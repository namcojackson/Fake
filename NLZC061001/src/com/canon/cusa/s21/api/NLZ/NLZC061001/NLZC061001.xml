<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NLZC061001">

    <statement id="findS21Person" parameterClass="Map" resultClass="Map">
         SELECT
             SP.PSN_FIRST_NM
             ,SP.PSN_LAST_NM
             ,SP.LINE_BIZ_TP_CD
             ,SP.HR_SUPV_ID
             ,SP.HR_SUPV_NM
         FROM
             S21_PSN SP
         WHERE
             SP.GLBL_CMPY_CD = #glblCmpyCd#
         AND SP.PSN_CD       = #psnCd#
         AND SP.EZCANCELFLAG = '0'
    </statement>

    <statement id="countCancelPiControl" parameterClass="Map" resultClass="BigDecimal">
         SELECT
             COUNT(PIC.PHYS_INVTY_NUM) AS CNT
         FROM
             PHYS_INVTY_CTRL PIC
         WHERE
             PIC.GLBL_CMPY_CD   = #glblCmpyCd#
         AND PIC.PHYS_INVTY_NUM = #physInvtyNum#
         <iterate property="cntStsCdList" var="cntStsCdList[]" open="AND PIC.PHYS_INVTY_CNT_STS_CD IN (" conjunction= ", " close=")">
             #cntStsCdList[]#
         </iterate>
         AND PIC.EZCANCELFLAG   = '0'
    </statement>

    <statement id="findVarianceAndNumberOfSKUs" parameterClass="Map" resultClass="Map">
         SELECT
              PIC.PHYS_INVTY_NUM
             ,PICH.PHYS_INVTY_ADJ_NM
             ,SUM(ABS(PICD.ADJ_VAR_QTY)) AS TOT_VAR_GRS_QTY
             ,SUM(ABS(PICD.ADJ_VAR_AMT)) AS TOT_VAR_GRS_AMT
             ,SUM(PICD.ADJ_VAR_QTY) AS TOT_VAR_NET_QTY
             ,SUM(PICD.ADJ_VAR_AMT) AS TOT_VAR_NET_AMT
         FROM
             PHYS_INVTY_CTRL PIC
             ,PHYS_INVTY_CNT_HDR PICH
             ,PHYS_INVTY_CNT_DTL PICD
         WHERE
         -- JOIN TO PHYS_INVTY_CTRL
             PIC.GLBL_CMPY_CD           = #glblCmpyCd#
         AND PIC.PHYS_INVTY_NUM         = #physInvtyNum#
         -- JOIN TO PHYS_INVTY_CNT_HDR
         AND PIC.GLBL_CMPY_CD           = PICH.GLBL_CMPY_CD
         AND PIC.PHYS_INVTY_CTRL_PK     = PICH.PHYS_INVTY_CTRL_PK
         --JOIN TO PHYS_INVTY_CNT_DTL
         AND PIC.GLBL_CMPY_CD           = PICD.GLBL_CMPY_CD
         AND PIC.PHYS_INVTY_CTRL_PK     = PICD.PHYS_INVTY_CTRL_PK
         AND PICH.PHYS_INVTY_CNT_HDR_PK = PICD.PHYS_INVTY_CNT_HDR_PK
         AND PICH.ADJ_VAR_FLG           = #adjVarFlg#
         AND PIC.EZCANCELFLAG           = '0'
         AND PICH.EZCANCELFLAG          = '0'
         AND PICD.EZCANCELFLAG          = '0'
         GROUP BY 
             PIC.PHYS_INVTY_NUM
            ,PICH.PHYS_INVTY_ADJ_NM
    </statement>

    <statement id="findTechBranch" parameterClass="Map" resultClass="Map">
        WITH ORG AS (
            SELECT DISTINCT
                A.GLBL_CMPY_CD
                ,B.BIZ_AREA_ORG_CD
                ,B.TIER
                ,A.TOC_CD
                ,CASE
                    WHEN B.TIER = A.FIRST_ORG_TIER_CD THEN A.FIRST_ORG_CD
                    WHEN B.TIER = A.SCD_ORG_TIER_CD THEN A.SCD_ORG_CD 
                    WHEN B.TIER = A.THIRD_ORG_TIER_CD THEN A.THIRD_ORG_CD
                    WHEN B.TIER = A.FRTH_ORG_TIER_CD THEN A.FRTH_ORG_CD
                    WHEN B.TIER = A.FIFTH_ORG_TIER_CD THEN A.FIFTH_ORG_CD
                    WHEN B.TIER = A.SIXTH_ORG_TIER_CD THEN A.SIXTH_ORG_CD 
                    WHEN B.TIER = A.SVNTH_ORG_TIER_CD THEN A.SVNTH_ORG_CD
                    WHEN B.TIER = A.EIGHTH_ORG_TIER_CD THEN A.EIGHTH_ORG_CD
                    WHEN B.TIER = A.NINTH_ORG_TIER_CD THEN A.NINTH_ORG_CD
                    WHEN B.TIER = A.TENTH_ORG_TIER_CD THEN A.TENTH_ORG_CD
                    WHEN B.TIER = A.ELVTH_ORG_TIER_CD THEN A.ELVTH_ORG_CD 
                END AS ORG_CD
                ,CASE
                    WHEN B.TIER = A.FIRST_ORG_TIER_CD THEN A.FIRST_ORG_NM
                    WHEN B.TIER = A.SCD_ORG_TIER_CD THEN A.SCD_ORG_NM 
                    WHEN B.TIER = A.THIRD_ORG_TIER_CD THEN A.THIRD_ORG_NM
                    WHEN B.TIER = A.FRTH_ORG_TIER_CD THEN A.FRTH_ORG_NM
                    WHEN B.TIER = A.FIFTH_ORG_TIER_CD THEN A.FIFTH_ORG_NM
                    WHEN B.TIER = A.SIXTH_ORG_TIER_CD THEN A.SIXTH_ORG_NM 
                    WHEN B.TIER = A.SVNTH_ORG_TIER_CD THEN A.SVNTH_ORG_NM
                    WHEN B.TIER = A.EIGHTH_ORG_TIER_CD THEN A.EIGHTH_ORG_NM
                    WHEN B.TIER = A.NINTH_ORG_TIER_CD THEN A.NINTH_ORG_NM
                    WHEN B.TIER = A.TENTH_ORG_TIER_CD THEN A.TENTH_ORG_NM
                    WHEN B.TIER = A.ELVTH_ORG_TIER_CD THEN A.ELVTH_ORG_NM 
                END AS ORG_NM
            FROM 
                S21_ORG A
                ,(
                    SELECT
                        OHSD.GLBL_CMPY_CD
                        ,OHSD.BIZ_AREA_ORG_CD
                        ,OHSD.ORG_TIER_CD AS TIER 
                    FROM
                        ORG_HRCH_STRU_DFN OHSD
                        ,STRU_DFN SD    
                    WHERE 
                        1 = 1
                    -- JOIN TO ORG_HRCH_STRU_DFN
                    AND OHSD.GLBL_CMPY_CD    = #glblCmpyCd#
                    AND OHSD.ORG_STRU_TP_CD  = #orgStruTpCd#
                    AND OHSD.BIZ_AREA_ORG_CD = #bizAreaOrgCd#
                    -- JOIN TO STRU_DFN
                    AND OHSD.GLBL_CMPY_CD    = SD.GLBL_CMPY_CD
                    AND OHSD.STRU_DFN_CD     = SD.STRU_DFN_CD
                    AND SD.BR_FLG            = #brFlg#
                    AND OHSD.EZCANCELFLAG    = '0'
                    AND SD.EZCANCELFLAG      = '0'
                ) B
            WHERE
                1 = 1
            -- JOIN TO S21_ORG
            AND A.GLBL_CMPY_CD = B.GLBL_CMPY_CD
            AND A.EZCANCELFLAG = '0'
        )
        SELECT DISTINCT
            ORG.ORG_NM AS BR_NM
        FROM
            ORG ORG
            ,S21_ORG O
            ,TOC T
            ,ORG_FUNC_ASG OFA
        WHERE
           1 = 1
        -- JOIN TO S21_ORG
        AND ORG.GLBL_CMPY_CD                    = O.GLBL_CMPY_CD
        AND ORG.BIZ_AREA_ORG_CD                 = O.FIRST_ORG_CD
        -- JOIN TO TOC
        AND O.GLBL_CMPY_CD                      = T.GLBL_CMPY_CD
        AND O.TOC_CD                            = T.TOC_CD
        AND T.TOC_CD                            = ORG.TOC_CD(+)
        -- JOIN TO ORG_FUNC_ASG
        AND O.GLBL_CMPY_CD                      = OFA.GLBL_CMPY_CD
        AND O.TOC_CD                            = OFA.TOC_CD
        <iterate property="gnrnTpCdList" var="gnrnTpCdList[]" open="AND OFA.GNRN_TP_CD IN (" conjunction= ", " close=")">
        #gnrnTpCdList[]#
        </iterate>
        AND OFA.EFF_FROM_DT                 &lt;= #salesDate#
        AND NVL(OFA.EFF_THRU_DT,'99991231') &gt;= #salesDate#
        AND OFA.PSN_CD                          = #psnCd#
        AND O.EZCANCELFLAG                      = '0'
        AND T.EZCANCELFLAG                      = '0'
        AND OFA.EZCANCELFLAG                    = '0'
    </statement>
        <statement id ="getPIMode" parameterClass="Map" resultClass="String">
         SELECT
             PIC.LOC_TP_CD
         FROM
             PHYS_INVTY_CTRL PIC
         WHERE
             PIC.PHYS_INVTY_NUM = #physInvtyNum#
         AND ROWNUM=1
         AND PIC.GLBL_CMPY_CD = #glblCmpyCd#
         AND PIC.EZCANCELFLAG='0'
    </statement>
    <statement id = "getRtlWhCode" parameterClass="Map" resultClass="Map">
        SELECT 
            PIC.RTL_WH_CD
        FROM
            PHYS_INVTY_CTRL PIC
        WHERE
            PIC.PHYS_INVTY_NUM                 = #physInvtyNum#
        AND PIC.GLBL_CMPY_CD                   = #glblCmpyCd#
        AND PIC.EZCANCELFLAG                   = '0'
        GROUP BY
            PIC.RTL_WH_CD
        ORDER BY
            PIC.RTL_WH_CD ASC
    </statement>

    <statement id="getApvlTeamTransactions" parameterClass="Map" resultClass="Map">
        SELECT DISTINCT
             APVL_TEAM_PK
            ,APVL_HIST_SRC_TP_CD
        FROM 
            (
            SELECT
                DISTINCT
                 ATE.APVL_TEAM_PK
                ,ATP.APVL_TEAM_POSN_LAYER_NUM
                ,ATT.APVL_HIST_SRC_TP_CD
                ,MAX(ATP.APVL_TEAM_POSN_LAYER_NUM) OVER (PARTITION BY 1) APPROVER_POS_LAYER_NUM
                ,MAX(ATE.APVL_TEAM_PK) OVER (PARTITION BY 1) APPROVER_TEAM_PK
            FROM
                 APVL_TEAM         ATE
                ,APVL_TEAM_MBR     ATM
                ,APVL_TEAM_TRX     ATT
                ,APVL_TEAM_LOC     ATL
                ,APVL_LIMIT        ALT
                ,APVL_TEAM_POSN_TP ATP
            WHERE 1=1
            AND ATE.GLBL_CMPY_CD         = #glblCmpyCd#
            AND ATE.APVL_HRCH_TP_CD      = #apvlHrchTpCd#
            AND ATE.EZCANCELFLAG         = '0'
            AND ATE.GLBL_CMPY_CD         = ATM.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK         = ATM.APVL_TEAM_PK
            AND ATM.EZCANCELFLAG         = '0'
            AND ATE.GLBL_CMPY_CD         = ATT.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK         = ATT.APVL_TEAM_PK
            AND ATT.APVL_HIST_SRC_TP_CD  IN (#adjMerchandise#, #adjParts#)
            AND ATT.EZCANCELFLAG         = '0'
            AND ATE.GLBL_CMPY_CD         = ATL.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK         = ATL.APVL_TEAM_PK
            AND ATL.RTL_WH_CD            = #rtlWhCd#
            AND ATL.EZCANCELFLAG         = '0'
            AND ATE.GLBL_CMPY_CD         = ALT.GLBL_CMPY_CD
            AND ATE.APVL_HRCH_TP_CD      = ALT.APVL_HRCH_TP_CD
            AND ALT.APVL_TEAM_POSN_TP_CD = ATM.APVL_TEAM_POSN_TP_CD
            AND ALT.APVL_HIST_SRC_TP_CD  = ATT.APVL_HIST_SRC_TP_CD
            AND ALT.APVL_LIMIT_AMT      &gt; #apvlLimitAmt#
            AND ALT.EZCANCELFLAG         = '0'
            AND ATM.APVL_TEAM_POSN_TP_CD = ATP.APVL_TEAM_POSN_TP_CD
            AND ATE.GLBL_CMPY_CD         = ATP.GLBL_CMPY_CD
            AND ATP.EZCANCELFLAG         = '0'
            ORDER BY 
                ATP.APVL_TEAM_POSN_LAYER_NUM DESC
            ) A
        WHERE 
            A.APPROVER_POS_LAYER_NUM  = A.APVL_TEAM_POSN_LAYER_NUM
        AND A.APPROVER_TEAM_PK        = A.APVL_TEAM_PK
    </statement>

    <statement id="cntPartsItem" parameterClass="Map" resultClass="BigDecimal">
         SELECT
              COUNT(M.GLBL_CMPY_CD) AS CNT
         FROM
             PHYS_INVTY_CTRL PIC
             ,PHYS_INVTY_CNT_HDR PICH
             ,PHYS_INVTY_CNT_DTL PICD
             ,MDSE M
         WHERE
             PIC.GLBL_CMPY_CD           = 'ADB'
         AND PIC.PHYS_INVTY_NUM         = #physInvtyNum#
         AND PIC.GLBL_CMPY_CD           = PICH.GLBL_CMPY_CD
         AND PIC.PHYS_INVTY_CTRL_PK     = PICH.PHYS_INVTY_CTRL_PK
         AND PIC.GLBL_CMPY_CD           = PICD.GLBL_CMPY_CD
         AND PIC.PHYS_INVTY_CTRL_PK     = PICD.PHYS_INVTY_CTRL_PK
         AND PICH.PHYS_INVTY_CNT_HDR_PK = PICD.PHYS_INVTY_CNT_HDR_PK
         AND PICH.ADJ_VAR_FLG           = #adjVarFlg#
         AND PICD.GLBL_CMPY_CD          = M.GLBL_CMPY_CD
         AND PICD.MDSE_CD               = M.MDSE_CD
         AND M.MDSE_CATG_CD             = #parts#
         AND PIC.EZCANCELFLAG           = '0'
         AND PICH.EZCANCELFLAG          = '0'
         AND PICD.EZCANCELFLAG          = '0'
         AND M.EZCANCELFLAG             = '0'
     </statement>
</sqlMap>
