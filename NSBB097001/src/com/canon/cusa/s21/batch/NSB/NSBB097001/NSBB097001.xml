<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSBB097001">

    <statement id="getTargetData" parameterClass="Map">
        SELECT
             INV.BILL_TO_CUST_CD                                        BILL_TO_CUST_CD
            ,BTC.LOC_NM                                                 BILL_TO_CUST_NM
            ,BTC.LOC_NUM                                                LOC_NUM
            ,INV.BILL_TO_CUST_ACCT_CD                                   BILL_TO_CUST_ACCT_CD
            ,INV.BILL_TO_CUST_ACCT_NM                                   BILL_TO_CUST_ACCT_NM
            ,INV.INV_NUM                                                INV_NUM
            ,INV.CUST_ISS_PO_NUM                                        CUST_ISS_PO_NUM
            ,INV.DS_BIZ_AREA_CD                                        DS_BIZ_AREA_CD
            ,SINV.DS_CONTR_NUM                                          DS_CONTR_NUM
            ,SINV.BLLG_PER_FROM_DT
                 || DECODE(SINV.BLLG_PER_TO_DT, NULL, '', '-')
                 || SINV.BLLG_PER_TO_DT                                 BLLG_PER
            ,SINV.SER_NUM                                               SER_NUM
            ,SINV.MDL_NM                                                MDL_NM
            ,INV.INV_DT                                                 INV_DT
            ,INV.INV_TP_CD                                              INV_TP_CD
            ,INV.INV_TOT_DEAL_NET_AMT                                   INV_TOT_DEAL_NET_AMT
            ,INV.INV_TOT_FUNC_NET_AMT                                   INV_TOT_FUNC_NET_AMT
            ,ATB.DEAL_RMNG_BAL_GRS_AMT                                  DEAL_RMNG_BAL_GRS_AMT
            ,ATB.FUNC_RMNG_BAL_GRS_AMT                                  FUNC_RMNG_BAL_GRS_AMT
            ,INV.PMT_TERM_CASH_DISC_CD                                  PMT_TERM_CASH_DISC_CD
            ,INV.PMT_TERM_CD                                            PMT_TERM_CD
            ,INV.PMT_TERM_CASH_DISC_DESC_TXT                            PMT_TERM_CASH_DISC_DESC_TXT
            ,PTC.PMT_TERM_CONSL_LAST_DOM_FLG                            PMT_TERM_CONSL_LAST_DOM_FLG
            ,PTC.PMT_TERM_CONSL_DUE_DAY                                 PMT_TERM_CONSL_DUE_DAY
            ,INV.ORIG_INV_NUM                                           ORIG_INV_NUM
            ,SINV.DS_CONTR_CATG_CD                                      DS_CONTR_CATG_CD
            ,(SELECT SIL.FIRST_BLLG_ATTRB_VAL_TXT FROM SVC_INV_LINE SIL WHERE SIL.GLBL_CMPY_CD = SINV.GLBL_CMPY_CD AND SIL.SVC_INV_NUM = SINV.SVC_INV_NUM AND SIL.EZCANCELFLAG = '0' AND ROWNUM = 1 ) AS FIRST_BLLG_ATTRB_VAL_TXT
            ,(SELECT SIL.SCD_BLLG_ATTRB_VAL_TXT   FROM SVC_INV_LINE SIL WHERE SIL.GLBL_CMPY_CD = SINV.GLBL_CMPY_CD AND SIL.SVC_INV_NUM = SINV.SVC_INV_NUM AND SIL.EZCANCELFLAG = '0' AND ROWNUM = 1 ) AS SCD_BLLG_ATTRB_VAL_TXT
            ,(SELECT SIL.THIRD_BLLG_ATTRB_VAL_TXT FROM SVC_INV_LINE SIL WHERE SIL.GLBL_CMPY_CD = SINV.GLBL_CMPY_CD AND SIL.SVC_INV_NUM = SINV.SVC_INV_NUM AND SIL.EZCANCELFLAG = '0' AND ROWNUM = 1 ) AS THIRD_BLLG_ATTRB_VAL_TXT
            ,(SELECT SIL.FRTH_BLLG_ATTRB_VAL_TXT  FROM SVC_INV_LINE SIL WHERE SIL.GLBL_CMPY_CD = SINV.GLBL_CMPY_CD AND SIL.SVC_INV_NUM = SINV.SVC_INV_NUM AND SIL.EZCANCELFLAG = '0' AND ROWNUM = 1 ) AS FRTH_BLLG_ATTRB_VAL_TXT
            ,(SELECT SIL.FIFTH_BLLG_ATTRB_VAL_TXT FROM SVC_INV_LINE SIL WHERE SIL.GLBL_CMPY_CD = SINV.GLBL_CMPY_CD AND SIL.SVC_INV_NUM = SINV.SVC_INV_NUM AND SIL.EZCANCELFLAG = '0' AND ROWNUM = 1 ) AS FIFTH_BLLG_ATTRB_VAL_TXT
            ,(SELECT SIL.SIXTH_BLLG_ATTRB_VAL_TXT FROM SVC_INV_LINE SIL WHERE SIL.GLBL_CMPY_CD = SINV.GLBL_CMPY_CD AND SIL.SVC_INV_NUM = SINV.SVC_INV_NUM AND SIL.EZCANCELFLAG = '0' AND ROWNUM = 1 ) AS SIXTH_BLLG_ATTRB_VAL_TXT
            ,SINV.INV_DUE_DT                                            INV_DUE_DT
            ,SINV.FSR_NUM                                               FSR_NUM
            ,SINV.TEMP_ETTL_NUM                                         TEMP_ETTL_NUM
        FROM
             INV                INV
            ,SVC_INV            SINV
            ,AR_TRX_BAL         ATB
            ,BILL_TO_CUST       BTC
            ,PMT_TERM_CASH_DISC PTC
        WHERE
                INV.GLBL_CMPY_CD            = #glblCmpyCd#
            AND INV.INV_PRINT_STS_CD        = '1'
            AND INV.FNLZ_INV_FLG            = 'Y'
            AND INV.INV_DT              &lt;= #slsDt#
            AND INV.EZCANCELFLAG            = '0'

            AND NOT EXISTS (
                SELECT
                    '1'
                FROM
                    CONSL_BILL_LINE CBL
                WHERE
                        CBL.GLBL_CMPY_CD      = INV.GLBL_CMPY_CD
                    AND CBL.CONSL_BILL_TRX_ID = INV.INV_NUM
                    AND CBL.EZCANCELFLAG      = '0'
            )

            AND SINV.GLBL_CMPY_CD       = INV.GLBL_CMPY_CD
            AND SINV.SVC_INV_NUM        = INV.INV_NUM
            AND SINV.TEMP_ETTL_NUM IS NOT NULL
            AND SINV.EZCANCELFLAG       = '0'

            AND ATB.GLBL_CMPY_CD (+)    = INV.GLBL_CMPY_CD
            AND ATB.AR_TRX_NUM (+)      = INV.INV_NUM
            AND ATB.EZCANCELFLAG (+)    = '0'

            AND BTC.GLBL_CMPY_CD        = INV.GLBL_CMPY_CD
            AND BTC.BILL_TO_CUST_CD     = INV.BILL_TO_CUST_CD
            AND BTC.EZCANCELFLAG        = '0'

            AND PTC.GLBL_CMPY_CD          = INV.GLBL_CMPY_CD
            AND PTC.PMT_TERM_CASH_DISC_CD = INV.PMT_TERM_CASH_DISC_CD
            AND PTC.EZCANCELFLAG          = '0'

        ORDER BY
             BILL_TO_CUST_CD
            ,TEMP_ETTL_NUM
            ,SER_NUM
            ,FSR_NUM NULLS LAST
    </statement>

    <statement id="getAppliedInvoice" parameterClass="Map" resultClass="Map">
        SELECT 
            A.AR_TRX_NUM
        FROM 
            AR_CASH_APP A
           ,AR_CASH_APP B
        WHERE 1=1
        AND A.GLBL_CMPY_CD = #glblCmpyCd#
        AND A.EZCANCELFLAG = '0'
        AND B.GLBL_CMPY_CD = #glblCmpyCd#
        AND B.EZCANCELFLAG = '0'
        AND A.RCPT_NUM = B.RCPT_NUM
        AND B.AR_TRX_NUM = #arTrxNum#  <!-- Credit Memo -->
        AND A.AR_TRX_NUM != #arTrxNum# <!-- not my self -->
    </statement>

</sqlMap>
