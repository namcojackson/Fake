<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSBB102001">

<!-- #################### Type Alias #################### -->
<typeAlias alias="FSR_HISTTMsg" type="business.db.FSR_HISTTMsg"/>
<typeAlias alias="SVC_TASK_HISTTMsg" type="business.db.SVC_TASK_HISTTMsg"/>
<typeAlias alias="FSR_VISIT_HISTTMsg" type="business.db.FSR_VISIT_HISTTMsg"/>

<!-- #################### Statement #################### -->
    <statement id="getLastExecTime" parameterClass="Map" resultClass="Map">
        SELECT
            MAX(BAT_PROC_START_TS) AS BAT_PROC_START_TS
        FROM
            BAT_PROC_LOG
        WHERE
                GLBL_CMPY_CD           = #glblCmpyCd#
            AND EZCANCELFLAG           = '0'
            AND BAT_PROC_PGM_ID        = #batProcPgmId#
            AND BAT_PROC_TRM_CD       != '99'
    </statement>

    <statement id="getFsrHist" parameterClass="Map" resultClass="Map">
        SELECT
             FH.GLBL_CMPY_CD    AS GLBL_CMPY_CD
            ,FH.FSR_H_PK        AS FSR_H_PK
            ,FH.FSR_NUM         AS FSR_NUM
            ,FH.HIST_CRAT_TS    AS HIST_CRAT_TS
            ,FH.HIST_ACT_NM     AS HIST_ACT_NM
            ,FH.EZUPUSERID      AS EZUPUSERID
            ,FH.FSR_STS_CD      AS FSR_STS_CD
            ,FH.ITT_NUM         AS ITT_NUM
        FROM
            FSR_HIST  FH
        WHERE
                FH.GLBL_CMPY_CD           = #glblCmpyCd#
            AND FH.EZCANCELFLAG           = '0'
            AND FH.HIST_CRAT_TS       &gt;= #targetStartTime#
            AND FH.HIST_CRAT_TS        &lt; #targetEndTime#
        ORDER BY
             FH.FSR_NUM
            ,FH.HIST_CRAT_TS
            ,FH.FSR_H_PK
    </statement>

    <statement id="getFsrHistOldRecord" parameterClass="Map" resultMap="result.queryFSR_HISTTMsg">
        SELECT
             FH.GLBL_CMPY_CD    AS GLBL_CMPY_CD
            ,FH.FSR_H_PK        AS FSR_H_PK
            ,FH.FSR_NUM         AS FSR_NUM
            ,FH.HIST_CRAT_TS    AS HIST_CRAT_TS
            ,FH.HIST_ACT_NM     AS HIST_ACT_NM
            ,FH.EZUPUSERID      AS EZUPUSERID
            ,FH.FSR_STS_CD      AS FSR_STS_CD
            ,FH.ITT_NUM         AS ITT_NUM
        FROM (
            SELECT
                 GLBL_CMPY_CD
                ,FSR_H_PK
                ,FSR_NUM
                ,HIST_CRAT_TS
                ,HIST_ACT_NM
                ,EZUPUSERID
                ,FSR_STS_CD
                ,ITT_NUM
            FROM
                FSR_HIST
            WHERE
                    GLBL_CMPY_CD           = #glblCmpyCd#
                AND EZCANCELFLAG           = '0'
                AND HIST_CRAT_TS       &lt;= #targetStartTime#
                AND FSR_NUM                = #fsrNum#
            ORDER BY
                 HIST_CRAT_TS   DESC
                ,FSR_H_PK       DESC
        ) FH
        WHERE ROWNUM = 1
    </statement>
    
    <resultMap id="result.queryFSR_HISTTMsg" class="FSR_HISTTMsg">
    <result property="glblCmpyCd"           column="GLBL_CMPY_CD"             javaType="EZDTStringItem"/>
    <result property="fsrHPk"               column="FSR_H_PK"                 javaType="EZDTBigDecimalItem"/>
    <result property="fsrNum"               column="FSR_NUM"                  javaType="EZDTStringItem"/>
    <result property="histCratTs"           column="HIST_CRAT_TS"             javaType="EZDTStringItem"/>
    <result property="histActNm"            column="HIST_ACT_NM"              javaType="EZDTStringItem"/>
    <result property="ezUpUserID"           column="EZUPUSERID"               javaType="EZDTStringItem"/>
    <result property="fsrStsCd"             column="FSR_STS_CD"               javaType="EZDTStringItem"/>
    <result property="ittNum"               column="ITT_NUM"                  javaType="EZDTStringItem"/>
    </resultMap>

    <statement id="getSvcTaskHist" parameterClass="Map" resultClass="Map">
        SELECT DISTINCT
             STH.GLBL_CMPY_CD       AS GLBL_CMPY_CD
            ,STH.SVC_TASK_H_PK      AS SVC_TASK_H_PK
            ,STH.FSR_NUM            AS FSR_NUM
            ,STH.SVC_TASK_NUM       AS SVC_TASK_NUM
            ,FVH.FSR_VISIT_NUM      AS FSR_VISIT_NUM
            ,STH.HIST_CRAT_TS       AS HIST_CRAT_TS
            ,STH.HIST_ACT_NM        AS HIST_ACT_NM
            ,STH.EZUPUSERID         AS EZUPUSERID
            ,STH.DS_SVC_CALL_TP_CD  AS DS_SVC_CALL_TP_CD
            ,STH.CRS_SVC_SR_NUM     AS CRS_SVC_SR_NUM
        FROM
             SVC_TASK_HIST  STH
            ,FSR_VISIT_HIST FVH
        WHERE
                STH.GLBL_CMPY_CD           = #glblCmpyCd#
            AND STH.EZCANCELFLAG           = '0'
            AND STH.GLBL_CMPY_CD           = FVH.GLBL_CMPY_CD(+)
            AND FVH.EZCANCELFLAG(+)        = '0'
            AND STH.FSR_NUM                IS NOT NULL
            AND STH.SVC_TASK_NUM           = FVH.SVC_TASK_NUM(+)
            AND STH.HIST_CRAT_TS       &gt;= #targetStartTime#
            AND STH.HIST_CRAT_TS        &lt; #targetEndTime#
        ORDER BY
             STH.FSR_NUM
            ,STH.SVC_TASK_NUM
            ,FVH.FSR_VISIT_NUM
            ,STH.HIST_CRAT_TS
            ,STH.SVC_TASK_H_PK
    </statement>

    <statement id="getSvcTaskHistOldRecord" parameterClass="Map" resultMap="result.querySVC_TASK_HISTTMsg">
        SELECT
             STH.GLBL_CMPY_CD       AS GLBL_CMPY_CD
            ,STH.SVC_TASK_H_PK      AS SVC_TASK_H_PK
            ,STH.FSR_NUM            AS FSR_NUM
            ,STH.SVC_TASK_NUM       AS SVC_TASK_NUM
            ,STH.HIST_CRAT_TS       AS HIST_CRAT_TS
            ,STH.HIST_ACT_NM        AS HIST_ACT_NM
            ,STH.EZUPUSERID         AS EZUPUSERID
            ,STH.DS_SVC_CALL_TP_CD  AS DS_SVC_CALL_TP_CD
            ,STH.CRS_SVC_SR_NUM     AS CRS_SVC_SR_NUM
        FROM (
            SELECT
                 GLBL_CMPY_CD
                ,SVC_TASK_H_PK
                ,FSR_NUM
                ,SVC_TASK_NUM
                ,HIST_CRAT_TS
                ,HIST_ACT_NM
                ,EZUPUSERID
                ,DS_SVC_CALL_TP_CD
                ,CRS_SVC_SR_NUM
            FROM
                SVC_TASK_HIST
            WHERE
                    GLBL_CMPY_CD           = #glblCmpyCd#
                AND EZCANCELFLAG           = '0'
                AND HIST_CRAT_TS       &lt;= #targetStartTime#
                AND FSR_NUM                = #fsrNum#
                AND SVC_TASK_NUM           = #svcTaskNum#
            ORDER BY
                 HIST_CRAT_TS   DESC
                ,SVC_TASK_H_PK  DESC
        ) STH
        WHERE ROWNUM = 1
    </statement>
    
    <resultMap id="result.querySVC_TASK_HISTTMsg" class="SVC_TASK_HISTTMsg">
    <result property="glblCmpyCd"           column="GLBL_CMPY_CD"             javaType="EZDTStringItem"/>
    <result property="svcTaskHPk"           column="SVC_TASK_H_PK"            javaType="EZDTBigDecimalItem"/>
    <result property="fsrNum"               column="FSR_NUM"                  javaType="EZDTStringItem"/>
    <result property="svcTaskNum"           column="SVC_TASK_NUM"             javaType="EZDTStringItem"/>
    <result property="histCratTs"           column="HIST_CRAT_TS"             javaType="EZDTStringItem"/>
    <result property="histActNm"            column="HIST_ACT_NM"              javaType="EZDTStringItem"/>
    <result property="ezUpUserID"           column="EZUPUSERID"               javaType="EZDTStringItem"/>
    <result property="dsSvcCallTpCd"        column="DS_SVC_CALL_TP_CD"        javaType="EZDTStringItem"/>
    <result property="crsSvcSrNum"          column="CRS_SVC_SR_NUM"           javaType="EZDTStringItem"/>
    </resultMap>

    <statement id="getFsrVisitHist" parameterClass="Map" resultClass="Map">
        SELECT
             FVH.GLBL_CMPY_CD       AS GLBL_CMPY_CD
            ,FVH.FSR_VISIT_H_PK     AS FSR_VISIT_H_PK
            ,FVH.FSR_NUM            AS FSR_NUM
            ,FVH.SVC_TASK_NUM       AS SVC_TASK_NUM
            ,FVH.FSR_VISIT_NUM      AS FSR_VISIT_NUM
            ,FVH.HIST_CRAT_TS       AS HIST_CRAT_TS
            ,FVH.HIST_ACT_NM        AS HIST_ACT_NM
            ,FVH.EZUPUSERID         AS EZUPUSERID
            ,FVH.FSR_VISIT_STS_CD   AS FSR_VISIT_STS_CD
            ,FVH.TECH_CD            AS TECH_CD
        FROM
            FSR_VISIT_HIST  FVH
        WHERE
                FVH.GLBL_CMPY_CD           = #glblCmpyCd#
            AND FVH.EZCANCELFLAG           = '0'
            AND FVH.FSR_NUM                IS NOT NULL
            AND FVH.HIST_CRAT_TS       &gt;= #targetStartTime#
            AND FVH.HIST_CRAT_TS        &lt; #targetEndTime#
        ORDER BY
             FVH.FSR_NUM
            ,FVH.FSR_VISIT_NUM
            ,FVH.HIST_CRAT_TS
            ,FVH.FSR_VISIT_H_PK
    </statement>

    <statement id="getFsrVisitHistOldRecord" parameterClass="Map" resultMap="result.queryFSR_VISIT_HISTTMsg">
        SELECT
             FVH.GLBL_CMPY_CD       AS GLBL_CMPY_CD
            ,FVH.FSR_VISIT_H_PK     AS FSR_VISIT_H_PK
            ,FVH.FSR_NUM            AS FSR_NUM
            ,FVH.SVC_TASK_NUM       AS SVC_TASK_NUM
            ,FVH.FSR_VISIT_NUM      AS FSR_VISIT_NUM
            ,FVH.HIST_CRAT_TS       AS HIST_CRAT_TS
            ,FVH.HIST_ACT_NM        AS HIST_ACT_NM
            ,FVH.EZUPUSERID         AS EZUPUSERID
            ,FVH.FSR_VISIT_STS_CD   AS FSR_VISIT_STS_CD
            ,FVH.TECH_CD            AS TECH_CD
        FROM (
            SELECT
                 GLBL_CMPY_CD
                ,FSR_VISIT_H_PK
                ,FSR_NUM
                ,SVC_TASK_NUM
                ,FSR_VISIT_NUM
                ,HIST_CRAT_TS
                ,HIST_ACT_NM
                ,EZUPUSERID
                ,FSR_VISIT_STS_CD
                ,TECH_CD
            FROM
                FSR_VISIT_HIST
            WHERE
                    GLBL_CMPY_CD           = #glblCmpyCd#
                AND EZCANCELFLAG           = '0'
                AND HIST_CRAT_TS       &lt;= #targetStartTime#
                AND FSR_NUM                = #fsrNum#
                AND SVC_TASK_NUM           = #svcTaskNum#
                AND FSR_VISIT_NUM          = #fsrVisitNum#
            ORDER BY
                 HIST_CRAT_TS   DESC
                ,FSR_VISIT_H_PK DESC
        ) FVH
        WHERE ROWNUM = 1
    </statement>
    
    <resultMap id="result.queryFSR_VISIT_HISTTMsg" class="FSR_VISIT_HISTTMsg">
    <result property="glblCmpyCd"           column="GLBL_CMPY_CD"             javaType="EZDTStringItem"/>
    <result property="fsrVisitHPk"          column="FSR_VISIT_H_PK"           javaType="EZDTBigDecimalItem"/>
    <result property="fsrNum"               column="FSR_NUM"                  javaType="EZDTStringItem"/>
    <result property="svcTaskNum"           column="SVC_TASK_NUM"             javaType="EZDTStringItem"/>
    <result property="fsrVisitNum"          column="FSR_VISIT_NUM"            javaType="EZDTStringItem"/>
    <result property="histCratTs"           column="HIST_CRAT_TS"             javaType="EZDTStringItem"/>
    <result property="histActNm"            column="HIST_ACT_NM"              javaType="EZDTStringItem"/>
    <result property="ezUpUserID"           column="EZUPUSERID"               javaType="EZDTStringItem"/>
    <result property="fsrVisitStsCd"        column="FSR_VISIT_STS_CD"         javaType="EZDTStringItem"/>
    <result property="techCd"               column="TECH_CD"                  javaType="EZDTStringItem"/>
    </resultMap>

    <statement id="getCrsSvcRcvUpdStage" parameterClass="Map" resultClass="Map">
        SELECT
             TSK.GLBL_CMPY_CD           AS GLBL_CMPY_CD
            ,TSK.FSR_NUM                AS FSR_NUM
            ,TSK.SVC_TASK_NUM           AS SVC_TASK_NUM
            ,FVT.FSR_VISIT_NUM          AS FSR_VISIT_NUM
            ,CRS.EZUPTIME               AS EZUPTIME
            ,CRS.EZUPUSERID             AS EZUPUSERID
            ,CRS.CRS_SVC_TASK_STS_CD    AS CRS_SVC_TASK_STS_CD
        FROM
             SVC_TASK              TSK
            ,FSR_VISIT             FVT
            ,CRS_SVC_RCV_UPD_STAGE CRS
        WHERE
                TSK.GLBL_CMPY_CD    = #glblCmpyCd#
            AND TSK.EZCANCELFLAG    = '0'
            AND TSK.GLBL_CMPY_CD    = CRS.GLBL_CMPY_CD
            AND CRS.EZCANCELFLAG    = '0'
            AND TSK.GLBL_CMPY_CD    = FVT.GLBL_CMPY_CD(+)
            AND FVT.EZCANCELFLAG(+) = '0'
            AND TSK.FSR_NUM         IS NOT NULL
            <!-- START 2024/01/11 T.Kawasue [QC#61374, MOD] -->
            <!-- AND TSK.SVC_TASK_NUM    = CRS.CRS_SVC_S21_SVC_TASK_NUM -->
            AND TSK.CRS_SVC_SR_NUM = CRS.CRS_SVC_SR_NUM
            <!-- END 2024/01/11 T.Kawasue [QC#61374, MOD] -->
            AND TSK.SVC_TASK_NUM    = FVT.SVC_TASK_NUM(+)
            <!-- START 2024/01/11 T.Kawasue [QC#61374, DEL] -->
            <!-- AND TSK.SVC_TASK_STS_CD not in ('90','95','99') -->
            <!-- END 2024/01/11 T.Kawasue [QC#61374, DEL] -->
            AND CRS.EZUPTIME    &gt;= #targetStartTime#
            AND CRS.EZUPTIME     &lt; #targetEndTime#
        ORDER BY
             TSK.FSR_NUM
            ,TSK.SVC_TASK_NUM
            ,FVT.FSR_VISIT_NUM
            ,CRS.EZUPTIME
            ,CRS.CRS_SVC_RCV_UPD_STAGE_PK
    </statement>

    <statement id="getDtyMgr" parameterClass="Map" resultClass="Map">
        SELECT
             TSK.GLBL_CMPY_CD  AS GLBL_CMPY_CD
            ,TSK.FSR_NUM       AS FSR_NUM
            ,TSK.SVC_TASK_NUM  AS SVC_TASK_NUM
            ,FVT.FSR_VISIT_NUM AS FSR_VISIT_NUM
            ,TSK.EZUPTIME      AS EZUPTIME_TSK
            ,MGR.EZUPTIME      AS EZUPTIME_MGR
            ,MGR.EZUPUSERID    AS EZUPUSERID
            ,MGR.PSN_CD        AS PSN_CD
        FROM
             SVC_TASK      TSK
            ,FSR_VISIT     FVT
            ,SVC_MACH_MSTR SMM
            ,SVC_RG_BR_V   SRB
            ,DTY_MGR       MGR
            ,S21_PSN       PSN
        WHERE
                TSK.GLBL_CMPY_CD                                          = #glblCmpyCd#
            AND TSK.EZCANCELFLAG                                          = '0'
            AND TSK.GLBL_CMPY_CD                                          = FVT.GLBL_CMPY_CD(+)
            AND FVT.EZCANCELFLAG(+)                                       = '0'
            AND TSK.GLBL_CMPY_CD                                          = SMM.GLBL_CMPY_CD
            AND SMM.EZCANCELFLAG                                          = '0'
            AND TSK.GLBL_CMPY_CD                                          = MGR.GLBL_CMPY_CD
            AND MGR.EZCANCELFLAG                                          = '0'
            AND TSK.GLBL_CMPY_CD                                          = PSN.GLBL_CMPY_CD
            AND PSN.EZCANCELFLAG                                          = '0'
            AND TSK.FSR_NUM                                               IS NOT NULL
            AND TSK.SVC_TASK_NUM                                          = FVT.SVC_TASK_NUM(+)
            AND TSK.SVC_TASK_STS_CD                                       not in ('90','95','99')
            AND TSK.SVC_MACH_MSTR_PK                                      = SMM.SVC_MACH_MSTR_PK
            AND SMM.FLD_SVC_BR_CD                                         = SUBSTR(SRB.BR_ORG_NM,0,3)
            AND (MGR.BR_ORG_CD                                            IS NULL OR
                MGR.BR_ORG_CD                                             = SRB.BR_ORG_CD)
            AND MGR.ORG_CD                                                = SRB.RG_ORG_CD
            AND ((SMM.SVC_BY_LINE_BIZ_TP_CD IN (#svcByLineBizTpCdLfs#,#svcByLineBizTpCdPps#) AND MGR.SVC_BY_LINE_BIZ_TP_CD IN (#svcByLineBizTpCdLfs#,#svcByLineBizTpCdPps#)) OR
                (SMM.SVC_BY_LINE_BIZ_TP_CD NOT IN (#svcByLineBizTpCdLfs#,#svcByLineBizTpCdPps#) AND MGR.SVC_BY_LINE_BIZ_TP_CD = SMM.SVC_BY_LINE_BIZ_TP_CD)
                )
            AND MGR.EFF_FROM_DT || MGR.EFF_FROM_TM                    &lt;= #sysTmStamp#
            AND NVL(MGR.EFF_THRU_DT || MGR.EFF_THRU_TM, #sysTmStamp#) &gt;= #sysTmStamp#
            AND MGR.SVC_AVAL_FLG                                          = #flgY#
            AND MGR.PSN_CD                                                = PSN.PSN_CD
        ORDER BY
             TSK.FSR_NUM
            ,TSK.SVC_TASK_NUM
            ,MGR.BR_ORG_CD NULLS LAST
            ,MGR.PSN_CD
    </statement>

    <statement id="getFsrAudLogOldRecord" parameterClass="Map" resultClass="Map">
        SELECT
             FAL.FSR_NUM        AS FSR_NUM
            ,FAL.SVC_TASK_NUM   AS SVC_TASK_NUM
            ,FAL.CRAT_TS        AS CRAT_TS
            ,FAL.UPD_FLD_TXT    AS UPD_FLD_TXT
            ,FAL.NEW_VAL_TXT    AS NEW_VAL_TXT
            <isEqual property="getLastExecTimeFlg" compareValue="Y">
            ,FAL.EZUPTIME       AS EZUPTIME
            </isEqual>
        FROM (
            SELECT
                 FSR_NUM
                ,SVC_TASK_NUM
                ,CRAT_TS
                ,UPD_FLD_TXT
                ,NEW_VAL_TXT
                <isEqual property="getLastExecTimeFlg" compareValue="Y">
                ,EZUPTIME
                </isEqual>
            FROM
                FSR_AUD_LOG
            WHERE
                    GLBL_CMPY_CD    = #glblCmpyCd#
                AND EZCANCELFLAG    = '0'
                <isEqual property="getLastExecTimeFlg" compareValue="Y">
                AND CRAT_TS      &gt; #lastExecTime#
                <isNotNull property="excludeFld">
                AND UPD_FLD_TXT    != #excludeFld#
                </isNotNull>
                </isEqual>
                <isEqual property="getLastExecTimeFlg" compareValue="N">
                AND CRAT_TS     &lt;= #lastExecTime#
                AND FSR_NUM         = #fsrNum#
                AND SVC_TASK_NUM    = #svcTaskNum#
                AND UPD_FLD_TXT     = #updFldTxt#
                </isEqual>
            ORDER BY
                 CRAT_TS            DESC
                ,FSR_AUD_LOG_PK     DESC
        ) FAL
        WHERE ROWNUM = 1
    </statement>

</sqlMap>
