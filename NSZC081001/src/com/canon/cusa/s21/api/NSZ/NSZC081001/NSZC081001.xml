<?xml version="1.0" encoding="UTF-8" standalone="yes"?>

<sqlMap namespace="NSZC081001">
    <statement id="getSvcMachMtr" parameterClass="Map" resultClass="Map">
        SELECT
              SMM.SER_NUM
            , ML.MTR_LB_CD
            , ML.MTR_LB_DESC_TXT
            , SPMR.READ_MTR_CNT
            , TO_CHAR(TO_DATE(SPMR.MTR_READ_DT , #dtFmt#), #dtFmt#) AS MTR_READ_DT
            , MRT.DS_MTR_READ_TP_CD
            , MRT.DS_MTR_READ_TP_DESC_TXT
        FROM
              SVC_MACH_MSTR SMM
            , SVC_PHYS_MTR SPM
            , MTR_LB ML
            , SVC_PHYS_MTR_READ SPMR
            , DS_MTR_READ_TP MRT
        WHERE 
            SMM.GLBL_CMPY_CD                  = #glblCmpyCd#
            AND SMM.SER_NUM                   = #serNum#
            AND SMM.EZCANCELFLAG              = '0'
            AND SMM.GLBL_CMPY_CD              = SPM.GLBL_CMPY_CD
            AND SMM.SVC_MACH_MSTR_PK          = SPM.SVC_MACH_MSTR_PK
            AND SPM.EZCANCELFLAG              = '0'
            AND SPM.GLBL_CMPY_CD              = ML.GLBL_CMPY_CD
            AND SPM.MDL_MTR_LB_CD             = ML.MTR_LB_CD
            AND ML.EZCANCELFLAG               = '0'
            AND SPM.GLBL_CMPY_CD              = SPMR.GLBL_CMPY_CD
            AND SPM.SVC_PHYS_MTR_PK           = SPMR.SVC_PHYS_MTR_PK
            AND SPMR.SVC_PHYS_MTR_READ_GRP_SQ = (SELECT
                                                     MAX(ISPMR.SVC_PHYS_MTR_READ_GRP_SQ)
                                                 FROM
                                                     SVC_PHYS_MTR_READ ISPMR
                                                 WHERE 
                                                     ISPMR.GLBL_CMPY_CD         = SMM.GLBL_CMPY_CD
                                                     AND ISPMR.SVC_MACH_MSTR_PK = SMM.SVC_MACH_MSTR_PK
                                                     AND ISPMR.VLD_MTR_FLG      = 'Y'
                                                     AND ISPMR.EZCANCELFLAG     = '0' )
            AND SPMR.EZCANCELFLAG              = '0'
            AND SPMR.GLBL_CMPY_CD              = MRT.GLBL_CMPY_CD
            AND SPMR.DS_MTR_READ_TP_CD         = MRT.DS_MTR_READ_TP_CD
            AND SPMR.EZCANCELFLAG              = '0'
        ORDER BY
            SPM.MDL_MTR_LB_CD
    </statement>
</sqlMap>
