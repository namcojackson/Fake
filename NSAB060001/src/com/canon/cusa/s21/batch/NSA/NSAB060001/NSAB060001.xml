<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSAB060001">
    <statement id="getSvcMtrUpldWrk" parameterClass="Map" resultClass="Map">
<!-- START 2019/01/22 [QC#29719,MOD] -->
       SELECT
             A.UPLD_CSV_RQST_PK
            ,A.UPLD_CSV_RQST_ROW_NUM
            ,A.SER_NUM
            ,A.MTR_READ_DT
            ,A.MTR_LB_CD
            ,A.MTR_LB_DESC_TXT
            ,A.READ_MTR_CNT
            ,A.TEST_MTR_CNT
<!-- START 2018/02/08 M.Kidokoro [QC#18145,ADD] -->
            ,A.MTR_ENTRY_CMNT_TXT
<!-- END 2018/02/08 M.Kidokoro [QC#18145,ADD] -->
<!-- START 2019/01/10 [QC#29791,ADD] -->
            ,A.EZINUSERID
            <!-- START 2019/01/30 K.Kitachi [QC#29719, MOD] -->
            <!-- ,A.MDSE_CD -->
            ,B.SVC_MACH_MSTR_PK
            <!-- END 2019/01/30 K.Kitachi [QC#29719, MOD] -->
<!-- END   2019/01/10 [QC#29791,ADD] -->
        FROM
             SVC_MTR_UPLD_WRK  A
            <!-- START 2019/01/30 K.Kitachi [QC#29719, ADD] -->
            ,SVC_MACH_MSTR     B
            <!-- END 2019/01/30 K.Kitachi [QC#29719, ADD] -->
        WHERE
                A.GLBL_CMPY_CD           = #glblCmpyCd#
            AND A.EZCANCELFLAG           = '0'
            AND A.UPLD_CSV_RQST_PK       = #upldCsvRqstPk#
            <!-- START 2019/01/30 K.Kitachi [QC#29719, ADD] -->
            AND A.GLBL_CMPY_CD           = B.GLBL_CMPY_CD (+)
            AND A.SER_NUM                = B.SER_NUM (+)
            AND B.EZCANCELFLAG (+)       = '0'
            <!-- END 2019/01/30 K.Kitachi [QC#29719, ADD] -->
        ORDER BY
             A.SER_NUM       ASC
            ,A.MTR_READ_DT   ASC
            ,A.MTR_LB_CD     ASC
<!-- END   2019/01/22 [QC#29719,MOD] -->
    </statement>
    <statement id="getMtrLbCd" parameterClass="Map" resultClass="String">
        SELECT
            A.MTR_LB_CD
        FROM 
            MTR_LB   A
        WHERE
                A.GLBL_CMPY_CD      = #glblCmpyCd#
            AND A.EZCANCELFLAG      = '0'
            <isNotNull property="mtrLbCd">
            AND A.MTR_LB_CD         = #mtrLbCd#
            </isNotNull>
            <isNotNull property="mtrLbDescTxt">
            AND A.MTR_LB_DESC_TXT   = #mtrLbDescTxt#
            </isNotNull>
            AND A.ACTV_FLG          = 'Y'
            AND NVL(A.EFF_FROM_DT, #minEffFromDt#)
                                    &lt;= #slsDt#
            AND NVL(A.EFF_THRU_DT, #maxEffThruDt#)
                                    &gt;= #slsDt#
    </statement>
    <statement id="getSvcPhysMtrPk" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            A.SVC_PHYS_MTR_PK
        FROM 
            SVC_PHYS_MTR   A
        WHERE
                A.GLBL_CMPY_CD      = #glblCmpyCd#
            AND A.EZCANCELFLAG      = '0'
            AND A.SVC_MACH_MSTR_PK  = #svcMachMstrPk#
            AND A.MDL_MTR_LB_CD     = #mtrLbCd#
            AND A.ACTV_FLG          = 'Y'
            AND NVL(A.EFF_FROM_DT, #minEffFromDt#)
                                    &lt;= #slsDt#
            AND NVL(A.EFF_THRU_DT, #maxEffThruDt#)
                                    &gt;= #slsDt#
    </statement>
    <statement id="getPrevMtrCnt" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            READ_MTR_CNT
        FROM
            (
            SELECT
                A.READ_MTR_CNT
            FROM 
                SVC_PHYS_MTR_READ   A   
            WHERE
                    A.GLBL_CMPY_CD      = #glblCmpyCd#
                AND A.EZCANCELFLAG      = '0'
                AND A.SVC_PHYS_MTR_PK   = #svcPhysMtrPk#
                AND A.DS_MTR_READ_TP_GRP_CD    
                                        = #dsMtrReadTpGrpB#
                AND A.EST_FLG           = 'N'
                <!-- START 2017/12/20 K.Fujimoto [QC#28592, MOD] -->
                AND A.VLD_MTR_FLG       = 'Y'
                <!-- START 2017/12/20 K.Fujimoto [QC#28592, MOD] -->
            ORDER BY
                 A.MTR_READ_DT DESC
                ,A.RGTN_MTR_DT DESC
                ,A.SVC_PHYS_MTR_READ_GRP_SQ DESC
            )
        WHERE
            ROWNUM = 1
    </statement>
<!-- START 2017/12/20 M.Kidokoro [QC#21127, ADD] -->
    <statement id="getSvcPhysMtrRead" parameterClass="Map" resultClass="Map">
        SELECT
             A.MTR_LB_CD
            ,B.MTR_LB_DESC_TXT
            ,A.MTR_READ_DT
            ,A.READ_MTR_CNT
        FROM 
            SVC_PHYS_MTR_READ   A
           ,MTR_LB              B
        WHERE
                A.GLBL_CMPY_CD      = #glblCmpyCd#
            AND A.EZCANCELFLAG      = '0'
            AND A.SVC_MACH_MSTR_PK  = #svcMachMstrPk#
            AND A.VLD_MTR_FLG       = 'Y'
            AND B.GLBL_CMPY_CD      = A.GLBL_CMPY_CD
            AND B.EZCANCELFLAG      = '0'
            AND B.MTR_LB_CD         = A.MTR_LB_CD
        ORDER BY
             A.MTR_READ_DT         ASC
            ,A.MTR_LB_CD           ASC
    </statement>
<!-- END 2017/12/20 M.Kidokoro [QC#21127, ADD] -->
<!-- START 2019/08/20 K.Kitachi [QC#52860, ADD] -->
    <statement id="getInvoicedPeriodCount" parameterClass="Map" resultMap="BigDecimal">
        SELECT
            COUNT(*)
        FROM
            SVC_PHYS_MTR_READ A
        WHERE
                A.GLBL_CMPY_CD     = #glblCmpyCd#
            AND A.SVC_MACH_MSTR_PK = #svcMachMstrPk#
            AND A.MTR_READ_DT      &lt;= #mtrReadDt#
            AND A.DS_CONTR_DTL_PK  IS NOT NULL
            AND A.VLD_MTR_FLG      = 'Y'
            AND A.EZCANCELFLAG     = '0'
            AND EXISTS (
                SELECT
                    1
                FROM
                    DS_CONTR_BLLG_SCHD X
                WHERE
                        A.GLBL_CMPY_CD      = X.GLBL_CMPY_CD
                    AND A.DS_CONTR_DTL_PK   = X.DS_CONTR_DTL_PK
                    AND X.BLLG_SCHD_THRU_DT &gt;= #mtrReadDt#
                    AND X.INV_FLG           = 'Y'
                    AND X.USG_CHRG_FLG      = 'Y'
                    AND X.EZCANCELFLAG      = '0'
            )
    </statement>
<!-- END 2019/08/20 K.Kitachi [QC#52860, ADD] -->
<!-- START 2024/03/26 K.Watanabe [QC#63549, ADD -->
    <statement id="getFinalReadPeriod" parameterClass="Map" resultClass="Integer">
        WITH MAX_DT AS(
            SELECT
                B.DS_CONTR_PK                      AS DS_CONTR_PK
               ,A.DS_CONTR_BLLG_MTR_PK             AS DS_CONTR_BLLG_MTR_PK
               ,MAX(A.BLLG_SCHD_THRU_DT)           AS MAX_DT
            FROM
                DS_CONTR_BLLG_SCHD A
               ,DS_CONTR_DTL B
            WHERE
                    A.EZCANCELFLAG                 = '0'
                AND A.GLBL_CMPY_CD                 = #glblCmpyCd#
                AND A.USG_CHRG_FLG                 = #usgChrgFlg#
                AND A.SKIP_RECOV_TP_CD      &lt;&gt; #skipRecovTp#
                AND A.DS_BLLG_SCHD_STS_CD   &lt;&gt; #dsBllgSchdStsCd#
                AND A.GLBL_CMPY_CD                 = B.GLBL_CMPY_CD
                AND A.DS_CONTR_DTL_PK              = B.DS_CONTR_DTL_PK
                AND B.EZCANCELFLAG                 = '0'
                AND B.SVC_MACH_MSTR_PK             = #svcMachMstrPk#
            GROUP BY
                B.DS_CONTR_PK
               ,A.DS_CONTR_BLLG_MTR_PK
        ), CHECK_DT AS(
            SELECT
                DISTINCT
                DC.DS_CONTR_PK                     AS DS_CONTR_PK
               ,DCBL.DS_CONTR_BLLG_MTR_PK          AS DS_CONTR_BLLG_MTR_PK
               ,DCB.DS_CONTR_BLLG_SCHD_PK          AS DS_CONTR_BLLG_SCHD_PK
               ,TO_CHAR(TO_DATE(MD.MAX_DT, #dateFormat#) - (DECODE(DCBL.BLLG_MTR_BLLG_CYCLE_CD, #months#, COALESCE(DWD.MTR_READ_WIN_MLY_DAYS_AOT, DWD2.MTR_READ_WIN_MLY_DAYS_AOT, #mtrReadWinMlyDaysAot#, #defBefDays#), COALESCE(DWD.MTR_READ_WIN_OTH_DAYS_AOT, DWD2.MTR_READ_WIN_OTH_DAYS_AOT, #mtrReadWinOthDaysAot#, #defBefDays#))), #dateFormat#) AS INTAVAL_DT
            FROM
                DS_CONTR_BLLG_SCHD                 DCB
               ,DS_CONTR_BLLG_MTR                  DCBL
               ,DS_CONTR_DTL                       DCD
               ,DS_CONTR                           DC
               ,DS_WIN_DAYS                        DWD
               ,DS_WIN_DAYS                        DWD2
               ,MAX_DT                             MD
            WHERE
                    DCB.GLBL_CMPY_CD                        =   #glblCmpyCd#
                AND DCB.DS_CONTR_BLLG_MTR_PK                =   MD.DS_CONTR_BLLG_MTR_PK
                AND DCB.BLLG_SCHD_THRU_DT                   =   MD.MAX_DT
                AND DCB.GLBL_CMPY_CD                        =   DCBL.GLBL_CMPY_CD
                AND DCB.DS_CONTR_BLLG_MTR_PK                =   DCBL.DS_CONTR_BLLG_MTR_PK
                AND DCBL.GLBL_CMPY_CD                       =   DCD.GLBL_CMPY_CD
                AND DCBL.DS_CONTR_DTL_PK                    =   DCD.DS_CONTR_DTL_PK
                AND DCD.GLBL_CMPY_CD                        =   DC.GLBL_CMPY_CD
                AND DCD.DS_CONTR_PK                         =   DC.DS_CONTR_PK
                AND DCB.GLBL_CMPY_CD                        =   DWD.GLBL_CMPY_CD(+)
                AND SUBSTR(DCB.BLLG_SCHD_THRU_DT, 0, 6)     =   DWD.DS_WIN_DAYS_TRGT_PER_TXT(+)
                AND DC.SVC_LINE_BIZ_CD                      =   DWD.SVC_LINE_BIZ_CD(+)
                AND DCB.GLBL_CMPY_CD                        =   DWD2.GLBL_CMPY_CD(+)
                AND SUBSTR(DCB.BLLG_SCHD_THRU_DT, 0, 6)     =   DWD2.DS_WIN_DAYS_TRGT_PER_TXT(+)
                AND DWD2.SVC_LINE_BIZ_CD(+)                 =   #svcLineBizCd#
                AND DCB.EZCANCELFLAG                        =   '0'
                AND DCD.EZCANCELFLAG                        =   '0'
                AND DC.EZCANCELFLAG                         =   '0'
                AND DCBL.EZCANCELFLAG                       =   '0'
                AND DWD.EZCANCELFLAG(+)                     =   '0'
                AND DWD2.EZCANCELFLAG(+)                    =   '0'
        )
        SELECT
            COUNT(MD.MAX_DT)
        FROM
            CHECK_DT CD
           ,MAX_DT MD
        WHERE
                CD.INTAVAL_DT                  &lt;= #mtrReadDt#
            AND MD.MAX_DT                      &gt;= #mtrReadDt#
            AND CD.DS_CONTR_PK                     = MD.DS_CONTR_PK
            AND CD.DS_CONTR_BLLG_MTR_PK            = MD.DS_CONTR_BLLG_MTR_PK
    </statement>
<!-- END 2024/03/26 K.Watanabe [QC#63549, ADD] -->
</sqlMap>
