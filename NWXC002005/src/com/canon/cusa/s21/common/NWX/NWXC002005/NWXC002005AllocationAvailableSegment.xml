<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NWXC002005AllocationAvailableSegment">

	<!-- ==== Type Aliases ==== -->
	<typeAlias alias="DIST_STRU_SEGTMsg"				type="business.db.DIST_STRU_SEGTMsg"/>
	<typeAlias alias="TargetDistStructure"				type="com.canon.cusa.s21.common.NWX.NWXC002005.TargetDistStructure"/>
	<!-- ==== Result Mapping ==== -->

	<statement id="getDistStructure" parameterClass="Map" resultMap="result.TargetDistStructure">

		SELECT
			D.GLBL_CMPY_CD				GLBL_CMPY_CD
		   ,D.DIST_PLN_NUM				DIST_PLN_NUM
		   ,DS.DIST_STRU_PK				DIST_STRU_PK
		   ,DS.DIST_STRU_TP_CD			DIST_STRU_TP_CD
		   ,MIN(DPF.TM_FRAME_FROM_DT)	TM_FRAME_FROM_DT
		FROM
		    DIST        	  D
		   ,DIST_STRU   	  DS
		   ,DIST_PLN    	  DP
		   ,DIST_PLN_TM_FRAME DPF
		WHERE
				D.GLBL_CMPY_CD 		= #glblCmpyCd#
			AND	(	
		<isNotNull property="ordTakeMdseCd">
					D.ORD_TAKE_MDSE_CD	= #ordTakeMdseCd#	OR
		</isNotNull>
					D.MDSE_CD			= #mdseCd#	)
        <isNotNull property="invtyLocCd">
			AND	(	D.INVTY_LOC_CD		= #invtyLocCd#	
				OR	D.INVTY_LOC_CD		IS NULL	)
        </isNotNull>
			AND DS.GLBL_CMPY_CD		= D.GLBL_CMPY_CD
			AND	DS.DIST_STRU_PK		= D.DIST_STRU_PK
			AND	DP.GLBL_CMPY_CD 	= D.GLBL_CMPY_CD
			AND	DP.DIST_PLN_NUM		= D.DIST_PLN_NUM
			AND DP.DIST_PLN_STS_CD IN (#distPlnStsCdPlanning#, #distPlnStsCdSubmitted#)
			AND	DPF.GLBL_CMPY_CD 	= D.GLBL_CMPY_CD
			AND	DPF.DIST_PLN_NUM	= D.DIST_PLN_NUM
			AND	D.EZCANCELFLAG 		= '0'
			AND	DS.EZCANCELFLAG 	= '0'
			AND	DP.EZCANCELFLAG 	= '0'
			AND	DPF.EZCANCELFLAG	= '0'
		GROUP BY  
			D.GLBL_CMPY_CD,
			D.DIST_PLN_NUM, 
			DS.DIST_STRU_PK, 
			DS.DIST_STRU_TP_CD
		ORDER BY 
			TM_FRAME_FROM_DT
	</statement>

	<statement id="getCustomerMaintenanceUnit" parameterClass="Map" resultClass="Map">

		SELECT
			CSM.CUST_STRU_MAINT_UNIT_CD	CUST_STRU_MAINT_UNIT_CD
		   ,CSM.SET_LOC_ROLE_TP_CD		SET_LOC_ROLE_TP_CD
		FROM
			CUST_STRU_MAINT_UNIT	CSM
		WHERE
			CSM.GLBL_CMPY_CD    = #glblCmpyCd#
		AND	CSM.CUST_STRU_TP_CD = #custStruTpCd#
		AND CSM.CUST_STRU_MAINT_UNIT_CD IN
		<iterate property="prodCtrlList" var="prodCtrlList[]" open="(" close=")" conjunction=",">
			#prodCtrlList[]#
		</iterate>
		AND	CSM.EZCANCELFLAG 	= '0'

	</statement>
	
	<statement id="getSegmentBySellTo" parameterClass="Map" resultMap="result.DIST_STRU_SEGTMsg" >
		SELECT
			 DSE.GLBL_CMPY_CD				GLBL_CMPY_CD
			,DSE.DIST_STRU_SEG_PK			DIST_STRU_SEG_PK
			,DSE.DIST_STRU_PK				DIST_STRU_PK
			,DSE.DIST_STRU_DPLY_SQ_NUM		DIST_STRU_DPLY_SQ_NUM
			,DSE.DIST_STRU_LEAF_LAYER_NUM	DIST_STRU_LEAF_LAYER_NUM
			,DSE.DIST_SEG_TP_CD				DIST_SEG_TP_CD
			,DSE.FIRST_DIST_STRU_SEG_PK		FIRST_DIST_STRU_SEG_PK
			,DSE.SCD_DIST_STRU_SEG_PK		SCD_DIST_STRU_SEG_PK
			,DSE.THIRD_DIST_STRU_SEG_PK		THIRD_DIST_STRU_SEG_PK
			,DSE.FRTH_DIST_STRU_SEG_PK		FRTH_DIST_STRU_SEG_PK
			,DSE.FIFTH_DIST_STRU_SEG_PK		FIFTH_DIST_STRU_SEG_PK
			,DSE.SIXTH_DIST_STRU_SEG_PK		SIXTH_DIST_STRU_SEG_PK
			,DSE.SVNTH_DIST_STRU_SEG_PK		SVNTH_DIST_STRU_SEG_PK
			,DSE.EIGHTH_DIST_STRU_SEG_PK	EIGHTH_DIST_STRU_SEG_PK
			,DSE.DIST_STRU_SEG_NM			DIST_STRU_SEG_NM
			,DSE.ORG_CD						ORG_CD
			,DSE.TOC_CD						TOC_CD
			,DSE.CUST_STRU_ELMNT_CD			CUST_STRU_ELMNT_CD
			,DSE.CUST_CD					CUST_CD
			,DSE.LOC_ROLE_TP_CD				LOC_ROLE_TP_CD
		FROM
			DIST_STRU_SEG DSE
		WHERE
			DSE.GLBL_CMPY_CD 				= #glblCmpyCd#
		AND	DSE.DIST_STRU_PK 				= #distStruPk#
		AND	DSE.DIST_SEG_TP_CD 				= #distSegTpCd#
		AND	DSE.CUST_CD 					= #custCd#
		AND	DSE.DIST_STRU_LEAF_LAYER_NUM 	= #distStruLeafLayerNum#
		AND	DSE.LOC_ROLE_TP_CD 				= #locRoleTpCd#
		<isNotNull property="firstDistStruSegPk">
		AND	DSE.FIRST_DIST_STRU_SEG_PK = #firstDistStruSegPk#
		</isNotNull>
		<isNotNull property="sndDistStruSegPk">
		AND	DSE.SCD_DIST_STRU_SEG_PK = #sndDistStruSegPk#
		</isNotNull>		
		<isNotNull property="thirdDistStruSegPk">
		AND	DSE.THIRD_DIST_STRU_SEG_PK = #thirdDistStruSegPk#
		</isNotNull>
		<isNotNull property="frthDistStruSegPk">
		AND	DSE.FRTH_DIST_STRU_SEG_PK = #frthDistStruSegPk#
		</isNotNull>
		<isNotNull property="fifthDistStruSegPk">
		AND	DSE.FIFTH_DIST_STRU_SEG_PK = #fifthDistStruSegPk#
		</isNotNull>
		<isNotNull property="sixthDistStruSegPk">
		AND	DSE.SIXTH_DIST_STRU_SEG_PK = #sixthDistStruSegPk#
		</isNotNull>
		<isNotNull property="svnthDistStruSegPk">
		AND	DSE.SVNTH_DIST_STRU_SEG_PK = #svnthDistStruSegPk#
		</isNotNull>		
		<isNotNull property="eighthDistStruSegPk">
		AND	DSE.EIGHTH_DIST_STRU_SEG_PK = #eighthDistStruSegPk#
		</isNotNull>			
		
	</statement>
	
	<resultMap id="result.TargetDistStructure" class="TargetDistStructure">
		<result property="glblCmpyCd"   			column="GLBL_CMPY_CD"				javaType="String"/>
		<result property="distPlnNum"   			column="DIST_PLN_NUM"				javaType="String"/>
		<result property="distStruPk"   			column="DIST_STRU_PK"				javaType="BigDecimal"/>
		<result property="distStruTpCd"				column="DIST_STRU_TP_CD"			javaType="String"/>
	</resultMap>
</sqlMap>
