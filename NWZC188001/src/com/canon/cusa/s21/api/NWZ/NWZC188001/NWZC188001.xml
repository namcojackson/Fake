<?xml version="1.0" encoding="UTF-8"?>

<sqlMap namespace="NWZC188001">

    <statement id="getSelfShpgPln" parameterClass="Map" resultClass="Map">
        SELECT
            SP.SET_SHPG_PLN_NUM           AS SET_SHPG_PLN_NUM
           ,SP.SHPG_PLN_NUM               AS SHPG_PLN_NUM
           <!-- 2017/12/08 QC#22930 Add Start -->
           ,SP.TRX_HDR_NUM                AS TRX_HDR_NUM
           ,SP.TRX_LINE_NUM               AS TRX_LINE_NUM
           ,SP.TRX_LINE_SUB_NUM           AS TRX_LINE_SUB_NUM
           <!-- 2017/12/08 QC#22930 Add End -->
           ,SP.SHPG_STS_CD                AS SHPG_STS_CD
           ,SP.INVTY_LOC_CD               AS INVTY_LOC_CD
           ,SP.PO_REQ_FLG                 AS PO_REQ_FLG
           ,CD.OPEN_FLG                   AS OPEN_FLG
           ,CD.REF_CPO_DTL_LINE_NUM       AS REF_CPO_DTL_LINE_NUM
           ,CD.REF_CPO_DTL_LINE_SUB_NUM   AS REF_CPO_DTL_LINE_SUB_NUM
           ,C.CPO_HLD_FLG                 AS CPO_HLD_FLG
           ,CD.CPO_DTL_HLD_FLG            AS CPO_DTL_HLD_FLG
           ,SP.SLS_HLD_QTY                AS SLS_HLD_QTY
           ,C.REV_RECOG_METH_CD           AS REV_RECOG_METH_CD
           ,CD.LOAN_BAL_QTY               AS LOAN_BAL_QTY
           ,CD.ORD_LINE_STS_CD            AS ORD_LINE_STS_CD
           ,PT.OUT_OF_WH_INVTY_PROC_FLG   AS OUT_OF_WH_INVTY_PROC_FLG
           ,PT.INV_CRAT_PROC_FLG          AS INV_CRAT_PROC_FLG
           ,DM.SVC_ISTL_REQ_FLG           AS SVC_ISTL_REQ_FLG
           ,C.ORD_BOOK_FLG                AS ORD_BOOK_FLG
           <!-- 2018/03/05 QC#24248 Add Start -->
           ,SP.SHPG_PLN_DPLY_STS_CD       AS SHPG_PLN_DPLY_STS_CD
           <!-- 2018/03/05 QC#24248 Add End -->
           ,SP.MDSE_CD                    AS MDSE_CD    <!-- 2018/12/14 QC#29488 Add -->
           ,SP.PO_ORD_NUM                 AS PO_ORD_NUM <!-- 2021/06/17 QC#58847 Add -->
        FROM
            SHPG_PLN             SP
           ,CPO                  C
           ,CPO_DTL              CD
           ,DS_CPO_CONFIG        DCC
           ,DS_ORD_LINE_PROC_DFN DFN
           ,ORD_PROC_TP          PT
           ,DS_MDL               DM
        WHERE
                SP.GLBL_CMPY_CD     = #glblCmpyCd#
            AND SP.SHPG_PLN_NUM     = #shpgPlnNum#
            AND SP.EZCANCELFLAG     = '0'

            AND SP.GLBL_CMPY_CD     = CD.GLBL_CMPY_CD
            AND SP.TRX_HDR_NUM      = CD.CPO_ORD_NUM
            AND SP.TRX_LINE_NUM     = CD.CPO_DTL_LINE_NUM
            AND SP.TRX_LINE_SUB_NUM = CD.CPO_DTL_LINE_SUB_NUM
            AND CD.EZCANCELFLAG     = '0'

            AND CD.GLBL_CMPY_CD     = DCC.GLBL_CMPY_CD
            AND CD.DS_CPO_CONFIG_PK = DCC.DS_CPO_CONFIG_PK
            AND DCC.EZCANCELFLAG    = '0'

            AND DCC.GLBL_CMPY_CD    = C.GLBL_CMPY_CD
            AND DCC.CPO_ORD_NUM     = C.CPO_ORD_NUM
            AND C.EZCANCELFLAG      = '0'

            AND C.GLBL_CMPY_CD      = DFN.GLBL_CMPY_CD(+)
            AND C.DS_ORD_TP_CD      = DFN.DS_ORD_TP_CD(+)
            AND CD.DS_ORD_LINE_CATG_CD = DFN.DS_ORD_LINE_CATG_CD(+)
            AND DFN.EZCANCELFLAG(+) = '0'

            AND DFN.GLBL_CMPY_CD    = PT.GLBL_CMPY_CD(+)
            AND DFN.ORD_PROC_TP_CD  = PT.ORD_PROC_TP_CD(+)
            AND PT.EZCANCELFLAG(+)  = '0'

            AND DCC.GLBL_CMPY_CD    = DM.GLBL_CMPY_CD(+)
            AND DCC.MDL_ID          = DM.MDL_ID(+)
            AND DM.EZCANCELFLAG(+)  = '0'
    </statement>

    <statement id="getParentShpgPln" parameterClass="Map" resultClass="Map">
        SELECT
            SP.SHPG_PLN_NUM               AS SHPG_PLN_NUM
           ,SP.SHPG_PLN_DPLY_STS_CD       AS SHPG_PLN_DPLY_STS_CD
           ,SP.SHPG_STS_CD                AS SHPG_STS_CD
           ,SP.PO_REQ_FLG                 AS PO_REQ_FLG
           ,SP.TRX_HDR_NUM                AS TRX_HDR_NUM
           ,SP.TRX_LINE_NUM               AS TRX_LINE_NUM
           ,SP.TRX_LINE_SUB_NUM           AS TRX_LINE_SUB_NUM
           ,CD.OPEN_FLG                   AS OPEN_FLG
           ,C.REV_RECOG_METH_CD           AS REV_RECOG_METH_CD
           ,CD.LOAN_BAL_QTY               AS LOAN_BAL_QTY
           ,C.CPO_HLD_FLG                 AS CPO_HLD_FLG
           ,CD.CPO_DTL_HLD_FLG            AS CPO_DTL_HLD_FLG
           ,SP.SLS_HLD_QTY                AS SLS_HLD_QTY
           ,CD.ORD_LINE_STS_CD            AS ORD_LINE_STS_CD
           ,PT.OUT_OF_WH_INVTY_PROC_FLG   AS OUT_OF_WH_INVTY_PROC_FLG
           ,PT.INV_CRAT_PROC_FLG          AS INV_CRAT_PROC_FLG
           ,DM.SVC_ISTL_REQ_FLG           AS SVC_ISTL_REQ_FLG
           ,C.ORD_BOOK_FLG                AS ORD_BOOK_FLG
        FROM
            SHPG_PLN             SP
           ,CPO                  C
           ,CPO_DTL              CD
           ,DS_CPO_CONFIG        DCC
           ,DS_ORD_LINE_PROC_DFN DFN
           ,ORD_PROC_TP          PT
           ,DS_MDL               DM
        WHERE
                SP.GLBL_CMPY_CD = #glblCmpyCd#
            AND SP.SHPG_PLN_NUM = #shpgPlnNum#
            AND SP.EZCANCELFLAG = '0'
  
            AND SP.GLBL_CMPY_CD     = CD.GLBL_CMPY_CD
            AND SP.TRX_HDR_NUM      = CD.CPO_ORD_NUM
            AND SP.TRX_LINE_NUM     = CD.CPO_DTL_LINE_NUM
            AND SP.TRX_LINE_SUB_NUM = CD.CPO_DTL_LINE_SUB_NUM
            AND CD.EZCANCELFLAG     = '0'

            AND CD.GLBL_CMPY_CD     = DCC.GLBL_CMPY_CD
            AND CD.CPO_ORD_NUM      = DCC.CPO_ORD_NUM
            AND DCC.EZCANCELFLAG    = '0'

            AND DCC.GLBL_CMPY_CD    = C.GLBL_CMPY_CD
            AND DCC.CPO_ORD_NUM     = C.CPO_ORD_NUM
            AND C.EZCANCELFLAG      = '0'

            AND C.GLBL_CMPY_CD      = DFN.GLBL_CMPY_CD(+)
            AND C.DS_ORD_TP_CD      = DFN.DS_ORD_TP_CD(+)
            AND CD.DS_ORD_LINE_CATG_CD = DFN.DS_ORD_LINE_CATG_CD(+)
            AND DFN.EZCANCELFLAG(+) = '0'

            AND DFN.GLBL_CMPY_CD    = PT.GLBL_CMPY_CD(+)
            AND DFN.ORD_PROC_TP_CD  = PT.ORD_PROC_TP_CD(+)
            AND PT.EZCANCELFLAG(+)  = '0'

            AND DCC.GLBL_CMPY_CD    = DM.GLBL_CMPY_CD(+)
            AND DCC.MDL_ID          = DM.MDL_ID(+)
            AND DM.EZCANCELFLAG(+)  = '0'
    </statement>

    <statement id="getRtrn" parameterClass="Map" resultClass="Map">
        SELECT
            RD.OPEN_FLG AS OPEN_FLG
           ,RD.CPO_ORD_NUM 
           ,RD.DS_CPO_RTRN_LINE_NUM       AS DS_CPO_RTRN_LINE_NUM
           ,RD.DS_CPO_RTRN_LINE_SUB_NUM   AS DS_CPO_RTRN_LINE_SUB_NUM
           ,RD.RTRN_LINE_STS_CD           AS RTRN_LINE_STS_CD
           ,RD.RTRN_LINE_DPLY_STS_CD      AS RTRN_LINE_DPLY_STS_CD <!-- 2018/05/28 S21_NA#25562 Add -->
        FROM
            DS_CPO_RTRN_DTL      RD
           ,CPO                  C
           <!-- ,DS_ORD_LINE_PROC_DFN DFN
           ,ORD_PROC_TP           PT  -->
        WHERE
                RD.GLBL_CMPY_CD = #glblCmpyCd#
            AND RD.CPO_ORD_NUM = #cpoOrdNum#
            AND RD.DS_CPO_RTRN_LINE_NUM = #dsCpoRtrnLineNum#
            AND RD.DS_CPO_RTRN_LINE_SUB_NUM = #dsCpoRtrnLineSubNum#
            AND RD.EZCANCELFLAG = '0'
            AND RD.GLBL_CMPY_CD = C.GLBL_CMPY_CD
            AND RD.CPO_ORD_NUM = C.CPO_ORD_NUM
            AND C.EZCANCELFLAG = '0'
    </statement>

    <statement id="getCpo" parameterClass="Map" resultClass="Map">
        SELECT
            C.CPO_ORD_NUM AS CPO_ORD_NUM
           ,C.ORD_HDR_STS_CD AS ORD_HDR_STS_CD
           ,C.OPEN_FLG       AS OPEN_FLG
           ,C.SUBMT_FLG       AS SUBMT_FLG
        FROM
            CPO C
        WHERE
                C.GLBL_CMPY_CD = #glblCmpyCd#
            AND C.CPO_ORD_NUM = #cpoOrdNum#
            AND C.EZCANCELFLAG = '0'
    </statement>

    <statement id="getfnlzInvFlgList" parameterClass="Map" resultClass="Map">
        SELECT
            I.CPO_ORD_NUM AS CPO_ORD_NUM
        FROM
            CPO C
           ,INV I
        WHERE
                C.GLBL_CMPY_CD = #glblCmpyCd#
            AND C.CPO_ORD_NUM = #cpoOrdNum#
            AND C.EZCANCELFLAG = '0'
            AND C.GLBL_CMPY_CD = I.GLBL_CMPY_CD
            AND C.CPO_ORD_NUM = I.CPO_ORD_NUM
            AND I.FNLZ_INV_FLG = 'N'
            <!-- 2017/06/23 QC#19387 Add Start -->
            AND I.SYS_SRC_CD = #sysSrcCd#
            <!-- 2017/06/23 QC#19387 Add End -->
            AND I.EZCANCELFLAG = '0'
    </statement>

    <statement id ="getOrdHdrDplySts" parameterClass="Map" resultClass="Map">
        SELECT
            C.CPO_ORD_NUM AS CPO_ORD_NUM
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   CPO C2
                       ,HLD H
                WHERE  C2.GLBL_CMPY_CD = C.GLBL_CMPY_CD
                AND    C2.CPO_ORD_NUM  = C.CPO_ORD_NUM
                AND    C2.EZCANCELFLAG = '0'
                AND    C2.GLBL_CMPY_CD = H.GLBL_CMPY_CD
                AND    C2.CPO_ORD_NUM = H.CPO_ORD_NUM
                AND    H.EZCANCELFLAG = '0'
                AND    C2.CPO_HLD_FLG = 'Y'
                AND    C2.WF_REJ_FLG = 'N'
                AND    H.HLD_RSN_CD = #hldRsnValHld#
                AND    H.REL_FLG = 'N')
            THEN 'Y'
            ELSE 'N'
            END AS VALIDATION_HLD_FLG
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   CPO C2
                       ,HLD H
                WHERE  C2.GLBL_CMPY_CD = C.GLBL_CMPY_CD
                AND    C2.CPO_ORD_NUM  = C.CPO_ORD_NUM
                AND    C2.EZCANCELFLAG = '0'
                AND    C2.GLBL_CMPY_CD = H.GLBL_CMPY_CD
                AND    C2.CPO_ORD_NUM = H.CPO_ORD_NUM
                AND    H.EZCANCELFLAG = '0'
                AND    C2.CPO_HLD_FLG = 'Y'
                AND    C2.WF_REJ_FLG = 'N'
                AND    H.HLD_RSN_CD IN (#hldRsnSplyYieldValHld#,#hldRsnPendOrdHld#,#hldRsnContrStsHld#,#hldRsnSplyEnfoHld#)
                AND    H.REL_FLG = 'N')
            THEN 'Y'
            ELSE 'N'
            END AS SUPPLY_ABUSE_HOLD_FLG
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   CPO C2
                       ,HLD H
                WHERE  C2.GLBL_CMPY_CD = C.GLBL_CMPY_CD
                AND    C2.CPO_ORD_NUM  = C.CPO_ORD_NUM
                AND    C2.EZCANCELFLAG = '0'
                AND    C2.GLBL_CMPY_CD = H.GLBL_CMPY_CD
                AND    C2.CPO_ORD_NUM = H.CPO_ORD_NUM
                AND    H.EZCANCELFLAG = '0'
                AND    C2.CPO_HLD_FLG = 'Y'
                AND    C2.WF_REJ_FLG = 'N'
                AND    H.HLD_RSN_CD = #hldRsnProftHld#
                AND    H.REL_FLG = 'N')
            THEN 'Y'
            ELSE 'N'
            END AS PROFITABILITY_HOLD_FLG
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   CPO C2
                       ,SHPG_PLN SP
                WHERE  C2.GLBL_CMPY_CD = C.GLBL_CMPY_CD
                AND    C2.CPO_ORD_NUM  = C.CPO_ORD_NUM
                AND    C2.WF_REJ_FLG = 'N'
                AND    C2.EZCANCELFLAG = '0'
                AND    C2.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    C2.CPO_ORD_NUM = SP.TRX_HDR_NUM
                AND    SP.CR_HLD_QTY &gt; '0'
                AND    SP.EZCANCELFLAG = '0')
            THEN 'Y'
            ELSE 'N'
            END AS CREDIT_HOLD_FLG
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   CPO C2
                WHERE  C2.GLBL_CMPY_CD = C.GLBL_CMPY_CD
                AND    C2.CPO_ORD_NUM  = C.CPO_ORD_NUM
                AND    C2.CPO_HLD_FLG = 'Y'
                AND    C2.WF_REJ_FLG = 'Y'
                AND    C2.EZCANCELFLAG = '0')
            THEN 'Y'
            ELSE 'N'
            END AS PENDING_RE_SUBMISSION_FLG
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   CPO C2
                WHERE  C2.GLBL_CMPY_CD = C.GLBL_CMPY_CD
                AND    C2.CPO_ORD_NUM  = C.CPO_ORD_NUM
                AND    C2.ORD_BOOK_FLG = 'Y'
                AND    C2.EZCANCELFLAG = '0')
            THEN 'Y'
            ELSE 'N'
            END AS BOOKED_FLG
            <!-- add start 2023/04/25 QC#61337 -->
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   CPO C2
                      ,HLD H
                WHERE  C2.GLBL_CMPY_CD = C.GLBL_CMPY_CD
                AND    C2.CPO_ORD_NUM  = C.CPO_ORD_NUM
                AND    C2.EZCANCELFLAG = '0'
                AND    C2.GLBL_CMPY_CD = H.GLBL_CMPY_CD
                AND    C2.CPO_ORD_NUM  = H.CPO_ORD_NUM
                AND    H.EZCANCELFLAG  = '0'
                AND    C2.CPO_HLD_FLG  = 'Y'
                AND    C2.WF_REJ_FLG   = 'N'
                AND    H.HLD_RSN_CD    = #hldRsnManPrcHld#
                AND    H.REL_FLG       = 'N')
            THEN 'Y'
            ELSE 'N'
            END AS MAN_PRC_HOLD_FLG
            <!-- add end 2023/04/25 QC#61337 -->
        FROM
            CPO C
        WHERE
                C.GLBL_CMPY_CD = #glblCmpyCd#
            AND C.CPO_ORD_NUM = #cpoOrdNum#
            AND C.EZCANCELFLAG = '0'
    </statement>

    <statement id="getHld" parameterClass="Map" resultClass="Map">
        SELECT
            HLD_PK
        FROM   
            HLD H
        WHERE  H.GLBL_CMPY_CD = #glblCmpyCd#
        AND    H.SHPG_PLN_NUM = #shpgPlnNum#
        AND    H.HLD_RSN_CD   = #hldRsnCd#
        AND    H.REL_FLG      = 'N'
        AND    H.EZCANCELFLAG = '0'
    </statement>

<!-- 2019/03/25 QC#30923 Add Start -->
    <statement id="getHldAtChild" parameterClass="Map" resultClass="Map">
        SELECT
            HLD_PK
        FROM   
            SHPG_PLN SP
           ,HLD H
        WHERE  SP.GLBL_CMPY_CD     = #glblCmpyCd#
        AND    SP.SET_SHPG_PLN_NUM = #shpgPlnNum#
        AND    SP.EZCANCELFLAG     = '0'
        AND    SP.GLBL_CMPY_CD     = H.GLBL_CMPY_CD
        AND    SP.SHPG_PLN_NUM     = H.SHPG_PLN_NUM
        AND    H.HLD_RSN_CD        = #hldRsnCd#
        AND    H.REL_FLG           = 'N'
        AND    H.EZCANCELFLAG      = '0'
    </statement>
<!-- 2019/03/25 QC#30923 Add End -->

    <statement id="getHldProcDfn" parameterClass="Map" resultClass="Map">
        SELECT
            H.HLD_PK
<!-- 2017/09/27 QC#21167 Add Start -->
            ,H.HLD_RSN_CD
<!-- 2017/09/27 QC#21167 Add End -->
        FROM
            SHPG_PLN SP
           ,HLD H
        WHERE
            SP.GLBL_CMPY_CD    = #glblCmpyCd#
        AND SP.SHPG_PLN_NUM    = #shpgPlnNum#
        AND SP.EZCANCELFLAG    = '0'
        AND H.GLBL_CMPY_CD     = SP.GLBL_CMPY_CD
        AND H.REL_FLG          = #flgOffN#
<!-- 2019/11/11 QC#54200 Del Start -->
<!-- 2019/01/29 QC#29932 Add Start -->
<!--    AND H.HLD_RSN_CD      &lt;&gt; #exceptHldRsn# -->
<!-- 2019/01/29 QC#29932 Add End -->
<!-- 2019/11/11 QC#54200 Del End -->
        AND H.EZCANCELFLAG     = '0'
        AND ((    H.CPO_ORD_NUM      = SP.TRX_HDR_NUM
              AND H.CPO_DTL_LINE_NUM IS NULL
              AND EXISTS(
                      SELECT
                          DFN.HLD_RSN_CD
                      FROM
                          HLD_PROC_DFN DFN
                      WHERE
                          DFN.GLBL_CMPY_CD    = H.GLBL_CMPY_CD
                      AND DFN.HLD_RSN_CD      = H.HLD_RSN_CD
                      AND DFN.REL_PNT_REV_FLG = #flgOnY#
                      AND DFN.EZCANCELFLAG    = '0'
                      )
             )
             OR
             (    H.CPO_ORD_NUM          = SP.TRX_HDR_NUM
              AND H.CPO_DTL_LINE_NUM     = SP.TRX_LINE_NUM
              AND H.CPO_DTL_LINE_SUB_NUM = SP.TRX_LINE_SUB_NUM
              AND EXISTS(
                      SELECT
                          DFN.HLD_RSN_CD
                      FROM
                          HLD_PROC_DFN DFN
                         ,MDSE         M
                      WHERE
                              DFN.GLBL_CMPY_CD       = H.GLBL_CMPY_CD
                          AND DFN.HLD_RSN_CD         = H.HLD_RSN_CD
                          AND DFN.WH_TP_CD           = DECODE(SP.PO_REQ_FLG, #flgOnY#, #whTp03#, DECODE(M.INVTY_CTRL_FLG, #flgOnY#, #whTp01#, #whTp02#))
                          AND DFN.REL_PNT_REV_FLG    = #flgOnY#
                          AND DFN.EZCANCELFLAG       = '0'
                          AND H.CPO_ORD_NUM          = SP.TRX_HDR_NUM
                          AND H.CPO_DTL_LINE_NUM     = SP.TRX_LINE_NUM
                          AND H.CPO_DTL_LINE_SUB_NUM = SP.TRX_LINE_SUB_NUM
                          AND M.GLBL_CMPY_CD         = SP.GLBL_CMPY_CD
                          AND M.MDSE_CD              = SP.MDSE_CD
                          AND M.EZCANCELFLAG         = '0')))
    </statement>

    <statement id="getHardAllocBatWrk" parameterClass="Map" resultClass="Map">
        SELECT
            SP.SHPG_PLN_NUM   AS SHPG_PLN_NUM
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   HARD_ALLOC_BAT_WRK   HABW
                WHERE  HABW.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    HABW.SHPG_PLN_NUM = SP.SHPG_PLN_NUM
                AND    HABW.EZCANCELFLAG = '0')
            THEN 'Y'
            ELSE 'N'
            END AS BACK_ORDER_FLG
        FROM
            SHPG_PLN SP
        WHERE
                SP.GLBL_CMPY_CD = #glblCmpyCd#
            AND SP.SHPG_PLN_NUM = #shpgPlnNum#
            AND SP.EZCANCELFLAG = '0'
    </statement>

    <statement id="getShpgOrd" parameterClass="Map" resultClass="Map">
        SELECT
            SP.SHPG_PLN_NUM   AS SHPG_PLN_NUM
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   SHPG_PLN SP2
                      ,SHPG_ORD SO
                      ,SHPG_ORD_DTL SOD
                WHERE  SP2.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    SP2.SHPG_PLN_NUM = SP.SHPG_PLN_NUM
                AND    SP2.EZCANCELFLAG = '0'
                AND    SP2.GLBL_CMPY_CD = SO.GLBL_CMPY_CD
                AND    SP2.SO_NUM       = SO.SO_NUM
                AND    SO.PRE_ISTL_SHOP_RQST_FLG = 'Y'
                AND    SO.EZCANCELFLAG  = '0'
                AND    SO.GLBL_CMPY_CD  = SOD.GLBL_CMPY_CD
                AND    SP2.SHPG_PLN_NUM = SOD.SHPG_PLN_NUM
                AND    SOD.DS_SO_LINE_STS_CD IN (#pickConfirmed#,#inAssemblyShop#)
                AND    SOD.EZCANCELFLAG = '0')
            THEN 'Y'
            ELSE 'N'
            END AS DELIVERED_TO_SHOP_FLG
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   SHPG_PLN SP2
                      ,SHPG_ORD SO
                      ,SHPG_ORD_DTL SOD
                WHERE  SP2.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    SP2.SHPG_PLN_NUM = SP.SHPG_PLN_NUM
                AND    SP2.EZCANCELFLAG = '0'
                AND    SP2.GLBL_CMPY_CD = SO.GLBL_CMPY_CD
                AND    SP2.SO_NUM       = SO.SO_NUM
                AND    SO.PRE_ISTL_SHOP_RQST_FLG = 'Y'
                AND    SO.EZCANCELFLAG  = '0'
                AND    SO.GLBL_CMPY_CD  = SOD.GLBL_CMPY_CD
                AND    SP2.SHPG_PLN_NUM = SOD.SHPG_PLN_NUM
                AND    SOD.DS_SO_LINE_STS_CD = #techAssigned#
                AND    SOD.EZCANCELFLAG = '0')
            THEN 'Y'
            ELSE 'N'
            END AS IN_SHOP_CONFIG_FLG
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   SHPG_PLN SP2
                      ,SHPG_ORD SO
                WHERE  SP2.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    SP2.SHPG_PLN_NUM = SP.SHPG_PLN_NUM
                AND    SP2.EZCANCELFLAG = '0'
                AND    SP2.GLBL_CMPY_CD = SO.GLBL_CMPY_CD
                AND    SP2.SO_NUM       = SO.SO_NUM
                AND    SO.PRE_ISTL_SHOP_RQST_FLG = 'N'
                AND    SO.EZCANCELFLAG  = '0')
            THEN 'Y'
<!-- 2019/07/31 QC#52213 Add Start -->
            WHEN NOT EXISTS(
                SELECT 1
                FROM   SHPG_PLN SP2
                      ,SHPG_ORD SO
                      ,SHPG_ORD_DTL SOD
                WHERE  SP2.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    SP2.SHPG_PLN_NUM = SP.SHPG_PLN_NUM
                AND    SP2.EZCANCELFLAG = '0'
                AND    SP2.GLBL_CMPY_CD = SO.GLBL_CMPY_CD
                AND    SP2.SO_NUM       = SO.SO_NUM
                AND    SO.PRE_ISTL_SHOP_RQST_FLG = 'Y'
                AND    SO.EZCANCELFLAG  = '0'
                AND    SO.GLBL_CMPY_CD  = SOD.GLBL_CMPY_CD
                AND    SP2.SHPG_PLN_NUM = SOD.SHPG_PLN_NUM
                AND    SOD.DS_SO_LINE_STS_CD IN (#pickConfirmed#,#inAssemblyShop#,#techAssigned#)
                AND    SOD.EZCANCELFLAG = '0')
            THEN 'Y'
<!-- 2019/07/31 QC#52213 Add End -->
            ELSE 'N'
            END AS PENDING_SHIP_FLG
        FROM
            SHPG_PLN SP
        WHERE
                SP.GLBL_CMPY_CD = #glblCmpyCd#
            AND SP.SHPG_PLN_NUM = #shpgPlnNum#
            AND SP.EZCANCELFLAG = '0'
    </statement>

    <statement id="getcpoDtlConvOrd" parameterClass="Map" resultClass="Map">
        SELECT
            SP.SHPG_PLN_NUM   AS SHPG_PLN_NUM
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   CPO_DTL  CD
                WHERE  SP.GLBL_CMPY_CD = CD.GLBL_CMPY_CD
                AND    SP.TRX_HDR_NUM  = CD.ORIG_CPO_ORD_NUM
                AND    SP.TRX_LINE_NUM = CD.ORIG_CPO_DTL_LINE_NUM
                AND    SP.TRX_LINE_SUB_NUM = CD.ORIG_CPO_DTL_LINE_SUB_NUM
                AND    CD.EZCANCELFLAG = '0')
            THEN 'Y'
            ELSE 'N'
            END AS CLOSED_LOAN_SOLD_FLG
        FROM
            SHPG_PLN SP
        WHERE
                SP.GLBL_CMPY_CD = #glblCmpyCd#
            AND SP.SHPG_PLN_NUM = #shpgPlnNum#
            AND SP.EZCANCELFLAG = '0'
    </statement>

    <statement id="getCpoRtrnDtlConvOrd" parameterClass="Map" resultClass="Map">
        SELECT
            SP.SHPG_PLN_NUM   AS SHPG_PLN_NUM
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   DS_CPO_RTRN_DTL  RD
                WHERE  SP.GLBL_CMPY_CD = RD.GLBL_CMPY_CD
                AND    SP.TRX_HDR_NUM  = RD.ORIG_CPO_ORD_NUM
                AND    SP.TRX_LINE_NUM = RD.ORIG_CPO_DTL_LINE_NUM
                AND    SP.TRX_LINE_SUB_NUM = RD.ORIG_CPO_DTL_LINE_SUB_NUM
                AND    RD.EZCANCELFLAG = '0')
            THEN 'Y'
            ELSE 'N'
            END AS CLOSED_LOAN_RETURN_FLG
        FROM
            SHPG_PLN SP
        WHERE
                SP.GLBL_CMPY_CD = #glblCmpyCd#
            AND SP.SHPG_PLN_NUM = #shpgPlnNum#
            AND SP.EZCANCELFLAG = '0'
    </statement>

    <statement id="getFnlzInvFlg" parameterClass="Map" resultClass="Map">
        SELECT
            SP.SHPG_PLN_NUM   AS SHPG_PLN_NUM
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   INV      I
                WHERE  SP.GLBL_CMPY_CD = I.GLBL_CMPY_CD
                AND    SP.INV_NUM      = I.INV_NUM
                AND    I.FNLZ_INV_FLG   = 'Y'
                AND    I.EZCANCELFLAG = '0')
            THEN 'Y'
            ELSE 'N'
            END AS FNLZ_INV_FLG
        FROM
            SHPG_PLN SP
        WHERE
                SP.GLBL_CMPY_CD = #glblCmpyCd#
            AND SP.SHPG_PLN_NUM = #shpgPlnNum#
            AND SP.EZCANCELFLAG = '0'
    </statement>

    <statement id="getRtrnFnlzInvFlg" parameterClass="Map" resultClass="Map">
        SELECT
            RD.CPO_ORD_NUM AS CPO_ORD_NUM
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   INV      I
                WHERE  RD.GLBL_CMPY_CD  = I.GLBL_CMPY_CD
                AND    RD.INV_NUM       = I.INV_NUM
                AND    I.FNLZ_INV_FLG   = 'N'
                AND    I.EZCANCELFLAG   = '0')
            THEN 'Y'
            ELSE 'N'
            END AS FNLZ_INV_FLG
        FROM
            DS_CPO_RTRN_DTL RD
        WHERE
                RD.GLBL_CMPY_CD = #glblCmpyCd#
            AND RD.CPO_ORD_NUM = #cpoOrdNum#
            AND RD.DS_CPO_RTRN_LINE_NUM = #dsCpoRtrnLineNum#
            AND RD.DS_CPO_RTRN_LINE_SUB_NUM = #dsCpoRtrnLineSubNum#
            AND RD.EZCANCELFLAG = '0'
    </statement>

    <statement id="getDplyStsForShpgStsValidated" parameterClass="Map" resultClass="Map">
        SELECT
            SP.SHPG_PLN_NUM   AS SHPG_PLN_NUM
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   SHPG_PLN SP2
                WHERE  SP2.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM  = SP.TRX_HDR_NUM
                AND    SP2.TRX_LINE_NUM  = SP.TRX_LINE_NUM
                AND    SP2.SET_SHPG_PLN_NUM = SP.SHPG_PLN_NUM
                AND    SP2.SHPG_STS_CD = #shpgStsValidated#
                AND    SP2.PO_REQ_FLG = 'N'
                AND    (SP2.INVTY_LOC_CD in (#invtyLocCdBo#, #invtyLocCdCr#)
                       OR  SP2.INVTY_LOC_CD like #invtyLocCdLo%#)
                AND    SP2.EZCANCELFLAG = '0')
            THEN 'Y'
            ELSE 'N'
            END AS PENDING_INVOICE_FLG
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   SHPG_PLN SP2
                       ,HARD_ALLOC_BAT_WRK ABW
                WHERE  SP2.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM  = SP.TRX_HDR_NUM
                AND    SP2.TRX_LINE_NUM  = SP.TRX_LINE_NUM
                AND    SP2.SET_SHPG_PLN_NUM = SP.SHPG_PLN_NUM
                AND    SP2.SHPG_STS_CD = #shpgStsValidated#
                AND    SP2.PO_REQ_FLG = 'N'
                AND    SP2.EZCANCELFLAG = '0'
                AND    SP2.GLBL_CMPY_CD = ABW.GLBL_CMPY_CD
                AND    SP2.SHPG_PLN_NUM = ABW.SHPG_PLN_NUM
                AND    ABW.EZCANCELFLAG = '0')
            THEN 'Y'
            ELSE 'N'
            END AS BACK_ORDER_FLG
        FROM
            SHPG_PLN   SP
        WHERE
                SP.GLBL_CMPY_CD = #glblCmpyCd#
            AND SP.SHPG_PLN_NUM = #shpgPlnNum#
            AND SP.TRX_HDR_NUM  = #trxHdrNum#
            AND SP.TRX_LINE_NUM = #trxLineNum#
            AND SP.TRX_LINE_SUB_NUM = #trxLineSubNum#
            AND SP.EZCANCELFLAG = '0'
    </statement>

    <statement id="getDplyStsForShpgStsSOPrinted" parameterClass="Map" resultClass="Map">
        SELECT
            SP.SHPG_PLN_NUM   AS SHPG_PLN_NUM
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   SHPG_PLN SP2
                WHERE  SP2.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM  = SP.TRX_HDR_NUM
                AND    SP2.TRX_LINE_NUM  = SP.TRX_LINE_NUM
                AND    SP2.SET_SHPG_PLN_NUM = SP.SHPG_PLN_NUM
                AND    SP2.SHPG_STS_CD = #shpgStsSOPrinted#
                AND    SP2.EZCANCELFLAG = '0')
            THEN 'Y'
            ELSE 'N'
            END AS WAITING_RECEIPT_FLG
        FROM
            SHPG_PLN   SP
        WHERE
                SP.GLBL_CMPY_CD = #glblCmpyCd#
            AND SP.SHPG_PLN_NUM = #shpgPlnNum#
            AND SP.TRX_HDR_NUM  = #trxHdrNum#
            AND SP.TRX_LINE_NUM = #trxLineNum#
            AND SP.TRX_LINE_SUB_NUM = #trxLineSubNum#
            AND SP.EZCANCELFLAG = '0'
    </statement>

    <statement id="getDplyStsForShpgStsSOPrinted2" parameterClass="Map" resultClass="Map">
        SELECT
            SP.SHPG_PLN_NUM   AS SHPG_PLN_NUM
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   SHPG_PLN SP2
                       ,SHPG_ORD SO
                WHERE  SP2.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM  = SP.TRX_HDR_NUM
                AND    SP2.TRX_LINE_NUM  = SP.TRX_LINE_NUM
                AND    SP2.SET_SHPG_PLN_NUM = SP.SHPG_PLN_NUM
                AND    SP2.EZCANCELFLAG = '0'
                AND    SO.GLBL_CMPY_CD = SP2.GLBL_CMPY_CD
                AND    SO.SO_NUM = SP2.SO_NUM
                AND    SO.EZCANCELFLAG = '0'
                AND    (SP2.SHPG_STS_CD = #shpgStsStaged#
                       OR (SP2.SHPG_STS_CD = #shpgStsPicked#
                       AND SO.PRE_ISTL_SHOP_RQST_FLG = 'N')))
            THEN 'Y'
            ELSE 'N'
            END AS PENDING_SHIP_FLG
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   SHPG_PLN SP2
                       ,SHPG_ORD SO
                       ,SHPG_ORD_DTL SOD
                WHERE  SP2.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM  = SP.TRX_HDR_NUM
                AND    SP2.TRX_LINE_NUM  = SP.TRX_LINE_NUM
                AND    SP2.SET_SHPG_PLN_NUM = SP.SHPG_PLN_NUM
                AND    SP2.EZCANCELFLAG = '0'
                AND    SO.GLBL_CMPY_CD = SP2.GLBL_CMPY_CD
                AND    SO.SO_NUM = SP2.SO_NUM
                AND    SO.EZCANCELFLAG = '0'
                AND    SOD.GLBL_CMPY_CD = SO.GLBL_CMPY_CD
                AND    SOD.SO_NUM = SO.SO_NUM
                AND    SOD.EZCANCELFLAG = '0'
                AND    SP2.SHPG_STS_CD = #shpgStsPicked#
                AND    SO.PRE_ISTL_SHOP_RQST_FLG = 'Y'
                AND    SOD.DS_SO_LINE_STS_CD IN (#pickConfirmed#, #inAssembryShop#))
            THEN 'Y'
            ELSE 'N'
            END AS DELIVERED_TO_SHOP_FLG
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   SHPG_PLN SP2
                       ,SHPG_ORD SO
                       ,SHPG_ORD_DTL SOD
                WHERE  SP2.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM  = SP.TRX_HDR_NUM
                AND    SP2.TRX_LINE_NUM  = SP.TRX_LINE_NUM
                AND    SP2.SET_SHPG_PLN_NUM = SP.SHPG_PLN_NUM
                AND    SP2.EZCANCELFLAG = '0'
                AND    SO.GLBL_CMPY_CD = SP2.GLBL_CMPY_CD
                AND    SO.SO_NUM = SP2.SO_NUM
                AND    SO.EZCANCELFLAG = '0'
                AND    SOD.GLBL_CMPY_CD = SO.GLBL_CMPY_CD
                AND    SOD.SO_NUM = SO.SO_NUM
                AND    SOD.EZCANCELFLAG = '0'
                AND    SP2.SHPG_STS_CD = #shpgStsPicked#
                AND    SO.PRE_ISTL_SHOP_RQST_FLG = 'Y'
                AND    SOD.DS_SO_LINE_STS_CD = #techAssigned#)
            THEN 'Y'
            ELSE 'N'
            END AS IN_SHOP_CONFIG_FLG
        FROM
            SHPG_PLN   SP
        WHERE
                SP.GLBL_CMPY_CD = #glblCmpyCd#
            AND SP.SHPG_PLN_NUM = #shpgPlnNum#
            AND SP.TRX_HDR_NUM  = #trxHdrNum#
            AND SP.TRX_LINE_NUM = #trxLineNum#
            AND SP.TRX_LINE_SUB_NUM = #trxLineSubNum#
            AND SP.EZCANCELFLAG = '0'
    </statement>

    <statement id="getDplyStsForShipped" parameterClass="Map" resultClass="Map">
        SELECT
            SP.SHPG_PLN_NUM   AS SHPG_PLN_NUM
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   SHPG_PLN SP2
                       ,CPO C
                       ,CPO_DTL CD
                       ,DS_ORD_LINE_PROC_DFN DFN
                       ,ORD_PROC_TP PT
                WHERE  SP2.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM  = SP.TRX_HDR_NUM
                AND    SP2.TRX_LINE_NUM  = SP.TRX_LINE_NUM
                AND    SP2.TRX_LINE_SUB_NUM &lt;&gt; #trxLineSubNum#
                AND    SP2.SET_SHPG_PLN_NUM = SP.SHPG_PLN_NUM
                AND    SP2.SHPG_STS_CD  = #shpgStsShipped#
                AND    SP2.EZCANCELFLAG = '0'
                AND    SP2.GLBL_CMPY_CD = CD.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM  = CD.CPO_ORD_NUM
                AND    SP2.TRX_LINE_NUM  = CD.CPO_DTL_LINE_NUM
                AND    SP2.TRX_LINE_SUB_NUM  = CD.CPO_DTL_LINE_SUB_NUM
                AND    CD.EZCANCELFLAG = '0'
                AND    SP2.GLBL_CMPY_CD = C.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM = C.CPO_ORD_NUM
                AND    C.EZCANCELFLAG = '0'
                AND    C.GLBL_CMPY_CD = DFN.GLBL_CMPY_CD
                AND    C.DS_ORD_TP_CD = DFN.DS_ORD_TP_CD
                AND    C.REV_RECOG_METH_CD = #revRecogMethCd#
                AND    CD.DS_ORD_LINE_CATG_CD = DFN.DS_ORD_LINE_CATG_CD
                AND    DFN.EZCANCELFLAG = '0'
                AND    DFN.GLBL_CMPY_CD = PT.GLBL_CMPY_CD
                AND    DFN.ORD_PROC_TP_CD = PT.ORD_PROC_TP_CD
                AND    PT.INV_CRAT_PROC_FLG = 'N'
                AND    PT.EZCANCELFLAG = '0')
            THEN 'Y'
            ELSE 'N'
            END AS SHIPPED_FLG
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   SHPG_PLN SP2
                       ,CPO C
                WHERE  SP2.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM  = SP.TRX_HDR_NUM
                AND    SP2.TRX_LINE_NUM  = SP.TRX_LINE_NUM
                AND    SP2.TRX_LINE_SUB_NUM &lt;&gt; #trxLineSubNum#
                AND    SP2.SET_SHPG_PLN_NUM = SP.SHPG_PLN_NUM
                AND    SP2.SHPG_STS_CD  = #shpgStsShipped#
                AND    SP2.PO_REQ_FLG = 'N'
                AND    SP2.EZCANCELFLAG = '0'
                AND    SP2.GLBL_CMPY_CD = C.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM = C.CPO_ORD_NUM
                AND    C.REV_RECOG_METH_CD &lt;&gt; #revRecogMethCd#
                AND    C.EZCANCELFLAG = '0')
            THEN 'Y'
            ELSE 'N'
            END AS PEND_DELY_CONF_FLG
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   SHPG_PLN SP2
                       ,CPO C
                       ,CPO_DTL CD
                       ,DS_MDL DM
                       ,DS_CPO_CONFIG DCC
                       <!-- START 01/13/2023 F.Fadriquela [QC#60973,ADD] -->
                       ,ALL_MDSE_V AMV
                       <!-- END 01/13/2023 F.Fadriquela [QC#60973,ADD] -->
                WHERE  SP2.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM  = SP.TRX_HDR_NUM
                AND    SP2.TRX_LINE_NUM  = SP.TRX_LINE_NUM
                AND    SP2.TRX_LINE_SUB_NUM &lt;&gt; #trxLineSubNum#
                AND    SP2.SET_SHPG_PLN_NUM = SP.SHPG_PLN_NUM
                AND    SP2.SHPG_STS_CD  IN (#shpgStsShipped#,#shpgStsArrived#)
                AND    SP2.EZCANCELFLAG = '0'
                AND    SP2.GLBL_CMPY_CD = CD.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM = CD.CPO_ORD_NUM
                AND    SP2.TRX_LINE_NUM = CD.CPO_DTL_LINE_NUM
                AND    SP2.TRX_LINE_SUB_NUM = CD.CPO_DTL_LINE_SUB_NUM
                AND    CD.EZCANCELFLAG = '0'
                AND    CD.GLBL_CMPY_CD = C.GLBL_CMPY_CD
                AND    CD.CPO_ORD_NUM = C.CPO_ORD_NUM
                AND    C.REV_RECOG_METH_CD &lt;&gt; #revRecogMethCd#
                AND    C.EZCANCELFLAG = '0'
                AND    CD.GLBL_CMPY_CD = DCC.GLBL_CMPY_CD
                AND    CD.DS_CPO_CONFIG_PK = DCC.DS_CPO_CONFIG_PK
                AND    DCC.EZCANCELFLAG = '0'
                AND    DCC.GLBL_CMPY_CD = DM.GLBL_CMPY_CD
                AND    DCC.MDL_ID = DM.MDL_ID
                AND    DM.EZCANCELFLAG = '0'
                AND    (DM.SVC_ISTL_REQ_FLG = 'Y'
                       OR CD.LOAN_BAL_QTY &gt; 0)
                <!-- START 01/13/2023 F.Fadriquela [QC#60973,ADD] -->
                AND    AMV.GLBL_CMPY_CD        = SP2.GLBL_CMPY_CD
                AND    AMV.MDSE_CD             = SP2.MDSE_CD
                AND    AMV.INSTL_BASE_CTRL_FLG = #flgY#
                AND    AMV.INVTY_CTRL_FLG      = #flgY#
                AND    AMV.EZCANCELFLAG        = '0')
                <!-- END 01/13/2023 F.Fadriquela [QC#60973,ADD] -->
            THEN 'Y'
            ELSE 'N'
            END AS PENDING_INSTALLATION_FLG
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   SHPG_PLN SP2
                       ,CPO_DTL CD
                WHERE  SP2.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM  = SP.TRX_HDR_NUM
                AND    SP2.TRX_LINE_NUM  = SP.TRX_LINE_NUM
                AND    SP2.SET_SHPG_PLN_NUM = SP.SHPG_PLN_NUM
                AND    SP2.SHPG_STS_CD  IN (#shpgStsShipped#,#shpgStsArrived#,#shpgStsInstalled#)
                AND    SP2.PO_REQ_FLG = 'N'
                AND    SP2.EZCANCELFLAG = '0'
                AND    SP2.GLBL_CMPY_CD = CD.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM = CD.CPO_ORD_NUM
                AND    SP2.TRX_LINE_NUM = CD.CPO_DTL_LINE_NUM
                AND    SP2.TRX_LINE_SUB_NUM = CD.CPO_DTL_LINE_SUB_NUM
                AND    CD.LOAN_BAL_QTY &gt; 0
                AND    CD.EZCANCELFLAG = '0')
            THEN 'Y'
            ELSE 'N'
            END AS ON_LOAN_FLG
            ,CASE
            WHEN (EXISTS(
                SELECT 1
                FROM   SHPG_PLN SP2
                       ,CPO C
                       ,CPO_DTL CD
                       ,DS_ORD_LINE_PROC_DFN DFN
                       ,ORD_PROC_TP PT
                WHERE  SP2.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM  = SP.TRX_HDR_NUM
                AND    SP2.TRX_LINE_NUM  = SP.TRX_LINE_NUM
                AND    SP2.SET_SHPG_PLN_NUM = SP.SHPG_PLN_NUM
                AND    SP2.SHPG_STS_CD  = #shpgStsInstalled#
                AND    SP2.EZCANCELFLAG = '0'
                AND    SP2.GLBL_CMPY_CD = CD.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM  = CD.CPO_ORD_NUM
                AND    SP2.TRX_LINE_NUM  = CD.CPO_DTL_LINE_NUM
                AND    SP2.TRX_LINE_SUB_NUM  = CD.CPO_DTL_LINE_SUB_NUM
                AND    CD.LOAN_BAL_QTY = 0
                AND    CD.EZCANCELFLAG = '0'
                AND    SP2.GLBL_CMPY_CD = C.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM = C.CPO_ORD_NUM
                AND    C.EZCANCELFLAG = '0'
                AND    C.GLBL_CMPY_CD = DFN.GLBL_CMPY_CD
                AND    C.DS_ORD_TP_CD = DFN.DS_ORD_TP_CD
                AND    CD.DS_ORD_LINE_CATG_CD = DFN.DS_ORD_LINE_CATG_CD
                AND    DFN.EZCANCELFLAG = '0'
                AND    DFN.GLBL_CMPY_CD = PT.GLBL_CMPY_CD
                AND    DFN.ORD_PROC_TP_CD = PT.ORD_PROC_TP_CD
                AND    PT.INV_CRAT_PROC_FLG = 'N'
                AND    PT.EZCANCELFLAG = '0'))
              OR (EXISTS(
                SELECT 1
                FROM   SHPG_PLN SP2
                       ,CPO C
                       ,CPO_DTL CD
                       ,DS_ORD_LINE_PROC_DFN DFN
                       ,ORD_PROC_TP PT
                       ,DS_CPO_CONFIG DCC
                       ,DS_MDL DM
                WHERE  SP2.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM  = SP.TRX_HDR_NUM
                AND    SP2.TRX_LINE_NUM  = SP.TRX_LINE_NUM
                AND    SP2.TRX_LINE_SUB_NUM &lt;&gt; #trxLineSubNum#
                AND    SP2.SET_SHPG_PLN_NUM = SP.SHPG_PLN_NUM
                AND    SP2.SHPG_STS_CD  IN (#shpgStsShipped#,#shpgStsArrived#)
                AND    SP2.EZCANCELFLAG = '0'
                AND    SP2.GLBL_CMPY_CD = CD.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM  = CD.CPO_ORD_NUM
                AND    SP2.TRX_LINE_NUM  = CD.CPO_DTL_LINE_NUM
                AND    SP2.TRX_LINE_SUB_NUM  = CD.CPO_DTL_LINE_SUB_NUM
                AND    CD.LOAN_BAL_QTY = 0
                AND    CD.EZCANCELFLAG = '0'
                AND    SP2.GLBL_CMPY_CD = C.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM = C.CPO_ORD_NUM
                AND    C.EZCANCELFLAG = '0'
                AND    C.GLBL_CMPY_CD = DFN.GLBL_CMPY_CD
                AND    C.DS_ORD_TP_CD = DFN.DS_ORD_TP_CD
                AND    CD.DS_ORD_LINE_CATG_CD = DFN.DS_ORD_LINE_CATG_CD
                AND    DFN.EZCANCELFLAG = '0'
                AND    DFN.GLBL_CMPY_CD = PT.GLBL_CMPY_CD
                AND    DFN.ORD_PROC_TP_CD = PT.ORD_PROC_TP_CD
                AND    PT.INV_CRAT_PROC_FLG = 'N'
                AND    PT.EZCANCELFLAG = '0'
                AND    CD.GLBL_CMPY_CD = DCC.GLBL_CMPY_CD
                AND    CD.DS_CPO_CONFIG_PK = DCC.DS_CPO_CONFIG_PK
                AND    DCC.EZCANCELFLAG = '0'
                AND    ((DM.SVC_ISTL_REQ_FLG = 'N'
                       AND DCC.GLBL_CMPY_CD = DM.GLBL_CMPY_CD
                       AND DCC.MDL_ID = DM.MDL_ID
                       AND DM.EZCANCELFLAG = '0')
                       OR DCC.MDL_ID IS NULL)))
            THEN 'Y'
            ELSE 'N'
            END AS CLOSED_FLG
            <!-- 2017/12/08 QC#22930 Add Start -->
            ,CASE
            WHEN (EXISTS(
                SELECT 1
                FROM   HLD H
                WHERE  SP.GLBL_CMPY_CD = H.GLBL_CMPY_CD
                AND    H.REL_FLG       = 'N'
                <iterate property="ittHldRsnCdList" var="hldRsnCd[]" open="AND H.HLD_RSN_CD IN (" close=")" conjunction=",">
                #hldRsnCd[]#
                </iterate>
                AND    H.EZCANCELFLAG  = '0'
                AND    ((H.CPO_ORD_NUM = SP.TRX_HDR_NUM
                       AND H.CPO_DTL_LINE_NUM IS NULL
                       AND EXISTS(
                               SELECT
                                   1
                               FROM
                                   HLD_PROC_DFN DFN
                               WHERE
                                   DFN.GLBL_CMPY_CD    = H.GLBL_CMPY_CD
                               AND DFN.HLD_RSN_CD      = H.HLD_RSN_CD
                               AND DFN.REL_PNT_REV_FLG = 'Y'
                               AND DFN.EZCANCELFLAG    = '0'
                               )
                       )
                       OR
                       (H.CPO_ORD_NUM             = SP.TRX_HDR_NUM
                       AND H.CPO_DTL_LINE_NUM     = SP.TRX_LINE_NUM
                       AND H.CPO_DTL_LINE_SUB_NUM = SP.TRX_LINE_SUB_NUM
                       AND EXISTS(
                               SELECT
                                   1
                               FROM
                                   HLD_PROC_DFN DFN
                                   ,MDSE M
                               WHERE
                                   DFN.GLBL_CMPY_CD       = H.GLBL_CMPY_CD
                               AND DFN.HLD_RSN_CD         = H.HLD_RSN_CD
                               AND DFN.WH_TP_CD           = DECODE(SP.PO_REQ_FLG, 'Y', #whTp03#, DECODE(M.INVTY_CTRL_FLG, 'Y', #whTp01#, #whTp02#))
                               AND DFN.REL_PNT_REV_FLG    = 'Y'
                               AND DFN.EZCANCELFLAG       = '0'
                               AND H.CPO_ORD_NUM          = SP.TRX_HDR_NUM
                               AND H.CPO_DTL_LINE_NUM     = SP.TRX_LINE_NUM
                               AND H.CPO_DTL_LINE_SUB_NUM = SP.TRX_LINE_SUB_NUM
                               AND M.GLBL_CMPY_CD         = SP.GLBL_CMPY_CD
                               AND M.MDSE_CD              = SP.MDSE_CD
                               AND M.EZCANCELFLAG         = '0')
                       ))
                 ))
            THEN 'Y'
            ELSE 'N'
            END AS PENDING_DEALER_INSTALL_FLG
            ,CASE
            WHEN (EXISTS(
                SELECT 1
                FROM   HLD H
                WHERE  SP.GLBL_CMPY_CD = H.GLBL_CMPY_CD
                AND    H.REL_FLG       = 'N'
                AND    H.EZCANCELFLAG  = '0'
                AND    ((H.CPO_ORD_NUM = SP.TRX_HDR_NUM
                       AND H.CPO_DTL_LINE_NUM IS NULL
                       AND EXISTS(
                               SELECT
                                   1
                               FROM
                                   HLD_PROC_DFN DFN
                               WHERE
                                   DFN.GLBL_CMPY_CD    = H.GLBL_CMPY_CD
                               AND DFN.HLD_RSN_CD      = H.HLD_RSN_CD
                               AND DFN.REL_PNT_REV_FLG = 'Y'
                               AND DFN.EZCANCELFLAG    = '0'
                               )
                       )
                       OR
                       (H.CPO_ORD_NUM             = SP.TRX_HDR_NUM
                       AND H.CPO_DTL_LINE_NUM     = SP.TRX_LINE_NUM
                       AND H.CPO_DTL_LINE_SUB_NUM = SP.TRX_LINE_SUB_NUM
                       AND EXISTS(
                               SELECT
                                   1
                               FROM
                                   HLD_PROC_DFN DFN
                                   ,MDSE M
                               WHERE
                                   DFN.GLBL_CMPY_CD       = H.GLBL_CMPY_CD
                               AND DFN.HLD_RSN_CD         = H.HLD_RSN_CD
                               AND DFN.WH_TP_CD           = DECODE(SP.PO_REQ_FLG, 'Y', #whTp03#, DECODE(M.INVTY_CTRL_FLG, 'Y', #whTp01#, #whTp02#))
                               AND DFN.REL_PNT_REV_FLG    = 'Y'
                               AND DFN.EZCANCELFLAG       = '0'
                               AND H.CPO_ORD_NUM          = SP.TRX_HDR_NUM
                               AND H.CPO_DTL_LINE_NUM     = SP.TRX_LINE_NUM
                               AND H.CPO_DTL_LINE_SUB_NUM = SP.TRX_LINE_SUB_NUM
                               AND M.GLBL_CMPY_CD         = SP.GLBL_CMPY_CD
                               AND M.MDSE_CD              = SP.MDSE_CD
                               AND M.EZCANCELFLAG         = '0')
                       ))
                 ))
            THEN 'Y'
            ELSE 'N'
            END AS BILLING_HLD_FLG
            <!-- 2017/12/08 QC#22930 Add End -->
            ,CASE
            WHEN (EXISTS(
                SELECT 1
                FROM   SHPG_PLN SP2
                       ,CPO C
                       ,CPO_DTL CD
                       ,DS_ORD_LINE_PROC_DFN DFN
                       ,ORD_PROC_TP PT
                WHERE  SP2.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM  = SP.TRX_HDR_NUM
                AND    SP2.TRX_LINE_NUM  = SP.TRX_LINE_NUM
                AND    SP2.SET_SHPG_PLN_NUM = SP.SHPG_PLN_NUM
                AND    SP2.SHPG_STS_CD  = #shpgStsInstalled#
                AND    SP2.EZCANCELFLAG = '0'
                AND    SP2.GLBL_CMPY_CD = CD.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM  = CD.CPO_ORD_NUM
                AND    SP2.TRX_LINE_NUM  = CD.CPO_DTL_LINE_NUM
                AND    SP2.TRX_LINE_SUB_NUM  = CD.CPO_DTL_LINE_SUB_NUM
                AND    CD.LOAN_BAL_QTY = 0
                AND    CD.EZCANCELFLAG = '0'
                AND    SP2.GLBL_CMPY_CD = C.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM = C.CPO_ORD_NUM
                AND    C.EZCANCELFLAG = '0'
                AND    C.GLBL_CMPY_CD = DFN.GLBL_CMPY_CD
                AND    C.DS_ORD_TP_CD = DFN.DS_ORD_TP_CD
                AND    CD.DS_ORD_LINE_CATG_CD = DFN.DS_ORD_LINE_CATG_CD
                AND    DFN.EZCANCELFLAG = '0'
                AND    DFN.GLBL_CMPY_CD = PT.GLBL_CMPY_CD
                AND    DFN.ORD_PROC_TP_CD = PT.ORD_PROC_TP_CD
                AND    PT.INV_CRAT_PROC_FLG = 'Y'
                AND    PT.EZCANCELFLAG = '0'))
              OR (EXISTS(
                SELECT 1
                FROM   SHPG_PLN SP2
                       ,CPO C
                       ,CPO_DTL CD
                       ,DS_ORD_LINE_PROC_DFN DFN
                       ,ORD_PROC_TP PT
                       ,DS_CPO_CONFIG DCC
                       ,DS_MDL DM
                WHERE  SP2.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM  = SP.TRX_HDR_NUM
                AND    SP2.TRX_LINE_NUM  = SP.TRX_LINE_NUM
                AND    SP2.TRX_LINE_SUB_NUM &lt;&gt; #trxLineSubNum#
                AND    SP2.SET_SHPG_PLN_NUM = SP.SHPG_PLN_NUM
                AND    SP2.SHPG_STS_CD  IN (#shpgStsShipped#,#shpgStsArrived#)
                AND    SP2.EZCANCELFLAG = '0'
                AND    SP2.GLBL_CMPY_CD = CD.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM  = CD.CPO_ORD_NUM
                AND    SP2.TRX_LINE_NUM  = CD.CPO_DTL_LINE_NUM
                AND    SP2.TRX_LINE_SUB_NUM  = CD.CPO_DTL_LINE_SUB_NUM
                AND    CD.LOAN_BAL_QTY = 0
                AND    CD.EZCANCELFLAG = '0'
                AND    SP2.GLBL_CMPY_CD = C.GLBL_CMPY_CD
                AND    SP2.TRX_HDR_NUM = C.CPO_ORD_NUM
                AND    C.EZCANCELFLAG = '0'
                AND    C.GLBL_CMPY_CD = DFN.GLBL_CMPY_CD
                AND    C.DS_ORD_TP_CD = DFN.DS_ORD_TP_CD
                AND    CD.DS_ORD_LINE_CATG_CD = DFN.DS_ORD_LINE_CATG_CD
                AND    DFN.EZCANCELFLAG = '0'
                AND    DFN.GLBL_CMPY_CD = PT.GLBL_CMPY_CD
                AND    DFN.ORD_PROC_TP_CD = PT.ORD_PROC_TP_CD
                AND    PT.INV_CRAT_PROC_FLG = 'Y'
                AND    PT.EZCANCELFLAG = '0'
                AND    CD.GLBL_CMPY_CD = DCC.GLBL_CMPY_CD
                AND    CD.DS_CPO_CONFIG_PK = DCC.DS_CPO_CONFIG_PK
                AND    DCC.EZCANCELFLAG = '0'
                AND    ((DM.SVC_ISTL_REQ_FLG = 'N'
                       AND DCC.GLBL_CMPY_CD = DM.GLBL_CMPY_CD
                       AND DCC.MDL_ID = DM.MDL_ID
                       AND DM.EZCANCELFLAG = '0')
                       OR DCC.MDL_ID IS NULL)))
            THEN 'Y'
            ELSE 'N'
            END AS PENDING_INVOICE_FLG
        FROM
            SHPG_PLN   SP
        WHERE
                SP.GLBL_CMPY_CD = #glblCmpyCd#
            AND SP.SHPG_PLN_NUM = #shpgPlnNum#
            AND SP.TRX_HDR_NUM  = #trxHdrNum#
            AND SP.TRX_LINE_NUM = #trxLineNum#
            AND SP.TRX_LINE_SUB_NUM = #trxLineSubNum#
            AND SP.EZCANCELFLAG = '0'
    </statement>

    <statement id="getCpoDtlFromChangeShpgPln" parameterClass="Map" resultClass="Map">
        SELECT
            SP2.SHPG_PLN_NUM          AS SHPG_PLN_NUM
            ,SP2.ORD_QTY              AS SHPG_PLN_ORD_QTY
            ,SP2.SHPG_STS_CD          AS SHPG_STS_CD
            ,SP2.SHPG_PLN_DPLY_STS_CD AS SHPG_PLN_DPLY_STS_CD
            ,CD.CPO_ORD_NUM           AS CPO_ORD_NUM
            ,CD.CPO_DTL_LINE_NUM      AS CPO_DTL_LINE_NUM
            ,CD.CPO_DTL_LINE_SUB_NUM  AS CPO_DTL_LINE_SUB_NUM
            ,CD.ORD_QTY               AS ORD_DTL_ORD_QTY
            ,CD.ORD_LINE_DPLY_STS_CD  AS ORD_LINE_DPLY_STS_CD
        FROM
             SHPG_PLN SP
            ,CPO_DTL CD
            ,SHPG_PLN SP2
        WHERE
                SP.GLBL_CMPY_CD = #glblCmpyCd#
            AND SP.SHPG_PLN_NUM = #shpgPlnNum#
            AND SP.EZCANCELFLAG = '0'
            AND SP.GLBL_CMPY_CD = CD.GLBL_CMPY_CD
            AND SP.TRX_HDR_NUM  = CD.CPO_ORD_NUM
            AND SP.TRX_LINE_NUM = CD.CPO_DTL_LINE_NUM
            AND SP.TRX_LINE_SUB_NUM = CD.CPO_DTL_LINE_SUB_NUM
            AND CD.EZCANCELFLAG = '0'
            AND CD.GLBL_CMPY_CD = SP2.GLBL_CMPY_CD
            AND CD.CPO_ORD_NUM  = SP2.TRX_HDR_NUM
            AND CD.CPO_DTL_LINE_NUM = SP2.TRX_LINE_NUM
            AND CD.CPO_DTL_LINE_SUB_NUM = SP2.TRX_LINE_SUB_NUM
            AND SP2.EZCANCELFLAG = '0'
    </statement>

    <statement id="getRws" parameterClass="Map" resultClass="Map">
        SELECT
            RD.CPO_ORD_NUM AS CPO_ORD_NUM
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   RWS_HDR RH
                WHERE  RD.GLBL_CMPY_CD     = RH.GLBL_CMPY_CD
                AND    RD.CPO_ORD_NUM      = RH.TRX_ORD_NUM
                AND    RD.DS_CPO_CONFIG_PK = RH.DS_CPO_CONFIG_PK
                AND    RH.RWS_STS_CD       IN (#rwsStsPrinted#,#rwsStsReceiving#)
                AND    RH.EZCANCELFLAG     = '0')
            THEN 'Y'
            ELSE 'N'
            END AS PENDING_INSPECTION_FLG
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   CPO     C
                      ,RWS_HDR RH
                WHERE  C.GLBL_CMPY_CD      = RD.GLBL_CMPY_CD
                AND    C.CPO_ORD_NUM       = RD.CPO_ORD_NUM
                AND    C.CPO_HLD_FLG       = 'Y'
                AND    C.EZCANCELFLAG      = '0'
                AND    RD.GLBL_CMPY_CD     = RH.GLBL_CMPY_CD
                AND    RD.CPO_ORD_NUM      = RH.TRX_ORD_NUM
                AND    RD.DS_CPO_CONFIG_PK = RH.DS_CPO_CONFIG_PK
                AND    RH.RWS_STS_CD       = #rwsStsReceived#
                AND    RH.EZCANCELFLAG     = '0')
            THEN 'Y'
                <!-- QC#30674 Mod Start-->
            WHEN RD.CPO_DTL_HLD_FLG = 'Y'
            THEN 'Y'
                <!-- QC#30674 Mod End-->
            ELSE 'N'
            END AS BILLING_HLD_FLG
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   CPO     C
                      ,RWS_HDR RH
                      ,DS_ORD_LINE_PROC_DFN DFN
                      ,ORD_PROC_TP PT
                WHERE  C.GLBL_CMPY_CD         = RD.GLBL_CMPY_CD
                AND    C.CPO_ORD_NUM          = RD.CPO_ORD_NUM
                AND    C.EZCANCELFLAG         = '0'
                AND    RD.GLBL_CMPY_CD        = RH.GLBL_CMPY_CD
                AND    RD.CPO_ORD_NUM         = RH.TRX_ORD_NUM
                AND    RD.DS_CPO_CONFIG_PK    = RH.DS_CPO_CONFIG_PK
                AND    RH.RWS_STS_CD          = #rwsStsReceived#
                AND    RH.EZCANCELFLAG        = '0'
                AND    C.GLBL_CMPY_CD         = DFN.GLBL_CMPY_CD
                AND    C.DS_ORD_TP_CD         = DFN.DS_ORD_TP_CD
                AND    RD.DS_ORD_LINE_CATG_CD = DFN.DS_ORD_LINE_CATG_CD
                AND    DFN.EZCANCELFLAG       = '0'
                AND    DFN.GLBL_CMPY_CD       = PT.GLBL_CMPY_CD
                AND    DFN.ORD_PROC_TP_CD     = PT.ORD_PROC_TP_CD
                AND    PT.INV_CRAT_PROC_FLG   = 'N'
                AND    PT.EZCANCELFLAG        = '0')
            THEN 'Y'
            ELSE 'N'
            END AS CLOSED_FLG
            ,CASE
            WHEN EXISTS(
                SELECT 1
                FROM   CPO     C
                      ,RWS_HDR RH
                WHERE  C.GLBL_CMPY_CD      = RD.GLBL_CMPY_CD
                AND    C.CPO_ORD_NUM       = RD.CPO_ORD_NUM
                AND    C.CPO_HLD_FLG       = 'N'
                AND    C.EZCANCELFLAG      = '0'
                AND    RD.GLBL_CMPY_CD     = RH.GLBL_CMPY_CD
                AND    RD.CPO_ORD_NUM      = RH.TRX_ORD_NUM
                AND    RD.DS_CPO_CONFIG_PK = RH.DS_CPO_CONFIG_PK
                AND    RH.RWS_STS_CD       = #rwsStsReceived#
                AND    RH.EZCANCELFLAG     = '0')
                <!-- QC#30674 Mod Start-->
                AND RD.CPO_DTL_HLD_FLG = 'N'
                <!-- QC#30674 Mod End-->
            THEN 'Y'
            ELSE 'N'
            END AS PENDING_INVOICE_FLG
        FROM
            DS_CPO_RTRN_DTL RD
        WHERE
                RD.GLBL_CMPY_CD = #glblCmpyCd#
            AND RD.CPO_ORD_NUM = #cpoOrdNum#
            AND RD.DS_CPO_RTRN_LINE_NUM = #dsCpoRtrnLineNum#
            AND RD.DS_CPO_RTRN_LINE_SUB_NUM = #dsCpoRtrnLineSubNum#
            AND RD.EZCANCELFLAG = '0'
    </statement>

    <statement id="getRefLineData" parameterClass="Map" resultClass="Map">
        SELECT
            CD.CPO_ORD_NUM                AS CPO_ORD_NUM
           ,CD.CPO_DTL_LINE_NUM           AS CPO_DTL_LINE_NUM
           ,CD.CPO_DTL_LINE_SUB_NUM       AS CPO_DTL_LINE_SUB_NUM
           ,CASE
           WHEN EXISTS(
               SELECT 1
               FROM   CPO_DTL  CD2
                     ,SHPG_PLN SP2
               WHERE  CD2.GLBL_CMPY_CD         = CD.GLBL_CMPY_CD
               AND    CD2.CPO_ORD_NUM          = CD.CPO_ORD_NUM
               AND    CD2.CPO_DTL_LINE_NUM     = CD.CPO_DTL_LINE_NUM
               AND    CD2.CPO_DTL_LINE_SUB_NUM = CD.CPO_DTL_LINE_SUB_NUM
               AND    CD2.EZCANCELFLAG         = '0'
               AND    SP2.GLBL_CMPY_CD         = CD2.GLBL_CMPY_CD
               AND    SP2.TRX_HDR_NUM          = CD2.CPO_ORD_NUM
               AND    SP2.TRX_LINE_NUM         = CD2.CPO_DTL_LINE_NUM
               AND    SP2.TRX_LINE_SUB_NUM     = CD2.CPO_DTL_LINE_SUB_NUM
               AND    SP2.SHPG_STS_CD          = #shpgStsCd10#
               AND    SP2.PO_REQ_FLG           = 'N'
               AND    (SP2.INVTY_LOC_CD        in (#invtyLocCdBo#, #invtyLocCdCr#)
                      OR  SP2.INVTY_LOC_CD     like #invtyLocCdLo%#)
               AND    SP2.EZCANCELFLAG         = '0')
    <!-- 2019/03/19 QC#30803 Add Start -->
           OR   EXISTS(
               SELECT 1
               FROM   CPO_DTL         CD2
                     ,SHPG_PLN        SP2
                     ,MDSE            M2
                     ,SVC_CONFIG_MSTR SCM2
                     ,SVC_MACH_MSTR   SMM2
               WHERE  CD2.GLBL_CMPY_CD          = CD.GLBL_CMPY_CD
               AND    CD2.CPO_ORD_NUM           = CD.CPO_ORD_NUM
               AND    CD2.CPO_DTL_LINE_NUM      = CD.CPO_DTL_LINE_NUM
               AND    CD2.CPO_DTL_LINE_SUB_NUM  = CD.CPO_DTL_LINE_SUB_NUM
               AND    CD2.EZCANCELFLAG          = '0'
               AND    SP2.GLBL_CMPY_CD          = CD2.GLBL_CMPY_CD
               AND    SP2.TRX_HDR_NUM           = CD2.CPO_ORD_NUM
               AND    SP2.TRX_LINE_NUM          = CD2.CPO_DTL_LINE_NUM
               AND    SP2.TRX_LINE_SUB_NUM      = CD2.CPO_DTL_LINE_SUB_NUM
               AND    SP2.EZCANCELFLAG          = '0'
               AND    SP2.PO_REQ_FLG            = 'N'
               AND    SP2.INVTY_LOC_CD          IS NULL
               AND    SP2.GLBL_CMPY_CD          = M2.GLBL_CMPY_CD
               AND    SP2.MDSE_CD               = M2.MDSE_CD
               AND    M2.INVTY_CTRL_FLG         = 'N'
               AND    M2.INSTL_BASE_CTRL_FLG    = 'Y'
               AND    M2.EZCANCELFLAG           = '0'
               AND    CD2.GLBL_CMPY_CD          = SCM2.GLBL_CMPY_CD
               AND    CD2.SVC_CONFIG_MSTR_PK    = SCM2.SVC_CONFIG_MSTR_PK
               AND    SCM2.EZCANCELFLAG         ='0'
               AND    SCM2.GLBL_CMPY_CD         = SMM2.GLBL_CMPY_CD
               AND    SCM2.SVC_MACH_MSTR_PK     = SMM2.SVC_MACH_MSTR_PK
               AND    SMM2.SVC_MACH_MSTR_STS_CD = #svcMachMstrStsCdInstalled#
               AND    SMM2.EZCANCELFLAG         ='0'
               )
    <!-- 2019/03/19 QC#30803 Add End   -->
           OR   EXISTS(
               SELECT 1
               FROM   CPO_DTL                  CD2
                     ,DS_CPO_CONFIG            DCC
                     ,SHPG_PLN                 SP2
                     ,CPO                      C2
                     ,DS_ORD_LINE_PROC_DFN     DFN
                     ,ORD_PROC_TP              PT
                     ,DS_MDL                   DM
               WHERE  CD.GLBL_CMPY_CD          = CD2.GLBL_CMPY_CD
               AND    CD.CPO_ORD_NUM           = CD2.CPO_ORD_NUM
               AND    CD.CPO_DTL_LINE_NUM      = CD2.CPO_DTL_LINE_NUM
               AND    CD.CPO_DTL_LINE_SUB_NUM  = CD2.CPO_DTL_LINE_SUB_NUM
               AND    CD2.LOAN_BAL_QTY         = 0
               AND    CD2.EZCANCELFLAG         = '0'
               AND    CD2.GLBL_CMPY_CD         = DCC.GLBL_CMPY_CD
               AND    CD2.DS_CPO_CONFIG_PK     = DCC.DS_CPO_CONFIG_PK
               AND    DCC.EZCANCELFLAG         = '0'
               AND    CD2.GLBL_CMPY_CD         = SP2.GLBL_CMPY_CD
               AND    CD2.CPO_ORD_NUM          = SP2.TRX_HDR_NUM
               AND    CD2.CPO_DTL_LINE_NUM     = SP2.TRX_LINE_NUM
               AND    CD2.CPO_DTL_LINE_SUB_NUM = SP2.TRX_LINE_SUB_NUM
               AND    SP2.SHPG_STS_CD          = #shpgStsCd38#
               AND    SP2.EZCANCELFLAG         = '0'
               AND    CD2.GLBL_CMPY_CD         = C2.GLBL_CMPY_CD
               AND    CD2.CPO_ORD_NUM          = C2.CPO_ORD_NUM
               AND    C2.REV_RECOG_METH_CD     = #revRecogMeth010#
               AND    C2.EZCANCELFLAG          = '0'
               AND    C2.GLBL_CMPY_CD          = DFN.GLBL_CMPY_CD
               AND    C2.DS_ORD_TP_CD          =  DFN.DS_ORD_TP_CD
               AND    CD2.DS_ORD_LINE_CATG_CD  = DFN.DS_ORD_LINE_CATG_CD
               AND    DFN.EZCANCELFLAG         = '0'
               AND    DFN.GLBL_CMPY_CD         =  PT.GLBL_CMPY_CD
               AND    DFN.ORD_PROC_TP_CD       = PT.ORD_PROC_TP_CD
               AND    PT.INV_CRAT_PROC_FLG     = 'Y'
               AND    PT.EZCANCELFLAG          = '0'
               AND    DM.GLBL_CMPY_CD          = DCC.GLBL_CMPY_CD
               AND    DM.MDL_ID                = DCC.MDL_ID
               AND    DM.SVC_ISTL_REQ_FLG      = 'N'
               AND    DM.EZCANCELFLAG          = '0')
           OR  EXISTS(
               SELECT 1
               FROM   CPO_DTL                  CD2
                     ,DS_CPO_CONFIG            DCC
                     ,SHPG_PLN                 SP2
                     ,CPO                      C2
                     ,DS_ORD_LINE_PROC_DFN     DFN
                     ,ORD_PROC_TP              PT
                     ,DS_MDL                   DM
               WHERE  CD.GLBL_CMPY_CD          = CD2.GLBL_CMPY_CD
               AND    CD.CPO_ORD_NUM           = CD2.CPO_ORD_NUM
               AND    CD.CPO_DTL_LINE_NUM      = CD2.CPO_DTL_LINE_NUM
               AND    CD.CPO_DTL_LINE_SUB_NUM  = CD2.CPO_DTL_LINE_SUB_NUM
               AND    CD2.LOAN_BAL_QTY         = 0
               AND    CD2.EZCANCELFLAG         = '0'
               AND    CD2.GLBL_CMPY_CD         = DCC.GLBL_CMPY_CD
               AND    CD2.DS_CPO_CONFIG_PK     = DCC.DS_CPO_CONFIG_PK
               AND    DCC.EZCANCELFLAG         = '0'
               AND    CD2.GLBL_CMPY_CD         = SP2.GLBL_CMPY_CD
               AND    CD2.CPO_ORD_NUM          = SP2.TRX_HDR_NUM
               AND    CD2.CPO_DTL_LINE_NUM     = SP2.TRX_LINE_NUM
               AND    CD2.CPO_DTL_LINE_SUB_NUM = SP2.TRX_LINE_SUB_NUM
               AND    SP2.SHPG_STS_CD          = #shpgStsCd50#
               AND    SP2.EZCANCELFLAG         = '0'
               AND    CD2.GLBL_CMPY_CD         = C2.GLBL_CMPY_CD
               AND    CD2.CPO_ORD_NUM          = C2.CPO_ORD_NUM
               AND    C2.EZCANCELFLAG          = '0'
               AND    DFN.GLBL_CMPY_CD         = C2.GLBL_CMPY_CD
               AND    DFN.DS_ORD_TP_CD         = C2.DS_ORD_TP_CD
               AND    DFN.DS_ORD_LINE_CATG_CD  = CD.DS_ORD_LINE_CATG_CD
               AND    DFN.EZCANCELFLAG         = '0'
               AND    PT.GLBL_CMPY_CD          = DFN.GLBL_CMPY_CD
               AND    PT.ORD_PROC_TP_CD        = DFN.ORD_PROC_TP_CD
               AND    PT.INV_CRAT_PROC_FLG     = 'Y'
               AND    PT.EZCANCELFLAG          = '0'
               AND    DM.GLBL_CMPY_CD          = DCC.GLBL_CMPY_CD
               AND    DM.MDL_ID                = DCC.MDL_ID
               AND    DM.SVC_ISTL_REQ_FLG      = 'N'
               AND    DM.EZCANCELFLAG          = '0')
           OR  EXISTS(
               SELECT 1
               FROM   CPO_DTL  CD2
                     ,DS_CPO_CONFIG DCC
                     ,SHPG_PLN SP2
                     ,CPO      C2
                     ,DS_ORD_LINE_PROC_DFN DFN
                     ,ORD_PROC_TP PT
               WHERE  CD.GLBL_CMPY_CD          = CD2.GLBL_CMPY_CD
               AND    CD.CPO_ORD_NUM           = CD2.CPO_ORD_NUM
               AND    CD.CPO_DTL_LINE_NUM      = CD2.CPO_DTL_LINE_NUM
               AND    CD.CPO_DTL_LINE_SUB_NUM  = CD2.CPO_DTL_LINE_SUB_NUM
               AND    CD2.LOAN_BAL_QTY         = 0
               AND    CD2.EZCANCELFLAG         = '0'
               AND    CD2.GLBL_CMPY_CD         = DCC.GLBL_CMPY_CD
               AND    CD2.DS_CPO_CONFIG_PK     = DCC.DS_CPO_CONFIG_PK
               AND    DCC.EZCANCELFLAG         = '0'
               AND    CD2.GLBL_CMPY_CD         = SP2.GLBL_CMPY_CD
               AND    CD2.CPO_ORD_NUM          = SP2.TRX_HDR_NUM
               AND    CD2.CPO_DTL_LINE_NUM     = SP2.TRX_LINE_NUM
               AND    CD2.CPO_DTL_LINE_SUB_NUM = SP2.TRX_LINE_SUB_NUM
               AND    SP2.SHPG_STS_CD          = #shpgStsCd60#
               AND    SP2.EZCANCELFLAG         = '0'
               AND    CD2.GLBL_CMPY_CD         = C2.GLBL_CMPY_CD
               AND    CD2.CPO_ORD_NUM          = C2.CPO_ORD_NUM
               AND    C2.EZCANCELFLAG          = '0'
               AND    DFN.GLBL_CMPY_CD         = C2.GLBL_CMPY_CD
               AND    DFN.DS_ORD_TP_CD         = C2.DS_ORD_TP_CD
               AND    DFN.DS_ORD_LINE_CATG_CD  = CD.DS_ORD_LINE_CATG_CD
               AND    DFN.EZCANCELFLAG         = '0'
               AND    PT.GLBL_CMPY_CD          = DFN.GLBL_CMPY_CD
               AND    PT.ORD_PROC_TP_CD        = DFN.ORD_PROC_TP_CD
               AND    PT.INV_CRAT_PROC_FLG     = 'Y'
               AND    PT.EZCANCELFLAG          = '0')
           THEN 'Y'
           ELSE 'N'
           END                            AS PENDING_INVOICE_FLG
           ,CASE
            WHEN EXISTS (
                 SELECT 1
                 FROM   CPO_DTL                   CD2
                        ,DS_CPO_CONFIG            DCC
                        ,SHPG_PLN                 SP2
                        ,CPO                      C2
                        ,DS_ORD_LINE_PROC_DFN     DFN
                        ,ORD_PROC_TP              PT
                        ,DS_MDL                   DM
                  WHERE  CD.GLBL_CMPY_CD          = CD2.GLBL_CMPY_CD
                  AND    CD.CPO_ORD_NUM           = CD2.CPO_ORD_NUM
                  AND    CD.CPO_DTL_LINE_NUM      = CD2.CPO_DTL_LINE_NUM
                  AND    CD.CPO_DTL_LINE_SUB_NUM  = CD2.CPO_DTL_LINE_SUB_NUM
                  <!-- AND    CD2.LOAN_BAL_QTY         = 0 //QC#22490 -->
                  AND    CD2.EZCANCELFLAG         = '0'
                  AND    CD2.GLBL_CMPY_CD         = DCC.GLBL_CMPY_CD
                  AND    CD2.DS_CPO_CONFIG_PK     = DCC.DS_CPO_CONFIG_PK
                  AND    DCC.EZCANCELFLAG         = '0'
                  AND    CD2.GLBL_CMPY_CD         = SP2.GLBL_CMPY_CD
                  AND    CD2.CPO_ORD_NUM          = SP2.TRX_HDR_NUM
                  AND    CD2.CPO_DTL_LINE_NUM     = SP2.TRX_LINE_NUM
                  AND    CD2.CPO_DTL_LINE_SUB_NUM = SP2.TRX_LINE_SUB_NUM
                  AND    SP2.SHPG_STS_CD          IN (#shpgStsCd38#, #shpgStsCd50#)
                  AND    SP2.EZCANCELFLAG         = '0'
                  AND    CD2.GLBL_CMPY_CD         = C2.GLBL_CMPY_CD
                  AND    CD2.CPO_ORD_NUM          = C2.CPO_ORD_NUM
                  AND    C2.EZCANCELFLAG          = '0'
                  AND    DFN.GLBL_CMPY_CD         = C2.GLBL_CMPY_CD
                  AND    DFN.DS_ORD_TP_CD         = C2.DS_ORD_TP_CD
                  AND    DFN.DS_ORD_LINE_CATG_CD  = CD.DS_ORD_LINE_CATG_CD
                  AND    DFN.EZCANCELFLAG         = '0'
                  AND    PT.GLBL_CMPY_CD          = DFN.GLBL_CMPY_CD
                  AND    PT.ORD_PROC_TP_CD        = DFN.ORD_PROC_TP_CD
                  AND    PT.INV_CRAT_PROC_FLG     = 'N'
                  AND    PT.EZCANCELFLAG          = '0'
                  AND    DM.GLBL_CMPY_CD          = DCC.GLBL_CMPY_CD
                  AND    DM.MDL_ID                = DCC.MDL_ID
                  AND    DM.SVC_ISTL_REQ_FLG      = 'N'
                  AND    DM.EZCANCELFLAG          = '0')
             OR  EXISTS (
                 SELECT 1
                 FROM   CPO_DTL  CD2
                        ,DS_CPO_CONFIG DCC
                        ,SHPG_PLN SP2
                        ,CPO      C2
                        ,DS_ORD_LINE_PROC_DFN DFN
                        ,ORD_PROC_TP PT
                  WHERE  CD.GLBL_CMPY_CD          = CD2.GLBL_CMPY_CD
                  AND    CD.CPO_ORD_NUM           = CD2.CPO_ORD_NUM
                  AND    CD.CPO_DTL_LINE_NUM      = CD2.CPO_DTL_LINE_NUM
                  AND    CD.CPO_DTL_LINE_SUB_NUM  = CD2.CPO_DTL_LINE_SUB_NUM
                  <!-- AND    CD2.LOAN_BAL_QTY         = 0 // QC#22490 -->
                  AND    CD2.EZCANCELFLAG         = '0'
                  AND    CD2.GLBL_CMPY_CD         = DCC.GLBL_CMPY_CD
                  AND    CD2.DS_CPO_CONFIG_PK     = DCC.DS_CPO_CONFIG_PK
                  AND    DCC.EZCANCELFLAG         = '0'
                  AND    CD2.GLBL_CMPY_CD         = SP2.GLBL_CMPY_CD
                  AND    CD2.CPO_ORD_NUM          = SP2.TRX_HDR_NUM
                  AND    CD2.CPO_DTL_LINE_NUM     = SP2.TRX_LINE_NUM
                  AND    CD2.CPO_DTL_LINE_SUB_NUM = SP2.TRX_LINE_SUB_NUM
                  AND    SP2.SHPG_STS_CD          = #shpgStsCd60#
                  AND    SP2.EZCANCELFLAG         = '0'
                  AND    CD2.GLBL_CMPY_CD         = C2.GLBL_CMPY_CD
                  AND    CD2.CPO_ORD_NUM          = C2.CPO_ORD_NUM
                  AND    C2.EZCANCELFLAG          = '0'
                  AND    DFN.GLBL_CMPY_CD         = C2.GLBL_CMPY_CD
                  AND    DFN.DS_ORD_TP_CD         = C2.DS_ORD_TP_CD
                  AND    DFN.DS_ORD_LINE_CATG_CD  = CD.DS_ORD_LINE_CATG_CD
                  AND    DFN.EZCANCELFLAG         = '0'
                  AND    PT.GLBL_CMPY_CD          = DFN.GLBL_CMPY_CD
                  AND    PT.ORD_PROC_TP_CD        = DFN.ORD_PROC_TP_CD
                  AND    PT.INV_CRAT_PROC_FLG     = 'N'
                  AND    PT.EZCANCELFLAG          = '0')
             THEN 'Y'
             ELSE 'N'
             END                            AS CLOSE_FLG
        FROM
            CPO_DTL  CD
        WHERE
                CD.GLBL_CMPY_CD         = #glblCmpyCd#
            AND CD.CPO_ORD_NUM          = #cpoOrdNum#
            AND CD.CPO_DTL_LINE_NUM     = #refCpoDtlLineNum#
            AND CD.CPO_DTL_LINE_SUB_NUM = #refCpoDtlLineSubNum#
            AND CD.EZCANCELFLAG         = '0'
    </statement>

    <!-- 2019/03/01 QC#30599 Add Start -->
    <statement id="getMachineSts" parameterClass="Map" resultClass="Map">
        SELECT
            SMM.SVC_MACH_MSTR_STS_CD
        FROM
             SHPG_PLN        SP
            ,CPO_DTL         CD
            ,SVC_CONFIG_MSTR SCM
            ,SVC_MACH_MSTR   SMM
        WHERE
             SP.GLBL_CMPY_CD         = #glblCmpyCd#
         AND SP.SHPG_PLN_NUM         = #shpgPlnNum#
         AND SP.EZCANCELFLAG         = '0'
         AND SP.GLBL_CMPY_CD         = CD.GLBL_CMPY_CD
         AND SP.TRX_HDR_NUM          = CD.CPO_ORD_NUM 
         AND SP.TRX_LINE_NUM         = CD.CPO_DTL_LINE_NUM
         AND SP.TRX_LINE_SUB_NUM     = CD.CPO_DTL_LINE_SUB_NUM
         AND CD.EZCANCELFLAG         ='0'
         AND CD.GLBL_CMPY_CD         = SCM.GLBL_CMPY_CD
         AND CD.SVC_CONFIG_MSTR_PK   = SCM.SVC_CONFIG_MSTR_PK
         AND SCM.EZCANCELFLAG        ='0'
         AND SCM.GLBL_CMPY_CD        = SMM.GLBL_CMPY_CD
         AND SCM.SVC_MACH_MSTR_PK    = SMM.SVC_MACH_MSTR_PK
         AND SMM.EZCANCELFLAG        ='0'
    </statement>
    <!-- 2019/03/01 QC#30599 Add End -->
</sqlMap>