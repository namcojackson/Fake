<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSAB042001">
    <statement id="getSvcInvInfo" parameterClass="Map" resultClass="Map">
        WITH 
             SIV AS (
                SELECT
                     A.GLBL_CMPY_CD
                    ,A.SVC_INV_PK
                    ,A.DS_CONTR_NUM
                    ,A.SVC_INV_NUM
                    ,A.DS_CONTR_PK
                    ,A.ORIG_SVC_INV_NUM
                    ,A.CUST_CARE_TKT_NUM
                FROM
                    SVC_INV A
                WHERE
                        A.GLBL_CMPY_CD      = #glblCmpyCd#
                    AND A.SVC_CR_REBIL_PK   IS NOT NULL
                    AND A.CFS_LINK_STS_CD   IN (#cfsLinkStsCd_inCompleted#, #cfsLinkStsCd_error#)
                    AND A.INV_TP_CD         IN (#invoice#, #debitMemo#)
                    AND A.EZCANCELFLAG      = '0')
            ,SIL AS (
                SELECT
                         SIV1.GLBL_CMPY_CD
                        ,SIV1.SVC_INV_PK
                        ,SIV1.ORIG_SVC_INV_NUM
                        ,SILN.SVC_INV_LINE_PK
                        ,SILN.SVC_MACH_MSTR_PK
                        ,SILN.BLLG_PER_FROM_DT
                        ,SILN.BLLG_PER_THRU_DT
                        ,SILN.SER_NUM
                        ,SILN.SVC_INV_LINE_TP_CD
                        ,SILN.SVC_INV_CHRG_TP_CD
                        ,SILM.SVC_INV_LINE_MTR_PK
                        ,SILM.DS_CONTR_BLLG_MTR_PK
                        ,SILM.TEST_COPY_QTY
                        ,SILM.TOT_COPY_QTY
                        ,SILM.PREV_TOT_COPY_QTY
                        ,SILM.MTR_READ_DT
                        ,SILM.MTR_LB_CD
                        ,DSCN.DS_CONTR_PK
                        ,DSCN.DS_CONTR_CATG_CD
                        ,DCCG.DS_CONTR_CATG_ABBR_NM
                        <!-- START 2017/08/01 K.Kojima [QC#20363,ADD] -->
                        <!-- ,STCT.DS_ACCT_DLR_CD -->
                        ,MSTC.DS_ACCT_DLR_CD
                        <!-- MOD 2017/08/01 K.Kojima [QC#20363,ADD] -->
                        <!-- START 2017/06/02 K.Kojima [QC#18762, MOD] -->
                        <!-- ,CLCN.CFS_LEASE_NUM -->
                        <!-- START 2017/11/22 [QC#21766,MOD] -->
                        ,MSTC_P.DS_ACCT_DLR_CD DS_ACCT_DLR_CD_P
                        <!-- END 2017/11/22 [QC#21766,MOD] -->
                        ,(
                            SELECT
                                CFS_LEASE_NUM
                            FROM
                                (
                                    SELECT
                                         CLC.CFS_LEASE_NUM AS CFS_LEASE_NUM
                                        ,'01'              AS SORT_ORDER
                                    FROM
                                        CFS_LEASE_CONTR CLC
                                    WHERE
                                            DSCN.GLBL_CMPY_CD       = CLC.GLBL_CMPY_CD
                                        AND DSCN.DS_CONTR_NUM       = CLC.CSA_CONTR_NUM
                                        AND CLC.EZCANCELFLAG        = '0'
                                    UNION ALL
                                    SELECT
                                         CLC.CFS_LEASE_NUM AS CFS_LEASE_NUM
                                        ,'02'              AS SORT_ORDER
                                    FROM
                                        CFS_LEASE_CONTR CLC
                                    WHERE
                                            SILN.GLBL_CMPY_CD       = CLC.GLBL_CMPY_CD
                                        AND SILN.SER_NUM            = CLC.SER_NUM
                                        AND CLC.EZCANCELFLAG        = '0'
                                    UNION ALL
                                    SELECT
                                         NULL              AS CFS_LEASE_NUM
                                        ,'03'              AS SORT_ORDER
                                    FROM
                                        DUAL
                                    ORDER BY
                                         SORT_ORDER     ASC
                                        ,CFS_LEASE_NUM  DESC
                                )
                            WHERE
                                ROWNUM = 1
                         ) AS CFS_LEASE_NUM
                        <!-- END 2017/06/02 K.Kojima [QC#18762, MOD] -->
                    FROM
                         SIV                SIV1
                        ,SVC_INV_LINE       SILN
                        ,SVC_INV_LINE_MTR   SILM
                        ,DS_CONTR           DSCN
                        ,DS_CONTR_CATG      DCCG
                        <!-- START 2017/08/01 K.Kojima [QC#20363,DEL] -->
                        <!-- ,SELL_TO_CUST       STCT -->
                        <!-- END 2017/08/01 K.Kojima [QC#20363,DEL] -->
                        <!-- START 2017/06/02 K.Kojima [QC#18762, DEL] -->
                        <!-- ,CFS_LEASE_CONTR    CLCN -->
                        <!-- END 2017/06/02 K.Kojima [QC#18762, DEL] -->
                        <!-- START 2017/08/01 K.Kojima [QC#20363,ADD] -->
                        ,DS_CONTR_BLLG_MTR  DCBM
                        ,BILL_TO_CUST       MBTC
                        ,SELL_TO_CUST       MSTC
                        <!-- END 2017/08/01 K.Kojima [QC#20363,ADD] -->
                        <!-- START 2017/11/22 [QC#21766,MOD] -->
                        ,DS_CONTR_BLLG_SCHD SCHD
                        ,DS_CONTR_BLLG_SCHD SCHD_P
                        ,DS_CONTR_BLLG_MTR  DCBM_P
                        ,BILL_TO_CUST       MBTC_P
                        ,SELL_TO_CUST       MSTC_P
                        <!-- END 2017/11/22 [QC#21766,MOD] -->
                    WHERE
                            SIV1.GLBL_CMPY_CD       = SILN.GLBL_CMPY_CD
                        AND SIV1.SVC_INV_NUM        = SILN.SVC_INV_NUM
                        AND SILN.SVC_INV_LINE_TP_CD IN (#svcInvLineTpCd_fleet#, #svcInvLineTpCd_machine#)
                        AND SILN.EZCANCELFLAG       = '0'
                        AND SILN.GLBL_CMPY_CD       = SILM.GLBL_CMPY_CD
                        AND SILN.SVC_INV_LINE_PK    = SILM.SVC_INV_LINE_PK
                        AND SILN.SVC_INV_LINE_NUM   = SILM.SVC_INV_LINE_NUM
                        AND SILM.EZCANCELFLAG       = '0'
                        AND SIV1.GLBL_CMPY_CD       = DSCN.GLBL_CMPY_CD
                        AND SIV1.DS_CONTR_PK        = DSCN.DS_CONTR_PK
                        AND DSCN.DS_CONTR_EDI_CD    = #dsContrEdi_cfs#
                        AND DSCN.EZCANCELFLAG       = '0'
                        AND DSCN.GLBL_CMPY_CD       = DCCG.GLBL_CMPY_CD
                        AND DSCN.DS_CONTR_CATG_CD   = DCCG.DS_CONTR_CATG_CD
                        AND DCCG.EZCANCELFLAG       = '0'
                        <!-- START 2017/08/01 K.Kojima [QC#20363,DEL] -->
                        <!-- AND DSCN.GLBL_CMPY_CD       = STCT.GLBL_CMPY_CD -->
                        <!-- AND DSCN.DS_ACCT_NUM        = STCT.SELL_TO_CUST_CD -->
                        <!-- AND STCT.EZCANCELFLAG       = '0' -->
                        <!-- END 2017/08/01 K.Kojima [QC#20363,DEL] -->
                        <!-- START 2017/08/01 K.Kojima [QC#20363,ADD] -->
                        AND SILM.GLBL_CMPY_CD             = DCBM.GLBL_CMPY_CD(+)
                        AND SILM.DS_CONTR_BLLG_MTR_PK     = DCBM.DS_CONTR_BLLG_MTR_PK(+)
                        AND DCBM.EZCANCELFLAG(+)          = '0'
                        AND DCBM.GLBL_CMPY_CD             = MBTC.GLBL_CMPY_CD(+)
                        AND DCBM.BLLG_MTR_BILL_TO_CUST_CD = MBTC.BILL_TO_CUST_CD(+)
                        AND MBTC.EZCANCELFLAG(+)          = '0'
                        AND MBTC.GLBL_CMPY_CD             = MSTC.GLBL_CMPY_CD(+)
                        AND MBTC.SELL_TO_CUST_CD          = MSTC.SELL_TO_CUST_CD(+)
                        <iterate property="dsAcctDlrCdList" var="dsAcctDlrCd[]" open="AND MSTC.DS_ACCT_DLR_CD(+) IN (" close=")" conjunction=",">
                        #dsAcctDlrCd[]#
                        </iterate>
                        AND MSTC.EZCANCELFLAG(+)          = '0'
                        <!-- END 2017/08/01 K.Kojima [QC#20363,ADD] -->
                        <!-- START 2017/11/22 [QC#21766,MOD] -->
                        AND SILN.GLBL_CMPY_CD               = SCHD.GLBL_CMPY_CD(+)
                        AND SILN.DS_CONTR_BLLG_SCHD_PK      = SCHD.DS_CONTR_BLLG_SCHD_PK(+)
                        AND SCHD.EZCANCELFLAG(+)            = '0'
                        AND SCHD.GLBL_CMPY_CD               = SCHD_P.GLBL_CMPY_CD(+)
                        AND SCHD.PRNT_DS_CONTR_BLLG_SCHD_PK = SCHD_P.DS_CONTR_BLLG_SCHD_PK(+)
                        AND SCHD_P.EZCANCELFLAG(+)          = '0'
                        AND SCHD_P.GLBL_CMPY_CD             = DCBM_P.GLBL_CMPY_CD(+)
                        AND SCHD_P.DS_CONTR_BLLG_MTR_PK     = DCBM_P.DS_CONTR_BLLG_MTR_PK(+)
                        AND DCBM_P.EZCANCELFLAG(+)          = '0'
                        AND DCBM_P.GLBL_CMPY_CD             = MBTC_P.GLBL_CMPY_CD(+)
                        AND DCBM_P.BLLG_MTR_BILL_TO_CUST_CD = MBTC_P.BILL_TO_CUST_CD(+)
                        AND MBTC_P.EZCANCELFLAG(+)          = '0'
                        AND MBTC_P.GLBL_CMPY_CD             = MSTC_P.GLBL_CMPY_CD(+)
                        AND MBTC_P.SELL_TO_CUST_CD          = MSTC_P.SELL_TO_CUST_CD(+)
                        AND MSTC_P.EZCANCELFLAG(+)          = '0'
                        <!-- END 2017/11/22 [QC#21766,MOD] -->
                        <!-- START 2017/07/24 K.Kojima [QC#20090,ADD] -->
                        AND (
                            EXISTS(
                                SELECT
                                    1
                                FROM
                                    DS_CONTR_BLLG_MTR DCBM
                                    ,BILL_TO_CUST      MBTC
                                    ,SELL_TO_CUST      MSTC
                                WHERE
                                        DCBM.GLBL_CMPY_CD             = SILM.GLBL_CMPY_CD
                                    AND DCBM.DS_CONTR_BLLG_MTR_PK     = SILM.DS_CONTR_BLLG_MTR_PK
                                    AND DCBM.GLBL_CMPY_CD             = MBTC.GLBL_CMPY_CD
                                    AND DCBM.BLLG_MTR_BILL_TO_CUST_CD = MBTC.BILL_TO_CUST_CD
                                    AND MBTC.GLBL_CMPY_CD             = MSTC.GLBL_CMPY_CD
                                    AND MBTC.SELL_TO_CUST_CD          = MSTC.SELL_TO_CUST_CD
                                    <iterate property="dsAcctDlrCdList" var="dsAcctDlrCd[]" open="AND MSTC.DS_ACCT_DLR_CD IN (" close=")" conjunction=",">
                                        #dsAcctDlrCd[]#
                                    </iterate>
                                    AND DCBM.EZCANCELFLAG             = '0'
                                    AND MBTC.EZCANCELFLAG             = '0'
                                    AND MSTC.EZCANCELFLAG             = '0'
                            )
                            <!-- START 2017/11/22 [QC#21766,MOD] -->
                            OR EXISTS(
                                SELECT
                                    1
                                FROM
                                     DS_CONTR_BLLG_MTR DCBM
                                    ,BILL_TO_CUST      MBTC
                                    ,SELL_TO_CUST      MSTC
                                WHERE
                                        DCBM.GLBL_CMPY_CD             = DCBM_P.GLBL_CMPY_CD
                                    AND DCBM.DS_CONTR_BLLG_MTR_PK     = DCBM_P.DS_CONTR_BLLG_MTR_PK
                                    AND DCBM.GLBL_CMPY_CD             = MBTC.GLBL_CMPY_CD
                                    AND DCBM.BLLG_MTR_BILL_TO_CUST_CD = MBTC.BILL_TO_CUST_CD
                                    AND MBTC.GLBL_CMPY_CD             = MSTC.GLBL_CMPY_CD
                                    AND MBTC.SELL_TO_CUST_CD          = MSTC.SELL_TO_CUST_CD
                                    <iterate property="dsAcctDlrCdList" var="dsAcctDlrCd[]" open="AND MSTC.DS_ACCT_DLR_CD IN (" close=")" conjunction=",">
                                        #dsAcctDlrCd[]#
                                    </iterate>
                                    AND DCBM.EZCANCELFLAG             = '0'
                                    AND MBTC.EZCANCELFLAG             = '0'
                                    AND MSTC.EZCANCELFLAG             = '0'
                            )
                            <!-- END 2017/11/22 [QC#21766,MOD] -->
                        )
                    <!-- END 2017/07/24 K.Kojima [QC#20090,ADD] -->
                    )
                        <!-- START 2017/06/02 K.Kojima [QC#18762, DEL] -->
                        <!-- AND DSCN.GLBL_CMPY_CD       = CLCN.GLBL_CMPY_CD -->
                        <!-- AND DSCN.DS_CONTR_NUM       = CLCN.CSA_CONTR_NUM -->
                        <!-- AND CLCN.EZCANCELFLAG       = '0') -->
                        <!-- END 2017/06/02 K.Kojima [QC#18762, DEL] -->
        SELECT
             SIV_C.SVC_INV_PK               AS SVC_INV_PK
            <!-- START 2017/11/22 [QC#21766,MOD] -->
            <!-- ,SIL_C.DS_ACCT_DLR_CD           AS DS_ACCT_DLR_CD -->
            ,NVL(SIL_C.DS_ACCT_DLR_CD, SIL_C.DS_ACCT_DLR_CD_P) DS_ACCT_DLR_CD
            <!-- END 2017/11/22 [QC#21766,MOD] -->
            ,SIL_C.DS_CONTR_PK              AS DS_CONTR_PK
            ,SIV_C.DS_CONTR_NUM             AS DS_CONTR_NUM
            ,SIL_C.CFS_LEASE_NUM            AS CFS_LEASE_NUM
            ,SIV_C.SVC_INV_NUM              AS SVC_INV_NUM
            ,SIV_C.ORIG_SVC_INV_NUM         AS ORIG_SVC_INV_NUM
            ,SIL_O.ORIG_SVC_INV_LINE_PK     AS ORIG_SVC_INV_LINE_PK
            ,SIL_C.SVC_INV_LINE_PK          AS SVC_INV_LINE_PK
            ,SIL_C.BLLG_PER_FROM_DT         AS BLLG_PER_FROM_DT
            ,SIL_C.BLLG_PER_THRU_DT         AS BLLG_PER_THRU_DT
            ,SIL_C.SVC_MACH_MSTR_PK         AS SVC_MACH_MSTR_PK
            ,SIL_C.SER_NUM                  AS SER_NUM
            ,SIL_O.TOT_COPY_QTY             AS OLD_TOT_COPY_QTY
            ,SIL_O.PREV_TOT_COPY_QTY        AS OLD_PREV_TOT_COPY_QTY
            ,SIL_O.TEST_COPY_QTY            AS OLD_TEST_COPY_QTY
            ,SIL_C.TOT_COPY_QTY             AS NEW_TOT_COPY_QTY
            ,SIL_C.PREV_TOT_COPY_QTY        AS NEW_PREV_TOT_COPY_QTY
            ,SIL_C.TEST_COPY_QTY            AS NEW_TEST_COPY_QTY
            ,SIL_C.MTR_READ_DT              AS MTR_READ_DT
            ,SIL_C.DS_CONTR_CATG_CD         AS DS_CONTR_CATG_CD
            ,SIL_O.SVC_INV_LINE_MTR_PK      AS ORIG_SVC_INV_LINE_MTR_PK
            ,SIL_C.SVC_INV_LINE_MTR_PK      AS SVC_INV_LINE_MTR_PK
            ,SIL_C.DS_CONTR_BLLG_MTR_PK     AS DS_CONTR_BLLG_MTR_PK
            ,SIL_C.MTR_LB_CD                AS MTR_LB_CD
            ,SIV_C.CUST_CARE_TKT_NUM        AS CUST_CARE_TKT_NUM
            ,SIL_C.DS_CONTR_CATG_ABBR_NM    AS DS_CONTR_CATG_ABBR_NM
        FROM
             SIV    SIV_C
            ,SIL    SIL_C
            ,(
                SELECT
                     SIL.SVC_INV_PK
                    ,SIL.SVC_INV_LINE_PK    AS SVC_INV_LINE_PK
                    ,SLO.SVC_INV_LINE_PK    AS ORIG_SVC_INV_LINE_PK
                    ,SMO.SVC_INV_LINE_MTR_PK
                    ,SMO.TOT_COPY_QTY
                    ,SMO.PREV_TOT_COPY_QTY
                    ,SMO.TEST_COPY_QTY
                FROM
                     SIL
                    ,SVC_INV            SIO
                    ,SVC_INV_LINE       SLO
                    ,SVC_INV_LINE_MTR   SMO
                WHERE
                        SIL.GLBL_CMPY_CD        = SIO.GLBL_CMPY_CD
                    AND SIL.ORIG_SVC_INV_NUM    = SIO.SVC_INV_NUM
                    AND SIO.EZCANCELFLAG        = '0'
                    AND SIO.GLBL_CMPY_CD        = SLO.GLBL_CMPY_CD
                    AND SIO.SVC_INV_NUM         = SLO.SVC_INV_NUM
                    AND (
                            (SLO.SVC_MACH_MSTR_PK IS NULL AND SLO.SVC_INV_LINE_TP_CD = #svcInvLineTpCd_fleet#)
                         OR (SIL.SVC_MACH_MSTR_PK = SLO.SVC_MACH_MSTR_PK))
                    AND SIL.BLLG_PER_FROM_DT      = SLO.BLLG_PER_FROM_DT
                    AND SIL.BLLG_PER_THRU_DT      = SLO.BLLG_PER_THRU_DT
                    AND SIL.SVC_INV_LINE_TP_CD    = SLO.SVC_INV_LINE_TP_CD
                    AND SIL.SVC_INV_CHRG_TP_CD    = SLO.SVC_INV_CHRG_TP_CD
                    AND SLO.EZCANCELFLAG          = '0'
                    AND SLO.GLBL_CMPY_CD          = SMO.GLBL_CMPY_CD
                    AND SLO.SVC_INV_NUM           = SMO.SVC_INV_NUM
                    AND SLO.SVC_INV_LINE_PK       = SMO.SVC_INV_LINE_PK
                    AND SIL.DS_CONTR_BLLG_MTR_PK  = SMO.DS_CONTR_BLLG_MTR_PK
                    AND SMO.EZCANCELFLAG          = '0') SIL_O
        WHERE
                SIV_C.SVC_INV_PK      = SIL_C.SVC_INV_PK(+)
            AND SIL_C.SVC_INV_PK      = SIL_O.SVC_INV_PK(+)
            AND SIL_C.SVC_INV_LINE_PK = SIL_O.SVC_INV_LINE_PK(+)
        ORDER BY
             SIV_C.SVC_INV_PK          ASC
            ,SIL_C.SVC_INV_LINE_PK     ASC
            ,SIL_C.SVC_INV_LINE_MTR_PK ASC
    </statement>
</sqlMap>
