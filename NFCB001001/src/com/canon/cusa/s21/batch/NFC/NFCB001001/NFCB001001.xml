<?xml version="1.0" encoding="UTF-8"?>

<sqlMap namespace="NFCB001001">

    <statement id="getOmInv" parameterClass="Map">
        SELECT
               INV.INV_NUM                              INV_NUM
              ,INV.ORIG_INV_NUM                         ORIG_INV_NUM
              ,INV.GRP_INV_NUM                          GRP_INV_NUM
              ,INV.INV_DT                               INV_DT
              ,INV.ACCT_DT                              ACCT_DT
              ,INV.INV_TP_CD                            INV_TP_CD
              ,INV.NET_DUE_DT                           NET_DUE_DT
              ,INV.CPO_ORD_NUM                          CPO_ORD_NUM
              ,INV.CUST_ISS_PO_NUM                      CUST_ISS_PO_NUM
              ,INV.BILL_TO_CUST_CD                      BILL_TO_CUST_CD
              ,INV.SELL_TO_CUST_CD                      SELL_TO_CUST_CD
              ,INV.ADV_RCPT_NUM                         ADV_RCPT_NUM
              ,INV.PMT_TERM_START_DT                    PMT_TERM_START_DT
              ,INV.PMT_TERM_CD                          PMT_TERM_CD
              ,INV.INV_PMT_METH_CD                      INV_PMT_METH_CD
              ,INV.INV_PMT_COND_CD                      INV_PMT_COND_CD
              ,INV.CASH_DISC_TERM_CD                    CASH_DISC_TERM_CD
              ,NVL(INV.INV_TOT_DEAL_NET_AMT, 0)         INV_TOT_DEAL_NET_AMT
              ,NVL(INV.INV_TOT_DEAL_SLS_AMT, 0)         INV_TOT_DEAL_SLS_AMT
              ,NVL(INV.INV_TOT_DEAL_FRT_AMT, 0)         INV_TOT_DEAL_FRT_AMT
              ,NVL(INV.INV_TOT_DEAL_TAX_AMT, 0)         INV_TOT_DEAL_TAX_AMT
              ,NVL(INV.INV_TOT_DEAL_DISC_AMT, 0)        INV_TOT_DEAL_DISC_AMT
              ,NVL(INV.INV_TOT_FUNC_NET_AMT, 0)         INV_TOT_FUNC_NET_AMT
              ,NVL(INV.INV_TOT_FUNC_SLS_AMT, 0)         INV_TOT_FUNC_SLS_AMT
              ,NVL(INV.INV_TOT_FUNC_FRT_AMT, 0)         INV_TOT_FUNC_FRT_AMT
              ,NVL(INV.INV_TOT_FUNC_TAX_AMT, 0)         INV_TOT_FUNC_TAX_AMT
              ,NVL(INV.INV_TOT_FUNC_DISC_AMT, 0)        INV_TOT_FUNC_DISC_AMT
              ,INV.DEAL_CCY_CD                          DEAL_CCY_CD
              ,INV.ACTL_APPLY_EXCH_RATE                 ACTL_APPLY_EXCH_RATE
              ,INV.PAYER_CUST_CD                        PAYER_CUST_CD
              ,INV.SYS_SRC_CD                           SYS_SRC_CD
              ,NVL(INV.INV_TOT_DEAL_INS_AMT, 0)         INV_TOT_DEAL_INS_AMT
              ,NVL(INV.INV_TOT_FUNC_INS_AMT, 0)         INV_TOT_FUNC_INS_AMT
              ,INV.PMT_TERM_CASH_DISC_CD                PMT_TERM_CASH_DISC_CD
              ,INV.DS_INV_TP_CD                         DS_INV_TP_CD
              ,INV.SRC_SYS_DOC_NUM                      SRC_SYS_DOC_NUM
              ,INV.CUST_CARE_TKT_NUM                    CUST_CARE_TKT_NUM
              ,INV.CR_REBIL_RSN_CATG_CD                 CR_REBIL_RSN_CATG_CD
              ,INV.BILL_TO_CUST_ACCT_CD                 BILL_TO_CUST_ACCT_CD
              ,INV.SLS_REP_TOC_CD                       SLS_REP_TOC_CD
              ,CASE WHEN INV.DS_CONTR_CATG_CD IN (#fleet#, #aggregate#) THEN SIL.BLLG_PER_FROM_DT  ELSE SIV.BLLG_PER_FROM_DT END BLLG_PER_FROM_DT
              ,CASE WHEN INV.DS_CONTR_CATG_CD IN (#fleet#, #aggregate#) THEN SIL.BLLG_PER_TO_DT    ELSE SIV.BLLG_PER_TO_DT   END BLLG_PER_TO_DT
              ,INL.COA_PROD_CD                          COA_PROD_CD
              ,PTC.ISTL_PMT_TERM_FLG                    ISTL_PMT_TERM_FLG
              <!-- START 2018/02/6 QC#23018 ADD -->
              ,INV.AR_AUTO_PURGE_OFS_FLG                AR_AUTO_PURGE_OFS_FLG
              <!-- END   2018/02/6 QC#23018 ADD -->
        FROM
               INV                  INV
              ,(
                 SELECT
                           IL1.INV_NUM                 INV_NUM
                          ,MAX(IL1.SLS_REP_TOC_CD)     SLS_REP_TOC_CD
                          ,MAX(IL1.COA_PROD_CD)        COA_PROD_CD
                 FROM
                           INV_LINE         IL1
                 WHERE
                           IL1.GLBL_CMPY_CD            =  #glblCmpyCd#
                 AND       IL1.EZCANCELFLAG            =  '0'
                 AND       IL1.INV_LINE_SUB_NUM       !=  #arInvDtlSubNumSet#
                 GROUP BY
                           IL1.INV_NUM
               )                    INL
              ,DS_INV_TP            DIT
              ,PMT_TERM_CASH_DISC   PTC
              ,SVC_INV              SIV
              ,( SELECT
                    SIL.SVC_INV_NUM
                  , MIN(SIL.BLLG_PER_FROM_DT)          AS BLLG_PER_FROM_DT
                  , MAX(BLLG_PER_THRU_DT)              AS BLLG_PER_TO_DT
                FROM SVC_INV_LINE SIL
                    WHERE
                      SIL.GLBL_CMPY_CD                 = #glblCmpyCd#
                  AND SIL.EZCANCELFLAG                 = '0' 
                GROUP BY SIL.SVC_INV_NUM
               ) SIL
        WHERE
               INV.GLBL_CMPY_CD            = #glblCmpyCd#
        AND    INV.EZCANCELFLAG            = '0'
        AND    INV.INV_TP_CD              IN 
        <iterate property="invTpList" var="invTpCd[]" open="(" close=")" conjunction=",">
               #invTpCd[]#
        </iterate>
        AND    INV.FNLZ_INV_FLG            = #fnlzInvFlg#
        AND    INV.INV_TOT_DEAL_NET_AMT   != 0
        AND    INV.ACCT_DT             &gt;= #batProcMthFirstDay#

        AND    INV.INV_NUM                 = INL.INV_NUM

        AND    INV.GLBL_CMPY_CD            = DIT.GLBL_CMPY_CD
        AND    INV.DS_INV_TP_CD            = DIT.DS_INV_TP_CD
        AND    DIT.OPEN_AR_FLG             = #openArFlg#
        AND    DIT.EZCANCELFLAG            = '0'
        AND    INV.PMT_TERM_CASH_DISC_CD   = PTC.PMT_TERM_CASH_DISC_CD(+)
        AND    INV.GLBL_CMPY_CD            = PTC.GLBL_CMPY_CD(+)
        AND    PTC.EZCANCELFLAG(+)         = '0'
        AND    INV.INV_NUM                 = SIV.SVC_INV_NUM(+)
        AND    INV.GLBL_CMPY_CD            = SIV.GLBL_CMPY_CD(+)
        AND    SIV.EZCANCELFLAG(+)         = '0'
        AND    INV.INV_NUM                 = SIL.SVC_INV_NUM(+)
        AND    NOT EXISTS
                     (
                         SELECT 
                              1
                         FROM
                              AR_TRX_BAL ATB
                         WHERE
                              ATB.EZCANCELFLAG      = '0'
                         AND  ATB.GLBL_CMPY_CD      = #glblCmpyCd#
                         AND  ATB.ORIG_INV_NUM      = INV.INV_NUM
                         AND  PTC.ISTL_PMT_TERM_FLG = 'Y'
                         UNION ALL
                         SELECT 
                              1
                         FROM
                              AR_TRX_BAL ATB
                         WHERE
                              ATB.EZCANCELFLAG      = '0'
                         AND  ATB.GLBL_CMPY_CD      = #glblCmpyCd#
                         AND  ATB.AR_TRX_NUM        = INV.INV_NUM
                         AND  PTC.ISTL_PMT_TERM_FLG = 'N'
                     )
        ORDER BY
               INV.INV_NUM

    </statement>

    <statement id="getCashDiscTerm" parameterClass="Map" resultClass="Map">
        SELECT
            A.GLBL_CMPY_CD
           ,A.CASH_DISC_TERM_CD
           ,A.CASH_DISC_TERM_EFF_FROM_DT
           ,A.CASH_DISC_TERM_EFF_THRU_DT
           ,A.CASH_DISC_TERM_DTL_NUM
           ,A.CASH_DISC_FROM_AOT
           ,A.CASH_DISC_THRU_AOT
           ,A.CASH_DISC_PCT
        FROM
            CASH_DISC_TERM  A
        WHERE
                A.GLBL_CMPY_CD               =  #glblCmpyCd#
            AND A.CASH_DISC_TERM_CD          =  #cashDiscTermCd#
            AND (#netDueDt#  BETWEEN  A.CASH_DISC_TERM_EFF_FROM_DT  AND  A.CASH_DISC_TERM_EFF_THRU_DT)
            <isNotNull property="pmtTermAot">
            AND A.CASH_DISC_THRU_AOT     &lt;=  #pmtTermAot#
            </isNotNull>
            AND A.EZCANCELFLAG               =  '0'
        ORDER BY
                A.CASH_DISC_FROM_AOT
    </statement>

    <statement id="getArApplayIntfcWrk" parameterClass="Map">
        SELECT
            A.APPLY_GRP_KEY
           ,A.DEAL_SQ_NUM
        FROM
            AR_APPLY_INTFC_WRK A
        WHERE
                A.GLBL_CMPY_CD  = #glblCmpyCd#
            AND A.BIZ_APP_ID    = #bizAppId#
            AND A.PROC_STS_CD   = #procStsCd#
            AND A.EZCANCELFLAG  = '0'
        ORDER BY
            A.APPLY_GRP_KEY ASC
    </statement>

</sqlMap>
