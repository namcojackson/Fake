<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NWDB006001">

    <statement id="getHardAllocationInfo" parameterClass="Map" resultClass="Map">
<!-- QC#5872(L3#001) Del Start -->
<!--  QC#16578 Add Start -->
<!--        SELECT /*+ ORDERED */-->
<!--            SPOTM.DS_ORD_CATG_CD                        DS_ORD_CATG_CD-->
<!--           ,SPOTM.DS_ORD_TP_CD                          DS_ORD_TP_CD-->
<!--           ,SPOTM.DS_ORD_RSN_CD                         DS_ORD_RSN_CD-->
<!--           ,SPOTM.DS_CPO_CONFIG_PK                      DS_CPO_CONFIG_PK-->
<!--           ,SPOTM.CPO_ORD_NUM                           CPO_ORD_NUM-->
<!--           ,SPOTM.CPO_DTL_LINE_NUM                      CPO_DTL_LINE_NUM-->
<!--           ,SPOTM.CPO_DTL_LINE_SUB_NUM                  CPO_DTL_LINE_SUB_NUM-->
<!--           ,SPOTM.SHPG_PLN_NUM                          SHPG_PLN_NUM-->
<!--           ,SPOTM.TIME_STAMP                            TIME_STAMP-->
<!--           ,SPOTM.WH_CD                                 WH_CD-->
<!--           ,SPOTM.RDD_DT                                RDD_DT-->
<!--           ,SPOTM.SP_MDSE_CD                            MDSE_CD-->
<!--           ,SPOTM.IS_ORD_TAKE_MDSE_FLG                  IS_ORD_TAKE_MDSE_FLG-->
<!--           ,M.DAYS_PRI_ALLOC_NUM                        DAYS_PRI_ALLOC_NUM-->
<!--           ,M.INVTY_DIST_TP_CD                          INVTY_DIST_TP_CD-->
<!--           ,BOIT.BACK_ORD_IMPCT_TP_PRTY_NUM             BACK_ORD_IMPCT_TP_PRTY_NUM-->
<!--           ,BOIT.BACK_ORD_IMPCT_TP_CD                   BACK_ORD_IMPCT_TP_CD-->
<!--           ,SPOTM.CPO_ORD_NUM || SPOTM.DS_CPO_CONFIG_PK ORD_CONFIG_KEY-->
<!--        FROM-->
<!--            (-->
<!--             SELECT-->
<!--                 SP.GLBL_CMPY_CD          GLBL_CMPY_CD-->
<!--                ,C.DS_ORD_CATG_CD         DS_ORD_CATG_CD-->
<!--                ,C.DS_ORD_TP_CD           DS_ORD_TP_CD-->
<!--                ,C.DS_ORD_RSN_CD          DS_ORD_RSN_CD-->
<!--                ,CD.DS_CPO_CONFIG_PK      DS_CPO_CONFIG_PK-->
<!--                ,CD.CPO_ORD_NUM           CPO_ORD_NUM-->
<!--                ,CD.CPO_DTL_LINE_NUM      CPO_DTL_LINE_NUM-->
<!--                ,CD.CPO_DTL_LINE_SUB_NUM  CPO_DTL_LINE_SUB_NUM-->
<!--                ,SP.SHPG_PLN_NUM          SHPG_PLN_NUM-->
<!--                ,CD.CPO_ORD_SUBMT_TS      TIME_STAMP-->
<!--                ,CD.RTL_WH_CD             WH_CD-->
<!--                ,SP.RDD_DT                RDD_DT-->
<!--                ,SP.MDSE_CD               SP_MDSE_CD-->
<!--                ,(CASE WHEN OTM.MDSE_CD IS NOT NULL AND SP.TRX_SRC_TP_CD = #trxSrcTpWholeSales# THEN OTM.MDSE_CD-->
<!--                  ELSE SP.MDSE_CD END) MDSE_CD-->
<!--                ,(CASE WHEN OTM.MDSE_CD IS NOT NULL AND SP.TRX_SRC_TP_CD = #trxSrcTpWholeSales# THEN 'Y'-->
<!--                  ELSE 'N' END) IS_ORD_TAKE_MDSE_FLG-->
<!--             FROM-->
<!--                 SHPG_PLN      SP-->
<!--                ,CPO_DTL       CD-->
<!--                ,DS_CPO_CONFIG DCC-->
<!--                ,CPO           C-->
<!--                ,ORD_TAKE_MDSE OTM-->
<!--             WHERE-->
<!--                 SP.GLBL_CMPY_CD         = #glblCmpyCd#-->
<!--                 AND SP.TRX_SRC_TP_CD    = #trxSrcTpWholeSales#-->
<!--                 AND SP.SHPG_STS_CD      = #shpgSts#-->
<!--                 AND SP.TRX_LINE_SUB_NUM &lt;&gt; #trxLineSubNum#-->
<!--                 AND SP.PO_REQ_FLG       = 'N'-->
<!--                 AND SP.ORD_QTY          &gt; 0-->
<!--                 <isNotNull property="whLst">    -->
<!--                     AND SP.INVTY_LOC_CD NOT IN-->
<!--                     <iterate property="whLst" var="whLst[]" open="(" close=")" conjunction=",">-->
<!--                         #whLst[]#-->
<!--                     </iterate>-->
<!--                 </isNotNull>-->
<!--                 AND NOT EXISTS (-->
<!--                                 SELECT-->
<!--                                     * -->
<!--                                 FROM-->
<!--                                     HLD          H-->
<!--                                    ,HLD_RSN      HR-->
<!--                                    ,HLD_PROC_DFN HPD-->
<!--                                 WHERE-->
<!--                                     SP.GLBL_CMPY_CD                = H.GLBL_CMPY_CD-->
<!--                                     AND SP.TRX_HDR_NUM             = H.CPO_ORD_NUM-->
<!--                                     AND H.REL_FLG                  = 'N'-->
<!--                                     AND H.EZCANCELFLAG             = '0'-->
<!--                                     AND H.GLBL_CMPY_CD             = HR.GLBL_CMPY_CD-->
<!--                                     AND H.HLD_RSN_CD               = HR.HLD_RSN_CD-->
<!--                                  2017/06/23 QC#19386 Mod Start -->
<!--                                 AND HR.HLD_LVL_CD              = #hldLvlCpo#-->
<!--                                     AND (-->
<!--                                             (-->
<!--                                                     HR.HLD_LVL_CD          = #hldLvlCpo#-->
<!--                                                 AND SP.TRX_HDR_NUM         = H.CPO_ORD_NUM-->
<!--                                             ) OR (-->
<!--                                                     HR.HLD_LVL_CD          = #hldLvlCpoDtl#-->
<!--                                                 AND SP.TRX_HDR_NUM         = H.CPO_ORD_NUM-->
<!--                                                 AND SP.TRX_LINE_NUM        = H.CPO_DTL_LINE_NUM-->
<!--                                                 AND SP.TRX_LINE_SUB_NUM    = H.CPO_DTL_LINE_SUB_NUM-->
<!--                                             ) OR (-->
<!--                                                     HR.HLD_LVL_CD          = #hldLvlShpg#-->
<!--                                                 AND SP.SHPG_PLN_NUM        = H.SHPG_PLN_NUM-->
<!--                                             ) OR (-->
<!--                                                     HR.HLD_LVL_CD          = #hldLvlCpoDtl#-->
<!--                                                 AND SP.TRX_HDR_NUM         = H.CPO_ORD_NUM-->
<!--                                                 AND SP.TRX_LINE_NUM        = H.CPO_DTL_LINE_NUM-->
<!--                                                 AND H.CPO_DTL_LINE_SUB_NUM = #trxLineSubNum#-->
<!--                                             )-->
<!--                                     )-->
<!--                                  2017/06/23 QC#19386 Mod End -->
<!--                                     AND HR.EZCANCELFLAG            = '0'-->
<!--                                     AND H.HLD_RSN_CD               = HPD.HLD_RSN_CD-->
<!--                                     AND H.GLBL_CMPY_CD             = HPD.GLBL_CMPY_CD-->
<!--                                     AND H.TRX_SRC_TP_CD            IS NULL-->
<!--                                     AND HPD.REL_PNT_HARD_ALLOC_FLG = 'Y'-->
<!--                                     AND HPD.EZCANCELFLAG           = '0'-->
<!--                                )-->
<!--                 AND SP.EZCANCELFLAG      = '0'-->
<!--                 AND SP.GLBL_CMPY_CD      = CD.GLBL_CMPY_CD-->
<!--                 AND SP.TRX_HDR_NUM       = CD.CPO_ORD_NUM-->
<!--                 AND SP.TRX_LINE_NUM      = CD.CPO_DTL_LINE_NUM-->
<!--                 AND SP.TRX_LINE_SUB_NUM  = CD.CPO_DTL_LINE_SUB_NUM-->
<!--                 AND CD.EZCANCELFLAG      = '0'-->
<!--                 <isNotNull property="rtlWhLst">-->
<!--                     AND CD.RTL_WH_CD NOT IN-->
<!--                     <iterate property="rtlWhLst" var="rtlWhLst[]" open="(" close=")" conjunction=",">-->
<!--                         #rtlWhLst[]#-->
<!--                     </iterate>-->
<!--                 </isNotNull>-->
<!--                 AND CD.GLBL_CMPY_CD      = DCC.GLBL_CMPY_CD-->
<!--                 AND CD.CPO_ORD_NUM       = DCC.CPO_ORD_NUM-->
<!--                 AND CD.DS_CPO_CONFIG_PK  = DCC.DS_CPO_CONFIG_PK-->
<!--                 AND DCC.EZCANCELFLAG     = '0'-->
<!--                 AND DCC.GLBL_CMPY_CD     = C.GLBL_CMPY_CD-->
<!--                 AND DCC.CPO_ORD_NUM      = C.CPO_ORD_NUM-->
<!--                 AND C.EZCANCELFLAG       = '0'-->
<!--                 AND SP.GLBL_CMPY_CD      = OTM.GLBL_CMPY_CD(+)-->
<!--                 AND SUBSTR(SP.MDSE_CD,1, #ordTakeMdseCdDigit#) = OTM.ORD_TAKE_MDSE_CD(+)-->
<!--                 AND OTM.EZCANCELFLAG(+)  = '0'-->
<!--            ) SPOTM-->
<!--            ,MDSE              M-->
<!--            ,MDSE_WH_COND      MWC-->
<!--            ,BACK_ORD_IMPCT_TP BOIT-->
<!--        WHERE-->
<!--            SPOTM.GLBL_CMPY_CD           = M.GLBL_CMPY_CD-->
<!--            AND SPOTM.MDSE_CD            = M.MDSE_CD-->
<!--            AND M.INVTY_DIST_TP_CD       = #invtyDistTpNone#-->
<!--            AND M.INVTY_CTRL_FLG         = 'Y'-->
<!--            AND M.EZCANCELFLAG           = '0'-->
<!--            AND SPOTM.GLBL_CMPY_CD       = MWC.GLBL_CMPY_CD(+)-->
<!--            AND SPOTM.MDSE_CD            = MWC.MDSE_CD(+)-->
<!--            AND SPOTM.WH_CD              = MWC.WH_CD(+)-->
<!--            AND MWC.EZCANCELFLAG(+)      = '0'-->
<!--            AND M.GLBL_CMPY_CD           = BOIT.GLBL_CMPY_CD(+)-->
<!--            AND M.BACK_ORD_IMPCT_TP_CD   = BOIT.BACK_ORD_IMPCT_TP_CD(+)-->
<!--            AND BOIT.EZCANCELFLAG(+)     = '0'-->
<!--            AND (CASE WHEN MWC.MDSE_CD IS NULL THEN M.INVTY_HARD_ALLOC_TP_CD-->
<!--                 ELSE MWC.INVTY_HARD_ALLOC_TP_CD END) = #hardAllocTp#-->
<!--        ORDER BY-->
<!--            SPOTM.TIME_STAMP ASC-->
<!--           ,SPOTM.CPO_ORD_NUM-->
<!--           ,SPOTM.DS_CPO_CONFIG_PK-->
<!--           ,BOIT.BACK_ORD_IMPCT_TP_PRTY_NUM NULLS LAST-->
<!--           ,SPOTM.CPO_DTL_LINE_NUM-->
<!--           ,SPOTM.CPO_DTL_LINE_SUB_NUM-->
<!-- QC#16578 Add End -->
<!-- QC#5872(L3#001) Del End-->
<!-- QC#5872(L3#001) Add Start-->

WITH SPOTM AS( 
     SELECT
          SP.GLBL_CMPY_CD          GLBL_CMPY_CD
         ,C.DS_ORD_CATG_CD         DS_ORD_CATG_CD
         ,C.DS_ORD_TP_CD           DS_ORD_TP_CD
         ,C.DS_ORD_RSN_CD          DS_ORD_RSN_CD
         ,CD.DS_CPO_CONFIG_PK      DS_CPO_CONFIG_PK
         ,CD.CPO_ORD_NUM           CPO_ORD_NUM
         ,CD.CPO_DTL_LINE_NUM      CPO_DTL_LINE_NUM
         ,CD.CPO_DTL_LINE_SUB_NUM  CPO_DTL_LINE_SUB_NUM
         ,SP.SHPG_PLN_NUM          SHPG_PLN_NUM
         ,C.ORD_BOOK_TS            TIME_STAMP
         ,CD.RTL_WH_CD             WH_CD
         ,CD.RTL_SWH_CD            SWH_CD
         ,SP.RDD_DT                RDD_DT
         ,SP.MDSE_CD               SP_MDSE_CD
         ,OTM.ORD_TAKE_MDSE_CD     ORD_TAKE_MDSE_CD
         ,(CASE WHEN OTM.ORD_TAKE_MDSE_CD = SP.MDSE_CD  AND SP.TRX_SRC_TP_CD = '010' THEN OTM.MDSE_CD
           ELSE SP.MDSE_CD END)    MDSE_CD
         ,(CASE WHEN OTM.MDSE_CD IS NOT NULL AND SP.TRX_SRC_TP_CD = '010' THEN 'Y'
           ELSE 'N' END) IS_ORD_TAKE_MDSE_FLG
         ,DCC.MDL_ID               MDL_ID
         <!-- START 2022/08/12 [QC#60319, ADD] -->
         ,CD.SET_MDSE_CD           SET_MDSE_CD
         <!-- END 2022/08/12 [QC#60319, ADD] -->
         <!-- START 2023/7/11 G.Quan [QC#61543, ADD] -->
         ,CD.COA_PROD_CD            COA_PROD_CD
         <!-- END 2023/7/11 G.Quan [QC#61543, ADD] -->
      FROM
          SHPG_PLN      SP
         ,CPO_DTL       CD
         ,DS_CPO_CONFIG DCC
         ,CPO           C
         ,ORD_TAKE_MDSE OTM
      WHERE
          SP.GLBL_CMPY_CD         = #glblCmpyCd#
          AND SP.TRX_SRC_TP_CD    = #trxSrcTpWholeSales#
          AND SP.SHPG_STS_CD      = #shpgSts#
          AND SP.TRX_LINE_SUB_NUM &lt;&gt; #trxLineSubNum#
          AND SP.PO_REQ_FLG       = 'N'
          AND SP.ORD_QTY          &gt; 0
          <isNotNull property="whLst">    
              AND SP.INVTY_LOC_CD NOT IN
              <iterate property="whLst" var="whLst[]" open="(" close=")" conjunction=",">
                  #whLst[]#
              </iterate>
          </isNotNull>
          AND NOT EXISTS (
                          SELECT
                              * 
                          FROM
                              HLD          H
                             ,HLD_RSN      HR
                             ,HLD_PROC_DFN HPD
                          WHERE
                              SP.GLBL_CMPY_CD                = H.GLBL_CMPY_CD
                              AND SP.TRX_HDR_NUM             = H.CPO_ORD_NUM
                              AND H.REL_FLG                  = 'N'
                              AND H.EZCANCELFLAG             = '0'
                              AND H.GLBL_CMPY_CD             = HR.GLBL_CMPY_CD
                              AND H.HLD_RSN_CD               = HR.HLD_RSN_CD
                              <!-- 2017/06/23 QC#19386 Mod Start -->
                              AND (
                                      (       HR.HLD_LVL_CD          = #hldLvlCpo#
                                          AND SP.TRX_HDR_NUM         = H.CPO_ORD_NUM
                                      ) OR (  HR.HLD_LVL_CD          = #hldLvlCpoDtl#
                                          AND SP.TRX_HDR_NUM         = H.CPO_ORD_NUM
                                          AND SP.TRX_LINE_NUM        = H.CPO_DTL_LINE_NUM
                                          AND SP.TRX_LINE_SUB_NUM    = H.CPO_DTL_LINE_SUB_NUM
                                      ) OR (  HR.HLD_LVL_CD          = #hldLvlShpg#
                                          AND SP.SHPG_PLN_NUM        = H.SHPG_PLN_NUM
                                      ) OR (  HR.HLD_LVL_CD          = #hldLvlCpoDtl#
                                          AND SP.TRX_HDR_NUM         = H.CPO_ORD_NUM
                                          AND SP.TRX_LINE_NUM        = H.CPO_DTL_LINE_NUM
                                          AND H.CPO_DTL_LINE_SUB_NUM = #trxLineSubNum#
                                      )
                              )
                              <!-- 2017/06/23 QC#19386 Mod End -->
                              AND HR.EZCANCELFLAG            = '0'
                              AND H.HLD_RSN_CD               = HPD.HLD_RSN_CD
                              AND H.GLBL_CMPY_CD             = HPD.GLBL_CMPY_CD
                              AND H.TRX_SRC_TP_CD            IS NULL
                              AND HPD.REL_PNT_HARD_ALLOC_FLG = 'Y'
                              AND HPD.EZCANCELFLAG           = '0'
                         )
          AND SP.EZCANCELFLAG      = '0'
          AND SP.GLBL_CMPY_CD      = CD.GLBL_CMPY_CD
          AND SP.TRX_HDR_NUM       = CD.CPO_ORD_NUM
          AND SP.TRX_LINE_NUM      = CD.CPO_DTL_LINE_NUM
          AND SP.TRX_LINE_SUB_NUM  = CD.CPO_DTL_LINE_SUB_NUM
          AND CD.EZCANCELFLAG      = '0'
          <isNotNull property="rtlWhLst">
              AND CD.RTL_WH_CD NOT IN
              <iterate property="rtlWhLst" var="rtlWhLst[]" open="(" close=")" conjunction=",">
                  #rtlWhLst[]#
              </iterate>
          </isNotNull>
          AND CD.GLBL_CMPY_CD      = DCC.GLBL_CMPY_CD
          AND CD.CPO_ORD_NUM       = DCC.CPO_ORD_NUM
          AND CD.DS_CPO_CONFIG_PK  = DCC.DS_CPO_CONFIG_PK
          AND DCC.EZCANCELFLAG     = '0'
          AND DCC.GLBL_CMPY_CD     = C.GLBL_CMPY_CD
          AND DCC.CPO_ORD_NUM      = C.CPO_ORD_NUM
          AND C.EZCANCELFLAG       = '0'
          AND SP.GLBL_CMPY_CD      = OTM.GLBL_CMPY_CD(+)
          AND SUBSTR(SP.MDSE_CD,1, #ordTakeMdseCdDigit#) = OTM.ORD_TAKE_MDSE_CD(+)
          AND OTM.EZCANCELFLAG(+)  = '0'
      )            

        SELECT
            ALLOCATION_INFO.DS_ORD_CATG_CD                        DS_ORD_CATG_CD
           ,ALLOCATION_INFO.DS_ORD_TP_CD                          DS_ORD_TP_CD
           ,ALLOCATION_INFO.DS_ORD_RSN_CD                         DS_ORD_RSN_CD
           ,ALLOCATION_INFO.DS_CPO_CONFIG_PK                      DS_CPO_CONFIG_PK
           ,ALLOCATION_INFO.CPO_ORD_NUM                           CPO_ORD_NUM
           ,ALLOCATION_INFO.CPO_DTL_LINE_NUM                      CPO_DTL_LINE_NUM
           ,ALLOCATION_INFO.CPO_DTL_LINE_SUB_NUM                  CPO_DTL_LINE_SUB_NUM
           ,ALLOCATION_INFO.SHPG_PLN_NUM                          SHPG_PLN_NUM
           ,ALLOCATION_INFO.TIME_STAMP                            TIME_STAMP
           ,ALLOCATION_INFO.WH_CD                                 WH_CD
           ,ALLOCATION_INFO.RDD_DT                                RDD_DT
           ,ALLOCATION_INFO.SP_MDSE_CD                            MDSE_CD
           ,ALLOCATION_INFO.IS_ORD_TAKE_MDSE_FLG                  IS_ORD_TAKE_MDSE_FLG
           ,ALLOCATION_INFO.TM_FENCE_DAYS_AOT                     DAYS_PRI_ALLOC_NUM
           ,M.INVTY_DIST_TP_CD                                    INVTY_DIST_TP_CD
           <!-- START 2022/08/12 [QC#60319, MOD] -->
           <!-- ,BOIT.BACK_ORD_IMPCT_TP_PRTY_NUM                       BACK_ORD_IMPCT_TP_PRTY_NUM -->
           <!-- ,BOIT.BACK_ORD_IMPCT_TP_CD                             BACK_ORD_IMPCT_TP_CD -->
           ,NVL2(PRNT_BOIT.BACK_ORD_IMPCT_TP_CD, PRNT_BOIT.BACK_ORD_IMPCT_TP_PRTY_NUM, BOIT.BACK_ORD_IMPCT_TP_PRTY_NUM)
                                                                  BACK_ORD_IMPCT_TP_PRTY_NUM
           ,NVL2(PRNT_BOIT.BACK_ORD_IMPCT_TP_CD, PRNT_BOIT.BACK_ORD_IMPCT_TP_CD, BOIT.BACK_ORD_IMPCT_TP_CD)
                                                                  BACK_ORD_IMPCT_TP_CD
           <!-- END 2022/08/12 [QC#60319, MOD] -->
           ,ALLOCATION_INFO.CPO_ORD_NUM || ALLOCATION_INFO.DS_CPO_CONFIG_PK 
                                                                  ORD_CONFIG_KEY
        FROM
            (SELECT *
             FROM 
                (SELECT
                    ALLOC_INFO1.*
                   ,ROW_NUMBER() OVER (PARTITION BY ALLOC_INFO1.SHPG_PLN_NUM ORDER BY ALLOC_INFO1.MDSE_WH_COND_TP_CD DESC)  AS PARTITION_NUM
                 FROM
                    (SELECT 
                        SPOTM.GLBL_CMPY_CD                          GLBL_CMPY_CD
                       ,SPOTM.DS_ORD_CATG_CD                        DS_ORD_CATG_CD
                       ,SPOTM.DS_ORD_TP_CD                          DS_ORD_TP_CD
                       ,SPOTM.DS_ORD_RSN_CD                         DS_ORD_RSN_CD
                       ,SPOTM.DS_CPO_CONFIG_PK                      DS_CPO_CONFIG_PK
                       ,SPOTM.CPO_ORD_NUM                           CPO_ORD_NUM
                       ,SPOTM.CPO_DTL_LINE_NUM                      CPO_DTL_LINE_NUM
                       ,SPOTM.CPO_DTL_LINE_SUB_NUM                  CPO_DTL_LINE_SUB_NUM
                       ,SPOTM.SHPG_PLN_NUM                          SHPG_PLN_NUM
                       ,SPOTM.TIME_STAMP                            TIME_STAMP
                       ,SPOTM.WH_CD                                 WH_CD
                       ,SPOTM.RDD_DT                                RDD_DT
                       ,SPOTM.MDSE_CD                               MDSE_CD
                       ,SPOTM.SP_MDSE_CD                            SP_MDSE_CD
                       ,SPOTM.ORD_TAKE_MDSE_CD                      ORD_TAKE_MDSE_CD
                       ,SPOTM.IS_ORD_TAKE_MDSE_FLG                  IS_ORD_TAKE_MDSE_FLG
                       ,SPOTM.MDL_ID                                MDL_ID
                       <!-- 2017/09/22 QC#21077 Mod START -->
                       <!-- ,0                                      TM_FENCE_DAYS_AOT -->
                       ,#defTmFenceDaysAot#                         TM_FENCE_DAYS_AOT
                       <!-- 2017/09/22 QC#21077 Mod END -->
                       ,SPOTM.CPO_ORD_NUM || SPOTM.DS_CPO_CONFIG_PK ORD_CONFIG_KEY
                       ,MWC1.INVTY_HARD_ALLOC_TP_CD                 INVTY_HARD_ALLOC_TP_CD
                       ,MWC1.MDSE_WH_COND_TP_CD                     MDSE_WH_COND_TP_CD
                       <!-- START 2022/08/12 [QC#60319, ADD] -->
                       ,SPOTM.SET_MDSE_CD                           SET_MDSE_CD
                       <!-- END 2022/08/12 [QC#60319, ADD] -->
                    FROM 
                         SPOTM
                        ,MDSE_WH_COND MWC1
                    WHERE
                        SPOTM.GLBL_CMPY_CD      = MWC1.GLBL_CMPY_CD
                    AND SPOTM.WH_CD             = MWC1.RTL_WH_CD 
                    AND (      SPOTM.MDSE_CD            = MWC1.MDSE_CD
                            OR SPOTM.ORD_TAKE_MDSE_CD   = MWC1.MDSE_CD )
                    AND (SPOTM.SWH_CD            = MWC1.RTL_SWH_CD
                        OR (   MWC1.RTL_SWH_CD      = '*'
                           AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD    = SPOTM.GLBL_CMPY_CD
                                            AND   MWC_B.RTL_WH_CD       = SPOTM.WH_CD 
                                            AND  (MWC_B.MDSE_CD             = SPOTM.MDSE_CD
                                                     OR MWC_B.MDSE_CD       = SPOTM.ORD_TAKE_MDSE_CD )
                                            AND   MWC_B.RTL_SWH_CD      = SPOTM.SWH_CD
                                            AND   MWC_B.EZCANCELFLAG    = '0'
                                            )
                            )
                        )
                    AND MWC1.EZCANCELFLAG       = '0'

                    UNION ALL

                    SELECT 
                        SPOTM.GLBL_CMPY_CD                                  GLBL_CMPY_CD
                       ,SPOTM.DS_ORD_CATG_CD                                DS_ORD_CATG_CD
                       ,SPOTM.DS_ORD_TP_CD                                  DS_ORD_TP_CD
                       ,SPOTM.DS_ORD_RSN_CD                                 DS_ORD_RSN_CD
                       ,SPOTM.DS_CPO_CONFIG_PK                              DS_CPO_CONFIG_PK
                       ,SPOTM.CPO_ORD_NUM                                   CPO_ORD_NUM
                       ,SPOTM.CPO_DTL_LINE_NUM                              CPO_DTL_LINE_NUM
                       ,SPOTM.CPO_DTL_LINE_SUB_NUM                          CPO_DTL_LINE_SUB_NUM
                       ,SPOTM.SHPG_PLN_NUM                                  SHPG_PLN_NUM
                       ,SPOTM.TIME_STAMP                                    TIME_STAMP
                       ,SPOTM.WH_CD                                         WH_CD
                       ,SPOTM.RDD_DT                                        RDD_DT
                       ,SPOTM.MDSE_CD                                       MDSE_CD
                       ,SPOTM.SP_MDSE_CD                                    SP_MDSE_CD
                       ,SPOTM.ORD_TAKE_MDSE_CD                              ORD_TAKE_MDSE_CD
                       ,SPOTM.IS_ORD_TAKE_MDSE_FLG                          IS_ORD_TAKE_MDSE_FLG
                       ,SPOTM.MDL_ID                                        MDL_ID
                       <!-- 2017/09/22 QC#21077 Mod START -->
                       <!-- ,NVL( MWC2.TM_FENCE_DAYS_AOT, 0 )               TM_FENCE_DAYS_AOT -->
                       ,NVL( MWC2.TM_FENCE_DAYS_AOT, #defTmFenceDaysAot# )  TM_FENCE_DAYS_AOT
                       <!-- 2017/09/22 QC#21077 Mod END -->
                       ,SPOTM.CPO_ORD_NUM || SPOTM.DS_CPO_CONFIG_PK         ORD_CONFIG_KEY
                       ,MWC2.INVTY_HARD_ALLOC_TP_CD                         INVTY_HARD_ALLOC_TP_CD
                       ,MWC2.MDSE_WH_COND_TP_CD                             MDSE_WH_COND_TP_CD
                       <!-- START 2022/08/12 [QC#60319, ADD] -->
                       ,SPOTM.SET_MDSE_CD                                   SET_MDSE_CD
                       <!-- END 2022/08/12 [QC#60319, ADD] -->
                    FROM 
                         SPOTM
                        ,DS_ORD_TP_PROC_DFN     DOTPD
                        ,MDSE_WH_COND           MWC2
                    WHERE
                        SPOTM.GLBL_CMPY_CD      = DOTPD.GLBL_CMPY_CD
                    AND SPOTM.DS_ORD_TP_CD      = DOTPD.DS_ORD_TP_CD
                    AND DOTPD.EZCANCELFLAG      = '0'
                    AND SPOTM.GLBL_CMPY_CD      = MWC2.GLBL_CMPY_CD
                    AND DOTPD.LINE_BIZ_TP_CD    = MWC2.LINE_BIZ_TP_CD
                    AND SPOTM.WH_CD             = MWC2.RTL_WH_CD
                    AND (
                           (    SPOTM.SWH_CD            = MWC2.RTL_SWH_CD
                            AND SPOTM.DS_ORD_CATG_CD    = MWC2.DS_ORD_CATG_CD
                            <!-- START 2023/7/11 G.Quan [QC#61543, ADD] -->
                            AND SPOTM.COA_PROD_CD       = MWC2.COA_PROD_CD
                            <!-- END 2023/7/11 G.Quan [QC#61543, ADD] -->
                            )
                        OR (    MWC2.RTL_SWH_CD         = '*'
                            AND SPOTM.DS_ORD_CATG_CD    = MWC2.DS_ORD_CATG_CD
                            <!-- START 2023/7/11 G.Quan [QC#61543, ADD] -->
                            AND SPOTM.COA_PROD_CD       = MWC2.COA_PROD_CD
                            <!-- END 2023/7/11 G.Quan [QC#61543, ADD] -->
                            AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD    = SPOTM.GLBL_CMPY_CD
                                            AND   MWC_B.LINE_BIZ_TP_CD  = DOTPD.LINE_BIZ_TP_CD 
                                            AND   MWC_B.RTL_WH_CD       = SPOTM.WH_CD 
                                            AND   MWC_B.RTL_SWH_CD      = SPOTM.SWH_CD
                                            AND   MWC_B.DS_ORD_CATG_CD  = SPOTM.DS_ORD_CATG_CD
                                            <!-- START 2023/7/11 G.Quan [QC#61543, ADD] -->
                                            AND   MWC_B.COA_PROD_CD     = SPOTM.COA_PROD_CD
                                            <!-- END 2023/7/11 G.Quan [QC#61543, ADD] -->
                                            AND   MWC_B.EZCANCELFLAG    = '0'
                                            )
                            )
                        OR (    SPOTM.SWH_CD            = MWC2.RTL_SWH_CD
                            AND MWC2.DS_ORD_CATG_CD     = '*'
                            <!-- START 2023/7/11 G.Quan [QC#61543, ADD] -->
                            AND SPOTM.COA_PROD_CD       = MWC2.COA_PROD_CD
                            <!-- END 2023/7/11 G.Quan [QC#61543, ADD] -->
                            AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD    = SPOTM.GLBL_CMPY_CD
                                            AND   MWC_B.LINE_BIZ_TP_CD  = DOTPD.LINE_BIZ_TP_CD 
                                            AND   MWC_B.RTL_WH_CD       = SPOTM.WH_CD 
                                            AND  (  MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                OR  MWC_B.RTL_SWH_CD        = '*'
                                                  )
                                            AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                            <!-- START 2023/7/11 G.Quan [QC#61543, ADD] -->
                                            AND   MWC_B.COA_PROD_CD     = SPOTM.COA_PROD_CD
                                            <!-- END 2023/7/11 G.Quan [QC#61543, ADD] -->
                                            AND   MWC_B.EZCANCELFLAG    = '0'
                                            )
                            )
                        OR (    MWC2.RTL_SWH_CD         = '*'
                            AND MWC2.DS_ORD_CATG_CD     = '*'
                            <!-- START 2023/7/11 G.Quan [QC#61543, ADD] -->
                            AND SPOTM.COA_PROD_CD       = MWC2.COA_PROD_CD
                            <!-- END 2023/7/11 G.Quan [QC#61543, ADD] -->
                            AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD    = SPOTM.GLBL_CMPY_CD
                                            AND   MWC_B.LINE_BIZ_TP_CD  = DOTPD.LINE_BIZ_TP_CD 
                                            AND   MWC_B.RTL_WH_CD       = SPOTM.WH_CD 
                                            AND  (  
                                                    (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    )
                                                 )
                                            <!-- START 2023/7/11 G.Quan [QC#61543, ADD] -->
                                            AND   MWC_B.COA_PROD_CD     = SPOTM.COA_PROD_CD
                                            <!-- END 2023/7/11 G.Quan [QC#61543, ADD] -->
                                            AND   MWC_B.EZCANCELFLAG    = '0'
                                            )
                            )
                        <!-- START 2023/7/11 G.Quan [QC#61543, ADD] -->
                        OR (    SPOTM.SWH_CD            = MWC2.RTL_SWH_CD
                            AND SPOTM.DS_ORD_CATG_CD    = MWC2.DS_ORD_CATG_CD
                            AND SUBSTR(MWC2.COA_PROD_CD,2,1) = '*'
                            AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC2.COA_PROD_CD,'*','%') 
                            AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD    = SPOTM.GLBL_CMPY_CD
                                            AND   MWC_B.LINE_BIZ_TP_CD  = DOTPD.LINE_BIZ_TP_CD 
                                            AND   MWC_B.RTL_WH_CD       = SPOTM.WH_CD 
                                            AND  (  
                                                    (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    )
                                                 )
                                            AND   MWC_B.COA_PROD_CD     = SPOTM.COA_PROD_CD
                                            AND   MWC_B.EZCANCELFLAG    = '0'
                                            )
                            )
                        OR (    MWC2.RTL_SWH_CD         = '*'
                            AND SPOTM.DS_ORD_CATG_CD    = MWC2.DS_ORD_CATG_CD
                            AND SUBSTR(MWC2.COA_PROD_CD,2,1) = '*'
                            AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC2.COA_PROD_CD,'*','%') 
                            AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD    = SPOTM.GLBL_CMPY_CD
                                            AND   MWC_B.LINE_BIZ_TP_CD  = DOTPD.LINE_BIZ_TP_CD 
                                            AND   MWC_B.RTL_WH_CD       = SPOTM.WH_CD 
                                            AND  (  
                                                    (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    )
                                                 )
                                            AND   MWC_B.EZCANCELFLAG    = '0'
                                            )
                            )
                        OR (    SPOTM.SWH_CD            = MWC2.RTL_SWH_CD
                            AND MWC2.DS_ORD_CATG_CD     = '*'
                            AND SUBSTR(MWC2.COA_PROD_CD,2,1) = '*'
                            AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC2.COA_PROD_CD,'*','%') 
                            AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD    = SPOTM.GLBL_CMPY_CD
                                            AND   MWC_B.LINE_BIZ_TP_CD  = DOTPD.LINE_BIZ_TP_CD 
                                            AND   MWC_B.RTL_WH_CD       = SPOTM.WH_CD 
                                            AND  (  
                                                    (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    ) 
                                                 )
                                            AND   MWC_B.EZCANCELFLAG    = '0'
                                            )
                            )
                        OR (    MWC2.RTL_SWH_CD         = '*'
                            AND MWC2.DS_ORD_CATG_CD     = '*'
                            AND SUBSTR(MWC2.COA_PROD_CD,2,1) = '*'
                            AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC2.COA_PROD_CD,'*','%') 
                            AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD    = SPOTM.GLBL_CMPY_CD
                                            AND   MWC_B.LINE_BIZ_TP_CD  = DOTPD.LINE_BIZ_TP_CD 
                                            AND   MWC_B.RTL_WH_CD       = SPOTM.WH_CD 
                                            AND  (  
                                                    (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    ) 
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    )
                                                 )
                                            AND   MWC_B.EZCANCELFLAG    = '0'
                                            )
                            )
                        OR (    SPOTM.SWH_CD            = MWC2.RTL_SWH_CD
                            AND SPOTM.DS_ORD_CATG_CD    = MWC2.DS_ORD_CATG_CD
                            AND MWC2.COA_PROD_CD        = '*'
                            AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD    = SPOTM.GLBL_CMPY_CD
                                            AND   MWC_B.LINE_BIZ_TP_CD  = DOTPD.LINE_BIZ_TP_CD 
                                            AND   MWC_B.RTL_WH_CD       = SPOTM.WH_CD 
                                            AND  (  
                                                    (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    ) 
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    ) 
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    ) 
                                                 )
                                            AND   MWC_B.EZCANCELFLAG    = '0'
                                            )
                            )
                        OR (    MWC2.RTL_SWH_CD         = '*'
                            AND SPOTM.DS_ORD_CATG_CD    = MWC2.DS_ORD_CATG_CD
                            AND MWC2.COA_PROD_CD        = '*'
                            AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD    = SPOTM.GLBL_CMPY_CD
                                            AND   MWC_B.LINE_BIZ_TP_CD  = DOTPD.LINE_BIZ_TP_CD 
                                            AND   MWC_B.RTL_WH_CD       = SPOTM.WH_CD 
                                            AND  (  
                                                    (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    ) 
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    ) 
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND MWC_B.COA_PROD_CD       = '*'
                                                    )  
                                                 )
                                            AND   MWC_B.EZCANCELFLAG    = '0'
                                            )
                            )
                        OR (    SPOTM.SWH_CD            = MWC2.RTL_SWH_CD
                            AND MWC2.DS_ORD_CATG_CD     = '*'
                            AND MWC2.COA_PROD_CD        = '*'
                            AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD    = SPOTM.GLBL_CMPY_CD
                                            AND   MWC_B.LINE_BIZ_TP_CD  = DOTPD.LINE_BIZ_TP_CD 
                                            AND   MWC_B.RTL_WH_CD       = SPOTM.WH_CD 
                                            AND  (  
                                                    (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    ) 
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    ) 
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND MWC_B.COA_PROD_CD       = '*'
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND MWC_B.COA_PROD_CD       = '*'
                                                    )
                                                 )
                                            AND   MWC_B.EZCANCELFLAG    = '0'
                                            )
                            )
                        OR (    MWC2.RTL_SWH_CD         = '*'
                            AND MWC2.DS_ORD_CATG_CD     = '*'
                            AND MWC2.COA_PROD_CD        = '*'
                            AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD    = SPOTM.GLBL_CMPY_CD
                                            AND   MWC_B.LINE_BIZ_TP_CD  = DOTPD.LINE_BIZ_TP_CD 
                                            AND   MWC_B.RTL_WH_CD       = SPOTM.WH_CD 
                                            AND  (  
                                                    (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND MWC_B.COA_PROD_CD       = SPOTM.COA_PROD_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    ) 
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    ) 
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND SUBSTR(MWC_B.COA_PROD_CD,2,1) = '*'
                                                    AND SPOTM.COA_PROD_CD       LIKE  REPLACE(MWC_B.COA_PROD_CD,'*','%') 
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND MWC_B.COA_PROD_CD       = '*'
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD    = SPOTM.DS_ORD_CATG_CD
                                                    AND MWC_B.COA_PROD_CD       = '*'
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD        = SPOTM.SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD    = '*'
                                                    AND MWC_B.COA_PROD_CD       = '*'
                                                    ) 
                                                 )
                                            AND   MWC_B.EZCANCELFLAG    = '0'
                                            )
                            )
                        <!-- END 2023/7/11 G.Quan [QC#61543, ADD] -->
                        )
                    AND MWC2.EZCANCELFLAG       = '0'

                    UNION ALL

                    SELECT  
                        SPOTM.GLBL_CMPY_CD                          GLBL_CMPY_CD
                       ,SPOTM.DS_ORD_CATG_CD                        DS_ORD_CATG_CD
                       ,SPOTM.DS_ORD_TP_CD                          DS_ORD_TP_CD
                       ,SPOTM.DS_ORD_RSN_CD                         DS_ORD_RSN_CD
                       ,SPOTM.DS_CPO_CONFIG_PK                      DS_CPO_CONFIG_PK
                       ,SPOTM.CPO_ORD_NUM                           CPO_ORD_NUM
                       ,SPOTM.CPO_DTL_LINE_NUM                      CPO_DTL_LINE_NUM
                       ,SPOTM.CPO_DTL_LINE_SUB_NUM                  CPO_DTL_LINE_SUB_NUM
                       ,SPOTM.SHPG_PLN_NUM                          SHPG_PLN_NUM
                       ,SPOTM.TIME_STAMP                            TIME_STAMP
                       ,SPOTM.WH_CD                                 WH_CD
                       ,SPOTM.RDD_DT                                RDD_DT
                       ,SPOTM.MDSE_CD                               MDSE_CD
                       ,SPOTM.SP_MDSE_CD                            SP_MDSE_CD
                       ,SPOTM.ORD_TAKE_MDSE_CD                      ORD_TAKE_MDSE_CD
                       ,SPOTM.IS_ORD_TAKE_MDSE_FLG                  IS_ORD_TAKE_MDSE_FLG
                       ,SPOTM.MDL_ID                                MDL_ID
                       <!-- 2017/09/22 QC#21077 Mod START -->
                       <!-- ,0                                      TM_FENCE_DAYS_AOT -->
                       ,#defTmFenceDaysAot#                         TM_FENCE_DAYS_AOT
                       <!-- 2017/09/22 QC#21077 Mod END -->
                       ,SPOTM.CPO_ORD_NUM || SPOTM.DS_CPO_CONFIG_PK ORD_CONFIG_KEY
                       ,M.INVTY_HARD_ALLOC_TP_CD                    INVTY_HARD_ALLOC_TP_CD
                       ,'00'                                        MDSE_WH_COND_TP_CD
                       <!-- START 2022/08/12 [QC#60319, ADD] -->
                       ,SPOTM.SET_MDSE_CD                           SET_MDSE_CD
                       <!-- END 2022/08/12 [QC#60319, ADD] -->
                    FROM 
                         SPOTM
                        ,MDSE     M
                    WHERE
                        SPOTM.GLBL_CMPY_CD       = M.GLBL_CMPY_CD
                    AND SPOTM.MDSE_CD            = M.MDSE_CD
                    AND M.EZCANCELFLAG           = '0'    
                    ) ALLOC_INFO1
            
                ) ALLOC_INFO2
            WHERE
                ALLOC_INFO2.PARTITION_NUM = 1
            
            )                   ALLOCATION_INFO
            
            ,MDSE               M
            ,MDL_BO_IMPCT       MBI    <!-- QC#18386(L3#072) Add -->
            ,BACK_ORD_IMPCT_TP  BOIT
            <!-- START 2022/08/12 [QC#60319, ADD] -->
            ,MDSE               PRNT_M
            ,BACK_ORD_IMPCT_TP  PRNT_BOIT
            <!-- END 2022/08/12 [QC#60319, ADD] -->
        WHERE
            <!-- START 2023/10/3 [QC#61274, MOD] -->
            <!--ALLOCATION_INFO.INVTY_HARD_ALLOC_TP_CD  = #hardAllocTp# -->
            (
                ALLOCATION_INFO.INVTY_HARD_ALLOC_TP_CD  = #hardAllocTp#
                OR
                (
                    <iterate property="avalRtlWhCdArray" var="rtlWhCdList[]" open="ALLOCATION_INFO.WH_CD IN (" close=")" conjunction=",">
                        #rtlWhCdList[]#
                    </iterate>
                AND EXISTS( SELECT 1
                            FROM
                                RCV_ASN_VND RAV
                               ,PO
                               ,PO_DTL PD
                            WHERE 1 = 1
                            AND ALLOCATION_INFO.GLBL_CMPY_CD         = PD.GLBL_CMPY_CD
                            AND ALLOCATION_INFO.CPO_ORD_NUM          = PD.CPO_ORD_NUM
                            AND ALLOCATION_INFO.CPO_DTL_LINE_NUM     = PD.CPO_DTL_LINE_NUM
                            AND ALLOCATION_INFO.CPO_DTL_LINE_SUB_NUM = PD.CPO_DTL_LINE_SUB_NUM
                            AND PD.GLBL_CMPY_CD                      = PO.GLBL_CMPY_CD
                            AND PD.PO_STS_CD                         = #poSts#
                            AND PD.EZCANCELFLAG                      = '0'
                            AND PD.PO_ORD_NUM                        = PO.PO_ORD_NUM
                            AND PO.EZCANCELFLAG                      = '0'
                            AND PO.GLBL_CMPY_CD                      = RAV.GLBL_CMPY_CD
                            AND PO.VND_CD                            = RAV.RCV_ASN_VND_CD
                            AND RAV.EZCANCELFLAG                     = '0'
                    )
                )
            )
            <!-- END 2023/10/3 [QC#61274, MOD] -->
        AND ALLOCATION_INFO.GLBL_CMPY_CD            = M.GLBL_CMPY_CD
        AND ALLOCATION_INFO.MDSE_CD                 = M.MDSE_CD
        AND M.INVTY_DIST_TP_CD                      = #invtyDistTpNone#
        AND M.INVTY_CTRL_FLG                        = 'Y'
        AND M.EZCANCELFLAG                          = '0'
        <!-- QC#18386(L3#072) ADD START -->
        AND ALLOCATION_INFO.GLBL_CMPY_CD            = MBI.GLBL_CMPY_CD(+)
        AND ALLOCATION_INFO.MDL_ID                  = MBI.MDL_ID(+)
        AND ALLOCATION_INFO.ORD_TAKE_MDSE_CD        = MBI.MDSE_CD(+)
        AND MBI.EZCANCELFLAG(+)                     = '0'
        
        AND M.GLBL_CMPY_CD                          = BOIT.GLBL_CMPY_CD(+)
        AND DECODE(MBI.MDL_ID , NULL, M.BACK_ORD_IMPCT_TP_CD, MBI.BO_IMPCT_TP_CD)
                                                    = BOIT.BACK_ORD_IMPCT_TP_CD(+)
        AND BOIT.EZCANCELFLAG(+)                    = '0'
        <!-- QC#18386(L3#072) ADD END -->
        <!-- START 2022/08/12 [QC#60319, ADD] -->
        AND ALLOCATION_INFO.GLBL_CMPY_CD            = PRNT_M.GLBL_CMPY_CD(+)
        AND ALLOCATION_INFO.SET_MDSE_CD             = PRNT_M.MDSE_CD(+)
        AND PRNT_M.MDSE_ITEM_TP_CD(+)               = #mdseItemTp#
        AND PRNT_M.EZCANCELFLAG(+)                  = '0'
        AND PRNT_M.GLBL_CMPY_CD                     = PRNT_BOIT.GLBL_CMPY_CD(+)
        AND PRNT_M.BACK_ORD_IMPCT_TP_CD             = PRNT_BOIT.BACK_ORD_IMPCT_TP_CD(+)
        AND PRNT_BOIT.EZCANCELFLAG(+)               = '0'
        <!-- END 2022/08/12 [QC#60319, ADD] -->
    ORDER BY
        ALLOCATION_INFO.TIME_STAMP ASC
       ,ALLOCATION_INFO.CPO_ORD_NUM
       ,ALLOCATION_INFO.DS_CPO_CONFIG_PK
       <!-- START 2022/08/12 [QC#60319, MOD] -->
       <!-- ,BOIT.BACK_ORD_IMPCT_TP_PRTY_NUM NULLS LAST -->
       ,NVL2(PRNT_BOIT.BACK_ORD_IMPCT_TP_CD, PRNT_BOIT.BACK_ORD_IMPCT_TP_PRTY_NUM, BOIT.BACK_ORD_IMPCT_TP_PRTY_NUM) NULLS LAST
       <!-- END 2022/08/12 [QC#60319, MOD] -->
       ,ALLOCATION_INFO.CPO_DTL_LINE_NUM
       ,ALLOCATION_INFO.CPO_DTL_LINE_SUB_NUM
<!--QC#5872(L3#001) Add End-->
    </statement>

    <statement id="getOrderCategoryBusinessContext" parameterClass="Map" resultClass="Map">
        SELECT
             OCBC.DS_ORD_CATG_CD                    DS_ORD_CATG_CD
            ,OCBC.DS_ORD_TP_CD                        DS_ORD_TP_CD
            ,OCBC.DS_ORD_RSN_CD                        DS_ORD_RSN_CD
        FROM
             ORD_CATG_BIZ_CTX OCBC
        WHERE
            OCBC.GLBL_CMPY_CD           = #glblCmpyCd#
            AND OCBC.ORD_CATG_CTX_TP_CD = #ordCatgCtxTpCd#
            AND OCBC.EZCANCELFLAG       = '0'
    </statement>

</sqlMap>
