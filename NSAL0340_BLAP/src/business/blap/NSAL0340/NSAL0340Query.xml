<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSAL0340Query">

    <statement id="isExsistSvcInvChrgTp" parameterClass="Map" resultClass="Integer">
        SELECT
            COUNT(CT.SVC_INV_CHRG_TP_CD)
        FROM
            SVC_INV_CHRG_TP CT
        WHERE
            CT.GLBL_CMPY_CD           = #glblCmpyCd#
            AND CT.SVC_INV_CHRG_TP_CD = #svcInvChrgTpCd#
            AND CT.EZCANCELFLAG       = '0'
    </statement>

    <statement id="getHdrData" parameterClass="Map" resultMap="result.getHdrData">
        SELECT
            DC.DS_CONTR_NUM          AS DS_CONTR_NUM
           ,DC.DS_CONTR_STS_CD       AS DS_CONTR_STS_CD
           ,SMM.SER_NUM              AS SER_NUM
           ,SMM.MDSE_CD              AS MDSE_CD
           ,MDSE.MDSE_DESC_SHORT_TXT AS MDSE_DESC_SHORT_TXT
           ,MN.T_MDL_NM              AS T_MDL_NM
           ,DCD.DS_CONTR_DTL_STS_CD  AS DS_CONTR_DTL_STS_CD
           ,CT.SVC_INV_CHRG_TP_NM    AS SVC_INV_CHRG_TP_NM
        FROM
            DS_CONTR_DTL    DCD
           ,DS_CONTR        DC
           ,SVC_MACH_MSTR   SMM
           ,MDSE            MDSE
<!-- START 2015/10/20 T.Tomita [N/A, MOD] -->
<!--       ,MDL_ITEM        MI     -->
           ,SVC_CONFIG_MSTR SCM
           ,DS_MDL          DM
<!-- END 2015/10/20 T.Tomita [N/A, MOD] -->
           ,MDL_NM          MN
           ,SVC_INV_CHRG_TP CT
        WHERE
            DCD.GLBL_CMPY_CD        = #glblCmpyCd#
            AND DCD.DS_CONTR_DTL_PK = #dsContrDtlPk#
            AND DCD.EZCANCELFLAG    = '0'

            AND DCD.GLBL_CMPY_CD = DC.GLBL_CMPY_CD
            AND DCD.DS_CONTR_PK  = DC.DS_CONTR_PK
            AND DC.EZCANCELFLAG  = '0'

<!-- START 2015/10/20 T.Tomita [N/A, MOD] -->
            AND DCD.GLBL_CMPY_CD      = SMM.GLBL_CMPY_CD     (+)
            AND DCD.SVC_MACH_MSTR_PK  = SMM.SVC_MACH_MSTR_PK (+)
            AND SMM.EZCANCELFLAG  (+) = '0'

            AND SMM.GLBL_CMPY_CD      = MDSE.GLBL_CMPY_CD (+)
            AND SMM.MDSE_CD           = MDSE.MDSE_CD      (+)
            AND MDSE.EZCANCELFLAG (+) = '0'

<!--        AND MDSE.GLBL_CMPY_CD   = MI.T_GLBL_CMPY_CD (+)      -->
<!--        AND MDSE.MDSE_CD        = MI.T_ITEM_CD (+)           -->
<!--        AND MI.EZCANCELFLAG (+) = '0'                        -->
<!--                                                             -->
<!--        AND MI.T_GLBL_CMPY_CD   = MN.T_GLBL_CMPY_CD (+)      -->
<!--        AND MI.T_MDL_ID         = MN.T_MDL_ID (+)            -->
<!--        AND MN.EZCANCELFLAG (+) = '0'                        -->

            AND SMM.GLBL_CMPY_CD         = SCM.GLBL_CMPY_CD       (+)
            AND SMM.SVC_CONFIG_MSTR_PK   = SCM.SVC_CONFIG_MSTR_PK (+)
            AND SCM.EZCANCELFLAG     (+) = '0'

            AND SCM.GLBL_CMPY_CD         = DM.GLBL_CMPY_CD        (+)
            AND SCM.MDL_ID               = DM.MDL_ID              (+)
            AND DM.EZCANCELFLAG      (+) = '0'

            AND DM.GLBL_CMPY_CD          = MN.T_GLBL_CMPY_CD      (+)
            AND DM.MDL_ID                = MN.T_MDL_ID            (+)
            AND MN.EZCANCELFLAG      (+) = '0'
<!-- END 2015/10/20 T.Tomita [N/A, MOD] -->

            AND DCD.GLBL_CMPY_CD          = CT.GLBL_CMPY_CD (+)
            AND CT.SVC_INV_CHRG_TP_CD (+) = #svcInvChrgTpCd#
            AND CT.EZCANCELFLAG (+)       = '0'
    </statement>

    <statement id="getDtlData" parameterClass="Map" resultMap="result.getDtlData">
        WITH MONTH AS (
                       SELECT TO_CHAR(SYSDATE, 'MM') MM FROM DUAL
                       UNION
                       SELECT TO_CHAR(ADD_MONTHS(SYSDATE, 1), 'MM') FROM DUAL
                       UNION
                       SELECT TO_CHAR(ADD_MONTHS(SYSDATE, 2), 'MM') FROM DUAL
                       UNION
                       SELECT TO_CHAR(ADD_MONTHS(SYSDATE, 3), 'MM') FROM DUAL
                       UNION
                       SELECT TO_CHAR(ADD_MONTHS(SYSDATE, 4), 'MM') FROM DUAL
                       UNION
                       SELECT TO_CHAR(ADD_MONTHS(SYSDATE, 5), 'MM') FROM DUAL
                       UNION
                       SELECT TO_CHAR(ADD_MONTHS(SYSDATE, 6), 'MM') FROM DUAL
                       UNION
                       SELECT TO_CHAR(ADD_MONTHS(SYSDATE, 7), 'MM') FROM DUAL
                       UNION
                       SELECT TO_CHAR(ADD_MONTHS(SYSDATE, 8), 'MM') FROM DUAL
                       UNION
                       SELECT TO_CHAR(ADD_MONTHS(SYSDATE, 9), 'MM') FROM DUAL
                       UNION
                       SELECT TO_CHAR(ADD_MONTHS(SYSDATE, 10), 'MM') FROM DUAL
                       UNION
                       SELECT TO_CHAR(ADD_MONTHS(SYSDATE, 11), 'MM') FROM DUAL
                      )
       ,SKIP_RECOV AS (
                       SELECT
                           DCSR.SKIP_RECOV_MTH
                          ,DCSR.SKIP_RECOV_TP_CD
                          ,DCSR.EZUPTIMEZONE
                          ,DCSR.EZUPTIME
<!-- START 2016/11/29 K.Ochiai [QC#14204, ADD] -->
                          ,DCSR.EZINTIME
                          ,DCSR.EZINUSERID
                          ,DCSR.EZUPUSERID
                          ,DCSR.EZTABLEID
<!-- END 2016/11/29 K.Ochiai [QC#14204, ADD] -->
                       FROM
                           DS_CONTR_SKIP_RECOV DCSR
                       WHERE
                           DCSR.GLBL_CMPY_CD           = #glblCmpyCd#
                           AND DCSR.DS_CONTR_DTL_PK    = #dsContrDtlPk#
                           AND DCSR.SVC_INV_CHRG_TP_CD = #svcInvChrgTpCd#
                           AND DCSR.EZCANCELFLAG       = '0'
                      )
        SELECT
            M.MM                             AS MONTH
           ,NVL(SR.SKIP_RECOV_TP_CD, #none#) AS SKIP_RECOV_TP_CD
           ,SR.EZUPTIMEZONE                  AS EZUPTIMEZONE
           ,SR.EZUPTIME                      AS EZUPTIME
<!-- START 2016/11/29 K.Ochiai [QC#14204, ADD] -->
           ,SR.EZINTIME                      AS  XX_REC_HIST_CRAT_TS
           ,SR.EZINUSERID                    AS  XX_REC_HIST_CRAT_BY_NM
           ,SR.EZUPTIME                      AS  XX_REC_HIST_UPD_TS
           ,SR.EZUPUSERID                    AS  XX_REC_HIST_UPD_BY_NM
           ,SR.EZTABLEID                     AS  XX_REC_HIST_TBL_NM
<!-- END 2016/11/29 K.Ochiai [QC#14204, ADD] -->
        FROM
            MONTH M
           ,SKIP_RECOV SR
        WHERE
            M.MM = SR.SKIP_RECOV_MTH(+)
        ORDER BY
            M.MM
    </statement>

    <statement id="isExistSkipRecovInfo" parameterClass="Map" resultClass="Integer">
        SELECT
            COUNT(DCSR.DS_CONTR_SKIP_RECOV_PK)
        FROM
            DS_CONTR_SKIP_RECOV DCSR
        WHERE
            DCSR.GLBL_CMPY_CD           = #glblCmpyCd#
            AND DCSR.DS_CONTR_DTL_PK    = #dsContrDtlPk#
            AND DCSR.SKIP_RECOV_MTH     = #skipRecovMth#
            AND DCSR.SVC_INV_CHRG_TP_CD = #svcInvChrgTpCd#
            AND DCSR.EZCANCELFLAG       = '0'
    </statement>

<!-- START 2017/09/13 K.Kim [QC#19938, ADD] -->
    <statement id="getBillWithEquipmentFlg" parameterClass="Map" resultClass="String">
        SELECT
            DCD.BILL_WITH_EQUIP_FLG
        FROM
            DS_CONTR_DTL DCD
        WHERE
            DCD.GLBL_CMPY_CD            = #glblCmpyCd#
            AND DCD.DS_CONTR_DTL_PK     = #dsContrDtlPk#
            AND DCD.EZCANCELFLAG        = '0'
    </statement>

    <statement id="isBillSchdStsClsInfo" parameterClass="Map" resultClass="Integer">
        SELECT
            COUNT(DCBS.DS_CONTR_BLLG_SCHD_PK)
        FROM
            DS_CONTR_BLLG_SCHD DCBS
        WHERE
            DCBS.GLBL_CMPY_CD                   = #glblCmpyCd#
            AND DCBS.DS_CONTR_DTL_PK            = #dsContrDtlPk#
            AND DCBS.DS_BLLG_SCHD_STS_CD &lt;&gt; #dsBllgSchdStsCdCl#
            AND DCBS.EZCANCELFLAG               = '0'
        <isEqual property="BaseChargeFlg" compareValue="Y">
            AND DCBS.BASE_CHRG_FLG              = 'Y'
        </isEqual>
        <isEqual property="BaseChargeFlg" compareValue="N">
            AND DCBS.USG_CHRG_FLG               = 'Y'
        </isEqual>
    </statement>
<!-- END 2017/09/13 K.Kim [QC#19938, ADD] -->

    <typeAlias alias="NSAL0340CMsg"   type="business.blap.NSAL0340.NSAL0340CMsg"/>
    <typeAlias alias="NSAL0340_ACMsg" type="business.blap.NSAL0340.NSAL0340_ACMsg"/>

    <resultMap id="result.getHdrData" class="NSAL0340CMsg">
        <result property="dsContrNum"       column="DS_CONTR_NUM"        javaType="EZDCStringItem"/>
        <result property="dsContrStsCd"     column="DS_CONTR_STS_CD"     javaType="EZDCStringItem"/>
        <result property="serNum"           column="SER_NUM"             javaType="EZDCStringItem"/>
        <result property="mdseCd"           column="MDSE_CD"             javaType="EZDCStringItem"/>
        <result property="mdseDescShortTxt" column="MDSE_DESC_SHORT_TXT" javaType="EZDCStringItem"/>
        <result property="t_MdlNm"          column="T_MDL_NM"            javaType="EZDCStringItem"/>
        <result property="dsContrDtlStsCd"  column="DS_CONTR_DTL_STS_CD" javaType="EZDCStringItem"/>
        <result property="svcInvChrgTpNm"   column="SVC_INV_CHRG_TP_NM"  javaType="EZDCStringItem"/>
    </resultMap>

    <resultMap id="result.getDtlData" class="NSAL0340_ACMsg">
        <result property="skipRecovMth_A0"       column="MONTH"            javaType="EZDCStringItem"/>
        <result property="skipRecovTpCd_A0" column="SKIP_RECOV_TP_CD" javaType="EZDCStringItem"/>
        <result property="ezUpTimeZone_A0"  column="EZUPTIMEZONE"     javaType="EZDCStringItem"/>
        <result property="ezUpTime_A0"      column="EZUPTIME"         javaType="EZDCStringItem"/>
<!-- START 2016/11/29 K.Ochiai [QC#14204, ADD] -->
        <result property="xxRecHistCratTs_A0"      column="XX_REC_HIST_CRAT_TS"        javaType="EZDCStringItem"/>
        <result property="xxRecHistCratByNm_A0"    column="XX_REC_HIST_CRAT_BY_NM"     javaType="EZDCStringItem"/>
        <result property="xxRecHistUpdTs_A0"       column="XX_REC_HIST_UPD_TS"         javaType="EZDCStringItem"/>
        <result property="xxRecHistUpdByNm_A0"     column="XX_REC_HIST_UPD_BY_NM"      javaType="EZDCStringItem"/>
        <result property="xxRecHistTblNm_A0"       column="XX_REC_HIST_TBL_NM"         javaType="EZDCStringItem"/>
<!-- END 2016/11/29 K.Ochiai [QC#14204, ADD] -->
    </resultMap>

<!-- START 2018/03/09 K.Kojima [QC#23600,ADD] -->
    <statement id="getChildDsContrDtlPkForAgg" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             DCDC.DS_CONTR_DTL_PK
        FROM
             DS_CONTR_DTL DCD
            ,DS_CONTR_DTL DCDC
        WHERE
                DCD.GLBL_CMPY_CD       = #glblCmpyCd#
            AND DCD.DS_CONTR_DTL_PK    = #dsContrDtlPk#
            AND DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpAgg#
            AND DCD.EZCANCELFLAG       = '0'
            AND DCD.GLBL_CMPY_CD       = DCDC.GLBL_CMPY_CD
            AND DCD.DS_CONTR_DTL_PK    = DCDC.PRNT_DS_CONTR_DTL_PK
            AND DCDC.EZCANCELFLAG      = '0'
            AND EXISTS(
                SELECT
                    1
                FROM
                    DS_CONTR_BLLG_SCHD DCBS
                WHERE
                        DCBS.GLBL_CMPY_CD    = DCDC.GLBL_CMPY_CD
                    AND DCBS.DS_CONTR_DTL_PK = DCDC.DS_CONTR_DTL_PK
                    <isEqual property="BaseChargeFlg" compareValue="Y">
                    AND DCBS.BASE_CHRG_FLG   = 'Y'
                    </isEqual>
                    <isEqual property="BaseChargeFlg" compareValue="N">
                    AND DCBS.USG_CHRG_FLG    = 'Y'
                    </isEqual>
                    AND DCBS.EZCANCELFLAG    = '0'
            )
        UNION ALL
        SELECT
             DCDCC.DS_CONTR_DTL_PK
        FROM
             DS_CONTR_DTL DCD
            ,DS_CONTR_DTL DCDC
            ,DS_CONTR_DTL DCDCC
        WHERE
                DCD.GLBL_CMPY_CD       = #glblCmpyCd#
            AND DCD.DS_CONTR_DTL_PK    = #dsContrDtlPk#
            AND DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpAgg#
            AND DCD.EZCANCELFLAG       = '0'
            AND DCD.GLBL_CMPY_CD       = DCDC.GLBL_CMPY_CD
            AND DCD.DS_CONTR_DTL_PK    = DCDC.PRNT_DS_CONTR_DTL_PK
            AND DCDC.EZCANCELFLAG      = '0'
            AND DCDC.GLBL_CMPY_CD      = DCDCC.GLBL_CMPY_CD
            AND DCDC.DS_CONTR_DTL_PK   = DCDCC.PRNT_DS_CONTR_DTL_PK
            AND DCDCC.EZCANCELFLAG     = '0'
            AND EXISTS(
                SELECT
                    1
                FROM
                    DS_CONTR_BLLG_SCHD DCBS
                WHERE
                        DCBS.GLBL_CMPY_CD    = DCDCC.GLBL_CMPY_CD
                    AND DCBS.DS_CONTR_DTL_PK = DCDCC.DS_CONTR_DTL_PK
                    <isEqual property="BaseChargeFlg" compareValue="Y">
                    AND DCBS.BASE_CHRG_FLG   = 'Y'
                    </isEqual>
                    <isEqual property="BaseChargeFlg" compareValue="N">
                    AND DCBS.USG_CHRG_FLG    = 'Y'
                    </isEqual>
                    AND DCBS.EZCANCELFLAG    = '0'
            )
    </statement>
<!-- END 2018/03/09 K.Kojima [QC#23600,ADD] -->

</sqlMap>
