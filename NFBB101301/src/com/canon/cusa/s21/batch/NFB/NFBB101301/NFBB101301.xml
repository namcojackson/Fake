<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NFBB101301">

    <statement id="SELECT_RECORD" parameterClass="Map">
        SELECT
             INV_DATE.*
            ,LPAD(TO_CHAR(ROW_NUMBER() OVER (PARTITION BY INV_DATE.AP_VND_CD, INV_DATE.AP_VND_INV_NUM
<!-- QC#20316(Sol#202) START-->
                 ORDER BY INV_DATE.AP_VND_CD, INV_DATE.AP_VND_INV_NUM, INV_DATE.VND_INV_LINE_NUM, INV_DATE.AP_VND_INV_SQ_NUM)), 4, '0')
<!-- QC#20316(Sol#202) END-->
             AS AP_VND_INV_LINE_NUM
        FROM(
            SELECT
                VIW.VND_CD                                           AP_VND_CD
            ,   VIW.VND_INV_NUM                                      AP_VND_INV_NUM
            ,   #apVndInvSqNum#                                      AP_VND_INV_SQ_NUM
            ,   #apInvTpCd#                                          AP_INV_TP_CD
            ,   VIW.INV_TP_CD                                        INV_TP_CD
            ,   #ifProcStsCd#                                        IF_PROC_STS_CD
            ,   VIW.INV_DT                                           INV_DT
            ,   VIW.DEAL_CCY_CD                                      CCY_CD
            ,   VIW.NET_DUE_DT                                       PMT_DUE_DT
            ,   VIW.VND_PMT_TERM_CD                                  VND_PMT_TERM_CD
            ,   CVB.ACCT_BANK_CD                                     ACCT_BANK_CD
            ,   CVB.ACCT_BANK_ACCT_PAY_TP_CD                         ACCT_BANK_ACCT_PAY_TP_CD
            ,   NVL(VIW.INV_TOT_DEAL_SLS_AMT,0)                      AC_OC_TOT_FOB_COST_AMT
            ,   NVL(VIW.INV_TOT_DEAL_FRT_AMT,0)                      AC_OC_TOT_FRT_COST_AMT
              <!-- START 2023/01/05 S.Nakatani [QC#60248,ADD] -->
            ,   NVL(VIW.INV_TOT_DEAL_HDLG_COST_AMT,0)                AC_OC_TOT_HDLG_COST_AMT
              <!-- END 2023/01/05 S.Nakatani [QC#60248,ADD] -->
            ,   NVL(VIW.INV_TOT_DEAL_INS_AMT,0)                      AC_OC_TOT_INS_COST_AMT
            ,   NVL(VIW.INV_TOT_DEAL_OTH_AMT,0)                      AC_OC_TOT_OTH_COST_AMT
            ,   NVL(VIW.INV_TOT_DEAL_TAX_AMT,0)                      AC_OC_TOT_TAX_AMT
            ,   NVL(VIW.INV_TOT_DEAL_SLS_AMT,0)
              + NVL(VIW.INV_TOT_DEAL_FRT_AMT,0)
              + NVL(VIW.INV_TOT_DEAL_INS_AMT,0)
              <!-- START 2023/01/05 S.Nakatani [QC#60248,ADD] -->
              + NVL(VIW.INV_TOT_DEAL_HDLG_COST_AMT,0)
              <!-- END 2023/01/05 S.Nakatani [QC#60248,ADD] -->
              + NVL(VIW.INV_TOT_DEAL_OTH_AMT,0)                      AC_OC_TOT_GND_COST_AMT
            ,   NVL(VILW.MDSE_CD,'NONE')                             MDSE_CD
            ,   NVL(VIBW.ASN_SO_NUM,VIW.VND_INV_NUM)                 DELY_ORD_NUM
            ,   VILW.SHIP_QTY                                        INV_QTY
            ,   NVL(VILW.VND_INV_LINE_DEAL_OTH_AMT,0)                AC_OC_OTH_COST_AMT
            ,   NVL(VILW.VND_INV_LINE_DEAL_NET_AMT,0)                AC_OC_FOB_COST_AMT
            ,   NVL(VILW.VND_INV_LINE_DEAL_NET_AMT,0)                VND_INV_LINE_DEAL_NET_AMT
            ,   SUBSTR(VIBW.PO_ORD_NUM,1,15)                         VND_REF_NUM
            ,   VILW.VND_INV_LINE_NUM                                VND_INV_LINE_NUM
            ,   VIBW.VND_INV_BOL_LINE_NUM                            VND_INV_BOL_LINE_NUM
            ,   VIBW.SHIP_DEAL_FRT_AMT                               SHIP_DEAL_FRT_AMT
            ,   NVL(VILW_BOL_SUM.VND_INV_LINE_DEAL_NET_AMT_SUM,0)    DEAL_NET_AMT_BOL_SUM
            ,   VILW_BOL_SUM.BOL_GROUP_REC_CNT                       BOL_GROUP_REC_CNT
            ,   NVL(VILW_LINE_SUM.VND_INV_LINE_DEAL_NET_AMT_SUM,0)   DEAL_NET_AMT_LINE_SUM
            ,   VILW_LINE_SUM.LINE_GROUP_REC_CNT                     LINE_GROUP_REC_CNT
            ,   VIBW.VND_FOC_TP_CD                                   VND_FOC_TP_CD
            ,   VIBW.PO_ORD_NUM                                      PO_ORD_NUM
<!-- QC#20316(Sol#202) START-->
            ,   VILW.PO_ORD_DTL_LINE_NUM                             PO_ORD_DTL_LINE_NUM
<!-- QC#20316(Sol#202) END-->
            ,   VIW.VND_INV_PROC_STS_CD                              VND_INV_PROC_STS_CD
            ,   PD.PO_QTY                                            PO_QTY
            ,   NVL(PD.THIS_MTH_FOB_COST_AMT, 0)                     THIS_MTH_FOB_COST_AMT
            ,   NVL(PD.ENT_DEAL_NET_UNIT_PRC_AMT, 0)                 ENT_DEAL_NET_UNIT_PRC_AMT
            ,   NVL(PD.ENT_PO_DTL_DEAL_NET_AMT, 0)                   ENT_PO_DTL_DEAL_NET_AMT
            ,   NVL(PD.ENT_FUNC_NET_UNIT_PRC_AMT, 0)                 ENT_FUNC_NET_UNIT_PRC_AMT
            ,   NVL(PD.ENT_PO_DTL_FUNC_NET_AMT, 0)                   ENT_PO_DTL_FUNC_NET_AMT
            ,   NVL(PD.EXCH_RATE, 0)                                 EXCH_RATE
            ,   PD.MDSE_DESC_SHORT_TXT                               MDSE_DESC_SHORT_TXT
<!-- QC#28099 START -->
            ,   VND.SPLY_PMT_FLG                                     SPLY_PMT_FLG
            ,   VND.ALT_VND_CD                                       ALT_VND_CD
<!-- QC#28099 END -->
<!-- QC#28982 START -->
            ,   NVL(VILW.DEAL_NET_UNIT_PRC_AMT,0)                    DEAL_NET_UNIT_PRC_AMT
<!-- QC#28982 END -->
<!-- QC#52280 START -->
            ,   VIW.ITRL_INTFC_ID                                    ITRL_INTFC_ID
<!-- QC#52280 END -->
            FROM
                VND_INV_WRK       VIW
            ,   VND_INV_BOL_WRK   VIBW
            ,   VND_INV_LINE_WRK  VILW
            ,   CM_VND_BANK       CVB
<!-- QC#28099 START -->
            ,   (
                    SELECT
                         PV.GLBL_CMPY_CD    AS GLBL_CMPY_CD
                        ,PV.PRNT_VND_CD     AS PRNT_VND_CD
                        ,V1.VND_CD          AS VND_CD
                        ,V1.SPLY_PMT_FLG    AS SPLY_PMT_FLG
                        ,V1.VND_CD          AS ALT_VND_CD
                    FROM
                         PRNT_VND PV
                        ,VND V1
                    WHERE 
                        PV.GLBL_CMPY_CD = #glblCmpyCd#
                    AND PV.GLBL_CMPY_CD = V1.GLBL_CMPY_CD
                    AND PV.PRNT_VND_PK  = V1.PRNT_VND_PK
                    AND V1.SPLY_PMT_FLG = #splyPmtFlgY#
                    AND PV.EZCANCELFLAG = '0'
                    AND V1.EZCANCELFLAG = '0'
                    UNION ALL
                    SELECT
                         PV.GLBL_CMPY_CD    AS GLBL_CMPY_CD
                        ,PV.PRNT_VND_CD     AS PRNT_VND_CD
                        ,V1.VND_CD          AS VND_CD
                        ,V1.SPLY_PMT_FLG    AS SPLY_PMT_FLG
                        ,MIN(V2.VND_CD)     AS ALT_VND_CD
                    FROM
                         PRNT_VND PV
                        ,VND V1
                        ,VND V2
                    WHERE 
                        PV.GLBL_CMPY_CD     = #glblCmpyCd#
                    AND PV.GLBL_CMPY_CD     = V1.GLBL_CMPY_CD
                    AND PV.GLBL_CMPY_CD     = V2.GLBL_CMPY_CD(+)
                    AND PV.PRNT_VND_PK      = V1.PRNT_VND_PK
                    AND PV.PRNT_VND_PK      = V2.PRNT_VND_PK(+)
                    AND V1.SPLY_PMT_FLG     = #splyPmtFlgN#
                    AND V2.SPLY_PMT_FLG(+)  = #splyPmtFlgY#
                    AND PV.EZCANCELFLAG     = '0'
                    AND V1.EZCANCELFLAG     = '0'
                    AND V2.EZCANCELFLAG(+)  = '0'
                    GROUP BY PV.GLBL_CMPY_CD, PV.PRNT_VND_CD, V1.VND_CD, V1.SPLY_PMT_FLG
                )                 VND
<!-- QC#28099 END -->
            ,   (
                    SELECT
                        VILW.VND_INV_NUM
                    ,   VILW.VND_INV_BOL_LINE_NUM
                    ,   SUM(VILW.VND_INV_LINE_DEAL_NET_AMT) VND_INV_LINE_DEAL_NET_AMT_SUM
                    ,   COUNT(VILW.GLBL_CMPY_CD)            BOL_GROUP_REC_CNT
                    FROM
                        VND_INV_LINE_WRK VILW
                    WHERE
                        VILW.GLBL_CMPY_CD = #glblCmpyCd#
                    AND VILW.EZCANCELFLAG = '0'
                    AND EXISTS
                            (
                                SELECT
                                    1
                                FROM
                                    VND_INV_WRK VIW
                                WHERE
                                    VIW.GLBL_CMPY_CD               =      VILW.GLBL_CMPY_CD
                                AND VIW.VND_INV_NUM                =      VILW.VND_INV_NUM
                                AND VIW.VND_INV_PROC_STS_CD        =      #vndInvProcStsP#
                                AND (
                                       VIW.CR_DR_RSN_CD            NOT IN
                                       <iterate property="listCrDrRsnCd" var="listCrDrRsnCd[]" open="(" close=")" conjunction=",">
                                           #listCrDrRsnCd[]#
                                       </iterate>
                                    OR VIW.CR_DR_RSN_CD            IS NULL
                                    )
                                AND VIW.CM_PROC_STS_CD             =      #cmProcStsCdN#
                                AND VIW.EZCANCELFLAG               =      '0'
                            )
                    GROUP BY
                        VILW.VND_INV_NUM
                    ,   VILW.VND_INV_BOL_LINE_NUM
                )                 VILW_BOL_SUM
            ,   (
                    SELECT
                        VILW.VND_INV_NUM
                    ,   SUM(VILW.VND_INV_LINE_DEAL_NET_AMT) VND_INV_LINE_DEAL_NET_AMT_SUM
                    ,   COUNT(GLBL_CMPY_CD)                 LINE_GROUP_REC_CNT
                    FROM
                        VND_INV_LINE_WRK VILW
                    WHERE
                        VILW.GLBL_CMPY_CD = #glblCmpyCd#
                    AND VILW.EZCANCELFLAG = '0'
                    AND EXISTS
                            (
                                SELECT
                                    1
                                FROM
                                    VND_INV_WRK VIW
                                WHERE
                                    VIW.GLBL_CMPY_CD               =      VILW.GLBL_CMPY_CD
                                AND VIW.VND_INV_NUM                =      VILW.VND_INV_NUM
                                AND VIW.VND_INV_PROC_STS_CD        =      #vndInvProcStsP#
                                AND (
                                       VIW.CR_DR_RSN_CD            NOT IN
                                       <iterate property="listCrDrRsnCd" var="listCrDrRsnCd[]" open="(" close=")" conjunction=",">
                                           #listCrDrRsnCd[]#
                                       </iterate>
                                    OR VIW.CR_DR_RSN_CD            IS NULL
                                    )
                                AND VIW.CM_PROC_STS_CD             =      #cmProcStsCdN#
                                AND VIW.EZCANCELFLAG               =      '0'
                            )
                    GROUP BY
                        VILW.VND_INV_NUM
                )                 VILW_LINE_SUM
                , PO_DTL PD
            WHERE
                VIW.GLBL_CMPY_CD                =      #glblCmpyCd#
            AND VIW.GLBL_CMPY_CD                =      VIBW.GLBL_CMPY_CD
            AND VIW.GLBL_CMPY_CD                =      VILW.GLBL_CMPY_CD
            AND VIW.GLBL_CMPY_CD                =      CVB.GLBL_CMPY_CD(+)
<!-- QC#28099 START -->
            AND VIW.GLBL_CMPY_CD                =      VND.GLBL_CMPY_CD(+)
<!-- QC#28099 END -->
            AND VIBW.GLBL_CMPY_CD               =      VILW.GLBL_CMPY_CD
            AND VIW.VND_INV_NUM                 =      VIBW.VND_INV_NUM
            AND VIBW.VND_INV_NUM                =      VILW.VND_INV_NUM
            AND VIBW.VND_INV_BOL_LINE_NUM       =      VILW.VND_INV_BOL_LINE_NUM
            AND VIW.VND_CD                      =      CVB.CM_VND_BANK_CD(+)
<!-- QC#28099 START -->
            AND VIW.VND_CD                      =      VND.VND_CD(+)
<!-- QC#28099 END -->
            AND VIW.VND_INV_PROC_STS_CD         =      #vndInvProcStsP#
            AND (
                    VIW.CR_DR_RSN_CD            NOT IN
                    <iterate property="listCrDrRsnCd" var="listCrDrRsnCd[]" open="(" close=")" conjunction=",">
                        #listCrDrRsnCd[]#
                    </iterate>
                OR VIW.CR_DR_RSN_CD             IS NULL
                )
            AND VIW.CM_PROC_STS_CD              =      #cmProcStsCdN#
            AND VILW.VND_INV_NUM                =      VILW_BOL_SUM.VND_INV_NUM
            AND VILW.VND_INV_BOL_LINE_NUM       =      VILW_BOL_SUM.VND_INV_BOL_LINE_NUM
            AND VILW.VND_INV_NUM                =      VILW_LINE_SUM.VND_INV_NUM
            AND VILW.VND_INV_LINE_SUB_NUM      !=      '000'
            AND VIBW.GLBL_CMPY_CD               =      PD.GLBL_CMPY_CD
            AND VIBW.PO_ORD_NUM                 =      PD.PO_ORD_NUM
<!-- QC#20316(Sol#202) START-->
            AND VIBW.PO_ORD_NUM                 =      PD.PO_ORD_NUM
            AND VILW.PO_ORD_DTL_LINE_NUM        =      PD.PO_ORD_DTL_LINE_NUM
<!-- QC#20316(Sol#202) END-->
            AND VIW.EZCANCELFLAG                =      '0'
            AND VIBW.EZCANCELFLAG               =      '0'
            AND VILW.EZCANCELFLAG               =      '0'
            AND CVB.EZCANCELFLAG(+)             =      '0'
            AND PD.EZCANCELFLAG                 =      '0'
        ) INV_DATE
        ORDER BY
            INV_DATE.AP_VND_CD                ASC
        ,   INV_DATE.AP_VND_INV_NUM           ASC
        ,   INV_DATE.AP_VND_INV_SQ_NUM        ASC
        ,   INV_DATE.VND_REF_NUM              ASC
<!-- QC#20316(Sol#202) START-->
        ,   AP_VND_INV_LINE_NUM      ASC
<!-- QC#20316(Sol#202) END-->
    </statement>

<!-- QC#55051 START -->
    <statement id="SELECT_ERR_RECORD" parameterClass="Map">
        SELECT DISTINCT
            VIW.VND_INV_NUM   VND_INV_NUM
            FROM
                VND_INV_WRK       VIW
            ,   VND_INV_BOL_WRK   VIBW
            ,   VND_INV_LINE_WRK  VILW
            ,   (
                    SELECT
                         PV.GLBL_CMPY_CD    AS GLBL_CMPY_CD
                        ,PV.PRNT_VND_CD     AS PRNT_VND_CD
                        ,V1.VND_CD          AS VND_CD
                        ,V1.SPLY_PMT_FLG    AS SPLY_PMT_FLG
                        ,V1.VND_CD          AS ALT_VND_CD
                    FROM
                         PRNT_VND PV
                        ,VND V1
                    WHERE 
                        PV.GLBL_CMPY_CD = #glblCmpyCd#
                    AND PV.GLBL_CMPY_CD = V1.GLBL_CMPY_CD
                    AND PV.PRNT_VND_PK  = V1.PRNT_VND_PK
                    AND V1.SPLY_PMT_FLG = #splyPmtFlgY#
                    AND PV.EZCANCELFLAG = '0'
                    AND V1.EZCANCELFLAG = '0'
                    UNION ALL
                    SELECT
                         PV.GLBL_CMPY_CD    AS GLBL_CMPY_CD
                        ,PV.PRNT_VND_CD     AS PRNT_VND_CD
                        ,V1.VND_CD          AS VND_CD
                        ,V1.SPLY_PMT_FLG    AS SPLY_PMT_FLG
                        ,MIN(V2.VND_CD)     AS ALT_VND_CD
                    FROM
                         PRNT_VND PV
                        ,VND V1
                        ,VND V2
                    WHERE 
                        PV.GLBL_CMPY_CD     = #glblCmpyCd#
                    AND PV.GLBL_CMPY_CD     = V1.GLBL_CMPY_CD
                    AND PV.GLBL_CMPY_CD     = V2.GLBL_CMPY_CD(+)
                    AND PV.PRNT_VND_PK      = V1.PRNT_VND_PK
                    AND PV.PRNT_VND_PK      = V2.PRNT_VND_PK(+)
                    AND V1.SPLY_PMT_FLG     = #splyPmtFlgN#
                    AND V2.SPLY_PMT_FLG(+)  = #splyPmtFlgY#
                    AND PV.EZCANCELFLAG     = '0'
                    AND V1.EZCANCELFLAG     = '0'
                    AND V2.EZCANCELFLAG(+)  = '0'
                    GROUP BY PV.GLBL_CMPY_CD, PV.PRNT_VND_CD, V1.VND_CD, V1.SPLY_PMT_FLG
                )                 VND
            ,   (
                    SELECT
                        VILW.VND_INV_NUM
                    ,   VILW.VND_INV_BOL_LINE_NUM
                    ,   SUM(VILW.VND_INV_LINE_DEAL_NET_AMT) VND_INV_LINE_DEAL_NET_AMT_SUM
                    ,   COUNT(VILW.GLBL_CMPY_CD)            BOL_GROUP_REC_CNT
                    FROM
                        VND_INV_LINE_WRK VILW
                    WHERE
                        VILW.GLBL_CMPY_CD = #glblCmpyCd#
                    AND VILW.EZCANCELFLAG = '0'
                    AND EXISTS
                            (
                                SELECT
                                    1
                                FROM
                                    VND_INV_WRK VIW
                                WHERE
                                    VIW.GLBL_CMPY_CD               =      VILW.GLBL_CMPY_CD
                                AND VIW.VND_INV_NUM                =      VILW.VND_INV_NUM
                                AND VIW.VND_INV_PROC_STS_CD        =      #vndInvProcStsP#
                                AND (
                                       VIW.CR_DR_RSN_CD            NOT IN
                                       <iterate property="listCrDrRsnCd" var="listCrDrRsnCd[]" open="(" close=")" conjunction=",">
                                           #listCrDrRsnCd[]#
                                       </iterate>
                                    OR VIW.CR_DR_RSN_CD            IS NULL
                                    )
                                AND VIW.CM_PROC_STS_CD             =      #cmProcStsCdN#
                                AND VIW.EZCANCELFLAG               =      '0'
                            )
                    GROUP BY
                        VILW.VND_INV_NUM
                    ,   VILW.VND_INV_BOL_LINE_NUM
                )                 VILW_BOL_SUM
            ,   (
                    SELECT
                        VILW.VND_INV_NUM
                    ,   SUM(VILW.VND_INV_LINE_DEAL_NET_AMT) VND_INV_LINE_DEAL_NET_AMT_SUM
                    ,   COUNT(GLBL_CMPY_CD)                 LINE_GROUP_REC_CNT
                    FROM
                        VND_INV_LINE_WRK VILW
                    WHERE
                        VILW.GLBL_CMPY_CD = #glblCmpyCd#
                    AND VILW.EZCANCELFLAG = '0'
                    AND EXISTS
                            (
                                SELECT
                                    1
                                FROM
                                    VND_INV_WRK VIW
                                WHERE
                                    VIW.GLBL_CMPY_CD               =      VILW.GLBL_CMPY_CD
                                AND VIW.VND_INV_NUM                =      VILW.VND_INV_NUM
                                AND VIW.VND_INV_PROC_STS_CD        =      #vndInvProcStsP#
                                AND (
                                       VIW.CR_DR_RSN_CD            NOT IN
                                       <iterate property="listCrDrRsnCd" var="listCrDrRsnCd[]" open="(" close=")" conjunction=",">
                                           #listCrDrRsnCd[]#
                                       </iterate>
                                    OR VIW.CR_DR_RSN_CD            IS NULL
                                    )
                                AND VIW.CM_PROC_STS_CD             =      #cmProcStsCdN#
                                AND VIW.EZCANCELFLAG               =      '0'
                            )
                    GROUP BY
                        VILW.VND_INV_NUM
                )                 VILW_LINE_SUM
                , PO_DTL PD
            WHERE
                VIW.GLBL_CMPY_CD                =      #glblCmpyCd#
            AND VIW.GLBL_CMPY_CD                =      VIBW.GLBL_CMPY_CD
            AND VIW.GLBL_CMPY_CD                =      VILW.GLBL_CMPY_CD
            AND VIW.GLBL_CMPY_CD                =      VND.GLBL_CMPY_CD(+)
            AND VIBW.GLBL_CMPY_CD               =      VILW.GLBL_CMPY_CD
            AND VIW.VND_INV_NUM                 =      VIBW.VND_INV_NUM
            AND VIBW.VND_INV_NUM                =      VILW.VND_INV_NUM
            AND VIBW.VND_INV_BOL_LINE_NUM       =      VILW.VND_INV_BOL_LINE_NUM
            AND VIW.VND_CD                      =      VND.VND_CD(+)
            AND VIW.VND_INV_PROC_STS_CD         =      #vndInvProcStsP#
            AND (
                    VIW.CR_DR_RSN_CD            NOT IN
                    <iterate property="listCrDrRsnCd" var="listCrDrRsnCd[]" open="(" close=")" conjunction=",">
                        #listCrDrRsnCd[]#
                    </iterate>
                OR VIW.CR_DR_RSN_CD             IS NULL
                )
            AND VIW.CM_PROC_STS_CD              =      #cmProcStsCdN#
            AND VILW.VND_INV_NUM                =      VILW_BOL_SUM.VND_INV_NUM
            AND VILW.VND_INV_BOL_LINE_NUM       =      VILW_BOL_SUM.VND_INV_BOL_LINE_NUM
            AND VILW.VND_INV_NUM                =      VILW_LINE_SUM.VND_INV_NUM
            AND VILW.VND_INV_LINE_SUB_NUM      !=      '000'
            AND VIBW.GLBL_CMPY_CD               =      PD.GLBL_CMPY_CD
            AND VIBW.PO_ORD_NUM                 =      PD.PO_ORD_NUM
            AND VIBW.PO_ORD_NUM                 =      PD.PO_ORD_NUM
            AND VILW.PO_ORD_DTL_LINE_NUM        =      PD.PO_ORD_DTL_LINE_NUM
            AND VIW.EZCANCELFLAG                =      '0'
            AND VIBW.EZCANCELFLAG               =      '0'
            AND VILW.EZCANCELFLAG               =      '0'
            AND PD.EZCANCELFLAG                 =      '0'
            AND EXISTS(
                       SELECT 1 
                       FROM CM_AP_INV_HDR CAIH 
                       WHERE CAIH.GLBL_CMPY_CD = VIW.GLBL_CMPY_CD 
                       AND CAIH.EZCANCELFLAG   = '0' 
                       AND CAIH.AP_VND_INV_NUM = VIW.VND_INV_NUM
                       AND CAIH.AP_VND_CD      = (CASE WHEN VND.SPLY_PMT_FLG = #splyPmtFlgN# AND VND.ALT_VND_CD IS NOT NULL THEN VND.ALT_VND_CD
                                                      ELSE VIW.VND_CD
                                                  END)
                      )
    </statement>
<!-- QC#55051 END -->

    <statement id="SELECT_DELETE_RECORDS" parameterClass="Map">
        SELECT 
            GLBL_CMPY_CD
        ,   AP_VND_CD
        ,   AP_VND_INV_NUM
        ,   AP_VND_INV_SQ_NUM
        FROM 
            CM_AP_INV_HDR CAIH
        WHERE
            GLBL_CMPY_CD       = #glblCmpyCd#
        AND EZCANCELFLAG       = '0'
        AND VND_INV_IMPT_TP_CD = #vndInvImptTpCd#
        AND NOT EXISTS 
                   (
                     SELECT 1
                     FROM CM_AP_INV_DTL CAID
                     WHERE 
                         CAID.GLBL_CMPY_CD      = #glblCmpyCd#
                     AND CAID.EZCANCELFLAG      = '0'
                     AND CAID.AP_INV_AUTH_FLG   = 'Y'
                     AND CAIH.AP_VND_CD         = CAID.AP_VND_CD
                     AND CAIH.AP_VND_INV_NUM    = CAID.AP_VND_INV_NUM
                     AND CAIH.AP_VND_INV_SQ_NUM = CAID.AP_VND_INV_SQ_NUM
                   )
        MINUS
<!-- QC#28099 START -->
        SELECT
            VIW.GLBL_CMPY_CD                                                            AS GLBL_CMPY_CD
        ,   DECODE(VND.SPLY_PMT_FLG, 'N', NVL(VND.ALT_VND_CD, VIW.VND_CD), VIW.VND_CD)  AS VND_CD
        ,   VIW.VND_INV_NUM                                                             AS VND_INV_NUM
        ,   #apVndInvSqNum#                                                             AS AP_VND_INV_SQ_NUM
        FROM VND_INV_WRK VIW
        ,   (
                SELECT
                     PV.GLBL_CMPY_CD    AS GLBL_CMPY_CD
                    ,PV.PRNT_VND_CD     AS PRNT_VND_CD
                    ,V1.VND_CD          AS VND_CD
                    ,V1.SPLY_PMT_FLG    AS SPLY_PMT_FLG
                    ,V1.VND_CD          AS ALT_VND_CD
                FROM
                     PRNT_VND PV
                    ,VND V1
                WHERE 
                    PV.GLBL_CMPY_CD = #glblCmpyCd#
                AND PV.GLBL_CMPY_CD = V1.GLBL_CMPY_CD
                AND PV.PRNT_VND_PK  = V1.PRNT_VND_PK
                AND V1.SPLY_PMT_FLG = #splyPmtFlgY#
                AND PV.EZCANCELFLAG = '0'
                AND V1.EZCANCELFLAG = '0'
                UNION ALL
                SELECT
                     PV.GLBL_CMPY_CD    AS GLBL_CMPY_CD
                    ,PV.PRNT_VND_CD     AS PRNT_VND_CD
                    ,V1.VND_CD          AS VND_CD
                    ,V1.SPLY_PMT_FLG    AS SPLY_PMT_FLG
                    ,MIN(V2.VND_CD)     AS ALT_VND_CD
                FROM
                     PRNT_VND PV
                    ,VND V1
                    ,VND V2
                WHERE 
                    PV.GLBL_CMPY_CD     = #glblCmpyCd#
                AND PV.GLBL_CMPY_CD     = V1.GLBL_CMPY_CD
                AND PV.GLBL_CMPY_CD     = V2.GLBL_CMPY_CD(+)
                AND PV.PRNT_VND_PK      = V1.PRNT_VND_PK
                AND PV.PRNT_VND_PK      = V2.PRNT_VND_PK(+)
                AND V1.SPLY_PMT_FLG     = #splyPmtFlgN#
                AND V2.SPLY_PMT_FLG(+)  = #splyPmtFlgY#
                AND PV.EZCANCELFLAG     = '0'
                AND V1.EZCANCELFLAG     = '0'
                AND V2.EZCANCELFLAG(+)  = '0'
                GROUP BY PV.GLBL_CMPY_CD, PV.PRNT_VND_CD, V1.VND_CD, V1.SPLY_PMT_FLG
            ) VND
        WHERE
            VIW.GLBL_CMPY_CD       = #glblCmpyCd#
        AND VIW.VND_CD             = VND.VND_CD(+)
<!-- QC#28099 END -->
    </statement>

</sqlMap>
