<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NPAB090001">
    <statement id="getAckData" parameterClass="Map" resultClass="Map">
        SELECT
            CASE
                WHEN PAD.VND_INVTY_LOC_CD IN    <iterate property="cusaPartsWHList" var="cusaPartsWH[]" open="(" close=")" conjunction=",">
                    #cusaPartsWH[]#
                </iterate>
                THEN '1'
                ELSE '2'
            END AS PRC_CD
            ,'01' AS WMS_REC_HDR_ID
            ,'MNX' AS TPL_FROM_PTNR_ID
            ,'OCE' AS TPL_TO_PTNR_ID
            ,PAD.VND_SO_NUM AS ORD_ID_TXT
            ,TCSL.TPL_CARR_CD AS TPL_CARR_CD
            ,TCSL.TPL_CARR_NM AS TPL_CARR_NM
            ,TCSL.TPL_SVC_LVL_CD AS TPL_SVC_LVL_CD
            ,TCSL.TPL_SVC_LVL_NM AS TPL_SVC_LVL_NM
            ,TCSL.TPL_SPCL_SVC_NM AS TPL_SPCL_SVC_NM
            ,'OCE' AS TPL_ACCT_CD
            ,PD.SHIP_TO_LOC_NM || ' ' || PD.SHIP_TO_ADDL_LOC_NM AS SHIP_NM_ALL_TXT
            ,PD.SHIP_TO_FIRST_LINE_ADDR  || ' ' || PD.SHIP_TO_SCD_LINE_ADDR || ' ' || PD.SHIP_TO_THIRD_LINE_ADDR  || ' ' || PD.SHIP_TO_FRTH_LINE_ADDR AS SHIP_ADDR_ALL_TXT
            ,PD.SHIP_TO_CTY_ADDR AS SHIP_CTY_TXT
            ,PD.SHIP_TO_ST_CD AS SHIP_ST_TXT
            ,PD.SHIP_TO_POST_CD AS SHIP_POST_TXT
            ,PD.SHIP_TO_CTRY_CD AS SHIP_CTRY_TXT
            ,NVL(PR.CTAC_PSN_NM, DEST_RW.RTL_WH_NM) AS SHIP_CTAC_NM_TXT
            ,NVL(DEST_RW.TEL_NUM, TM.TEL_NUM) AS SHIP_PHO_NUM_TXT
            ,PR.DELY_ADDL_CMNT_TXT AS ORD_CMNT_ALL_TXT
            ,SUM(PAD.ORD_QTY) OVER(PARTITION BY PAD.VND_SO_NUM ORDER BY PAD.VND_SO_NUM) AS ORIG_ORD_QTY_TXT
            ,PRD.DEST_RTL_WH_CD AS SHIP_TO_CUST_CD
            ,#svcTpTxt# AS SVC_TP_TXT
            ,#shipFromNmAll# AS SHIP_FROM_NM_ALL_TXT
            ,#shipFromAddrAll# AS SHIP_FROM_ADDR_ALL_TXT
            ,#shipFromCty# AS SHIP_FROM_CTY_TXT
            ,#shipFromSt# AS SHIP_FROM_ST_TXT
            ,#shipFromPost# AS SHIP_FROM_POST_TXT
            ,#shipFromCtry# AS SHIP_FROM_CTRY_TXT
            ,#shipFromCtacNm# AS SHIP_FROM_CTAC_NM
            ,#shipFromPhoNum# AS SHIP_FROM_PHO_NUM
            ,#shipFromCmntAll# AS SHIP_FROM_CMNT_ALL_TXT
            ,'02' AS WMS_REC_DTL_ID
            ,PAD.ORD_QTY AS QTY_ORD_TXT   ,PAD.VND_MDSE_CD AS ITEM_CD_TXT
            ,ROW_NUMBER() OVER(PARTITION BY PAD.VND_SO_NUM ORDER BY PAD.VND_SO_NUM, PRD.PRCH_REQ_LINE_NUM) ORD_LINE_TXT
            ,PR.RQST_TECH_TOC_CD
            ,PR.PRCH_REQ_NUM
            ,PR.PRCH_REQ_TP_CD
            ,PRD.PRCH_REQ_LINE_NUM
            ,PAD.VND_SO_NUM
            ,PAD.MDSE_CD
            ,PAD.VND_MDSE_CD
            ,PAD.ORD_QTY
            ,PAD.ETA_DT
            ,PR.FSR_NUM
            ,PR.SVC_TASK_NUM
            ,PR.SVC_MACH_SER_NUM
            ,PAD.VND_INVTY_LOC_CD   
            ,PAH.EZINTIME
            ,PD.CARR_CD AS PO_CARR_CD
            ,PD.SHPG_SVC_LVL_CD  AS PO_SHPG_SVC_LVL_CD
        FROM
            PO_ACK_HDR   PAH
            ,PO_ACK_DTL   PAD
            ,PO_DTL       PD
            ,PO           PO
            ,PRCH_REQ_DTL PRD
            ,PRCH_REQ     PR
            ,TPL_CARR_SVC_LVL TCSL
            ,TECH_MSTR TM
            ,S21_PSN  PSN
            ,RTL_WH   RW
            ,RTL_WH   DEST_RW
        WHERE
            PAH.GLBL_CMPY_CD = #glblCmpyCd#
            AND PAH.EZINTIME     &gt; #targetTime#
            AND PAH.ITRL_INTFC_ID = #cusaPartsIntfcId#
            AND PAH.GLBL_CMPY_CD = PAD.GLBL_CMPY_CD
            AND PAH.PO_ACK_HDR_PK = PAD.PO_ACK_HDR_PK
            <iterate property="ackLineStsCds" var="ackLineStsCds[]" open="AND PAD.PO_ACK_LINE_STS_CD IN (" close=")" conjunction=",">
                #ackLineStsCds[]#
            </iterate>
            AND PAD.GLBL_CMPY_CD = PD.GLBL_CMPY_CD
            AND PAD.PO_ORD_NUM = PD.PO_ORD_NUM
            AND PAD.PO_ORD_DTL_LINE_NUM = PD.PO_ORD_DTL_LINE_NUM
            AND PD.GLBL_CMPY_CD = PO.GLBL_CMPY_CD
            AND PD.PO_ORD_NUM = PO.PO_ORD_NUM
            AND PO.PO_ORD_SRC_CD = #insourcing#
            AND PD.GLBL_CMPY_CD = PRD.GLBL_CMPY_CD
            AND PD.TRX_REF_NUM = PRD.PRCH_REQ_NUM
            AND PD.TRX_REF_LINE_NUM = PRD.PRCH_REQ_LINE_NUM
            AND PD.TRX_REF_LINE_SUB_NUM = PRD.PRCH_REQ_LINE_SUB_NUM
            AND PRD.GLBL_CMPY_CD = PR.GLBL_CMPY_CD
            AND PRD.PRCH_REQ_NUM = PR.PRCH_REQ_NUM
            AND PR.PRCH_REQ_TP_CD = #premiumRush#
            AND PD.GLBL_CMPY_CD = TCSL.GLBL_CMPY_CD(+)
            AND PD.CARR_CD = TCSL.CARR_CD(+)
            AND PD.SHPG_SVC_LVL_CD = TCSL.SHPG_SVC_LVL_CD(+)
            AND PR.GLBL_CMPY_CD = RW.GLBL_CMPY_CD(+)
            AND PR.RQST_TECH_TOC_CD = RW.RTL_WH_CD(+)
            AND TCSL.WH_OWNR_CD(+) = #whOwnrMNX#
            AND PR.GLBL_CMPY_CD = TM.GLBL_CMPY_CD(+)
            AND PR.RQST_TECH_TOC_CD = TM.TECH_TOC_CD(+)
            AND TM.GLBL_CMPY_CD       =  PSN.GLBL_CMPY_CD(+)
            AND TM.TECH_TOC_CD        =  PSN.PSN_CD(+)
            AND TM.GLBL_CMPY_CD       =  RW.GLBL_CMPY_CD(+)
            AND TM.TECH_TOC_CD        =  RW.RTL_WH_CD(+)
            AND PO.GLBL_CMPY_CD       =  DEST_RW.GLBL_CMPY_CD(+)
            AND PO.DEST_RTL_WH_CD     =  DEST_RW.RTL_WH_CD(+)
            AND PAH.EZCANCELFLAG = '0'
            AND PAD.EZCANCELFLAG = '0'
            AND PO.EZCANCELFLAG = '0'
            AND PD.EZCANCELFLAG = '0'
            AND PR.EZCANCELFLAG = '0'
            AND PRD.EZCANCELFLAG = '0'
            AND TCSL.EZCANCELFLAG(+) = '0'
            AND TM.EZCANCELFLAG = '0'
            AND PSN.EZCANCELFLAG = '0'
            AND RW.EZCANCELFLAG(+) = '0'
            AND DEST_RW.EZCANCELFLAG(+) = '0'
        ORDER BY
             PRC_CD, VND_INVTY_LOC_CD, VND_SO_NUM, PRCH_REQ_LINE_NUM
        
    </statement>
    
    <statement id="getIfData" parameterClass="Map" resultClass="Map">
        SELECT
            H.TPL_FROM_PTNR_ID
            ,H.TPL_TO_PTNR_ID
            ,H.REQ_DT_TM_TS_TXT
            ,H.ORD_ID_TXT
            ,H.CARR_CD
            ,H.SHPG_SVC_LVL_CD
            ,H.TPL_ACCT_TXT 
            ,H.TPL_LOC_TXT 
            ,H.SHIP_NM_ALL_TXT
            ,H.SHIP_ADDR_ALL_TXT
            ,H.SHIP_CTY_TXT
            ,H.SHIP_ST_TXT
            ,H.SHIP_POST_TXT
            ,H.SHIP_CTRY_TXT
            ,H.SHIP_CTAC_NM_TXT
            ,H.SHIP_PHO_NUM_TXT
            ,H.ORD_CMNT_ALL_TXT
            ,H.ORIG_ORD_QTY_TXT
            ,H.SHIP_TO_CUST_CD
            ,H.SVC_TP_TXT
            ,H.SHIP_FROM_NM_ALL_TXT
            ,H.SHIP_FROM_ADDR_ALL_TXT
            ,H.SHIP_FROM_CTY_TXT
            ,H.SHIP_FROM_ST_TXT
            ,H.SHIP_FROM_POST_TXT
            ,H.SHIP_FROM_CTRY_TXT
            ,H.SHIP_FROM_CTAC_NM
            ,H.SHIP_FROM_PHO_NUM
            ,H.SHIP_FROM_CMNT_ALL_TXT
            ,H.TPL_CARR_NM
            ,H.TPL_SVC_LVL_NM
            ,H.TPL_SPCL_SVC_NM
            <!-- START 2021/01/26 A.Marte [QC#58281,ADD] -->
            ,H.SEGMENT_ID
            <!-- START 2021/01/26 A.Marte [QC#58281,ADD] -->
         FROM
             NLBI1410_01 H
         WHERE
             H.INTERFACE_ID = #interfaceId#
             AND H.TRANSACTION_ID = #transactionId#
             AND H.TPL_LOC_TXT IS NULL
             AND H.EZCANCELFLAG = '0'
         ORDER BY
             H.ORD_ID_TXT, H.TPL_LOC_TXT
    
    </statement>

    <statement id="getTplCarrSvcLvl" parameterClass="Map" resultClass="Map">
        SELECT
            *
        FROM (
            SELECT
                TC.TPL_CARR_CD
                ,TC.TPL_SVC_LVL_CD
                ,TC.TPL_CARR_NM
                ,TC.TPL_SVC_LVL_NM
                ,TC.TPL_SPCL_SVC_NM
            FROM
                TPL_CARR_SVC_LVL TC
            WHERE
                TC.GLBL_CMPY_CD         = #GLBL_CMPY_CD#
            AND TC.WH_OWNR_CD           = #WH_OWNR_CD#
        <isNotNull property="CARR_CD">
            AND TC.CARR_CD              = #CARR_CD#
        </isNotNull>
        <isNull property="CARR_CD">
            AND TC.CARR_CD              IS NULL
        </isNull>
        <isNotNull property="SHPG_SVC_LVL_CD">
            AND TC.SHPG_SVC_LVL_CD      = #SHPG_SVC_LVL_CD#
        </isNotNull>
        <isNull property="SHPG_SVC_LVL_CD">
            AND TC.SHPG_SVC_LVL_CD      IS NULL
        </isNull>
            AND TC.EZCANCELFLAG         = '0'
            ORDER BY
                TC.TPL_CARR_SVC_LVL_SORT_NUM
        )
        WHERE
            ROWNUM&lt;=1
    </statement>

    <statement id="getMnxErrCond" parameterClass="Map" resultClass="Map">
        SELECT
            DCC.DS_COND_CONST_VAL_TXT_01   AS ML_TP
           ,DCC.DS_COND_CONST_VAL_TXT_02   AS FL_ABEND
        FROM
            DS_COND_CONST   DCC
        WHERE
            DCC.GLBL_CMPY_CD                = #GLBL_CMPY_CD#
        AND DCC.DS_COND_CONST_GRP_ID        = #DS_COND_CONST_GRP_ID#
        AND DCC.DS_COND_CONST_CD            = #DS_COND_CONST_CD#
        AND DCC.EZCANCELFLAG                = '0'
    </statement>

    <statement id="chkRegistIf" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            COUNT(H.TRANSACTION_ID) AS CNT
        FROM
            NLBI1410_01 H
        WHERE
            H.INTERFACE_ID = #interfaceId#
        AND H.ORD_ID_TXT = #ordIdTxt#
        AND H.TPL_LOC_TXT IS NULL
        AND H.EZCANCELFLAG = '0'
    </statement>

</sqlMap>