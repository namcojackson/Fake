<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSZC115001">

    <typeAlias alias="CPO_DTLTMsg" type="business.db.CPO_DTLTMsg" />

    <statement id="getMdlIdByCpoDtl" parameterClass="CPO_DTLTMsg" resultClass="Map">
        SELECT
             DCD.CPO_ORD_NUM
            <!-- QC#50174 MOD Start -->
            <!-- ,DCC.MDL_ID -->
            ,(CASE
                WHEN C.ORD_BOOK_FLG = 'Y'
                    THEN NVL(CD.MDL_ID, DCC.MDL_ID)
                ELSE
                    DCC.MDL_ID
              END
             ) AS MDL_ID
            <!-- QC#50174 ADD End -->
            ,DCC.SVC_CONFIG_MSTR_PK
        FROM
             CPO_DTL       DCD
            ,DS_CPO_CONFIG DCC
            <!-- QC#50174 ADD Start -->
            ,CPO           C
            ,DS_CONTR_DTL  CD
            <!-- QC#50174 ADD End -->
        WHERE
                 DCD.GLBL_CMPY_CD         = #glblCmpyCd#
             AND DCD.CPO_ORD_NUM          = #cpoOrdNum#
             AND DCD.CPO_DTL_LINE_NUM     = #cpoDtlLineNum#
             AND DCD.CPO_DTL_LINE_SUB_NUM = #cpoDtlLineSubNum#
             AND DCD.EZCANCELFLAG         = '0'
             <!-- QC#50174 ADD Start -->
             AND DCD.GLBL_CMPY_CD         = C.GLBL_CMPY_CD
             AND DCD.CPO_ORD_NUM          = C.CPO_ORD_NUM
             AND C.EZCANCELFLAG           = '0'
             <!-- QC#50174 ADD End -->
             AND DCD.GLBL_CMPY_CD         = DCC.GLBL_CMPY_CD(+)
             AND DCD.DS_CPO_CONFIG_PK     = DCC.DS_CPO_CONFIG_PK(+)
             AND DCC.EZCANCELFLAG(+)      = '0'
             <!-- QC#50174 ADD Start -->
             AND DCD.GLBL_CMPY_CD         = CD.GLBL_CMPY_CD(+)
             AND DCD.CPO_ORD_NUM          = CD.CPO_ORD_NUM(+)
             AND DCD.CPO_DTL_LINE_NUM     = CD.CPO_DTL_LINE_NUM(+)
             AND DCD.CPO_DTL_LINE_SUB_NUM = CD.CPO_DTL_LINE_SUB_NUM(+)
             AND CD.EZCANCELFLAG(+)       = '0'
             <!-- QC#50174 ADD End -->
    </statement>

    <!-- QC#50174 ADD Start -->
    <statement id="getMdlIdByDsContrDtl" parameterClass="CPO_DTLTMsg" resultClass="Map">
        SELECT
             DCD.CPO_ORD_NUM
            ,DCD.MDL_ID
            ,DCD.SVC_CONFIG_MSTR_PK
        FROM
             DS_CONTR_DTL       DCD
        WHERE
                 DCD.GLBL_CMPY_CD         = #glblCmpyCd#
             AND DCD.CPO_ORD_NUM          = #cpoOrdNum#
             AND DCD.CPO_DTL_LINE_NUM     = #cpoDtlLineNum#
             AND DCD.CPO_DTL_LINE_SUB_NUM = #cpoDtlLineSubNum#
             AND DCD.EZCANCELFLAG         = '0'
    </statement>
    <!-- QC#50174 ADD End -->

    <statement id="getMtrLbByBllgMtr" parameterClass="Map" resultClass="String">
        SELECT DISTINCT
                  MS.BLLG_MTR_LB_CD
            FROM
                PRC_MTR_PKG_MTR_STRU_V MS
            WHERE
                MS.GLBL_CMPY_CD                     = #glblCmpyCd#
                AND MS.PRC_MTR_PKG_PK               = #prcMtrPkgPk#
                AND MS.MDL_ID                       = #mdlId#
                AND MS.ACTV_FLG                     = 'Y'
                AND MS.BLLBL_FLG                    = 'Y'
                AND MS.MDL_MTR_EFF_FROM_DT          &lt;= #slsDt#
                AND ( 
                    MS.MDL_MTR_EFF_THRU_DT          &gt;= #slsDt#
                    OR MS.MDL_MTR_EFF_THRU_DT       IS NULL
                ) 
                AND MS.BLLG_MTR_MAP_EFF_FROM_DT     &lt;= #slsDt#
                AND ( 
                    MS.BLLG_MTR_MAP_EFF_THRU_DT     &gt;= #slsDt#
                    OR MS.BLLG_MTR_MAP_EFF_THRU_DT  IS NULL
                ) 
                AND MS.MTR_PKG_EFF_FROM_DT          &lt;= #slsDt#
                AND ( 
                    MS.MTR_PKG_EFF_THRU_DT          &gt;= #slsDt#
                    OR MS.MTR_PKG_EFF_THRU_DT       IS NULL
                ) 
                AND MS.MTR_PKG_MDL_EFF_FROM_DT      &lt;= #slsDt#
                AND ( 
                    MS.MTR_PKG_MDL_EFF_THRU_DT      &gt;= #slsDt#
                    OR MS.MTR_PKG_MDL_EFF_THRU_DT   IS NULL
                )
    </statement>

    <statement id="getMtrLbByBllgMtrForFleet" parameterClass="Map" resultClass="String">
        SELECT DISTINCT
                  MS.BLLG_MTR_LB_CD
            FROM
                PRC_MTR_PKG_MTR_STRU_V MS
            WHERE
                MS.GLBL_CMPY_CD                     = #glblCmpyCd#
              <iterate property="mdlIdList" var="mdlId[]" open="AND MS.MDL_ID IN (" close=")"  conjunction=",">
                #mdlId[]#
              </iterate>
                AND MS.PRC_MTR_PKG_PK               = #prcMtrPkgPk#
                AND MS.ACTV_FLG                     = 'Y'
                AND MS.BLLBL_FLG                    = 'Y'
                AND MS.BLLG_MTR_LB_CD              IS NOT NULL <!-- QC#29248 -->
                AND MS.MDL_MTR_EFF_FROM_DT          &lt;= #slsDt#
                AND ( 
                    MS.MDL_MTR_EFF_THRU_DT          &gt;= #slsDt#
                    OR MS.MDL_MTR_EFF_THRU_DT       IS NULL
                ) 
                AND MS.BLLG_MTR_MAP_EFF_FROM_DT     &lt;= #slsDt#
                AND ( 
                    MS.BLLG_MTR_MAP_EFF_THRU_DT     &gt;= #slsDt#
                    OR MS.BLLG_MTR_MAP_EFF_THRU_DT  IS NULL
                ) 
                AND MS.MTR_PKG_EFF_FROM_DT          &lt;= #slsDt#
                AND ( 
                    MS.MTR_PKG_EFF_THRU_DT          &gt;= #slsDt#
                    OR MS.MTR_PKG_EFF_THRU_DT       IS NULL
                ) 
                AND MS.MTR_PKG_MDL_EFF_FROM_DT      &lt;= #slsDt#
                AND ( 
                    MS.MTR_PKG_MDL_EFF_THRU_DT      &gt;= #slsDt#
                    OR MS.MTR_PKG_MDL_EFF_THRU_DT   IS NULL
                )
    </statement>

    <statement id="getPrcgApiParams" parameterClass="Map" resultClass="Map">
        WITH
            DS_CONTR_DTL_V AS (
                SELECT
                    DC.GLBL_CMPY_CD
                   ,DC.DS_CONTR_PK
                   ,DCD.SHELL_LINE_NUM
                   ,DC.SVC_PGM_MDSE_CD
                   ,DC.ALT_PAYER_CUST_CD
                   ,DC.BILL_BY_TP_CD
                   ,DC.DS_ACCT_NUM
                   ,DCD.DS_CONTR_DTL_PK
                   ,NULL                             AS DS_CONTR_ADDL_CHRG_PK
                   ,DCD.CPO_ORD_NUM
                   ,DCD.CPO_DTL_LINE_NUM
                   ,DCD.CPO_DTL_LINE_SUB_NUM
                   ,(SELECT
                         PC.CCY_CD
                     FROM
                         PRC_CATG PC
                     WHERE
                             PC.GLBL_CMPY_CD  = DCD.GLBL_CMPY_CD
                         AND PC.PRC_CATG_CD   = DCD.PRC_CATG_CD
                         AND PC.EZCANCELFLAG  = '0') AS CCY_CD
                    ,DCD.PRC_CATG_CD
<!-- START 2017/12/27 U.Kim [QC#23104, MOD] -->
<!--                ,DCD.BASE_PRC_DEAL_AMT * (DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT  AS AUTO_PRC_AMT_RATE -->
<!--                ,DCD.BASE_PRC_DEAL_AMT * (DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT  AS CALC_PRC_AMT_RATE -->
<!--                ,DCD.BASE_PRC_DEAL_AMT * (DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT  AS UNIT_PRC_AMT -->
                    ,ROUND((DCD.BASE_PRC_DEAL_AMT * ROUND(((DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT),#aftDeclPntDigitNum#)), #aftDeclPntDigitNum#)  AS AUTO_PRC_AMT_RATE
                    ,ROUND((DCD.BASE_PRC_DEAL_AMT * ROUND(((DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT),#aftDeclPntDigitNum#)), #aftDeclPntDigitNum#)  AS CALC_PRC_AMT_RATE
                    ,ROUND((DCD.BASE_PRC_DEAL_AMT * ROUND(((DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT),#aftDeclPntDigitNum#)), #aftDeclPntDigitNum#)  AS UNIT_PRC_AMT
<!-- END 2017/12/27 U.Kim [QC#23104, MOD] -->
                    , DCD.BILL_WITH_EQUIP_FLG   <!-- QC#26467 -->
                FROM
                     DS_CONTR_DTL    DCD
                    ,DS_CONTR_DTL_TP DCDT
                    ,DS_CONTR        DC
                    ,BLLG_CYCLE      BC
                WHERE
                        DCD.GLBL_CMPY_CD       = #glblCmpyCd#
                    AND DCD.CPO_ORD_NUM        = #cpoOrdNum#
                    AND DCD.SHELL_LINE_NUM     = #shellLineNum#
                    AND DCD.DS_CONTR_DTL_TP_CD &lt;&gt; #dsContrDtlTpCd_Aggregate#
                    AND DCD.EZCANCELFLAG       = '0'
                    AND DCD.GLBL_CMPY_CD       = DCDT.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_TP_CD = DCDT.DS_CONTR_DTL_TP_CD
                    AND DCDT.BASE_CHRG_FLG     = 'Y'
                    AND DCDT.EZCANCELFLAG      = '0'
                    AND DCD.GLBL_CMPY_CD       = DC.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_PK        = DC.DS_CONTR_PK
                    AND DC.EZCANCELFLAG        = '0'
                    AND DC.GLBL_CMPY_CD        = BC.GLBL_CMPY_CD
                    AND DC.BASE_BLLG_CYCLE_CD  = BC.BLLG_CYCLE_CD
                    AND BC.EZCANCELFLAG        = '0'
            )
            ,DS_CONTR_ADDL_CHRG_V AS (
                SELECT
                    DC.GLBL_CMPY_CD
                   ,DC.DS_CONTR_PK
                   ,DCD.SHELL_LINE_NUM
                   ,DC.SVC_PGM_MDSE_CD
                   ,DC.ALT_PAYER_CUST_CD
                   ,DC.BILL_BY_TP_CD
                   ,DC.DS_ACCT_NUM
                   ,NULL                            AS DS_CONTR_DTL_PK
                   ,DCAC.DS_CONTR_ADDL_CHRG_PK
                   ,DCD.CPO_ORD_NUM
                   ,DCD.CPO_DTL_LINE_NUM
                   ,DCD.CPO_DTL_LINE_SUB_NUM
                   ,(SELECT
                         PC.CCY_CD
                     FROM
                         PRC_CATG PC
                     WHERE
                             PC.GLBL_CMPY_CD  = DCAC.GLBL_CMPY_CD
                         AND PC.PRC_CATG_CD   = DCAC.PRC_CATG_CD
                         AND PC.EZCANCELFLAG  = '0') AS CCY_CD
                    ,DCAC.PRC_CATG_CD
<!-- START 2017/12/27 U.Kim [QC#23104, MOD] -->
<!--                ,DCAC.ADDL_CHRG_FLAT_DEAL_PRC_AMT * (DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT  AS AUTO_PRC_AMT_RATE -->
<!--                ,DCAC.ADDL_CHRG_FLAT_DEAL_PRC_AMT * (DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT  AS CALC_PRC_AMT_RATE -->
<!--                ,DCAC.ADDL_CHRG_FLAT_DEAL_PRC_AMT * (DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT  AS UNIT_PRC_AMT -->
                    ,ROUND((DCAC.ADDL_CHRG_FLAT_DEAL_PRC_AMT * ROUND(((DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT),#aftDeclPntDigitNum#)), #aftDeclPntDigitNum#)  AS AUTO_PRC_AMT_RATE
                    ,ROUND((DCAC.ADDL_CHRG_FLAT_DEAL_PRC_AMT * ROUND(((DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT),#aftDeclPntDigitNum#)), #aftDeclPntDigitNum#)  AS CALC_PRC_AMT_RATE
                    ,ROUND((DCAC.ADDL_CHRG_FLAT_DEAL_PRC_AMT * ROUND(((DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT),#aftDeclPntDigitNum#)), #aftDeclPntDigitNum#)  AS UNIT_PRC_AMT
<!-- END 2017/12/27 U.Kim [QC#23104, MOD] -->
                    , DCD.BILL_WITH_EQUIP_FLG   <!-- QC#26467 -->
                FROM
                     DS_CONTR_DTL       DCD
                    ,DS_CONTR_ADDL_CHRG DCAC
                    ,DS_CONTR           DC
                    ,BLLG_CYCLE         BC
                WHERE
                        DCD.GLBL_CMPY_CD       = #glblCmpyCd#
                    AND DCD.CPO_ORD_NUM        = #cpoOrdNum#
                    AND DCD.SHELL_LINE_NUM     = #shellLineNum#
                    AND DCD.EZCANCELFLAG       = '0'
                    AND DCD.GLBL_CMPY_CD       = DCAC.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK    = DCAC.DS_CONTR_DTL_PK
                    AND DCAC.ADDL_CHRG_CATG_CD IN (#addlChrgCatgcd_Rental#, #addlChrgCatgcd_Normal#)
                    AND DCAC.EZCANCELFLAG      = '0'
                    AND DCD.GLBL_CMPY_CD       = DC.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_PK        = DC.DS_CONTR_PK
                    AND DC.EZCANCELFLAG        = '0'
                    AND DC.GLBL_CMPY_CD        = BC.GLBL_CMPY_CD
                    AND DC.BASE_BLLG_CYCLE_CD  = BC.BLLG_CYCLE_CD
                    AND BC.EZCANCELFLAG        = '0'
            )
           ,VDS_CPO_DTL_V AS (
               SELECT
                  *
               FROM
                   DS_CONTR_DTL_V CSP
               UNION ALL
               SELECT
                  *
               FROM
                   DS_CONTR_ADDL_CHRG_V CSBP
            )
        SELECT
            DCD.DS_CONTR_PK
            ,DCD.SHELL_LINE_NUM
            ,DCD.DS_CONTR_DTL_PK
            ,DCD.DS_CONTR_ADDL_CHRG_PK
            ,DCD.CPO_ORD_NUM
            ,DCD.CPO_DTL_LINE_NUM
            ,DCD.CPO_DTL_LINE_SUB_NUM
            ,OPD.LINE_BIZ_TP_CD                   AS LINE_BIZ_TP_CD
            ,C.SELL_TO_CUST_CD                    AS DS_ACCT_NUM
            ,C.LEASE_PRCH_OPT_CD                  AS LEASE_PRCH_OPT_CD
            ,CASE
                WHEN DCD.BILL_WITH_EQUIP_FLG = 'Y' <!-- QC#26467 -->
                    THEN DCC.BILL_TO_CUST_LOC_CD
                WHEN
                        DCC.BILL_TO_CUST_LOC_CD &lt;&gt; DCD.ALT_PAYER_CUST_CD
                    AND EXISTS(
                            SELECT
                                *
                            FROM
                                BILL_BY_TP BT
                            WHERE
                                    BT.GLBL_CMPY_CD        = DCD.GLBL_CMPY_CD
                                AND BT.BILL_BY_TP_CD       = DCD.BILL_BY_TP_CD
                                AND BT.USE_SVC_BILL_TO_FLG = 'Y'
                                AND BT.EZCANCELFLAG        = '0'
                        ) THEN DCD.ALT_PAYER_CUST_CD
                ELSE
                    DCC.BILL_TO_CUST_LOC_CD
             END                                  AS BILL_TO_CUST_CD
            ,DCC.SHIP_TO_CUST_LOC_CD              AS SHIP_TO_CUST_CD
            ,DCC.SHIP_TO_CUST_ACCT_CD             AS DS_ACCT_NUM_SH
            ,CASE
                WHEN DCD.BILL_WITH_EQUIP_FLG = 'Y' <!-- QC#26467 -->
                    THEN DCC.BILL_TO_CUST_ACCT_CD
                WHEN
                         DCC.BILL_TO_CUST_LOC_CD &lt;&gt; DCD.ALT_PAYER_CUST_CD
                    AND EXISTS(
                            SELECT
                                *
                            FROM
                                BILL_BY_TP BT
                            WHERE
                                    BT.GLBL_CMPY_CD        = DCD.GLBL_CMPY_CD
                                AND BT.BILL_BY_TP_CD       = DCD.BILL_BY_TP_CD
                                AND BT.USE_SVC_BILL_TO_FLG = 'Y'
                                AND BT.EZCANCELFLAG        = '0'
                        ) THEN DCD.DS_ACCT_NUM
                ELSE
                    DCC.BILL_TO_CUST_ACCT_CD
                    END                          AS DS_ACCT_NUM_BL
            ,DCD.CCY_CD
            ,DCD.SVC_PGM_MDSE_CD                  AS MDSE_CD
            ,(SELECT
                  PUC.BASE_PKG_UOM_CD
              FROM
                  PKG_UOM_CLS PUC
              WHERE
                      PUC.GLBL_CMPY_CD   = AMV.GLBL_CMPY_CD
                  AND PUC.PKG_UOM_CLS_CD = AMV.PKG_UOM_CLS_CD
                  AND PUC.EZCANCELFLAG   = '0')   AS PKG_UOM_CD
            ,SC.FIRST_LINE_ADDR                   AS FIRST_LINE_ADDR_SH
            ,SC.SCD_LINE_ADDR                     AS SCD_LINE_ADDR_SH
            ,SC.CTY_ADDR                          AS CTY_ADDR_SH
            ,SC.ST_CD                             AS ST_CD_SH
            ,(SELECT
                  C.CNTY_NM
              FROM
                  CNTY C
              WHERE
                      C.GLBL_CMPY_CD = SC.GLBL_CMPY_CD
                  AND C.CNTY_PK      = SC.CNTY_PK
                  AND C.EZCANCELFLAG = '0')       AS CNTY_NM_SH
            ,SC.POST_CD                           AS POST_CD_SH
            ,SC.CTRY_CD                           AS CTRY_CD_SH
            ,CDV.SLS_REP_OR_SLS_TEAM_TOC_CD
            ,CDV.RTL_WH_CD                       AS RTL_WH_CD
            ,DCD.PRC_CATG_CD
            ,DCD.CCY_CD                           AS AUTO_PRC_CCY_CD
            ,DCD.AUTO_PRC_AMT_RATE
            ,DCD.CALC_PRC_AMT_RATE
            ,DCD.UNIT_PRC_AMT
            ,C.DS_ORD_CATG_CD
            ,C.DS_ORD_TP_CD
        FROM
             VDS_CPO_DTL_V         DCD
            ,CPO_DTL               CDV <!--Mod 2018/06/21 K.Ishizuka [QC#24294, CPO_DTL_V→CPO_DTL] -->
            ,DS_CPO_CONFIG         DCC
            ,CPO                   C
            ,SHIP_TO_CUST          SC
            ,BILL_TO_CUST          BC
            ,ALL_MDSE_V            AMV
            ,DS_ORD_TP_PROC_DFN    OPD
            ,DS_INV_TP             DIT
        WHERE
                DCD.GLBL_CMPY_CD         = CDV.GLBL_CMPY_CD
            AND DCD.CPO_ORD_NUM          = CDV.CPO_ORD_NUM
            AND DCD.CPO_DTL_LINE_NUM     = CDV.CPO_DTL_LINE_NUM
            AND DCD.CPO_DTL_LINE_SUB_NUM = CDV.CPO_DTL_LINE_SUB_NUM
            AND CDV.EZCANCELFLAG         = '0'
            AND CDV.GLBL_CMPY_CD         = DCC.GLBL_CMPY_CD
            AND CDV.DS_CPO_CONFIG_PK     = DCC.DS_CPO_CONFIG_PK
            AND DCC.EZCANCELFLAG         = '0'
            AND DCD.GLBL_CMPY_CD         = C.GLBL_CMPY_CD
            AND DCD.CPO_ORD_NUM          = C.CPO_ORD_NUM
            AND C.EZCANCELFLAG           = '0'
            AND DCC.GLBL_CMPY_CD         = SC.GLBL_CMPY_CD
            AND DCC.SHIP_TO_CUST_LOC_CD  = SC.SHIP_TO_CUST_CD
            AND SC.EZCANCELFLAG          = '0'
            AND DCC.GLBL_CMPY_CD         = BC.GLBL_CMPY_CD
            AND DCC.BILL_TO_CUST_LOC_CD  = BC.BILL_TO_CUST_CD
            AND BC.EZCANCELFLAG          = '0'
            AND DCD.GLBL_CMPY_CD         = AMV.GLBL_CMPY_CD
            AND DCD.SVC_PGM_MDSE_CD      = AMV.MDSE_CD
            AND AMV.EZCANCELFLAG         = '0'
            AND C.GLBL_CMPY_CD           = OPD.GLBL_CMPY_CD
            AND C.DS_ORD_TP_CD           = OPD.DS_ORD_TP_CD
            AND OPD.ACTV_FLG             = 'Y'
            AND OPD.EFF_FROM_DT         &lt;= #slsDt#
            AND (OPD.EFF_THRU_DT        IS NULL
             OR  OPD.EFF_THRU_DT        &gt;= #slsDt#)
            AND OPD.EZCANCELFLAG         = '0'
            AND OPD.GLBL_CMPY_CD         = DIT.GLBL_CMPY_CD
            AND OPD.DS_INV_TP_CD         = DIT.DS_INV_TP_CD
            AND DIT.EZCANCELFLAG         = '0'
        ORDER BY
             DCD.DS_CONTR_PK
            ,DCD.DS_CONTR_DTL_PK
            ,DCD.DS_CONTR_ADDL_CHRG_PK
    </statement>

    <statement id="getPrcgApiParamsForFleet" parameterClass="Map" resultClass="Map">
        WITH
            DS_CONTR_DTL_V AS (
                SELECT
                    DC.GLBL_CMPY_CD
                   ,DC.DS_CONTR_PK
                   ,SHELL_LINE.SHELL_LINE_NUM
                   ,DC.SVC_PGM_MDSE_CD
                   ,DC.ALT_PAYER_CUST_CD
                   ,DC.BILL_BY_TP_CD
                   ,DC.DS_ACCT_NUM
                   ,FLEET_LINE.DS_CONTR_DTL_PK
                   ,NULL                             AS DS_CONTR_ADDL_CHRG_PK
                   ,SHELL_LINE.CPO_ORD_NUM
                   ,#dummyCpoDtlLineNum#             AS CPO_DTL_LINE_NUM
                   ,#dummyCpoDtlLineSubNum#          AS CPO_DTL_LINE_SUB_NUM
                   ,(SELECT
                         PC.CCY_CD
                     FROM
                         PRC_CATG PC
                     WHERE
                             PC.GLBL_CMPY_CD  = SHELL_LINE.GLBL_CMPY_CD
                         AND PC.PRC_CATG_CD   = SHELL_LINE.PRC_CATG_CD
                         AND PC.EZCANCELFLAG  = '0') AS CCY_CD
                    ,SHELL_LINE.PRC_CATG_CD
<!-- START 2017/12/27 U.Kim [QC#23104, MOD] -->
<!--                ,SHELL_LINE.BASE_PRC_DEAL_AMT * (SHELL_LINE.TO_PER_MTH_NUM - SHELL_LINE.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT  AS AUTO_PRC_AMT_RATE -->
<!--                ,SHELL_LINE.BASE_PRC_DEAL_AMT * (SHELL_LINE.TO_PER_MTH_NUM - SHELL_LINE.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT  AS CALC_PRC_AMT_RATE -->
<!--                ,SHELL_LINE.BASE_PRC_DEAL_AMT * (SHELL_LINE.TO_PER_MTH_NUM - SHELL_LINE.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT  AS UNIT_PRC_AMT -->
                    ,ROUND((SHELL_LINE.BASE_PRC_DEAL_AMT * ROUND(((SHELL_LINE.TO_PER_MTH_NUM - SHELL_LINE.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT),#aftDeclPntDigitNum#)), #aftDeclPntDigitNum#)  AS AUTO_PRC_AMT_RATE
                    ,ROUND((SHELL_LINE.BASE_PRC_DEAL_AMT * ROUND(((SHELL_LINE.TO_PER_MTH_NUM - SHELL_LINE.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT),#aftDeclPntDigitNum#)), #aftDeclPntDigitNum#)  AS CALC_PRC_AMT_RATE
                    ,ROUND((SHELL_LINE.BASE_PRC_DEAL_AMT * ROUND(((SHELL_LINE.TO_PER_MTH_NUM - SHELL_LINE.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT),#aftDeclPntDigitNum#)), #aftDeclPntDigitNum#)  AS UNIT_PRC_AMT
<!-- END 2017/12/27 U.Kim [QC#23104, MOD] -->
                    ,FLEET_LINE.BASE_BILL_TO_CUST_CD
                    ,FLEET_LINE.SHIP_TO_CUST_CD
                    ,FLEET_LINE.SELL_TO_CUST_CD
                    ,FLEET_LINE.BILL_WITH_EQUIP_FLG <!-- QC#26647 -->
                FROM
                     DS_CONTR_DTL    SHELL_LINE
                    ,DS_CONTR_DTL    FLEET_LINE
                    ,DS_CONTR        DC
                    ,BLLG_CYCLE      BC
                WHERE
                        SHELL_LINE.GLBL_CMPY_CD       = #glblCmpyCd#
                    AND SHELL_LINE.CPO_ORD_NUM        = #cpoOrdNum#
                    AND SHELL_LINE.SHELL_LINE_NUM     = #shellLineNum#
                    AND SHELL_LINE.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCd_Shell#
                    AND SHELL_LINE.EZCANCELFLAG       = '0'
                    AND SHELL_LINE.GLBL_CMPY_CD       = FLEET_LINE.GLBL_CMPY_CD
                    AND SHELL_LINE.DS_CONTR_PK        = FLEET_LINE.DS_CONTR_PK
                    AND FLEET_LINE.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCd_Fleet#
                    AND FLEET_LINE.EZCANCELFLAG       = '0'
                    AND FLEET_LINE.GLBL_CMPY_CD       = DC.GLBL_CMPY_CD
                    AND FLEET_LINE.DS_CONTR_PK        = DC.DS_CONTR_PK
                    AND DC.EZCANCELFLAG               = '0'
                    AND DC.GLBL_CMPY_CD               = BC.GLBL_CMPY_CD
                    AND DC.BASE_BLLG_CYCLE_CD         = BC.BLLG_CYCLE_CD
                    AND BC.EZCANCELFLAG               = '0'
            )
            ,DS_CONTR_ADDL_CHRG_V AS (
                SELECT
                    DC.GLBL_CMPY_CD
                   ,DC.DS_CONTR_PK
                   ,DCD.SHELL_LINE_NUM
                   ,DC.SVC_PGM_MDSE_CD
                   ,DC.ALT_PAYER_CUST_CD
                   ,DC.BILL_BY_TP_CD
                   ,DC.DS_ACCT_NUM
                   ,NULL                            AS DS_CONTR_DTL_PK
                   ,DCAC.DS_CONTR_ADDL_CHRG_PK
                   ,DCD.CPO_ORD_NUM
                   ,DCD.CPO_DTL_LINE_NUM
                   ,DCD.CPO_DTL_LINE_SUB_NUM
                   ,(SELECT
                         PC.CCY_CD
                     FROM
                         PRC_CATG PC
                     WHERE
                             PC.GLBL_CMPY_CD  = DCAC.GLBL_CMPY_CD
                         AND PC.PRC_CATG_CD   = DCAC.PRC_CATG_CD
                         AND PC.EZCANCELFLAG  = '0') AS CCY_CD
                    ,DCAC.PRC_CATG_CD
<!-- START 2017/12/27 U.Kim [QC#23104, MOD] -->
<!--                ,DCAC.ADDL_CHRG_FLAT_DEAL_PRC_AMT * (DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT  AS AUTO_PRC_AMT_RATE -->
<!--                ,DCAC.ADDL_CHRG_FLAT_DEAL_PRC_AMT * (DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT  AS CALC_PRC_AMT_RATE -->
<!--                ,DCAC.ADDL_CHRG_FLAT_DEAL_PRC_AMT * (DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT  AS UNIT_PRC_AMT -->
                    ,ROUND((DCAC.ADDL_CHRG_FLAT_DEAL_PRC_AMT * ROUND(((DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT),#aftDeclPntDigitNum#)), #aftDeclPntDigitNum#)  AS AUTO_PRC_AMT_RATE
                    ,ROUND((DCAC.ADDL_CHRG_FLAT_DEAL_PRC_AMT * ROUND(((DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT),#aftDeclPntDigitNum#)), #aftDeclPntDigitNum#)  AS CALC_PRC_AMT_RATE
                    ,ROUND((DCAC.ADDL_CHRG_FLAT_DEAL_PRC_AMT * ROUND(((DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT),#aftDeclPntDigitNum#)), #aftDeclPntDigitNum#)  AS UNIT_PRC_AMT
<!-- END 2017/12/27 U.Kim [QC#23104, MOD] -->
                    ,DCD.BILL_WITH_EQUIP_FLG <!-- QC#26647 -->
                FROM
                     DS_CONTR_DTL       DCD
                    ,DS_CONTR_ADDL_CHRG DCAC
                    ,DS_CONTR           DC
                    ,BLLG_CYCLE         BC
                WHERE
                        DCD.GLBL_CMPY_CD       = #glblCmpyCd#
                    AND DCD.CPO_ORD_NUM        = #cpoOrdNum#
                    AND DCD.SHELL_LINE_NUM     = #shellLineNum#
                    AND DCD.EZCANCELFLAG       = '0'
                    AND DCD.GLBL_CMPY_CD       = DCAC.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK    = DCAC.DS_CONTR_DTL_PK
                    AND DCAC.ADDL_CHRG_CATG_CD IN (#addlChrgCatgcd_Rental#, #addlChrgCatgcd_Normal#)
                    AND DCAC.EZCANCELFLAG      = '0'
                    AND DCD.GLBL_CMPY_CD       = DC.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_PK        = DC.DS_CONTR_PK
                    AND DC.EZCANCELFLAG        = '0'
                    AND DC.GLBL_CMPY_CD        = BC.GLBL_CMPY_CD
                    AND DC.BASE_BLLG_CYCLE_CD  = BC.BLLG_CYCLE_CD
                    AND BC.EZCANCELFLAG        = '0'
            )
        SELECT
            DCD.DS_CONTR_PK
            ,DCD.SHELL_LINE_NUM
            ,DCD.DS_CONTR_DTL_PK
            ,DCD.DS_CONTR_ADDL_CHRG_PK
            ,DCD.CPO_ORD_NUM
            ,DCD.CPO_DTL_LINE_NUM
            ,DCD.CPO_DTL_LINE_SUB_NUM
            ,OPD.LINE_BIZ_TP_CD                   AS LINE_BIZ_TP_CD
            ,C.SELL_TO_CUST_CD                    AS DS_ACCT_NUM
            ,C.LEASE_PRCH_OPT_CD                  AS LEASE_PRCH_OPT_CD
            ,CASE
                 WHEN DCD.BILL_WITH_EQUIP_FLG = 'Y'  <!-- QC#26647 -->
                     THEN C.BILL_TO_CUST_CD
                 WHEN
                         DCD.BASE_BILL_TO_CUST_CD &lt;&gt; DCD.ALT_PAYER_CUST_CD
                     AND EXISTS(
                             SELECT
                                 *
                             FROM
                                 BILL_BY_TP BT
                             WHERE
                                     BT.GLBL_CMPY_CD        = DCD.GLBL_CMPY_CD
                                 AND BT.BILL_BY_TP_CD       = DCD.BILL_BY_TP_CD
                                 AND BT.USE_SVC_BILL_TO_FLG = 'Y'
                                 AND BT.EZCANCELFLAG        = '0'
                         ) THEN DCD.ALT_PAYER_CUST_CD
                 ELSE
                     DCD.BASE_BILL_TO_CUST_CD
             END                                  AS BILL_TO_CUST_CD
            ,DCD.SHIP_TO_CUST_CD                  AS SHIP_TO_CUST_CD
            ,DCD.SELL_TO_CUST_CD                  AS DS_ACCT_NUM_SH
            ,CASE
                WHEN DCD.BILL_WITH_EQUIP_FLG = 'Y'  <!-- QC#26647 -->
                     THEN C.BILL_TO_CUST_ACCT_CD
                WHEN
                        DCD.BASE_BILL_TO_CUST_CD &lt;&gt; DCD.ALT_PAYER_CUST_CD
                    AND EXISTS(
                            SELECT
                                *
                            FROM
                                BILL_BY_TP BT
                            WHERE
                                    BT.GLBL_CMPY_CD        = DCD.GLBL_CMPY_CD
                                AND BT.BILL_BY_TP_CD       = DCD.BILL_BY_TP_CD
                                AND BT.USE_SVC_BILL_TO_FLG = 'Y'
                                AND BT.EZCANCELFLAG        = '0'
                        ) THEN DCD.DS_ACCT_NUM
                ELSE
                    DCD.SELL_TO_CUST_CD
                END                              AS DS_ACCT_NUM_BL
            ,DCD.CCY_CD
            ,DCD.SVC_PGM_MDSE_CD                  AS MDSE_CD
            ,(SELECT
                  PUC.BASE_PKG_UOM_CD
              FROM
                  PKG_UOM_CLS PUC
              WHERE
                      PUC.GLBL_CMPY_CD   = AMV.GLBL_CMPY_CD
                  AND PUC.PKG_UOM_CLS_CD = AMV.PKG_UOM_CLS_CD
                  AND PUC.EZCANCELFLAG   = '0')   AS PKG_UOM_CD
            ,SC.FIRST_LINE_ADDR                   AS FIRST_LINE_ADDR_SH
            ,SC.SCD_LINE_ADDR                     AS SCD_LINE_ADDR_SH
            ,SC.CTY_ADDR                          AS CTY_ADDR_SH
            ,SC.ST_CD                             AS ST_CD_SH
            ,(SELECT
                  C.CNTY_NM
              FROM
                  CNTY C
              WHERE
                      C.GLBL_CMPY_CD = SC.GLBL_CMPY_CD
                  AND C.CNTY_PK      = SC.CNTY_PK
                  AND C.EZCANCELFLAG = '0')       AS CNTY_NM_SH
            ,SC.POST_CD                           AS POST_CD_SH
            ,SC.CTRY_CD                           AS CTRY_CD_SH
            ,C.SLS_REP_TOC_CD                     AS SLS_REP_OR_SLS_TEAM_TOC_CD
            ,''                                   AS RTL_WH_CD
            ,DCD.PRC_CATG_CD
            ,DCD.CCY_CD                           AS AUTO_PRC_CCY_CD
            ,DCD.AUTO_PRC_AMT_RATE
            ,DCD.CALC_PRC_AMT_RATE
            ,DCD.UNIT_PRC_AMT
            ,C.DS_ORD_CATG_CD
            ,C.DS_ORD_TP_CD
        FROM
             DS_CONTR_DTL_V        DCD
            ,CPO                   C
            ,SHIP_TO_CUST          SC
            ,BILL_TO_CUST          BC
            ,ALL_MDSE_V            AMV
            ,DS_ORD_TP_PROC_DFN    OPD
            ,DS_INV_TP             DIT
        WHERE
                DCD.GLBL_CMPY_CD         = C.GLBL_CMPY_CD
            AND DCD.CPO_ORD_NUM          = C.CPO_ORD_NUM
            AND C.EZCANCELFLAG           = '0'
            AND DCD.GLBL_CMPY_CD         = SC.GLBL_CMPY_CD
            AND DCD.SHIP_TO_CUST_CD      = SC.SHIP_TO_CUST_CD
            AND SC.EZCANCELFLAG          = '0'
            AND DCD.GLBL_CMPY_CD         = BC.GLBL_CMPY_CD
            AND DCD.BASE_BILL_TO_CUST_CD = BC.BILL_TO_CUST_CD
            AND BC.EZCANCELFLAG          = '0'
            AND DCD.GLBL_CMPY_CD         = AMV.GLBL_CMPY_CD
            AND DCD.SVC_PGM_MDSE_CD      = AMV.MDSE_CD
            AND AMV.EZCANCELFLAG         = '0'
            AND C.GLBL_CMPY_CD           = OPD.GLBL_CMPY_CD
            AND C.DS_ORD_TP_CD           = OPD.DS_ORD_TP_CD
            AND OPD.ACTV_FLG             = 'Y'
            AND OPD.EFF_FROM_DT         &lt;= #slsDt#
            AND (OPD.EFF_THRU_DT        IS NULL
             OR  OPD.EFF_THRU_DT        &gt;= #slsDt#)
            AND OPD.EZCANCELFLAG         = '0'
            AND OPD.GLBL_CMPY_CD         = DIT.GLBL_CMPY_CD
            AND OPD.DS_INV_TP_CD         = DIT.DS_INV_TP_CD
            AND DIT.EZCANCELFLAG         = '0'
        UNION ALL
        SELECT
            DCD.DS_CONTR_PK
            ,DCD.SHELL_LINE_NUM
            ,DCD.DS_CONTR_DTL_PK
            ,DCD.DS_CONTR_ADDL_CHRG_PK
            ,DCD.CPO_ORD_NUM
            ,DCD.CPO_DTL_LINE_NUM
            ,DCD.CPO_DTL_LINE_SUB_NUM
            ,OPD.LINE_BIZ_TP_CD                   AS LINE_BIZ_TP_CD
            ,C.SELL_TO_CUST_CD                    AS DS_ACCT_NUM
            ,C.LEASE_PRCH_OPT_CD                  AS LEASE_PRCH_OPT_CD
            ,CASE
                 WHEN DCD.BILL_WITH_EQUIP_FLG = 'Y'  <!-- QC#26647 -->
                     THEN DCC.BILL_TO_CUST_LOC_CD
                 WHEN
                         DCC.BILL_TO_CUST_LOC_CD &lt;&gt; DCD.ALT_PAYER_CUST_CD
                     AND EXISTS(
                             SELECT
                                 *
                             FROM
                                 BILL_BY_TP BT
                             WHERE
                                     BT.GLBL_CMPY_CD        = DCD.GLBL_CMPY_CD
                                 AND BT.BILL_BY_TP_CD       = DCD.BILL_BY_TP_CD
                                 AND BT.USE_SVC_BILL_TO_FLG = 'Y'
                                 AND BT.EZCANCELFLAG        = '0'
                         ) THEN DCD.ALT_PAYER_CUST_CD
                 ELSE
                     DCC.BILL_TO_CUST_LOC_CD
             END                                  AS BILL_TO_CUST_CD
            ,DCC.SHIP_TO_CUST_LOC_CD              AS SHIP_TO_CUST_CD
            ,DCC.SHIP_TO_CUST_ACCT_CD             AS DS_ACCT_NUM_SH
            ,CASE
                 WHEN DCD.BILL_WITH_EQUIP_FLG = 'Y'  <!-- QC#26647 -->
                     THEN DCC.BILL_TO_CUST_ACCT_CD
                 WHEN
                         DCC.BILL_TO_CUST_LOC_CD &lt;&gt; DCD.ALT_PAYER_CUST_CD
                     AND EXISTS(
                             SELECT
                                 *
                             FROM
                                 BILL_BY_TP BT
                             WHERE
                                     BT.GLBL_CMPY_CD        = DCD.GLBL_CMPY_CD
                                 AND BT.BILL_BY_TP_CD       = DCD.BILL_BY_TP_CD
                                 AND BT.USE_SVC_BILL_TO_FLG = 'Y'
                                 AND BT.EZCANCELFLAG        = '0'
                         ) THEN DCD.DS_ACCT_NUM
                 ELSE
                     DCC.BILL_TO_CUST_ACCT_CD
                     END                          AS DS_ACCT_NUM_BL
            ,DCD.CCY_CD
            ,DCD.SVC_PGM_MDSE_CD                  AS MDSE_CD
            ,(SELECT
                  PUC.BASE_PKG_UOM_CD
              FROM
                  PKG_UOM_CLS PUC
              WHERE
                      PUC.GLBL_CMPY_CD   = AMV.GLBL_CMPY_CD
                  AND PUC.PKG_UOM_CLS_CD = AMV.PKG_UOM_CLS_CD
                  AND PUC.EZCANCELFLAG   = '0')   AS PKG_UOM_CD
            ,SC.FIRST_LINE_ADDR                   AS FIRST_LINE_ADDR_SH
            ,SC.SCD_LINE_ADDR                     AS SCD_LINE_ADDR_SH
            ,SC.CTY_ADDR                          AS CTY_ADDR_SH
            ,SC.ST_CD                             AS ST_CD_SH
            ,(SELECT
                  C.CNTY_NM
              FROM
                  CNTY C
              WHERE
                      C.GLBL_CMPY_CD = SC.GLBL_CMPY_CD
                  AND C.CNTY_PK      = SC.CNTY_PK
                  AND C.EZCANCELFLAG = '0')       AS CNTY_NM_SH
            ,SC.POST_CD                           AS POST_CD_SH
            ,SC.CTRY_CD                           AS CTRY_CD_SH
            ,CDV.SLS_REP_OR_SLS_TEAM_TOC_CD
            ,CDV.RTL_WH_CD                       AS RTL_WH_CD
            ,DCD.PRC_CATG_CD
            ,DCD.CCY_CD                           AS AUTO_PRC_CCY_CD
            ,DCD.AUTO_PRC_AMT_RATE
            ,DCD.CALC_PRC_AMT_RATE
            ,DCD.UNIT_PRC_AMT
            ,C.DS_ORD_CATG_CD
            ,C.DS_ORD_TP_CD
        FROM
             DS_CONTR_ADDL_CHRG_V  DCD
            ,CPO_DTL               CDV <!--Mod 2018/06/21 K.Ishizuka [QC#24294, CPO_DTL_V→CPO_DTL] -->
            ,DS_CPO_CONFIG         DCC
            ,CPO                   C
            ,SHIP_TO_CUST          SC
            ,BILL_TO_CUST          BC
            ,ALL_MDSE_V            AMV
            ,DS_ORD_TP_PROC_DFN    OPD
            ,DS_INV_TP             DIT
        WHERE
                DCD.GLBL_CMPY_CD         = CDV.GLBL_CMPY_CD
            AND DCD.CPO_ORD_NUM          = CDV.CPO_ORD_NUM
            AND DCD.CPO_DTL_LINE_NUM     = CDV.CPO_DTL_LINE_NUM
            AND DCD.CPO_DTL_LINE_SUB_NUM = CDV.CPO_DTL_LINE_SUB_NUM
            AND CDV.EZCANCELFLAG         = '0'
            AND CDV.GLBL_CMPY_CD         = DCC.GLBL_CMPY_CD
            AND CDV.DS_CPO_CONFIG_PK     = DCC.DS_CPO_CONFIG_PK
            AND DCC.EZCANCELFLAG         = '0'
            AND DCD.GLBL_CMPY_CD         = C.GLBL_CMPY_CD
            AND DCD.CPO_ORD_NUM          = C.CPO_ORD_NUM
            AND C.EZCANCELFLAG           = '0'
            AND DCC.GLBL_CMPY_CD         = SC.GLBL_CMPY_CD
            AND DCC.SHIP_TO_CUST_LOC_CD  = SC.SHIP_TO_CUST_CD
            AND SC.EZCANCELFLAG          = '0'
            AND DCC.GLBL_CMPY_CD         = BC.GLBL_CMPY_CD
            AND DCC.BILL_TO_CUST_LOC_CD  = BC.BILL_TO_CUST_CD
            AND BC.EZCANCELFLAG          = '0'
            AND DCD.GLBL_CMPY_CD         = AMV.GLBL_CMPY_CD
            AND DCD.SVC_PGM_MDSE_CD      = AMV.MDSE_CD
            AND AMV.EZCANCELFLAG         = '0'
            AND C.GLBL_CMPY_CD           = OPD.GLBL_CMPY_CD
            AND C.DS_ORD_TP_CD           = OPD.DS_ORD_TP_CD
            AND OPD.ACTV_FLG             = 'Y'
            AND OPD.EFF_FROM_DT         &lt;= #slsDt#
            AND (OPD.EFF_THRU_DT        IS NULL
             OR  OPD.EFF_THRU_DT        &gt;= #slsDt#)
            AND OPD.EZCANCELFLAG         = '0'
            AND OPD.GLBL_CMPY_CD         = DIT.GLBL_CMPY_CD
            AND OPD.DS_INV_TP_CD         = DIT.DS_INV_TP_CD
            AND DIT.EZCANCELFLAG         = '0'
        ORDER BY
             DS_CONTR_PK
            ,DS_CONTR_DTL_PK
            ,DS_CONTR_ADDL_CHRG_PK
    </statement>

    <statement id="getMdlIdFromDsCpoConfig" parameterClass="Map" resultClass="Map">
        SELECT
                  DCC.MDL_ID
            FROM
                DS_CPO_CONFIG DCC 
            WHERE
                DCC.GLBL_CMPY_CD        = #glblCmpyCd#
                AND DCC.CPO_ORD_NUM     = #cpoOrdNum#
                AND DCC.DS_ORD_POSN_NUM = #dsOrdPosnNum#
                AND DCC.CONFIG_CATG_CD  = #configCatgCd#
                AND DCC.EZCANCELFLAG    = '0'
    </statement>

    <statement id="getMdlIdFromDsCpoConfigForPrcOnly" parameterClass="Map" resultClass="Map">
        SELECT
                  DCC.MDL_ID
            FROM
                DS_CONTR_DTL        DCD
                <!-- START 2018/07/09 K.Kojima [QC#27135,MOD] -->
                <!-- , CPO_DTL_V         CDV -->
                , CPO_DTL           CDV
                <!-- END 2018/07/09 K.Kojima [QC#27135,MOD] -->
                , DS_CPO_CONFIG     DCC
            WHERE
                DCD.GLBL_CMPY_CD             = #glblCmpyCd#
                AND DCD.DS_CONTR_PK       = #dsContrPk#
                AND DCD.EZCANCELFLAG         = '0'
                --
                AND DCD.GLBL_CMPY_CD         = CDV.GLBL_CMPY_CD
                AND DCD.CPO_ORD_NUM          = CDV.CPO_ORD_NUM
                AND DCD.CPO_DTL_LINE_NUM     = CDV.CPO_DTL_LINE_NUM
                AND DCD.CPO_DTL_LINE_SUB_NUM = CDV.CPO_DTL_LINE_SUB_NUM
                AND CDV.EZCANCELFLAG         = '0'
                --
                AND CDV.GLBL_CMPY_CD         = DCC.GLBL_CMPY_CD
                AND CDV.CPO_ORD_NUM          = DCC.CPO_ORD_NUM
                AND CDV.DS_ORD_POSN_NUM      = DCC.DS_ORD_POSN_NUM
                AND DCC.CONFIG_CATG_CD       = #configCatgCd#
                AND DCC.EZCANCELFLAG         = '0'
    </statement>

    <statement id="getDsContrPkFromDsContrDtl" parameterClass="Map" resultClass="Map">
        SELECT
                  DCD.DS_CONTR_PK
            FROM
                DS_CONTR_DTL DCD
            WHERE
                DCD.GLBL_CMPY_CD              = #glblCmpyCd#
                AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                AND DCD.EZCANCELFLAG          = '0'
    </statement>

    <!-- START 2018/07/09 K.Kojima [QC#27135,DEL] -->
    <!-- <statement id="getCpoDtlLineNumByMdlId" parameterClass="Map" resultClass="Map"> -->
    <!--     SELECT -->
    <!--               DCD.CPO_DTL_LINE_NUM -->
    <!--             , DCD.CPO_DTL_LINE_SUB_NUM -->
    <!--         FROM -->
    <!--             CPO_DTL_V    DCD -->
    <!--         WHERE -->
    <!--             DCD.GLBL_CMPY_CD        = #glblCmpyCd# -->
    <!--             AND DCD.CPO_ORD_NUM     = #cpoOrdNum# -->
    <!--             <isNotNull  property="dsOrdPosnNum"> -->
    <!--             AND DCD.DS_ORD_POSN_NUM = #dsOrdPosnNum# -->
    <!--             </isNotNull> -->
    <!--             AND DCD.BASE_CMPT_FLG   = 'Y' -->
    <!--             AND EXISTS ( -->
    <!--                 SELECT -->
    <!--                           DCC.GLBL_CMPY_CD -->
    <!--                     FROM -->
    <!--                         DS_CPO_CONFIG   DCC -->
    <!--                     WHERE -->
    <!--                         DCC.GLBL_CMPY_CD         = DCD.GLBL_CMPY_CD -->
    <!--                         AND DCC.DS_CPO_CONFIG_PK = DCD.DS_CPO_CONFIG_PK -->
    <!--                         <isNotNull property="mdlId"> -->
    <!--                         AND DCC.MDL_ID           = #mdlId# -->
    <!--                         </isNotNull> -->
    <!--                         AND DCC.EZCANCELFLAG     = '0' -->
    <!--             )  -->
    <!-- </statement> -->
    <!-- END 2018/07/09 K.Kojima [QC#27135,DEL] -->

    <statement id="getBaseTotalAmt" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            SUM(A.TERM_AMT)
        FROM (     
            SELECT
<!-- START 2018/04/10 M.Naito [QC#23378, MOD] -->
<!-- START 2017/12/27 U.Kim [QC#23104, MOD] -->
<!--            (NVL(DCD.BASE_PRC_DEAL_AMT, 0) * (DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT) AS TERM_AMT -->
<!-- START 2018/06/19 K.Kojima [QC#26591, MOD] -->
<!--            ROUND((NVL(DCD.BASE_PRC_DEAL_AMT, 0) * FLT_MACH.COUNT * ROUND(((DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT), #aftDeclPntDigitNum#)), #aftDeclPntDigitNum#) AS TERM_AMT -->
                ROUND((NVL(DCD.BASE_PRC_DEAL_AMT, 0) * ROUND(((DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT), #aftDeclPntDigitNum#)), #aftDeclPntDigitNum#) AS TERM_AMT
<!-- END 2018/06/19 K.Kojima [QC#26591, MOD] -->
<!-- END 2017/12/27 U.Kim [QC#23104, MOD] -->
            FROM
                 DS_CONTR_DTL          DCD
                ,DS_CONTR              DC
                ,BLLG_CYCLE            BC
<!-- START 2018/06/19 K.Kojima [QC#26591, DEL] -->
<!--            ,( -->
<!--                SELECT -->
<!--                    CASE WHEN DC1.DS_CONTR_CATG_CD != #dsContrCatgCd_Fleet# THEN 1 ELSE count(DCD1.DS_CONTR_DTL_PK) END COUNT -->
<!--                 FROM -->
<!--                     DS_CONTR_DTL          DCD1 -->
<!--                    ,DS_CONTR              DC1 -->
<!--                 WHERE -->
<!--                         DCD1.GLBL_CMPY_CD          = #glblCmpyCd# -->
<!--                     AND DCD1.CPO_ORD_NUM           = #cpoOrdNum# -->
<!--                     AND DCD1.SHELL_LINE_NUM        = #shellLineNum# -->
<!--                     AND DCD1.DS_CONTR_DTL_TP_CD       IN  -->
<!--                     <iterate property="dsContrDtlTpCdMach" var="dsContrDtlTpCdMach[]" open=" (" close=")" conjunction=","> -->
<!--                          #dsContrDtlTpCdMach[]# -->
<!--                     </iterate> -->
<!--                     AND DCD1.EZCANCELFLAG          = '0' -->
<!--                     AND DCD1.GLBL_CMPY_CD          = DC1.GLBL_CMPY_CD -->
<!--                     AND DCD1.DS_CONTR_PK           = DC1.DS_CONTR_PK -->
<!--                     AND DC1.EZCANCELFLAG           = '0' -->
<!--                 GROUP BY DC1.DS_CONTR_CATG_CD -->
<!--             ) FLT_MACH -->
<!-- END 2018/06/19 K.Kojima [QC#26591, DEL] -->
<!-- END 2018/04/10 M.Naito [QC#23378, MOD] -->
            WHERE
                    DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                AND DCD.CPO_ORD_NUM           = #cpoOrdNum#
                AND DCD.SHELL_LINE_NUM        = #shellLineNum#
                AND DCD.EZCANCELFLAG          = '0'
                AND DCD.GLBL_CMPY_CD          = DC.GLBL_CMPY_CD
                AND DCD.DS_CONTR_PK           = DC.DS_CONTR_PK
                AND DC.EZCANCELFLAG           = '0'
                AND DCD.GLBL_CMPY_CD          = BC.GLBL_CMPY_CD
                AND DCD.BASE_BLLG_CYCLE_CD    = BC.BLLG_CYCLE_CD
                AND BC.EZCANCELFLAG           = '0'
                AND (
                    (
                        DC.DS_CONTR_CATG_CD = #dsContrCatgCd_Fleet#
                        AND DCD.DS_CONTR_DTL_TP_CD NOT IN (#dsContrDtlTpCd_Fleet#)
                    ) OR
                    (
                        DC.DS_CONTR_CATG_CD &lt;&gt; #dsContrCatgCd_Fleet#
                        AND DCD.DS_CONTR_DTL_TP_CD NOT IN (#dsContrDtlTpCd_Aggregate#, #dsContrDtlTpCd_Shell#)
                    )
                )
            UNION ALL
            SELECT
<!-- START 2017/12/27 U.Kim [QC#23104, MOD] -->
<!--            (NVL(DCAC.ADDL_CHRG_FLAT_DEAL_PRC_AMT, 0) * (DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT) AS TERM_AMT -->
                ROUND((NVL(DCAC.ADDL_CHRG_FLAT_DEAL_PRC_AMT, 0) * ROUND(((DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT), #aftDeclPntDigitNum#)),  #aftDeclPntDigitNum#) AS TERM_AMT
<!-- END 2017/12/27 U.Kim [QC#23104, MOD] -->
            FROM
                 DS_CONTR_DTL          DCD
                ,DS_CONTR              DC
                ,BLLG_CYCLE            BC
                ,DS_CONTR_ADDL_CHRG    DCAC
            WHERE
                    DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                AND DCD.CPO_ORD_NUM           = #cpoOrdNum#
                AND DCD.SHELL_LINE_NUM        = #shellLineNum#
                AND DCD.EZCANCELFLAG          = '0'
                AND DCD.GLBL_CMPY_CD          = DC.GLBL_CMPY_CD
                AND DCD.DS_CONTR_PK           = DC.DS_CONTR_PK
                AND DC.EZCANCELFLAG           = '0'
                AND DCD.GLBL_CMPY_CD          = BC.GLBL_CMPY_CD
                AND (
                    DCD.BASE_BLLG_CYCLE_CD    = BC.BLLG_CYCLE_CD
                    OR (
                        BC.BLLG_CYCLE_CD IN (
                        SELECT
                            A.BASE_BLLG_CYCLE_CD
                        FROM
                            DS_CONTR_DTL A
                        WHERE
                                A.GLBL_CMPY_CD       = #glblCmpyCd#
                            AND A.CPO_ORD_NUM        = #cpoOrdNum#
                            AND A.SHELL_LINE_NUM     = #shellLineNum#
                            AND A.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCd_Shell#
                            AND A.EZCANCELFLAG       = '0'
                        )
                    )
                )
                AND BC.EZCANCELFLAG           = '0'
                AND DCD.GLBL_CMPY_CD          = DCAC.GLBL_CMPY_CD(+)
                AND DCD.DS_CONTR_DTL_PK       = DCAC.DS_CONTR_DTL_PK(+)
                AND DCAC.ADDL_CHRG_CATG_CD(+) IS NOT NULL
                AND DCAC.EZCANCELFLAG(+)      = '0'
                AND (
                    (
                        DC.DS_CONTR_CATG_CD = #dsContrCatgCd_Fleet#
                        AND DCD.DS_CONTR_DTL_TP_CD NOT IN (#dsContrDtlTpCd_Fleet#)
                    ) OR
                    (
                        DC.DS_CONTR_CATG_CD &lt;&gt; #dsContrCatgCd_Fleet#
                        AND DCD.DS_CONTR_DTL_TP_CD NOT IN (#dsContrDtlTpCd_Aggregate#, #dsContrDtlTpCd_Shell#)
                    )
                )
            <!-- START 2018/04/10 M.Naito [QC#23378,MOD] -->
            UNION ALL
            SELECT
                ROUND((NVL(FL_RNTL.RNTL_PRC_AMT, 0) * ROUND(((DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) / BC.BLLG_CYCLE_MTH_AOT), #aftDeclPntDigitNum#)), #aftDeclPntDigitNum#) AS TERM_AMT
            FROM
                 DS_CONTR_DTL          DCD
                ,DS_CONTR              DC
                ,BLLG_CYCLE            BC
                ,(
                    SELECT
                        SUM(NVL(DCD.RNTL_PRC_AMT, 0)) AS RNTL_PRC_AMT
                    FROM
                        DS_CONTR_DTL          DCD
                       ,DS_CONTR              DC
                    WHERE
                            DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                        AND DCD.CPO_ORD_NUM           = #cpoOrdNum#
                        AND DCD.SHELL_LINE_NUM        = #shellLineNum#
                        AND DCD.EZCANCELFLAG          = '0'
                        AND DCD.GLBL_CMPY_CD          = DC.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_PK           = DC.DS_CONTR_PK
                        AND DC.EZCANCELFLAG           = '0'
                 ) FL_RNTL
            WHERE
                    DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                AND DCD.CPO_ORD_NUM           = #cpoOrdNum#
                AND DCD.SHELL_LINE_NUM        = #shellLineNum#
                AND DCD.EZCANCELFLAG          = '0'
                AND DCD.GLBL_CMPY_CD          = DC.GLBL_CMPY_CD
                AND DCD.DS_CONTR_PK           = DC.DS_CONTR_PK
                AND DC.EZCANCELFLAG           = '0'
                AND DCD.GLBL_CMPY_CD          = BC.GLBL_CMPY_CD
                AND DCD.BASE_BLLG_CYCLE_CD    = BC.BLLG_CYCLE_CD
                AND BC.EZCANCELFLAG           = '0'
                AND DC.DS_CONTR_CATG_CD       = #dsContrCatgCd_Fleet#
                AND DCD.DS_CONTR_DTL_TP_CD    != #dsContrDtlTpCd_Fleet#
            <!-- END 2018/04/10 M.Naito [QC#23378,MOD] -->
        ) A
    </statement>

    <statement id="getNeedToUpdateAsryDsContrCrCardPo" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            DCCCP.DS_CONTR_CR_CARD_PO_PK
        FROM
             DS_CONTR_DTL        MAC
            ,DS_CONTR_DTL        ACC
            ,DS_CONTR_CR_CARD_PO DCCCP
        WHERE
                MAC.GLBL_CMPY_CD              = #glblCmpyCd#
            AND MAC.DS_CONTR_DTL_PK           = #dsContrDtlPk#
            AND MAC.EZCANCELFLAG              = '0'
            AND MAC.GLBL_CMPY_CD              = ACC.GLBL_CMPY_CD
            AND MAC.DS_CONTR_DTL_PK           = ACC.PRNT_DS_CONTR_DTL_PK
            AND MAC.CPO_ORD_NUM               = ACC.CPO_ORD_NUM
            AND MAC.SHELL_LINE_NUM            = ACC.SHELL_LINE_NUM
            AND ACC.EZCANCELFLAG              = '0'
            AND ACC.GLBL_CMPY_CD              = DCCCP.GLBL_CMPY_CD
            AND ACC.DS_CONTR_DTL_PK           = DCCCP.DS_CONTR_DTL_PK
            AND DCCCP.EZCANCELFLAG            = '0'
            AND (
                   DCCCP.CR_CARD_CUST_REF_NUM &lt;&gt; #crCardCustRefNum#
                OR DCCCP.CR_CARD_EXPR_YR_MTH  &lt;&gt; #crCardExprYrMth#
                OR DCCCP.CUST_PO_NUM          &lt;&gt; #custPoNum#
                OR DCCCP.PO_DT                &lt;&gt; #poDt#
            )
    </statement>

    <statement id="getDsContrCrCardPoForAsry" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            DCCCP.DS_CONTR_CR_CARD_PO_PK
        FROM
             DS_CONTR_DTL        MAC
            ,DS_CONTR_DTL        ACC
            ,DS_CONTR_CR_CARD_PO DCCCP
        WHERE
                MAC.GLBL_CMPY_CD              = #glblCmpyCd#
            AND MAC.DS_CONTR_DTL_PK           = #dsContrDtlPk#
            AND MAC.EZCANCELFLAG              = '0'
            AND MAC.GLBL_CMPY_CD              = ACC.GLBL_CMPY_CD
            AND MAC.DS_CONTR_DTL_PK           = ACC.PRNT_DS_CONTR_DTL_PK
            AND MAC.CPO_ORD_NUM               = ACC.CPO_ORD_NUM
            AND MAC.SHELL_LINE_NUM            = ACC.SHELL_LINE_NUM
            AND ACC.EZCANCELFLAG              = '0'
            AND ACC.GLBL_CMPY_CD              = DCCCP.GLBL_CMPY_CD
            AND ACC.DS_CONTR_DTL_PK           = DCCCP.DS_CONTR_DTL_PK
            AND DCCCP.EZCANCELFLAG            = '0'
    </statement>

    <statement id="getUpdateBaseTotalTarget" parameterClass="Map" resultClass="BigDecimal">
        SELECT DISTINCT
             DCD.SHELL_LINE_NUM
        FROM
            DS_CONTR_DTL DCD
        WHERE
                DCD.GLBL_CMPY_CD = #glblCmpyCd#
            AND DCD.CPO_ORD_NUM  = #cpoOrdNum#
            AND DCD.SHELL_LINE_NUM IS NOT NULL
            AND DCD.EZCANCELFLAG = '0'
    </statement>

    <statement id="getCountPrcMtrPkg" parameterClass="Map" resultClass="Integer">
        SELECT
                  COUNT('EXIST')        CNT
            FROM
              <isEqual property="prcListTp" compareValue="21"><!-- EzPack -->
                PRC_LIST_SPLY_PGM       PL
              </isEqual>
              <isEqual property="prcListTp" compareValue="07"><!-- service tier -->
                PRC_LIST_SVC_TIER       PL
              </isEqual>
              <isNotEqual property="prcListTp" compareValue="21">
              <isNotEqual property="prcListTp" compareValue="07">
                PRC_LIST_SVC           PL
              </isNotEqual>
              </isNotEqual>
            WHERE
                PL.GLBL_CMPY_CD             = #glblCmpyCd#
                AND PL.PRC_CATG_CD          = #prcCatgCd#
                AND PL.MDL_ID              IN
              <iterate property="mdlIdList" var="mdlIdList[]" open="(" close=")" conjunction=",">
                #mdlIdList[]#
              </iterate>
                AND PL.PRC_SVC_PLN_TP_CD    = #prcSvcPlnTp#
                AND PL.PRC_SVC_CONTR_TP_CD  = #prcSvcContrTp#
                AND PL.PRC_MTR_PKG_PK       = #prcMtrPkgPk#
                AND PL.DEL_FLG              = 'N'
                AND PL.EFF_FROM_DT         &lt;= #slsDt#
                AND ( 
                    PL.EFF_THRU_DT         IS NULL
                    OR PL.EFF_THRU_DT      &gt;= #slsDt#
                ) 
                AND PL.EZCANCELFLAG         = '0'
    </statement>

    <statement id="getPrcListTp" parameterClass="Map" resultClass="String">
        SELECT
            PLT.PRC_LIST_TP_CD
        FROM
             PRC_CATG                PC
            ,PRC_CATG                DPC
            ,PRC_LIST_TP             PLT
        WHERE
                PC.GLBL_CMPY_CD      = #glblCmpyCd#
            AND PC.PRC_CATG_CD       = #prcCatgCd#
            AND PC.GLBL_CMPY_CD      = DPC.GLBL_CMPY_CD
            AND PC.PRC_CATG_CD       = DPC.PRC_CATG_CD
            AND DPC.GLBL_CMPY_CD     = PLT.GLBL_CMPY_CD
            AND DPC.PRC_LIST_TP_CD   = PLT.PRC_LIST_TP_CD
            AND PC.EZCANCELFLAG      = '0'
            AND DPC.EZCANCELFLAG     = '0'
            AND PLT.EZCANCELFLAG     = '0'
            AND ROWNUM               = 1
    </statement>

    <statement id="getMdlIdList" parameterClass="Map" resultClass="BigDecimal">
        SELECT DISTINCT
                  CV.MDL_ID
            FROM
                <!-- START 2018/07/09 K.Kojima [QC#27135,MOD] -->
                <!-- DS_CPO_CONFIG_V         CV -->
                <!-- , CPO_DTL_V             DV -->
                  DS_CPO_CONFIG         CV
                , CPO_DTL               DV
                <!-- END 2018/07/09 K.Kojima [QC#27135,MOD] -->
                , DS_CONTR_DTL          DCD
            WHERE
                CV.GLBL_CMPY_CD             = #glblCmpyCd#
                AND CV.CPO_ORD_NUM          = #cpoOrdNum#
                AND CV.CONFIG_CATG_CD       = #configCatgOutbound#
                AND CV.EZCANCELFLAG         = '0'
                -- 
                AND CV.GLBL_CMPY_CD         = DV.GLBL_CMPY_CD
                AND CV.CPO_ORD_NUM          = DV.CPO_ORD_NUM
                AND CV.DS_ORD_POSN_NUM      = DV.DS_ORD_POSN_NUM
                AND DV.EZCANCELFLAG         = '0'
                --
                AND DV.GLBL_CMPY_CD         = DCD.GLBL_CMPY_CD
                AND DV.CPO_ORD_NUM          = DCD.CPO_ORD_NUM
                AND DV.CPO_DTL_LINE_NUM     = DCD.CPO_DTL_LINE_NUM
                AND DV.CPO_DTL_LINE_SUB_NUM = DCD.CPO_DTL_LINE_SUB_NUM
                AND DCD.DS_CONTR_PK         = #dsContrPk#
                AND DCD.EZCANCELFLAG        = '0'
    </statement>

    <statement id="getDclnSvcPosnList" parameterClass="Map" resultClass="String">
          SELECT 
                 DCC.DS_ORD_POSN_NUM
          FROM 
                 DS_CPO_CONFIG DCC
          WHERE 
                 DCC.GLBL_CMPY_CD   = #glblCmpyCd#
            AND DCC.CPO_ORD_NUM     = #cpoOrdNum#
            AND DCC.DCLN_SVC_CD     = #dclnSvcCd#
            AND DCC.CONFIG_CATG_CD  = #configCatgOutbound#
            AND DCC.EZCANCELFLAG    = '0'
    </statement>

    <statement id="getPrcListStruTpFromPrcCatg" parameterClass="Map" resultClass="String">
        SELECT
                PLT.PRC_LIST_STRU_TP_CD
            FROM
                 PRC_CATG    DPC
               , PRC_LIST_TP PLT
            WHERE 
                DPC.GLBL_CMPY_CD    = #glblCmpyCd#
            AND DPC.EZCANCELFLAG    = '0'
            AND DPC.PRC_CATG_CD     = #prcCatgCd#
            AND DPC.ACTV_FLG        = 'Y'
            ANd DPC.DEL_FLG         = 'N'
            AND DPC.EFF_FROM_DT    &lt;= #slsDt#
            AND (
                DPC.EFF_THRU_DT    &gt;= #slsDt#
             OR DPC.EFF_THRU_DT    IS NULL
            )
            AND DPC.GLBL_CMPY_CD    = PLT.GLBL_CMPY_CD
            AND DPC.EZCANCELFLAG    = PLT.EZCANCELFLAG
            AND DPC.PRC_LIST_TP_CD  = PLT.PRC_LIST_TP_CD
            AND ROWNUM              = #rownum1#
    </statement>

    <statement id="getCountPrcListBandForService" parameterClass="Map" resultClass="Integer">
        SELECT
                  COUNT(PLB.GLBL_CMPY_CD)   CNT
            FROM
                PRC_LIST_SVC        PLS
                , PRC_LIST_BAND     PLB
            WHERE
                PLS.GLBL_CMPY_CD                = #glblCmpyCd#
                AND PLS.PRC_CATG_CD             = #prcCatgCd#
                AND PLS.MDL_ID                  = #mdlId#
                AND PLS.PRC_MTR_PKG_PK          = #prcMtrPkgPk#
                AND PLS.PRC_SVC_PLN_TP_CD       = #prcSvcPlnTpCd#
                AND PLS.PRC_SVC_CONTR_TP_CD     = #prcSvcContrTpCd#
                AND PLS.BLLG_MTR_LB_CD          = #bllgMtrLbCd#
                AND PLS.PRC_RATE_TP_CD         IN (#cpc#, #annual#)
                AND PLS.EFF_FROM_DT            &lt;= #slsDt#
                AND ( 
                    PLS.EFF_THRU_DT            IS NULL 
                    OR PLS.EFF_THRU_DT         &gt;= #slsDt#
                ) 
                AND PLS.TERM_FROM_MTH_AOT      &lt;= #termMth#
                AND (
                    PLS.TERM_THRU_MTH_AOT      IS NULL
                    OR PLS.TERM_THRU_MTH_AOT   &gt;= #termMth#
                )
                AND PLS.EZCANCELFLAG            = '0'
                                --
                AND PLS.GLBL_CMPY_CD            = PLB.GLBL_CMPY_CD
                AND PLS.PRC_LIST_BAND_CD        = PLB.PRC_LIST_BAND_CD
                AND PLB.PRC_LIST_BAND_DESC_TXT  = #prcListBandCd#
                AND PLB.EZCANCELFLAG            = '0'
    </statement>

    <statement id="getCountPrcListBandForServiceTiers" parameterClass="Map" resultClass="Integer">
        SELECT
                  COUNT(PLST.GLBL_CMPY_CD)      CNT
            FROM
                PRC_LIST_SVC_TIER       PLST
                , PRC_LIST_BAND         PLB
            WHERE
                PLST.GLBL_CMPY_CD               = #glblCmpyCd#
                AND PLST.PRC_CATG_CD            = #prcCatgCd#
                AND PLST.MDL_ID                 = #mdlId#
                AND PLST.PRC_MTR_PKG_PK         = #prcMtrPkgPk#
                AND PLST.PRC_SVC_PLN_TP_CD      = #prcSvcPlnTpCd#
                AND PLST.PRC_SVC_CONTR_TP_CD    = #prcSvcContrTpCd#
                AND PLST.BLLG_MTR_LB_CD         = #bllgMtrLbCd#
                AND PLST.EFF_FROM_DT           &lt;= #slsDt#
                AND (
                    PLST.EFF_THRU_DT           IS NULL
                    OR PLST.EFF_THRU_DT        &gt;= #slsDt#
                ) 
                AND PLST.TERM_FROM_MTH_AOT     &lt;= #termMth#
                AND ( 
                    PLST.TERM_THRU_MTH_AOT     IS NULL 
                    OR PLST.TERM_THRU_MTH_AOT  &gt;= #termMth#
                ) 
                AND PLST.EZCANCELFLAG           = '0'
                               --
                AND PLST.GLBL_CMPY_CD           = PLB.GLBL_CMPY_CD
                AND PLST.PRC_LIST_BAND_CD       = PLB.PRC_LIST_BAND_CD
                AND PLB.PRC_LIST_BAND_DESC_TXT  = #prcListBandCd#
                AND PLB.EZCANCELFLAG            = '0'
    </statement>

    <statement id="getCountPrcListBandForSupplyProgram" parameterClass="Map" resultClass="Integer">
        SELECT
                  COUNT(PLB.GLBL_CMPY_CD) CNT
            FROM
                PRC_LIST_SPLY_PGM   PLSP
                , PRC_LIST_BAND     PLB
            WHERE
                PLSP.GLBL_CMPY_CD               = #glblCmpyCd#
                AND PLSP.MDL_ID                 = #mdlId#
                AND PLSP.PRC_MTR_PKG_PK         = #prcMtrPkgPk#
                AND PLSP.PRC_SVC_PLN_TP_CD      = #prcSvcPlnTpCd#
                AND PLSP.PRC_SVC_CONTR_TP_CD    = #prcSvcContrTpCd#
                AND PLSP.BLLG_MTR_LB_CD         = #bllgMtrLbCd#
                AND PLSP.PRC_CATG_CD            = #prcCatgCd#
                AND PLSP.EFF_FROM_DT           &lt;= #slsDt#
                AND ( 
                    PLSP.EFF_THRU_DT           IS NULL 
                    OR PLSP.EFF_THRU_DT        &gt;= #slsDt#
                ) 
                AND PLSP.TERM_FROM_MTH_AOT     &lt;= #termMth#
                AND (
                    PLSP.TERM_THRU_MTH_AOT     IS NULL
                    OR PLSP.TERM_THRU_MTH_AOT  &gt;= #termMth#
                )
                AND PLSP.EZCANCELFLAG           = '0'
                               --
                AND PLSP.GLBL_CMPY_CD           = PLB.GLBL_CMPY_CD
                AND PLSP.PRC_LIST_BAND_CD       = PLB.PRC_LIST_BAND_CD
                AND PLB.PRC_LIST_BAND_CD        = #prcListBandCd#
                AND PLB.EZCANCELFLAG            = '0'
                AND (
                    PLSP.SPLY_AGMT_PLN_PK      IS NULL
                    OR (
                        EXISTS (
                            SELECT
                                      1
                                FROM
                                    SPLY_AGMT_PLN   SAP
                                WHERE
                                    PLSP.GLBL_CMPY_CD           = SAP.GLBL_CMPY_CD
                                    AND PLSP.SPLY_AGMT_PLN_PK   = SAP.SPLY_AGMT_PLN_PK
                                    AND SAP.EFF_FROM_DT        &lt;= #slsDt#
                                    AND (
                                        SAP.EFF_THRU_DT        IS NULL
                                        OR SAP.EFF_THRU_DT     &gt;= #slsDt#
                                    )
                                    AND SAP.ACTV_FLG            = 'Y'
                                    AND SAP.DEL_FLG             = 'N'
                                    AND SAP.EZCANCELFLAG        = '0'
                        )
                    )
                ) 
    </statement>

    <statement id="cntRentalOrder" parameterClass="Map" resultClass="Integer">
        SELECT
                  COUNT(DC.GLBL_CMPY_CD)    CNT
            FROM
                ORD_CATG_BIZ_CTX    BC
                , CPO               DC
            WHERE
                BC.GLBL_CMPY_CD             = #glblCmpyCd#
                AND BC.ORD_CATG_CTX_TP_CD   = #ordCatgCtxTpCd# -- 'RENTAL_ORDER'
                AND BC.EZCANCELFLAG         = '0'
                AND BC.GLBL_CMPY_CD         = DC.GLBL_CMPY_CD
                AND BC.DS_ORD_CATG_CD       = DC.DS_ORD_CATG_CD
                AND (
                    BC.DS_ORD_TP_CD         = DC.DS_ORD_TP_CD
                    OR BC.DS_ORD_TP_CD     IS NULL
                ) 
                AND (
                    BC.DS_ORD_RSN_CD        = DC.DS_ORD_RSN_CD
                    OR BC.DS_ORD_RSN_CD    IS NULL
                ) 
                AND DC.CPO_ORD_NUM          = #cpoOrdNum#
                AND DC.EZCANCELFLAG         = '0'
    </statement>

    <statement id="getLineNumListForRentalCheck" parameterClass="Map" resultClass="Map">
        SELECT
                  CD.CPO_DTL_LINE_NUM
                , CD.CPO_DTL_LINE_SUB_NUM
                , CASE 
                    WHEN 
                    EXISTS (
                        SELECT
                                  MTVS.GLBL_CMPY_CD
                            FROM
                                MDSE_TP_VAL_SET     MTVS
                            WHERE
                                MTVS.GLBL_CMPY_CD           = M.GLBL_CMPY_CD 
                                AND MTVS.COA_MDSE_TP_CD     = M.COA_MDSE_TP_CD 
                                AND MTVS.MDSE_TP_CTX_TP_CD IN
                                <iterate property="mdseTpCtxTpForRentalEquip" var="mdseTpCtxTpForRentalEquip[]" open=" (" close=")" conjunction=",">
                                     #mdseTpCtxTpForRentalEquip[]#
                                </iterate>
                                AND MTVS.EZCANCELFLAG       = '0'
                    ) 
                    THEN    'Y'
                    ELSE    'N'
                    END             RENTAL_FLG
                , CASE 
                    WHEN CD.BASE_CMPT_FLG = 'Y' THEN 'N'    <!-- QC#27738 -->
                    WHEN 
                    EXISTS (
                        SELECT
                                  MTVS.GLBL_CMPY_CD
                            FROM
                                MDSE_TP_VAL_SET     MTVS
                            WHERE
                                MTVS.GLBL_CMPY_CD           = M.GLBL_CMPY_CD
                                AND MTVS.COA_MDSE_TP_CD     = M.COA_MDSE_TP_CD
                                AND MTVS.MDSE_TP_CTX_TP_CD  = #mdseTpCtxCpoSvcAddlBaseItems#    -- 'CPO_SVC_ADDL_BASE_ITEMS'
                                AND MTVS.EZCANCELFLAG       = '0'
                    ) 
                    THEN 'Y'
                    ELSE 'N'
                    END         ACSRY_FLG
                    --
            FROM
                CPO                 C
                <!-- START 2018/07/09 K.Kojima [QC#27135,MOD] -->
                <!-- , CPO_DTL_V         CD -->
                , CPO_DTL           CD
                <!-- END 2018/07/09 K.Kojima [QC#27135,MOD] -->
                , ALL_MDSE_V        M
            WHERE
                C.GLBL_CMPY_CD              = #glblCmpyCd#
                AND C.CPO_ORD_NUM           = #cpoOrdNum#
                AND C.EZCANCELFLAG          = '0'
                AND CD.GLBL_CMPY_CD         = C.GLBL_CMPY_CD
                AND CD.CPO_ORD_NUM          = C.CPO_ORD_NUM
                AND CD.EZCANCELFLAG         = '0'
                AND CD.GLBL_CMPY_CD         = M.GLBL_CMPY_CD
                AND CD.MDSE_CD              = M.MDSE_CD
                AND M.INSTL_BASE_CTRL_FLG   = 'Y'
                AND M.EZCANCELFLAG          = '0'
                --
                AND EXISTS (
                    SELECT
                              OCBC.GLBL_CMPY_CD
                        FROM
                            ORD_CATG_BIZ_CTX OCBC
                        WHERE
                            OCBC.GLBL_CMPY_CD           = #glblCmpyCd#
                            AND OCBC.ORD_CATG_CTX_TP_CD = #ordCatgCtxTp#
                            AND OCBC.DS_ORD_CATG_CD     = C.DS_ORD_CATG_CD
                            AND ( 
                                OCBC.DS_ORD_TP_CD       = C.DS_ORD_TP_CD
                                OR OCBC.DS_ORD_TP_CD   IS NULL
                            ) 
                            AND ( 
                                OCBC.DS_ORD_RSN_CD      = C.DS_ORD_RSN_CD
                                <!-- OR OCBC.DS_ORD_TP_CD   IS NULL -->
                                OR OCBC.DS_ORD_RSN_CD  IS NULL <!-- 2019/02/05 S21_NA#30236 Mod -->
                            ) 
                            AND OCBC.EZCANCELFLAG = '0'
                )
                AND EXISTS (
                    SELECT
                              DCD.GLBL_CMPY_CD
                        FROM
                            DS_CONTR_DTL   DCD
                        WHERE
                            DCD.GLBL_CMPY_CD             = CD.GLBL_CMPY_CD
                            AND DCD.CPO_ORD_NUM          = CD.CPO_ORD_NUM
                            AND (
                                (
                                    DCD.CPO_DTL_LINE_NUM     = CD.REF_CPO_DTL_LINE_NUM
                                AND DCD.CPO_DTL_LINE_SUB_NUM = CD.REF_CPO_DTL_LINE_SUB_NUM
                                ) OR (
                                    DCD.CPO_DTL_LINE_NUM     = CD.CPO_DTL_LINE_NUM
                                AND DCD.CPO_DTL_LINE_SUB_NUM = CD.CPO_DTL_LINE_SUB_NUM
                                )
                            )
                            AND DCD.EZCANCELFLAG         = '0'
                            AND DCD.SHELL_LINE_NUM       = #shellLineNum#
                            <!-- 2019/05/08 QC#50174 Add Start -->
                            AND DCD.DS_CONTR_DTL_STS_CD  = #dsContrDtlStsCd#
                            <!-- 2019/05/08 QC#50174 Add End -->
                )
                <!-- 2019/05/08 QC#50174 Add Start -->
                AND CD.ORD_LINE_STS_CD          &lt;&gt; #ordLineStsCancel#
                <!-- 2019/05/08 QC#50174 Add End -->
    </statement>

    <statement id="cntMainMachine" parameterClass="Map" resultClass="Integer">
        SELECT
                  COUNT(D.GLBL_CMPY_CD)
            FROM
                <!-- START 2018/07/09 K.Kojima [QC#27135,MOD] -->
                <!-- CPO_DTL_V       D -->
                  CPO_DTL       D
                <!-- END 2018/07/09 K.Kojima [QC#27135,MOD] -->
                , ALL_MDSE_V    M
            WHERE
                D.GLBL_CMPY_CD              = #glblCmpyCd#
                AND D.CPO_ORD_NUM           = #cpoOrdNum#
                AND D.CPO_DTL_LINE_NUM      = #cpoDtlLineNum#
                AND D.CPO_DTL_LINE_SUB_NUM  = #cpoDtlLineSubNum#
                AND D.EZCANCELFLAG          = '0'
                --
                AND D.GLBL_CMPY_CD          = M.GLBL_CMPY_CD
                AND D.MDSE_CD               = M.MDSE_CD
                AND D.BASE_CMPT_FLG         = 'Y'
                AND M.INSTL_BASE_CTRL_FLG   = 'Y'
                AND M.EZCANCELFLAG          = '0'
    </statement>

    <statement id="getCountValidItem" parameterClass="Map" resultClass="Integer">
        SELECT
                  COUNT(CD.GLBL_CMPY_CD)    CNT
            FROM
                CPO_DTL         CD
                , ALL_MDSE_V    M
            WHERE
                CD.GLBL_CMPY_CD             = #glblCmpyCd#
                AND CD.CPO_ORD_NUM          = #cpoOrdNum#
                AND CD.CPO_DTL_LINE_NUM     = #cpoDtlLineNum#
                AND CD.CPO_DTL_LINE_SUB_NUM = #cpoDtlLineSubNum#
                AND CD.EZCANCELFLAG         = '0'
                AND CD.GLBL_CMPY_CD         = M.GLBL_CMPY_CD
                AND CD.MDSE_CD              = M.MDSE_CD
                AND M.INSTL_BASE_CTRL_FLG   = 'Y'
                AND M.EZCANCELFLAG          = '0'
              <isNotNull property="mdseTpCtxTp">
                <!-- Mod Start 2018/07/20 QC#27268 -->
                <!-- AND NOT EXISTS ( -->
                <!--     SELECT -->
                <!--               1 -->
                <!--         FROM -->
                <!--             MDSE_TP_VAL_SET MTVS  -->
                <!--         WHERE -->
                <!--             MTVS.GLBL_CMPY_CD            = M.GLBL_CMPY_CD -->
                <!--             AND MTVS.COA_MDSE_TP_CD      = M.COA_MDSE_TP_CD -->
                <!--             AND MTVS.MDSE_TP_CTX_TP_CD  IN -->
                <!--           <iterate property="mdseTpCtxTp" var="mdseTpCtxTp[]" open=" (" close=")" conjunction=","> -->
                <!--             #mdseTpCtxTp[]# -->
                <!--           </iterate> -->
                <!--             AND MTVS.EZCANCELFLAG        = '0' -->
                <!-- ) -->
                AND CD.BASE_CMPT_FLG        = 'N'
                <!-- Mod End 2018/07/20 QC#27268 -->
              </isNotNull>
    </statement>

    <statement id="getCountContr" parameterClass="Map" resultClass="Integer">
        SELECT
                  COUNT(DCD.GLBL_CMPY_CD)
            FROM
                DS_CONTR_DTL    DCD
            WHERE
                DCD.GLBL_CMPY_CD        = #glblCmpyCd#
                AND DCD.DS_CONTR_PK     = #dsContrPk#
                AND DCD.EZCANCELFLAG    = '0'
                AND EXISTS (
                    SELECT
                              1
                        FROM
                            DS_CPO_CONFIG       DCC
                            , SVC_CONFIG_MSTR   SCM
                            , SVC_MACH_MSTR     SMM
                        WHERE
                            DCC.GLBL_CMPY_CD            = DCD.GLBL_CMPY_CD
                            AND DCC.CPO_ORD_NUM         = #cpoOrdNum#
                            AND DCC.EZCANCELFLAG        = '0'
                            --
                            AND DCC.GLBL_CMPY_CD        = SCM.GLBL_CMPY_CD
                            AND DCC.SVC_CONFIG_MSTR_PK  = SCM.SVC_CONFIG_MSTR_PK
                            AND SCM.EZCANCELFLAG        = '0'
                            --
                            AND SCM.GLBL_CMPY_CD        = SMM.GLBL_CMPY_CD
                            AND SCM.SVC_CONFIG_MSTR_PK  = SMM.SVC_CONFIG_MSTR_PK
                            AND SCM.SVC_MACH_MSTR_PK    = SMM.SVC_MACH_MSTR_PK
                            AND SMM.EZCANCELFLAG        = '0'
                )
    </statement>

    <statement id="getCountPriceBookItem" parameterClass="Map" resultClass="Integer">
        <!-- START 2018/07/09 K.Kojima [QC#27135,MOD] -->
        <!-- SELECT -->
        <!--      COUNT(M.MDSE_DESC_SHORT_TXT)     CNT -->
        <!-- FROM -->
        <!--       ITEM_TP_VAL_SET ITVS -->
        <!--     , MDSE            M -->
        <!-- WHERE -->
        <!--         ITVS.EZCANCELFLAG               = '0' -->
        <!--     AND ITVS.GLBL_CMPY_CD               = #glblCmpyCd# -->
        <!--     AND ITVS.ITEM_TP_CTX_TP_CD          = #itemTpCtxTpCd# -->
        <!--     AND ITVS.EZCANCELFLAG               = M.EZCANCELFLAG -->
        <!--     AND ITVS.GLBL_CMPY_CD               = M.GLBL_CMPY_CD -->
        <!--     AND ITVS.MDSE_ITEM_TP_CD            = M.MDSE_ITEM_TP_CD -->
        <!--     AND ITVS.FIRST_BIZ_CTX_ATTRB_TXT    = M.DS_INTG_MDSE_TP_CD -->
        <!--     AND M.RGTN_STS_CD                   = #rgtnStsCd# -->
        <!--     AND M.MDSE_CD                       = NVL( -->
        <!--                                         ( -->
        <!--                                             SELECT -->
        <!--                                                       OTM.MDSE_CD -->
        <!--                                                 FROM -->
        <!--                                                     ORD_TAKE_MDSE   OTM -->
        <!--                                                 WHERE -->
        <!--                                                     OTM.ORD_TAKE_MDSE_CD = #mdseCd# -->
        <!--                                                     AND OTM.EZCANCELFLAG = M.EZCANCELFLAG -->
        <!--                                                     AND OTM.GLBL_CMPY_CD = M.GLBL_CMPY_CD -->
        <!--                                         ) -->
        <!--                                         , #mdseCd# -->
        <!--                                     ) -->
        WITH ORD_TAKE AS (
            SELECT
                OTM.MDSE_CD
            FROM
                ORD_TAKE_MDSE   OTM
            WHERE
                    OTM.GLBL_CMPY_CD     = #glblCmpyCd#
                AND OTM.ORD_TAKE_MDSE_CD = #mdseCd#
                AND OTM.EZCANCELFLAG     = '0'
        )
        SELECT
            SUM(CNT) AS CNT
        FROM
            (
                SELECT
                    COUNT(M.MDSE_DESC_SHORT_TXT) AS CNT
                FROM
                     ITEM_TP_VAL_SET ITVS
                    ,MDSE            M
                WHERE
                        ITVS.GLBL_CMPY_CD               = #glblCmpyCd#
                    AND ITVS.ITEM_TP_CTX_TP_CD          = #itemTpCtxTpCd#
                    AND ITVS.EZCANCELFLAG               = '0'
                    AND ITVS.GLBL_CMPY_CD               = M.GLBL_CMPY_CD
                    AND ITVS.MDSE_ITEM_TP_CD            = M.MDSE_ITEM_TP_CD
                    AND ITVS.FIRST_BIZ_CTX_ATTRB_TXT    = M.DS_INTG_MDSE_TP_CD
                    AND M.RGTN_STS_CD                   = #rgtnStsCd#
                    AND M.EZCANCELFLAG                  = '0'
                    AND EXISTS(SELECT 1 FROM ORD_TAKE OT WHERE OT.MDSE_CD = M.MDSE_CD)
                UNION ALL
                SELECT
                    COUNT(M.MDSE_DESC_SHORT_TXT) AS CNT
                FROM
                     ITEM_TP_VAL_SET ITVS
                    ,MDSE            M
                WHERE
                        ITVS.GLBL_CMPY_CD               = #glblCmpyCd#
                    AND ITVS.ITEM_TP_CTX_TP_CD          = #itemTpCtxTpCd#
                    AND ITVS.EZCANCELFLAG               = '0'
                    AND ITVS.GLBL_CMPY_CD               = M.GLBL_CMPY_CD
                    AND ITVS.MDSE_ITEM_TP_CD            = M.MDSE_ITEM_TP_CD
                    AND ITVS.FIRST_BIZ_CTX_ATTRB_TXT    = M.DS_INTG_MDSE_TP_CD
                    AND M.RGTN_STS_CD                   = #rgtnStsCd#
                    AND M.MDSE_CD                       = #mdseCd#
                    AND M.EZCANCELFLAG                  = '0'
                    AND NOT EXISTS(SELECT 1 FROM ORD_TAKE)
            )
        <!-- END 2018/07/09 K.Kojima [QC#27135,MOD] -->
    </statement>

    <statement id="getCountPrcCatg" parameterClass="Map" resultClass="Integer">
        SELECT
                  COUNT(PC.PRC_CATG_CD)     CNT
            FROM
                PRC_CATG        PC
            WHERE
                PC.GLBL_CMPY_CD      = #glblCmpyCd#
                AND PC.PRC_CATG_CD   = #prcCatgCd#
                AND PC.EZCANCELFLAG  = '0'
                --
                AND PC.EFF_FROM_DT &lt;= #slsDt#
                AND (
                    PC.EFF_THRU_DT     IS NULL
                    OR PC.EFF_THRU_DT &gt;= #slsDt#
                )
                AND PC.ACTV_FLG     = 'Y'
                AND PC.DEL_FLG      = 'N'
    </statement>

    <statement id="getTierInfoForAggregate" parameterClass="Map" resultClass="Map">
        SELECT
                  COUNT(DCBM.XS_CHRG_TP_CD)  CNT
                , DCBM.XS_CHRG_TP_CD
            FROM
                DS_CONTR_DTL          DCD
                , DS_CONTR_BLLG_MTR   DCBM
            WHERE
                    DCD.GLBL_CMPY_CD       = #glblCmpyCd#
                AND DCD.CPO_ORD_NUM        = #cpoOrdNum#
                AND DCD.SHELL_LINE_NUM     = #shellLineNum#
                AND DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCd#
                AND DCD.EZCANCELFLAG       = '0'
                AND DCD.GLBL_CMPY_CD       = DCBM.GLBL_CMPY_CD
                AND DCD.DS_CONTR_DTL_PK    = DCBM.DS_CONTR_DTL_PK
                AND DCBM.EZCANCELFLAG      = '0'
            GROUP BY
                DCBM.XS_CHRG_TP_CD
    </statement>

    <statement id="getNumOfTierLineError" parameterClass="Map" resultClass="Map">
        SELECT
                  COUNT(CXC.PRC_SVC_TIER_TP_CD) CNT
                , DCD.DS_CONTR_DTL_PK
                , DCBM.BLLG_MTR_LB_CD 
            FROM
                DS_CONTR_DTL          DCD
                , DS_CONTR_BLLG_MTR   DCBM
                , CONTR_XS_COPY       CXC
            WHERE
                    DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                AND DCD.CPO_ORD_NUM           = #cpoOrdNum#
                AND DCD.SHELL_LINE_NUM        = #shellLineNum#
                AND DCD.DS_CONTR_DTL_TP_CD    = #dsContrDtlTpCd#
                AND DCD.EZCANCELFLAG          = '0'
                AND DCD.GLBL_CMPY_CD          = DCBM.GLBL_CMPY_CD
                AND DCD.DS_CONTR_DTL_PK       = DCBM.DS_CONTR_DTL_PK
                AND DCBM.EZCANCELFLAG         = '0'
                AND DCBM.GLBL_CMPY_CD         = CXC.GLBL_CMPY_CD
                AND DCBM.DS_CONTR_BLLG_MTR_PK = CXC.DS_CONTR_BLLG_MTR_PK
                AND CXC.PRC_SVC_TIER_TP_CD    IS NOT NULL
                AND CXC.EZCANCELFLAG          = '0'
            GROUP BY
                DCD.DS_CONTR_DTL_PK
                , DCBM.BLLG_MTR_LB_CD
            HAVING
                COUNT(CXC.PRC_SVC_TIER_TP_CD) &lt; #minNum#    -- 2
    </statement>

    <statement id="getCountMtrPkgForAggregate" parameterClass="Map" resultClass="Map">
        SELECT
                  COUNT(DCD.PRC_MTR_PKG_PK)  CNT
                , DCD.PRC_MTR_PKG_PK
            FROM
                DS_CONTR_DTL          DCD
            WHERE
                    DCD.GLBL_CMPY_CD       = #glblCmpyCd#
                AND DCD.CPO_ORD_NUM        = #cpoOrdNum#
                AND DCD.SHELL_LINE_NUM     = #shellLineNum#
                AND DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCd#
                AND DCD.EZCANCELFLAG       = '0'
            GROUP BY
                DCD.PRC_MTR_PKG_PK
    </statement>

    <statement id="getNumOfExcessChargeError" parameterClass="Map" resultClass="Map">
        SELECT
                  WK.BLLG_MTR_LB_CD
                , WK.INTG_MDSE_CD
                , WK.PRC_SVC_TIER_TP_CD
                , COUNT(WK.XS_MTR_AMT_RATE)     CNT
            FROM
                ( 
                    SELECT
                              DCBM.BLLG_MTR_LB_CD
                            , DCBM.INTG_MDSE_CD
                            , CXC.PRC_SVC_TIER_TP_CD
                            , CXC.XS_MTR_AMT_RATE
                        FROM
                            DS_CONTR_DTL          DCD
                            , DS_CONTR_BLLG_MTR   DCBM
                            , CONTR_XS_COPY       CXC
                        WHERE
                                DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                            AND DCD.CPO_ORD_NUM           = #cpoOrdNum#
                            AND DCD.SHELL_LINE_NUM        = #shellLineNum#
                            AND DCD.DS_CONTR_DTL_TP_CD    = #dsContrDtlTpCd#
                            AND DCD.EZCANCELFLAG          = '0'
                            AND DCD.GLBL_CMPY_CD          = DCBM.GLBL_CMPY_CD
                            AND DCD.DS_CONTR_DTL_PK       = DCBM.DS_CONTR_DTL_PK
                            AND DCBM.EZCANCELFLAG         = '0'
                            AND DCBM.GLBL_CMPY_CD         = CXC.GLBL_CMPY_CD
                            AND DCBM.DS_CONTR_BLLG_MTR_PK = CXC.DS_CONTR_BLLG_MTR_PK
                            AND CXC.EZCANCELFLAG          = '0'
                        GROUP BY
                            DCBM.BLLG_MTR_LB_CD
                            , DCBM.INTG_MDSE_CD
                            , CXC.PRC_SVC_TIER_TP_CD
                            , CXC.XS_MTR_AMT_RATE
                ) WK
            GROUP BY
                WK.BLLG_MTR_LB_CD
                , WK.INTG_MDSE_CD
                , WK.PRC_SVC_TIER_TP_CD
            HAVING
                COUNT(WK.XS_MTR_AMT_RATE) > #minNum#    -- 1
    </statement>

    <statement id="getSplyAgmtPlnInfo" parameterClass="Map" resultClass="Map">
        SELECT
             A.SPLY_AGMT_PLN_PK
            ,A.SPLY_BASE_AMT
            ,B.SPLY_AGMT_PLN_TP_CD
            ,B.SPLY_AGMT_DOC_TP_CD
            ,B.ANN_TERM_CAP_NUM
            ,B.ANN_TERM_CAP_NUM * TRUNC(#termMthNum# / #numberOfMonths#) AS QTY_CONTR_CAP_QTY
            ,C.MDSE_CD
            ,NVL(C.SPLY_AGMT_PLN_FIRST_QTY, 0)  SPLY_AGMT_PLN_FIRST_QTY
            ,NVL(C.SPLY_AGMT_PLN_QTY, 0)        SPLY_AGMT_PLN_QTY
            ,C.SPLY_AGMT_FREQ_TP_CD
            ,#dsContrPk#             AS DS_CONTR_PK
            ,#cpoOrdNum#             AS CPO_ORD_NUM
            <isNull property="dsContrDtlPk">
            ,NULL                    AS DS_CONTR_DTL_PK
            </isNull>
            <isNotNull property="dsContrDtlPk">
            ,#dsContrDtlPk#          AS DS_CONTR_DTL_PK
            </isNotNull>
        FROM
             PRC_LIST_SPLY_PGM A
            ,SPLY_AGMT_PLN     B
            ,SPLY_AGMT_PLN_DTL C
        WHERE
             A.GLBL_CMPY_CD        = #glblCmpyCd#
        AND  A.PRC_CATG_CD         = #prcCatgCd#
        AND  A.MDL_ID              = #mdlId#
        AND  A.PRC_MTR_PKG_PK      = #prcMtrPkgPk#
        AND  A.PRC_SVC_PLN_TP_CD   = #prcSvcPlnTpCd#
        AND  A.PRC_SVC_CONTR_TP_CD = #prcSvcContrTpCd#
        
        AND  A.BLLG_MTR_LB_CD      = #bllgMtrLbCd#
        <isNull property="prcListBandCd">
        AND  A.PRC_LIST_BAND_CD    IS NULL
        </isNull>
        <isNotNull property="prcListBandCd">
        AND  A.PRC_LIST_BAND_CD    = #prcListBandCd#
        </isNotNull>
        <!-- QC#27005 -->
        AND  A.EFF_FROM_DT        &lt;= #slsDt#
        AND ( 
            A.EFF_THRU_DT         IS NULL
            OR A.EFF_THRU_DT      &gt;= #slsDt#
        ) 
        AND  A.DEL_FLG             = 'N'
        --
        AND  A.EZCANCELFLAG        = '0'

        AND  A.GLBL_CMPY_CD        = B.GLBL_CMPY_CD
        AND  A.SPLY_AGMT_PLN_PK    = B.SPLY_AGMT_PLN_PK
        AND  B.EZCANCELFLAG        = '0'
        <!-- START 2020/09/15 K.Kitachi [QC#57629, ADD] -->
        AND  B.EFF_FROM_DT        &lt;= #slsDt#
        AND (
            B.EFF_THRU_DT         IS NULL
            OR B.EFF_THRU_DT      &gt;= #slsDt#
        )
        AND  B.ACTV_FLG            = 'Y'
        AND  B.DEL_FLG             = 'N'
        <!-- END 2020/09/15 K.Kitachi [QC#57629, ADD] -->

        AND  B.GLBL_CMPY_CD        = C.GLBL_CMPY_CD
        AND  B.SPLY_AGMT_PLN_PK    = C.SPLY_AGMT_PLN_PK
        AND  C.EZCANCELFLAG        = '0'
        <!-- START 2020/09/15 K.Kitachi [QC#57629, ADD] -->
        AND  C.EFF_FROM_DT        &lt;= #slsDt#
        AND (
            C.EFF_THRU_DT         IS NULL
            OR C.EFF_THRU_DT      &gt;= #slsDt#
        )
        AND  C.DEL_FLG             = 'N'
        <!-- END 2020/09/15 K.Kitachi [QC#57629, ADD] -->
    </statement>

    <statement id="getSplyAgmtPlnPk" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             SPLY_AGMT_PLN_PK
        FROM
             PRC_LIST_SPLY_PGM
        WHERE
             GLBL_CMPY_CD          = #glblCmpyCd#
        AND  PRC_CATG_CD           = #prcCatgCd#
        AND  PRC_SVC_PLN_TP_CD     = #prcSvcPlnTpCd#
        AND  PRC_SVC_CONTR_TP_CD   = #prcSvcContrTpCd#

        <isNull property="mdlId">
        AND  MDL_ID                IS NULL
        </isNull>
        <isNotNull property="mdlId">
        AND  MDL_ID                = #mdlId#
        </isNotNull>

        <isNull property="prcMtrPkgPk">
        AND  PRC_MTR_PKG_PK        IS NULL
        </isNull>
        <isNotNull property="prcMtrPkgPk">
        AND  PRC_MTR_PKG_PK        = #prcMtrPkgPk#
        </isNotNull>

        <isNull property="bllgMtrLbCd">
        AND  BLLG_MTR_LB_CD        IS NULL
        </isNull>
        <isNotNull property="bllgMtrLbCd">
        AND  BLLG_MTR_LB_CD        = #bllgMtrLbCd#
        </isNotNull>

        <isNull property="prcListBandCd">
        AND  PRC_LIST_BAND_CD      IS NULL
        </isNull>
        <isNotNull property="prcListBandCd">
        AND  PRC_LIST_BAND_CD      = #prcListBandCd#
        </isNotNull>

        AND  EZCANCELFLAG          = '0'
        AND  ROWNUM                = 1
    </statement>

    <statement id="getSplyAgmtParam" parameterClass="Map" resultClass="Map">
        SELECT
              DCD.DS_CONTR_DTL_PK
            , DCD.PRC_CATG_CD         AS MAINT_PRC_CATG_CD
            , DCD.MDL_ID
            , DCD.PRC_MTR_PKG_PK
            , DC.PRC_SVC_PLN_TP_CD
            , DC.PRC_SVC_CONTR_TP_CD
            , DCBM.BLLG_MTR_LB_CD
            , DCBM.PRC_LIST_BAND_CD
            , DCBM.INTG_MDSE_CD       AS USG_MDSE_CD
            , (DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1) AS TERM_MTH_NUM
        FROM
              DS_CONTR_DTL             DCD
            , DS_CONTR                 DC
            , DS_CONTR_BLLG_MTR        DCBM
            , CONTR_PHYS_BLLG_MTR_RELN CPBMR
            , CONTR_XS_COPY            CXC
            , MTR_LB                   ML
        WHERE
                DCD.GLBL_CMPY_CD          = #glblCmpyCd#
            AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
            AND DCD.EZCANCELFLAG          = '0'
            --
            AND DCD.GLBL_CMPY_CD          = DC.GLBL_CMPY_CD
            AND DCD.DS_CONTR_PK           = DC.DS_CONTR_PK
            AND DC.EZCANCELFLAG           = '0'
            --
            AND DCD.GLBL_CMPY_CD          = DCBM.GLBL_CMPY_CD
            AND DCD.DS_CONTR_DTL_PK       = DCBM.DS_CONTR_DTL_PK
            AND DCBM.EZCANCELFLAG         = '0'
            --
            AND DCBM.GLBL_CMPY_CD         = CPBMR.GLBL_CMPY_CD
            AND DCBM.DS_CONTR_BLLG_MTR_PK = CPBMR.DS_CONTR_BLLG_MTR_PK
            AND CPBMR.EZCANCELFLAG        = '0'
            --
            AND DCBM.GLBL_CMPY_CD         = CXC.GLBL_CMPY_CD
            AND DCBM.DS_CONTR_BLLG_MTR_PK = CXC.DS_CONTR_BLLG_MTR_PK
            AND CXC.EZCANCELFLAG          = '0'
            --
            AND CPBMR.GLBL_CMPY_CD        = ML.GLBL_CMPY_CD(+)
            AND CPBMR.REG_MTR_LB_CD       = ML.MTR_LB_CD(+)
            AND ML.EZCANCELFLAG(+)        = '0'
        ORDER BY
              DCD.MDL_ID                  NULLS LAST
            , DCBM.BLLG_MTR_LB_CD
            , DCBM.INTG_MDSE_CD           NULLS LAST
            , CXC.XS_MTR_COPY_QTY
            , ML.MTR_LB_SORT_NUM          NULLS FIRST
    </statement>

    <statement id="getSchdCratTmplPkForDelete" parameterClass="Map" resultClass="BigDecimal">
        SELECT
                SCT.SCHD_CRAT_TMPL_PK
        FROM
                DS_CONTR_DTL        DCD
               ,SCHD_CRAT_TMPL_LINE SCTL
               ,SCHD_CRAT_TMPL      SCT
        WHERE
                DCD.GLBL_CMPY_CD           = #glblCmpyCd#
        AND     DCD.DS_CONTR_DTL_PK        = #dsContrDtlPk#
<!-- QC#17668 MOD START -->
<!--        AND     DCD.EZCANCELFLAG           = '0' -->
<!-- QC#17668 MOD END   -->
        AND     DCD.GLBL_CMPY_CD           = SCTL.GLBL_CMPY_CD
        AND     DCD.DS_CONTR_DTL_PK        = SCTL.DS_CONTR_DTL_PK
        AND     SCTL.EZCANCELFLAG          = '0'
        AND     SCTL.GLBL_CMPY_CD          = SCT.GLBL_CMPY_CD
        AND     SCTL.SCHD_CRAT_TMPL_PK     = SCT.SCHD_CRAT_TMPL_PK
        AND     SCT.EZCANCELFLAG           = '0'
        GROUP BY
                SCT.SCHD_CRAT_TMPL_PK
    </statement>

    <statement id="getSchdCratTmplLinePkForDelete" parameterClass="Map" resultClass="Map">
        SELECT
                SCTL.SCHD_CRAT_TMPL_PK
               ,SCTL.SCHD_CRAT_TMPL_LINE_NUM
        FROM
                DS_CONTR_DTL        DCD
               ,SCHD_CRAT_TMPL_LINE SCTL
        WHERE
                DCD.GLBL_CMPY_CD           = #glblCmpyCd#
        AND     DCD.DS_CONTR_DTL_PK        = #dsContrDtlPk#
<!-- QC#17668 MOD START -->
<!--        AND     DCD.EZCANCELFLAG           = '0' -->
<!-- QC#17668 MOD END   -->
        AND     DCD.GLBL_CMPY_CD           = SCTL.GLBL_CMPY_CD
        AND     DCD.DS_CONTR_DTL_PK        = SCTL.DS_CONTR_DTL_PK
        AND     SCTL.EZCANCELFLAG          = '0'
        GROUP BY
                SCTL.SCHD_CRAT_TMPL_PK
               ,SCTL.SCHD_CRAT_TMPL_LINE_NUM
    </statement>

    <statement id="getCpoInfo" parameterClass="Map" resultClass="Map">
        SELECT
                C.CPO_ORD_NUM
               ,C.DS_ORD_TP_CD
               ,C.CUST_ISS_PO_NUM
               ,C.CUST_ISS_PO_DT
               ,C.SYS_SRC_CD
               ,NULL  AS SYS_SRC_REF_NUM
               ,C.CPO_SRC_TP_CD
               ,C.ORD_SRC_REF_NUM
<!-- QC#20228 ADD START -->
               ,C.DS_ORD_CATG_CD
<!-- QC#20228 ADD END   -->
        FROM
                CPO    C
        WHERE
                C.GLBL_CMPY_CD  = #glblCmpyCd#
            AND C.CPO_ORD_NUM   = #cpoOrdNum#
            AND C.EZCANCELFLAG  = '0'
            AND ROWNUM          = 1
    </statement>

<!-- QC#20228 ADD START -->
    <statement id="getOrdCatgBizCtxInfo" parameterClass="Map" resultClass="Map">
        SELECT
                OCBC.SCD_BIZ_CTX_ATTRB_TXT
        FROM
                ORD_CATG_BIZ_CTX  OCBC
        WHERE
                OCBC.GLBL_CMPY_CD       = #glblCmpyCd#
            AND OCBC.DS_ORD_CATG_CD     = #dsOrdCatgCd#
<!-- START 2019/06/17 W.Honda [QC#50842,MOD] -->
            <!-- AND OCBC.DS_ORD_TP_CD       = #dsOrdTpCd# -->
            AND (OCBC.DS_ORD_TP_CD       = #dsOrdTpCd#
                OR  OCBC.DS_ORD_TP_CD    IS NULL)
<!-- END 2019/06/17 W.Honda [QC#50842,MOD] -->
            AND OCBC.ORD_CATG_CTX_TP_CD = #ordCatgCtxTpCd#  -- 'SCHD_ORD_RSN_MAP'
            AND (OCBC.THIRD_BIZ_CTX_ATTRB_TXT = #splyAgmtPlnTpCd# OR OCBC.THIRD_BIZ_CTX_ATTRB_TXT IS NULL)
            AND OCBC.EZCANCELFLAG       = '0'
    </statement>
<!-- QC#20228 ADD END -->

    <statement id="getSchdCratTmplWOConfig" parameterClass="Map" resultClass="Map">
        SELECT
                 SCTL.SCHD_CRAT_TMPL_PK
                ,SCTL.SCHD_CRAT_TMPL_LINE_NUM
        FROM
                 SCHD_CRAT_TMPL      SCT
                ,SCHD_CRAT_TMPL_LINE SCTL
        WHERE
                 SCTL.GLBL_CMPY_CD    = #glblCmpyCd#
        AND      NOT EXISTS ( 
                             SELECT
                                     DCD.GLBL_CMPY_CD
                             FROM
                                     DS_CONTR_DTL DCD
                             WHERE
                                     DCD.GLBL_CMPY_CD             = SCTL.GLBL_CMPY_CD
                             AND     DCD.DS_CONTR_DTL_PK          = SCTL.DS_CONTR_DTL_PK
                             AND     DCD.EZCANCELFLAG             = '0'
                            )
        AND      SCTL.EZCANCELFLAG      = '0'
        AND      SCTL.GLBL_CMPY_CD      = SCT.GLBL_CMPY_CD
        AND      SCTL.SCHD_CRAT_TMPL_PK = SCT.SCHD_CRAT_TMPL_PK
        AND      SCT.REF_CPO_ORD_NUM    = #refCpoOrdNum#
        AND      SCT.EZCANCELFLAG       = '0'
        GROUP BY SCTL.SCHD_CRAT_TMPL_PK
                ,SCTL.SCHD_CRAT_TMPL_LINE_NUM
    </statement>

    <statement id="cntOverlappingTerm" parameterClass="Map" resultClass="Integer">
        SELECT
                  COUNT(DCD.GLBL_CMPY_CD)   CNT
            FROM
                DS_CONTR_DTL                DCD
                <!-- START 2018/07/09 K.Kojima [QC#27135,MOD] -->
                <!-- , CPO_DTL_V                 CDV -->
                , CPO_DTL                   CDV
                <!-- END 2018/07/09 K.Kojima [QC#27135,MOD] -->
                , DS_CONTR_BLLG_MTR         DCBM
                , CONTR_PHYS_BLLG_MTR_RELN  CPBMR
            WHERE
                    DCD.GLBL_CMPY_CD           = #glblCmpyCd#
                AND DCD.CPO_ORD_NUM            = #cpoOrdNum#
                AND DCD.SHELL_LINE_NUM        != #shellLineNum#
                AND DCD.EZCANCELFLAG           = '0'
                --
                AND DCD.GLBL_CMPY_CD           = CDV.GLBL_CMPY_CD
                AND DCD.CPO_ORD_NUM            = CDV.CPO_ORD_NUM
                AND DCD.CPO_DTL_LINE_NUM       = CDV.CPO_DTL_LINE_NUM
                AND DCD.CPO_DTL_LINE_SUB_NUM   = CDV.CPO_DTL_LINE_SUB_NUM
                AND CDV.DS_ORD_POSN_NUM        = #dsOrdPosnNum#
                AND CDV.EZCANCELFLAG           = '0'
                --
                AND DCD.GLBL_CMPY_CD           = DCBM.GLBL_CMPY_CD
                AND DCD.DS_CONTR_DTL_PK        = DCBM.DS_CONTR_DTL_PK
                AND DCBM.EZCANCELFLAG          = '0'
                --
                AND DCBM.GLBL_CMPY_CD          = CPBMR.GLBL_CMPY_CD
                AND DCBM.DS_CONTR_BLLG_MTR_PK  = CPBMR.DS_CONTR_BLLG_MTR_PK
                AND CPBMR.EZCANCELFLAG         = '0'
                --
                AND ( 
                    ( 
                        DCD.FROM_PER_MTH_NUM          &lt;= #fromMth#
                        AND DCD.TO_PER_MTH_NUM   BETWEEN #fromMth# AND #toMth#
                    ) 
                    OR ( 
                        DCD.TO_PER_MTH_NUM            &gt;= #toMth#
                        AND DCD.FROM_PER_MTH_NUM BETWEEN #fromMth# AND #toMth#
                    ) 
                    OR ( 
                        DCD.TO_PER_MTH_NUM            &gt;= #toMth#
                        AND DCD.FROM_PER_MTH_NUM      &lt;= #fromMth#
                    ) 
                    OR ( 
                        DCD.TO_PER_MTH_NUM            &lt;= #toMth#
                        AND DCD.FROM_PER_MTH_NUM      &gt;= #fromMth#
                    )
                ) 
                AND DCBM.BLLG_MTR_LB_CD        = #bllgMtrLbCd#
                AND CPBMR.ACTV_FLG             = 'Y'
    </statement>

<!-- QC#21700 MOD START -->
    <statement id="getContractBranch" parameterClass="Map" resultClass="Map">
        SELECT
             SCCBM.SVC_CONTR_BR_CD  AS SVC_CONTR_BR_CD_SCCBM
            ,SCCBM.CONTR_ADMIN_PSN_CD
        FROM
            CPO                  DC
           ,S21_ORG              S21O
           ,SVC_CONTR_COA_BR_MAP SCCBM
        WHERE
                DC.GLBL_CMPY_CD              = #glblCmpyCd#
            AND DC.CPO_ORD_NUM               = #cpoOrdNum#
            AND DC.EZCANCELFLAG              = '0'
            AND DC.GLBL_CMPY_CD              = S21O.GLBL_CMPY_CD
            AND DC.SLS_REP_TOC_CD            = S21O.TOC_CD
            AND S21O.EZCANCELFLAG            = '0'
            AND S21O.GLBL_CMPY_CD            = SCCBM.GLBL_CMPY_CD
            AND S21O.COA_BR_CD               = SCCBM.COA_BR_CD
<!-- START 2018/01/09 M.Kidokoro [QC#20635,ADD] -->
            AND SCCBM.SVC_LINE_BIZ_CD        = #svcLineBizCd#
<!-- END 2018/01/09 M.Kidokoro [QC#20635,ADD] -->
            AND SCCBM.EZCANCELFLAG           = '0'
    </statement>

    <statement id="getEmsdContractBranch" parameterClass="Map" resultClass="Map">
        SELECT
            *
        FROM
            (
            SELECT
                 OCBC.SCD_BIZ_CTX_ATTRB_TXT   AS SVC_CONTR_BR_CD_OCBC
                ,OCBC.THIRD_BIZ_CTX_ATTRB_TXT AS CONTR_ADMIN_PSN_CD_OCBC
            FROM
                CPO                  CPO
               ,ORD_CATG_BIZ_CTX     OCBC
            WHERE
                    CPO.GLBL_CMPY_CD              = #glblCmpyCd#
                AND CPO.CPO_ORD_NUM               = #cpoOrdNum#
                AND CPO.EZCANCELFLAG              = '0'
                AND CPO.GLBL_CMPY_CD              = OCBC.GLBL_CMPY_CD
                AND CPO.DS_ORD_CATG_CD            = OCBC.DS_ORD_CATG_CD
                AND (
                        OCBC.DS_ORD_TP_CD IS NULL
                        OR (
                                OCBC.DS_ORD_TP_CD IS NOT NULL
                            AND CPO.DS_ORD_TP_CD  = OCBC.DS_ORD_TP_CD
                        )
                    )
                AND (
                        OCBC.DS_ORD_RSN_CD IS NULL
                        OR (
                                OCBC.DS_ORD_RSN_CD IS NOT NULL
                            AND CPO.DS_ORD_RSN_CD = OCBC.DS_ORD_RSN_CD
                        )
                    )
                AND OCBC.ORD_CATG_CTX_TP_CD(+)    = #emsdContrBrRep#
                AND OCBC.EZCANCELFLAG(+)          = '0'
             ORDER BY OCBC.DS_ORD_CATG_CD,OCBC.DS_ORD_TP_CD,OCBC.DS_ORD_RSN_CD
             )
         WHERE
            ROWNUM = 1
    </statement>
<!-- QC#21700 MOD END -->

<!-- START 2018/03/13 K.Kojima [QC#24263,DEL] -->
<!--     <statement id="getCtacPsnPk" parameterClass="Map" resultClass="BigDecimal"> -->
<!--         SELECT -->
<!--             A.CTAC_PSN_PK -->
<!--         FROM ( -->
<!--             SELECT -->
<!--                 DCCP.CTAC_PSN_PK -->
<!--             FROM -->
<!--                 DS_CPO_CTAC_PSN DCCP -->
<!--             WHERE -->
<!--                 DCCP.GLBL_CMPY_CD         = #glblCmpyCd# -->
<!--             AND DCCP.CPO_ORD_NUM          = #cpoOrdNum# -->
<!--             AND DCCP.CTAC_PSN_TP_CD       = #billToContact# -->
<!--             AND DCCP.EZCANCELFLAG         = '0' -->
<!--             ORDER BY -->
<!--                 DCCP.DS_CPO_CTAC_PSN_PK -->
<!--         ) A -->
<!--         WHERE -->
<!--             ROWNUM = 1 -->
<!--     </statement> -->
<!-- END 2018/03/13 K.Kojima [QC#24263,DEL] -->

    <statement id="getBillByFlg" parameterClass="Map" resultClass="Map">
        SELECT
             CSDCD.BILL_BY_BASE_FLG
            ,CSDCD.BILL_BY_USG_FLG
        FROM
            CPO_SVC_DEF_CUST_DECN   CSDCD
        WHERE
                CSDCD.GLBL_CMPY_CD        = #glblCmpyCd#
            AND CSDCD.DS_ORD_CATG_CD      = #dsOrdCatgCd#
            <!-- START 2018/02/06 K.Kojima [QC#23357,ADD] -->
            AND CSDCD.DS_ORD_TP_CD        = #dsOrdTpCd#
            <!-- END 2018/02/06 K.Kojima [QC#23357,ADD] -->
            AND CSDCD.BILL_BY_TP_CD       = #billByTpCd#
            AND CSDCD.EZCANCELFLAG        = '0'
    </statement>

    <statement id="getTocCd" parameterClass="Map" resultClass="String">
        SELECT
            SCBM.TOC_CD
        FROM
            S21_ORG             S21O
           ,SUB_CONTR_BR_MAP    SCBM
        WHERE
                S21O.GLBL_CMPY_CD            = #glblCmpyCd#
            AND S21O.TOC_CD                  = #tocCd#
            AND S21O.EZCANCELFLAG            = '0'
            AND S21O.GLBL_CMPY_CD            = SCBM.GLBL_CMPY_CD
            AND S21O.COA_BR_CD               = SCBM.SVC_CONTR_BR_CD
<!-- START 2018/01/09 M.Kidokoro [QC#20635,ADD] -->
            AND SCBM.SVC_LINE_BIZ_CD         = #svcLineBizCd#
<!-- END 2018/01/09 M.Kidokoro [QC#20635,ADD] -->
            AND SCBM.ENBL_FLG                = 'Y'
            AND SCBM.EZCANCELFLAG            = '0'
    </statement>

<!-- QC#21698 ADD START -->
    <statement id="getEmsdTocd" parameterClass="Map" resultClass="String">
        SELECT
            *
        FROM
            (
            SELECT
                DCSC.SLS_REP_TOC_CD
            FROM
                DS_CPO_SLS_CR       DCSC
               ,CPO                 CPO
               ,ORD_CATG_BIZ_CTX    OCBC
            WHERE
                    DCSC.GLBL_CMPY_CD            = #glblCmpyCd#
                AND DCSC.CPO_ORD_NUM             = #cpoOrdNum#
                AND OCBC.FIRST_BIZ_CTX_ATTRB_TXT = DCSC.SLS_REP_ROLE_TP_CD
                AND DCSC.DS_CPO_CONFIG_PK        IS NULL
                AND DCSC.SLS_CR_QUOT_FLG         = 'N'
                AND DCSC.EZCANCELFLAG            = '0'
                AND DCSC.GLBL_CMPY_CD            = CPO.GLBL_CMPY_CD
                AND DCSC.CPO_ORD_NUM             = CPO.CPO_ORD_NUM
                AND DCSC.GLBL_CMPY_CD            = OCBC.GLBL_CMPY_CD
                AND DCSC.SLS_REP_ROLE_TP_CD      = OCBC.FIRST_BIZ_CTX_ATTRB_TXT
                AND OCBC.DS_ORD_CATG_CD          = CPO.DS_ORD_CATG_CD
                AND (
                        OCBC.DS_ORD_TP_CD IS NULL
                        OR (
                                OCBC.DS_ORD_TP_CD IS NOT NULL
                            AND OCBC.DS_ORD_TP_CD = CPO.DS_ORD_TP_CD
                        )
                    )
                AND (
                        OCBC.DS_ORD_RSN_CD IS NULL
                        OR (
                                OCBC.DS_ORD_RSN_CD IS NOT NULL
                            AND OCBC.DS_ORD_RSN_CD = CPO.DS_ORD_RSN_CD
                        )
                    )
                AND OCBC.ORD_CATG_CTX_TP_CD       = #emsdContrBrRep#
                AND OCBC.EZCANCELFLAG             = '0'
             ORDER BY OCBC.DS_ORD_CATG_CD,OCBC.DS_ORD_TP_CD,OCBC.DS_ORD_RSN_CD
             )
         WHERE
            ROWNUM = 1
    </statement>
<!-- QC#21698 ADD END -->

    <statement id="getFltAggDsContrDtlPkByDB" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            DCD.DS_CONTR_DTL_PK
        FROM
            DS_CONTR_DTL   DCD
        WHERE
                DCD.GLBL_CMPY_CD        = #glblCmpyCd#
            AND DCD.DS_CONTR_PK         = #dsContrPk#
            AND DCD.DS_CONTR_DTL_TP_CD  IN (#dsContrDtlTpCd_Fleet#, #dsContrDtlTpCd_Aggregate#)
            AND DCD.EZCANCELFLAG        = '0'
    </statement>

    <statement id="getDsContrBllgMtrListForAggLine" parameterClass="Map" resultClass="Map">
        SELECT
             DCBM.BLLG_MTR_LB_CD
            ,MAX(DCBM.BLLG_MTR_BILL_TO_CUST_CD)  AS BLLG_MTR_BILL_TO_CUST_CD
            ,MAX(DCBM.BLLG_MTR_BLLG_CYCLE_CD)    AS BLLG_MTR_BLLG_CYCLE_CD
            ,MAX(DCBM.XS_CHRG_TP_CD)             AS XS_CHRG_TP_CD
            ,MAX(DCBM.CTAC_PSN_PK)               AS CTAC_PSN_PK
            ,MAX(DCBM.INTG_MDSE_CD)              AS INTG_MDSE_CD
            -- <!-- QC#25030 -->
            ,SUM(DCBM.BLLG_MIN_CNT)              AS BLLG_MIN_CNT
            ,SUM(DCBM.BLLG_MIN_AMT_RATE)         AS BLLG_MIN_AMT_RATE
            ,SUM(DCBM.BLLG_FREE_COPY_CNT)        AS BLLG_FREE_COPY_CNT
            ,MAX(DCBM.BLLG_ROLL_OVER_RATIO)      AS BLLG_ROLL_OVER_RATIO
        FROM
             DS_CONTR_DTL      DCD
            ,DS_CONTR_BLLG_MTR DCBM
        WHERE
                DCD.GLBL_CMPY_CD        = #glblCmpyCd#
            AND DCD.DS_CONTR_PK         = #dsContrPk#
            AND DCD.DS_CONTR_DTL_TP_CD  = #dsContrDtlTpCd#
            AND DCD.EZCANCELFLAG        = '0'
            AND DCD.GLBL_CMPY_CD        = DCBM.GLBL_CMPY_CD
            AND DCD.DS_CONTR_DTL_PK     = DCBM.DS_CONTR_DTL_PK
            AND DCBM.EZCANCELFLAG       = '0'
        GROUP BY
            DCBM.BLLG_MTR_LB_CD
    </statement>

    <statement id="getContrPhysBllgMtrRelnListForAggLine" parameterClass="Map" resultClass="Map">
        SELECT
             CPBMR.BLLG_MTR_LB_CD
            ,MAX(CPBMR.CONTR_MTR_MULT_RATE)  AS CONTR_MTR_MULT_RATE
            ,MAX(CPBMR.BLLG_MTR_LVL_NUM)     AS BLLG_MTR_LVL_NUM
        FROM
             DS_CONTR_DTL             DCD
            ,CONTR_PHYS_BLLG_MTR_RELN CPBMR
        WHERE
                DCD.GLBL_CMPY_CD        = #glblCmpyCd#
            AND DCD.DS_CONTR_PK         = #dsContrPk#
            AND DCD.DS_CONTR_DTL_TP_CD  = #dsContrDtlTpCd#
            AND DCD.EZCANCELFLAG        = '0'
            AND DCD.GLBL_CMPY_CD        = CPBMR.GLBL_CMPY_CD
            AND DCD.DS_CONTR_DTL_PK     = CPBMR.DS_CONTR_DTL_PK
            AND CPBMR.BLLBL_FLG         = 'Y'
            AND CPBMR.EZCANCELFLAG      = '0'
        GROUP BY
            CPBMR.BLLG_MTR_LB_CD
    </statement>

    <statement id="getContrXsCopyListForAggLine" parameterClass="Map" resultClass="Map">
        SELECT
             X.BLLG_MTR_LB_CD
            ,SUM(X.XS_MTR_COPY_QTY)  AS XS_MTR_COPY_QTY
            ,MAX(X.XS_MTR_AMT_RATE)  AS XS_MTR_AMT_RATE
            ,MAX(X.XS_MTR_FIRST_FLG) AS XS_MTR_FIRST_FLG
        FROM (
            SELECT
                 DCBM.BLLG_MTR_LB_CD
                ,CXC.XS_MTR_COPY_QTY
                ,CXC.XS_MTR_AMT_RATE
                ,CXC.XS_MTR_FIRST_FLG
                ,RANK() OVER(
                    PARTITION BY
                         CXC.DS_CONTR_BLLG_MTR_PK
                    ORDER BY
                         CXC.XS_MTR_COPY_QTY
                 ) AS RANK_QTY
            FROM
                 DS_CONTR_DTL      DCD
                ,DS_CONTR_BLLG_MTR DCBM
                ,CONTR_XS_COPY     CXC
            WHERE
                    DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                AND DCD.DS_CONTR_PK           = #dsContrPk#
                AND DCD.DS_CONTR_DTL_TP_CD    = #dsContrDtlTpCd#
                AND DCD.EZCANCELFLAG          = '0'
                AND DCD.GLBL_CMPY_CD          = DCBM.GLBL_CMPY_CD
                AND DCD.DS_CONTR_DTL_PK       = DCBM.DS_CONTR_DTL_PK
                AND DCBM.EZCANCELFLAG         = '0'
                AND DCBM.GLBL_CMPY_CD         = CXC.GLBL_CMPY_CD
                AND DCBM.DS_CONTR_BLLG_MTR_PK = CXC.DS_CONTR_BLLG_MTR_PK
                AND CXC.EZCANCELFLAG          = '0'
        ) X
        GROUP BY
             X.BLLG_MTR_LB_CD
            ,X.RANK_QTY
        ORDER BY
             X.BLLG_MTR_LB_CD
            ,X.RANK_QTY
    </statement>

    <statement id="cntNextContr" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             COUNT(*)
        FROM
             DS_CONTR_DTL DCD
        WHERE
            DCD.GLBL_CMPY_CD   = #glblCmpyCd#
        AND DCD.CPO_ORD_NUM    = #cpoOrdNum#
        AND DCD.SHELL_LINE_NUM = #shellLineNum#
        AND DCD.EZCANCELFLAG   = '0'
        AND EXISTS (
            SELECT
                1
            FROM
                 DS_CONTR_DTL    X
            WHERE
                    X.GLBL_CMPY_CD          = DCD.GLBL_CMPY_CD
                AND X.CPO_ORD_NUM           = DCD.CPO_ORD_NUM <!-- 2018/06/21 K.Ishizuka [QC#24294, Add] -->
                AND X.SVC_CONFIG_MSTR_PK    = DCD.SVC_CONFIG_MSTR_PK
                AND X.EZCANCELFLAG          = '0'
                AND X.FROM_PER_MTH_NUM      &gt; DCD.TO_PER_MTH_NUM
        )
    </statement>

    <statement id="cntTrnsfAmt" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            COUNT(*)
        FROM
<!-- START 2018/05/24 K.Kishimoto [QC#26062,MOD] -->
            CPO_DTL      DCDR
<!-- END   2018/05/24 K.Kishimoto [QC#26062,MOD] -->
        WHERE
                DCDR.GLBL_CMPY_CD            = #glblCmpyCd#
            AND DCDR.CPO_ORD_NUM             = #cpoOrdNum#
            AND DCDR.DEAL_SVC_COST_TRNSF_AMT &lt;&gt; 0
            AND DCDR.EZCANCELFLAG            = '0'
    </statement>

    <statement id="getNeedToUpdateMthDsContrDtl" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            DCD.DS_CONTR_DTL_PK
        FROM
            DS_CONTR_DTL DCD
        WHERE
                DCD.GLBL_CMPY_CD           = #glblCmpyCd#
            AND DCD.CPO_ORD_NUM            = #cpoOrdNum#
            AND DCD.SHELL_LINE_NUM         = #shellLineNum#
            AND (
                   DCD.FROM_PER_MTH_NUM    &lt;&gt; #fromPerMthNum#
                OR DCD.TO_PER_MTH_NUM      &lt;&gt; #toPerMthNum#
                OR DCD.BILL_WITH_EQUIP_FLG &lt;&gt; #billWithEquipFlg#
            )
            AND DCD.EZCANCELFLAG           = '0'
    </statement>

    <statement id="getNeedToUpdateBillWithEquipFlgDsContrAddlChrg" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            DCAC.DS_CONTR_ADDL_CHRG_PK
        FROM
             DS_CONTR_DTL       DCD
            ,DS_CONTR_ADDL_CHRG DCAC
        WHERE
                DCD.GLBL_CMPY_CD           = #glblCmpyCd#
            AND DCD.CPO_ORD_NUM            = #cpoOrdNum#
            AND DCD.SHELL_LINE_NUM         = #shellLineNum#
            AND DCD.EZCANCELFLAG           = '0'
            AND DCD.GLBL_CMPY_CD           = DCAC.GLBL_CMPY_CD
            AND DCD.DS_CONTR_DTL_PK        = DCAC.DS_CONTR_DTL_PK
            AND DCAC.BILL_WITH_EQUIP_FLG   &lt;&gt; #billWithEquipFlg#
            AND DCAC.EZCANCELFLAG          = '0'
    </statement>

    <statement id="getBasePrcDealAmtForAgg" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            NVL(SUM(BASE_PRC_DEAL_AMT), 0)
        FROM
            DS_CONTR_DTL DCD
        WHERE
                DCD.GLBL_CMPY_CD        = #glblCmpyCd#
            AND DCD.DS_CONTR_PK         = #dsContrPk#
            AND DCD.DS_CONTR_DTL_TP_CD  NOT IN (#dsContrDtlTpCd_Aggregate#, #dsContrDtlTpCd_Shell#)
            AND DCD.DS_CONTR_DTL_STS_CD NOT IN (#dsContrDtlStsCd_Terminated#, #dsContrDtlStsCd_Expired#, #dsContrDtlStsCd_Cancelled#)
            AND DCD.EZCANCELFLAG        = '0'
    </statement>

    <statement id="getDsContrDtlPkForRemoveShell" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            SHELL.DS_CONTR_DTL_PK
        FROM
            DS_CONTR_DTL SHELL
        WHERE
                SHELL.GLBL_CMPY_CD              = #glblCmpyCd#
            AND SHELL.CPO_ORD_NUM               = #cpoOrdNum#
            AND SHELL.SHELL_LINE_NUM            = #shellLineNum#
            AND SHELL.DS_CONTR_DTL_TP_CD        = #dsContrDtlTpCd_Shell#
            AND SHELL.EZCANCELFLAG              = '0'
            AND NOT EXISTS (
                SELECT
                    *
                FROM
                     DS_CONTR_DTL    DCD
                  <isEqual property="addAsryFlg" compareValue="N">
                    ,DS_CONTR_DTL_TP DCDT
                  </isEqual>
                WHERE
                        DCD.GLBL_CMPY_CD        = SHELL.GLBL_CMPY_CD
                    AND DCD.CPO_ORD_NUM         = SHELL.CPO_ORD_NUM
                    AND DCD.SHELL_LINE_NUM      = SHELL.SHELL_LINE_NUM
                  <isEqual property="fleetFlg" compareValue="N">
                    AND DCD.MDL_ID              = SHELL.MDL_ID
                  </isEqual>
                    AND DCD.EZCANCELFLAG        = '0'
                  <isEqual property="addAsryFlg" compareValue="N">
                    AND DCD.GLBL_CMPY_CD        = DCDT.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_TP_CD  = DCDT.DS_CONTR_DTL_TP_CD
                    AND DCDT.MAIN_UNIT_LINE_FLG = 'Y'
                    AND DCDT.EZCANCELFLAG       = '0'
                  </isEqual>
            )
    </statement>

    <statement id="getDsContrDtlPkForRemoveFltAgg" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            FLTAGG.DS_CONTR_DTL_PK
        FROM
            DS_CONTR_DTL FLTAGG
        WHERE
                FLTAGG.GLBL_CMPY_CD              = #glblCmpyCd#
            AND FLTAGG.DS_CONTR_PK               = #dsContrPk#
            AND FLTAGG.DS_CONTR_DTL_TP_CD        IN (#dsContrDtlTpCd_Fleet#, #dsContrDtlTpCd_Aggregate#)
            AND FLTAGG.EZCANCELFLAG              = '0'
            AND NOT EXISTS (
                SELECT
                    *
                FROM
                     DS_CONTR_DTL    DCD
                WHERE
                        DCD.GLBL_CMPY_CD         = FLTAGG.GLBL_CMPY_CD
                    AND DCD.PRNT_DS_CONTR_DTL_PK = FLTAGG.DS_CONTR_DTL_PK
                    AND DCD.EZCANCELFLAG         = '0'
            )
    </statement>

    <statement id="getDsContrDtlPkForShortageShell" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            A.DS_CONTR_DTL_PK
        FROM (
            SELECT
                 DCD.MDL_ID
                ,DCD.DS_CONTR_DTL_PK
                ,CD.DS_ORD_POSN_NUM
                ,RANK() OVER(
                    PARTITION BY
                         DCD.MDL_ID
                    ORDER BY
                         CD.DS_ORD_POSN_NUM
                 ) AS RANK_NUM
            FROM
                 DS_CONTR_DTL DCD
                ,CPO_DTL CD
            WHERE
                    DCD.GLBL_CMPY_CD           = #glblCmpyCd#
                AND DCD.CPO_ORD_NUM            = #cpoOrdNum#
                AND DCD.SHELL_LINE_NUM         = #shellLineNum#
                AND DCD.DS_CONTR_DTL_TP_CD     &lt;&gt; #dsContrDtlTpCd_Accessory#
                AND DCD.MDL_ID                 IS NOT NULL
                AND NOT EXISTS(
                    SELECT
                        *
                    FROM
                        DS_CONTR_DTL    SHELL
                    WHERE
                            SHELL.GLBL_CMPY_CD       = DCD.GLBL_CMPY_CD
                        AND SHELL.CPO_ORD_NUM        = DCD.CPO_ORD_NUM
                        AND SHELL.SHELL_LINE_NUM     = DCD.SHELL_LINE_NUM
                        AND SHELL.MDL_ID             = DCD.MDL_ID
                        AND SHELL.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCd_Shell#
                        AND SHELL.EZCANCELFLAG       = '0'
                )
                AND DCD.EZCANCELFLAG           = '0'
                AND DCD.GLBL_CMPY_CD           = CD.GLBL_CMPY_CD
                AND DCD.CPO_ORD_NUM            = CD.CPO_ORD_NUM
                AND DCD.CPO_DTL_LINE_NUM       = CD.CPO_DTL_LINE_NUM
                AND DCD.CPO_DTL_LINE_SUB_NUM   = CD.CPO_DTL_LINE_SUB_NUM
                AND CD.EZCANCELFLAG            = '0'
        ) A
        WHERE A.RANK_NUM = 1
    </statement>

    <statement id="getDsContrDtlPkByMdlId" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             DCD.DS_CONTR_DTL_PK
        FROM
             DS_CONTR_DTL DCD
        WHERE
                DCD.GLBL_CMPY_CD           = #glblCmpyCd#
            AND DCD.CPO_ORD_NUM            = #cpoOrdNum#
            AND DCD.SHELL_LINE_NUM         = #shellLineNum#
            AND DCD.MDL_ID                 = #mdlId#
            AND DCD.EZCANCELFLAG           = '0'
    </statement>

    <statement id="getContrForBwEquip" parameterClass="Map" resultClass="Map">
        SELECT
             A.DS_CONTR_DTL_PK
            ,B.DS_CONTR_ADDL_CHRG_PK
        FROM
             DS_CONTR_DTL A
            ,DS_CONTR_ADDL_CHRG B
        WHERE
            A.GLBL_CMPY_CD                 = #glblCmpyCd#
        AND A.CPO_ORD_NUM                  = #cpoOrdNum#
        AND A.CPO_DTL_LINE_NUM             = #cpoOrdDtlLineNum#
        AND A.CPO_DTL_LINE_SUB_NUM         = #cpoOrdDtlLineSubNum#
        AND A.BILL_WITH_EQUIP_FLG          = 'Y'
        AND A.BILL_WITH_EQUIP_INVD_FLG     = 'N'
        AND A.EZCANCELFLAG                 = '0'
        AND A.GLBL_CMPY_CD                 = B.GLBL_CMPY_CD    (+)
        AND A.DS_CONTR_PK                  = B.DS_CONTR_PK     (+)
        AND A.DS_CONTR_DTL_PK              = B.DS_CONTR_DTL_PK (+)
        AND B.BILL_WITH_EQUIP_FLG      (+) = 'Y'
        AND B.BILL_WITH_EQUIP_INVD_FLG (+) = 'N'
        AND B.EZCANCELFLAG             (+) = '0'
        ORDER BY
             A.CPO_ORD_NUM
            ,A.CPO_DTL_LINE_NUM
            ,A.CPO_DTL_LINE_SUB_NUM
            ,A.SHELL_LINE_NUM
    </statement>

    <statement id="getDsContrForCopy" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             A.DS_CONTR_PK
        FROM
             DS_CONTR A
        WHERE
            A.GLBL_CMPY_CD       = #glblCmpyCd#
        AND A.EZCANCELFLAG       = '0'
        AND EXISTS (
            SELECT
                *
            FROM
                DS_CONTR_DTL DTL
            WHERE
                DTL.GLBL_CMPY_CD = A.GLBL_CMPY_CD
            AND DTL.CPO_ORD_NUM  = #cpoOrdNum#
            AND DTL.DS_CONTR_PK  = A.DS_CONTR_PK
            AND DTL.SHELL_LINE_NUM IS NOT NULL
            AND DTL.EZCANCELFLAG = '0'
        )
        UNION
        SELECT
             A.DS_CONTR_PK
        FROM
             DS_CONTR A
        WHERE
            A.GLBL_CMPY_CD       = #glblCmpyCd#
        AND A.CPO_ORD_NUM        = #cpoOrdNum#
        AND A.EZCANCELFLAG       = '0'
        AND NOT EXISTS (
            SELECT
                *
            FROM
                DS_CONTR_DTL DTL
            WHERE
                DTL.GLBL_CMPY_CD = A.GLBL_CMPY_CD
            AND DTL.CPO_ORD_NUM  = A.CPO_ORD_NUM
            AND DTL.DS_CONTR_PK  = A.DS_CONTR_PK
            AND DTL.EZCANCELFLAG = '0'
        )
        ORDER BY
             DS_CONTR_PK
    </statement>

    <statement id="getDsContrDtlForCopy" parameterClass="Map" resultClass="Map">
        SELECT
             B.GLBL_CMPY_CD         AS GLBL_CMPY_CD
            ,B.DS_CONTR_PK          AS DS_CONTR_PK
            ,B.MDL_ID               AS MDL_ID
            ,B.DS_CONTR_DTL_PK      AS DS_CONTR_DTL_PK
            ,B.CPO_ORD_NUM          AS CPO_ORD_NUM
            ,B.DS_CONTR_DTL_TP_CD   AS DS_CONTR_DTL_TP_CD
            ,B.SVC_CONFIG_MSTR_PK   AS SVC_CONFIG_MSTR_PK
            ,NULL                   AS NEW_SVC_CONFIG_MSTR_PK
            ,1                      AS LINE_SORT
            ,0                      AS TP_SORT
            ,0                      AS MACH_SORT
        FROM
            DS_CONTR_DTL B
        WHERE
            B.GLBL_CMPY_CD       =  #glblCmpyCd#
        AND B.EZCANCELFLAG       =  '0'
        AND B.DS_CONTR_DTL_TP_CD IN (#dsContrDtlTpFlt#, #dsContrDtlTpAgg#)
        AND B.DS_CONTR_PK        =  #dsContrPk#
        AND B.CPO_ORD_NUM        =  #cpoOrdNum#
        UNION ALL
        SELECT
             A.GLBL_CMPY_CD         AS GLBL_CMPY_CD
            ,A.DS_CONTR_PK          AS DS_CONTR_PK
            ,A.MDL_ID               AS MDL_ID
            ,A.DS_CONTR_DTL_PK      AS DS_CONTR_DTL_PK
            ,A.CPO_ORD_NUM          AS CPO_ORD_NUM
            ,A.DS_CONTR_DTL_TP_CD   AS DS_CONTR_DTL_TP_CD
            ,A.SVC_CONFIG_MSTR_PK   AS SVC_CONFIG_MSTR_PK
            ,NULL                   AS NEW_SVC_CONFIG_MSTR_PK
            ,2                      AS LINE_SORT
            ,1                      AS TP_SORT
            ,0                      AS MACH_SORT
        FROM
            DS_CONTR_DTL A
        WHERE
            A.GLBL_CMPY_CD       =  #glblCmpyCd#
        AND A.EZCANCELFLAG       =  '0'
        AND A.DS_CONTR_DTL_TP_CD =  #dsContrDtlTpShell#
        AND A.DS_CONTR_PK        =  #dsContrPk#
        AND A.CPO_ORD_NUM        =  #cpoOrdNum#
        UNION ALL
        SELECT
             C.GLBL_CMPY_CD         AS GLBL_CMPY_CD
            ,C.DS_CONTR_PK          AS DS_CONTR_PK
            ,C.MDL_ID               AS MDL_ID
            ,C.DS_CONTR_DTL_PK      AS DS_CONTR_DTL_PK
            ,C.CPO_ORD_NUM          AS CPO_ORD_NUM
            ,C.DS_CONTR_DTL_TP_CD   AS DS_CONTR_DTL_TP_CD
            ,C.SVC_CONFIG_MSTR_PK   AS SVC_CONFIG_MSTR_PK
            ,(
                SELECT
                     CONF.SVC_CONFIG_MSTR_PK
                FROM
                     CPO_DTL        DTL
                    ,DS_CPO_CONFIG  CONF
                WHERE
                    DTL.GLBL_CMPY_CD         = C.GLBL_CMPY_CD
                AND DTL.CPO_ORD_NUM          = #newCpoOrdNum#
                AND DTL.CPO_DTL_LINE_NUM     = C.CPO_DTL_LINE_NUM
                AND DTL.CPO_DTL_LINE_SUB_NUM = C.CPO_DTL_LINE_SUB_NUM
                AND DTL.EZCANCELFLAG         = '0'
                AND DTL.GLBL_CMPY_CD         = CONF.GLBL_CMPY_CD
                AND DTL.DS_CPO_CONFIG_PK     = CONF.DS_CPO_CONFIG_PK
                AND CONF.EZCANCELFLAG        = '0'
             )                      AS NEW_SVC_CONFIG_MSTR_PK
            ,2                      AS LINE_SORT
            ,2                      AS TP_SORT
            ,(
                SELECT
                    TP.DS_CONTR_DTL_TP_SORT_NUM
                FROM
                    DS_CONTR_DTL_TP TP
                WHERE
                    TP.GLBL_CMPY_CD       = C.GLBL_CMPY_CD
                AND TP.DS_CONTR_DTL_TP_CD = C.DS_CONTR_DTL_TP_CD
                AND TP.EZCANCELFLAG       = '0'
             )                      AS MACH_SORT
        FROM
            DS_CONTR_DTL C
        WHERE
            C.GLBL_CMPY_CD       =  #glblCmpyCd#
        AND C.EZCANCELFLAG       =  '0'
        AND C.DS_CONTR_DTL_TP_CD NOT IN (#dsContrDtlTpShell#, #dsContrDtlTpFlt#, #dsContrDtlTpAgg#)
        AND C.DS_CONTR_PK        =  #dsContrPk#
        AND C.CPO_ORD_NUM        =  #cpoOrdNum#
        ORDER BY
             DS_CONTR_PK
            ,LINE_SORT
            ,MDL_ID             NULLS FIRST
            ,TP_SORT
            ,SVC_CONFIG_MSTR_PK
            ,MACH_SORT
    </statement>

    <statement id="getDsContrBllgMtrForCopy" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             A.DS_CONTR_BLLG_MTR_PK
        FROM
             DS_CONTR_BLLG_MTR A
            ,MTR_LB            B
        WHERE
            A.GLBL_CMPY_CD    = #glblCmpyCd#
        AND A.EZCANCELFLAG    = '0'
        AND A.DS_CONTR_DTL_PK = #dsContrDtlPk#
        AND A.GLBL_CMPY_CD    = B.GLBL_CMPY_CD
        AND A.BLLG_MTR_LB_CD  = B.MTR_LB_CD
        AND B.EZCANCELFLAG    = '0'
        ORDER BY
            B.MTR_LB_SORT_NUM
    </statement>

    <statement id="getContrPhysBllgMtrRelnForCopy" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             A.CONTR_PHYS_BLLG_MTR_RELN_PK
        FROM
             CONTR_PHYS_BLLG_MTR_RELN A
        WHERE
            A.GLBL_CMPY_CD         = #glblCmpyCd#
        AND A.EZCANCELFLAG         = '0'
        AND A.DS_CONTR_BLLG_MTR_PK = #dsContrBllgMtrPk#
        ORDER BY
            A.DS_CONTR_BLLG_MTR_PK
    </statement>

    <statement id="getContrXsCopyForCopy" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             A.CONTR_XS_COPY_PK
        FROM
             CONTR_XS_COPY A
        WHERE
            A.GLBL_CMPY_CD         = #glblCmpyCd#
        AND A.EZCANCELFLAG         = '0'
        AND A.DS_CONTR_BLLG_MTR_PK = #dsContrBllgMtrPk#
        ORDER BY
            A.XS_MTR_COPY_QTY
    </statement>

    <statement id="getDsContrAddlChrgForCopy" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             A.DS_CONTR_ADDL_CHRG_PK
        FROM
            DS_CONTR_ADDL_CHRG A
        WHERE
            A.GLBL_CMPY_CD        = #glblCmpyCd#
        AND A.EZCANCELFLAG        = '0'
        AND A.DS_CONTR_PK         = #dsContrPk#
        AND A.DS_CONTR_DTL_PK     = #dsContrDtlPk#
        AND A.SVC_BILL_BY_TP_CD   = #svcBillByTpCd#
        AND A.ADDL_CHRG_INV_TP_CD = #addlChrgInvTpCd#
        ORDER BY
             A.DS_CONTR_ADDL_CHRG_PK
    </statement>

    <statement id="getDsContrCrCardPoForCopy" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             A.DS_CONTR_CR_CARD_PO_PK
        FROM
            DS_CONTR_CR_CARD_PO A
        WHERE
            A.GLBL_CMPY_CD         = #glblCmpyCd#
        AND A.EZCANCELFLAG         = '0'
        AND A.DS_CONTR_PK          = #dsContrPk#
        <isNotNull property="dsContrDtlPk">
        AND A.DS_CONTR_DTL_PK      = #dsContrDtlPk#
        </isNotNull>
        <isNull property="dsContrDtlPk">
        AND A.DS_CONTR_DTL_PK      IS NULL
        </isNull>
        AND A.DS_CONTR_BLLG_MTR_PK IS NULL
        ORDER BY
             A.DS_CONTR_CR_CARD_PO_PK
    </statement>

    <statement id="getSvcTermCondForCopy" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             A.SVC_TERM_COND_PK
        FROM
            SVC_TERM_COND A
        WHERE
            A.GLBL_CMPY_CD    = #glblCmpyCd#
        AND A.EZCANCELFLAG    = '0'
        AND A.DS_CONTR_PK     = #dsContrPk#
        <isNotNull property="dsContrDtlPk">
        AND A.DS_CONTR_DTL_PK = #dsContrDtlPk#
        </isNotNull>
        <isNull property="dsContrDtlPk">
        AND A.DS_CONTR_DTL_PK IS NULL
        </isNull>
        ORDER BY
             A.SVC_TERM_COND_PK
    </statement>

    <statement id="getSvcMemoForCopy" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             A.SVC_MEMO_PK
        FROM
            SVC_MEMO A
        WHERE
            A.GLBL_CMPY_CD     =  #glblCmpyCd#
        AND A.EZCANCELFLAG     =  '0'
        AND A.DS_CONTR_PK      =  #dsContrPk#
        AND A.DS_CONTR_DTL_PK  IS NULL
        AND A.SVC_MEMO_CATG_CD =  #svcMemoCatgCd#
        AND A.SVC_MEMO_TP_CD   =  #svcMemoTpCd#
        ORDER BY
             A.SVC_MEMO_PK
    </statement>

    <statement id="getDsContrRnwEsclForCopy" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             A.DS_CONTR_RNW_ESCL_PK
        FROM
            DS_CONTR_RNW_ESCL A
        WHERE
            A.GLBL_CMPY_CD          =  #glblCmpyCd#
        AND A.EZCANCELFLAG          =  '0'
        AND A.DS_CONTR_PK           =  #dsContrPk#
        <!-- mod start 2020/03/24 QC#54318 -->
        <isNull property="dsContrDtlPk">
        AND A.DS_CONTR_DTL_PK       IS NULL
        AND A.DS_CONTR_MACH_LVL_NUM = '1'
        </isNull>
        <isNotNull property="dsContrDtlPk">
        AND A.DS_CONTR_DTL_PK       = #dsContrDtlPk#
        AND A.DS_CONTR_MACH_LVL_NUM = '2'
        </isNotNull>
        <!-- mod end 2020/03/24 QC#54318 -->
        ORDER BY
             A.DS_CONTR_RNW_ESCL_PK
    </statement>

    <statement id="getDsContrTaxDtlForCopy" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             A.DS_CONTR_TAX_DTL_PK
        FROM
            DS_CONTR_TAX_DTL A
        WHERE
            A.GLBL_CMPY_CD          =  #glblCmpyCd#
        AND A.EZCANCELFLAG          =  '0'
        AND A.DS_CONTR_PK           =  #dsContrPk#
        AND A.CPO_ORD_NUM           =  #cpoOrdNum#
        ORDER BY
             A.DS_CONTR_TAX_DTL_PK
    </statement>
    
    <!-- START 2017/10/05 K.Ishizuka [QC#21393,ADD] -->
    <statement id="getSchdCratTmplForCopy" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             A.SCHD_CRAT_TMPL_PK
        FROM
            SCHD_CRAT_TMPL A
        WHERE
            A.GLBL_CMPY_CD          =  #glblCmpyCd#
        AND A.EZCANCELFLAG          =  '0'
        AND A.DS_CONTR_PK           =  #dsContrPk#
        AND A.REF_CPO_ORD_NUM       =  #cpoOrdNum#
        ORDER BY
             A.SCHD_CRAT_TMPL_PK
    </statement>
    
    <statement id="getSchdCratTmplLineForCopy" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             A.SCHD_CRAT_TMPL_LINE_NUM
        FROM
            SCHD_CRAT_TMPL_LINE A
        WHERE
            A.GLBL_CMPY_CD          =  #glblCmpyCd#
        AND A.EZCANCELFLAG          =  '0'
        AND A.SCHD_CRAT_TMPL_PK     =  #schdCratTmplPk#
        ORDER BY
             A.SCHD_CRAT_TMPL_LINE_NUM
    </statement>
    <!-- END 2017/10/05 K.Ishizuka [QC#21393,ADD] -->

    <statement id="getDsContrDocId" parameterClass="Map" resultClass="BigDecimal">
        SELECT DISTINCT
            DCD.SHELL_LINE_NUM AS DOC_ID
        FROM
            DS_CONTR_DTL   DCD
        WHERE
            DCD.GLBL_CMPY_CD    = #glblCmpyCd#
        AND DCD.DS_CONTR_PK     = #dsContrPk#
        ORDER BY
            DCD.SHELL_LINE_NUM
    </statement>

    <statement id="getDsContrDtlDocId" parameterClass="Map" resultClass="String">
        SELECT DISTINCT
            DCD.SHELL_LINE_NUM || #docIdDlmt# || CD.DS_ORD_POSN_NUM || #docIdDlmt# || DCD.CPO_DTL_LINE_NUM || #docIdDlmt# || DCD.CPO_DTL_LINE_SUB_NUM AS DOC_ID
        FROM
             DS_CONTR_DTL   DCD
            ,CPO_DTL        CD
        WHERE
            DCD.GLBL_CMPY_CD         = #glblCmpyCd#
        AND DCD.DS_CONTR_DTL_PK      = #dsContrDtlPk#
        AND DCD.GLBL_CMPY_CD         = CD.GLBL_CMPY_CD
        AND DCD.CPO_ORD_NUM          = CD.CPO_ORD_NUM
        AND DCD.CPO_DTL_LINE_NUM     = CD.CPO_DTL_LINE_NUM
        AND DCD.CPO_DTL_LINE_SUB_NUM = CD.CPO_DTL_LINE_SUB_NUM
    </statement>

    <statement id="getShellLineNum" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            A.SHELL_LINE_NUM
        FROM (
            SELECT
                DCD.SHELL_LINE_NUM
            FROM
                DS_CONTR_DTL DCD
            WHERE
                    DCD.GLBL_CMPY_CD     = #glblCmpyCd#
                AND DCD.CPO_ORD_NUM      = #cpoOrdNum#
                AND DCD.DS_CONTR_PK      = #dsContrPk#
                AND DCD.SHELL_LINE_NUM   IS NOT NULL
                AND DCD.EZCANCELFLAG     = '0'
            UNION
            SELECT
                DC.SHELL_LINE_NUM
            FROM
                DS_CONTR DC
            WHERE
                    DC.GLBL_CMPY_CD     = #glblCmpyCd#
                AND DC.CPO_ORD_NUM      = #cpoOrdNum#
                AND DC.DS_CONTR_PK      = #dsContrPk#
                AND DC.EZCANCELFLAG     = '0'
                AND NOT EXISTS (
                    SELECT 
                        1
                    FROM
                        DS_CONTR_DTL DCD
                    WHERE
                            DCD.GLBL_CMPY_CD   = DC.GLBL_CMPY_CD
                        AND DCD.CPO_ORD_NUM    = DC.CPO_ORD_NUM
                        AND DCD.DS_CONTR_PK    = DC.DS_CONTR_PK
                        AND DCD.EZCANCELFLAG   = '0'
                    )
            ) A
        WHERE
            ROWNUM = 1
    </statement>

    <statement id="getAddContrDtlPk" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             A.DS_CONTR_DTL_PK
        FROM
             DS_CONTR_DTL         A
            ,DS_CONTR_DTL_STS_V   B
        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            AND (  A.CPO_ORD_NUM &lt;&gt; #cpoOrdNum#
                OR A.CPO_ORD_NUM        IS NULL)
            AND A.DS_CONTR_PK           = #dsContrPk#
            AND A.EZCANCELFLAG          = '0'
            AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
            AND A.DS_CONTR_DTL_PK       = B.DS_CONTR_DTL_PK
            <iterate property="dsContrCtrlStsCdList" var="dsContrCtrlStsCd[]" open="AND B.DS_CONTR_CTRL_STS_CD NOT IN (" close=")" conjunction=",">
                #dsContrCtrlStsCd[]#
            </iterate>
    </statement>

    <statement id="getDsContrCatgCd" parameterClass="Map" resultClass="String">
        SELECT
            DISTINCT DC.DS_CONTR_CATG_CD
        FROM
             DS_CONTR_DTL DCD
            ,DS_CONTR     DC
        WHERE
                DCD.GLBL_CMPY_CD     = #glblCmpyCd#
            AND DCD.CPO_ORD_NUM      = #cpoOrdNum#
            AND DCD.SHELL_LINE_NUM   = #shellLineNum#
            AND DCD.EZCANCELFLAG     = '0'
            AND DCD.GLBL_CMPY_CD     = DC.GLBL_CMPY_CD
            AND DCD.DS_CONTR_PK      = DC.DS_CONTR_PK
            AND DC.EZCANCELFLAG      = '0'
    </statement>

<!-- START 2019/02/05 [QC#30244, MOD] -->
    <statement id="getPrntDsContrDtlPk" parameterClass="Map" resultClass="BigDecimal">
        <!-- START 2023/11/08 R.Jin [QC#62108, MOD] -->
        SELECT
            DS_CONTR_DTL_PK
        FROM
            (SELECT
                DCD.DS_CONTR_DTL_PK
            FROM
                DS_CONTR_DTL DCD
                ,DS_CONTR_DTL_STS DCDS
            WHERE
                    DCD.GLBL_CMPY_CD       = #glblCmpyCd#
                AND DCD.DS_CONTR_PK        = #dsContrPk#
                AND DCD.SVC_CONFIG_MSTR_PK = #svcConfigMstrPk#
                AND DCD.DS_CONTR_DTL_TP_CD &lt;&gt; #dsContrDtlTpCd_Accessory#
                <!-- START 2019/02/15 [QC#30386, MOD] -->
                AND (DCD.DS_CONTR_CRAT_TP_CD NOT IN (#dsContrCratTpSupply#, #dsContrCratTpOther#)
                    OR DCD.DS_CONTR_CRAT_TP_CD IS NULL)
                <!--END 2019/02/15 [QC#30386, MOD] -->
                AND DCD.EZCANCELFLAG       = '0'
                <!-- START 2023/07/05 T.Kojima [QC#61472, ADD] -->
    <!--            AND DCD.DS_CONTR_DTL_STS_CD NOT IN (#cancelled#, #terminated#, #expired#)-->
                <!-- END 2023/07/05 T.Kojima [QC#61472, ADD] -->
                AND DCD.DS_CONTR_DTL_STS_CD = DCDS.DS_CONTR_DTL_STS_CD
                AND DCDS.EZCANCELFLAG      = '0'
            ORDER BY
                CASE WHEN DCDS.DS_CONTR_DTL_STS_CD=#dsContrDtlStsCdActive# THEN 0 ELSE DCDS.DS_CONTR_DTL_STS_SORT_NUM END
                ,DCD.DS_CONTR_DTL_PK
            ) A
        WHERE
            ROWNUM = 1
        <!-- END 2023/11/08 R.Jin [QC#62108, MOD] -->
    </statement>
<!-- END 2019/02/05 [QC#30244, MOD] -->

<!-- START 2019/01/18 [QC#29782, ADD] -->
    <statement id="getPrntSvcPgmMdseCd" parameterClass="Map" resultClass="String">
        SELECT
            DCD.SVC_PGM_MDSE_CD
        FROM
            DS_CONTR_DTL DCD
        WHERE
                DCD.GLBL_CMPY_CD    = #glblCmpyCd#
            AND DCD.DS_CONTR_DTL_PK = #dsContrDtlPk#
            AND DCD.EZCANCELFLAG    = '0'
    </statement>
<!-- END 2019/01/18 [QC#29782, ADD] -->

    <statement id="countDsContrDtlMachAcc" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            COUNT(*) AS CNT
        FROM
            DS_CONTR_DTL A
        WHERE
            A.GLBL_CMPY_CD = #glblCmpyCd#
        AND A.DS_CONTR_PK  = #dsContrPk#
        <iterate property="dsContrDtlTpList" var="dsContrDtlTp[]" open=" AND A.DS_CONTR_DTL_TP_CD IN (" close=")" conjunction=",">
            #dsContrDtlTp[]#
        </iterate>
        AND A.EZCANCELFLAG = '0'
    </statement>

    <statement id="getContrLeaseCmpy" parameterClass="Map" resultClass="Map">
        SELECT
             B.CONTR_LEASE_DS_ACCT_NUM
            ,B.CONTR_LEASE_BILL_TO_CUST_CD
        FROM
             CPO                   A
            ,CPO_SVC_DEF_CUST_DECN B
        WHERE
            A.GLBL_CMPY_CD   = #glblCmpyCd#
        AND A.CPO_ORD_NUM    = #cpoOrdNum#
        AND A.EZCANCELFLAG   = '0'
        AND A.GLBL_CMPY_CD   = B.GLBL_CMPY_CD
        AND A.DS_ORD_CATG_CD = B.DS_ORD_CATG_CD
        <!-- START 2018/02/13 K.Kojima [QC#23357,ADD] -->
        AND A.DS_ORD_TP_CD   = B.DS_ORD_TP_CD
        <!-- END 2018/02/13 K.Kojima [QC#23357,ADD] -->
        AND B.EZCANCELFLAG   = '0'
        AND B.BILL_BY_TP_CD  = #billByTpCd#
    </statement>

    <!-- START 2017/08/09 K.Kojima [QC#20527,ADD] -->
    <statement id="countContrCfsEdi" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            COUNT(C.GLBL_CMPY_CD) AS CNT
        FROM
             CPO              C
            ,ORD_CATG_BIZ_CTX OCBC
        WHERE
                C.GLBL_CMPY_CD               = #glblCmpyCd#
            AND C.CPO_ORD_NUM                = #cpoOrdNum#
            AND C.EZCANCELFLAG               = '0'
            AND C.GLBL_CMPY_CD               = OCBC.GLBL_CMPY_CD
            AND C.DS_ORD_CATG_CD             = OCBC.DS_ORD_CATG_CD
<!-- START 2019/06/17 W.Honda [QC#50842,MOD] -->
            <!-- AND C.DS_ORD_TP_CD               = OCBC.DS_ORD_TP_CD -->
            AND (C.DS_ORD_TP_CD              = OCBC.DS_ORD_TP_CD
                OR  OCBC.DS_ORD_TP_CD        IS NULL)
<!-- START 2019/06/17 W.Honda [QC#50842,MOD] -->
            AND OCBC.ORD_CATG_CTX_TP_CD      = #ordCatgCtxTpContrCfsEdi#
            AND OCBC.FIRST_BIZ_CTX_ATTRB_TXT = #flgY#
            AND OCBC.EZCANCELFLAG            = '0'
    </statement>
    <!-- END 2017/08/09 K.Kojima [QC#20527,ADD] -->

<!-- add start 2017/08/09 QC#18799 -->
    <statement id="getDsContrClsCd" parameterClass="Map" resultClass="String">
        SELECT
            OCBC.FIRST_BIZ_CTX_ATTRB_TXT
        FROM
             CPO              C
            ,ORD_CATG_BIZ_CTX OCBC
        WHERE
                C.GLBL_CMPY_CD               = #glblCmpyCd#
            AND C.CPO_ORD_NUM                = #cpoOrdNum#
            AND C.EZCANCELFLAG               = '0'
            AND C.GLBL_CMPY_CD               = OCBC.GLBL_CMPY_CD
            AND C.DS_ORD_CATG_CD             = OCBC.DS_ORD_CATG_CD
            AND (
                     (C.DS_ORD_TP_CD  =  OCBC.DS_ORD_TP_CD AND OCBC.DS_ORD_TP_CD IS NOT NULL)
                 OR  OCBC.DS_ORD_TP_CD IS NULL
                )
            AND OCBC.ORD_CATG_CTX_TP_CD      = #svcContrCatg#
            AND OCBC.EZCANCELFLAG            = '0'
    </statement>
<!-- add end 2017/08/09 QC#18799 -->

    <!-- START 2017/08/18 [QC#20651, ADD] -->
    <statement id="getMtrGrpPk" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             MDL.MTR_GRP_PK
        FROM
             CPO_DTL       DCD
            ,DS_CPO_CONFIG DCC
            ,DS_MDL        MDL
        WHERE
                 DCD.GLBL_CMPY_CD         = #glblCmpyCd#
             AND DCD.CPO_ORD_NUM          = #cpoOrdNum#
             AND DCD.CPO_DTL_LINE_NUM     = #cpoDtlLineNum#
             AND DCD.CPO_DTL_LINE_SUB_NUM = #cpoDtlLineSubNum#
             AND DCD.EZCANCELFLAG         = '0'
             AND DCD.GLBL_CMPY_CD         = DCC.GLBL_CMPY_CD(+)
             AND DCD.DS_CPO_CONFIG_PK     = DCC.DS_CPO_CONFIG_PK(+)
             AND DCC.EZCANCELFLAG(+)      = '0'
             AND DCC.GLBL_CMPY_CD         = MDL.GLBL_CMPY_CD(+)
             AND DCC.MDL_ID               = MDL.MDL_ID(+)
             AND MDL.EZCANCELFLAG(+)      = '0'
    </statement>
    <!-- END   2017/08/18 [QC#20651, ADD] -->
    
    <!-- START 2017/08/25 [QC#18345, ADD] -->
    <statement id="countInvoicedBllgSchd" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            COUNT(*) AS CNT
        FROM
             DS_CONTR_BLLG_SCHD DCBS
            ,DS_CONTR_DTL DCD
        WHERE
                DCD.GLBL_CMPY_CD    = #glblCmpyCd#
            AND DCD.DS_CONTR_PK     = #dsContrPk#
            AND DCD.EZCANCELFLAG    = '0'
            AND DCD.GLBL_CMPY_CD    = DCBS.GLBL_CMPY_CD
            AND DCD.DS_CONTR_DTL_PK = DCBS.DS_CONTR_DTL_PK
            AND DCBS.INV_FLG        = 'Y'
            AND DCBS.USG_CHRG_FLG   = 'Y'
            AND DCBS.EZCANCELFLAG   = '0'
    </statement>
    
    <statement id="getBllgMtrLbCdForAdd" parameterClass="Map" resultClass="String">
        SELECT
            DCBM.BLLG_MTR_LB_CD
        FROM
             DS_CONTR_DTL DCD
            ,DS_CONTR_BLLG_MTR DCBM
        WHERE
                DCD.GLBL_CMPY_CD       = #glblCmpyCd#
            AND DCD.DS_CONTR_PK        = #dsContrPk#
            AND DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCd#
            AND DCD.GLBL_CMPY_CD       = DCBM.GLBL_CMPY_CD
            AND DCD.DS_CONTR_DTL_PK    = DCBM.DS_CONTR_DTL_PK
            AND DCD.EZCANCELFLAG       = '0'
            AND DCBM.EZCANCELFLAG      = '0'
    </statement>

    <!-- END 2017/08/25 [QC#18345, ADD] -->

    <statement id="getBllgMtrLvlNum" parameterClass="Map" resultClass="String">
        SELECT
            BMM.BLLG_MTR_MAP_LVL_NUM
        FROM
             DS_MDL        DM
            ,BLLG_MTR_MAP  BMM
        WHERE
                DM.GLBL_CMPY_CD         = #glblCmpyCd#
          <iterate property="mdlIdList" var="mdlId[]" open="AND DM.MDL_ID IN (" close=")"  conjunction=",">
            #mdlId[]#
          </iterate>
            AND DM.EZCANCELFLAG         = '0'
            AND DM.GLBL_CMPY_CD         = BMM.GLBL_CMPY_CD
            AND DM.MTR_GRP_PK           = BMM.MTR_GRP_PK
            AND BMM.MDL_MTR_LB_CD       = #mdlMtrLbCd#
            AND BMM.BLLG_MTR_LB_CD      = #bllgMtrLbCd#
            AND BMM.ACTV_FLG            = 'Y'
            AND BMM.EFF_FROM_DT         &lt;= #slsDt#
            AND ( 
                   BMM.EFF_THRU_DT      &gt;= #slsDt#
                OR BMM.EFF_THRU_DT      IS NULL
            ) 
            AND BMM.EZCANCELFLAG        = '0'
        ORDER BY
            BMM.BLLG_MTR_MAP_LVL_NUM
    </statement>

    <!-- START 2017/08/28 [QC#20665, ADD] -->
    <statement id="getDsContrPkAddContrHeaderonly" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            DC.DS_CONTR_PK
        FROM
            DS_CONTR DC
        WHERE
                DC.GLBL_CMPY_CD       = #glblCmpyCd#
            AND DC.DS_CONTR_NUM       = #dsContrNum#
            AND DC.CPO_ORD_NUM        = #cpoOrdNum#
            AND DC.SHELL_LINE_NUM     = #shellLineNum#
            AND DC.DS_CONTR_STS_CD    = #dsContrStsCd#
            AND DC.EZCANCELFLAG       = '0'
            AND NOT EXISTS (
                SELECT 
                    1
                FROM
                    DS_CONTR_DTL CD
                WHERE
                        CD.GLBL_CMPY_CD   = DC.GLBL_CMPY_CD
                    AND CD.CPO_ORD_NUM    = DC.CPO_ORD_NUM
                    AND CD.DS_CONTR_PK    = DC.DS_CONTR_PK
                    AND CD.EZCANCELFLAG   = '0'
                )
    </statement>

    <!-- END   2017/08/28 [QC#20665, ADD] -->

    <statement id="getQtyContrCapQty" parameterClass="Map" resultClass="BigDecimal"><!-- QC#20036(L3#397) -->
        SELECT
                  SCT.QTY_CONTR_CAP_QTY
            FROM
                SCHD_CRAT_TMPL        SCT
                , SCHD_CRAT_TMPL_LINE SCL
            WHERE
                SCT.GLBL_CMPY_CD            = #glblCmpyCd#
                AND SCT.EZCANCELFLAG        = '0' 
                AND SCT.GLBL_CMPY_CD        = SCL.GLBL_CMPY_CD
                AND SCT.SCHD_CRAT_TMPL_PK   = SCL.SCHD_CRAT_TMPL_PK
                AND SCL.DS_CONTR_DTL_PK     = #dsContrDtlPk#
                AND SCL.EZCANCELFLAG        = '0'
                AND ROWNUM                  = 1
    </statement>

    <statement id="getSplyAgmtDocTpCd" parameterClass="Map" resultClass="String"><!-- QC#20036(L3#397) -->
        SELECT
                 SAP.SPLY_AGMT_DOC_TP_CD
            FROM
                  PRC_LIST_SPLY_PGM  PLSP
                , SPLY_AGMT_PLN      SAP
            WHERE
                 PLSP.GLBL_CMPY_CD          = #glblCmpyCd#
             AND PLSP.MDL_ID                = #mdlId#
             AND PLSP.PRC_MTR_PKG_PK        = #prcMtrPkgPk#
             AND PLSP.PRC_SVC_PLN_TP_CD     = #prcSvcPlnTpCd#
             AND PLSP.PRC_SVC_CONTR_TP_CD   = #prcSvcContrTpCd#
             AND PLSP.BLLG_MTR_LB_CD        = #bllgMtrLbCd#
             AND PLSP.PRC_CATG_CD           = #prcCatgCd#
             AND PLSP.EFF_FROM_DT          &lt;= #slsDt#
             AND ( 
                 PLSP.EFF_THRU_DT          IS NULL
                 OR PLSP.EFF_THRU_DT       &gt;= #slsDt#
             ) 
             AND PLSP.TERM_FROM_MTH_AOT    &lt;= #termMthAot#
             AND PLSP.TERM_THRU_MTH_AOT    &gt;= #termMthAot#
             AND PLSP.EZCANCELFLAG          = '0'
             
             AND PLSP.GLBL_CMPY_CD          = SAP.GLBL_CMPY_CD
             AND PLSP.SPLY_AGMT_PLN_PK      = SAP.SPLY_AGMT_PLN_PK
             AND SAP.EZCANCELFLAG           = '0'
             AND ROWNUM                     = 1
    </statement>

<!-- add start 2017/10/05 QC#21542 -->
    <statement id="getSvcLineBizCd" parameterClass="Map" resultClass="String">
        SELECT
            LBR.SVC_LINE_BIZ_CD
        FROM
             DS_ORD_TP_PROC_DFN       OPD
            ,SVC_LINE_BIZ_RELN        LBR
        WHERE
                  OPD.GLBL_CMPY_CD    = #glblCmpyCd#
            AND OPD.DS_ORD_TP_CD      = #dsOrdTpCd# 
            AND OPD.EZCANCELFLAG      = '0' 
            AND OPD.GLBL_CMPY_CD      = LBR.GLBL_CMPY_CD
            AND OPD.LINE_BIZ_TP_CD    = LBR.LINE_BIZ_TP_CD
            AND LBR.EZCANCELFLAG      = '0'
    </statement>
<!-- add end 2017/10/05 QC#21542 -->

<!-- START 2017/12/11 K.Kojima [QC#19955,ADD] -->
    <statement id="getChangeBllgCycleDetailPk" parameterClass="Map" resultClass="Map">
        SELECT
             DCD.DS_CONTR_DTL_PK
            ,DC.BASE_BLLG_CYCLE_CD
        FROM
             DS_CONTR DC
            ,DS_CONTR_DTL DCD
        WHERE
                DC.GLBL_CMPY_CD              = #glblCmpyCd#
            AND DC.DS_CONTR_PK               = #dsContrPk#
            AND DC.EZCANCELFLAG              = '0'
            AND DC.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
            AND DC.DS_CONTR_PK               = DCD.DS_CONTR_PK
            AND DC.BASE_BLLG_CYCLE_CD &lt;&gt; DCD.BASE_BLLG_CYCLE_CD
            AND DCD.DS_CONTR_DTL_STS_CD      = #dsContrDtlStsOrdr#
            AND DCD.EZCANCELFLAG             = '0'
    </statement>

    <statement id="getChangeBllgCycleBllgMtrPk" parameterClass="Map" resultClass="Map">
        SELECT
             DCBM.DS_CONTR_BLLG_MTR_PK
            ,DC.MTR_BLLG_CYCLE_CD
        FROM
             DS_CONTR          DC
            ,DS_CONTR_DTL      DCD
            ,DS_CONTR_BLLG_MTR DCBM
        WHERE
                DC.GLBL_CMPY_CD                      = #glblCmpyCd#
            AND DC.DS_CONTR_PK                       = #dsContrPk#
            AND DC.EZCANCELFLAG                      = '0'
            AND DC.GLBL_CMPY_CD                      = DCD.GLBL_CMPY_CD
            AND DC.DS_CONTR_PK                       = DCD.DS_CONTR_PK
            AND DCD.DS_CONTR_DTL_STS_CD              = #dsContrDtlStsOrdr#
            AND DCD.EZCANCELFLAG                     = '0'
            AND DCD.GLBL_CMPY_CD                     = DCBM.GLBL_CMPY_CD
            AND DCD.DS_CONTR_DTL_PK                  = DCBM.DS_CONTR_DTL_PK
            AND DC.MTR_BLLG_CYCLE_CD          &lt;&gt; DCBM.BLLG_MTR_BLLG_CYCLE_CD
            AND DCBM.DS_CONTR_BLLG_MTR_STS_CD        = #dsContrDtlStsOrdr#
            AND DCBM.EZCANCELFLAG                    = '0'
    </statement>

    <statement id="getChangeBllgCycleAddlChrgPk" parameterClass="Map" resultClass="Map">
        SELECT
             DCAC.DS_CONTR_ADDL_CHRG_PK
            ,DC.BASE_BLLG_CYCLE_CD
        FROM
             DS_CONTR DC
            ,DS_CONTR_ADDL_CHRG DCAC
        WHERE
                DC.GLBL_CMPY_CD              = #glblCmpyCd#
            AND DC.DS_CONTR_PK               = #dsContrPk#
            AND DC.EZCANCELFLAG              = '0'
            AND DC.GLBL_CMPY_CD              = DCAC.GLBL_CMPY_CD
            AND DC.DS_CONTR_PK               = DCAC.DS_CONTR_PK
            AND DC.BASE_BLLG_CYCLE_CD &lt;&gt; DCAC.BLLG_CYCLE_CD
            AND DCAC.EZCANCELFLAG            = '0'
    </statement>
<!-- END 2017/12/11 K.Kojima [QC#19955,ADD] -->

<!-- START 2017/12/26 M.Kidokoro [QC#23167,ADD] -->
    <statement id="getUpdateBllgMtrPkList" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            DCBM.DS_CONTR_BLLG_MTR_PK
        FROM
             DS_CONTR          DC
            ,DS_CONTR_DTL      DCD
            ,DS_CONTR_BLLG_MTR DCBM
        WHERE
                DC.GLBL_CMPY_CD     = #glblCmpyCd#
            AND DC.DS_CONTR_PK      = #dsContrPk#
            AND DC.EZCANCELFLAG     = '0'
            AND DC.GLBL_CMPY_CD     = DCD.GLBL_CMPY_CD
            AND DC.DS_CONTR_PK      = DCD.DS_CONTR_PK
            AND DCD.EZCANCELFLAG    = '0'
            AND DCD.GLBL_CMPY_CD    = DCBM.GLBL_CMPY_CD
            AND DCD.DS_CONTR_DTL_PK = DCBM.DS_CONTR_DTL_PK
            AND DCBM.EZCANCELFLAG   = '0'
            AND DCBM.BLLG_MTR_BILL_TO_CUST_CD IS NOT NULL
        ORDER BY
             DC.DS_CONTR_PK
            ,DCD.DS_CONTR_DTL_PK
            ,DCBM.DS_CONTR_BLLG_MTR_PK
    </statement>
<!-- END 2017/12/26 M.Kidokoro [QC#23167,ADD] -->

<!-- START 2018/02/20 K.Kojima [QC#24234,ADD] -->
    <statement id="getUpdateDsContrDtlPkForAccesory" parameterClass="Map" resultClass="Map">
        SELECT
             A.DS_CONTR_DTL_PK
            ,B.BASE_BILL_TO_CUST_CD
        FROM
             DS_CONTR_DTL A
            ,DS_CONTR_DTL B
        WHERE
                A.GLBL_CMPY_CD                = #glblCmpyCd#
            AND A.DS_CONTR_PK                 = #dsContrPk#
            AND A.DS_CONTR_DTL_TP_CD          = #dsContrDtlTpAcc#
            AND A.EZCANCELFLAG                = '0'
            AND A.GLBL_CMPY_CD                = B.GLBL_CMPY_CD
            AND A.PRNT_DS_CONTR_DTL_PK        = B.DS_CONTR_DTL_PK
            AND A.BASE_BILL_TO_CUST_CD &lt;&gt; B.BASE_BILL_TO_CUST_CD
            AND B.EZCANCELFLAG                = '0'
    </statement>
<!-- END 2018/02/20 K.Kojima [QC#24234,ADD] -->

    <statement id="getAggBllgFreeCopyCnt" parameterClass="Map" resultClass="BigDecimal">
        SELECT
                  MAX(DCBM.BLLG_FREE_COPY_CNT)  BLLG_FREE_COPY_CNT
            FROM
                DS_CONTR_DTL            DCD
                , DS_CONTR_BLLG_MTR     DCBM
            WHERE
                DCD.GLBL_CMPY_CD            = #glblCmpyCd#
                AND DCD.DS_CONTR_PK         = #dsContrPk#
                AND DCD.DS_CONTR_DTL_TP_CD  = #aggregate#
                AND DCD.EZCANCELFLAG        = '0'
                --
                AND DCD.GLBL_CMPY_CD        = DCBM.GLBL_CMPY_CD
                AND DCD.DS_CONTR_DTL_PK     = DCBM.DS_CONTR_DTL_PK
                AND DCBM.EZCANCELFLAG       = '0'
    </statement>
<!-- START 2018/05/24 K.Kishimoto [QC#26062,ADD] -->
    <statement id="getSvcPgmTpCd" parameterClass="Map" resultClass="Map">
        SELECT
             A.SVC_WTY_TP_CD
            ,A.SVC_PGM_TP_CD
        FROM
            MDSE                A
        WHERE
                A.GLBL_CMPY_CD      = #glblCmpyCd#
            AND A.EZCANCELFLAG      = '0'
            AND A.MDSE_CD           = #svcPgmMdseCd#
    </statement>
<!-- END 2018/0524 K.Kishimoto [QC#26062,ADD] -->

<!-- add start 2018/08/22 QC#23920 -->
    <statement id="getContrXsCopyForAgg" parameterClass="Map" resultClass="Map">
        SELECT
             DCBM.BLLG_MTR_LB_CD
            ,COUNT(CXC.CONTR_XS_COPY_PK) CNT
        FROM
             DS_CONTR_DTL      DCD
            ,DS_CONTR_BLLG_MTR DCBM
            ,CONTR_XS_COPY     CXC
        WHERE
                DCD.GLBL_CMPY_CD          = #glblCmpyCd#
            AND DCD.DS_CONTR_PK           = #dsContrPk#
            AND DCD.DS_CONTR_DTL_TP_CD    = #dsContrDtlTpAgg#
            AND DCD.EZCANCELFLAG          = '0'
            AND DCD.GLBL_CMPY_CD          = DCBM.GLBL_CMPY_CD
            AND DCD.DS_CONTR_DTL_PK       = DCBM.DS_CONTR_DTL_PK
            AND DCBM.EZCANCELFLAG         = '0'
            AND DCBM.GLBL_CMPY_CD         = CXC.GLBL_CMPY_CD
            AND DCBM.DS_CONTR_BLLG_MTR_PK = CXC.DS_CONTR_BLLG_MTR_PK
            AND CXC.EZCANCELFLAG          = '0'
        GROUP BY
            DCBM.BLLG_MTR_LB_CD
        ORDER BY
            DCBM.BLLG_MTR_LB_CD
    </statement>

    <statement id="getXsChrgTpCdForAgg" parameterClass="Map" resultClass="String">
        SELECT
            DCBM.XS_CHRG_TP_CD
        FROM
             DS_CONTR_DTL      DCD
            ,DS_CONTR_BLLG_MTR DCBM
        WHERE
                DCD.GLBL_CMPY_CD       = #glblCmpyCd#
            AND DCD.DS_CONTR_PK        = #dsContrPk#
            AND DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpAgg#
            AND DCD.EZCANCELFLAG       = '0'
            AND DCD.GLBL_CMPY_CD       = DCBM.GLBL_CMPY_CD
            AND DCD.DS_CONTR_DTL_PK    = DCBM.DS_CONTR_DTL_PK
            AND DCBM.BLLG_MTR_LB_CD    = #bllgMtrLbCd#
            AND DCBM.EZCANCELFLAG      = '0'
    </statement>
<!-- add end 2018/08/22 QC#23920 -->
<!-- START 2018/08/21 [QC#22821, ADD] -->
    <statement id="getAccMdseCd" parameterClass="CPO_DTLTMsg" resultClass="Map">
        SELECT
             DCD.MDSE_CD
        FROM
             CPO_DTL       DCD
        WHERE
                 DCD.GLBL_CMPY_CD         = #glblCmpyCd#
             AND DCD.CPO_ORD_NUM          = #cpoOrdNum#
             AND DCD.CPO_DTL_LINE_NUM     = #cpoDtlLineNum#
             AND DCD.CPO_DTL_LINE_SUB_NUM = #cpoDtlLineSubNum#
             AND DCD.EZCANCELFLAG         = '0'
    </statement>
<!-- END   2018/08/21 [QC#22821, ADD] -->

<!-- START 2018/09/19 K.Kitachi [QC#28164, ADD] -->
    <statement id="getDsContrDtlPkListForAcc" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            A.DS_CONTR_DTL_PK
        FROM
            DS_CONTR_DTL A
        WHERE
                A.GLBL_CMPY_CD         = #glblCmpyCd#
            AND A.CPO_ORD_NUM          = #cpoOrdNum#
            AND A.CPO_DTL_LINE_NUM     = #cpoDtlLineNum#
            AND A.CPO_DTL_LINE_SUB_NUM = #cpoDtlLineSubNum#
            AND A.EZCANCELFLAG         = '0'
            AND EXISTS (
                SELECT
                    1
                FROM
                    DS_CONTR_DTL_TP X
                WHERE
                        A.GLBL_CMPY_CD       = X.GLBL_CMPY_CD
                    AND A.DS_CONTR_DTL_TP_CD = X.DS_CONTR_DTL_TP_CD
                    AND X.MAIN_UNIT_LINE_FLG = 'N'
                    AND X.EZCANCELFLAG       = '0'
            )
    </statement>
    <statement id="getDsContrDtlPkListExstConfig" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            B.DS_CONTR_DTL_PK
        FROM
             DS_CONTR_DTL A
            ,DS_CONTR_DTL B
        WHERE
                A.GLBL_CMPY_CD         = #glblCmpyCd#
            AND A.CPO_ORD_NUM          = #cpoOrdNum#
            AND A.CPO_DTL_LINE_NUM     = #cpoDtlLineNum#
            AND A.CPO_DTL_LINE_SUB_NUM = #cpoDtlLineSubNum#
            AND A.EZCANCELFLAG         = '0'
            AND EXISTS (
                SELECT
                    1
                FROM
                    DS_CONTR_DTL_TP X
                WHERE
                        A.GLBL_CMPY_CD       = X.GLBL_CMPY_CD
                    AND A.DS_CONTR_DTL_TP_CD = X.DS_CONTR_DTL_TP_CD
                    AND X.MAIN_UNIT_LINE_FLG = 'Y'
                    AND X.EZCANCELFLAG       = '0'
            )
            AND EXISTS (
                SELECT
                    1
                FROM
                    DS_CONTR_DTL X
                WHERE
                        A.GLBL_CMPY_CD       = X.GLBL_CMPY_CD
                    AND A.CPO_ORD_NUM        = X.CPO_ORD_NUM
                    AND A.SHELL_LINE_NUM     = X.SHELL_LINE_NUM
                    AND A.SVC_CONFIG_MSTR_PK &lt;&gt; X.SVC_CONFIG_MSTR_PK
                    AND X.EZCANCELFLAG       = '0'
            )
            AND A.GLBL_CMPY_CD         = B.GLBL_CMPY_CD
            AND A.CPO_ORD_NUM          = B.CPO_ORD_NUM
            AND A.SHELL_LINE_NUM       = B.SHELL_LINE_NUM
            AND A.SVC_CONFIG_MSTR_PK   = B.SVC_CONFIG_MSTR_PK
            AND B.EZCANCELFLAG         = '0'
    </statement>
    <statement id="getDsContrDtlPkListNotExstConfig" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            B.DS_CONTR_DTL_PK
        FROM
             DS_CONTR_DTL A
            ,DS_CONTR_DTL B
        WHERE
                A.GLBL_CMPY_CD         = #glblCmpyCd#
            AND A.CPO_ORD_NUM          = #cpoOrdNum#
            AND A.CPO_DTL_LINE_NUM     = #cpoDtlLineNum#
            AND A.CPO_DTL_LINE_SUB_NUM = #cpoDtlLineSubNum#
            AND A.EZCANCELFLAG         = '0'
            AND EXISTS (
                SELECT
                    1
                FROM
                    DS_CONTR_DTL_TP X
                WHERE
                        A.GLBL_CMPY_CD       = X.GLBL_CMPY_CD
                    AND A.DS_CONTR_DTL_TP_CD = X.DS_CONTR_DTL_TP_CD
                    AND X.MAIN_UNIT_LINE_FLG = 'Y'
                    AND X.EZCANCELFLAG       = '0'
            )
            AND NOT EXISTS (
                SELECT
                    1
                FROM
                    DS_CONTR_DTL X
                WHERE
                        A.GLBL_CMPY_CD       = X.GLBL_CMPY_CD
                    AND A.CPO_ORD_NUM        = X.CPO_ORD_NUM
                    AND A.SHELL_LINE_NUM     = X.SHELL_LINE_NUM
                    AND A.SVC_CONFIG_MSTR_PK &lt;&gt; X.SVC_CONFIG_MSTR_PK
                    AND X.EZCANCELFLAG       = '0'
            )
            AND A.GLBL_CMPY_CD         = B.GLBL_CMPY_CD
            AND A.CPO_ORD_NUM          = B.CPO_ORD_NUM
            AND A.SHELL_LINE_NUM       = B.SHELL_LINE_NUM
            AND B.EZCANCELFLAG         = '0'
    </statement>
<!-- END 2018/09/19 K.Kitachi [QC#28164, ADD] -->

<!-- START 2019/05/23 W.Honda [QC#50157, ADD] -->
    <statement id="getExistDsCrCardPO" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            DS_CONTR_CR_CARD_PO_PK
        FROM
             (
             SELECT
                 A.DS_CONTR_CR_CARD_PO_PK
             FROM
                 DS_CONTR_CR_CARD_PO A
             WHERE
                 A.GLBL_CMPY_CD         = #glblCmpyCd#
             AND A.DS_CONTR_PK          = #dsContrPk#
             <isNotNull property="dsContrDtlPk">
             AND A.DS_CONTR_DTL_PK      = #dsContrDtlPk#
             </isNotNull>
             <isNull property="dsContrDtlPk">
             AND A.DS_CONTR_DTL_PK      IS NULL
             </isNull>
             AND CR_CARD_FLG            = 'N'
             AND A.EZCANCELFLAG         = '0'
             ORDER BY
                 A.EZINTIME
             )
        WHERE
            ROWNUM = 1
    </statement>
<!-- END 2019/05/23 W.Honda [QC#50157, ADD] -->
</sqlMap>

