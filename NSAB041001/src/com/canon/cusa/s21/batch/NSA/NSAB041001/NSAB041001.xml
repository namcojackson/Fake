<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSAB041001">
    <statement id="getSvcInvInfo" parameterClass="Map" resultClass="Map">
        SELECT
             SIV.SVC_INV_PK
            <!-- START 2017/11/22 [QC#21766,MOD] -->
            <!-- START 2017/08/01 K.Kojima [QC#20363,MOD] -->
            <!-- ,STC.DS_ACCT_DLR_CD -->
            <!-- ,SIL.DS_ACCT_DLR_CD -->
            ,NVL(SIL.DS_ACCT_DLR_CD, SIL.DS_ACCT_DLR_CD_P) DS_ACCT_DLR_CD
            <!-- END 2017/08/01 K.Kojima [QC#20363,MOD] -->
            <!-- END 2017/11/22 [QC#21766,MOD] -->
            ,DSC.DS_CONTR_PK
            ,SIV.DS_CONTR_NUM
            <!-- START 2017/06/02 K.Kojima [QC#18762, MOD] -->
            <!-- ,CLC.CFS_LEASE_NUM -->
            ,(
                SELECT
                    CFS_LEASE_NUM
                FROM
                    (
                        SELECT
                             CLC.CFS_LEASE_NUM AS CFS_LEASE_NUM
                            ,'01'              AS SORT_ORDER
                        FROM
                            CFS_LEASE_CONTR CLC
                        WHERE
                                DSC.GLBL_CMPY_CD        = CLC.GLBL_CMPY_CD
                            AND DSC.DS_CONTR_NUM        = CLC.CSA_CONTR_NUM
                            AND CLC.EZCANCELFLAG        = '0'
                        UNION ALL
                        SELECT
                             CLC.CFS_LEASE_NUM AS CFS_LEASE_NUM
                            ,'02'              AS SORT_ORDER
                        FROM
                            CFS_LEASE_CONTR CLC
                        WHERE
                                SIL.GLBL_CMPY_CD        = CLC.GLBL_CMPY_CD
                            AND SIL.SER_NUM             = CLC.SER_NUM
                            AND CLC.EZCANCELFLAG        = '0'
                        UNION ALL
                        SELECT
                             NULL              AS CFS_LEASE_NUM
                            ,'03'              AS SORT_ORDER
                        FROM
                            DUAL
                        ORDER BY
                             SORT_ORDER     ASC
                            ,CFS_LEASE_NUM  DESC
                    )
                WHERE
                    ROWNUM = 1
             ) AS CFS_LEASE_NUM
            <!-- END 2017/06/02 K.Kojima [QC#18762, MOD] -->
            ,SIV.SVC_INV_NUM
            ,SIL.SVC_INV_LINE_PK
            ,SIL.BLLG_PER_FROM_DT
            ,SIL.BLLG_PER_THRU_DT
            ,SIL.SVC_MACH_MSTR_PK
            ,SIL.SER_NUM
            ,SIL.TOT_COPY_QTY
            ,SIL.PREV_TOT_COPY_QTY
            ,SIL.TEST_COPY_QTY
            ,SIL.MTR_READ_DT
            ,DSC.DS_CONTR_CATG_CD
            ,SIL.SVC_INV_LINE_MTR_PK
            ,SIL.DS_CONTR_BLLG_MTR_PK
            ,SIL.MTR_LB_CD
            ,DCC.DS_CONTR_CATG_ABBR_NM
            ,SIL.SVC_PHYS_MTR_READ_GRP_SQ
        FROM
             SVC_INV            SIV
            ,DS_CONTR           DSC
            ,DS_CONTR_CATG      DCC
            <!-- START 2017/08/01 K.Kojima [QC#20363,DEL] -->
            <!-- ,SELL_TO_CUST       STC -->
            <!-- END 2017/08/01 K.Kojima [QC#20363,DEL] -->
            <!-- START 2017/06/02 K.Kojima [QC#18762, DEL] -->
            <!-- ,CFS_LEASE_CONTR    CLC -->
            <!-- END 2017/06/02 K.Kojima [QC#18762, DEL] -->
            ,(
                SELECT
                     SIV1.GLBL_CMPY_CD
                    ,SIV1.SVC_INV_PK
                    ,SILN.SVC_INV_LINE_PK
                    ,SILN.SVC_MACH_MSTR_PK
                    ,SILN.BLLG_PER_FROM_DT
                    ,SILN.BLLG_PER_THRU_DT
                    ,SILN.SER_NUM
                    ,SILM.SVC_INV_LINE_MTR_PK
                    ,SILM.DS_CONTR_BLLG_MTR_PK
                    ,SILM.TEST_COPY_QTY
                    ,SILM.TOT_COPY_QTY
                    ,SILM.PREV_TOT_COPY_QTY
                    ,SILM.MTR_READ_DT
                    ,SILM.MTR_LB_CD
                    ,SILM.SVC_PHYS_MTR_READ_GRP_SQ
                    <!-- START 2017/08/01 K.Kojima [QC#20363,ADD] -->
                    ,MSTC.DS_ACCT_DLR_CD
                    <!-- END 2017/08/01 K.Kojima [QC#20363,ADD] -->
                    <!-- START 2017/11/22 [QC#21766,ADD] -->
                    ,MSTC_P.DS_ACCT_DLR_CD DS_ACCT_DLR_CD_P
                    <!-- END 2017/11/22 [QC#21766,ADD] -->
                FROM
                     SVC_INV            SIV1
                    ,SVC_INV_LINE       SILN
                    ,SVC_INV_LINE_MTR   SILM
                    ,DS_CONTR           DSCN
                    <!-- START 2017/08/01 K.Kojima [QC#20363,ADD] -->
                    ,DS_CONTR_BLLG_MTR  DCBM
                    ,BILL_TO_CUST       MBTC
                    ,SELL_TO_CUST       MSTC
                    <!-- END 2017/08/01 K.Kojima [QC#20363,ADD] -->
                    <!-- START 2017/11/22 [QC#21766,ADD] -->
                    ,DS_CONTR_BLLG_SCHD SCHD
                    ,DS_CONTR_BLLG_SCHD SCHD_P
                    ,DS_CONTR_BLLG_MTR  DCBM_P
                    ,BILL_TO_CUST       MBTC_P
                    ,SELL_TO_CUST       MSTC_P
                    <!-- END 2017/11/22 [QC#21766,ADD] -->
                WHERE
                        SIV1.GLBL_CMPY_CD       = #glblCmpyCd#
                    AND SIV1.SVC_CR_REBIL_PK IS NULL
                    AND SIV1.CFS_LINK_STS_CD    IN (#cfsLinkStsCd_inCompleted#, #cfsLinkStsCd_error#)
                    AND SIV1.EZCANCELFLAG       = '0'
                    AND SIV1.GLBL_CMPY_CD       = SILN.GLBL_CMPY_CD
                    AND SIV1.SVC_INV_NUM        = SILN.SVC_INV_NUM
                    AND SILN.SVC_INV_LINE_TP_CD IN (#svcInvLineTpCd_fleet#, #svcInvLineTpCd_machine#)
                    AND SILN.EZCANCELFLAG       = '0'
                    AND SILN.GLBL_CMPY_CD       = SILM.GLBL_CMPY_CD
                    AND SILN.SVC_INV_LINE_PK    = SILM.SVC_INV_LINE_PK
                    AND SILN.SVC_INV_LINE_NUM   = SILM.SVC_INV_LINE_NUM
                    AND SILM.EZCANCELFLAG       = '0'
                    AND SIV1.GLBL_CMPY_CD       = DSCN.GLBL_CMPY_CD
                    AND SIV1.DS_CONTR_PK        = DSCN.DS_CONTR_PK
                    AND DSCN.DS_CONTR_EDI_CD    = #dsContrEdi_cfs#
                    AND DSCN.EZCANCELFLAG       = '0'
                    <!-- START 2017/08/01 K.Kojima [QC#20363,ADD] -->
                    AND SILM.GLBL_CMPY_CD             = DCBM.GLBL_CMPY_CD(+)
                    AND SILM.DS_CONTR_BLLG_MTR_PK     = DCBM.DS_CONTR_BLLG_MTR_PK(+)
                    AND DCBM.EZCANCELFLAG(+)          = '0'
                    AND DCBM.GLBL_CMPY_CD             = MBTC.GLBL_CMPY_CD(+)
                    AND DCBM.BLLG_MTR_BILL_TO_CUST_CD = MBTC.BILL_TO_CUST_CD(+)
                    AND MBTC.EZCANCELFLAG(+)          = '0'
                    AND MBTC.GLBL_CMPY_CD             = MSTC.GLBL_CMPY_CD(+)
                    AND MBTC.SELL_TO_CUST_CD          = MSTC.SELL_TO_CUST_CD(+)
                    <iterate property="dsAcctDlrCdList" var="dsAcctDlrCd[]" open="AND MSTC.DS_ACCT_DLR_CD(+) IN (" close=")" conjunction=",">
                    #dsAcctDlrCd[]#
                    </iterate>
                    AND MSTC.EZCANCELFLAG(+)          = '0'
                    <!-- END 2017/08/01 K.Kojima [QC#20363,ADD] -->
                    <!-- START 2017/07/24 K.Kojima [QC#20090,ADD] -->
                    <!-- START 2017/08/01 K.Kojima [QC#20363,DEL] -->
                    <!-- AND EXISTS( -->
                    <!--     SELECT -->
                    <!--         1 -->
                    <!--     FROM -->
                    <!--          DS_CONTR_BLLG_MTR DCBM -->
                    <!--         ,BILL_TO_CUST      MBTC -->
                    <!--         ,SELL_TO_CUST      MSTC -->
                    <!--     WHERE -->
                    <!--             DCBM.GLBL_CMPY_CD             = SILM.GLBL_CMPY_CD -->
                    <!--         AND DCBM.DS_CONTR_BLLG_MTR_PK     = SILM.DS_CONTR_BLLG_MTR_PK -->
                    <!--         AND DCBM.GLBL_CMPY_CD             = MBTC.GLBL_CMPY_CD -->
                    <!--         AND DCBM.BLLG_MTR_BILL_TO_CUST_CD = MBTC.BILL_TO_CUST_CD -->
                    <!--         AND MBTC.GLBL_CMPY_CD             = MSTC.GLBL_CMPY_CD -->
                    <!--         AND MBTC.SELL_TO_CUST_CD          = MSTC.SELL_TO_CUST_CD -->
                    <!--         <iterate property="dsAcctDlrCdList" var="dsAcctDlrCd[]" open="AND MSTC.DS_ACCT_DLR_CD IN (" close=")" conjunction=","> -->
                    <!--             #dsAcctDlrCd[]# -->
                    <!--         </iterate> -->
                    <!--         AND DCBM.EZCANCELFLAG             = '0' -->
                    <!--         AND MBTC.EZCANCELFLAG             = '0' -->
                    <!--         AND MSTC.EZCANCELFLAG             = '0' -->
                    <!-- ) -->
                    <!-- END 2017/08/01 K.Kojima [QC#20363,DEL] -->
                    <!-- END 2017/07/24 K.Kojima [QC#20090,ADD] -->
                    <!-- START 2017/11/22 [QC#21766,ADD] -->
                    AND SILN.GLBL_CMPY_CD               = SCHD.GLBL_CMPY_CD(+)
                    AND SILN.DS_CONTR_BLLG_SCHD_PK      = SCHD.DS_CONTR_BLLG_SCHD_PK(+)
                    AND SCHD.EZCANCELFLAG(+)            = '0'
                    AND SCHD.GLBL_CMPY_CD               = SCHD_P.GLBL_CMPY_CD(+)
                    AND SCHD.PRNT_DS_CONTR_BLLG_SCHD_PK = SCHD_P.DS_CONTR_BLLG_SCHD_PK(+)
                    AND SCHD_P.EZCANCELFLAG(+)          = '0'
                    AND SCHD_P.GLBL_CMPY_CD             = DCBM_P.GLBL_CMPY_CD(+)
                    AND SCHD_P.DS_CONTR_BLLG_MTR_PK     = DCBM_P.DS_CONTR_BLLG_MTR_PK(+)
                    AND DCBM_P.EZCANCELFLAG(+)          = '0'
                    AND DCBM_P.GLBL_CMPY_CD             = MBTC_P.GLBL_CMPY_CD(+)
                    AND DCBM_P.BLLG_MTR_BILL_TO_CUST_CD = MBTC_P.BILL_TO_CUST_CD(+)
                    AND MBTC_P.EZCANCELFLAG(+)          = '0'
                    AND MBTC_P.GLBL_CMPY_CD             = MSTC_P.GLBL_CMPY_CD(+)
                    AND MBTC_P.SELL_TO_CUST_CD          = MSTC_P.SELL_TO_CUST_CD(+)
                    <iterate property="dsAcctDlrCdList" var="dsAcctDlrCd[]" open="AND MSTC_P.DS_ACCT_DLR_CD(+) IN (" close=")" conjunction=",">
                    #dsAcctDlrCd[]#
                    </iterate>
                    AND MSTC_P.EZCANCELFLAG(+)          = '0'
                    <!-- START 2017/11/22 [QC#21766,ADD] -->
                    AND (
                            EXISTS(
                                SELECT
                                    1
                                FROM
                                    DS_CONTR_BLLG_MTR DCBM
                                    ,BILL_TO_CUST      MBTC
                                    ,SELL_TO_CUST      MSTC
                                WHERE
                                        DCBM.GLBL_CMPY_CD             = SILM.GLBL_CMPY_CD
                                    AND DCBM.DS_CONTR_BLLG_MTR_PK     = SILM.DS_CONTR_BLLG_MTR_PK
                                    AND DCBM.GLBL_CMPY_CD             = MBTC.GLBL_CMPY_CD
                                    AND DCBM.BLLG_MTR_BILL_TO_CUST_CD = MBTC.BILL_TO_CUST_CD
                                    AND MBTC.GLBL_CMPY_CD             = MSTC.GLBL_CMPY_CD
                                    AND MBTC.SELL_TO_CUST_CD          = MSTC.SELL_TO_CUST_CD
                                    <iterate property="dsAcctDlrCdList" var="dsAcctDlrCd[]" open="AND MSTC.DS_ACCT_DLR_CD IN (" close=")" conjunction=",">
                                        #dsAcctDlrCd[]#
                                    </iterate>
                                    AND DCBM.EZCANCELFLAG             = '0'
                                    AND MBTC.EZCANCELFLAG             = '0'
                                    AND MSTC.EZCANCELFLAG             = '0'
                            )
                            OR EXISTS(
                                SELECT
                                    1
                                FROM
                                     DS_CONTR_BLLG_MTR DCBM
                                    ,BILL_TO_CUST      MBTC
                                    ,SELL_TO_CUST      MSTC
                                WHERE
                                        DCBM.GLBL_CMPY_CD             = DCBM_P.GLBL_CMPY_CD
                                    AND DCBM.DS_CONTR_BLLG_MTR_PK     = DCBM_P.DS_CONTR_BLLG_MTR_PK
                                    AND DCBM.GLBL_CMPY_CD             = MBTC.GLBL_CMPY_CD
                                    AND DCBM.BLLG_MTR_BILL_TO_CUST_CD = MBTC.BILL_TO_CUST_CD
                                    AND MBTC.GLBL_CMPY_CD             = MSTC.GLBL_CMPY_CD
                                    AND MBTC.SELL_TO_CUST_CD          = MSTC.SELL_TO_CUST_CD
                                    <iterate property="dsAcctDlrCdList" var="dsAcctDlrCd[]" open="AND MSTC.DS_ACCT_DLR_CD IN (" close=")" conjunction=",">
                                        #dsAcctDlrCd[]#
                                    </iterate>
                                    AND DCBM.EZCANCELFLAG             = '0'
                                    AND MBTC.EZCANCELFLAG             = '0'
                                    AND MSTC.EZCANCELFLAG             = '0'
                            )
                        )
                    <!-- END 2017/11/22 [QC#21766,ADD] -->
                ) SIL
        WHERE
                SIV.GLBL_CMPY_CD        = #glblCmpyCd#
            AND SIV.SVC_CR_REBIL_PK IS NULL
            AND SIV.CFS_LINK_STS_CD     IN (#cfsLinkStsCd_inCompleted#, #cfsLinkStsCd_error#)
            AND SIV.EZCANCELFLAG        = '0'
            AND SIV.GLBL_CMPY_CD        = DSC.GLBL_CMPY_CD(+)
            AND SIV.DS_CONTR_PK         = DSC.DS_CONTR_PK(+)
            AND DSC.DS_CONTR_EDI_CD(+)  = #dsContrEdi_cfs#
            AND DSC.EZCANCELFLAG(+)     = '0'
            AND DSC.GLBL_CMPY_CD        = DCC.GLBL_CMPY_CD(+)
            AND DSC.DS_CONTR_CATG_CD    = DCC.DS_CONTR_CATG_CD(+)
            AND DCC.EZCANCELFLAG(+)     = '0'
            <!-- START 2017/08/01 K.Kojima [QC#20363,DEL] -->
            <!-- AND DSC.GLBL_CMPY_CD        = STC.GLBL_CMPY_CD(+) -->
            <!-- AND DSC.DS_ACCT_NUM         = STC.SELL_TO_CUST_CD(+) -->
            <!-- AND STC.EZCANCELFLAG(+)     = '0' -->
            <!-- END 2017/08/01 K.Kojima [QC#20363,DEL] -->
            <!-- START 2017/06/02 K.Kojima [QC#18762, DEL] -->
            <!-- AND DSC.GLBL_CMPY_CD        = CLC.GLBL_CMPY_CD(+) -->
            <!-- AND DSC.DS_CONTR_NUM        = CLC.CSA_CONTR_NUM(+) -->
            <!-- AND CLC.EZCANCELFLAG(+)     = '0' -->
            <!-- END 2017/06/02 K.Kojima [QC#18762, DEL] -->
            AND SIV.GLBL_CMPY_CD        = SIL.GLBL_CMPY_CD(+)
            AND SIV.SVC_INV_PK          = SIL.SVC_INV_PK(+)
        ORDER BY
             SIV.SVC_INV_PK          ASC
            ,SIL.SVC_INV_LINE_PK     ASC
            ,SIL.SVC_INV_LINE_MTR_PK ASC
    </statement>
</sqlMap>
