<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSAL0460Query">
    <typeAlias alias="NSAL0460_ASMsg"  type="business.blap.NSAL0460.NSAL0460_ASMsg"/>

    <statement id="getMainData" parameterClass="Map" resultMap="result.getMainData">
<!-- START 2018/05/11 K.Kojima [QC#24817,MOD] -->
    WITH MTR_FMLA_DATA AS (
        SELECT
            *
        FROM
            MTR_FMLA MF
        WHERE
                MF.GLBL_CMPY_CD = #glblCmpyCd#
            AND MF.EZCANCELFLAG = '0'
    )
    ,MTR_FMLA_INFO AS (
        SELECT A.MTR_GRP_PK,A.MTR_LB_CD,A.FMLA_MTR_LB_CD_01 AS FMLA_MTR_LB_CD FROM MTR_FMLA_DATA A WHERE A.FMLA_MTR_LB_CD_01 IS NOT NULL UNION
        SELECT A.MTR_GRP_PK,A.MTR_LB_CD,A.FMLA_MTR_LB_CD_02 AS FMLA_MTR_LB_CD FROM MTR_FMLA_DATA A WHERE A.FMLA_MTR_LB_CD_02 IS NOT NULL UNION
        SELECT A.MTR_GRP_PK,A.MTR_LB_CD,A.FMLA_MTR_LB_CD_03 AS FMLA_MTR_LB_CD FROM MTR_FMLA_DATA A WHERE A.FMLA_MTR_LB_CD_03 IS NOT NULL UNION
        SELECT A.MTR_GRP_PK,A.MTR_LB_CD,A.FMLA_MTR_LB_CD_04 AS FMLA_MTR_LB_CD FROM MTR_FMLA_DATA A WHERE A.FMLA_MTR_LB_CD_04 IS NOT NULL UNION
        SELECT A.MTR_GRP_PK,A.MTR_LB_CD,A.FMLA_MTR_LB_CD_05 AS FMLA_MTR_LB_CD FROM MTR_FMLA_DATA A WHERE A.FMLA_MTR_LB_CD_05 IS NOT NULL UNION
        SELECT A.MTR_GRP_PK,A.MTR_LB_CD,A.FMLA_MTR_LB_CD_06 AS FMLA_MTR_LB_CD FROM MTR_FMLA_DATA A WHERE A.FMLA_MTR_LB_CD_06 IS NOT NULL UNION
        SELECT A.MTR_GRP_PK,A.MTR_LB_CD,A.FMLA_MTR_LB_CD_07 AS FMLA_MTR_LB_CD FROM MTR_FMLA_DATA A WHERE A.FMLA_MTR_LB_CD_07 IS NOT NULL UNION
        SELECT A.MTR_GRP_PK,A.MTR_LB_CD,A.FMLA_MTR_LB_CD_08 AS FMLA_MTR_LB_CD FROM MTR_FMLA_DATA A WHERE A.FMLA_MTR_LB_CD_08 IS NOT NULL UNION
        SELECT A.MTR_GRP_PK,A.MTR_LB_CD,A.FMLA_MTR_LB_CD_09 AS FMLA_MTR_LB_CD FROM MTR_FMLA_DATA A WHERE A.FMLA_MTR_LB_CD_09 IS NOT NULL UNION
        SELECT A.MTR_GRP_PK,A.MTR_LB_CD,A.FMLA_MTR_LB_CD_10 AS FMLA_MTR_LB_CD FROM MTR_FMLA_DATA A WHERE A.FMLA_MTR_LB_CD_10 IS NOT NULL
    )
<!-- END 2018/05/11 K.Kojima [QC#24817,MOD] -->
    SELECT
        ROWNUM AS ROW_NUM
<!-- START 2018/05/11 K.Kojima [QC#24817,MOD] -->
<!--         ,FRST_CNT_ROW -->
<!--         ,FRST_SER_ROW -->
<!-- START 2018/07/18 [QC#26859,MOD] -->
        ,ROW_NUMBER() OVER (PARTITION BY DS_CONTR_PK ORDER BY DS_CONTR_NUM, SER_NUM, CONTR_EFF_FROM_DT, DS_CONTR_DTL_PK ,MDL_MTR_LB_CD) AS FRST_CNT_ROW
        ,ROW_NUMBER() OVER (PARTITION BY DS_CONTR_PK,SER_NUM, CONTR_EFF_FROM_DT, DS_CONTR_DTL_PK ORDER BY DS_CONTR_NUM , SER_NUM, CONTR_EFF_FROM_DT, DS_CONTR_DTL_PK ,MDL_MTR_LB_CD) AS FRST_SER_ROW
<!-- START 2018/07/18 [QC#26859,MOD] -->
<!-- END 2018/05/11 K.Kojima [QC#24817,MOD] -->
        ,DS_CONTR_PK
        ,DS_CONTR_NUM
        ,DS_CONTR_DTL_PK
        ,SVC_MACH_MSTR_PK
        ,SER_NUM
        ,CONTR_EFF_FROM_DT
        ,CONTR_EFF_FROM_DT AS CONTR_EFF_FROM_DT_P
        ,MDL_MTR_LB_CD
        ,MTR_LB_DESC_TXT
        ,MTR_READ_DT
        ,READ_MTR_CNT
        ,SVC_PHYS_MTR_PK
        ,CASE
<!-- START 2018/05/11 K.Kojima [QC#24817,ADD] -->
            WHEN  MDL_MTR_LB_CD IS NULL
                THEN 'N'
<!-- END 2018/05/11 K.Kojima [QC#24817,ADD] -->
            WHEN  BILL_FLG = 'Y' 
                THEN 'N'
<!-- [QC#2882,MOD]START -->
<!--
            WHEN  DS_CONTR_STS_CD     = #stsTerm# OR DS_CONTR_STS_CD     = #stsExp# OR DS_CONTR_STS_CD     = #stsCan# OR DS_CONTR_STS_CD     = #stsTermHold# OR DS_CONTR_STS_CD     = #stsExpHold# OR 
                  DS_CONTR_DTL_STS_CD = #stsTerm# OR DS_CONTR_DTL_STS_CD = #stsExp# OR DS_CONTR_DTL_STS_CD = #stsCan# OR DS_CONTR_DTL_STS_CD = #stsTermHold# OR DS_CONTR_DTL_STS_CD = #stsExpHold#
                THEN 'N'
            ELSE     'Y'
-->
<!-- START 2018/10/01 K.Kitachi [QC#28396, MOD] -->
<!--        WHEN  (DS_CONTR_STS_CD     = #stsDraft#  OR  DS_CONTR_STS_CD     = #stsEnterd#  OR  DS_CONTR_STS_CD     = #stsQaHold#) -->
<!--         AND  (DS_CONTR_DTL_STS_CD = #stsDraft#  OR  DS_CONTR_DTL_STS_CD = #stsEnterd#  OR  DS_CONTR_DTL_STS_CD = #stsQaHold#) -->
            WHEN  EXISTS (
                    SELECT
                        1
                    FROM
                        DS_CONTR_STS_V X
                    WHERE
                            A.GLBL_CMPY_CD         = X.GLBL_CMPY_CD
                        AND A.DS_CONTR_PK          = X.DS_CONTR_PK
                        AND X.DS_CONTR_CTRL_STS_CD IN (#stsDraft#, #stsEnterd#, #stsQaHold#)
                        AND X.EZCANCELFLAG         = '0'
                  )
             AND  EXISTS (
                    SELECT
                        1
                    FROM
                        DS_CONTR_DTL_STS_V X
                    WHERE
                            A.GLBL_CMPY_CD         = X.GLBL_CMPY_CD
                        AND A.DS_CONTR_PK          = X.DS_CONTR_PK
                        AND A.DS_CONTR_DTL_PK      = X.DS_CONTR_DTL_PK
                        AND X.DS_CONTR_CTRL_STS_CD IN (#stsDraft#, #stsEnterd#, #stsQaHold#)
                        AND X.EZCANCELFLAG         = '0'
                  )
<!-- END 2018/10/01 K.Kitachi [QC#28396, MOD] -->
                THEN 'Y'
            ELSE     'N'
<!-- [QC#2882,MOD]END -->
        END AS ACTV_FLG
        ,SVC_CMNT_TXT
<!-- START 2017/01/04 K.Ochiai [QC#16584, ADD] -->
        ,DS_MTR_READ_TP_GRP_CD
<!-- END 2017/01/04 K.Ochiai [QC#16584, ADD] -->
<!-- START 2016/12/07 K.Ochiai [QC#14204, ADD] -->
        ,XX_REC_HIST_CRAT_TS
        ,XX_REC_HIST_CRAT_BY_NM
        ,XX_REC_HIST_UPD_TS
        ,XX_REC_HIST_UPD_BY_NM
        ,XX_REC_HIST_TBL_NM
<!-- END 2016/12/07 K.Ochiai [QC#14204, ADD] -->
    FROM
    (    SELECT
<!-- START 2018/10/01 K.Kitachi [QC#28396, ADD] -->
             CNT.GLBL_CMPY_CD
<!-- END 2018/10/01 K.Kitachi [QC#28396, ADD] -->
<!-- START 2018/05/11 K.Kojima [QC#24817,MOD] -->
<!--             ROW_NUMBER() OVER (PARTITION BY CNT.DS_CONTR_PK ORDER BY CNT.DS_CONTR_NUM ,MCH.SER_NUM ,PMT.MDL_MTR_LB_CD) AS FRST_CNT_ROW -->
<!--             ,ROW_NUMBER() OVER (PARTITION BY CNT.DS_CONTR_PK,MCH.SER_NUM ORDER BY CNT.DS_CONTR_NUM ,MCH.SER_NUM ,PMT.MDL_MTR_LB_CD) AS FRST_SER_ROW -->
<!--             ,CNT.DS_CONTR_PK -->
            ,CNT.DS_CONTR_PK
<!-- END 2018/05/11 K.Kojima [QC#24817,MOD] -->
            ,CNT.DS_CONTR_NUM
<!-- START 2018/10/01 K.Kitachi [QC#28396, DEL] -->
<!--        ,CNV.DS_CONTR_CTRL_STS_CD AS DS_CONTR_STS_CD -->
<!-- END 2018/10/01 K.Kitachi [QC#28396, DEL] -->
            ,DTL.DS_CONTR_DTL_PK
<!-- START 2018/10/01 K.Kitachi [QC#28396, DEL] -->
<!--        ,DTS.DS_CONTR_CTRL_STS_CD AS DS_CONTR_DTL_STS_CD -->
<!-- END 2018/10/01 K.Kitachi [QC#28396, DEL] -->
            ,DTL.SVC_MACH_MSTR_PK
            ,MCH.SER_NUM
            ,DTL.CONTR_EFF_FROM_DT
            ,PMT.MDL_MTR_LB_CD
            ,MLB.MTR_LB_DESC_TXT
            ,PMTR.MTR_READ_DT
            ,PMTR.READ_MTR_CNT
            ,PMT.SVC_PHYS_MTR_PK
            ,CASE WHEN CNT.DS_CONTR_CATG_CD = #dsContrCatgCd#  THEN 
                        CASE WHEN (SELECT COUNT(*)
                                    FROM DS_CONTR_BLLG_SCHD CBS 
                                    WHERE CBS.GLBL_CMPY_CD      = DTL.GLBL_CMPY_CD 
                                        AND CBS.DS_CONTR_DTL_PK = DTL.PRNT_DS_CONTR_DTL_PK
                                        AND CBS.USG_CHRG_FLG    = 'Y'
                                        AND CBS.INV_FLG         = 'Y'
                                        AND CBS.EZCANCELFLAG    = '0' ) &gt; 0
                               THEN 'Y'
                            ELSE    'N'
                        END
                    ELSE
                        CASE WHEN (SELECT COUNT(*)
                                    FROM DS_CONTR_BLLG_SCHD CBS 
                                    WHERE CBS.GLBL_CMPY_CD      = DTL.GLBL_CMPY_CD 
                                        AND CBS.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK
                                        AND CBS.USG_CHRG_FLG    = 'Y'
                                        AND CBS.INV_FLG         = 'Y'
                                        AND CBS.EZCANCELFLAG    = '0' ) &gt; 0
                               THEN 'Y'
                            ELSE    'N'
                        END
            END     AS BILL_FLG
<!-- START 2018/02/08 M.Kidokoro [QC#18145,MOD] -->
<!--        ,MEMO.SVC_CMNT_TXT -->
            ,PMTR.MTR_ENTRY_CMNT_TXT AS SVC_CMNT_TXT
<!-- END 2018/02/08 M.Kidokoro [QC#18145,MOD] -->
<!-- START 2017/01/04 K.Ochiai [QC#16584, ADD] -->
            ,PMTR.DS_MTR_READ_TP_GRP_CD     AS DS_MTR_READ_TP_GRP_CD
<!-- END 2017/01/04 K.Ochiai [QC#16584, ADD] -->
<!-- START 2016/12/07 K.Ochiai [QC#14204, ADD] -->
            ,PMTR.EZINTIME      AS XX_REC_HIST_CRAT_TS
            ,PMTR.EZINUSERID    AS XX_REC_HIST_CRAT_BY_NM
            ,PMTR.EZUPTIME      AS XX_REC_HIST_UPD_TS
            ,PMTR.EZUPUSERID    AS XX_REC_HIST_UPD_BY_NM
            ,PMTR.EZTABLEID     AS XX_REC_HIST_TBL_NM
<!-- END 2016/12/07 K.Ochiai [QC#14204, ADD] -->
        FROM
            DS_CONTR            CNT
<!-- START 2018/10/01 K.Kitachi [QC#28396, DEL] -->
<!--        ,DS_CONTR_STS_V     CNV -->
<!-- END 2018/10/01 K.Kitachi [QC#28396, DEL] -->
            ,DS_CONTR_DTL       DTL
<!-- START 2018/07/18 [QC#26859,ADD] -->
            ,DS_CONTR_DTL_TP    DTP
<!-- END   2018/07/18 [QC#26859,ADD] -->
<!-- START 2018/10/01 K.Kitachi [QC#28396, DEL] -->
<!--        ,DS_CONTR_DTL_STS_V DTS -->
<!-- END 2018/10/01 K.Kitachi [QC#28396, DEL] -->
            ,SVC_MACH_MSTR      MCH
            ,SVC_PHYS_MTR       PMT
            ,SVC_PHYS_MTR_READ  PMTR
            ,MTR_LB             MLB
<!-- START 2018/02/08 M.Kidokoro [QC#18145,DEL] -->
<!--        ,( -->
<!--          SELECT -->
<!--               MEMO1.SVC_MEMO_TRX_NUM         AS SVC_MEMO_TRX_NUM -->
<!--              ,MEMO1.SVC_CMNT_TXT             AS SVC_CMNT_TXT -->
<!--          FROM -->
<!--             ( -->
<!--               SELECT -->
<!--                    MEMO2.GLBL_CMPY_CD        AS GLBL_CMPY_CD -->
<!--                   ,MEMO2.SVC_MEMO_TRX_NUM    AS SVC_MEMO_TRX_NUM -->
<!--                   ,MEMO2.SVC_CMNT_TXT        AS SVC_CMNT_TXT -->
<!--                   ,ROW_NUMBER() OVER(PARTITION BY MEMO2.SVC_MEMO_TRX_NUM  ORDER BY MEMO2.EZINTIME DESC, MEMO2.SVC_MEMO_PK DESC) -->
<!--                                              AS ROW_NUM -->
<!--               FROM -->
<!--                   SVC_MEMO MEMO2 -->
<!--               WHERE -->
<!--                       MEMO2.GLBL_CMPY_CD     = #glblCmpyCd# -->
<!--                   AND MEMO2.SVC_MEMO_TP_CD   = #svcMemoTpCd# -->
<!--                   AND MEMO2.SVC_MEMO_TRX_NM  = #svcMemoTrxNm# -->
<!--                   AND MEMO2.EZCANCELFLAG     = '0' -->
<!--              ) MEMO1 -->
<!--          WHERE -->
<!--              MEMO1.ROW_NUM = 1 -->
<!--         ) MEMO -->
<!-- END 2018/02/08 M.Kidokoro [QC#18145,DEL] -->
        WHERE
            CNT.GLBL_CMPY_CD            = #glblCmpyCd#
            <iterate property="dsContrPkList" var="dsContrPkList[]" open="            AND CNT.DS_CONTR_PK IN (" close=")" conjunction=",">
                #dsContrPkList[]#
            </iterate>
            AND CNT.EZCANCELFLAG        = '0'
            AND CNT.GLBL_CMPY_CD        = DTL.GLBL_CMPY_CD
            AND CNT.DS_CONTR_PK         = DTL.DS_CONTR_PK
            <iterate property="dsContrDtlPkList" var="dsContrDtlPkList[]" open="      AND DTL.DS_CONTR_DTL_PK IN (" close=")" conjunction=",">
                #dsContrDtlPkList[]#
            </iterate>
            AND DTL.EZCANCELFLAG        = '0'
<!-- START 2018/07/18 [QC#26859,ADD] -->
            AND DTL.GLBL_CMPY_CD        = DTP.GLBL_CMPY_CD
            AND DTP.EZCANCELFLAG        = '0'
            AND DTL.DS_CONTR_DTL_TP_CD  = DTP.DS_CONTR_DTL_TP_CD
            AND DTP.USG_CHRG_FLG        = 'Y'
<!-- END   2018/07/18 [QC#26859,ADD] -->
<!-- START 2018/10/01 K.Kitachi [QC#28396, DEL] -->
<!--        AND CNT.GLBL_CMPY_CD        = CNV.GLBL_CMPY_CD -->
<!--        AND CNT.DS_CONTR_PK         = CNV.DS_CONTR_PK -->
<!--        AND CNV.EZCANCELFLAG        = '0' -->
<!--        AND DTL.GLBL_CMPY_CD        = DTS.GLBL_CMPY_CD -->
<!--        AND DTL.DS_CONTR_PK         = DTS.DS_CONTR_PK -->
<!--        AND DTL.DS_CONTR_DTL_PK     = DTS.DS_CONTR_DTL_PK -->
<!--        AND DTS.EZCANCELFLAG        = '0' -->
<!-- END 2018/10/01 K.Kitachi [QC#28396, DEL] -->
            AND DTL.GLBL_CMPY_CD        = MCH.GLBL_CMPY_CD
            AND DTL.SVC_MACH_MSTR_PK    = MCH.SVC_MACH_MSTR_PK
            AND MCH.EZCANCELFLAG        = '0'
            AND DTL.GLBL_CMPY_CD        = PMT.GLBL_CMPY_CD
            AND DTL.SVC_MACH_MSTR_PK    = PMT.SVC_MACH_MSTR_PK
            AND PMT.EZCANCELFLAG        = '0'
            AND PMT.GLBL_CMPY_CD        = PMTR.GLBL_CMPY_CD(+)
            AND PMT.SVC_PHYS_MTR_PK     = PMTR.SVC_PHYS_MTR_PK(+)
            AND DTL.DS_CONTR_DTL_PK     = PMTR.DS_CONTR_DTL_PK(+)
            AND PMTR.EZCANCELFLAG(+)    = '0'
            AND PMT.GLBL_CMPY_CD        = MLB.GLBL_CMPY_CD
            AND PMT.MDL_MTR_LB_CD       = MLB.MTR_LB_CD
            AND MLB.EZCANCELFLAG        = '0'
<!-- START 2018/02/08 M.Kidokoro [QC#18145,DEL] -->
<!--        AND PMT.SVC_PHYS_MTR_PK     = MEMO.SVC_MEMO_TRX_NUM(+) -->
<!-- END 2018/02/08 M.Kidokoro [QC#18145,DEL] -->
<!-- START 2017/07/13 K.Kim [QC#17276, ADD] -->
<!-- START 2018/05/11 K.Kojima [QC#24817,DEL] -->
<!--             AND PMT.SVC_PHYS_MTR_PK NOT IN ( -->
<!--                 SELECT -->
<!--                     PMT2.SVC_PHYS_MTR_PK -->
<!--                 FROM -->
<!--                     DS_CONTR           CNT2 -->
<!--                    ,DS_CONTR_DTL       DTL2 -->
<!--                    ,SVC_PHYS_MTR       PMT2 -->
<!--                    ,MTR_GRP            MGP2 -->
<!--                    ,MTR_LB             MLB2 -->
<!--                 WHERE -->
<!--                     CNT2.GLBL_CMPY_CD            = #glblCmpyCd# -->
<!--                 <iterate property="dsContrPkList" var="dsContrPkList[]" open="            AND CNT2.DS_CONTR_PK IN (" close=")" conjunction=","> -->
<!--                     #dsContrPkList[]# -->
<!--                 </iterate> -->
<!--                 AND CNT2.EZCANCELFLAG            = '0' -->
<!--                 AND CNT2.GLBL_CMPY_CD            = DTL2.GLBL_CMPY_CD -->
<!--                 AND CNT2.EZCANCELFLAG            = DTL2.EZCANCELFLAG -->
<!--                 AND CNT2.DS_CONTR_PK             = DTL2.DS_CONTR_PK -->
<!--                 <iterate property="dsContrDtlPkList" var="dsContrDtlPkList[]" open="      AND DTL2.DS_CONTR_DTL_PK IN (" close=")" conjunction=","> -->
<!--                     #dsContrDtlPkList[]# -->
<!--                 </iterate> -->
<!--                 AND DTL2.GLBL_CMPY_CD            = PMT2.GLBL_CMPY_CD -->
<!--                 AND DTL2.EZCANCELFLAG            = PMT2.EZCANCELFLAG -->
<!--                 AND DTL2.SVC_MACH_MSTR_PK        = PMT2.SVC_MACH_MSTR_PK -->
<!--                 AND PMT2.GLBL_CMPY_CD            = MGP2.GLBL_CMPY_CD -->
<!--                 AND PMT2.EZCANCELFLAG            = MGP2.EZCANCELFLAG -->
<!--                 AND PMT2.MTR_GRP_PK              = MGP2.MTR_GRP_PK -->
<!--                 AND MGP2.COLOR_MTR_AUTO_DRV_FLG  = 'Y' -->
<!--                 AND PMT2.GLBL_CMPY_CD            = MLB2.GLBL_CMPY_CD -->
<!--                 AND PMT2.EZCANCELFLAG            = MLB2.EZCANCELFLAG -->
<!--                 AND PMT2.MDL_MTR_LB_CD           = MLB2.MTR_LB_CD -->
<!--                 AND MLB2.COLOR_MTR_FLG           = 'Y' -->
<!--         ) -->
<!-- END 2018/05/11 K.Kojima [QC#24817,DEL] -->
<!-- END 2017/07/13 K.Kim [QC#17276, ADD] -->
<!-- START 2018/05/11 K.Kojima [QC#24817,ADD] -->
            AND (
                EXISTS(
                    SELECT
                        1
                    FROM
                        CONTR_PHYS_BLLG_MTR_RELN CPBMR
                    WHERE
                            CPBMR.GLBL_CMPY_CD    = DTL.GLBL_CMPY_CD
                        AND CPBMR.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK
                        AND CPBMR.GLBL_CMPY_CD    = PMT.GLBL_CMPY_CD
                        AND CPBMR.SVC_PHYS_MTR_PK = PMT.SVC_PHYS_MTR_PK
                        AND CPBMR.BLLG_MTR_LB_CD IS NOT NULL
                        AND CPBMR.EZCANCELFLAG    = '0'
                ) OR EXISTS(
                    SELECT
                        1
                    FROM
                         MTR_FMLA_INFO MFI
                    WHERE
                            MFI.MTR_GRP_PK       = PMT.MTR_GRP_PK
                        AND MFI.FMLA_MTR_LB_CD   = PMT.MDL_MTR_LB_CD
                )
            )
            AND EXISTS(
                SELECT
                    1
                FROM
                    CONTR_PHYS_BLLG_MTR_RELN CPBMR
                WHERE
                        CPBMR.GLBL_CMPY_CD    = DTL.GLBL_CMPY_CD
                    AND CPBMR.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK
                    AND CPBMR.BLLG_MTR_LB_CD  IS NOT NULL
                    AND CPBMR.EZCANCELFLAG    = '0'
            )
            AND NOT EXISTS(
                SELECT
                    1
                FROM
                    MTR_FMLA MF
                WHERE
                        MF.GLBL_CMPY_CD = PMT.GLBL_CMPY_CD
                    AND MF.MTR_GRP_PK   = PMT.MTR_GRP_PK
                    AND MF.MTR_LB_CD    = PMT.MDL_MTR_LB_CD
                    AND MF.EZCANCELFLAG = '0'
            )
            UNION ALL
         SELECT
<!-- START 2018/10/01 K.Kitachi [QC#28396, ADD] -->
             CNT.GLBL_CMPY_CD
<!-- END 2018/10/01 K.Kitachi [QC#28396, ADD] -->
            ,CNT.DS_CONTR_PK
            ,CNT.DS_CONTR_NUM
<!-- START 2018/10/01 K.Kitachi [QC#28396, DEL] -->
<!--        ,CNV.DS_CONTR_CTRL_STS_CD AS DS_CONTR_STS_CD -->
<!-- END 2018/10/01 K.Kitachi [QC#28396, DEL] -->
            ,DTL.DS_CONTR_DTL_PK
<!-- START 2018/10/01 K.Kitachi [QC#28396, DEL] -->
<!--        ,DTS.DS_CONTR_CTRL_STS_CD AS DS_CONTR_DTL_STS_CD -->
<!-- END 2018/10/01 K.Kitachi [QC#28396, DEL] -->
            ,DTL.SVC_MACH_MSTR_PK
            ,MCH.SER_NUM
            ,DTL.CONTR_EFF_FROM_DT
            ,NULL AS MDL_MTR_LB_CD
            ,NULL AS MTR_LB_DESC_TXT
            ,NULL AS MTR_READ_DT
            ,NULL AS READ_MTR_CNT
            ,NULL AS SVC_PHYS_MTR_PK
            ,'N'  AS BILL_FLG
            ,#noBllgCntrMsg# AS SVC_CMNT_TXT
            ,NULL AS DS_MTR_READ_TP_GRP_CD
            ,NULL AS XX_REC_HIST_CRAT_TS
            ,NULL AS XX_REC_HIST_CRAT_BY_NM
            ,NULL AS XX_REC_HIST_UPD_TS
            ,NULL AS XX_REC_HIST_UPD_BY_NM
            ,NULL AS XX_REC_HIST_TBL_NM
        FROM
            DS_CONTR            CNT
<!-- START 2018/10/01 K.Kitachi [QC#28396, DEL] -->
<!--        ,DS_CONTR_STS_V     CNV -->
<!-- END 2018/10/01 K.Kitachi [QC#28396, DEL] -->
            ,DS_CONTR_DTL       DTL
<!-- START  2018/07/18 [QC#26859,ADD] -->
            ,DS_CONTR_DTL_TP    DTP
<!-- END   2018/07/18 [QC#26859,ADD] -->
<!-- START 2018/10/01 K.Kitachi [QC#28396, DEL] -->
<!--        ,DS_CONTR_DTL_STS_V DTS -->
<!-- END 2018/10/01 K.Kitachi [QC#28396, DEL] -->
            ,SVC_MACH_MSTR      MCH
        WHERE
            CNT.GLBL_CMPY_CD            = #glblCmpyCd#
            <iterate property="dsContrPkList" var="dsContrPkList[]" open="            AND CNT.DS_CONTR_PK IN (" close=")" conjunction=",">
                #dsContrPkList[]#
            </iterate>
            AND CNT.EZCANCELFLAG        = '0'
            AND CNT.GLBL_CMPY_CD        = DTL.GLBL_CMPY_CD
            AND CNT.DS_CONTR_PK         = DTL.DS_CONTR_PK
            <iterate property="dsContrDtlPkList" var="dsContrDtlPkList[]" open="      AND DTL.DS_CONTR_DTL_PK IN (" close=")" conjunction=",">
                #dsContrDtlPkList[]#
            </iterate>
            AND DTL.EZCANCELFLAG        = '0'
<!-- START 2018/07/18 [QC#26859,ADD] -->
            AND DTL.GLBL_CMPY_CD        = DTP.GLBL_CMPY_CD
            AND DTP.EZCANCELFLAG        = '0'
            AND DTL.DS_CONTR_DTL_TP_CD  = DTP.DS_CONTR_DTL_TP_CD
            AND DTP.USG_CHRG_FLG        = 'Y'
<!-- END   2018/07/18 [QC#26859,ADD] -->
<!-- START 2018/10/01 K.Kitachi [QC#28396, DEL] -->
<!--        AND CNT.GLBL_CMPY_CD        = CNV.GLBL_CMPY_CD -->
<!--        AND CNT.DS_CONTR_PK         = CNV.DS_CONTR_PK -->
<!--        AND CNV.EZCANCELFLAG        = '0' -->
<!--        AND DTL.GLBL_CMPY_CD        = DTS.GLBL_CMPY_CD -->
<!--        AND DTL.DS_CONTR_PK         = DTS.DS_CONTR_PK -->
<!--        AND DTL.DS_CONTR_DTL_PK     = DTS.DS_CONTR_DTL_PK -->
<!--        AND DTS.EZCANCELFLAG        = '0' -->
<!-- END 2018/10/01 K.Kitachi [QC#28396, DEL] -->
            AND DTL.GLBL_CMPY_CD        = MCH.GLBL_CMPY_CD
            AND DTL.SVC_MACH_MSTR_PK    = MCH.SVC_MACH_MSTR_PK
            AND MCH.EZCANCELFLAG        = '0'
            AND EXISTS (
                SELECT
                    1
                FROM
                    SVC_PHYS_MTR       PM
                WHERE
                        DTL.GLBL_CMPY_CD        = PM.GLBL_CMPY_CD
                    AND DTL.SVC_MACH_MSTR_PK    = PM.SVC_MACH_MSTR_PK
                    AND PM.EZCANCELFLAG        = '0'
            )
            AND NOT EXISTS(
                SELECT
                    1
                FROM
                    CONTR_PHYS_BLLG_MTR_RELN CPBMR
                WHERE
                        CPBMR.GLBL_CMPY_CD    = DTL.GLBL_CMPY_CD
                    AND CPBMR.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK
                    AND CPBMR.BLLG_MTR_LB_CD  IS NOT NULL
                    AND CPBMR.EZCANCELFLAG    = '0'
            )
<!-- END 2018/05/11 K.Kojima [QC#24817,ADD] -->
        ORDER BY
<!-- START 2018/05/11 K.Kojima [QC#24817,MOD] -->
<!--             CNT.DS_CONTR_NUM -->
<!--             ,MCH.SER_NUM -->
<!--             ,PMT.MDL_MTR_LB_CD -->
             DS_CONTR_NUM
            ,SER_NUM
<!-- START 2018/07/18 [QC#26859,ADD] -->
            ,CONTR_EFF_FROM_DT
            ,DS_CONTR_DTL_PK
<!-- END   2018/07/18 [QC#26859,ADD] -->
            ,MDL_MTR_LB_CD
<!-- END 2018/05/11 K.Kojima [QC#24817,MOD] -->
    ) A
    WHERE
        ROWNUM &lt;= #limitNum#
    </statement>
    <resultMap id="result.getMainData"        class="NSAL0460_ASMsg">
        <result property="dsContrNum"            column="DS_CONTR_NUM"            javaType="EZDSStringItem"/>
        <result property="serNum"                column="SER_NUM"                 javaType="EZDSStringItem"/>
        <result property="contrEffFromDt"        column="CONTR_EFF_FROM_DT"       javaType="EZDSStringItem"/>
        <result property="contrEffFromDt_P"      column="CONTR_EFF_FROM_DT_P"     javaType="EZDSStringItem"/>
        <result property="mdlMtrLbCd"            column="MDL_MTR_LB_CD"           javaType="EZDSStringItem"/>
        <result property="mtrLbDescTxt"          column="MTR_LB_DESC_TXT"         javaType="EZDSStringItem"/>
        <result property="mtrReadDt"             column="MTR_READ_DT"             javaType="EZDSStringItem"/>
        <result property="readMtrCnt"            column="READ_MTR_CNT"            javaType="EZDSBigDecimalItem"/>
        <result property="svcCmntTxt_A"          column="SVC_CMNT_TXT"            javaType="EZDSStringItem"/>
        <result property="dsContrPk"             column="DS_CONTR_PK"             javaType="EZDSBigDecimalItem"/>
        <result property="dsContrDtlPk"          column="DS_CONTR_DTL_PK"         javaType="EZDSBigDecimalItem"/>
        <result property="svcMachMstrPk"         column="SVC_MACH_MSTR_PK"        javaType="EZDSBigDecimalItem"/>
        <result property="svcPhysMtrPk"          column="SVC_PHYS_MTR_PK"         javaType="EZDSBigDecimalItem"/>
        <result property="xxRowNum_A"            column="ROW_NUM"                 javaType="EZDSBigDecimalItem"/>
        <result property="xxRowNum_C"            column="FRST_CNT_ROW"            javaType="EZDSBigDecimalItem"/>
        <result property="xxRowNum_D"            column="FRST_SER_ROW"            javaType="EZDSBigDecimalItem"/>
        <result property="actvFlg"               column="ACTV_FLG"                javaType="EZDSStringItem"/>
<!-- START 2017/01/04 K.Ochiai [QC#16584, ADD] -->
        <result property="dsMtrReadTpGrpCd"      column="DS_MTR_READ_TP_GRP_CD"   javaType="EZDSStringItem"/>
<!-- END 2017/01/04 K.Ochiai [QC#16584, ADD] -->
<!-- START 2016/12/07 K.Ochiai [QC#14204, ADD] -->
        <result property="xxRecHistCratTs"       column="XX_REC_HIST_CRAT_TS"     javaType="EZDSStringItem"/>
        <result property="xxRecHistCratByNm"     column="XX_REC_HIST_CRAT_BY_NM"  javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdTs"        column="XX_REC_HIST_UPD_TS"      javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdByNm"      column="XX_REC_HIST_UPD_BY_NM"   javaType="EZDSStringItem"/>
        <result property="xxRecHistTblNm"        column="XX_REC_HIST_TBL_NM"      javaType="EZDSStringItem"/>
<!-- END 2016/12/07 K.Ochiai [QC#14204, ADD] -->
    </resultMap>
    <!-- START 2022/06/22 E.Sanchez [QC#59804, ADD] -->
    <statement id="getBllgMtrSchdBySvcPhysMrReadGrpSq" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            A.DS_CONTR_BLLG_SCHD_PK
        FROM
            DS_CONTR_BLLG_SCHD A
        WHERE
                A.GLBL_CMPY_CD             = #glblCmpyCd#
            AND A.SVC_PHYS_MTR_READ_GRP_SQ = #svcPhysMtrReadGrpSq#
            AND A.EZCANCELFLAG             = '0'
    </statement>
    <!-- END 2022/06/22 E.Sanchez [QC#59804, ADD] -->
    <!-- START 2022/08/05 E.Sanchez [QC#60357, ADD] -->
    <statement id="getUnbilledSchedules" parameterClass="Map" resultClass="Map">
        SELECT DISTINCT
            SCHD.DS_CONTR_DTL_PK       DS_CONTR_DTL_PK
           ,SCHD.BLLG_SCHD_THRU_DT     BLLG_SCHD_THRU_DT
           ,DC.DS_CONTR_NUM            DS_CONTR_NUM
        FROM
            DS_CONTR_BLLG_SCHD SCHD
           ,CONTR_PHYS_BLLG_MTR_RELN RELN
           ,DS_CONTR_DTL DCD
           ,DS_CONTR DC
        WHERE
                DCD.GLBL_CMPY_CD                = #glblCmpyCd#
            AND DCD.SVC_MACH_MSTR_PK            = #svcMachMstrPk#
            AND DCD.EZCANCELFLAG                = '0'
            AND DCD.DS_CONTR_DTL_PK      &lt;&gt; #dsContrDtlPk#
            AND DCD.DS_CONTR_DTL_STS_CD  &lt;&gt; #stsCan#
            AND DCD.DS_CONTR_PK                 = DC.DS_CONTR_PK
            <!-- START 2022/11/04 E.Sanchez [QC#60775, ADD] -->
            AND DCD.CONTR_EFF_FROM_DT        &lt; #contrEffFromDt#
            <!-- END 2022/11/04 E.Sanchez [QC#60775, ADD] -->
            AND DCD.GLBL_CMPY_CD                = DC.GLBL_CMPY_CD
            AND DC.EZCANCELFLAG                 = '0'
            AND DCD.GLBL_CMPY_CD                = SCHD.GLBL_CMPY_CD
            AND DCD.DS_CONTR_DTL_PK             = SCHD.DS_CONTR_DTL_PK
            AND SCHD.EZCANCELFLAG               = '0'
            AND SCHD.DS_BLLG_SCHD_STS_CD &lt;&gt; #dsBllgSchdStsCdClose#
            AND SCHD.BLLG_SCHD_THRU_DT      &gt;= #mtrReadDt#
            AND SCHD.USG_CHRG_FLG               = #usgChrgFlg#
            AND SCHD.SKIP_RECOV_TP_CD           NOT IN (#skip#)
            AND SCHD.SVC_CR_REBIL_PK            IS NULL
            AND SCHD.DS_CONTR_BLLG_MTR_PK       = RELN.DS_CONTR_BLLG_MTR_PK
            AND SCHD.GLBL_CMPY_CD               = RELN.GLBL_CMPY_CD
            AND RELN.BLLG_MTR_LB_CD             IS NOT NULL
            AND RELN.BLLBL_FLG                  = #bllblFlg#
            AND RELN.ACTV_FLG                   = #actvFlg#
            AND RELN.EZCANCELFLAG               = '0'
            AND RELN.SVC_PHYS_MTR_PK IN (
                SELECT
                    C.SVC_PHYS_MTR_PK
                FROM
                    CONTR_PHYS_BLLG_MTR_RELN C
                WHERE
                        C.DS_CONTR_DTL_PK      = #dsContrDtlPk#
                    AND C.GLBL_CMPY_CD         = #glblCmpyCd#
                    AND C.BLLG_MTR_LB_CD       IS NOT NULL
                    AND C.BLLBL_FLG            = #bllblFlg#
                    AND C.ACTV_FLG             = #actvFlg#
                    AND C.EZCANCELFLAG         = '0'
            )
        ORDER BY
             SCHD.BLLG_SCHD_THRU_DT      DESC
    </statement>
    <!-- END 2022/08/05 E.Sanchez [QC#60357, ADD] -->
</sqlMap>
