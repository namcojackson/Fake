<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSAL0550Query">
    <typeAlias alias="NSAL0550_ASMsg" type="business.blap.NSAL0550.NSAL0550_ASMsg"/>
    <statement id="getSvcInvList" parameterClass="Map" resultMap="result.getSvcInvList">
<!-- START 2018/08/09 K.Kitachi [QC#22381, MOD] -->
<!--     SELECT -->
<!--          (ROWNUM - 1) AS XX_SEL_NUM -->
<!--         ,X.DS_CONTR_NUM -->
<!--         ,X.SVC_INV_NUM -->
<!--         ,X.INV_DT -->
<!--         ,X.SVC_INV_CHRG_TP_DESC_TXT -->
<!-- START 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
<!--         ,X.INV_TP_CD -->
<!-- END 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
<!--         ,X.INV_TP_DESC_TXT -->
<!--         ,X.SVC_INV_SRC_TP_DESC_TXT -->
<!--         ,X.INV_TOT_DEAL_SLS_AMT -->
<!--         ,X.INV_TOT_DEAL_TAX_AMT -->
<!--         ,(X.INV_TOT_DEAL_NET_AMT + X.INV_TOT_DEAL_TAX_AMT) AS INV_TOT_DEAL_NET_AMT -->
<!--         ,X.DEAL_RMNG_BAL_GRS_AMT -->
<!--         ,X.BLLG_PER_FROM_DT -->
<!--         ,X.BLLG_PER_TO_DT -->
<!--         ,X.INV_DUE_DT -->
<!-- START 2017/10/20 U.Kim [QC#21764, MOD] -->
<!-- [QC#21764,MOD]START -->
<!--    ,CASE -->
<!--        WHEN X.SVC_CR_REBIL_STS_CD = #svcCrRebilStsCancelled# -->
<!--            THEN '' -->
<!--            ELSE X.CUST_CARE_TKT_NUM -->
<!--     END CUST_CARE_TKT_NUM -->
<!--    ,CASE -->
<!--        WHEN X.SVC_CR_REBIL_STS_CD = #svcCrRebilStsCancelled# -->
<!--            THEN '' -->
<!--            ELSE X.REBIL_SVC_INV_NUM -->
<!--     END REBIL_SVC_INV_NUM -->
<!--    ,CASE -->
<!--        WHEN X.SVC_CR_REBIL_STS_CD = #svcCrRebilStsCancelled# -->
<!--            THEN '' -->
<!--            ELSE X.CR_SVC_INV_NUM -->
<!--     END CR_SVC_INV_NUM -->
<!--         ,X.CUST_CARE_TKT_NUM -->
<!--         ,X.REBIL_SVC_INV_NUM -->
<!--         ,X.CR_SVC_INV_NUM -->
<!-- [QC#21764,MOD]END -->
<!-- END 2017/10/20 U.Kim [QC#21764, MOD] -->
<!--         ,X.ORIG_SVC_INV_NUM -->
<!--         ,X.INV_PRINT_RQST_NUM -->
<!--         ,X.INV_FTP_RQST_NUM -->
<!--     FROM ( -->
<!--         SELECT -->
<!--              T.DS_CONTR_NUM -->
<!--             ,T.SVC_INV_NUM -->
<!--             ,T.INV_DT -->
<!--             ,LISTAGG(T.SVC_INV_CHRG_TP_DESC_TXT, CHR(13) || CHR(10)) WITHIN GROUP (ORDER BY T.SVC_INV_CHRG_TP_SORT_NUM) AS SVC_INV_CHRG_TP_DESC_TXT -->
<!-- START 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
<!--             ,T.INV_TP_CD -->
<!-- END 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
<!--             ,T.INV_TP_DESC_TXT -->
<!--             ,T.SVC_INV_SRC_TP_DESC_TXT -->
<!--             ,T.INV_TOT_DEAL_SLS_AMT -->
<!--             ,T.INV_TOT_DEAL_TAX_AMT -->
<!--             ,T.INV_TOT_DEAL_NET_AMT -->
<!--             ,T.DEAL_RMNG_BAL_GRS_AMT -->
<!-- START 2018/06/13 T.Murai [QC#25687, MOD] -->
<!--            ,T.BLLG_PER_FROM_DT-->
<!--            ,T.BLLG_PER_TO_DT-->
<!--             ,LISTAGG(TO_CHAR(TO_DATE(T.BLLG_PER_FROM_DT,'YYYYMMDD'),'MM/DD/YYYY'), CHR(13) || CHR(10)) -->
<!--                 WITHIN GROUP (ORDER BY T.SVC_INV_CHRG_TP_SORT_NUM)                      AS BLLG_PER_FROM_DT -->
<!--             ,LISTAGG(TO_CHAR(TO_DATE(T.BLLG_PER_TO_DT,'YYYYMMDD'),'MM/DD/YYYY'), CHR(13) || CHR(10)) -->
<!--                 WITHIN GROUP (ORDER BY T.SVC_INV_CHRG_TP_SORT_NUM)                      AS BLLG_PER_TO_DT -->
<!-- START 2018/06/13 T.Murai [QC#25687, MOD] -->
<!--             ,T.INV_DUE_DT -->
<!--             ,T.CUST_CARE_TKT_NUM -->
<!--             ,T.REBIL_SVC_INV_NUM -->
<!--             ,T.CR_SVC_INV_NUM -->
<!--             ,T.ORIG_SVC_INV_NUM -->
<!--             ,T.INV_PRINT_RQST_NUM -->
<!--             ,T.INV_FTP_RQST_NUM -->
<!-- START 2017/10/20 U.Kim [QC#21764, DEL] -->
<!-- [QC#21764,MOD]START -->
<!--        ,T.SVC_CR_REBIL_STS_CD -->
<!-- [QC#21764,MOD]END -->
<!-- END 2017/10/20 U.Kim [QC#21764, DEL] -->
<!--         FROM -->
<!--             ( -->
<!--                 SELECT -->
<!--                      SI.DS_CONTR_NUM -->
<!--                     ,SI.SVC_INV_NUM -->
<!--                     ,SI.INV_DT -->
<!--                     ,SICT.SVC_INV_CHRG_TP_DESC_TXT -->
<!--                     ,SICT.SVC_INV_CHRG_TP_SORT_NUM -->
<!-- START 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
<!--                     ,IT.INV_TP_CD -->
<!-- END 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
<!--                     ,IT.INV_TP_DESC_TXT -->
<!--                     ,SIST.SVC_INV_SRC_TP_DESC_TXT -->
<!--                     ,SI.INV_TOT_DEAL_SLS_AMT -->
<!--                     ,SI.INV_TOT_DEAL_TAX_AMT -->
<!--                     ,SI.INV_TOT_DEAL_NET_AMT -->
<!--                     ,ATB.DEAL_RMNG_BAL_GRS_AMT -->
<!--                     ,SI.INV_DUE_DT -->
<!-- [QC#18758,MOD]START -->
<!--                     ,SCRD.CUST_INCDT_ID AS CUST_CARE_TKT_NUM -->
<!-- [QC#18758,MOD]END -->
<!--                     ,SCRD.REBIL_SVC_INV_NUM -->
<!--                     ,SCRD.CR_SVC_INV_NUM -->
<!--                     ,SI.ORIG_SVC_INV_NUM -->
<!--                     ,IPC.INV_PRINT_RQST_NUM -->
<!--                     ,IPC.INV_FTP_RQST_NUM -->
<!--                     ,MIN(SIL.BLLG_PER_FROM_DT) AS BLLG_PER_FROM_DT -->
<!--                     ,MAX(SIL.BLLG_PER_THRU_DT) AS BLLG_PER_TO_DT -->
<!-- START 2017/10/20 U.Kim [QC#21764, DEL] -->
<!-- [QC#21764,MOD]START -->
<!--                ,SCR.SVC_CR_REBIL_STS_CD -->
<!-- [QC#21764,MOD]END -->
<!-- END 2017/10/20 U.Kim [QC#21764, DEL] -->
<!--                 FROM -->
<!--                      SVC_INV SI -->
<!--                     ,INV_PRT_CTRL IPC -->
<!--                     ,AR_TRX_BAL ATB -->
<!-- START 2017/10/20 U.Kim [QC#21764, MOD] -->
<!--                ,SVC_CR_REBIL_DTL SCRD -->
<!--                     ,( -->
<!--                         SELECT -->
<!--                             SCRD.GLBL_CMPY_CD -->
<!--                             ,SCRD.EZCANCELFLAG -->
<!--                             ,SCRD.SVC_CR_REBIL_DTL_PK -->
<!--                             ,SCRD.CUST_INCDT_ID -->
<!--                             ,SCRD.REBIL_SVC_INV_NUM -->
<!--                             ,SCRD.CR_SVC_INV_NUM -->
<!--                             ,SCRD.ORIG_SVC_INV_NUM -->
<!--                         FROM -->
<!--                             SVC_CR_REBIL_DTL  SCRD -->
<!--                             ,SVC_CR_REBIL     SCR -->
<!--                             ,DS_CONTR         DC -->
<!--                         WHERE -->
<!--                             SCRD.GLBL_CMPY_CD       = #glblCmpyCd# -->
<!--                         AND SCRD.EZCANCELFLAG       = '0' -->
<!--                         AND SCRD.GLBL_CMPY_CD       = DC.GLBL_CMPY_CD -->
<!--                         AND SCRD.DS_CONTR_PK        = DC.DS_CONTR_PK -->
<!--                         AND DC.DS_CONTR_NUM         = #dsContrNum# -->
<!--                         AND SCRD.GLBL_CMPY_CD       = SCR.GLBL_CMPY_CD -->
<!--                         AND SCRD.SVC_CR_REBIL_PK    = SCR.SVC_CR_REBIL_PK -->
<!--                         AND SCR.SVC_CR_REBIL_STS_CD &lt;&gt; #svcCrRebilStsCancelled# -->
<!--                     ) SCRD -->
<!-- END 2017/10/20 U.Kim [QC#21764, MOD] -->
<!--                     ,INV_TP IT -->
<!--                     ,SVC_INV_SRC_TP SIST -->
<!--                     ,SVC_INV_LINE SIL -->
<!--                     ,SVC_INV_CHRG_TP SICT -->
<!-- START 2017/10/20 U.Kim [QC#21764, DEL] -->
<!-- [QC#21764,MOD]START -->
<!--                ,SVC_CR_REBIL     SCR -->
<!-- [QC#21764,MOD]END -->
<!-- END 2017/10/20 U.Kim [QC#21764, DEL] -->
<!--                 WHERE -->
<!--                     SI.GLBL_CMPY_CD = #glblCmpyCd# -->
<!--                 <isNotNull property="dsContrNum"> -->
<!--                     AND SI.DS_CONTR_NUM = #dsContrNum# -->
<!--                 </isNotNull> -->
<!--                 <isNotNull property="invTpCd"> -->
<!--                     AND SI.INV_TP_CD = #invTpCd# -->
<!--                 </isNotNull> -->
<!--                     AND SI.SVC_INV_SRC_TP_CD = #svcInvSrcTpCd# -->
<!--                     AND SI.EZCANCELFLAG = '0' -->
<!--                     AND SI.GLBL_CMPY_CD = IPC.GLBL_CMPY_CD(+) -->
<!--                     AND SI.SVC_INV_NUM = IPC.INV_NUM(+) -->
<!--                     AND IPC.EZCANCELFLAG(+) = '0' -->
<!--                     AND SI.GLBL_CMPY_CD = SCRD.GLBL_CMPY_CD (+) -->
<!-- [QC#18758,MOD]START -->
<!--                     AND SI.SVC_INV_NUM = SCRD.ORIG_SVC_INV_NUM (+) -->
<!-- [QC#18758,MOD]END -->
<!--                     AND SI.EZCANCELFLAG = SCRD.EZCANCELFLAG (+) -->
<!--                     AND SI.GLBL_CMPY_CD = ATB.GLBL_CMPY_CD (+) -->
<!--                     AND SI.SVC_INV_NUM = ATB.AR_TRX_NUM (+) -->
<!--                     AND SI.EZCANCELFLAG = ATB.EZCANCELFLAG (+) -->
<!--                     AND SI.GLBL_CMPY_CD = IT.GLBL_CMPY_CD -->
<!--                     AND SI.INV_TP_CD = IT.INV_TP_CD -->
<!--                     AND IT.EZCANCELFLAG = '0' -->
<!--                     AND SI.GLBL_CMPY_CD = SIST.GLBL_CMPY_CD -->
<!--                     AND SI.SVC_INV_SRC_TP_CD = SIST.SVC_INV_SRC_TP_CD -->
<!--                     AND SIST.EZCANCELFLAG = '0' -->
<!--                     AND SI.GLBL_CMPY_CD = SIL.GLBL_CMPY_CD -->
<!--                     AND SI.SVC_INV_NUM = SIL.SVC_INV_NUM -->
<!--                     AND SIL.EZCANCELFLAG = '0' -->
<!--                     AND SIL.GLBL_CMPY_CD = SICT.GLBL_CMPY_CD -->
<!--                     AND SIL.SVC_INV_CHRG_TP_CD = SICT.SVC_INV_CHRG_TP_CD -->
<!--                     AND SICT.EZCANCELFLAG = '0' -->
<!-- START 2017/10/20 U.Kim [QC#21764, DEL] -->
<!-- [QC#21764,MOD]START -->
<!--                AND SCRD.GLBL_CMPY_CD = SCR.GLBL_CMPY_CD(+) -->
<!--                AND SCRD.SVC_CR_REBIL_PK = SCR.SVC_CR_REBIL_PK(+) -->
<!--                AND SCR.EZCANCELFLAG(+) = '0' -->
<!-- [QC#21764,MOD]END -->
<!-- END 2017/10/20 U.Kim [QC#21764, DEL] -->
<!--                 GROUP BY -->
<!--                      SI.DS_CONTR_NUM -->
<!--                     ,SI.SVC_INV_NUM -->
<!--                     ,SI.INV_DT -->
<!-- START 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
<!--                     ,IT.INV_TP_CD -->
<!-- END 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
<!--                     ,IT.INV_TP_DESC_TXT -->
<!--                     ,SIST.SVC_INV_SRC_TP_DESC_TXT -->
<!--                     ,SICT.SVC_INV_CHRG_TP_DESC_TXT -->
<!--                     ,SICT.SVC_INV_CHRG_TP_SORT_NUM -->
<!--                     ,SI.INV_TOT_DEAL_SLS_AMT -->
<!--                     ,SI.INV_TOT_DEAL_TAX_AMT -->
<!--                     ,SI.INV_TOT_DEAL_NET_AMT -->
<!--                     ,ATB.DEAL_RMNG_BAL_GRS_AMT -->
<!--                     ,SI.INV_DUE_DT -->
<!-- [QC#18758,MOD]START -->
<!--                     ,SCRD.CUST_INCDT_ID -->
<!-- [QC#18758,MOD]END -->
<!--                     ,SCRD.REBIL_SVC_INV_NUM -->
<!--                     ,SCRD.CR_SVC_INV_NUM -->
<!--                     ,SI.ORIG_SVC_INV_NUM -->
<!--                     ,IPC.INV_PRINT_RQST_NUM -->
<!--                     ,IPC.INV_FTP_RQST_NUM -->
<!-- START 2017/10/20 U.Kim [QC#21764, DEL] -->
<!-- [QC#21764,MOD]START -->
<!--                ,SCR.SVC_CR_REBIL_STS_CD -->
<!-- [QC#21764,MOD]END -->
<!-- END 2017/10/20 U.Kim [QC#21764, DEL] -->
<!--                 HAVING -->
<!--                         COUNT(*) > 0 -->
<!--                 <isNotNull property="bllgPerFromDt"> -->
<!--                     AND MIN(SIL.BLLG_PER_FROM_DT) &gt;= #bllgPerFromDt# -->
<!--                 </isNotNull> -->
<!--                 <isNotNull property="bllgPerToDt"> -->
<!--                     AND MAX(SIL.BLLG_PER_THRU_DT) &lt;= #bllgPerToDt# -->
<!--                 </isNotNull> -->
<!--             ) T  -->
<!--             GROUP BY -->
<!--                  T.DS_CONTR_NUM -->
<!--                 ,T.SVC_INV_NUM -->
<!--                 ,T.INV_DT -->
<!-- START 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
<!--                 ,T.INV_TP_CD -->
<!-- END 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
<!--                 ,T.INV_TP_DESC_TXT -->
<!--                 ,T.SVC_INV_SRC_TP_DESC_TXT -->
<!--                 ,T.INV_TOT_DEAL_SLS_AMT -->
<!--                 ,T.INV_TOT_DEAL_TAX_AMT -->
<!--                 ,T.INV_TOT_DEAL_NET_AMT -->
<!--                 ,T.DEAL_RMNG_BAL_GRS_AMT -->
<!--                 ,T.INV_DUE_DT -->
<!-- START 2018/06/13 T.Murai [QC#25687, DEL] -->
<!--                ,T.BLLG_PER_FROM_DT-->
<!--                ,T.BLLG_PER_TO_DT-->
<!-- END 2018/06/13 T.Murai [QC#25687, DEL] -->
<!--                 ,T.CUST_CARE_TKT_NUM -->
<!--                 ,T.REBIL_SVC_INV_NUM -->
<!--                 ,T.CR_SVC_INV_NUM -->
<!--                 ,T.ORIG_SVC_INV_NUM -->
<!--                 ,T.INV_PRINT_RQST_NUM -->
<!--                 ,T.INV_FTP_RQST_NUM -->
<!-- START 2017/10/20 U.Kim [QC#21764, DEL] -->
<!-- [QC#21764,MOD]START -->
<!--            ,T.SVC_CR_REBIL_STS_CD -->
<!-- [QC#21764,MOD]END -->
<!-- END 2017/10/20 U.Kim [QC#21764, DEL] -->
<!--             ORDER BY -->
<!--                 T.DS_CONTR_NUM ASC -->
<!-- START 2017/10/20 U.Kim [QC#21764, MOD] -->
<!--            ,T.SVC_INV_NUM ASC -->
<!--            ,T.INV_PRINT_RQST_NUM NULLS FIRST -->
<!--                 ,NVL(T.ORIG_SVC_INV_NUM, T.SVC_INV_NUM) ASC -->
<!--                 ,T.ORIG_SVC_INV_NUM NULLS FIRST -->
<!--                 ,T.SVC_INV_NUM ASC -->
<!--                 ,T.BLLG_PER_FROM_DT ASC -->
<!--                 ,T.INV_PRINT_RQST_NUM NULLS FIRST -->
<!-- END 2017/10/20 U.Kim [QC#21764, MOD] -->
<!--     ) X WHERE ROWNUM &lt;= #rowNum# -->
<!-- START 2019/12/6 E.Kameishi [QC#54749, MOD] -->
        WITH TARGET_INV AS (
            SELECT
                SI.SVC_INV_NUM  AS INV_NUM
            FROM
                 SVC_INV      SI
                ,SVC_INV_LINE SIL
            WHERE
                    SI.GLBL_CMPY_CD      = #glblCmpyCd#
                <isNotNull property="dsContrNum">
                AND SI.DS_CONTR_NUM      = #dsContrNum#
                </isNotNull>
                <isNotNull property="svcInvNum">
                AND SI.SVC_INV_NUM       = #svcInvNum#
                </isNotNull>
                <isNotNull property="invTpCd">
                AND SI.INV_TP_CD         = #invTpCd#
                </isNotNull>
                <isNotNull property="invDt">
                AND SI.INV_DT            = #invDt#
                </isNotNull>
                AND SI.SVC_INV_SRC_TP_CD = #svcInvSrcTpCd#
                AND SI.EZCANCELFLAG      = '0'
                AND SI.GLBL_CMPY_CD      = SIL.GLBL_CMPY_CD
                AND SI.SVC_INV_NUM       = SIL.SVC_INV_NUM
                <isNotNull property="bllgPerFromDt">
                AND SIL.BLLG_PER_FROM_DT &gt;= #bllgPerFromDt#
                </isNotNull>
                <isNotNull property="bllgPerToDt">
                AND SIL.BLLG_PER_THRU_DT &lt;= #bllgPerToDt#
                </isNotNull>
                AND SIL.EZCANCELFLAG     = '0'
                <isNotNull property="custIncdtId">
                AND EXISTS (
                    SELECT
                        1
                    FROM
                         SVC_CR_REBIL_DTL SCRD
                        ,SVC_CR_REBIL     SCR
                    WHERE
                            SCRD.GLBL_CMPY_CD        = SI.GLBL_CMPY_CD
                        AND ( SCRD.ORIG_SVC_INV_NUM  = SI.SVC_INV_NUM
                         OR   SCRD.CR_SVC_INV_NUM    = SI.SVC_INV_NUM
                         OR   SCRD.REBIL_SVC_INV_NUM = SI.SVC_INV_NUM
                        )
                        AND SCRD.CUST_INCDT_ID       = #custIncdtId#
                        AND SCRD.EZCANCELFLAG        = '0'
                        AND SCRD.GLBL_CMPY_CD        = SCR.GLBL_CMPY_CD
                        AND SCRD.SVC_CR_REBIL_PK     = SCR.SVC_CR_REBIL_PK
                        AND SCR.SVC_CR_REBIL_STS_CD  &lt;&gt; #svcCrRebilStsCancelled#
                        AND SCR.EZCANCELFLAG         = '0'
                )
                </isNotNull>
            GROUP BY
                SI.SVC_INV_NUM
            UNION
            SELECT
                I.INV_NUM    AS INV_NUM
            FROM
                 INV      I
                ,INV_LINE IL
            WHERE
                    I.GLBL_CMPY_CD      = #glblCmpyCd#
                AND I.SYS_SRC_CD        = #nfc#
                <!-- START 2023/09/22 R.Jin [QC#61399, MOD] -->
                <!-- START 2023/04/20 R.Avelino [QC#61399, MOD] -->
                <!-- AND I.SVC_INV_PK        IS NOT NULL -->
<!--                AND I.SVC_INV_PK        IS NULL-->
                <iterate property="svcInvChrgTpCdList" var="svcInvChrgTpCdList[]" open=" AND IL.SVC_INV_CHRG_TP_CD IN (" close=")" conjunction=",">
                    #svcInvChrgTpCdList[]#
                </iterate>
                <!-- END 2023/04/20 R.Avelino [QC#61399, MOD] -->
                <!-- START 2023/05/12 R.Avelino [QC#61399, DEL] -->
                <!-- AND I.DS_CONTR_CATG_CD  IS NOT NULL -->
                <!-- END 2023/05/12 R.Avelino [QC#61399, DEL] -->
                <!-- END 2023/09/22 R.Jin [QC#61399, MOD] -->
                <isNotNull property="dsContrNum">
                AND IL.DS_CONTR_NUM      = #dsContrNum#
                </isNotNull>
                <isNotNull property="svcInvNum">
                AND I.INV_NUM       = #svcInvNum#
                </isNotNull>
                <isNotNull property="invTpCd">
                AND I.INV_TP_CD         = #invTpCd#
                </isNotNull>
                <isNotNull property="invDt">
                AND I.INV_DT            = #invDt#
                </isNotNull>
                AND I.EZCANCELFLAG      = '0'
                AND I.GLBL_CMPY_CD      = IL.GLBL_CMPY_CD
                AND I.INV_NUM           = IL.INV_NUM
                <isNotNull property="bllgPerFromDt">
                AND IL.BLLG_PER_FROM_DT &gt;= #bllgPerFromDt#
                </isNotNull>
                <isNotNull property="bllgPerToDt">
                AND IL.BLLG_PER_THRU_DT &lt;= #bllgPerToDt#
                </isNotNull>
                AND IL.EZCANCELFLAG     = '0'
                <isNotNull property="custIncdtId">
                AND EXISTS (
                    SELECT
                        1
                    FROM
                         AR_CR_REBIL     ACR
                    WHERE
                            ACR.GLBL_CMPY_CD         = I.GLBL_CMPY_CD
                        AND ( ACR.ORIG_INV_NUM       = I.INV_NUM
                         OR   ACR.INV_NUM            = I.INV_NUM
                        )
                        AND ACR.CUST_INCDT_ID        = #custIncdtId#
                        AND ACR.EZCANCELFLAG         = '0'
                )
                </isNotNull>
            GROUP BY
                I.INV_NUM
        )
        <isEqual property="relatedInvoice" compareValue="Y">
        , ROOT_INV AS (
            SELECT
                 B.SVC_INV_NUM
                ,LEVEL AS ROOT_NUM
            FROM 
                SVC_INV B
            WHERE
                    B.GLBL_CMPY_CD = #glblCmpyCd#
                AND B.EZCANCELFLAG = '0'
            START WITH
                EXISTS (SELECT 1 FROM TARGET_INV A WHERE A.INV_NUM = B.SVC_INV_NUM)
            CONNECT BY PRIOR
                B.ORIG_SVC_INV_NUM = B.SVC_INV_NUM
        )
        , ROOT_INV_AR AS (
            SELECT
                 C.INV_NUM
                ,LEVEL AS ROOT_NUM
            FROM 
                INV C
            WHERE
                    C.GLBL_CMPY_CD = #glblCmpyCd#
                AND C.EZCANCELFLAG = '0'
            START WITH
                EXISTS (SELECT 1 FROM TARGET_INV A WHERE A.INV_NUM = C.INV_NUM)
            CONNECT BY PRIOR
                C.ORIG_INV_NUM = C.INV_NUM
        )
        , RELATED_INV AS (
            SELECT
                 B.SVC_INV_NUM   AS INV_NUM
                ,CONNECT_BY_ROOT(B.SVC_INV_NUM) AS RT_INV_NUM
            FROM
                SVC_INV B
            WHERE
                    B.GLBL_CMPY_CD = #glblCmpyCd#
                AND B.EZCANCELFLAG = '0'
            START WITH
                EXISTS (SELECT 1 FROM ROOT_INV A WHERE A.SVC_INV_NUM = B.SVC_INV_NUM AND A.ROOT_NUM = (SELECT MAX(ROOT_NUM) FROM ROOT_INV))
            CONNECT BY PRIOR
                B.SVC_INV_NUM = B.ORIG_SVC_INV_NUM
            UNION
            SELECT
                 D.INV_NUM   AS INV_NUM
                ,CONNECT_BY_ROOT(D.INV_NUM) AS RT_INV_NUM
            FROM
                INV D
            WHERE
                    D.GLBL_CMPY_CD = #glblCmpyCd#
                AND D.EZCANCELFLAG = '0'
            START WITH
                EXISTS (SELECT 1 FROM ROOT_INV_AR A WHERE A.INV_NUM = D.INV_NUM AND A.ROOT_NUM = (SELECT MAX(ROOT_NUM) FROM ROOT_INV_AR))
            CONNECT BY PRIOR
                D.INV_NUM = D.ORIG_INV_NUM
        )
        </isEqual>
        , SEARCH_TARGET AS (
            SELECT
                A.INV_NUM
            FROM
                TARGET_INV A
            <isEqual property="relatedInvoice" compareValue="Y">
            UNION
            SELECT
                SI.SVC_INV_NUM
            FROM
                 SVC_INV      SI
                ,SVC_INV_LINE SIL
            WHERE
                    SI.GLBL_CMPY_CD      = #glblCmpyCd#
                <isNotNull property="invTpCd">
                AND SI.INV_TP_CD         = #invTpCd#
                </isNotNull>
                <isNotNull property="invDt">
                AND SI.INV_DT            = #invDt#
                </isNotNull>
                AND SI.SVC_INV_SRC_TP_CD = #svcInvSrcTpCd#
                AND SI.EZCANCELFLAG      = '0'
                AND EXISTS (SELECT 1 FROM RELATED_INV A WHERE A.INV_NUM = SI.SVC_INV_NUM)
                AND SI.GLBL_CMPY_CD      = SIL.GLBL_CMPY_CD
                AND SI.SVC_INV_NUM       = SIL.SVC_INV_NUM
                <isNotNull property="bllgPerFromDt">
                AND SIL.BLLG_PER_FROM_DT &gt;= #bllgPerFromDt#
                </isNotNull>
                <isNotNull property="bllgPerToDt">
                AND SIL.BLLG_PER_THRU_DT &lt;= #bllgPerToDt#
                </isNotNull>
                <isNotNull property="custIncdtId">
                AND EXISTS (
                    SELECT
                        1
                    FROM
                         SVC_CR_REBIL_DTL SCRD
                        ,SVC_CR_REBIL     SCR
                    WHERE
                            SCRD.GLBL_CMPY_CD        = SI.GLBL_CMPY_CD
                        AND ( SCRD.ORIG_SVC_INV_NUM  = SI.SVC_INV_NUM
                         OR   SCRD.CR_SVC_INV_NUM    = SI.SVC_INV_NUM
                         OR   SCRD.REBIL_SVC_INV_NUM = SI.SVC_INV_NUM
                        )
                        AND SCRD.CUST_INCDT_ID       = #custIncdtId#
                        AND SCRD.EZCANCELFLAG        = '0'
                        AND SCRD.GLBL_CMPY_CD        = SCR.GLBL_CMPY_CD
                        AND SCRD.SVC_CR_REBIL_PK     = SCR.SVC_CR_REBIL_PK
                        AND SCR.SVC_CR_REBIL_STS_CD  &lt;&gt; #svcCrRebilStsCancelled#
                        AND SCR.EZCANCELFLAG         = '0'
                )
                </isNotNull>
                AND SIL.EZCANCELFLAG     = '0'
            UNION
            SELECT
                I.INV_NUM
            FROM
                 INV      I
                ,INV_LINE IL
            WHERE
                    I.GLBL_CMPY_CD      = #glblCmpyCd#
                <isNotNull property="invTpCd">
                AND I.INV_TP_CD         = #invTpCd#
                </isNotNull>
                <isNotNull property="invDt">
                AND I.INV_DT            = #invDt#
                </isNotNull>
                AND I.EZCANCELFLAG      = '0'
                AND EXISTS (SELECT 1 FROM RELATED_INV A WHERE A.INV_NUM = I.INV_NUM)
                AND I.GLBL_CMPY_CD      = IL.GLBL_CMPY_CD
                AND I.INV_NUM           = IL.INV_NUM
                <isNotNull property="bllgPerFromDt">
                AND IL.BLLG_PER_FROM_DT &gt;= #bllgPerFromDt#
                </isNotNull>
                <isNotNull property="bllgPerToDt">
                AND IL.BLLG_PER_THRU_DT &lt;= #bllgPerToDt#
                </isNotNull>
                <isNotNull property="custIncdtId">
                AND EXISTS (
                    SELECT
                        1
                    FROM
                         AR_CR_REBIL     ACR
                    WHERE
                            ACR.GLBL_CMPY_CD         = I.GLBL_CMPY_CD
                        AND ( ACR.ORIG_INV_NUM       = I.INV_NUM
                         OR   ACR.INV_NUM            = I.INV_NUM
                        )
                        AND ACR.CUST_INCDT_ID        = #custIncdtId#
                        AND ACR.EZCANCELFLAG        = '0'
                )
                </isNotNull>
                AND IL.EZCANCELFLAG     = '0'
            </isEqual>
        )
        , CR_REBIL_INV AS (
            SELECT
                 SCRD.SVC_CR_REBIL_DTL_PK
                ,SCRD.CUST_INCDT_ID
                ,SCRD.ORIG_SVC_INV_NUM
                ,SCRD.CR_SVC_INV_NUM
                ,SCRD.REBIL_SVC_INV_NUM
            FROM
                 SVC_CR_REBIL_DTL SCRD
                ,SVC_CR_REBIL     SCR
            WHERE
                    SCRD.GLBL_CMPY_CD       = #glblCmpyCd#
                <isNotNull property="custIncdtId">
                AND SCRD.CUST_INCDT_ID      = #custIncdtId#
                </isNotNull>
                AND SCRD.EZCANCELFLAG       = '0'
                AND EXISTS (SELECT 1 FROM SEARCH_TARGET A WHERE A.INV_NUM = SCRD.ORIG_SVC_INV_NUM)
                AND SCRD.GLBL_CMPY_CD       = SCR.GLBL_CMPY_CD
                AND SCRD.SVC_CR_REBIL_PK    = SCR.SVC_CR_REBIL_PK
                AND SCR.SVC_CR_REBIL_STS_CD &lt;&gt; #svcCrRebilStsCancelled#
                AND SCR.EZCANCELFLAG        = '0'
            UNION
            SELECT
                 NULL AS SVC_CR_REBIL_DTL_PK
                ,CRT.CUST_INCDT_ID
                ,CRT.ORIG_SVC_INV_NUM
                ,CACR.INV_NUM AS CR_SVC_INV_NUM
                ,RACR.INV_NUM AS REBIL_SVC_INV_NUM
            FROM
            (SELECT DISTINCT
                 ACR.CUST_INCDT_ID AS CUST_INCDT_ID
                ,ACR.ORIG_INV_NUM AS ORIG_SVC_INV_NUM
                ,ACR.GLBL_CMPY_CD
                ,ACR.EZCANCELFLAG
            FROM
                 AR_CR_REBIL ACR
            WHERE
                    ACR.GLBL_CMPY_CD       = #glblCmpyCd#
                <isNotNull property="custIncdtId">
                AND ACR.CUST_INCDT_ID      = #custIncdtId#
                </isNotNull>
                AND ACR.EZCANCELFLAG       = '0'
                AND EXISTS (SELECT 1 FROM SEARCH_TARGET A WHERE A.INV_NUM = ACR.ORIG_INV_NUM)
            ) CRT
            ,AR_CR_REBIL CACR
            ,AR_CR_REBIL RACR
            WHERE
                CRT.GLBL_CMPY_CD           = #glblCmpyCd#
            AND CRT.EZCANCELFLAG           = '0'
            AND CRT.ORIG_SVC_INV_NUM       = CACR.ORIG_INV_NUM
            AND CACR.INV_TP_CD             = #invTpCreditMemo#
            AND CRT.ORIG_SVC_INV_NUM       = RACR.ORIG_INV_NUM
            AND RACR.INV_TP_CD             = #invTpInvoice#
        )
        , MAIN AS (
            SELECT
                 T.DS_CONTR_NUM
                ,T.SVC_INV_NUM
                ,T.INV_DT
                ,LISTAGG(T.SVC_INV_CHRG_TP_DESC_TXT, CHR(13) || CHR(10)) WITHIN GROUP (ORDER BY T.SVC_INV_CHRG_TP_SORT_NUM) AS SVC_INV_CHRG_TP_DESC_TXT
                ,T.INV_TP_CD
                ,T.INV_TP_DESC_TXT
                ,T.SVC_INV_SRC_TP_DESC_TXT
                ,T.INV_TOT_DEAL_SLS_AMT
                ,T.INV_TOT_DEAL_TAX_AMT
                ,T.INV_TOT_DEAL_NET_AMT
                ,T.DEAL_RMNG_BAL_GRS_AMT
                ,LISTAGG(TO_CHAR(TO_DATE(T.BLLG_PER_FROM_DT, 'YYYYMMDD'), 'MM/DD/YYYY'), CHR(13) || CHR(10))
                    WITHIN GROUP (ORDER BY T.SVC_INV_CHRG_TP_SORT_NUM)                        AS BLLG_PER_FROM_DT
                ,LISTAGG(TO_CHAR(TO_DATE(T.BLLG_PER_TO_DT, 'YYYYMMDD'), 'MM/DD/YYYY'), CHR(13) || CHR(10))
                    WITHIN GROUP (ORDER BY T.SVC_INV_CHRG_TP_SORT_NUM)                        AS BLLG_PER_TO_DT
                ,T.INV_DUE_DT
                ,T.CUST_CARE_TKT_NUM
                ,T.REBIL_SVC_INV_NUM
                ,T.CR_SVC_INV_NUM
                ,T.ORIG_SVC_INV_NUM
                ,T.INV_PRINT_RQST_NUM
                ,T.INV_FTP_RQST_NUM
                ,LISTAGG(TO_CHAR(TO_DATE(T.BLLG_SCHD_FROM_DT, 'YYYYMMDD'), 'MM/DD/YYYY'), CHR(13) || CHR(10))
                    WITHIN GROUP (ORDER BY T.SVC_INV_CHRG_TP_SORT_NUM)                        AS BLLG_SCHD_FROM_DT
                ,LISTAGG(T.SVC_CR_REBIL_PK, CHR(13) || CHR(10)) WITHIN GROUP (ORDER BY T.SVC_INV_CHRG_TP_SORT_NUM) AS SVC_CR_REBIL_PK
                ,LISTAGG(T.DS_BLLG_SCHD_TP_CD, CHR(13) || CHR(10)) WITHIN GROUP (ORDER BY T.SVC_INV_CHRG_TP_SORT_NUM) AS DS_BLLG_SCHD_TP_CD
                <!-- START 2018/09/27 T.Tomita [QC#28530, ADD] -->
                ,LISTAGG(T.BLLG_PER_FROM_DT, CHR(13) || CHR(10)) WITHIN GROUP (ORDER BY T.SVC_INV_CHRG_TP_SORT_NUM) AS SORT_BLLG_PER_FROM_DT
                ,LISTAGG(T.BLLG_PER_TO_DT,   CHR(13) || CHR(10)) WITHIN GROUP (ORDER BY T.SVC_INV_CHRG_TP_SORT_NUM) AS SORT_BLLG_PER_TO_DT
                <!-- END   2018/09/27 T.Tomita [QC#28530, ADD] -->
            FROM
                (
                    SELECT
                         SI.DS_CONTR_NUM
                        ,SI.SVC_INV_NUM
                        ,SI.INV_DT
                        ,SICT.SVC_INV_CHRG_TP_DESC_TXT
                        ,SICT.SVC_INV_CHRG_TP_SORT_NUM
                        ,IT.INV_TP_CD
                        ,IT.INV_TP_DESC_TXT
                        ,SIST.SVC_INV_SRC_TP_DESC_TXT
                        ,SI.INV_TOT_DEAL_SLS_AMT
                        ,SI.INV_TOT_DEAL_TAX_AMT
                        ,SI.INV_TOT_DEAL_NET_AMT
                        ,ATB.DEAL_RMNG_BAL_GRS_AMT
                        ,SI.INV_DUE_DT
                        ,SCRD.CUST_INCDT_ID AS CUST_CARE_TKT_NUM
                        ,SCRD.REBIL_SVC_INV_NUM
                        ,SCRD.CR_SVC_INV_NUM
                        ,SI.ORIG_SVC_INV_NUM
                        ,IPC.INV_PRINT_RQST_NUM
                        ,IPC.INV_FTP_RQST_NUM
                        ,MIN(SIL.BLLG_PER_FROM_DT) AS BLLG_PER_FROM_DT
                        ,MAX(SIL.BLLG_PER_THRU_DT) AS BLLG_PER_TO_DT
                        ,MIN(DCBS.BLLG_SCHD_FROM_DT) AS BLLG_SCHD_FROM_DT
                        ,MIN(DCBS.SVC_CR_REBIL_PK) AS SVC_CR_REBIL_PK
                        ,MIN(DCBS.DS_BLLG_SCHD_TP_CD) AS DS_BLLG_SCHD_TP_CD
                    FROM
                         SVC_INV            SI
                        ,INV_PRT_CTRL       IPC
                        ,AR_TRX_BAL         ATB
                        ,CR_REBIL_INV       SCRD
                        ,INV_TP             IT
                        ,SVC_INV_SRC_TP     SIST
                        ,SVC_INV_LINE       SIL
                        ,SVC_INV_CHRG_TP    SICT
                        ,DS_CONTR_BLLG_SCHD DCBS
                    WHERE
                            SI.GLBL_CMPY_CD               = #glblCmpyCd#
                        AND SI.EZCANCELFLAG               = '0'
                        AND EXISTS (SELECT 1 FROM SEARCH_TARGET A WHERE A.INV_NUM = SI.SVC_INV_NUM)
                        AND SI.GLBL_CMPY_CD               = IPC.GLBL_CMPY_CD           (+)
                        AND SI.SVC_INV_NUM                = IPC.INV_NUM                (+)
                        AND IPC.EZCANCELFLAG          (+) = '0'
                        AND SI.SVC_INV_NUM                = SCRD.ORIG_SVC_INV_NUM      (+)
                        AND SI.GLBL_CMPY_CD               = ATB.GLBL_CMPY_CD           (+)
                        AND SI.SVC_INV_NUM                = ATB.AR_TRX_NUM             (+)
                        AND ATB.EZCANCELFLAG          (+) = '0'
                        AND SI.GLBL_CMPY_CD               = IT.GLBL_CMPY_CD
                        AND SI.INV_TP_CD                  = IT.INV_TP_CD
                        AND IT.EZCANCELFLAG               = '0'
                        AND SI.GLBL_CMPY_CD               = SIST.GLBL_CMPY_CD
                        AND SI.SVC_INV_SRC_TP_CD          = SIST.SVC_INV_SRC_TP_CD
                        AND SIST.EZCANCELFLAG             = '0'
                        AND SI.GLBL_CMPY_CD               = SIL.GLBL_CMPY_CD
                        AND SI.SVC_INV_NUM                = SIL.SVC_INV_NUM
                        AND SIL.EZCANCELFLAG              = '0'
                        AND SIL.GLBL_CMPY_CD              = SICT.GLBL_CMPY_CD
                        AND SIL.SVC_INV_CHRG_TP_CD        = SICT.SVC_INV_CHRG_TP_CD
                        AND SICT.EZCANCELFLAG             = '0'
                        AND SIL.GLBL_CMPY_CD              = DCBS.GLBL_CMPY_CD(+)
                        AND SIL.DS_CONTR_BLLG_SCHD_PK     = DCBS.DS_CONTR_BLLG_SCHD_PK(+)
                        AND DCBS.EZCANCELFLAG(+)          = '0'
                        <isEqual property="latestOnly" compareValue="Y">
                        AND SI.INV_TP_CD               &lt;&gt; #invTpCreditMemo#
                        AND NOT EXISTS (
                            SELECT
                                1
                            FROM
                                 SVC_CR_REBIL_DTL X
                                ,SVC_CR_REBIL     Y
                            WHERE
                                    X.GLBL_CMPY_CD        = SI.GLBL_CMPY_CD
                                AND X.ORIG_SVC_INV_NUM    = SI.SVC_INV_NUM
                                AND X.EZCANCELFLAG        = '0'
                                AND X.GLBL_CMPY_CD        = Y.GLBL_CMPY_CD
                                AND X.SVC_CR_REBIL_PK     = Y.SVC_CR_REBIL_PK
                                AND Y.SVC_CR_REBIL_STS_CD = #svcCrRebilStsProcessed#
                                AND Y.EZCANCELFLAG        = '0'
                        )
                        AND NOT EXISTS (
                            SELECT
                                1
                            FROM
                                 AR_CR_REBIL X
                            WHERE
                                    X.GLBL_CMPY_CD        = SI.GLBL_CMPY_CD
                                AND X.ORIG_INV_NUM        = SI.SVC_INV_NUM
                                AND X.EZCANCELFLAG        = '0'
                        )
                        </isEqual>
                    GROUP BY
                         SI.DS_CONTR_NUM
                        ,SI.SVC_INV_NUM
                        ,SI.INV_DT
                        ,IT.INV_TP_CD
                        ,IT.INV_TP_DESC_TXT
                        ,SIST.SVC_INV_SRC_TP_DESC_TXT
                        ,SICT.SVC_INV_CHRG_TP_DESC_TXT
                        ,SICT.SVC_INV_CHRG_TP_SORT_NUM
                        ,SI.INV_TOT_DEAL_SLS_AMT
                        ,SI.INV_TOT_DEAL_TAX_AMT
                        ,SI.INV_TOT_DEAL_NET_AMT
                        ,ATB.DEAL_RMNG_BAL_GRS_AMT
                        ,SI.INV_DUE_DT
                        ,SCRD.CUST_INCDT_ID
                        ,SCRD.REBIL_SVC_INV_NUM
                        ,SCRD.CR_SVC_INV_NUM
                        ,SI.ORIG_SVC_INV_NUM
                        ,IPC.INV_PRINT_RQST_NUM
                        ,IPC.INV_FTP_RQST_NUM
                    HAVING
                            COUNT(*)                  &gt; 0
                        <isNotNull property="bllgPerFromDt">
                        AND MIN(SIL.BLLG_PER_FROM_DT) &gt;= #bllgPerFromDt#
                        </isNotNull>
                        <isNotNull property="bllgPerToDt">
                        AND MAX(SIL.BLLG_PER_THRU_DT) &lt;= #bllgPerToDt#
                        </isNotNull>
                    UNION
                    SELECT
                         IL.DS_CONTR_NUM
                        ,I.INV_NUM
                        ,I.INV_DT
                        ,SICT.SVC_INV_CHRG_TP_DESC_TXT
                        ,SICT.SVC_INV_CHRG_TP_SORT_NUM
                        ,IT.INV_TP_CD
                        ,IT.INV_TP_DESC_TXT
                        ,#contract# AS SVC_INV_SRC_TP_DESC_TXT
                        ,I.INV_TOT_DEAL_SLS_AMT
                        ,I.INV_TOT_DEAL_TAX_AMT
                        ,I.INV_TOT_DEAL_SLS_AMT
                        ,ATB.DEAL_RMNG_BAL_GRS_AMT
                        ,I.NET_DUE_DT
                        ,SCRD.CUST_INCDT_ID AS CUST_CARE_TKT_NUM
                        ,SCRD.REBIL_SVC_INV_NUM
                        ,SCRD.CR_SVC_INV_NUM
                        ,I.ORIG_INV_NUM
                        ,IPC.INV_PRINT_RQST_NUM
                        ,IPC.INV_FTP_RQST_NUM
                        ,MIN(IL.BLLG_PER_FROM_DT) AS BLLG_PER_FROM_DT
                        ,MAX(IL.BLLG_PER_THRU_DT) AS BLLG_PER_TO_DT
                        ,NULL AS BLLG_SCHD_FROM_DT
                        ,NULL AS SVC_CR_REBIL_PK
                        ,NULL AS DS_BLLG_SCHD_TP_CD
                    FROM
                         INV                I
                        ,INV_PRT_CTRL       IPC
                        ,AR_TRX_BAL         ATB
                        ,CR_REBIL_INV       SCRD
                        ,INV_TP             IT
                        ,INV_LINE           IL
                        ,SVC_INV_CHRG_TP    SICT
                    WHERE
                            I.GLBL_CMPY_CD                = #glblCmpyCd#
                        AND I.EZCANCELFLAG                = '0'
                        AND EXISTS (SELECT 1 FROM SEARCH_TARGET A WHERE A.INV_NUM = I.INV_NUM)
                        AND I.GLBL_CMPY_CD                = IPC.GLBL_CMPY_CD           (+)
                        AND I.INV_NUM                     = IPC.INV_NUM                (+)
                        AND IPC.EZCANCELFLAG          (+) = '0'
                        AND I.INV_NUM                     = SCRD.ORIG_SVC_INV_NUM      (+)
                        AND I.GLBL_CMPY_CD                = ATB.GLBL_CMPY_CD           (+)
                        AND I.INV_NUM                     = ATB.AR_TRX_NUM             (+)
                        AND ATB.EZCANCELFLAG          (+) = '0'
                        AND I.GLBL_CMPY_CD                = IT.GLBL_CMPY_CD
                        AND I.INV_TP_CD                   = IT.INV_TP_CD
                        AND IT.EZCANCELFLAG               = '0'
                        AND I.GLBL_CMPY_CD                = IL.GLBL_CMPY_CD
                        AND I.INV_NUM                     = IL.INV_NUM
                        AND IL.EZCANCELFLAG               = '0'
                        AND IL.GLBL_CMPY_CD               = SICT.GLBL_CMPY_CD
                        AND IL.SVC_INV_CHRG_TP_CD         = SICT.SVC_INV_CHRG_TP_CD
                        AND SICT.EZCANCELFLAG             = '0'
                        AND I.SYS_SRC_CD                  = #nfc#
                        <isEqual property="latestOnly" compareValue="Y">
                        AND I.INV_TP_CD                  &lt;&gt; #invTpCreditMemo#
                        AND NOT EXISTS (
                            SELECT
                                1
                            FROM
                                AR_CR_REBIL     X
                            WHERE
                                    X.GLBL_CMPY_CD        = I.GLBL_CMPY_CD
                                AND X.ORIG_INV_NUM        = I.INV_NUM
                                AND X.EZCANCELFLAG        = '0'
                        )
                        </isEqual>
                    GROUP BY
                         IL.DS_CONTR_NUM
                        ,I.INV_NUM
                        ,I.INV_DT
                        ,IT.INV_TP_CD
                        ,IT.INV_TP_DESC_TXT
                        ,SICT.SVC_INV_CHRG_TP_DESC_TXT
                        ,SICT.SVC_INV_CHRG_TP_SORT_NUM
                        ,I.INV_TOT_DEAL_SLS_AMT
                        ,I.INV_TOT_DEAL_TAX_AMT
                        ,I.INV_TOT_DEAL_NET_AMT
                        ,ATB.DEAL_RMNG_BAL_GRS_AMT
                        ,I.NET_DUE_DT
                        ,SCRD.CUST_INCDT_ID
                        ,SCRD.REBIL_SVC_INV_NUM
                        ,SCRD.CR_SVC_INV_NUM
                        ,I.ORIG_INV_NUM
                        ,IPC.INV_PRINT_RQST_NUM
                        ,IPC.INV_FTP_RQST_NUM
                    HAVING
                            COUNT(*)                  &gt; 0
                        <isNotNull property="bllgPerFromDt">
                        AND MIN(IL.BLLG_PER_FROM_DT) &gt;= #bllgPerFromDt#
                        </isNotNull>
                        <isNotNull property="bllgPerToDt">
                        AND MAX(IL.BLLG_PER_THRU_DT) &lt;= #bllgPerToDt#
                        </isNotNull>
                ) T
            GROUP BY
                 T.DS_CONTR_NUM
                ,T.SVC_INV_NUM
                ,T.INV_DT
                ,T.INV_TP_CD
                ,T.INV_TP_DESC_TXT
                ,T.SVC_INV_SRC_TP_DESC_TXT
                ,T.INV_TOT_DEAL_SLS_AMT
                ,T.INV_TOT_DEAL_TAX_AMT
                ,T.INV_TOT_DEAL_NET_AMT
                ,T.DEAL_RMNG_BAL_GRS_AMT
                ,T.INV_DUE_DT
                ,T.CUST_CARE_TKT_NUM
                ,T.REBIL_SVC_INV_NUM
                ,T.CR_SVC_INV_NUM
                ,T.ORIG_SVC_INV_NUM
                ,T.INV_PRINT_RQST_NUM
                ,T.INV_FTP_RQST_NUM
        )
        SELECT
             (ROWNUM - 1) AS XX_SEL_NUM
            <!-- START 2023/09/22 R.Jin [QC#61399, MOD] -->
<!--         START 2023/04/20 R.Avelino [QC#61399, MOD] -->
             ,X.DS_CONTR_NUM 
             ,X.SVC_INV_NUM 
             ,X.INV_DT 
             ,X.SVC_INV_CHRG_TP_DESC_TXT 
             ,X.INV_TP_CD 
             ,X.INV_TP_DESC_TXT 
             ,X.SVC_INV_SRC_TP_DESC_TXT 
             ,X.INV_TOT_DEAL_SLS_AMT 
             ,X.INV_TOT_DEAL_TAX_AMT 
             ,(X.INV_TOT_DEAL_NET_AMT + X.INV_TOT_DEAL_TAX_AMT) AS INV_TOT_DEAL_NET_AMT 
             ,X.DEAL_RMNG_BAL_GRS_AMT 
             ,X.BLLG_PER_FROM_DT 
             ,X.BLLG_PER_TO_DT 
             ,X.INV_DUE_DT 
             ,X.CUST_CARE_TKT_NUM 
             ,X.REBIL_SVC_INV_NUM 
             ,X.CR_SVC_INV_NUM 
             ,X.ORIG_SVC_INV_NUM 
             ,X.INV_PRINT_RQST_NUM 
             ,X.INV_FTP_RQST_NUM 
<!--             START 2018/09/27 T.Tomita [QC#28530 ADD] -->
             ,X.SORT_BLLG_PER_FROM_DT 
             ,X.SORT_BLLG_PER_TO_DT 
<!--             END   2018/09/27 T.Tomita [QC#28530 ADD] -->
         FROM 
             ( 
<!--                 SELECT -->
<!--                     M.* -->
<!--                 FROM -->
<!--                     MAIN M -->
<!--                 ORDER BY -->
<!--                      M.DS_CONTR_NUM             ASC -->
<!--                     START 2018/09/27 T.Tomita [QC#28530 MOD] -->
<!--                     ,M.BLLG_SCHD_FROM_DT        ASC -->
<!--                     ,M.SORT_BLLG_PER_FROM_DT -->
<!--                     END   2018/09/27 T.Tomita [QC#28530 MOD] -->
<!--                     ,M.ORIG_SVC_INV_NUM         ASC NULLS FIRST-->
<!--                     ,M.SVC_INV_CHRG_TP_DESC_TXT ASC -->
<!--                    ,M.SVC_CR_REBIL_PK          ASC NULLS FIRST -->
                  SELECT
                      Y.*
                  FROM
                      (
                          SELECT
                              M.*
<!--                              ,CASE WHEN M.ORIG_SVC_INV_NUM IS NULL THEN M.SORT_BLLG_PER_TO_DT ELSE (SELECT SORT_BLLG_PER_TO_DT FROM MAIN M1 WHERE M1.SVC_INV_NUM=M.ORIG_SVC_INV_NUM AND ROWNUM=1) END SORT_ORIGIN_BLLG_PER_TO_DT-->
<!--                              ,CASE WHEN M.ORIG_SVC_INV_NUM IS NULL or (select M1.SVC_INV_NUM from MAIN M1 where M1.SVC_INV_NUM=M.ORIG_SVC_INV_NUM and M.CR_SVC_INV_NUM is NOT NULL AND ROWNUM=1) is NULL  THEN M.SORT_BLLG_PER_TO_DT ELSE (SELECT SORT_BLLG_PER_TO_DT FROM MAIN M1 WHERE M1.SVC_INV_NUM=M.ORIG_SVC_INV_NUM AND ROWNUM=1) END SORT_ORIGIN_BLLG_PER_TO_DT-->
                                  ,SUBSTR(REPLACE(REPLACE(
                                  CASE WHEN M.ORIG_SVC_INV_NUM IS NULL OR (M.ORIG_SVC_INV_NUM IS NOT NULL AND M.CR_SVC_INV_NUM is NOT NULL ) 
                                             THEN M.SORT_BLLG_PER_FROM_DT
                                        ELSE (SELECT MAX(SORT_BLLG_PER_FROM_DT) FROM MAIN M1 WHERE M1.SVC_INV_NUM=M.ORIG_SVC_INV_NUM AND ROWNUM=1 )  
                                  END,CHR(13),NULL),CHR(10),NULL),1,8) AS  SORT_ORIGIN_BLLG_PER_FROM_DT
<!--                              ,NVL(M.ORIG_SVC_INV_NUM,M.SVC_INV_NUM) || NVL(M.CR_SVC_INV_NUM,M.SVC_INV_NUM)   AS SORT_ORIGIN_INVNUM-->
<!--                              ,CASE WHEN M.ORIG_SVC_INV_NUM IS NOT NULL AND M.CR_SVC_INV_NUM IS NOT NULL THEN M.ORIG_SVC_INV_NUM || M.SVC_INV_NUM -->
<!--                                    WHEN M.ORIG_SVC_INV_NUM IS NOT NULL AND M.CR_SVC_INV_NUM IS NULL THEN NVL((SELECT M1.ORIG_SVC_INV_NUM  FROM MAIN M1 WHERE M1.SVC_INV_NUM=M.ORIG_SVC_INV_NUM and (M1.CR_SVC_INV_NUM=M.SVC_INV_NUM or M1.REBIL_SVC_INV_NUM=M.SVC_INV_NUM)  AND ROWNUM=1 ),M.ORIG_SVC_INV_NUM ) || M.SVC_INV_NUM-->
<!--                                   ELSE NVL(M.ORIG_SVC_INV_NUM,M.SVC_INV_NUM)  || NVL(M.CR_SVC_INV_NUM,M.SVC_INV_NUM)-->
<!--                               END SORT_ORIGIN_INVNUM -->
                                   <!-- START 2024/01/16 R.Jin [QC#61399, MOD] -->
<!--                                  ,CASE WHEN M.ORIG_SVC_INV_NUM IS NOT NULL AND M.CR_SVC_INV_NUM IS NOT NULL THEN M.ORIG_SVC_INV_NUM || M.SVC_INV_NUM  -->
                                  ,CASE WHEN M.ORIG_SVC_INV_NUM IS NOT NULL AND M.CR_SVC_INV_NUM IS NOT NULL THEN M.ORIG_SVC_INV_NUM || M.SVC_INV_NUM || M.SVC_INV_NUM
                                  <!-- END 2024/01/16 R.Jin [QC#61399, MOD] -->
                                        WHEN M.ORIG_SVC_INV_NUM IS NOT NULL AND M.CR_SVC_INV_NUM IS NULL 
                                             THEN NVL((SELECT MAX(M3.SVC_INV_NUM) FROM (SELECT MAX(M1.ORIG_SVC_INV_NUM) AS ORIG_SVC_INV_NUM  FROM MAIN M1 WHERE M1.SVC_INV_NUM=M.ORIG_SVC_INV_NUM  AND ROWNUM =1 ) M2, MAIN M3 WHERE M2.ORIG_SVC_INV_NUM=M3.SVC_INV_NUM),NVL((SELECT MAX(M1.ORIG_SVC_INV_NUM) AS ORIG_SVC_INV_NUM  FROM MAIN M1 WHERE M1.SVC_INV_NUM=M.ORIG_SVC_INV_NUM AND (M1.CR_SVC_INV_NUM=M.SVC_INV_NUM or M1.REBIL_SVC_INV_NUM=M.SVC_INV_NUM)  AND ROWNUM =1),M.ORIG_SVC_INV_NUM) )  ||
                                                 case when (select count(1) from MAIN M1 where M1.CR_SVC_INV_NUM=M.SVC_INV_NUM) > 0 then M.SVC_INV_NUM || (select MAX(M1.REBIL_SVC_INV_NUM) from MAIN M1 where M1.CR_SVC_INV_NUM=M.SVC_INV_NUM AND ROWNUM=1)
                                                       when (select count(1) from MAIN M1 where M1.REBIL_SVC_INV_NUM=M.SVC_INV_NUM) > 0 then (select MAX(M1.CR_SVC_INV_NUM) from MAIN M1 where M1.REBIL_SVC_INV_NUM=M.SVC_INV_NUM AND ROWNUM=1) || M.SVC_INV_NUM
<!--                                                       else  (SELECT M3.CR_SVC_INV_NUM || M3.REBIL_SVC_INV_NUM FROM (SELECT MAX(M1.ORIG_SVC_INV_NUM) AS ORIG_SVC_INV_NUM, M1.SVC_INV_NUM FROM MAIN M1 WHERE M1.SVC_INV_NUM=M.ORIG_SVC_INV_NUM GROUP BY M1.ORIG_SVC_INV_NUM, M1.SVC_INV_NUM) M2, MAIN M3 WHERE M2.ORIG_SVC_INV_NUM=M3.SVC_INV_NUM AND (M3.CR_SVC_INV_NUM=M2.SVC_INV_NUM OR M3.REBIL_SVC_INV_NUM=M2.SVC_INV_NUM))-->
                                                       ELSE CASE WHEN  (SELECT MAX(M1.ORIG_SVC_INV_NUM)   FROM MAIN M1 WHERE M1.SVC_INV_NUM=M.ORIG_SVC_INV_NUM  AND ROWNUM =1 GROUP BY M1.ORIG_SVC_INV_NUM ) > 0 then (SELECT MAX(M3.CR_SVC_INV_NUM) || MAX(M3.REBIL_SVC_INV_NUM) FROM (SELECT MAX(M1.ORIG_SVC_INV_NUM) AS ORIG_SVC_INV_NUM  FROM MAIN M1 WHERE M1.SVC_INV_NUM=M.ORIG_SVC_INV_NUM  AND ROWNUM =1 GROUP BY M1.ORIG_SVC_INV_NUM) M2,MAIN M3 WHERE M3.SVC_INV_NUM=M2.ORIG_SVC_INV_NUM AND M3.ORIG_SVC_INV_NUM IS NULL  AND ROWNUM =1 GROUP BY M3.CR_SVC_INV_NUM,M3.REBIL_SVC_INV_NUM )
                                                                 <!-- START 2024/01/16 R.Jin [QC#61399, MOD] -->
<!--                                                                 ELSE  (SELECT MAX(M1.ORIG_SVC_INV_NUM) || MAX(M1.CR_SVC_INV_NUM) || MAX(M1.REBIL_SVC_INV_NUM)   FROM MAIN M1 WHERE M1.SVC_INV_NUM=M.ORIG_SVC_INV_NUM AND ROWNUM =1 GROUP BY M1.ORIG_SVC_INV_NUM, M1.SVC_INV_NUM,M1.CR_SVC_INV_NUM,M1.REBIL_SVC_INV_NUM)-->
                                                                 ELSE  (SELECT NVL(MAX(M1.CR_SVC_INV_NUM), M1.SVC_INV_NUM) || NVL(MAX(M1.REBIL_SVC_INV_NUM), M1.SVC_INV_NUM)   FROM MAIN M1 WHERE M1.SVC_INV_NUM=M.ORIG_SVC_INV_NUM AND ROWNUM =1 GROUP BY M1.ORIG_SVC_INV_NUM, M1.SVC_INV_NUM,M1.CR_SVC_INV_NUM,M1.REBIL_SVC_INV_NUM)
                                                                 <!-- END 2024/01/16 R.Jin [QC#61399, MOD] -->
                                                            END
                                                  end
                                        ELSE NVL(M.ORIG_SVC_INV_NUM,M.SVC_INV_NUM)  || NVL(M.CR_SVC_INV_NUM,M.SVC_INV_NUM) || NVL(M.REBIL_SVC_INV_NUM,M.SVC_INV_NUM)
                                   END SORT_ORIGIN_INVNUM
                          FROM
                              MAIN M
                      ) Y
                  ORDER BY
                      Y.DS_CONTR_NUM                      ASC
                      ,Y.SORT_ORIGIN_BLLG_PER_FROM_DT     ASC
                      ,Y.SORT_ORIGIN_INVNUM               ASC
                      ,Y.ORIG_SVC_INV_NUM                 ASC NULLS FIRST
<!--                      ,Y.INV_TP_CD                      DESC-->
                      ,Y.SVC_INV_NUM                      ASC
<!--                      ,Y.SVC_INV_CHRG_TP_DESC_TXT       ASC-->
             ) X 
            
<!--            ,Y.DS_CONTR_NUM-->
<!--            ,Y.SVC_INV_NUM-->
<!--            ,Y.INV_DT-->
<!--            ,Y.SVC_INV_CHRG_TP_DESC_TXT-->
<!--            ,Y.INV_TP_CD-->
<!--            ,Y.INV_TP_DESC_TXT-->
<!--            ,Y.SVC_INV_SRC_TP_DESC_TXT-->
<!--            ,Y.INV_TOT_DEAL_SLS_AMT-->
<!--            ,Y.INV_TOT_DEAL_TAX_AMT-->
<!--            ,Y.INV_TOT_DEAL_NET_AMT-->
<!--            ,Y.DEAL_RMNG_BAL_GRS_AMT-->
<!--            ,Y.BLLG_PER_FROM_DT-->
<!--            ,Y.BLLG_PER_TO_DT-->
<!--            ,Y.INV_DUE_DT-->
<!--            ,Y.CUST_CARE_TKT_NUM-->
<!--            ,Y.REBIL_SVC_INV_NUM-->
<!--            ,Y.CR_SVC_INV_NUM-->
<!--            ,Y.ORIG_SVC_INV_NUM-->
<!--            ,Y.INV_PRINT_RQST_NUM-->
<!--            ,Y.INV_FTP_RQST_NUM-->
<!--            ,Y.SORT_BLLG_PER_FROM_DT-->
<!--            ,Y.SORT_BLLG_PER_TO_DT-->
<!--            ,Y.SORT_ORD_NUM_1-->
<!--            ,Y.SORT_ORD_NUM_2-->
<!--          FROM-->
<!--          (-->
<!--              SELECT-->
<!--                  X.DS_CONTR_NUM-->
<!--                 ,X.SVC_INV_NUM-->
<!--                 ,X.INV_DT-->
<!--                 ,X.SVC_INV_CHRG_TP_DESC_TXT-->
<!--                 ,X.INV_TP_CD-->
<!--                 ,X.INV_TP_DESC_TXT-->
<!--                 ,X.SVC_INV_SRC_TP_DESC_TXT-->
<!--                 ,X.INV_TOT_DEAL_SLS_AMT-->
<!--                 ,X.INV_TOT_DEAL_TAX_AMT-->
<!--                 ,(X.INV_TOT_DEAL_NET_AMT + X.INV_TOT_DEAL_TAX_AMT) AS INV_TOT_DEAL_NET_AMT-->
<!--                 ,X.DEAL_RMNG_BAL_GRS_AMT-->
<!--                 ,X.BLLG_PER_FROM_DT-->
<!--                 ,X.BLLG_PER_TO_DT-->
<!--                 ,X.INV_DUE_DT-->
<!--                 ,X.CUST_CARE_TKT_NUM-->
<!--                 ,X.REBIL_SVC_INV_NUM-->
<!--                 ,X.CR_SVC_INV_NUM-->
<!--                 ,X.ORIG_SVC_INV_NUM-->
<!--                 ,X.INV_PRINT_RQST_NUM-->
<!--                 ,X.INV_FTP_RQST_NUM-->
<!--                  START 2018/09/27 T.Tomita [QC#28530 ADD] -->
<!--                 ,X.SORT_BLLG_PER_FROM_DT-->
<!--                 ,X.SORT_BLLG_PER_TO_DT-->
<!--                  END   2018/09/27 T.Tomita [QC#28530 ADD] -->
<!--                  START 2023/04/28 R.Avelino [QC#61399, ADD] -->
<!--                 ,CASE-->
<!--                      WHEN X.ORIG_SVC_INV_NUM IS NOT NULL THEN X.ORIG_SVC_INV_NUM-->
<!--                      WHEN X.REBIL_SVC_INV_NUM IS NOT NULL THEN X.SVC_INV_NUM-->
<!--                      WHEN X.CR_SVC_INV_NUM IS NOT NULL THEN X.SVC_INV_NUM-->
<!--                      ELSE NULL-->
<!--                  END SVC_INV_NUM_GRP_NUM-->
<!--                  END 2023/04/28 R.Avelino [QC#61399, ADD] -->
<!--                 ,RANK() OVER(PARTITION BY X.DS_CONTR_NUM, X.ORIG_SVC_INV_NUM-->
<!--                        ORDER BY-->
<!--                            X.SORT_BLLG_PER_FROM_DT     ASC-->
<!--                           ,X.SVC_INV_CHRG_TP_DESC_TXT  ASC-->
<!--                           ,X.DS_BLLG_SCHD_TP_CD        ASC-->
<!--                           ,X.INV_TP_CD                 DESC-->
<!--                           ,X.SVC_INV_NUM               ASC) AS SORT_ORD_NUM_1-->
<!--                ,RANK() OVER (PARTITION BY X.DS_CONTR_NUM, X.ORIG_SVC_INV_NUM-->
<!--                        ORDER BY-->
<!--                            X.DS_BLLG_SCHD_TP_CD        ASC-->
<!--                           ,X.INV_TP_CD                 DESC-->
<!--                           ,X.SVC_INV_CHRG_TP_DESC_TXT  ASC-->
<!--                           ,X.SORT_BLLG_PER_FROM_DT     ASC-->
<!--                           ,X.SVC_INV_NUM               ASC) AS SORT_ORD_NUM_2-->
<!--              FROM-->
<!--                  (-->
<!--                      SELECT-->
<!--                          M.*-->
<!--                      FROM-->
<!--                          MAIN M-->
<!--                  ) X-->
<!--              ORDER BY -->
<!--                  X.DS_CONTR_NUM                                      ASC-->
<!--                 ,SUBSTR(X.SORT_BLLG_PER_FROM_DT, 1, 8)               ASC-->
<!--                  START 2023/04/28 R.Avelino [QC#61399, ADD] -->
<!--                 ,SVC_INV_NUM_GRP_NUM                                 ASC NULLS FIRST-->
<!--                  END 2023/04/28 R.Avelino [QC#61399, ADD] -->
<!--                 ,X.ORIG_SVC_INV_NUM                                  ASC NULLS FIRST-->
<!--                 ,NVL2(X.ORIG_SVC_INV_NUM, SORT_ORD_NUM_2, 0)-->
<!--                      + NVL2(X.ORIG_SVC_INV_NUM, 0, SORT_ORD_NUM_1)   ASC-->
<!--          ) Y-->
        <!-- END 2023/04/20 R.Avelino [QC#61399, MOD] -->
         <!-- END 2023/09/22 R.Jin [QC#61399, MOD] -->
        WHERE
            ROWNUM &lt;= #rowNum#
<!-- END 2018/08/09 K.Kitachi [QC#22381, MOD] -->
<!-- END 2019/12/06 E.Kameishi [QC#54749, MOD] -->
    </statement>

    <resultMap id="result.getSvcInvList" class="NSAL0550_ASMsg">
        <result property="dsContrNum_A1"          column="DS_CONTR_NUM"             javaType="EZDSStringItem" />
        <result property="svcInvNum_A1"           column="SVC_INV_NUM"              javaType="EZDSStringItem" />
        <result property="invDt_A1"               column="INV_DT"                   javaType="EZDSStringItem" />
        <result property="svcInvChrgTpDescTxt_A1" column="SVC_INV_CHRG_TP_DESC_TXT" javaType="EZDSStringItem" />
<!-- START 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
        <result property="invTpCd_A1"             column="INV_TP_CD"                javaType="EZDSStringItem" />
<!-- END 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
        <result property="invTpDescTxt_A1"        column="INV_TP_DESC_TXT"          javaType="EZDSStringItem" />
        <result property="svcInvSrcTpDescTxt_A1"  column="SVC_INV_SRC_TP_DESC_TXT"  javaType="EZDSStringItem" />
        <result property="invTotDealSlsAmt_A1"    column="INV_TOT_DEAL_SLS_AMT"     javaType="EZDSBigDecimalItem" />
        <result property="invTotDealTaxAmt_A1"    column="INV_TOT_DEAL_TAX_AMT"     javaType="EZDSBigDecimalItem" />
        <result property="invTotDealNetAmt_A1"    column="INV_TOT_DEAL_NET_AMT"     javaType="EZDSBigDecimalItem" />
        <result property="dealRmngBalGrsAmt_A1"   column="DEAL_RMNG_BAL_GRS_AMT"    javaType="EZDSBigDecimalItem" />
<!-- START 2018/06/13 T.Murai [QC#25687, MOD] -->
<!--        <result property="bllgPerFromDt_A1" column="BLLG_PER_FROM_DT" javaType="EZDSDateItem" />-->
<!--        <result property="bllgPerToDt_A1" column="BLLG_PER_TO_DT" javaType="EZDSDateItem" />-->
        <result property="xxMsgPrmTxt_FR"         column="BLLG_PER_FROM_DT"         javaType="EZDSStringItem" />
        <result property="xxMsgPrmTxt_TO"         column="BLLG_PER_TO_DT"           javaType="EZDSStringItem" />
<!-- END 2018/06/13 T.Murai [QC#25687, MOD] -->
        <result property="invDueDt_A1"            column="INV_DUE_DT"               javaType="EZDSDateItem" />
        <result property="custCareTktNum_A1"      column="CUST_CARE_TKT_NUM"        javaType="EZDSStringItem" />
        <result property="rebilSvcInvNum_A1"      column="REBIL_SVC_INV_NUM"        javaType="EZDSStringItem" />
        <result property="crSvcInvNum_A1"         column="CR_SVC_INV_NUM"           javaType="EZDSStringItem" />
        <result property="origSvcInvNum_A1"       column="ORIG_SVC_INV_NUM"         javaType="EZDSStringItem" />
        <result property="invPrintRqstNum_A1"     column="INV_PRINT_RQST_NUM"       javaType="EZDSBigDecimalItem" />
        <result property="invFtpRqstNum_A1"       column="INV_FTP_RQST_NUM"         javaType="EZDSBigDecimalItem" />
        <!-- START 2018/09/27 T.Tomita [QC#28530 ADD] -->
        <result property="xxMsgPrmTxt_SF"         column="SORT_BLLG_PER_FROM_DT"    javaType="EZDSStringItem" />
        <result property="xxMsgPrmTxt_ST"         column="SORT_BLLG_PER_TO_DT"      javaType="EZDSStringItem" />
        <!-- END   2018/09/27 T.Tomita [QC#28530 ADD] -->
    </resultMap>

    <statement id="getCtacInfo" parameterClass="Map" resultClass="Map">
        SELECT
            SVC_INV_NUM
            ,CTAC_PSN_FIRST_NM
            ,CTAC_PSN_LAST_NM
            ,DS_CTAC_PNT_VAL_TXT
            ,RANK
        FROM (
                SELECT
                    A.SVC_INV_NUM
                    ,B.CTAC_PSN_FIRST_NM
                    ,B.CTAC_PSN_LAST_NM
                    ,C.DS_CTAC_PNT_VAL_TXT
                    ,ROW_NUMBER() OVER (ORDER BY C.DS_CTAC_PNT_PK) RANK
                FROM
                    SVC_INV A
                    ,CTAC_PSN B
                    ,DS_CTAC_PNT C
                    ,DS_CTAC_PNT_TP D
                WHERE
                    A.GLBL_CMPY_CD      = #glblCmpyCd#
                AND A.EZCANCELFLAG      = '0'
                AND A.SVC_INV_NUM       = #svcInvNum#
                AND A.GLBL_CMPY_CD      = B.GLBL_CMPY_CD
                AND A.CTAC_PSN_PK       = B.CTAC_PSN_PK
                AND B.EZCANCELFLAG      = '0'
                AND A.GLBL_CMPY_CD      = C.GLBL_CMPY_CD
                AND A.CTAC_PSN_PK       = C.CTAC_PSN_PK
                AND C.EZCANCELFLAG      = '0'
                AND C.GLBL_CMPY_CD      = D.GLBL_CMPY_CD
                AND C.DS_CTAC_PNT_TP_CD = D.DS_CTAC_PNT_TP_CD
                AND D.EZCANCELFLAG      = '0'
            )
        WHERE
            RANK = 1
    </statement>

    <statement id="getSvcInvChgTpCnt" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            COUNT(*)
        FROM
            SVC_INV_LINE    A
        WHERE
            A.GLBL_CMPY_CD              = #glblCmpyCd#
            AND A.EZCANCELFLAG          = '0'
            AND A.SVC_INV_NUM           = #svcInvNum#
            AND A.SVC_INV_CHRG_TP_CD    = #svcInvChrgTp#
    </statement>

<!-- START 2019/12/6 E.Kameishi [QC#54749, MOD] -->
<!-- [QC#21762,ADD]START -->
    <statement id="getCreditAndRebillCnt" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            SUM(X.COUNT)
        FROM
            (SELECT
                 COUNT(*) AS COUNT
             FROM
                 SVC_CR_REBIL       A
                ,SVC_CR_REBIL_DTL   B
             WHERE
                 A.GLBL_CMPY_CD        = #glblCmpyCd#
             AND A.EZCANCELFLAG        = '0'
             AND A.SVC_CR_REBIL_STS_CD &lt;&gt; #svcCrRebilStsCancelled#
             AND A.GLBL_CMPY_CD        = B.GLBL_CMPY_CD
             AND A.SVC_CR_REBIL_PK     = B.SVC_CR_REBIL_PK
             AND B.EZCANCELFLAG        = '0'
             AND (
                  B.ORIG_SVC_INV_NUM   = #svcInvNum#
                  OR  B.CR_SVC_INV_NUM = #svcInvNum#
                 )
             UNION
             SELECT
                 COUNT(*) AS COUNT
             FROM
                 AR_CR_REBIL       A
             WHERE
                 A.GLBL_CMPY_CD        = #glblCmpyCd#
             AND A.EZCANCELFLAG        = '0'
             AND A.ORIG_INV_NUM        = #svcInvNum#
             UNION
             SELECT
                 COUNT(*) AS COUNT
             FROM
                 AR_CR_REBIL       A
             WHERE
                 A.GLBL_CMPY_CD        = #glblCmpyCd#
             AND A.EZCANCELFLAG        = '0'
             AND A.INV_TP_CD           = #creditMemo#
             AND A.INV_NUM             = #svcInvNum#
            ) X
    </statement>
<!-- [QC#21762,ADD]END -->
<!-- END 2019/12/6 E.Kameishi [QC#54749, MOD] -->
</sqlMap>
