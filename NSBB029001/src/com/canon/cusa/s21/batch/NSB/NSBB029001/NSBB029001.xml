<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSBB029001">

    <!-- #################### Type Alias #################### -->

    <!-- #################### Statement #################### -->
    <statement id="getCrsSvcRcvHdrStage" parameterClass="Map">
        SELECT
             HDR.GLBL_CMPY_CD
<!-- START 2016/10/06 N.Arai [QC#14750, MOD]    -->
            ,HDR.FSR_NUM    AS TASK_NUM
            ,HDR.SER_NUM
            ,HDR.CRS_SVC_RCV_HDR_STAGE_PK
            ,TASK.FSR_NUM
<!-- START 2019/08/26 T.Aoyagi [QC#52704, ADD]    -->
            ,TASK.SVC_MACH_MSTR_PK
<!-- END 2019/08/26 T.Aoyagi [QC#52704, ADD]    -->
<!-- START QC#57307, ADD    -->
            ,TASK.CRS_SVC_SR_NUM
<!-- END QC#57307, ADD    -->
        FROM
             CRS_SVC_RCV_HDR_STAGE  HDR
            ,SVC_TASK               TASK
        WHERE HDR.GLBL_CMPY_CD        = #glblCmpyCd#
        AND   HDR.CRS_SVC_PROC_STS_CD = #procStsCd#
        AND   HDR.EZCANCELFLAG        = '0'
        AND   HDR.GLBL_CMPY_CD        = TASK.GLBL_CMPY_CD
        AND   HDR.FSR_NUM             = TASK.SVC_TASK_NUM
        AND   HDR.EZCANCELFLAG        = '0'
        ORDER BY
              HDR.FSR_NUM ASC
<!-- END 2016/10/06 N.Arai [QC#14750, MOD]      -->
    </statement>

    <statement id="getCrsSvcRcvMtrStage" parameterClass="Map" resultClass="Map">
        SELECT
             MTR.GLBL_CMPY_CD
            ,MTR.CRS_SVC_RCV_MTR_STAGE_PK
            ,MTR.CRS_SVC_RCV_HDR_STAGE_PK
            ,MTR.CRS_SVC_HDR_ID
            ,MTR.FSR_NUM
            ,MTR.CRS_SVC_MTR_LB_CD
            ,MTR.CRS_SVC_TASK_NUM
            ,MTR.PROC_SVC_TASK_NUM
            ,MTR.CRS_SVC_TEST_MTR_ORIG_TXT
            ,MTR.CRS_SVC_READ_MTR_ORIG_TXT
            ,MTR.CRS_SVC_PROC_STS_CD
            ,MAP.MTR_LB_CD
        FROM
              CRS_SVC_RCV_MTR_STAGE MTR
             ,CRS_SVC_MTR_LB_MAP MAP
        WHERE MTR.GLBL_CMPY_CD              = #glblCmpyCd#
        AND   MTR.CRS_SVC_RCV_HDR_STAGE_PK  = #crsSvcRcvHdrStagePk#
        AND   MTR.CRS_SVC_PROC_STS_CD       = #procStsCd#
        AND   MTR.EZCANCELFLAG              = '0'
        AND   MTR.GLBL_CMPY_CD              = MAP.GLBL_CMPY_CD(+)
        AND   MTR.CRS_SVC_MTR_LB_CD         = MAP.CRS_SVC_MTR_LB_CD(+)
        <!-- START 2019/08/23 K.Fujimoto [QC#52415, ADD] -->
        AND   MTR.FSR_NUM                   = #fsrNum#
        <!-- END   2018/09/18 K.Fujimoto [QC#52415, ADD] -->

<!-- START 2018/07/25 T.Wada [QC#27095, ADD] -->
        <isNotNull property="mtrGrpPk">
        AND   #mtrGrpPk#                    = MAP.MTR_GRP_PK(+)
        </isNotNull>
<!-- END   2018/07/25 T.Wada [QC#27095, ADD] -->

        AND   MTR.EZCANCELFLAG              = MAP.EZCANCELFLAG(+)
    </statement>

<!-- START 2016/04/19 Y.Takeno [QC#5459, ADD] -->
    <statement id="getCrsSvcRcvTaskStage" parameterClass="Map" resultClass="Map">
<!-- START 2018/02/01 T.Tomita [QC#23569, MOD] -->
        SELECT
             B.FSR_NUM                   AS FSR_NUM
            ,D.CRS_SVC_RCV_SR_NUM        AS CRS_SVC_RCV_SR_NUM
            ,B.SVC_TASK_NUM              AS SVC_TASK_NUM
            ,C.FSR_VISIT_STS_CD          AS FSR_VISIT_STS_CD
            ,D.CRS_SVC_RCV_TASK_STAGE_PK AS CRS_SVC_RCV_TASK_STAGE_PK
            ,D.CRS_SVC_RCV_HDR_STAGE_PK  AS CRS_SVC_RCV_HDR_STAGE_PK
        FROM
             (
                SELECT
                    ST.FSR_NUM
                FROM
                     CRS_SVC_RCV_TASK_STAGE CSRTS
                    ,SVC_TASK ST
                WHERE
                    CSRTS.GLBL_CMPY_CD             = #glblCmpyCd#
                AND CSRTS.CRS_SVC_RCV_HDR_STAGE_PK = #crsSvcRcvHdrStagePk#
                AND CSRTS.CRS_SVC_PROC_STS_CD      = '0'
                AND CSRTS.EZCANCELFLAG             = '0'
                AND CSRTS.GLBL_CMPY_CD             = ST.GLBL_CMPY_CD
                AND CSRTS.FSR_NUM                  = ST.SVC_TASK_NUM
                AND CSRTS.CRS_SVC_RCV_SR_NUM       = ST.CRS_SVC_SR_NUM
                AND ST.EZCANCELFLAG                = '0'
                GROUP BY
                    ST.FSR_NUM
             ) A
            ,SVC_TASK               B
            ,FSR_VISIT              C
            ,CRS_SVC_RCV_TASK_STAGE D
        WHERE
            A.FSR_NUM             = B.FSR_NUM
        AND B.GLBL_CMPY_CD        = #glblCmpyCd#
        AND B.EZCANCELFLAG        = '0'
        AND B.GLBL_CMPY_CD        = C.GLBL_CMPY_CD
        AND B.FSR_NUM             = C.FSR_NUM
        AND B.SVC_TASK_NUM        = C.SVC_TASK_NUM
        AND C.EZCANCELFLAG        = '0'
        AND B.GLBL_CMPY_CD        = D.GLBL_CMPY_CD
        AND B.CRS_SVC_SR_NUM      = D.CRS_SVC_RCV_SR_NUM
        AND D.CRS_SVC_PROC_STS_CD = '0'
        AND D.EZCANCELFLAG        = '0'
        ORDER BY
             B.FSR_NUM
            ,B.SVC_TASK_NUM
            ,D.CRS_SVC_RCV_SR_NUM
<!-- END 2018/02/01 T.Tomita [QC#23569, MOD] -->
    </statement>
<!-- END 2016/04/19 Y.Takeno [QC#5459, ADD] -->

    <!-- START 2018/09/18 K.Fujimoto [QC#28294, ADD] -->
    <statement id="getInstallCheckList" parameterClass="Map" resultClass="Map">
            SELECT
                 SMM.SVC_CONFIG_MSTR_PK
                ,SMM.MDSE_CD
                ,DMI.MDSE_DESC_SHORT_TXT
                ,SMM.SER_NUM
                ,MN.T_MDL_NM
                ,SMM.SVC_MACH_MSTR_STS_CD
                ,SMM.SVC_MACH_TP_CD
                ,SCM.MDL_ID
            FROM
                 SVC_MACH_MSTR      SMM
                ,MDSE               DMI
                ,SVC_CONFIG_MSTR    SCM
                ,MDL_NM             MN
            WHERE
                    SMM.GLBL_CMPY_CD         = #glblCmpyCd#
                AND SMM.SVC_MACH_MSTR_STS_CD IN (#machStsCd#, #machStsCdInstl#)
                AND SMM.EZCANCELFLAG         = '0'
                AND SMM.GLBL_CMPY_CD         = DMI.GLBL_CMPY_CD(+)
                AND SMM.MDSE_CD              = DMI.MDSE_CD(+)
                AND DMI.EZCANCELFLAG(+)      = '0'
                AND SMM.SVC_CONFIG_MSTR_PK   = SCM.SVC_CONFIG_MSTR_PK(+)
                AND SMM.GLBL_CMPY_CD         = SCM.GLBL_CMPY_CD(+)
                AND SCM.EZCANCELFLAG(+)      = '0'
                AND SCM.MDL_ID               = MN.T_MDL_ID(+)
                AND SCM.GLBL_CMPY_CD         = MN.T_GLBL_CMPY_CD(+)
                AND MN.EZCANCELFLAG(+)       = '0'
                AND EXISTS(SELECT 1 FROM SVC_MACH_MSTR TRIB
                           WHERE TRIB.GLBL_CMPY_CD             = SMM.GLBL_CMPY_CD
                                 AND TRIB.SVC_MACH_MSTR_PK     = #svcMachMstrPk#
                                 AND TRIB.SVC_CONFIG_MSTR_PK   = SMM.SVC_CONFIG_MSTR_PK
                                 AND TRIB.EZCANCELFLAG         = '0' )
        ORDER BY
            SVC_MACH_TP_CD, MDSE_CD, SER_NUM
    <!-- END 2018/09/18 K.Fujimoto [QC#28294, ADD] -->
    </statement>
    <!-- START 2018/11/28 S.Kitamura [QC#29016, ADD] -->
    <statement id="getLastMeterCount" parameterClass="Map" resultClass="BigDecimal">
            SELECT * 
            FROM
	            (SELECT
	                MTR.READ_MTR_CNT
	            FROM
	                SVC_PHYS_MTR_READ MTR
	            WHERE 
	                    MTR.SVC_MACH_MSTR_PK = #svcMachMstrPk#
	                AND MTR.MTR_LB_CD = #mtrLbCd#
	                AND MTR.MTR_READ_DT &lt;= #mtrReadDt#
	                AND MTR.VLD_MTR_FLG = 'Y'
	                AND MTR.EZCANCELFLAG = '0' 
	                AND MTR.GLBL_CMPY_CD  = #glblCmpyCd#
	            ORDER BY
	                MTR.MTR_READ_DT DESC ,
	                MTR.SVC_PHYS_MTR_READ_GRP_SQ DESC
	            )
            WHERE ROWNUM = 1
    </statement>
    <!-- END 2018/11/28 S.Kitamura [QC#29016, ADD] -->
    <!-- START 2019/08/23 K.Fujimoto [QC#52415, MOD] -->
    <statement id="getCrsSrNum" parameterClass="Map" resultClass="String">
            SELECT ST.CRS_SVC_SR_NUM
            FROM
	              FSR_VISIT FV
	             ,SVC_TASK  ST
	        WHERE
	              FV.GLBL_CMPY_CD  = #glblCmpyCd#
	          AND FV.FSR_NUM = #fsrNum#
	          AND FV.FSR_VISIT_NUM = #fsrVisitNum#
	          AND FV.GLBL_CMPY_CD  = ST.GLBL_CMPY_CD
	          AND FV.SVC_TASK_NUM  = ST.SVC_TASK_NUM
    </statement>
    <!-- END   2019/08/23 K.Fujimoto [QC#52415, MOD] -->
</sqlMap>
