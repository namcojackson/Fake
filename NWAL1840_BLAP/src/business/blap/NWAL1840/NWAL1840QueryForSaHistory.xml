<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NWAL1840QueryForSaHistory">

    <statement id="getSaHistory" parameterClass="Map" resultClass="Map">
        WITH SA_HISTORY AS (
            SELECT
                X.SCHD_AGMT_NUM
               ,X.SER_NUM
               ,X.DS_CONTR_NUM
               ,Z.LOC_NM
               ,Y.SCHD_AGMT_STS_NM
               ,X.SCHD_AGMT_CRAT_DT
               ,X.SCHD_AGMT_VLD_FROM_DT
               ,X.SCHD_AGMT_VLD_THRU_DT
            FROM
                SCHD_AGMT         X
               ,SCHD_AGMT_STS     Y
               ,BILL_TO_CUST      Z
            WHERE
                    X.GLBL_CMPY_CD        = #glblCmpyCd#
                AND X.EZCANCELFLAG        = '0'
                AND X.GLBL_CMPY_CD        = Y.GLBL_CMPY_CD
                AND Y.EZCANCELFLAG        = '0'
                AND X.GLBL_CMPY_CD        = Z.GLBL_CMPY_CD
                AND Z.EZCANCELFLAG        = '0'
                AND X.SCHD_AGMT_STS_CD    = Y.SCHD_AGMT_STS_CD
                AND X.SOLD_TO_CUST_LOC_CD = Z.BILL_TO_CUST_CD
                AND X.SER_NUM             = #serNum#
            ORDER BY
                SCHD_AGMT_CRAT_DT DESC
               ,SCHD_AGMT_NUM     DESC
        )

        SELECT
            SH.SCHD_AGMT_NUM
           ,SH.SER_NUM
           ,SH.DS_CONTR_NUM
           ,SH.LOC_NM
           ,SH.SCHD_AGMT_STS_NM
           ,SH.SCHD_AGMT_CRAT_DT
           ,SH.SCHD_AGMT_VLD_FROM_DT
           ,SH.SCHD_AGMT_VLD_THRU_DT
        FROM
            SA_HISTORY SH
        WHERE
            ROWNUM &lt;= #numOfHistory#
	</statement>

</sqlMap>
