<?xml version="1.0" encoding="UTF-8"?>

<project name="S21CodeMaintenanceWeb" basedir="." default="build">


<!-- Replace value -->
<property name="returnMenuUrl"                value="/dvlppc/main.jsp"/>

<property name="datasource"                   value="S21_APPS01"/>
<property name="provider_url"                 value="file:////home/waspoc/jndi"/>
<!--
<property name="datasource"                   value="ARCH"/>
<property name="provider_url"                 value="file:///C:/Interstage/J2EE/var/jndi"/>
-->

<!-- Module name -->
<property name="ap.name"                      value="S21CodeMaintenanceWeb"/>
<property name="jar.name"                     value="${ap.name}.jar"/>
<property name="war.name"                     value="${ap.name}.war"/>
<property name="ear.name"                     value="${ap.name}.ear"/>

<!-- Root dir -->
<property name="root"                         location="."/>
<!-- Release dir -->
<property name="rel.dir"                      location="${root}/release"/>
<property name="rel.ear"                      location="${rel.dir}/ear"/>
<property name="rel.ear.meta-inf"             location="${rel.ear}/META-INF"/>
<property name="rel.war"                      location="${rel.dir}/war"/>
<property name="rel.war.cm"                   location="${rel.war}/codemaintenance"/>
<property name="rel.war.css"                  location="${rel.war}/css"/>
<property name="rel.war.img"                  location="${rel.war}/img"/>
<property name="rel.war.meta-inf"             location="${rel.war}/META-INF"/>
<property name="rel.war.web-inf"              location="${rel.war}/WEB-INF"/>
<property name="rel.war.web-inf.lib"          location="${rel.war.web-inf}/lib"/>
<property name="rel.war.web-inf.classes"      location="${rel.war.web-inf}/classes"/>
<property name="rel.props"                    location="${rel.dir}/props"/>
<property name="rel.webx"                     location="${rel.dir}/web_xml"/>
<!-- Source dir：WebResource -->
<property name="ctxroot"                      location="${root}/ContextRoot"/>
<property name="ctxroot.cm"                   location="${ctxroot}/codemaintenance"/>
<property name="ctxroot.css"                  location="${ctxroot}/css"/>
<property name="ctxroot.img"                  location="${ctxroot}/img"/>
<property name="ctxroot.meta"                 location="${ctxroot}/META-INF"/>
<property name="ctxroot.web-inf"              location="${ctxroot}/WEB-INF"/>
<property name="ctxroot.web-inf.lib"          location="${ctxroot.web-inf}/lib"/>
<property name="ctxroot.web-inf.classes"      location="${ctxroot.web-inf}/classes"/>
<!-- Source dir：Java Source -->
<property name="src.dir"                      location="${root}/src"/>
<property name="env_src.dir"                  location="${root}/env_src"/>
<!-- Source dir：Settings -->
<property name="config"                       location="${root}/config"/>
<property name="config.meta-inf"              location="${root}/config/META-INF"/>
<property name="config.test"                  location="${root}/config_test"/>
<!-- Source dir：Master Files -->
<property name="dvlpMaster"                   location="../dvlpMaster"/>
<property name="dvlpPC"                       location="../dvlpPC"/>

<property name="99ezf.parts.java"             location="${dvlpPC}/99ezf/parts/java"/>

<property name="80conf.setting"               location="${dvlpMaster}/80conf/setting"/>

<property name="SharedResources"              location="../SharedResources"/>
<property name="31dbjava.oracle.gen.src"      location="${SharedResources}/31dbjava/oracle/gen/src"/>
<property name="31dbjava.oracle.gen.xml"      location="${SharedResources}/31dbjava/oracle/gen/xml"/>

<property name="EZDSystemMessage"             location="${dvlpMaster}/90common/msg/EZDSystemMessage.properties"/>
<property name="EZDBusinessMessage"           location="${SharedResources}/90common/msg/EZDBusinessMessage.properties"/>

<property name="application_xml"              location="${dvlpMaster}/80conf/package/ear/META_INF/application.xml"/>
<property name="ibm-web-ext_xmi"              location="${dvlpMaster}/80conf/package/war/WEB-INF/ibm-web-ext.xmi"/>
<property name="ibm-web-bnd_xmi"              location="${dvlpMaster}/80conf/package/war/WEB-INF/ibm-web-bnd.xmi"/>

<!-- Local dirs -->
<property name="Interstage.dir"               location="C:/Interstage"/>

<!-- Work dir -->
<property name="temp.dir"                     location="${root}/temp"/>

<property environment="env"/>


<target name="build"/>

<!-- **************************************************************
 WARファイル生成
 （WAR単独デプロイ用モジュール：プロダクション環境用）
 ************************************************************** -->
<target name="build.war.for_production" description="EAR不要版：プロダクション環境用WAR作成（暫定版）">
    <antcall target="1_copy.latest.fw-jar"/>
    <antcall target="2_compile.31dbjava"/>
    <antcall target="3_compile.src"/>
    <antcall target="4_clean.release.dir"/>
    <antcall target="5_copy.files.to_release"/>
    <antcall target="6_copy.config.files.to_release"/>
    <antcall target="9_create.war"/>
</target>

<!-- **************************************************************
 WARファイル生成
 （WAR単独デプロイ用モジュール：テスト環境用）
 ************************************************************** -->
<target name="build.war.for_test" description="EAR不要版：テスト環境用WAR作成">
    <antcall target="1_copy.latest.fw-jar"/>
    <antcall target="2_compile.31dbjava"/>
    <antcall target="3_compile.src"/>
    <antcall target="4_clean.release.dir"/>
    <antcall target="5_copy.files.to_release"/>
    <antcall target="6_copy.config.files.to_release"/>
    <antcall target="7_(overwrite.was-test-config.files.to_release)"/>
    <antcall target="9_create.war"/>
</target>

<!-- **************************************************************
 WARファイル生成
 （S21FWを使用した運用系画面EARへ同梱するためのモジュール：プロダクション環境用）
 ************************************************************** -->
<target name="build.war.for_production.[ear]" description="運用系画面EAR同梱版WAR作成（プロダクション環境用）">
    <antcall target="1_copy.latest.fw-jar"/>
    <antcall target="2_compile.31dbjava"/>
    <antcall target="3_compile.src"/>
    <antcall target="4_clean.release.dir"/>
    <antcall target="5_copy.files.to_release.[ear]"/>
    <antcall target="6_copy.config.files.to_release.[ear]"/>
    <antcall target="9_create.war"/>
</target>

<!-- **************************************************************
 WARファイル生成
 （S21FWを使用した運用系画面EARへ同梱するためのモジュール：テスト環境）
 ************************************************************** -->
<target name="build.war.for_test.[ear]" description="運用系画面EAR同梱版WAR作成（テスト環境用）">
    <antcall target="1_copy.latest.fw-jar"/>
    <antcall target="2_compile.31dbjava"/>
    <antcall target="3_compile.src"/>
    <antcall target="4_clean.release.dir"/>
    <antcall target="5_copy.files.to_release.[ear]"/>
    <antcall target="6_copy.config.files.to_release.[ear]"/>
    <antcall target="7_(overwrite.was-test-config.files.to_release.[ear])"/>
    <antcall target="9_create.war"/>
</target>


<!-- **************************************************************
 コンパイル用Jarファイル取得
 ************************************************************** -->
<target name="get.fw-jar" description="コンパイル用Jarファイル取得">
    <antcall target="1_copy.latest.fw-jar"/>
</target>


<!-- **************************************************************
 Jarファイル最新化
 ************************************************************** -->
<target name="1_copy.latest.fw-jar">
    <!-- ミドルウェアJar最新化 -->
    <copy todir="${ctxroot.web-inf.lib}" overwrite="true" flatten="yes">
        <fileset dir="${99ezf.parts.java}">
            <include name="EXTJARS/fscontext.jar"/>
            <include name="EXTJARS/providerutil.jar"/>
            <include name="EXTJARS/jstl.jar"/>
            <include name="EXTJARS/standard.jar"/>
            <include name="EXTJARS/ojdbc14.jar"/>
            <include name="EXTJARS/orai18n.jar"/>
        </fileset>
    </copy>

    <!-- FW,部品Jar最新化 -->
    <copy todir="${ctxroot.web-inf.lib}" overwrite="true" flatten="yes">
        <fileset dir="${99ezf.parts.java}">
            <include name="EZDCommon/EZDCommon.jar"/>
            <include name="EZDi18n/EZDI18N.jar"/>
            <include name="EZDMonitor/EZDMonitor.jar"/>
            <include name="S21Cache/S21Cache.jar"/>
            <include name="S21Codetable/S21Codetable.jar"/>
            <include name="S21Log/S21Log.jar"/>
            <include name="S21AuthorizationService/S21AuthorizationService.jar"/>
            <include name="S21SecurityAuthExt/S21SecurityAuthExt.jar"/>
            <include name="S21SecurityCommon/S21SecurityCommon.jar"/>
            <include name="S21SecurityTestEnv/S21SecurityTestEnv.jar"/>
            <include name="S21DBAppArch/S21DBAppArch.jar"/>
        </fileset>
    </copy>
</target>

<!-- **************************************************************
 31dbjava.jar コンパイル＆パッケージ
 ************************************************************** -->
<target name="2_compile.31dbjava">
    <delete dir="${temp.dir}"/>
    <mkdir dir="${temp.dir}"/>

    <path id="id_classpath1">
        <fileset dir="${ctxroot.web-inf.lib}">
            <include name="*.jar"/>
            <exclude name="31dbjava.jar"/>
        </fileset>
    </path>

    <javac encoding="utf8" debug="on" memoryMaximumSize="512m" fork="true" destdir="${temp.dir}">
        <classpath refid="id_classpath1"/>
        <src path="${31dbjava.oracle.gen.src}"/>
    </javac>

    <!-- アクセス条件XMLファイルがない場合生成する -->
    <exec dir="${root}" executable="createConditionXml.cmd"/>

    <jar jarfile="${ctxroot.web-inf.lib}/31dbjava.jar">
        <fileset dir="${temp.dir}" includes="**/*.class" excludes="**/Test*.class"/>
        <fileset dir="${temp.dir}" includes="*.xml"/>
        <fileset dir="${31dbjava.oracle.gen.xml}" includes="**/*.xml"/>
    </jar>

    <delete dir="${temp.dir}"/>
</target>

<!-- **************************************************************
 S21CodeMaintenanceWeb.jar コンパイル＆パッケージ
 ************************************************************** -->
<target name="3_compile.src">
    <delete dir="${temp.dir}"/>
    <mkdir dir="${temp.dir}"/>

    <path id="id_classpath2">
        <fileset dir="${ctxroot.web-inf.lib}">
            <include name="*.jar"/>
            <exclude name="S21CodeMaintenanceWeb.jar"/>
        </fileset>
        <fileset dir="${Interstage.dir}/J2EE/lib">
            <include name="isj2ee.jar"/>
            <include name="isws.jar"/>
        </fileset>
        <fileset dir="${Interstage.dir}/F3FMjs5/common/lib">
            <include name="servlet-api.jar"/>
            <include name="jsp-api.jar"/>
        </fileset>
    </path>

    <javac encoding="utf8" debug="on" memoryMaximumSize="128m" fork="true" destdir="${temp.dir}">
        <classpath refid="id_classpath2"/>
        <src path="${src.dir}"/>
        <src path="${env_src.dir}"/>
    </javac>

    <jar jarfile="${ctxroot.web-inf.lib}/S21CodeMaintenanceWeb.jar">
        <fileset dir="${temp.dir}" includes="**/*.class" excludes="**/Test*.class"/>
    </jar>

    <delete dir="${temp.dir}"/>
</target>

<!-- **************************************************************
 releaseディレクトリ再作成
 ************************************************************** -->
<target name="4_clean.release.dir">
    <delete dir="${rel.dir}"/>
    <mkdir dir="${rel.dir}"/>
    <mkdir dir="${rel.ear}"/>
    <mkdir dir="${rel.ear.meta-inf}"/>
    <mkdir dir="${rel.war}"/>
</target>

<!-- **************************************************************
 releaseディレクトリへファイルコピー
 ************************************************************** -->
<target name="5_copy.files.to_release">
    <copy todir="${rel.war}" overwrite="yes" includeEmptyDirs="no">
        <fileset dir="${ctxroot}">
            <exclude name="**/CVS*"/>
            <exclude name="**/*.class"/>
            <exclude name="**/*.metadata-*"/>
        </fileset>
    </copy>
</target>

<!-- **************************************************************
 releaseディレクトリへファイルコピー
 ************************************************************** -->
<target name="5_copy.files.to_release.[ear]">
    <copy todir="${rel.war}" overwrite="yes" includeEmptyDirs="no">
        <fileset dir="${ctxroot}">
            <exclude name="**/CVS*"/>
            <exclude name="**/*.class"/>
            <exclude name="**/*.jar"/>
            <exclude name="**/*.metadata-*"/>
        </fileset>
    </copy>
    <copy todir="${rel.ear}" overwrite="yes" includeEmptyDirs="no">
        <fileset dir="${ctxroot.web-inf.lib}">
            <include name="*.jar"/>
            <exclude name="**/*.metadata-*"/>
        </fileset>
    </copy>
</target>

<!-- **************************************************************
 releaseディレクトリへ設定ファイルコピー
 ************************************************************** -->
<target name="6_copy.config.files.to_release">
    <delete dir="${rel.war.web-inf.classes}"/>
    <mkdir dir="${rel.war.web-inf.classes}"/>

    <!-- 設定ファイル全般 -->
    <copy todir="${rel.war.web-inf.classes}" overwrite="yes" flatten="yes" includeEmptyDirs="no">
        <fileset dir="${80conf.setting}">
            <include name="**/*.properties"/>
            <include name="**/*.xml"/>
            <exclude name="**/web.xml"/>
            <exclude name="**/s21codetableinfo.properties"/>
            <exclude name="**/*.metadata-*"/>
        </fileset>
    </copy>

    <!-- メッセージ -->
    <copy todir="${rel.war.web-inf.classes}" overwrite="yes" flatten="yes">
        <fileset file="${EZDSystemMessage}"/>
        <fileset file="${EZDBusinessMessage}"/>
    </copy>

    <!-- IBMデプロイメントデスクリプタ -->
    <copy todir="${rel.war.web-inf}" overwrite="yes" flatten="yes">
        <fileset file="${ibm-web-ext_xmi}"/>
        <!-- <fileset file="${ibm-web-bnd_xmi}"/> -->
    </copy>

    <!-- コードメンテ設定ファイル -->
    <copy todir="${rel.war.web-inf.classes}" overwrite="yes">
        <fileset dir="${config}">
            <include name="*"/>
            <exclude name="**/*.metadata-*"/>
        </fileset>
    </copy>
</target>

<!-- **************************************************************
 earディレクトリへ設定ファイルコピー
 ************************************************************** -->
<target name="6_copy.config.files.to_release.[ear]">
    <!-- 設定ファイル全般 -->
    <copy todir="${rel.ear}" overwrite="yes" flatten="yes" includeEmptyDirs="no">
        <fileset dir="${80conf.setting}">
            <include name="**/*.properties"/>
            <include name="**/*.xml"/>
            <exclude name="**/web.xml"/>
            <exclude name="**/s21codetableinfo.properties"/>
            <exclude name="**/*.metadata-*"/>
        </fileset>
    </copy>

    <!-- メッセージ -->
    <copy todir="${rel.ear}" overwrite="yes" flatten="yes">
        <fileset file="${EZDSystemMessage}"/>
        <fileset file="${EZDBusinessMessage}"/>
    </copy>

    <!-- IBMデプロイメントデスクリプタ -->
    <copy todir="${rel.war.web-inf}" overwrite="yes" flatten="yes">
        <fileset file="${ibm-web-ext_xmi}"/>
        <!-- <fileset file="${ibm-web-bnd_xmi}"/> -->
    </copy>

    <!-- コードメンテ設定ファイル -->
    <copy todir="${rel.ear}" overwrite="yes" flatten="no">
        <fileset dir="${config}">
            <include name="**/*.properties"/>
            <include name="**/*.xml"/>
            <include name="**/MANIFEST.MF"/>
            <exclude name="**/web.xml"/>
            <exclude name="**/*.metadata-*"/>
        </fileset>
    </copy>
</target>

<!-- **************************************************************
 releaseディレクトリへ設定ファイルコピー
 ************************************************************** -->
<target name="7_(overwrite.was-test-config.files.to_release)">
    <copy todir="${rel.war.web-inf}" overwrite="yes" flatten="yes">
        <fileset dir="${config.test}">
            <include name="**/web.xml"/>
        </fileset>
    </copy>
    <copy todir="${rel.war.web-inf.classes}" overwrite="yes" flatten="yes" includeEmptyDirs="no">
        <fileset dir="${config.test}">
            <include name="**/*.properties"/>
            <include name="**/*.xml"/>
            <exclude name="**/web.xml"/>
            <exclude name="**/*.metadata-*"/>
        </fileset>
    </copy>
</target>

<!-- **************************************************************
 ear,releaseディレクトリへ設定ファイルコピー
 ************************************************************** -->
<target name="7_(overwrite.was-test-config.files.to_release.[ear])">
    <copy todir="${rel.war.web-inf}" overwrite="yes" flatten="yes">
        <fileset dir="${config.test}">
            <include name="**/web.xml"/>
        </fileset>
    </copy>
    <copy todir="${rel.ear}" overwrite="yes" flatten="yes" includeEmptyDirs="no">
        <fileset dir="${config.test}">
            <include name="**/*.properties"/>
            <include name="**/*.xml"/>
            <exclude name="**/web.xml"/>
            <exclude name="**/*.metadata-*"/>
        </fileset>
    </copy>
</target>

<!-- **************************************************************
 設定ファイル編集
 ************************************************************** -->
<target name="8_edit.settings.ear">
    <!--<replace file="${rel.ear}/EZDDBInfo.properties" token="@@@" value="wombat"/>-->
    <replaceregexp file="${rel.ear}/EZDDBInfo.properties" byline="true"
                         match="^DataSourceName_0=(.*)"
                         replace="DataSourceName_0=${datasource}"/>
    <replaceregexp file="${rel.ear}/EZDDBInfo.properties" byline="true"
                         match="^Context.PROVIDER_URL_0=(.*)"
                         replace="Context.PROVIDER_URL_0=${provider_url}"/>
    <replaceregexp file="${ctxroot.web-inf}/web.xml" byline="true"
                         match="/dvlppc/main.jsp"
                         replace="${returnMenuUrl}"/>
</target>

<!-- **************************************************************
 warパッケージ作成
 ************************************************************** -->
<target name="9_create.war">
    <delete file="${rel.dir}/${war.name}"/>
    <jar destfile="${rel.dir}/${war.name}" basedir="${rel.war}" manifest="${rel.war.meta-inf}/MANIFEST.MF"/>
</target>

<!-- **************************************************************
 earパッケージ作成
 ************************************************************** -->
<target name="A_create.ear">
    <delete file="${rel.dir}/${ear.name}"/>
    <jar destfile="${rel.dir}/${ear.name}">
        <fileset dir="${rel.ear}">
            <exclude name="jstl.jar"/>
            <exclude name="standard.jar"/>
        </fileset>
        <fileset file="${rel.dir}/${war.name}"/>
    </jar>
</target>

<!-- **************************************************************
 ローカルのInterStageにデプロイ
 ************************************************************** -->
<target name="deploy.war.to_local.[ear]">
    <property name="ijserver" location="C:/Interstage/J2EE/var/deployment/ijserver"/>
    <property name="AppRoot"  location="${ijserver}/S21CodeMaintenance"/>

    <copy todir="${AppRoot}/apps/S21CodeMaintenance" overwrite="yes">
        <fileset dir="${rel.war}"/>
    </copy>
    <copy todir="${AppRoot}/Shared/classes" overwrite="yes">
        <fileset dir="${rel.ear}">
            <include name="**/*.properties"/>
            <include name="**/*.xml"/>
        </fileset>
    </copy>
    <copy todir="${AppRoot}/Shared/lib" overwrite="yes">
        <fileset dir="${rel.ear}">
            <include name="*.jar"/>
        </fileset>
    </copy>
</target>

</project>
