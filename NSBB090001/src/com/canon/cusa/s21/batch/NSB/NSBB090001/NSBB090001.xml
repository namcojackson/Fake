<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSBB090001">

    <statement id="getTrgtYrMth" parameterClass="Map" resultClass="String">
        SELECT
            CAL.DWH_TRGT_YR_MTH
        FROM
            DMN_RPT_CAL              CAL
        WHERE 
            CAL.GLBL_CMPY_CD         = #glblCmpyCd#
        AND CAL.DWH_TRGT_DT          = #trgtDt#
        AND CAL.EZCANCELFLAG         = '0'
    </statement>

    <statement id="getTrgtYrMthRec" parameterClass="Map" resultClass="BigDecimal">
        SELECT COUNT(1)
        FROM
            FCT_MLY_FSR_VISIT        FCT
        WHERE 
            FCT.GLBL_CMPY_CD         = #glblCmpyCd#
        AND FCT.DWH_TRGT_YR_MTH      = #trgtYrMth#
        AND FCT.EZCANCELFLAG         = '0'
    </statement>

    <statement id="getMainData" parameterClass="Map" resultClass="Map">
        -- Visit Data
        SELECT
            VIS.FSR_NUM
           ,FSR.FSR_TP_CD
           ,FSR.FSR_CRAT_DT
           ,FSR.FSR_CRAT_TM
           ,FSR.FSR_CPLT_DT
           ,FSR.FSR_CPLT_TM
           ,TSK.SVC_TASK_NUM
           ,TSK.SVC_TASK_STS_CD
           ,TSK.DS_SVC_CALL_TP_CD
           ,NVL(DSCT.PHO_FIX_FLG, 'N')                 AS PHO_FIX_FLG
           ,SUBSTR(TSK.ERL_START_TS, 0, #ymdtsLen#)    AS ERL_START_TS
           ,VIS.FSR_VISIT_NUM
           ,VIS.PREV_FSR_VISIT_NUM
           ,VIS.NEXT_FSR_VISIT_NUM
           ,NEX.DS_SVC_CALL_TP_CD                      AS NEXT_VISIT_SVC_CALL_TP_CD
           ,SUP.SVC_SUPPL_TASK_NUM                     AS SVC_SUPPL_TASK_NUM
           ,SUP.SVC_SUPPL_TASK_TP_CD                   AS SVC_SUPPL_TASK_TP_CD
           ,VIS.TECH_CD
           ,TEC.FLD_SVC_MGR_CD
           ,NVL(TSK.FIRST_SVC_TASK_FLG ,'N')           AS FIRST_VISIT_FLG
           ,CASE WHEN TSK.FIRST_SVC_TASK_FLG = 'Y' AND VIS.FSR_VISIT_LTST_FLG = 'Y' THEN 'Y' ELSE 'N' END AS FIRST_VISIT_CPLT_FLG
           ,CASE WHEN STE.SVC_TASK_NUM IS NOT NULL THEN 'Y' ELSE 'N' END AS TSS_FOLL_UP_FLG
           ,NVL(FVTE.MOD_EVENT_CNT, 0)                 AS MOD_EVENT_CNT
           ,MAC.SVC_CONFIG_MSTR_PK
           ,NVL(MDL_1.MDL_ID                  , MDL_2.MDL_ID)                      AS MDL_ID
           ,NVL(MDL_1.RCLL_INTVL_DAYS_AOT     , MDL_2.RCLL_INTVL_DAYS_AOT)         AS RCLL_INTVL_DAYS_AOT
           ,NVL(MDL_1.RCLL_COPY_VOL_CNT       , MDL_2.RCLL_COPY_VOL_CNT)           AS RCLL_COPY_VOL_CNT
           ,NVL(MDL_1.RCLL_GLBL_INTVL_DAYS_AOT, MDL_2.RCLL_GLBL_INTVL_DAYS_AOT)    AS RCLL_GLBL_INTVL_DAYS_AOT
           ,NVL(MDL_1.RCLL_GLBL_COPY_VOL_CNT  , MDL_2.RCLL_GLBL_COPY_VOL_CNT)      AS RCLL_GLBL_COPY_VOL_CNT
           ,FSR.SVC_MACH_MSTR_PK
           ,FSR.SER_NUM
           ,MAC.MDSE_CD
           ,MAC.CUR_LOC_ACCT_NUM
           ,ACC.DS_ACCT_NM                             AS CUR_LOC_ACCT_NM
           ,DAG.DS_ACCT_GRP_CD
           ,DAG.DS_ACCT_GRP_NM
           ,MAC.CUR_LOC_NUM
           ,MAC.IND_CUR_LOC_NUM
           ,NVL(MAC.DS_KEY_ACCT_FLG, 'N')              AS DS_KEY_ACCT_FLG
           ,SHP.FIRST_LINE_ADDR
           ,SHP.SCD_LINE_ADDR
           ,SHP.THIRD_LINE_ADDR
           ,SHP.FRTH_LINE_ADDR
           ,SHP.CTY_ADDR
           ,SHP.CNTY_PK
           ,SHP.PROV_NM
           ,SHP.ST_CD
           ,SHP.POST_CD
           ,SHP.CTRY_CD
           ,VIS.TECH_SCHD_FROM_DT
           ,VIS.TECH_SCHD_FROM_TM
           ,VIS.TECH_SCHD_TO_DT
           ,VIS.TECH_SCHD_TO_TM
           ,VIS.TECH_SCHD_TZ
           ,VIS.FSR_VISIT_SCHD_DT
           ,VIS.FSR_VISIT_SCHD_TM
           ,VIS.FSR_VISIT_DISPT_DT
           ,VIS.FSR_VISIT_DISPT_TM
           ,VIS.SVC_ASG_TP_CD
           ,NVL(VIS.TECH_ACPT_FLG, 'N')                AS TECH_ACPT_FLG
           ,VIS.TECH_ACPT_DT
           ,VIS.TECH_ACPT_TM
           ,VIS.FSR_VISIT_ARV_DT
           ,VIS.FSR_VISIT_ARV_TM
           ,VIS.FSR_VISIT_CPLT_DT
           ,VIS.FSR_VISIT_CPLT_TM
           ,VIS.FSR_VISIT_CLO_DT
           ,VIS.FSR_VISIT_CLO_TM
           ,SUP.SVC_SUPPL_FROM_DT
           ,SUP.SVC_SUPPL_FROM_TM
           ,SUP.SVC_SUPPL_TO_DT
           ,SUP.SVC_SUPPL_TO_TM
           ,EVE.SVC_LBOR_CMNT_TXT                      AS RSN_NOT_CPLT_TXT
           ,NVL(V_AOT.FSR_TOT_TRVL_AOT, 0)             AS SVC_TRVL_AOT
           ,NVL(V_AOT.FSR_TOT_LBOR_AOT, 0)             AS SVC_LBOR_AOT
           ,NVL(I_AOT.SVC_ITRPT_AOT, 0)                AS SVC_ITRPT_AOT
           ,NVL(I_AOT.SVC_ITRPT_TRVL_AOT, 0)           AS SVC_ITRPT_TRVL_AOT
           ,NVL(I_AOT.SVC_ITRPT_MEAL_AOT, 0)           AS SVC_ITRPT_MEAL_AOT
           ,NVL(V_AOT.FSR_TOT_LBOR_AOT, 0) + NVL(V_AOT.FSR_TOT_TRVL_AOT, 0) + NVL(I_AOT.SVC_ITRPT_AOT, 0) + NVL(I_AOT.SVC_ITRPT_TRVL_AOT, 0) AS SVC_TOT_AOT
           ,NVL(CST.RPT_COND_CONST_VAL_NUM_02, 0)      AS SVC_AVG_TRVL_AOT
           ,NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0)      AS SVC_LBOR_COST_UNIT_AMT
           ,TRUNC(NVL(V_AOT.FSR_TOT_TRVL_AOT, 0)/(#timeAdj# * #timeAdj#), #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0) AS SVC_TRVL_COST_AMT
           ,TRUNC(NVL(V_AOT.FSR_TOT_LBOR_AOT, 0)/(#timeAdj# * #timeAdj#), #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0) AS SVC_LBOR_COST_AMT
           ,TRUNC(NVL(I_AOT.SVC_ITRPT_AOT,    0)/(#timeAdj# * #timeAdj#), #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0) AS SVC_ITRPT_COST_AMT
           ,NVL(U_AOT.FSR_TOT_PRT_COST_AMT, 0)         AS SVC_PRT_COST_AMT
           ,(TRUNC(NVL(V_AOT.FSR_TOT_TRVL_AOT, 0)/(#timeAdj# * #timeAdj#), #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0))
           +(TRUNC(NVL(V_AOT.FSR_TOT_LBOR_AOT, 0)/(#timeAdj# * #timeAdj#), #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0))
           +(TRUNC(NVL(I_AOT.SVC_ITRPT_AOT,    0)/(#timeAdj# * #timeAdj#), #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0))
           + NVL(U_AOT.FSR_TOT_PRT_COST_AMT,   0)      AS SVC_TOT_COST_AMT
           ,VIS.FSR_VISIT_ETA_DT
           ,VIS.FSR_VISIT_ETA_TM
           ,NVL(MDL_1.MTR_GRP_PK, MDL_2.MTR_GRP_PK)    AS MTR_GRP_PK
           ,M_CNT.TOT_READ_MTR_CNT
           ,M_CNT.BW_READ_MTR_CNT
           ,M_CNT.COLOR_READ_MTR_CNT
           ,M_CNT.MTR_READ_DT
           ,NVL(M_CMNT.TL_CMNT, NVL(M_CMNT.BW_CMNT, M_CMNT.CL_CMNT)) AS MTR_READ_EX_RSN_TXT
        FROM
            FSR_VISIT               VIS
           ,FSR                     FSR
           ,FSR_VISIT_TASK          FVT
           ,SVC_TASK                TSK
           ,SVC_MACH_MSTR           MAC
           ,SHIP_TO_CUST            SHP
           ,TECH_MSTR               TEC
           ,SELL_TO_CUST            ACC
           ,RPT_COND_CONST          CST
           ,DS_SVC_CALL_TP          DSCT
           ,DS_ACCT_GRP_ASG         DAGA
           ,DS_ACCT_GRP             DAG
           ,(
               SELECT
                   FVT.FSR_NUM
                  ,FVT.SVC_TASK_NUM
                  ,FVT.FSR_VISIT_NUM
                  ,TSK.DS_SVC_CALL_TP_CD
               FROM
                   FSR_VISIT                   VIS
                  ,FSR_VISIT_TASK              FVT
                  ,SVC_TASK                    TSK
               WHERE
                   VIS.GLBL_CMPY_CD            = #glblCmpyCd#
               AND VIS.GLBL_CMPY_CD            = FVT.GLBL_CMPY_CD
               AND VIS.FSR_NUM                 = FVT.FSR_NUM
               AND VIS.FSR_VISIT_NUM           = FVT.FSR_VISIT_NUM
               AND FVT.GLBL_CMPY_CD            = TSK.GLBL_CMPY_CD
               AND FVT.FSR_NUM                 = TSK.FSR_NUM
               AND FVT.SVC_TASK_NUM            = TSK.SVC_TASK_NUM
               AND VIS.EZCANCELFLAG            = '0'
               AND FVT.EZCANCELFLAG            = '0'
               AND TSK.EZCANCELFLAG            = '0'
           ) NEX
           ,(
               SELECT
                   EVE.FSR_NUM
                  ,EVE.SVC_TASK_NUM
                  ,EVE.FSR_VISIT_NUM
                  ,EVE.SVC_LBOR_CMNT_TXT
               FROM
                   FSR_VISIT_TM_EVENT          EVE
                 ,(
                   SELECT
                       EVE.GLBL_CMPY_CD
                      ,EVE.FSR_NUM
                      ,EVE.SVC_TASK_NUM
                      ,EVE.FSR_VISIT_NUM
                      ,MIN(EVE.FSR_VISIT_TM_EVENT_PK) AS FSR_VISIT_TM_EVENT_PK
                   FROM
                       FSR_VISIT_TM_EVENT          EVE
                   WHERE
                       EVE.GLBL_CMPY_CD            = #glblCmpyCd#
                   AND EVE.EZCANCELFLAG            = '0'
                   GROUP BY
                       EVE.GLBL_CMPY_CD
                      ,EVE.FSR_NUM
                      ,EVE.SVC_TASK_NUM
                      ,EVE.FSR_VISIT_NUM
                   ) EVE_MIN
               WHERE
                   EVE.GLBL_CMPY_CD          = #glblCmpyCd#
               AND EVE.GLBL_CMPY_CD          = EVE_MIN.GLBL_CMPY_CD
               AND EVE.FSR_NUM               = EVE_MIN.FSR_NUM
               AND EVE.SVC_TASK_NUM          = EVE_MIN.SVC_TASK_NUM
               AND EVE.FSR_VISIT_NUM         = EVE_MIN.FSR_VISIT_NUM
               AND EVE.FSR_VISIT_TM_EVENT_PK = EVE_MIN.FSR_VISIT_TM_EVENT_PK
           ) EVE
           ,(
               SELECT 
                   FSR.FSR_NUM
                  ,MDL.MDL_ID
                  ,MDL.RCLL_INTVL_DAYS_AOT
                  ,MDL.RCLL_COPY_VOL_CNT
                  ,MDL.RCLL_GLBL_INTVL_DAYS_AOT
                  ,MDL.RCLL_GLBL_COPY_VOL_CNT
                  ,MDL.MTR_GRP_PK
                  ,MDL.RSP_TM_UP_MN_AOT
               FROM
                   FSR                         FSR
                  ,SVC_MACH_MSTR               MAC
                  ,SVC_CONFIG_MSTR             CON
                  ,DS_MDL                      MDL
               WHERE
                   FSR.GLBL_CMPY_CD            = #glblCmpyCd#
               AND FSR.GLBL_CMPY_CD            = MAC.GLBL_CMPY_CD
               AND FSR.SVC_MACH_MSTR_PK        = MAC.SVC_MACH_MSTR_PK
               AND MAC.GLBL_CMPY_CD            = CON.GLBL_CMPY_CD
               AND MAC.SVC_CONFIG_MSTR_PK      = CON.SVC_CONFIG_MSTR_PK
               AND CON.GLBL_CMPY_CD            = MDL.GLBL_CMPY_CD
               AND CON.MDL_ID                  = MDL.MDL_ID
               AND FSR.EZCANCELFLAG            = '0'
               AND MAC.EZCANCELFLAG            = '0'
               AND CON.EZCANCELFLAG            = '0'
               AND MDL.EZCANCELFLAG            = '0'
           ) MDL_1
           ,(
               SELECT 
                   FSR_NUM
                  ,MDL_ID
                  ,RCLL_INTVL_DAYS_AOT
                  ,RCLL_COPY_VOL_CNT
                  ,RCLL_GLBL_INTVL_DAYS_AOT
                  ,RCLL_GLBL_COPY_VOL_CNT
                  ,MTR_GRP_PK
                  ,RSP_TM_UP_MN_AOT
               FROM
                   (
                   SELECT
                       FSR.FSR_NUM
                      ,SVC_CONFIG_MSTR_DTL_PK
                      ,ROW_NUMBER() OVER(PARTITION BY FSR_NUM ORDER BY SVC_CONFIG_MSTR_DTL_PK DESC) ROW_NUM
                      ,MDL.MDL_ID
                      ,MDL.RCLL_INTVL_DAYS_AOT
                      ,MDL.RCLL_COPY_VOL_CNT
                      ,MDL.RCLL_GLBL_INTVL_DAYS_AOT
                      ,MDL.RCLL_GLBL_COPY_VOL_CNT
                      ,MDL.MTR_GRP_PK
                      ,MDL.RSP_TM_UP_MN_AOT
                   FROM
                       FSR                         FSR
                      ,SVC_CONFIG_MSTR_DTL         CON
                      ,DS_MDL                      MDL
                   WHERE
                       FSR.GLBL_CMPY_CD            = #glblCmpyCd#
                   AND FSR.GLBL_CMPY_CD            = CON.GLBL_CMPY_CD
                   AND FSR.SVC_MACH_MSTR_PK        = CON.SVC_MACH_MSTR_PK
                   AND CON.GLBL_CMPY_CD            = MDL.GLBL_CMPY_CD
                   AND CON.MDL_ID                  = MDL.MDL_ID
                   AND FSR.EZCANCELFLAG            = '0'
                   AND CON.EZCANCELFLAG            = '0'
                   AND MDL.EZCANCELFLAG            = '0'
                   )
               WHERE ROW_NUM = 1
           ) MDL_2
           ,(
               SELECT
                   FSR_NUM
                  ,FSR_VISIT_NUM
                  ,MTR_READ_DT
                  ,SUM(BW_CNT)                                                                   AS BW_READ_MTR_CNT
                  ,SUM(CL_CNT)                                                                   AS COLOR_READ_MTR_CNT
                  ,CASE WHEN SUM(TL_CNT) = 0 THEN SUM(BW_CNT) + SUM(CL_CNT) ELSE SUM(TL_CNT) END AS TOT_READ_MTR_CNT
               FROM
                   (
                   SELECT DISTINCT
                       MTR.FSR_NUM
                      ,MTR.FSR_VISIT_NUM
                      ,MTR.MTR_READ_DT
                      ,CASE WHEN LB.BW_MTR_FLG    = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS BW_CNT
                      ,CASE WHEN LB.COLOR_MTR_FLG = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS CL_CNT
                      ,CASE WHEN LB.TOT_MTR_FLG   = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS TL_CNT
                   FROM
                       FSR                       FSR
                      ,SVC_PHYS_MTR_READ         MTR
                      ,MTR_LB                    LB
                   WHERE
                       FSR.GLBL_CMPY_CD          = #glblCmpyCd#
                   AND FSR.GLBL_CMPY_CD          = MTR.GLBL_CMPY_CD
                   AND FSR.FSR_NUM               = MTR.FSR_NUM
                   AND FSR.SVC_MACH_MSTR_PK      = MTR.SVC_MACH_MSTR_PK
                   AND MTR.TEST_MTR_CNT          = 0
                   AND MTR.GLBL_CMPY_CD          = LB.GLBL_CMPY_CD
                   AND MTR.MTR_LB_CD             = LB.MTR_LB_CD
                   <!-- START QC#28592 2018/10/11 [ADD]-->
                   AND MTR.VLD_MTR_FLG           = 'Y'
                   <!-- END   QC#28592 2018/10/11 [ADD]-->
                   AND FSR.EZCANCELFLAG          = '0'
                   AND MTR.EZCANCELFLAG          = '0'
                   AND LB.EZCANCELFLAG           = '0'
                   )
               GROUP BY FSR_NUM ,FSR_VISIT_NUM, MTR_READ_DT
           ) M_CNT
           ,(
               SELECT
                   FSR_NUM
                  ,FSR_VISIT_NUM
                  ,MAX(BW_CMNT)    AS BW_CMNT
                  ,MAX(CL_CMNT)    AS CL_CMNT
                  ,MAX(TL_CMNT)    AS TL_CMNT
               FROM
                   (
                   SELECT DISTINCT
                       MTR.FSR_NUM
                      ,MTR.FSR_VISIT_NUM
                      ,CASE WHEN LB.BW_MTR_FLG    = 'Y' THEN MTR_ENTRY_CMNT_TXT ELSE NULL END AS BW_CMNT
                      ,CASE WHEN LB.COLOR_MTR_FLG = 'Y' THEN MTR_ENTRY_CMNT_TXT ELSE NULL END AS CL_CMNT
                      ,CASE WHEN LB.TOT_MTR_FLG   = 'Y' THEN MTR_ENTRY_CMNT_TXT ELSE NULL END AS TL_CMNT
                   FROM
                       FSR                       FSR
                      ,SVC_PHYS_MTR_READ         MTR
                      ,MTR_LB                    LB
                   WHERE
                       FSR.GLBL_CMPY_CD          = #glblCmpyCd#
                   AND FSR.GLBL_CMPY_CD          = MTR.GLBL_CMPY_CD
                   AND FSR.FSR_NUM               = MTR.FSR_NUM
                   AND FSR.SVC_MACH_MSTR_PK      = MTR.SVC_MACH_MSTR_PK
                   AND MTR.TEST_MTR_CNT          = 0
                   AND MTR.GLBL_CMPY_CD          = LB.GLBL_CMPY_CD
                   AND MTR.MTR_LB_CD             = LB.MTR_LB_CD
                   <!-- START QC#28592 2018/10/11 [ADD]-->
                   AND MTR.VLD_MTR_FLG           = 'Y'
                   <!-- END   QC#28592 2018/10/11 [ADD]-->
                   AND FSR.EZCANCELFLAG          = '0'
                   AND MTR.EZCANCELFLAG          = '0'
                   AND LB.EZCANCELFLAG           = '0'
                   )
               GROUP BY FSR_NUM, FSR_VISIT_NUM
           ) M_CMNT
           ,(
               SELECT
                   FSR_NUM
                  ,SVC_TASK_NUM
                  ,FSR_VISIT_NUM
                  ,SUM(LA_AOT)           AS FSR_TOT_LBOR_AOT
                  ,SUM(TR_AOT)           AS FSR_TOT_TRVL_AOT
               FROM
                   (
                   SELECT
                       EVE.FSR_NUM
                      ,EVE.SVC_TASK_NUM
                      ,EVE.FSR_VISIT_NUM
                      ,EVE.SVC_TM_EVENT_CD
                      ,CASE WHEN EVE.SVC_TM_EVENT_CD = #labor#  THEN SUM(ROUND((TO_DATE(SVC_TM_EVENT_TO_DT || SVC_TM_EVENT_TO_TM,'YYYYMMDDHH24MISS') - TO_DATE(SVC_TM_EVENT_FROM_DT || SVC_TM_EVENT_FROM_TM,'YYYYMMDDHH24MISS')) * 24 * 60)) END AS LA_AOT
                      ,CASE WHEN EVE.SVC_TM_EVENT_CD = #travel# THEN SUM(ROUND((TO_DATE(SVC_TM_EVENT_TO_DT || SVC_TM_EVENT_TO_TM,'YYYYMMDDHH24MISS') - TO_DATE(SVC_TM_EVENT_FROM_DT || SVC_TM_EVENT_FROM_TM,'YYYYMMDDHH24MISS')) * 24 * 60)) END AS TR_AOT
                   FROM
                       FSR_VISIT             VIS
                      ,FSR_VISIT_TASK        FVT
                      ,FSR_VISIT_TM_EVENT    EVE
                   WHERE
                       VIS.GLBL_CMPY_CD      = #glblCmpyCd#
                   AND VIS.GLBL_CMPY_CD      = FVT.GLBL_CMPY_CD
                   AND VIS.FSR_NUM           = FVT.FSR_NUM
                   AND VIS.FSR_VISIT_NUM     = FVT.FSR_VISIT_NUM
                   AND FVT.GLBL_CMPY_CD      = EVE.GLBL_CMPY_CD
                   AND FVT.FSR_NUM           = EVE.FSR_NUM
                   AND FVT.SVC_TASK_NUM      = EVE.SVC_TASK_NUM
                   AND FVT.FSR_VISIT_NUM     = EVE.FSR_VISIT_NUM
                   AND EVE.SVC_TM_EVENT_CD   IN (#labor#, #travel#)
                   AND VIS.EZCANCELFLAG      = '0'
                   AND FVT.EZCANCELFLAG      = '0'
                   AND EVE.EZCANCELFLAG      = '0'
                   GROUP BY EVE.FSR_NUM, EVE.SVC_TASK_NUM, EVE.FSR_VISIT_NUM, EVE.SVC_TM_EVENT_CD
                   )
               GROUP BY FSR_NUM, SVC_TASK_NUM, FSR_VISIT_NUM
           ) V_AOT
           ,(
               SELECT
                   FSR_NUM
                  ,SVC_TASK_NUM
                  ,FSR_VISIT_NUM
                  ,SUM(NVL(FSR_TOT_PRT_COST_AMT, 0)) AS FSR_TOT_PRT_COST_AMT
               FROM (
                      SELECT
                          USG.FSR_NUM
                         ,USG.SVC_TASK_NUM
                         ,USG.FSR_VISIT_NUM
                         ,USG.MDSE_CD
                         ,NVL(USG.SVC_PRT_QTY, 0) * NVL(MDS.THIS_MTH_TOT_STD_COST_AMT, 0) AS FSR_TOT_PRT_COST_AMT
                      FROM
                          FSR_USG               USG
                         ,MDSE                  MDS
                      WHERE
                          USG.GLBL_CMPY_CD      = #glblCmpyCd#
                      AND USG.GLBL_CMPY_CD      = MDS.GLBL_CMPY_CD
                      AND USG.MDSE_CD           = MDS.MDSE_CD
                      AND USG.EZCANCELFLAG      = '0'
                      AND MDS.EZCANCELFLAG      = '0'
               )
               GROUP BY FSR_NUM, SVC_TASK_NUM, FSR_VISIT_NUM
           ) U_AOT
           ,(
               SELECT
                   SUP.FSR_NUM
                  ,SUP.SVC_TASK_NUM
                  ,SUP.SVC_SUPPL_TASK_NUM
                  ,SUP.SVC_SUPPL_TASK_TP_CD
                  ,SUP.SVC_SUPPL_FROM_DT
                  ,SUP.SVC_SUPPL_FROM_TM
                  ,SUP.SVC_SUPPL_TO_DT
                  ,SUP.SVC_SUPPL_TO_TM
               FROM
                   SVC_SUPPL_TASK            SUP
                 ,(
                   SELECT
                       SUP.GLBL_CMPY_CD
                      ,SUP.FSR_NUM
                      ,SUP.SVC_TASK_NUM
                      ,MIN(SUP.SVC_SUPPL_TASK_NUM) AS SVC_SUPPL_TASK_NUM
                   FROM
                       SVC_SUPPL_TASK            SUP
                   WHERE
                       SUP.GLBL_CMPY_CD          = #glblCmpyCd#
                   AND SUP.EZCANCELFLAG          = '0'
                   GROUP BY
                       SUP.GLBL_CMPY_CD
                      ,SUP.FSR_NUM
                      ,SUP.SVC_TASK_NUM
                  ) SUP_MIN
               WHERE
                   SUP.GLBL_CMPY_CD          = #glblCmpyCd#
               AND SUP.EZCANCELFLAG          = '0'
               AND SUP.GLBL_CMPY_CD          = SUP_MIN.GLBL_CMPY_CD
               AND SUP.FSR_NUM               = SUP_MIN.FSR_NUM
               AND SUP.SVC_TASK_NUM          = SUP_MIN.SVC_TASK_NUM
               AND SUP.SVC_SUPPL_TASK_NUM    = SUP_MIN.SVC_SUPPL_TASK_NUM
           ) SUP
           ,(
               SELECT
                   SUP.FSR_NUM
                  ,SUP.SVC_TASK_NUM
                  ,SUM(NVL(CASE WHEN SUP.SVC_SUPPL_TASK_TP_CD != #meal2# THEN SUP.SVC_TRVL_TM_NUM ELSE 0 END, 0)) AS SVC_ITRPT_TRVL_AOT
                  ,SUM(NVL(CASE WHEN SUP.SVC_SUPPL_TASK_TP_CD != #meal2# THEN SUP.SVC_SUPPL_TM_NUM ELSE 0 END, 0)) AS SVC_ITRPT_AOT
                  ,SUM(NVL(CASE WHEN SUP.SVC_SUPPL_TASK_TP_CD  = #meal2# THEN SUP.SVC_SUPPL_TM_NUM ELSE 0 END, 0)) AS SVC_ITRPT_MEAL_AOT
               FROM
                   SVC_SUPPL_TASK            SUP
                  ,SVC_SUPPL_TASK_TP         STP
               WHERE
                   SUP.GLBL_CMPY_CD          = #glblCmpyCd#
               AND SUP.GLBL_CMPY_CD          = STP.GLBL_CMPY_CD
               AND SUP.SVC_SUPPL_TASK_TP_CD  = STP.SVC_SUPPL_TASK_TP_CD
               AND STP.SVC_ITRPT_FLG         = 'Y'
               AND SUP.EZCANCELFLAG          = '0'
               AND STP.EZCANCELFLAG          = '0'
               GROUP BY SUP.FSR_NUM, SUP.SVC_TASK_NUM
           ) I_AOT
           ,(
               SELECT DISTINCT
                   ST.SVC_TASK_NUM
               FROM
                   SVC_TASK                 ST
                  ,SVC_TSS_ESCL             STE
               WHERE
                   ST.GLBL_CMPY_CD          = #glblCmpyCd#
               AND ST.GLBL_CMPY_CD          = STE.GLBL_CMPY_CD
               AND ST.SVC_TASK_NUM          = STE.SVC_TASK_NUM
               AND ST.EZCANCELFLAG          = '0'
               AND STE.EZCANCELFLAG         = '0'
               GROUP BY ST.SVC_TASK_NUM
           ) STE
           ,(
               SELECT
                   EVE.FSR_NUM
                  ,EVE.FSR_VISIT_NUM
                  ,EVE.SVC_TASK_NUM
                  ,COUNT(EVE.FSR_VISIT_NUM)  AS MOD_EVENT_CNT
               FROM
                   FSR_VISIT             VIS
                  ,FSR_VISIT_TASK        FVT
                  ,FSR_VISIT_TM_EVENT    EVE
               WHERE
                   VIS.GLBL_CMPY_CD      = #glblCmpyCd#
               AND VIS.GLBL_CMPY_CD      = FVT.GLBL_CMPY_CD
               AND VIS.FSR_NUM           = FVT.FSR_NUM
               AND VIS.FSR_VISIT_NUM     = FVT.FSR_VISIT_NUM
               AND FVT.GLBL_CMPY_CD      = EVE.GLBL_CMPY_CD
               AND FVT.FSR_NUM           = EVE.FSR_NUM
               AND FVT.SVC_TASK_NUM      = EVE.SVC_TASK_NUM
               AND FVT.FSR_VISIT_NUM     = EVE.FSR_VISIT_NUM
               AND EVE.SVC_TM_EVENT_CD   = #modification#
               AND VIS.EZCANCELFLAG      = '0'
               AND FVT.EZCANCELFLAG      = '0'
               AND EVE.EZCANCELFLAG      = '0'
               GROUP BY EVE.FSR_NUM, EVE.SVC_TASK_NUM, EVE.FSR_VISIT_NUM
           ) FVTE
        WHERE
            VIS.GLBL_CMPY_CD                          = #glblCmpyCd#
        AND SUBSTR(VIS.FSR_VISIT_ARV_DT, 0, #ymLen#)  = #trgtYrMth#
        AND VIS.GLBL_CMPY_CD                          = FSR.GLBL_CMPY_CD
        AND VIS.FSR_NUM                               = FSR.FSR_NUM
        AND VIS.GLBL_CMPY_CD                          = FVT.GLBL_CMPY_CD
        AND VIS.FSR_NUM                               = FVT.FSR_NUM
        AND VIS.FSR_VISIT_NUM                         = FVT.FSR_VISIT_NUM
        AND VIS.FSR_NUM                               = NEX.FSR_NUM(+)
        AND VIS.NEXT_FSR_VISIT_NUM                    = NEX.FSR_VISIT_NUM(+)
        AND FVT.GLBL_CMPY_CD                          = TSK.GLBL_CMPY_CD
        AND FVT.FSR_NUM                               = TSK.FSR_NUM
        AND TSK.GLBL_CMPY_CD                          = DSCT.GLBL_CMPY_CD(+)
        AND TSK.DS_SVC_CALL_TP_CD                     = DSCT.DS_SVC_CALL_TP_CD(+)
        AND FVT.SVC_TASK_NUM                          = TSK.SVC_TASK_NUM
        AND FSR.GLBL_CMPY_CD                          = MAC.GLBL_CMPY_CD
        AND FSR.SVC_MACH_MSTR_PK                      = MAC.SVC_MACH_MSTR_PK
        AND MAC.GLBL_CMPY_CD                          = SHP.GLBL_CMPY_CD
        AND MAC.CUR_LOC_NUM                           = SHP.SHIP_TO_CUST_CD
        AND MAC.GLBL_CMPY_CD                          = TEC.GLBL_CMPY_CD(+)
        AND VIS.TECH_CD                               = TEC.TECH_TOC_CD(+)
        AND MAC.GLBL_CMPY_CD                          = ACC.GLBL_CMPY_CD(+)
        AND MAC.CUR_LOC_ACCT_NUM                      = ACC.SELL_TO_CUST_CD(+)
        AND MAC.GLBL_CMPY_CD                          = DAGA.GLBL_CMPY_CD(+)
        AND MAC.CUR_LOC_ACCT_NUM                      = DAGA.DS_ACCT_NUM(+)
        AND DAGA.GLBL_CMPY_CD                         = DAG.GLBL_CMPY_CD(+)
        AND DAGA.DS_ACCT_GRP_CD                       = DAG.DS_ACCT_GRP_CD(+)
        AND MAC.GLBL_CMPY_CD                          = CST.GLBL_CMPY_CD(+)
        AND MAC.SVC_BY_LINE_BIZ_TP_CD                 = CST.RPT_COND_CONST_CD(+)
        AND CST.RPT_COND_CONST_GRP_ID(+)              = #laborRate#
        AND FSR.FSR_NUM                               = MDL_1.FSR_NUM(+)
        AND FSR.FSR_NUM                               = MDL_2.FSR_NUM(+)
        AND FVT.FSR_NUM                               = M_CNT.FSR_NUM(+)
        AND FVT.FSR_VISIT_NUM                         = M_CNT.FSR_VISIT_NUM(+)
        AND FVT.FSR_NUM                               = M_CMNT.FSR_NUM(+)
        AND FVT.FSR_VISIT_NUM                         = M_CMNT.FSR_VISIT_NUM(+)
        AND FVT.FSR_NUM                               = EVE.FSR_NUM(+)
        AND FVT.SVC_TASK_NUM                          = EVE.SVC_TASK_NUM(+)
        AND FVT.FSR_VISIT_NUM                         = EVE.FSR_VISIT_NUM(+)
        AND FVT.FSR_NUM                               = U_AOT.FSR_NUM(+)
        AND FVT.SVC_TASK_NUM                          = U_AOT.SVC_TASK_NUM(+)
        AND FVT.FSR_VISIT_NUM                         = U_AOT.FSR_VISIT_NUM(+)
        AND FVT.FSR_NUM                               = V_AOT.FSR_NUM(+)
        AND FVT.SVC_TASK_NUM                          = V_AOT.SVC_TASK_NUM(+)
        AND FVT.FSR_VISIT_NUM                         = V_AOT.FSR_VISIT_NUM(+)
        AND FVT.FSR_NUM                               = U_AOT.FSR_NUM(+)
        AND FVT.SVC_TASK_NUM                          = U_AOT.SVC_TASK_NUM(+)
        AND FVT.FSR_VISIT_NUM                         = U_AOT.FSR_VISIT_NUM(+)
        AND FVT.FSR_NUM                               = SUP.FSR_NUM(+)
        AND FVT.SVC_TASK_NUM                          = SUP.SVC_TASK_NUM(+)
        AND FVT.FSR_NUM                               = I_AOT.FSR_NUM(+)
        AND FVT.SVC_TASK_NUM                          = I_AOT.SVC_TASK_NUM(+)
        AND TSK.SVC_TASK_NUM                          = STE.SVC_TASK_NUM(+)
        AND FVT.FSR_NUM                               = FVTE.FSR_NUM(+)
        AND FVT.SVC_TASK_NUM                          = FVTE.SVC_TASK_NUM(+)
        AND FVT.FSR_VISIT_NUM                         = FVTE.FSR_VISIT_NUM(+)
        AND VIS.EZCANCELFLAG                          = '0'
        AND FSR.EZCANCELFLAG                          = '0'
        AND TSK.EZCANCELFLAG                          = '0'
        AND MAC.EZCANCELFLAG                          = '0'
        AND SHP.EZCANCELFLAG                          = '0'
        AND TEC.EZCANCELFLAG(+)                       = '0'
        AND ACC.EZCANCELFLAG(+)                       = '0'
        AND CST.EZCANCELFLAG(+)                       = '0'
        AND DSCT.EZCANCELFLAG(+)                      = '0'
        AND DAGA.EZCANCELFLAG(+)                      = '0'
        AND DAG.EZCANCELFLAG(+)                       = '0'
        --------------------------------------------------------------------------------------------
        -- Supplemental Data (No FSR_NUM and TASK_NUM)
        UNION ALL
        SELECT
            NULL                                       AS FSR_NUM
           ,NULL                                       AS FSR_TP_CD
           ,NULL                                       AS FSR_CRAT_DT
           ,NULL                                       AS FSR_CRAT_TM
           ,NULL                                       AS FSR_CPLT_DT
           ,NULL                                       AS FSR_CPLT_TM
           ,NULL                                       AS SVC_TASK_NUM
           ,NULL                                       AS SVC_TASK_STS_CD
           ,NULL                                       AS DS_SVC_CALL_TP_CD
           ,'N'                                        AS PHO_FIX_FLG
           ,NULL                                       AS ERL_START_TS
           ,NULL                                       AS FSR_VISIT_NUM
           ,NULL                                       AS PREV_FSR_VISIT_NUM
           ,NULL                                       AS NEXT_FSR_VISIT_NUM
           ,NULL                                       AS NEXT_VISIT_SVC_CALL_TP_CD
           ,SUP.SVC_SUPPL_TASK_NUM
           ,SUP.SVC_SUPPL_TASK_TP_CD
           ,SUP.TECH_CD
           ,TEC.FLD_SVC_MGR_CD
           ,'N'                                        AS FIRST_VISIT_FLG
           ,'N'                                        AS FIRST_VISIT_CPLT_FLG
           ,'N'                                        AS TSS_FOLL_UP_FLG
           ,0                                          AS MOD_EVENT_CNT
           ,NULL                                       AS SVC_CONFIG_MSTR_PK
           ,NULL                                       AS MDL_ID
           ,0                                          AS RCLL_INTVL_DAYS_AOT
           ,0                                          AS RCLL_COPY_VOL_CNT
           ,0                                          AS RCLL_GLBL_INTVL_DAYS_AOT
           ,0                                          AS RCLL_GLBL_COPY_VOL_CNT
           ,NULL                                       AS SVC_MACH_MSTR_PK
           ,NULL                                       AS SER_NUM
           ,NULL                                       AS MDSE_CD
           ,NULL                                       AS CUR_LOC_ACCT_NUM
           ,NULL                                       AS CUR_LOC_ACCT_NM
           ,NULL                                       AS DS_ACCT_GRP_CD
           ,NULL                                       AS DS_ACCT_GRP_NM
           ,NULL                                       AS CUR_LOC_NUM
           ,NULL                                       AS IND_CUR_LOC_NUM
           ,'N'                                        AS DS_KEY_ACCT_FLG
           ,NULL                                       AS FIRST_LINE_ADDR
           ,NULL                                       AS SCD_LINE_ADDR
           ,NULL                                       AS THIRD_LINE_ADDR
           ,NULL                                       AS FRTH_LINE_ADDR
           ,NULL                                       AS CTY_ADDR
           ,NULL                                       AS CNTY_PK
           ,NULL                                       AS PROV_NM
           ,NULL                                       AS ST_CD
           ,NULL                                       AS POST_CD
           ,NULL                                       AS CTRY_CD
           ,NULL                                       AS TECH_SCHD_FROM_DT
           ,NULL                                       AS TECH_SCHD_FROM_TM
           ,NULL                                       AS TECH_SCHD_TO_DT
           ,NULL                                       AS TECH_SCHD_TO_TM
           ,NULL                                       AS TECH_SCHD_TZ
           ,NULL                                       AS FSR_VISIT_SCHD_DT
           ,NULL                                       AS FSR_VISIT_SCHD_TM
           ,NULL                                       AS FSR_VISIT_DISPT_DT
           ,NULL                                       AS FSR_VISIT_DISPT_TM
           ,NULL                                       AS SVC_ASG_TP_CD
           ,'N'                                        AS TECH_ACPT_FLG
           ,NULL                                       AS TECH_ACPT_DT
           ,NULL                                       AS TECH_ACPT_TM
           ,NULL                                       AS FSR_VISIT_ARV_DT
           ,NULL                                       AS FSR_VISIT_ARV_TM
           ,NULL                                       AS FSR_VISIT_CPLT_DT
           ,NULL                                       AS FSR_VISIT_CPLT_TM
           ,NULL                                       AS FSR_VISIT_CLO_DT
           ,NULL                                       AS FSR_VISIT_CLO_TM
           ,SUP.SVC_SUPPL_FROM_DT
           ,SUP.SVC_SUPPL_FROM_TM
           ,SUP.SVC_SUPPL_TO_DT
           ,SUP.SVC_SUPPL_TO_TM
           ,NULL                                       AS RSN_NOT_CPLT_TXT
           ,0                                          AS SVC_TRVL_AOT
           ,0                                          AS SVC_LBOR_AOT
           ,NVL(SUP.SVC_SUPPL_TM_NUM, 0) * #timeAdj#   AS SVC_ITRPT_AOT
           ,NVL(SUP.SVC_TRVL_TM_NUM,  0) * #timeAdj#   AS SVC_ITRPT_TRVL_AOT
           ,0                                          AS SVC_ITRPT_MEAL_AOT
           ,(NVL(SUP.SVC_SUPPL_TM_NUM,  0) * #timeAdj#) + (NVL(SUP.SVC_TRVL_TM_NUM,  0) * #timeAdj#) AS SVC_TOT_AOT
           ,NVL(CST.RPT_COND_CONST_VAL_NUM_02, 0)      AS SVC_AVG_TRVL_AOT
           ,NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0)      AS SVC_LBOR_COST_UNIT_AMT
           ,TRUNC(NVL(SUP.SVC_TRVL_TM_NUM,  0)/#timeAdj#, #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0)      AS SVC_TRVL_COST_AMT
           ,0                                          AS SVC_LBOR_COST_AMT
           ,TRUNC(NVL(SUP.SVC_SUPPL_TM_NUM, 0)/#timeAdj#, #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0)      AS SVC_ITRPT_COST_AMT
           ,0                                          AS SVC_PRT_COST_AMT
           ,(TRUNC(NVL(SUP.SVC_TRVL_TM_NUM,  0)/#timeAdj#, #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0))
           +(TRUNC(NVL(SUP.SVC_SUPPL_TM_NUM, 0)/#timeAdj#, #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0))    AS SVC_TOT_COST_AMT
           ,NULL                                       AS FSR_VISIT_ETA_DT
           ,NULL                                       AS FSR_VISIT_ETA_TM
           ,NULL                                       AS MTR_GRP_PK
           ,0                                          AS TOT_READ_MTR_CNT
           ,0                                          AS BW_READ_MTR_CNT
           ,0                                          AS COLOR_READ_MTR_CNT
           ,NULL                                       AS MTR_READ_DT
           ,NULL                                       AS MTR_READ_EX_RSN_TXT
        FROM
            SVC_SUPPL_TASK          SUP
           ,TECH_MSTR               TEC
           ,S21_PSN                 PSN
           ,RPT_COND_CONST          CST
        WHERE
            SUP.GLBL_CMPY_CD                          = #glblCmpyCd#
        AND SUBSTR(SUP.SVC_SUPPL_TO_DT, 0, #ymLen#)   = #trgtYrMth#
        AND SUP.FSR_NUM                               IS NULL
        AND SUP.GLBL_CMPY_CD                          = TEC.GLBL_CMPY_CD(+)
        AND SUP.TECH_CD                               = TEC.TECH_TOC_CD(+)
        AND SUP.GLBL_CMPY_CD                          = PSN.GLBL_CMPY_CD(+)
        AND SUP.TECH_CD                               = PSN.PSN_CD(+)
        AND PSN.GLBL_CMPY_CD                          = CST.GLBL_CMPY_CD(+)
        AND PSN.LINE_BIZ_TP_CD                        = CST.RPT_COND_CONST_CD(+)
        AND CST.RPT_COND_CONST_GRP_ID(+)              = #laborRate#
        AND SUP.EZCANCELFLAG                          = '0'
        AND TEC.EZCANCELFLAG(+)                       = '0'
        AND CST.EZCANCELFLAG(+)                       = '0'
    </statement>

</sqlMap>
