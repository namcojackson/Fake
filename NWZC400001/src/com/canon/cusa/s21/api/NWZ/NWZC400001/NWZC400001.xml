<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NWZC400001">

    <typeAlias alias="HLDTMsg" type="business.db.HLDTMsg"/>

    <statement id="getHldProcDfnList" parameterClass="Map">
        SELECT 
            HR.HLD_RSN_CD
          , HR.HLD_RSN_NM
          , HR.HLD_LVL_CD
          , HR.EX_REQ_FLG
        FROM
            HLD_RSN       HR
          , HLD_PROC_DFN  HPD
        WHERE
                HR.GLBL_CMPY_CD         = #glblCmpyCd#
            AND HR.EZCANCELFLAG         = '0'
            AND HPD.GLBL_CMPY_CD        = HR.GLBL_CMPY_CD
            AND HPD.HLD_RSN_CD          = HR.HLD_RSN_CD
            AND HPD.EZCANCELFLAG        = '0'
          <isEqual property="hldDfnChkPnt" compareValue="1">
            AND HPD.CHK_PNT_ORD_VLD_FLG = 'Y'
          </isEqual>
        GROUP BY
            HR.HLD_RSN_CD
          , HR.HLD_RSN_NM
          , HR.HLD_LVL_CD
          , HR.EX_REQ_FLG
        ORDER BY
            HR.HLD_LVL_CD
          , HR.HLD_RSN_CD
    </statement>


    <statement id="getApplyOrdTpList" parameterClass="Map" resultClass="String">
        SELECT
            HR.HLD_RSN_CD || '.' || HCOS.APPLY_ORD_SRC_TP_CD || '.' || HCOT.APPLY_ORD_TP_CD || '.' || HPD.WH_TP_CD
        FROM
            HLD_RSN          HR
          , HLD_PROC_DFN     HPD
          , HLD_CTRL_ORD_SRC HCOS
          , HLD_CTRL_ORD_TP  HCOT
          , DS_HLD_CTRL_ORD_TP  DHCOT
          
        WHERE
                HR.GLBL_CMPY_CD          = #glblCmpyCd#
            AND HR.EZCANCELFLAG          = '0'
            AND HPD.GLBL_CMPY_CD         = HR.GLBL_CMPY_CD
            AND HPD.HLD_RSN_CD           = HR.HLD_RSN_CD
            AND HPD.EZCANCELFLAG         = '0'
          <isEqual property="hldDfnChkPnt" compareValue="1">
            AND HPD.CHK_PNT_ORD_VLD_FLG  = 'Y'
          </isEqual>
            AND HCOS.GLBL_CMPY_CD        = HR.GLBL_CMPY_CD
            AND HCOS.HLD_RSN_CD          = HR.HLD_RSN_CD
            AND HCOS.EZCANCELFLAG        = '0'
            AND HCOT.GLBL_CMPY_CD        = HR.GLBL_CMPY_CD
            AND HCOT.HLD_RSN_CD          = HR.HLD_RSN_CD
            AND HCOT.EZCANCELFLAG        = '0'
            AND DHCOT.GLBL_CMPY_CD       = HR.GLBL_CMPY_CD
            AND DHCOT.HLD_RSN_CD         = HR.HLD_RSN_CD
            AND DHCOT.APPLY_DS_ORD_TP_CD = #applyDsOrdTpCd#
            AND DHCOT.EZCANCELFLAG       = '0'
        GROUP BY
            HR.HLD_RSN_CD || '.' || HCOS.APPLY_ORD_SRC_TP_CD || '.' || HCOT.APPLY_ORD_TP_CD || '.' || HPD.WH_TP_CD
        ORDER BY
            HR.HLD_RSN_CD || '.' || HCOS.APPLY_ORD_SRC_TP_CD || '.' || HCOT.APPLY_ORD_TP_CD || '.' || HPD.WH_TP_CD
    </statement>

    <statement id="getHldCtrlOrgList" parameterClass="Map" resultClass="Map">
        SELECT 
            HLD_RSN_CD
          , FIRST_ORG_CD
          , SCD_ORG_CD
          , THIRD_ORG_CD
          , FRTH_ORG_CD
          , FIFTH_ORG_CD
          , SIXTH_ORG_CD
          , SVNTH_ORG_CD
          , EIGHTH_ORG_CD
          , TOC_CD 
        FROM
          HLD_CTRL_ORG
        WHERE
              GLBL_CMPY_CD = #glblCmpyCd#
          AND EZCANCELFLAG = '0'
        GROUP BY
            HLD_RSN_CD
          , FIRST_ORG_CD
          , SCD_ORG_CD
          , THIRD_ORG_CD
          , FRTH_ORG_CD
          , FIFTH_ORG_CD
          , SIXTH_ORG_CD
          , SVNTH_ORG_CD
          , EIGHTH_ORG_CD
          , TOC_CD
        ORDER BY
          HLD_RSN_CD
        , TOC_CD        NULLS LAST
        , EIGHTH_ORG_CD NULLS LAST
        , SVNTH_ORG_CD  NULLS LAST
        , SIXTH_ORG_CD  NULLS LAST
        , FIFTH_ORG_CD  NULLS LAST
        , FRTH_ORG_CD   NULLS LAST
        , THIRD_ORG_CD  NULLS LAST
        , SCD_ORG_CD    NULLS LAST
        , FIRST_ORG_CD  NULLS LAST
    </statement>

    <statement id="getHldOrderList" parameterClass="Map" resultClass="String">
        SELECT
          CASE HR.HLD_LVL_CD
            WHEN #hldLvl.cpo#     THEN HR.HLD_LVL_CD || '.' || H.CPO_ORD_NUM
            WHEN #hldLvl.cpoDtl#  THEN HR.HLD_LVL_CD || '.' || H.CPO_ORD_NUM || '.' || H.CPO_DTL_LINE_NUM || '.' || H.CPO_DTL_LINE_SUB_NUM
          END HLD_ORD
        FROM
              HLD     H
            , HLD_RSN HR
        WHERE
                H.GLBL_CMPY_CD  = #glblCmpyCd#
            AND H.CPO_ORD_NUM   = #cpoOrdNum#
            AND H.REL_FLG       = 'N'
            AND H.EZCANCELFLAG  = '0'
            <!-- QC#11306 Add-->
            AND CASE HR.HLD_LVL_CD
                  WHEN #hldLvl.cpo#     THEN 1
                  WHEN #hldLvl.cpoDtl#  THEN
                    CASE WHEN H.TRX_SRC_TP_CD = #trxSrcTp# THEN 1
                         ELSE 0
                    END
                END = 1
            AND HR.GLBL_CMPY_CD = H.GLBL_CMPY_CD
            AND HR.HLD_RSN_CD   = H.HLD_RSN_CD
            AND HR.EZCANCELFLAG = '0'
    </statement>

    <statement id="getBookHldListWOBlockHld" parameterClass="Map" resultClass="BigDecimal">
        WITH
            NON_BOOK_HLD AS (
                SELECT
                     COUNT(*) AS CNT
                    ,H.GLBL_CMPY_CD
                    ,H.CPO_ORD_NUM
                FROM
                     HLD        H
                    ,HLD_RSN    HR
                WHERE
                         H.GLBL_CMPY_CD             = #glblCmpyCd#
                     AND H.CPO_ORD_NUM              = #cpoOrdNum#
                     AND H.REL_FLG                  = 'N'
                     AND H.HLD_RSN_CD              != #hldRsn.book#
                     AND H.EZCANCELFLAG             = '0'
                     AND HR.GLBL_CMPY_CD           = H.GLBL_CMPY_CD
                     AND HR.HLD_RSN_CD             = H.HLD_RSN_CD
                     AND HR.BLOCK_BOOK_HLD_REL_FLG = 'Y'
                     AND HR.HLD_EFF_FROM_DT       &lt;= #slsDt#
                     AND (HR.HLD_EFF_TO_DT        IS NULL
                      OR  HR.HLD_EFF_TO_DT        &gt;= #slsDt#)
                     AND HR.EZCANCELFLAG           = '0'
                GROUP BY
                     H.GLBL_CMPY_CD
                    ,H.CPO_ORD_NUM
            )
        SELECT
             H.HLD_PK
        FROM
             HLD H
        WHERE
                H.GLBL_CMPY_CD = #glblCmpyCd#
            AND H.CPO_ORD_NUM  = #cpoOrdNum#
            AND H.REL_FLG      = 'N'
            AND H.HLD_RSN_CD   = #hldRsn.book#
            AND H.EZCANCELFLAG = '0'
            AND NOT EXISTS(
                    SELECT
                        *
                    FROM
                        NON_BOOK_HLD NBH
                    WHERE
                            NBH.GLBL_CMPY_CD = H.GLBL_CMPY_CD
                        AND NBH.CPO_ORD_NUM  = H.CPO_ORD_NUM
                        AND NBH.CNT          &gt; 0
                )
    </statement>

    <statement id="getHldCnt" parameterClass="Map" resultClass="Integer">
        WITH
            HLD_V AS (
                SELECT
                     C.CPO_ORD_NUM
                    ,NULL AS DS_CPO_RTRN_LINE_NUM
                    ,NULL AS DS_CPO_RTRN_LINE_SUB_NUM
                FROM
                     CPO        C
                    ,HLD        H
                    ,HLD_RSN    HR
                WHERE
                        C.GLBL_CMPY_CD             = #glblCmpyCd#
                    AND C.CPO_ORD_NUM              = #cpoOrdNum#
                    AND C.CPO_HLD_FLG              = 'Y'
                    AND C.EZCANCELFLAG             = '0'
                    AND H.GLBL_CMPY_CD             = C.GLBL_CMPY_CD
                    AND H.CPO_ORD_NUM              = C.CPO_ORD_NUM
                    AND H.CPO_DTL_LINE_NUM        IS NULL
                    AND H.CPO_DTL_LINE_SUB_NUM    IS NULL
                    AND H.REL_FLG                  = 'N'
                    AND H.HLD_RSN_CD               = HR.HLD_RSN_CD
                    AND H.EZCANCELFLAG             = '0'
                    AND HR.GLBL_CMPY_CD           = H.GLBL_CMPY_CD
                    AND HR.HLD_RSN_CD             = H.HLD_RSN_CD
                    AND HR.BLOCK_BOOK_HLD_REL_FLG = 'Y'
                    AND HR.HLD_EFF_FROM_DT        &lt;= #slsDt#
                    AND (HR.HLD_EFF_TO_DT         IS NULL
                     OR  HR.HLD_EFF_TO_DT         &gt;= #slsDt#)
                    AND HR.EZCANCELFLAG           = '0'

                UNION

                SELECT
                     CRD.CPO_ORD_NUM
                    ,CRD.DS_CPO_RTRN_LINE_NUM
                    ,CRD.DS_CPO_RTRN_LINE_SUB_NUM
                FROM
                     DS_CPO_RTRN_DTL CRD
                    ,HLD             H
                    ,HLD_RSN         HR
                WHERE
                        CRD.GLBL_CMPY_CD           = #glblCmpyCd#
                    AND CRD.CPO_ORD_NUM            = #cpoOrdNum#
                    AND CRD.CPO_DTL_HLD_FLG        = 'Y'
                    AND CRD.EZCANCELFLAG           = '0'
                    AND H.GLBL_CMPY_CD             = CRD.GLBL_CMPY_CD
                    AND H.CPO_ORD_NUM              = CRD.CPO_ORD_NUM
                    AND H.CPO_DTL_LINE_NUM         = CRD.DS_CPO_RTRN_LINE_NUM
                    AND H.CPO_DTL_LINE_SUB_NUM     = CRD.DS_CPO_RTRN_LINE_SUB_NUM
                    AND H.REL_FLG                  = 'N'
                    AND H.EZCANCELFLAG             = '0'
                    AND H.TRX_SRC_TP_CD            = #trxSrcTp#  <!-- QC#11306 Add-->
                    AND HR.GLBL_CMPY_CD            = H.GLBL_CMPY_CD
                    AND HR.HLD_RSN_CD              = H.HLD_RSN_CD
                    AND HR.BLOCK_BOOK_HLD_REL_FLG  = 'Y'
                    AND HR.HLD_EFF_FROM_DT         &lt;= #slsDt#
                    AND (HR.HLD_EFF_TO_DT          IS NULL
                     OR  HR.HLD_EFF_TO_DT          &gt;= #slsDt#)
                    AND HR.EZCANCELFLAG            = '0'
            )
        SELECT
            COUNT(*) CNT
        FROM
            HLD_V
    </statement>

    <statement id="getOrderList" parameterClass="Map" resultClass="Map">
        SELECT
                C.GLBL_CMPY_CD                  GLBL_CMPY_CD
            ,   C.CPO_ORD_NUM                   CPO_ORD_NUM
            ,   CRD.DS_CPO_RTRN_LINE_NUM        DS_CPO_RTRN_LINE_NUM
            ,   CRD.DS_CPO_RTRN_LINE_SUB_NUM    DS_CPO_RTRN_LINE_SUB_NUM
            ,   C.PAYER_CUST_CD                 PAYER_CUST_CD
            ,   C.CPO_SRC_TP_CD                 CPO_SRC_TP_CD
            ,   C.CPO_ORD_TP_CD                 C_CPO_ORD_TP_CD
            ,   CRD.CPO_ORD_TP_CD               RTRN_CPO_ORD_TP_CD
            ,   CRD.MDSE_CD                     RTRN_MDSE_CD
            ,   CRD.INVTY_LOC_CD                RTRN_INVTY_LOC_CD
            ,   CRD.ORD_QTY                     RTRN_ORD_QTY
            ,   CRD.SET_MDSE_CD                 SET_MDSE_CD
            ,   CRD.CPO_ORD_TS                  CPO_ORD_TS
            ,   C.DS_ORD_TP_CD                 DS_ORD_TP_CD
            ,   C.DS_ORD_CATG_CD               DS_ORD_CATG_CD <!-- 2018/05/08 S21_NA#22131 Add -->
            ,   C.ADDL_CUST_INSTL_FLG          ADDL_CUST_INSTL_FLG
            ,   C.CR_CARD_AUTH_DT              CR_CARD_AUTH_DT
            ,   C.CR_CARD_AUTH_REF_NUM         CR_CARD_AUTH_REF_NUM
            ,   C.CR_CARD_AUTH_STS_CD          CR_CARD_AUTH_STS_CD
            ,   C.CR_CARD_CUST_REF_NUM         CR_CARD_CUST_REF_NUM
            ,   C.CR_CARD_TP_CD                CR_CARD_TP_CD
            ,   C.DS_PMT_METH_CD               DS_PMT_METH_CD
            ,   C.INV_RCPNT_CUST_CD            INV_RCPNT_CUST_CD
            ,   C.DS_ORD_RSN_CD                DS_ORD_RSN_CD
            ,   C.SLCNF_TRX_NUM                SLCNF_TRX_NUM
            ,   C.XREF_RMA_NUM                 XREF_RMA_NUM
            ,   C.BILL_TO_CUST_ACCT_CD         BILL_TO_CUST_ACCT_CD
            ,   CRD.SVC_CONFIG_MSTR_PK          SVC_CONFIG_MSTR_PK
        FROM 
                CPO                 C
            ,   DS_CPO_RTRN_DTL     CRD
        WHERE
                C.GLBL_CMPY_CD               = #glblCmpyCd#
          <isNotNull property="cpoOrdNum_I">
            AND C.CPO_ORD_NUM                = #cpoOrdNum_I#
          </isNotNull>
            AND C.EZCANCELFLAG               = '0'
            AND CRD.CPO_ORD_NUM              = C.CPO_ORD_NUM
          <isNotNull property="dsCpoRtrnLineNum_I">
            AND CRD.DS_CPO_RTRN_LINE_NUM     = #dsCpoRtrnLineNum_I#
          </isNotNull>
          <isNotNull property="dsCpoRtrnLineSubNum_I">
            AND CRD.DS_CPO_RTRN_LINE_SUB_NUM = #dsCpoRtrnLineSubNum_I#
          </isNotNull>
            AND CRD.EZCANCELFLAG             = '0'
<!--        #QC11306 Del
            AND NOT EXISTS (
                    SELECT
                        *
                    FROM
                        CPO_DTL CD
                    WHERE
                            CD.GLBL_CMPY_CD     = C.GLBL_CMPY_CD
                        AND CD.CPO_ORD_NUM      = C.CPO_ORD_NUM
                        AND CD.ORD_LINE_STS_CD != #ordLineSts.cancel#
                        AND CD.EZCANCELFLAG     = '0')
 -->
     </statement>

    <statement id="getOrderListToUpdateHldFlg" parameterClass="Map">
        /**********
          CPO
        **********/
        SELECT
            'CPO'         AS  TBL_NM
          , CPO_HLD_FLG   AS  HLD_FLG
          , CPO_ORD_NUM   AS  CPO_ORD_NUM
          , NULL          AS  DS_CPO_RTRN_LINE_NUM
          , NULL          AS  DS_CPO_RTRN_LINE_SUB_NUM
        FROM
          CPO
        WHERE
              GLBL_CMPY_CD  = #glblCmpyCd#
          AND CPO_ORD_NUM   = #cpoOrdNum#
          AND EZCANCELFLAG  = '0'
          
        /**********
          CPO_DTL
        **********/
        UNION ALL
        
        SELECT
            'DS_CPO_RTRN_DTL'
          , CPO_DTL_HLD_FLG
          , CPO_ORD_NUM
          , DS_CPO_RTRN_LINE_NUM
          , DS_CPO_RTRN_LINE_SUB_NUM
        FROM
          DS_CPO_RTRN_DTL
        WHERE
              GLBL_CMPY_CD  = #glblCmpyCd#
          AND CPO_ORD_NUM   = #cpoOrdNum#
          AND EZCANCELFLAG  = '0'
    </statement>
    
    <!-- 2018/05/08 S21_NA#22131 Add Start -->
    <statement id="getHldRsnFromValSet" parameterClass="Map" resultClass="String">
        SELECT
                OCBC.FIRST_BIZ_CTX_ATTRB_TXT
        FROM
                ORD_CATG_BIZ_CTX OCBC
        WHERE
                OCBC.GLBL_CMPY_CD             = #glblCmpyCd#
            AND OCBC.EZCANCELFLAG             = '0'
            AND OCBC.ORD_CATG_CTX_TP_CD       = #ordCatgCtxTpCd#
            AND
            (
               (    OCBC.DS_ORD_CATG_CD       IS NULL
                AND OCBC.DS_ORD_TP_CD         IS NULL
                AND OCBC.DS_ORD_RSN_CD        IS NULL)
              OR
               (    OCBC.DS_ORD_CATG_CD       = #dsOrdCatgCd#
                AND OCBC.DS_ORD_TP_CD         IS NULL
                AND OCBC.DS_ORD_RSN_CD        IS NULL)
              OR
               (    OCBC.DS_ORD_CATG_CD       = #dsOrdCatgCd#
                AND OCBC.DS_ORD_TP_CD         = #dsOrdTpCd#
                AND OCBC.DS_ORD_RSN_CD        IS NULL)
              <isNotNull property="dsOrdRsnCd">       -- 2016/03/23 S21_NA5918
              OR
               (    OCBC.DS_ORD_CATG_CD       = #dsOrdCatgCd#
                AND OCBC.DS_ORD_TP_CD         = #dsOrdTpCd#
                AND OCBC.DS_ORD_RSN_CD        = #dsOrdRsnCd#)
              </isNotNull>
            )
    </statement>
    <!-- 2018/05/08 S21_NA#22131 Add End -->

</sqlMap>
