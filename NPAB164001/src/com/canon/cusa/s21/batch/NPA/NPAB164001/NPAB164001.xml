<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NPAB164001">
    <statement id="searchRequest" parameterClass="Map" resultClass="Map">
        SELECT
            PR.PRCH_REQ_NUM
            ,PRD.RQST_RCV_DT
            ,PRD.RQST_RCV_TM
            ,PRD.PRCH_REQ_LINE_NUM
            ,PRD.PRCH_REQ_LINE_SUB_NUM
            ,PRD.MDSE_CD
            ,PRD.PRCH_REQ_QTY
            ,PRD.DEST_RTL_WH_CD
            ,PRD.DEST_RTL_SWH_CD
            ,TM.TECH_NM
            ,PRT.PRCH_REQ_TP_DESC_TXT
            ,PRLT.PRCH_REQ_LINE_TP_DESC_TXT
            ,DMI.MDSE_DESC_SHORT_TXT
            ,IV1.INVTY_QTY AS INVTY_QTY_1
            ,IV2.INVTY_QTY AS INVTY_QTY_2
            ,CASE WHEN MI1.MIN_ORD_QTY IS NULL THEN M.MIN_ORD_QTY
                ELSE MI1.MIN_ORD_QTY
                END AS  MIN_ORD_QTY
            ,CASE WHEN MI1.MAX_INVTY_QTY IS NULL THEN M.MAX_INVTY_QTY
                ELSE MI1.MAX_INVTY_QTY
                END AS  MAX_INVTY_QTY
            ,SP1.EML_ADDR AS EML_ADDR_1
            ,SP2.EML_ADDR AS EML_ADDR_2
            ,TM.TECH_TOC_CD
        FROM
            PRCH_REQ PR
            ,PRCH_REQ_DTL PRD
            ,TECH_MSTR TM
            ,S21_PSN SP1
            ,S21_PSN SP2
            ,PRCH_REQ_TP PRT
            ,PRCH_REQ_LINE_TP PRLT
            ,MDSE DMI
            ,INVTY IV1
            ,INVTY IV2
            ,MRP_INFO MI1
            ,(
                SELECT
                    MRP2.MDSE_CD
                    ,MRP2.INVTY_LOC_CD
                    ,MRP2.MIN_ORD_QTY
                    ,MRP2.MAX_INVTY_QTY
                FROM
                    MRP_INFO MRP2
                    ,ORD_TAKE_MDSE OTM
                WHERE
                    OTM.ORD_TAKE_MDSE_CD = MRP2.MDSE_CD
                AND MRP2.MRP_ENBL_FLG = #mrpEnblFlg#
                AND MRP2.MRP_INFO_RGTN_STS_CD = #mrpInfoRgtnStsCd#
                AND MRP2.GLBL_CMPY_CD = #glblCmpyCd#
                AND MRP2.GLBL_CMPY_CD = OTM.GLBL_CMPY_CD
                AND MRP2.EZCANCELFLAG = '0'
                AND OTM.EZCANCELFLAG = '0'
            ) M
        WHERE
                PR.GLBL_CMPY_CD = #glblCmpyCd#
            AND PR.PRCH_REQ_REC_TP_CD = #prchReqRecTpCd#
            AND PR.EZCANCELFLAG = '0'
            AND PR.GLBL_CMPY_CD = PRD.GLBL_CMPY_CD
            AND PR.PRCH_REQ_NUM = PRD.PRCH_REQ_NUM
            AND PRD.TECH_RQST_NTC_ML_PROC_CD IN (#techRqstNtcMlProcCd_0#, #techRqstNtcMlProcCd_9#)
            AND PRD.EZCANCELFLAG = '0'
            AND PR.GLBL_CMPY_CD = TM.GLBL_CMPY_CD
            AND PR.RQST_TECH_TOC_CD = TM.TECH_TOC_CD
            AND TM.EZCANCELFLAG = '0'
            AND PR.GLBL_CMPY_CD = SP1.GLBL_CMPY_CD
            AND PR.RQST_TECH_TOC_CD = SP1.PSN_CD
            AND SP1.EFF_FROM_DT &lt;= #effFromDt#
            AND NVL(SP1.EFF_THRU_DT, '99991231') &gt;= #effThruDt#
            AND SP1.DEL_FLG = #delFlg#
            AND SP1.EZCANCELFLAG = '0'
            AND SP1.GLBL_CMPY_CD = SP2.GLBL_CMPY_CD
            AND SP1.HR_SUPV_ID = SP2.PSN_CD
            AND SP2.EFF_FROM_DT &lt;= #effFromDt#
            AND NVL(SP2.EFF_THRU_DT, '99991231') &gt;= #effThruDt#
            AND SP2.DEL_FLG = #delFlg#
            AND SP2.EZCANCELFLAG = '0'
            AND PR.GLBL_CMPY_CD  = PRT.GLBL_CMPY_CD(+)
            AND PR.PRCH_REQ_TP_CD = PRT.PRCH_REQ_TP_CD(+)
            AND PRT.EZCANCELFLAG(+) = '0'
            AND PRD.GLBL_CMPY_CD = PRLT.GLBL_CMPY_CD(+)
            AND PRD.PRCH_REQ_LINE_TP_CD = PRLT.PRCH_REQ_LINE_TP_CD(+)
            AND PRLT.EZCANCELFLAG(+) = '0'
            AND PRD.GLBL_CMPY_CD = IV1.GLBL_CMPY_CD(+) 
            AND PRD.MDSE_CD = IV1.MDSE_CD(+)
            AND PRD.DEST_INVTY_LOC_CD = IV1.INVTY_LOC_CD(+)
            AND IV1.LOC_STS_CD(+) = #locStsCd_1#
            AND IV1.EZCANCELFLAG(+) = '0'
            AND PRD.GLBL_CMPY_CD = IV2.GLBL_CMPY_CD(+)
            AND PRD.MDSE_CD = IV2.MDSE_CD(+)
            AND PRD.DEST_INVTY_LOC_CD = IV2.INVTY_LOC_CD(+)
            AND IV2.LOC_STS_CD(+) = #locStsCd_2#
            AND IV2.EZCANCELFLAG(+) = '0'
            AND PRD.GLBL_CMPY_CD = MI1.GLBL_CMPY_CD(+)
            AND PRD.MDSE_CD = MI1.MDSE_CD(+)
            AND PRD.DEST_INVTY_LOC_CD = MI1.INVTY_LOC_CD(+)
            AND MI1.MRP_ENBL_FLG(+) = #mrpEnblFlg#
            AND MI1.MRP_INFO_RGTN_STS_CD(+) = #mrpInfoRgtnStsCd#
            AND MI1.EZCANCELFLAG(+) = '0'
            AND PRD.GLBL_CMPY_CD = DMI.GLBL_CMPY_CD(+)
            AND PRD.MDSE_CD = DMI.MDSE_CD(+)
            AND DMI.EZCANCELFLAG(+) = '0'
            AND SUBSTR(PRD.MDSE_CD,1,8) = M.MDSE_CD(+)
            AND PRD.DEST_INVTY_LOC_CD = M.INVTY_LOC_CD(+)
        ORDER BY
            PR.PRCH_REQ_NUM
            ,PRD.PRCH_REQ_LINE_NUM
            ,PRD.PRCH_REQ_LINE_SUB_NUM
    </statement>
    
    <statement id="searchReturn" parameterClass="Map" resultClass="Map">
        SELECT
            PR.PRCH_REQ_NUM
            ,PRD.PRCH_REQ_CRAT_DT
            ,PRD.SRC_RTL_WH_CD
            ,PRD.SRC_RTL_SWH_CD
            ,PRD.PRCH_REQ_LINE_NUM
            ,PRD.PRCH_REQ_LINE_SUB_NUM
            ,PRD.MDSE_CD
            ,PRD.PRCH_REQ_QTY
            ,PRD.SHIP_QTY
            ,PRD.RWS_PUT_AWAY_QTY
            ,PRD.BACK_TO_TECH_QTY
            ,PRD.DEST_RTL_WH_CD
            ,PRD.DEST_RTL_SWH_CD
            ,PRD.RWS_CLO_DT_TM_TS
            ,TM.TECH_NM
            ,PRLT.PRCH_REQ_LINE_TP_DESC_TXT
            ,DMI.MDSE_DESC_SHORT_TXT
            ,SP1.EML_ADDR AS EML_ADDR_1
            ,SP2.EML_ADDR AS EML_ADDR_2
            ,TM.TECH_TOC_CD
        FROM
            PRCH_REQ PR
            ,PRCH_REQ_DTL PRD
            ,TECH_MSTR TM
            ,S21_PSN SP1
            ,S21_PSN SP2
            ,PRCH_REQ_LINE_TP PRLT
            ,MDSE DMI
        WHERE
                PR.GLBL_CMPY_CD = #glblCmpyCd#
            AND PR.PRCH_REQ_REC_TP_CD = #prchReqRecTpCd#
            AND PR.EZCANCELFLAG = '0'
            AND PR.GLBL_CMPY_CD = PRD.GLBL_CMPY_CD
            AND PR.PRCH_REQ_NUM = PRD.PRCH_REQ_NUM
            AND PRD.TECH_RQST_NTC_ML_PROC_CD IN (#techRqstNtcMlProcCd_0#, #techRqstNtcMlProcCd_9#)
            AND PRD.PRCH_REQ_LINE_STS_CD = #prchReqLineStsCd#
            AND PRD.EZCANCELFLAG = '0'
            AND PR.GLBL_CMPY_CD = TM.GLBL_CMPY_CD
            AND PR.RQST_TECH_TOC_CD = TM.TECH_TOC_CD
            AND TM.EZCANCELFLAG = '0'
            AND PR.GLBL_CMPY_CD = SP1.GLBL_CMPY_CD
            AND PR.RQST_TECH_TOC_CD = SP1.PSN_CD
            AND SP1.EFF_FROM_DT &lt;= #effFromDt#
            AND NVL(SP1.EFF_THRU_DT, '99991231') &gt;= #effThruDt#
            AND SP1.DEL_FLG = #delFlg#
            AND SP1.EZCANCELFLAG = '0'
            AND SP1.GLBL_CMPY_CD = SP2.GLBL_CMPY_CD
            AND SP1.HR_SUPV_ID = SP2.PSN_CD
            AND SP2.EFF_FROM_DT &lt;= #effFromDt#
            AND NVL(SP2.EFF_THRU_DT, '99991231') &gt;= #effThruDt#
            AND SP2.DEL_FLG = #delFlg#
            AND SP2.EZCANCELFLAG = '0'
            AND PRD.GLBL_CMPY_CD = PRLT.GLBL_CMPY_CD(+)
            AND PRD.PRCH_REQ_LINE_TP_CD = PRLT.PRCH_REQ_LINE_TP_CD(+)
            AND PRLT.EZCANCELFLAG(+) = '0'
            AND PRD.GLBL_CMPY_CD = DMI.GLBL_CMPY_CD(+)
            AND PRD.MDSE_CD = DMI.MDSE_CD(+)
            AND DMI.EZCANCELFLAG(+) = '0'
        ORDER BY
            PR.PRCH_REQ_NUM
            ,PRD.PRCH_REQ_LINE_NUM
            ,PRD.PRCH_REQ_LINE_SUB_NUM
    </statement>

    <statement id="getTechLocation" parameterClass="Map" resultClass="Map">
        SELECT
            LOC.POST_CD
            ,LOC.CTRY_CD
        FROM
        (
            SELECT
                RWH.POST_CD  AS POST_CD
                ,RWH.CTRY_CD AS CTRY_CD
            FROM
                RTL_WH RWH
            WHERE
                RWH.GLBL_CMPY_CD    = #glblCmpyCd#
            AND RWH.TECH_TOC_CD     = #techTocCd#
            AND NVL(RWH.EFF_FROM_DT, '00000000') &lt;= #effFromDt#
            AND NVL(RWH.EFF_THRU_DT, '99991231') &gt;= #effThruDt#
            AND RWH.EZCANCELFLAG    = '0'
            ORDER BY 
               RTL_WH_CATG_CD
              ,RTL_WH_CD
        ) LOC
        WHERE
            ROWNUM = 1
    </statement>
</sqlMap>
