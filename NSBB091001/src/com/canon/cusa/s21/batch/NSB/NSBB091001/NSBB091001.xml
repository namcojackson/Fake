<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSBB091001">

    <statement id="getTrgtYrMth" parameterClass="Map" resultClass="String">
        SELECT
            CAL.DWH_TRGT_YR_MTH
        FROM
            DMN_RPT_CAL              CAL
        WHERE 
            CAL.GLBL_CMPY_CD         = #glblCmpyCd#
        AND CAL.DWH_TRGT_DT          = #trgtDt#
        AND CAL.EZCANCELFLAG         = '0'
    </statement>

    <statement id="getTrgtYrMthRec" parameterClass="Map" resultClass="BigDecimal">
        SELECT COUNT(1)
        FROM
            FCT_MLY_FSR_BY_MACH      FCT
        WHERE 
            FCT.GLBL_CMPY_CD         = #glblCmpyCd#
        AND FCT.DWH_TRGT_YR_MTH      = #trgtYrMth#
        AND FCT.EZCANCELFLAG         = '0'
    </statement>

    <statement id="getMainData" parameterClass="Map" resultClass="Map">
        -- Machine Level Data
        SELECT
            FSR.SVC_MACH_MSTR_PK                               AS SVC_MACH_MSTR_PK
           ,NULL                                               AS TECH_CD
           ,MAC.SVC_CONFIG_MSTR_PK                             AS SVC_CONFIG_MSTR_PK
           ,MAC.SVC_BY_LINE_BIZ_TP_CD                          AS SVC_BY_LINE_BIZ_TP_CD
           ,NVL(MDL_1.MDL_ID, MDL_2.MDL_ID)                    AS MDL_ID
           ,FSR.SER_NUM                                        AS SER_NUM
           ,COA.COPR_MACH_FLG                                  AS COPR_MACH_FLG
           ,NVL(T_FLG.TM_AND_MAT_FLG, 'Y')                     AS TM_AND_MAT_FLG
           ,NVL(P_MTR.PREV_READ_MTR_CNT, 0)                    AS PREV_READ_MTR_CNT
           ,NVL(L_MTR.LTST_READ_MTR_CNT, 0)                    AS LTST_READ_MTR_CNT
           ,NVL(L_MTR.LTST_READ_MTR_CNT, 0) - NVL(P_MTR.PREV_READ_MTR_CNT, 0) AS MLY_COPY_VOL
           ,CASE WHEN NVL(T_FLG.TM_AND_MAT_FLG, 'Y') = 'Y' THEN NULL ELSE INV.SVC_INV_NUM   END AS SVC_INV_NUM
           ,CASE WHEN NVL(T_FLG.TM_AND_MAT_FLG, 'Y') = 'Y' THEN NULL ELSE INV.INV_DT        END AS INV_DT
           ,CASE WHEN NVL(T_FLG.TM_AND_MAT_FLG, 'Y') = 'Y' THEN 0 ELSE INV.CHRG_COPY_VOL    END AS CHRG_COPY_VOL
           ,NVL(C_FSR.MLY_TOT_FSR_CNT, 0)                      AS MLY_TOT_FSR_CNT
           ,NVL(C_FSR.MLY_TOT_CM_CNT, 0)                       AS MLY_TOT_CM_CNT
           ,NVL(C_VIS.TOT_VISIT_CNT_01, 0)                     AS MLY_TOT_VISIT_CNT
           ,NVL(C_RTR.MLY_TOT_RTRN_VISIT_CNT, 0)               AS MLY_TOT_RTRN_VISIT_CNT
           ,TRUNC(NVL(C_RTR.MLY_TOT_RTRN_VISIT_CNT, 0) / (CASE WHEN C_VIS.TOT_VISIT_CNT_01 = 0 OR C_VIS.TOT_VISIT_CNT_01 IS NULL THEN 1 ELSE C_VIS.TOT_VISIT_CNT_01 END), #secPeriod#) * 100 AS SCD_VISIT_RATIO
           ,NVL(CST.RPT_COND_CONST_VAL_NUM_02, 0)              AS SVC_AVG_TRVL_AOT
           ,NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0)              AS SVC_LBOR_COST_UNIT_AMT
           ,NVL(M_AOT.MLY_TOT_TRVL_AOT, 0)                     AS MLY_TOT_TRVL_AOT
           ,NVL(M_AOT.MLY_TOT_LBOR_AOT, 0)                     AS MLY_TOT_LBOR_AOT
           ,NVL(I_AOT.MLY_TOT_ITRPT_AOT, 0)                    AS MLY_TOT_ITRPT_AOT
           ,TRUNC(NVL(M_AOT.MLY_TOT_TRVL_AOT,  0)/(#timeAdj# * #timeAdj#), #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0) AS MLY_TOT_TRVL_COST_AMT
           ,TRUNC(NVL(M_AOT.MLY_TOT_LBOR_AOT,  0)/(#timeAdj# * #timeAdj#), #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0) AS MLY_TOT_LBOR_COST_AMT
           ,TRUNC(NVL(I_AOT.MLY_TOT_ITRPT_AOT, 0)/(#timeAdj# * #timeAdj#), #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0) AS MLY_TOT_ITRPT_COST_AMT
           ,NVL(U_AOT.MLY_TOT_PRT_COST_AMT, 0)                 AS MLY_TOT_PRT_COST_AMT
           ,(TRUNC(NVL(M_AOT.MLY_TOT_TRVL_AOT,  0)/(#timeAdj# * #timeAdj#), #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0))
           +(TRUNC(NVL(M_AOT.MLY_TOT_LBOR_AOT,  0)/(#timeAdj# * #timeAdj#), #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0))
           +(TRUNC(NVL(I_AOT.MLY_TOT_ITRPT_AOT, 0)/(#timeAdj# * #timeAdj#), #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0))
           + NVL(U_AOT.MLY_TOT_PRT_COST_AMT, 0)                AS MLY_TOT_COST_AMT
           ,NVL(C_CLVIS.MLY_NITL_VISIT_CNT, 0)                 AS MLY_NI_VISIT_CNT
           ,NVL(M_AOT.MLY_NI_LBOR_AOT, 0)                      AS MLY_NI_LBOR_AOT
           ,NVL(M_AOT.MLY_NI_TRVL_AOT, 0)                      AS MLY_NI_TRVL_AOT
           ,NVL(I_AOT.MLY_NI_ITRPT_AOT, 0)                     AS MLY_NI_ITRPT_AOT
           ,NVL(C_CLVIS.MLY_NISTL_SCD_VISIT_CNT, 0)            AS MLY_NI_SCD_VISIT_CNT
           ,NVL(M_AOT.MLY_NI_SCD_VISIT_TRVL_AOT, 0)            AS MLY_NI_SCD_VISIT_TRVL_AOT
           ,NVL(M_AOT.MLY_NI_SCD_VISIT_LBOR_AOT, 0)            AS MLY_NI_SCD_VISIT_LBOR_AOT
           ,NVL(I_AOT.MLY_NI_SCD_VISIT_ITRPT_AOT, 0)           AS MLY_NI_SCD_VISIT_ITRPT_AOT
           ,NVL(U_AOT.MLY_NI_SCD_VISIT_PRT_CNT, 0)             AS MLY_NI_SCD_VISIT_PRT_CNT
           ,NVL(C_CLVIS.MLY_ISTL_VISIT_CNT, 0)                 AS MLY_ISTL_VISIT_CNT
           ,NVL(C_CLVIS.MLY_ISTL_SCD_VISIT_CNT, 0)             AS MLY_ISTL_SCD_VISIT_CNT
           ,NVL(U_AOT.MLY_TOT_PRT_COST_AMT
           *TRUNC(TRUNC((LAST_DAY(TO_DATE(#trgtYrMth#, 'YYYYMM'))
                                - TO_DATE(MAC.ISTL_DT, 'YYYYMMDD'))
                                / TO_CHAR(LAST_DAY(TO_DATE(#trgtYrMth#, 'YYYYMM')), 'DD'), #secPeriod#)
                                / 12, #secPeriod#), 0)         AS CNF_YR_PRT_COST_AMT
           ,NVL(CHG.SVC_LBOR_DEAL_AMT, 0)                      AS SVC_LBOR_DEAL_AMT
           ,NVL(CHG.SVC_LBOR_FUNC_AMT, 0)                      AS SVC_LBOR_FUNC_AMT
           ,NVL(CHG.SVC_LBOR_DEAL_DISC_AMT, 0)                 AS SVC_LBOR_DEAL_DISC_AMT
           ,NVL(CHG.SVC_LBOR_FUNC_DISC_AMT, 0)                 AS SVC_LBOR_FUNC_DISC_AMT
           ,NVL(CHG.SVC_TRVL_DEAL_AMT, 0)                      AS SVC_TRVL_DEAL_AMT
           ,NVL(CHG.SVC_TRVL_FUNC_AMT, 0)                      AS SVC_TRVL_FUNC_AMT
           ,NVL(CHG.SVC_TRVL_DEAL_DISC_AMT, 0)                 AS SVC_TRVL_DEAL_DISC_AMT
           ,NVL(CHG.SVC_TRVL_FUNC_DISC_AMT, 0)                 AS SVC_TRVL_FUNC_DISC_AMT
           ,NVL(CHG.SVC_PRT_DEAL_AMT, 0)                       AS SVC_PRT_DEAL_AMT
           ,NVL(CHG.SVC_PRT_FUNC_AMT, 0)                       AS SVC_PRT_FUNC_AMT
           ,NVL(CHG.SVC_PRT_DEAL_DISC_AMT, 0)                  AS SVC_PRT_DEAL_DISC_AMT
           ,NVL(CHG.SVC_PRT_FUNC_DISC_AMT, 0)                  AS SVC_PRT_FUNC_DISC_AMT
           ,NVL(TRUNC(U_AOT.MLY_TOT_PRT_COST_AMT/ 1000, #secPeriod#), 0) AS K_CLICK_PRT_COST_AMT
           ,NVL(C_VIS.TOT_VISIT_CNT_01, 0)                     AS TOT_VISIT_CNT_01
           ,NVL(C_VIS.TOT_CM_CNT_01, 0)                        AS TOT_CM_CNT_01
           ,NVL(L_MTR.LTST_READ_MTR_CNT, 0) - NVL(P_MTR.PREV_READ_MTR_CNT, 0) AS TOT_MTR_VOL_01
           ,NVL(C_VIS.TOT_VISIT_CNT_03, 0)                     AS TOT_VISIT_CNT_03
           ,NVL(C_VIS.TOT_CM_CNT_03, 0)                        AS TOT_CM_CNT_03
           ,NVL(L_MTR.LTST_READ_MTR_CNT, 0) - NVL(MTR_03.READ_MTR_CNT, 0) AS TOT_MTR_VOL_03
           ,NVL(C_VIS.TOT_VISIT_CNT_06, 0)                     AS TOT_VISIT_CNT_06
           ,NVL(C_VIS.TOT_CM_CNT_06, 0)                        AS TOT_CM_CNT_06
           ,NVL(L_MTR.LTST_READ_MTR_CNT, 0) - NVL(MTR_06.READ_MTR_CNT, 0) AS TOT_MTR_VOL_06
           ,NVL(C_VIS.TOT_VISIT_CNT_12, 0)                     AS TOT_VISIT_CNT_12
           ,NVL(C_VIS.TOT_CM_CNT_12, 0)                        AS TOT_CM_CNT_12
           ,NVL(L_MTR.LTST_READ_MTR_CNT, 0) - NVL(MTR_12.READ_MTR_CNT, 0) AS TOT_MTR_VOL_12
           ,NULL                                               AS RGTN_MTR_DT
        FROM
            SVC_MACH_MSTR              MAC
           ,RPT_COND_CONST             CST
           ,(
               SELECT DISTINCT
                   FSR.SVC_MACH_MSTR_PK
                  ,FSR.SER_NUM
               FROM
                   FSR                 FSR
                 ,(
                   SELECT
                       FSR.SVC_MACH_MSTR_PK
                      ,MAX(FSR.FSR_CLO_DT) AS FSR_CLO_DT
                   FROM
                       FSR                 FSR
                   WHERE
                       FSR.GLBL_CMPY_CD                   = #glblCmpyCd#
                   AND SUBSTR(FSR.FSR_CLO_DT, 0, #ymLen#) = #trgtYrMth#
                   AND FSR.EZCANCELFLAG                   = '0'
                   GROUP BY FSR.SVC_MACH_MSTR_PK
                  ) MAX_FSR
               WHERE
                   FSR.GLBL_CMPY_CD                   = #glblCmpyCd#
               AND FSR.SVC_MACH_MSTR_PK               = MAX_FSR.SVC_MACH_MSTR_PK
               AND FSR.FSR_CLO_DT                     = MAX_FSR.FSR_CLO_DT
               AND FSR.EZCANCELFLAG                   = '0'
           ) FSR
           ,(
               SELECT 
                   MAC.SVC_MACH_MSTR_PK
                  ,MDL.MDL_ID
               FROM
                   SVC_MACH_MSTR               MAC
                  ,SVC_CONFIG_MSTR             CON
                  ,DS_MDL                      MDL
               WHERE
                   MAC.GLBL_CMPY_CD            = #glblCmpyCd#
               AND MAC.GLBL_CMPY_CD            = CON.GLBL_CMPY_CD
               AND MAC.SVC_CONFIG_MSTR_PK      = CON.SVC_CONFIG_MSTR_PK
               AND CON.GLBL_CMPY_CD            = MDL.GLBL_CMPY_CD
               AND CON.MDL_ID                  = MDL.MDL_ID
               AND MAC.EZCANCELFLAG            = '0'
               AND CON.EZCANCELFLAG            = '0'
               AND MDL.EZCANCELFLAG            = '0'
           ) MDL_1
           ,(
               SELECT 
                   SVC_MACH_MSTR_PK
                  ,MDL_ID
               FROM
                   (
                   SELECT
                       MAC.SVC_MACH_MSTR_PK
                      ,ROW_NUMBER() OVER(PARTITION BY MAC.SVC_MACH_MSTR_PK ORDER BY SVC_CONFIG_MSTR_DTL_PK DESC) ROW_NUM
                      ,MDL.MDL_ID
                   FROM
                       SVC_MACH_MSTR               MAC
                      ,SVC_CONFIG_MSTR_DTL         CON
                      ,DS_MDL                      MDL
                   WHERE
                       MAC.GLBL_CMPY_CD            = #glblCmpyCd#
                   AND MAC.GLBL_CMPY_CD            = CON.GLBL_CMPY_CD
                   AND MAC.SVC_MACH_MSTR_PK        = CON.SVC_MACH_MSTR_PK
                   AND CON.GLBL_CMPY_CD            = MDL.GLBL_CMPY_CD
                   AND CON.MDL_ID                  = MDL.MDL_ID
                   AND MAC.EZCANCELFLAG            = '0'
                   AND CON.EZCANCELFLAG            = '0'
                   AND MDL.EZCANCELFLAG            = '0'
                   )
               WHERE ROW_NUM = 1
           ) MDL_2
           ,(
               SELECT
                   MAC.SVC_MACH_MSTR_PK
                  ,CASE WHEN UPPER(COA.COA_PROD_NM) LIKE #copier# THEN 'Y' ELSE 'N' END AS COPR_MACH_FLG
               FROM
                   SVC_MACH_MSTR           MAC
                  ,MDSE                    MDS
                  ,COA_PROD                COA
               WHERE
                   MAC.GLBL_CMPY_CD        = #glblCmpyCd#
               AND MAC.GLBL_CMPY_CD        = MDS.GLBL_CMPY_CD
               AND MAC.MDSE_CD             = MDS.MDSE_CD
               AND MDS.GLBL_CMPY_CD        = COA.GLBL_CMPY_CD
               AND MDS.COA_PROD_CD         = COA.COA_PROD_CD
               AND MAC.EZCANCELFLAG        = '0'
               AND MDS.EZCANCELFLAG        = '0'
               AND COA.EZCANCELFLAG        = '0'
           ) COA
           ,(
               SELECT
                   MAC.SVC_MACH_MSTR_PK
                  ,CASE WHEN (SUM(CASE WHEN CTR.DS_CONTR_STS_CD IN (#effective#, #approved#) THEN 1 ELSE 0 END)) = 0 THEN 'Y' ELSE 'N' END AS TM_AND_MAT_FLG
               FROM
                   SVC_MACH_MSTR           MAC
                  ,DS_CONTR                CTR
                  ,DS_CONTR_DTL            CTD
               WHERE
                   MAC.GLBL_CMPY_CD        = #glblCmpyCd#
               AND MAC.GLBL_CMPY_CD        = CTD.GLBL_CMPY_CD
               AND MAC.SVC_MACH_MSTR_PK    = CTD.SVC_MACH_MSTR_PK
               AND CTD.GLBL_CMPY_CD        = CTR.GLBL_CMPY_CD
               AND CTD.DS_CONTR_PK         = CTR.DS_CONTR_PK
               AND MAC.EZCANCELFLAG        = '0'
               AND CTR.EZCANCELFLAG        = '0'
               AND CTD.EZCANCELFLAG        = '0'
               GROUP BY MAC.SVC_MACH_MSTR_PK
           ) T_FLG
           ,(
               SELECT
                   FSR.SVC_MACH_MSTR_PK
                  ,COUNT(FSR.FSR_NUM)                                             AS MLY_TOT_FSR_CNT
                  ,SUM(CASE WHEN FSR.FSR_TP_CD = #serviceCall# THEN 1 ELSE 0 END) AS MLY_TOT_CM_CNT
               FROM
                   FSR                 FSR
               WHERE
                   FSR.GLBL_CMPY_CD                    = #glblCmpyCd#
               AND SUBSTR(FSR.FSR_CRAT_DT, 0, #ymLen#) = #trgtYrMth#
               AND FSR.EZCANCELFLAG                    = '0'
               GROUP BY
                   FSR.SVC_MACH_MSTR_PK
           ) C_FSR
           ,(
               SELECT
                   FSR.SVC_MACH_MSTR_PK
                  ,SUM(CASE WHEN FSR.FSR_TP_CD != #installCall# AND SUBSTR(VIS.FSR_VISIT_CPLT_DT, 0, 6) =  #trgtYrMth# THEN 1 ELSE 0 END)                                                                  - 1 AS TOT_VISIT_CNT_01
                  ,SUM(CASE WHEN FSR.FSR_TP_CD != #installCall# AND SUBSTR(VIS.FSR_VISIT_CPLT_DT, 0, 6) >= TO_CHAR(ADD_MONTHS(TO_DATE(#trgtYrMth#, 'YYYYMM'), - #threeMth# ), 'YYYYMM') THEN 1 ELSE 0 END) - 1 AS TOT_VISIT_CNT_03
                  ,SUM(CASE WHEN FSR.FSR_TP_CD != #installCall# AND SUBSTR(VIS.FSR_VISIT_CPLT_DT, 0, 6) >= TO_CHAR(ADD_MONTHS(TO_DATE(#trgtYrMth#, 'YYYYMM'), - #sixMth#   ), 'YYYYMM') THEN 1 ELSE 0 END) - 1 AS TOT_VISIT_CNT_06
                  ,SUM(CASE WHEN FSR.FSR_TP_CD != #installCall# AND SUBSTR(VIS.FSR_VISIT_CPLT_DT, 0, 6) >= TO_CHAR(ADD_MONTHS(TO_DATE(#trgtYrMth#, 'YYYYMM'), - #twelveMth#), 'YYYYMM') THEN 1 ELSE 0 END) - 1 AS TOT_VISIT_CNT_12
                  ,SUM(CASE WHEN FSR.FSR_TP_CD != #installCall# AND SUBSTR(VIS.FSR_VISIT_CPLT_DT, 0, 6) =  #trgtYrMth# THEN (CASE WHEN FSR.FSR_TP_CD = #serviceCall# THEN 1 ELSE 0 END) ELSE 0 END)                                                                  - 1 AS TOT_CM_CNT_01
                  ,SUM(CASE WHEN FSR.FSR_TP_CD != #installCall# AND SUBSTR(VIS.FSR_VISIT_CPLT_DT, 0, 6) >= TO_CHAR(ADD_MONTHS(TO_DATE(#trgtYrMth#, 'YYYYMM'), - #threeMth# ), 'YYYYMM') THEN (CASE WHEN FSR.FSR_TP_CD = #serviceCall# THEN 1 ELSE 0 END) ELSE 0 END) - 1 AS TOT_CM_CNT_03
                  ,SUM(CASE WHEN FSR.FSR_TP_CD != #installCall# AND SUBSTR(VIS.FSR_VISIT_CPLT_DT, 0, 6) >= TO_CHAR(ADD_MONTHS(TO_DATE(#trgtYrMth#, 'YYYYMM'), - #sixMth#   ), 'YYYYMM') THEN (CASE WHEN FSR.FSR_TP_CD = #serviceCall# THEN 1 ELSE 0 END) ELSE 0 END) - 1 AS TOT_CM_CNT_06
                  ,SUM(CASE WHEN FSR.FSR_TP_CD != #installCall# AND SUBSTR(VIS.FSR_VISIT_CPLT_DT, 0, 6) >= TO_CHAR(ADD_MONTHS(TO_DATE(#trgtYrMth#, 'YYYYMM'), - #twelveMth#), 'YYYYMM') THEN (CASE WHEN FSR.FSR_TP_CD = #serviceCall# THEN 1 ELSE 0 END) ELSE 0 END) - 1 AS TOT_CM_CNT_12
               FROM
                   FSR                 FSR
                  ,FSR_VISIT           VIS
               WHERE
                   VIS.GLBL_CMPY_CD                    = #glblCmpyCd#
               AND SUBSTR(VIS.FSR_VISIT_CPLT_DT, 0, #ymLen#) &gt;= TO_CHAR(ADD_MONTHS(TO_DATE(#trgtYrMth#, 'YYYYMM'), - #twelveMth#), 'YYYYMM')
               AND VIS.GLBL_CMPY_CD                    = FSR.GLBL_CMPY_CD
               AND VIS.FSR_NUM                         = FSR.FSR_NUM
               AND VIS.EZCANCELFLAG                    = '0'
               AND FSR.EZCANCELFLAG                    = '0'
               GROUP BY
                   FSR.SVC_MACH_MSTR_PK
           ) C_VIS
           ,(
               SELECT
                   FSR.SVC_MACH_MSTR_PK
                  ,COUNT(VIS.FSR_VISIT_NUM) AS MLY_TOT_RTRN_VISIT_CNT
               FROM
                   FSR                 FSR
                  ,FSR_VISIT_TASK      FVT
                  ,SVC_TASK            TSK
                  ,FSR_VISIT           VIS
               WHERE
                   FSR.GLBL_CMPY_CD                          = #glblCmpyCd#
               AND FSR.GLBL_CMPY_CD                          = FVT.GLBL_CMPY_CD
               AND FSR.FSR_NUM                               = FVT.FSR_NUM
               AND FVT.GLBL_CMPY_CD                          = TSK.GLBL_CMPY_CD
               AND FVT.FSR_NUM                               = TSK.FSR_NUM
               AND FVT.SVC_TASK_NUM                          = TSK.SVC_TASK_NUM
               AND TSK.FIRST_SVC_TASK_FLG                    = 'N'
               AND FVT.GLBL_CMPY_CD                          = VIS.GLBL_CMPY_CD
               AND FVT.FSR_NUM                               = VIS.FSR_NUM
               AND FVT.FSR_VISIT_NUM                         = VIS.FSR_VISIT_NUM
               AND SUBSTR(VIS.FSR_VISIT_CPLT_DT, 0, #ymLen#) = #trgtYrMth#
               AND FSR.EZCANCELFLAG                          = '0'
               AND FVT.EZCANCELFLAG                          = '0'
               AND TSK.EZCANCELFLAG                          = '0'
               AND VIS.EZCANCELFLAG                          = '0'
               GROUP BY
                   FSR.SVC_MACH_MSTR_PK
           ) C_RTR
           ,(
               SELECT
                   SVC_MACH_MSTR_PK
                  ,SUM(LA_AOT)           AS MLY_TOT_LBOR_AOT
                  ,SUM(TR_AOT)           AS MLY_TOT_TRVL_AOT
                  ,SUM(LA_AOT_NINST)     AS MLY_NI_LBOR_AOT
                  ,SUM(TR_AOT_NINST)     AS MLY_NI_TRVL_AOT
                  ,SUM(LA_AOT_NI_SCD)    AS MLY_NI_SCD_VISIT_LBOR_AOT
                  ,SUM(TR_AOT_NI_SCD)    AS MLY_NI_SCD_VISIT_TRVL_AOT
               FROM
                   (
                   SELECT
                       FSR.SVC_MACH_MSTR_PK
                      ,EVE.SVC_TM_EVENT_CD
                      ,CASE WHEN EVE.SVC_TM_EVENT_CD = #labor#  THEN SUM(ROUND((TO_DATE(SVC_TM_EVENT_TO_DT || SVC_TM_EVENT_TO_TM,'YYYYMMDDHH24MISS') - TO_DATE(SVC_TM_EVENT_FROM_DT || SVC_TM_EVENT_FROM_TM,'YYYYMMDDHH24MISS')) * 24 * 60 * 60)) END AS LA_AOT
                      ,CASE WHEN EVE.SVC_TM_EVENT_CD = #travel# THEN SUM(ROUND((TO_DATE(SVC_TM_EVENT_TO_DT || SVC_TM_EVENT_TO_TM,'YYYYMMDDHH24MISS') - TO_DATE(SVC_TM_EVENT_FROM_DT || SVC_TM_EVENT_FROM_TM,'YYYYMMDDHH24MISS')) * 24 * 60 * 60)) END AS TR_AOT
                      ,CASE WHEN EVE.SVC_TM_EVENT_CD = #labor#  AND FSR.FSR_TP_CD != #installCall# THEN SUM(ROUND((TO_DATE(SVC_TM_EVENT_TO_DT || SVC_TM_EVENT_TO_TM,'YYYYMMDDHH24MISS') - TO_DATE(SVC_TM_EVENT_FROM_DT || SVC_TM_EVENT_FROM_TM,'YYYYMMDDHH24MISS')) * 24 * 60 * 60)) END AS LA_AOT_NINST
                      ,CASE WHEN EVE.SVC_TM_EVENT_CD = #travel# AND FSR.FSR_TP_CD != #installCall# THEN SUM(ROUND((TO_DATE(SVC_TM_EVENT_TO_DT || SVC_TM_EVENT_TO_TM,'YYYYMMDDHH24MISS') - TO_DATE(SVC_TM_EVENT_FROM_DT || SVC_TM_EVENT_FROM_TM,'YYYYMMDDHH24MISS')) * 24 * 60 * 60)) END AS TR_AOT_NINST
                      ,CASE WHEN EVE.SVC_TM_EVENT_CD = #labor#  AND FSR.FSR_TP_CD != #installCall# AND TSK.FIRST_SVC_TASK_FLG = 'N' THEN SUM(ROUND((TO_DATE(SVC_TM_EVENT_TO_DT || SVC_TM_EVENT_TO_TM,'YYYYMMDDHH24MISS') - TO_DATE(SVC_TM_EVENT_FROM_DT || SVC_TM_EVENT_FROM_TM,'YYYYMMDDHH24MISS')) * 24 * 60 * 60)) END AS LA_AOT_NI_SCD
                      ,CASE WHEN EVE.SVC_TM_EVENT_CD = #travel# AND FSR.FSR_TP_CD != #installCall# AND TSK.FIRST_SVC_TASK_FLG = 'N' THEN SUM(ROUND((TO_DATE(SVC_TM_EVENT_TO_DT || SVC_TM_EVENT_TO_TM,'YYYYMMDDHH24MISS') - TO_DATE(SVC_TM_EVENT_FROM_DT || SVC_TM_EVENT_FROM_TM,'YYYYMMDDHH24MISS')) * 24 * 60 * 60)) END AS TR_AOT_NI_SCD
                   FROM
                       FSR                                FSR
                      ,FSR_VISIT_TASK                     FVT
                      ,SVC_TASK                           TSK
                      ,FSR_VISIT_TM_EVENT                 EVE
                   WHERE
                       FSR.GLBL_CMPY_CD                   = #glblCmpyCd#
                   AND SUBSTR(FSR.FSR_CLO_DT, 0, #ymLen#) = #trgtYrMth#
                   AND FSR.GLBL_CMPY_CD                   = FVT.GLBL_CMPY_CD
                   AND FSR.FSR_NUM                        = FVT.FSR_NUM
                   AND FVT.GLBL_CMPY_CD                   = TSK.GLBL_CMPY_CD
                   AND FVT.FSR_NUM                        = TSK.FSR_NUM
                   AND FVT.SVC_TASK_NUM                   = TSK.SVC_TASK_NUM
                   AND FVT.GLBL_CMPY_CD                   = EVE.GLBL_CMPY_CD
                   AND FVT.FSR_NUM                        = EVE.FSR_NUM
                   AND FVT.SVC_TASK_NUM                   = EVE.SVC_TASK_NUM
                   AND FVT.FSR_VISIT_NUM                  = EVE.FSR_VISIT_NUM
                   AND EVE.SVC_TM_EVENT_CD                IN (#labor#, #travel#)
                   AND FSR.EZCANCELFLAG                   = '0'
                   AND FVT.EZCANCELFLAG                   = '0'
                   AND TSK.EZCANCELFLAG                   = '0'
                   AND EVE.EZCANCELFLAG                   = '0'
                   GROUP BY FSR.SVC_MACH_MSTR_PK, EVE.SVC_TM_EVENT_CD, FSR.FSR_TP_CD, TSK.FIRST_SVC_TASK_FLG
                   )
               GROUP BY SVC_MACH_MSTR_PK
           ) M_AOT
           ,(
               SELECT
                   FSR.SVC_MACH_MSTR_PK
                  ,SUM(NVL(SUP.SVC_SUPPL_TM_NUM, 0)) * #timeAdj# AS MLY_TOT_ITRPT_AOT
                  ,SUM(CASE WHEN FSR.FSR_TP_CD != #installCall# THEN NVL(SUP.SVC_SUPPL_TM_NUM, 0) END ) * #timeAdj# AS MLY_NI_ITRPT_AOT
                  ,SUM(CASE WHEN FSR.FSR_TP_CD != #installCall# AND TSK.FIRST_SVC_TASK_FLG = 'N' THEN NVL(SUP.SVC_SUPPL_TM_NUM, 0) END ) * #timeAdj# AS MLY_NI_SCD_VISIT_ITRPT_AOT
               FROM
                   FSR                                FSR
                  ,FSR_VISIT_TASK                     FVT
                  ,SVC_TASK                           TSK
                  ,SVC_SUPPL_TASK                     SUP
                  ,SVC_SUPPL_TASK_TP                  STP
               WHERE
                   FSR.GLBL_CMPY_CD                   = #glblCmpyCd#
               AND SUBSTR(FSR.FSR_CLO_DT, 0, #ymLen#) = #trgtYrMth#
               AND FSR.GLBL_CMPY_CD                   = FVT.GLBL_CMPY_CD
               AND FSR.FSR_NUM                        = FVT.FSR_NUM
               AND FVT.GLBL_CMPY_CD                   = TSK.GLBL_CMPY_CD
               AND FVT.FSR_NUM                        = TSK.FSR_NUM
               AND FVT.SVC_TASK_NUM                   = TSK.SVC_TASK_NUM
               AND FVT.GLBL_CMPY_CD                   = SUP.GLBL_CMPY_CD
               AND FVT.FSR_NUM                        = SUP.FSR_NUM
               AND FVT.SVC_TASK_NUM                   = SUP.SVC_TASK_NUM
               AND SUP.SVC_SUPPL_TASK_TP_CD           != #meal2#
               AND SUP.GLBL_CMPY_CD                   = STP.GLBL_CMPY_CD
               AND SUP.SVC_SUPPL_TASK_TP_CD           = STP.SVC_SUPPL_TASK_TP_CD
               AND STP.SVC_ITRPT_FLG                  = 'Y'
               AND FSR.EZCANCELFLAG                   = '0'
               AND FVT.EZCANCELFLAG                   = '0'
               AND TSK.EZCANCELFLAG                   = '0'
               AND SUP.EZCANCELFLAG                   = '0'
               AND STP.EZCANCELFLAG                   = '0'
               GROUP BY FSR.SVC_MACH_MSTR_PK
           ) I_AOT
           ,(
               SELECT
                   SVC_MACH_MSTR_PK
                  ,SUM(NVL(FSR_TOT_PRT_COST_AMT, 0)) AS MLY_TOT_PRT_COST_AMT
                  ,SUM(NVL(FSR_NI_SCD_PRT_COST_AMT, 0)) AS MLY_NI_SCD_VISIT_PRT_CNT
               FROM (
                      SELECT
                          FSR.SVC_MACH_MSTR_PK
                         ,USG.MDSE_CD
                         ,NVL(USG.SVC_PRT_QTY, 0) * NVL(MDS.THIS_MTH_TOT_STD_COST_AMT, 0) AS FSR_TOT_PRT_COST_AMT
                         ,CASE WHEN FSR.FSR_TP_CD != #installCall# AND TSK.FIRST_SVC_TASK_FLG = 'N' THEN NVL(USG.SVC_PRT_QTY, 0) * NVL(MDS.THIS_MTH_TOT_STD_COST_AMT, 0) END AS FSR_NI_SCD_PRT_COST_AMT
                      FROM
                          FSR                                FSR
                         ,FSR_VISIT_TASK                     FVT
                         ,SVC_TASK                           TSK
                         ,FSR_USG                            USG
                         ,MDSE                               MDS
                      WHERE
                          FSR.GLBL_CMPY_CD                   = #glblCmpyCd#
                      AND SUBSTR(FSR.FSR_CLO_DT, 0, #ymLen#) = #trgtYrMth#
                      AND FSR.GLBL_CMPY_CD                   = FVT.GLBL_CMPY_CD
                      AND FSR.FSR_NUM                        = FVT.FSR_NUM
                      AND FVT.GLBL_CMPY_CD                   = TSK.GLBL_CMPY_CD
                      AND FVT.FSR_NUM                        = TSK.FSR_NUM
                      AND FVT.SVC_TASK_NUM                   = TSK.SVC_TASK_NUM
                      AND FVT.GLBL_CMPY_CD                   = USG.GLBL_CMPY_CD
                      AND FVT.FSR_NUM                        = USG.FSR_NUM
                      AND FVT.SVC_TASK_NUM                   = USG.SVC_TASK_NUM
                      AND FVT.FSR_VISIT_NUM                  = USG.FSR_VISIT_NUM
                      AND USG.GLBL_CMPY_CD                   = MDS.GLBL_CMPY_CD
                      AND USG.MDSE_CD                        = MDS.MDSE_CD
                      AND FSR.EZCANCELFLAG                   = '0'
                      AND FVT.EZCANCELFLAG                   = '0'
                      AND TSK.EZCANCELFLAG                   = '0'
                      AND USG.EZCANCELFLAG                   = '0'
                      AND MDS.EZCANCELFLAG                   = '0'
               )
               GROUP BY SVC_MACH_MSTR_PK
           ) U_AOT
           ,(
               SELECT
                   FSR.SVC_MACH_MSTR_PK
                  ,SUM(CASE WHEN FSR.FSR_TP_CD  = #installCall# THEN 1 ELSE 0 END) AS MLY_ISTL_VISIT_CNT
                  ,SUM(CASE WHEN FSR.FSR_TP_CD != #installCall# THEN 1 ELSE 0 END) AS MLY_NITL_VISIT_CNT
                  ,SUM(CASE WHEN FSR.FSR_TP_CD  = #installCall# AND TSK.FIRST_SVC_TASK_FLG = 'N' THEN 1 ELSE 0 END) AS MLY_ISTL_SCD_VISIT_CNT
                  ,SUM(CASE WHEN FSR.FSR_TP_CD != #installCall# AND TSK.FIRST_SVC_TASK_FLG = 'N' THEN 1 ELSE 0 END) AS MLY_NISTL_SCD_VISIT_CNT
               FROM
                   FSR                 FSR
                  ,FSR_VISIT_TASK      FVT
                  ,SVC_TASK            TSK
                  ,FSR_VISIT           VIS
               WHERE
                   FSR.GLBL_CMPY_CD                    = #glblCmpyCd#
               AND SUBSTR(FSR.FSR_CLO_DT, 0, #ymLen#)  = #trgtYrMth#
               AND FSR.GLBL_CMPY_CD                    = FVT.GLBL_CMPY_CD
               AND FSR.FSR_NUM                         = FVT.FSR_NUM
               AND FVT.GLBL_CMPY_CD                    = TSK.GLBL_CMPY_CD
               AND FVT.FSR_NUM                         = TSK.FSR_NUM
               AND FVT.SVC_TASK_NUM                    = TSK.SVC_TASK_NUM
               AND FVT.GLBL_CMPY_CD                    = VIS.GLBL_CMPY_CD
               AND FVT.FSR_NUM                         = VIS.FSR_NUM
               AND FVT.FSR_VISIT_NUM                   = VIS.FSR_VISIT_NUM
               AND FSR.EZCANCELFLAG                    = '0'
               AND FVT.EZCANCELFLAG                    = '0'
               AND TSK.EZCANCELFLAG                    = '0'
               AND VIS.EZCANCELFLAG                    = '0'
               GROUP BY
                   FSR.SVC_MACH_MSTR_PK
           ) C_CLVIS
           ,(
               SELECT
                   FSR.SVC_MACH_MSTR_PK
                  ,SUM(CHG.SVC_LBOR_DEAL_AMT)      AS SVC_LBOR_DEAL_AMT
                  ,SUM(CHG.SVC_LBOR_FUNC_AMT)      AS SVC_LBOR_FUNC_AMT
                  ,SUM(CHG.SVC_LBOR_DEAL_DISC_AMT) AS SVC_LBOR_DEAL_DISC_AMT
                  ,SUM(CHG.SVC_LBOR_FUNC_DISC_AMT) AS SVC_LBOR_FUNC_DISC_AMT
                  ,SUM(CHG.SVC_TRVL_DEAL_AMT)      AS SVC_TRVL_DEAL_AMT
                  ,SUM(CHG.SVC_TRVL_FUNC_AMT)      AS SVC_TRVL_FUNC_AMT
                  ,SUM(CHG.SVC_TRVL_DEAL_DISC_AMT) AS SVC_TRVL_DEAL_DISC_AMT
                  ,SUM(CHG.SVC_TRVL_FUNC_DISC_AMT) AS SVC_TRVL_FUNC_DISC_AMT
                  ,SUM(CHG.SVC_PRT_DEAL_AMT)       AS SVC_PRT_DEAL_AMT
                  ,SUM(CHG.SVC_PRT_FUNC_AMT)       AS SVC_PRT_FUNC_AMT
                  ,SUM(CHG.SVC_PRT_DEAL_DISC_AMT)  AS SVC_PRT_DEAL_DISC_AMT
                  ,SUM(CHG.SVC_PRT_FUNC_DISC_AMT)  AS SVC_PRT_FUNC_DISC_AMT
               FROM
                   FSR                 FSR
                  ,FSR_CHRG            CHG
               WHERE
                   FSR.GLBL_CMPY_CD                    = #glblCmpyCd#
               AND SUBSTR(FSR.FSR_CLO_DT, 0, #ymLen#)  = #trgtYrMth#
               AND FSR.GLBL_CMPY_CD                    = CHG.GLBL_CMPY_CD
               AND FSR.FSR_NUM                         = CHG.FSR_NUM
               AND FSR.EZCANCELFLAG                    = '0'
               AND CHG.EZCANCELFLAG                    = '0'
               GROUP BY
                   FSR.SVC_MACH_MSTR_PK
           ) CHG
           ,(
               SELECT
                   SVC_MACH_MSTR_PK
                  ,CASE WHEN SUM(TL_CNT) != 0 THEN SUM(TL_CNT) ELSE SUM(BW_CNT) + SUM(CL_CNT) END AS PREV_READ_MTR_CNT
               FROM
                  (
                   SELECT DISTINCT
                       MTR.SVC_MACH_MSTR_PK
                      ,CASE WHEN LB.BW_MTR_FLG    = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS BW_CNT
                      ,CASE WHEN LB.COLOR_MTR_FLG = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS CL_CNT
                      ,CASE WHEN LB.TOT_MTR_FLG   = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS TL_CNT
                   FROM
                       SVC_PHYS_MTR_READ             MTR
                      ,MTR_LB                        LB
                      ,FSR                           FSR
                      ,(
                       SELECT
                           MTR.SVC_MACH_MSTR_PK
                          ,MAX(RGTN_MTR_DT)          AS RGTN_MTR_DT
                       FROM
                           SVC_PHYS_MTR_READ         MTR
                       WHERE
                           MTR.GLBL_CMPY_CD                    = #glblCmpyCd#
                       AND SUBSTR(MTR.RGTN_MTR_DT, 0, #ymLen#) &lt; #trgtYrMth#
                       <!-- START QC#28592 2018/10/11 [ADD]-->
                       AND MTR.VLD_MTR_FLG                     = 'Y'
                       <!-- END   QC#28592 2018/10/11 [ADD]-->
                       AND MTR.EZCANCELFLAG                    = '0'
                       GROUP BY
                           MTR.SVC_MACH_MSTR_PK
                       ) MTR_WK
                   WHERE
                       MTR.GLBL_CMPY_CD              = #glblCmpyCd#
                   AND MTR.TEST_MTR_CNT              = 0
                   AND MTR.FSR_NUM                   IS NOT NULL
                   AND MTR.FSR_VISIT_NUM             IS NOT NULL
                   AND MTR.GLBL_CMPY_CD              = LB.GLBL_CMPY_CD
                   AND MTR.MTR_LB_CD                 = LB.MTR_LB_CD
                   AND MTR.SVC_MACH_MSTR_PK          = MTR_WK.SVC_MACH_MSTR_PK
                   AND MTR.RGTN_MTR_DT               = MTR_WK.RGTN_MTR_DT
                   AND MTR.GLBL_CMPY_CD              = FSR.GLBL_CMPY_CD
                   AND MTR.FSR_NUM                   = FSR.FSR_NUM
                   AND FSR.FSR_TP_CD                != #installCall#
                   <!-- START QC#28592 2018/10/11 [ADD]-->
                   AND MTR.VLD_MTR_FLG               = 'Y'
                   <!-- END   QC#28592 2018/10/11 [ADD]-->
                   AND MTR.EZCANCELFLAG              = '0'
                   AND LB.EZCANCELFLAG               = '0'
                   AND FSR.EZCANCELFLAG              = '0'
                  )
               GROUP BY 
                   SVC_MACH_MSTR_PK
           ) P_MTR
           ,(
               SELECT
                   SVC_MACH_MSTR_PK
                  ,RGTN_MTR_DT
                  ,CASE WHEN SUM(TL_CNT) != 0 THEN SUM(TL_CNT) ELSE SUM(BW_CNT) + SUM(CL_CNT) END AS LTST_READ_MTR_CNT
               FROM
                  (
                   SELECT DISTINCT
                       MTR.SVC_MACH_MSTR_PK
                      ,MTR.RGTN_MTR_DT
                      ,CASE WHEN LB.BW_MTR_FLG    = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS BW_CNT
                      ,CASE WHEN LB.COLOR_MTR_FLG = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS CL_CNT
                      ,CASE WHEN LB.TOT_MTR_FLG   = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS TL_CNT
                   FROM
                       SVC_PHYS_MTR_READ             MTR
                      ,MTR_LB                        LB
                      ,FSR                           FSR
                      ,(
                       SELECT
                           MTR.SVC_MACH_MSTR_PK
                          ,MAX(RGTN_MTR_DT)          AS RGTN_MTR_DT
                       FROM
                           SVC_PHYS_MTR_READ         MTR
                       WHERE
                           MTR.GLBL_CMPY_CD                = #glblCmpyCd#
                       AND SUBSTR(RGTN_MTR_DT, 0, #ymLen#) = #trgtYrMth#
                       <!-- START QC#28592 2018/10/11 [ADD]-->
                       AND MTR.VLD_MTR_FLG                 = 'Y'
                       <!-- END   QC#28592 2018/10/11 [ADD]-->
                       AND MTR.EZCANCELFLAG                = '0'
                       GROUP BY
                           MTR.SVC_MACH_MSTR_PK
                       ) MTR_WK
                   WHERE
                       MTR.GLBL_CMPY_CD              = #glblCmpyCd#
                   AND MTR.TEST_MTR_CNT              = 0
                   AND MTR.FSR_NUM                   IS NOT NULL
                   AND MTR.FSR_VISIT_NUM             IS NOT NULL
                   AND MTR.GLBL_CMPY_CD              = LB.GLBL_CMPY_CD
                   AND MTR.MTR_LB_CD                 = LB.MTR_LB_CD
                   AND MTR.SVC_MACH_MSTR_PK          = MTR_WK.SVC_MACH_MSTR_PK
                   AND MTR.RGTN_MTR_DT               = MTR_WK.RGTN_MTR_DT
                   AND MTR.GLBL_CMPY_CD              = FSR.GLBL_CMPY_CD
                   AND MTR.FSR_NUM                   = FSR.FSR_NUM
                   AND FSR.FSR_TP_CD                != #installCall#
                   <!-- START QC#28592 2018/10/11 [ADD]-->
                   AND MTR.VLD_MTR_FLG               = 'Y'
                   <!-- END   QC#28592 2018/10/11 [ADD]-->
                   AND MTR.EZCANCELFLAG              = '0'
                   AND LB.EZCANCELFLAG               = '0'
                   AND FSR.EZCANCELFLAG              = '0'
                  )
               GROUP BY
                   SVC_MACH_MSTR_PK, RGTN_MTR_DT
           ) L_MTR
           ,(
               SELECT
                   MTR.SVC_MACH_MSTR_PK
                  ,MTR.RGTN_MTR_DT
                  ,MTR.SVC_INV_NUM
                  ,MTR.INV_DT
                  ,INV.CHRG_COPY_VOL
               FROM
                   SVC_PHYS_MTR_READ MTR
                 ,(
                   SELECT
                       INV.SVC_INV_NUM
                      ,SUM(INV.BLLG_COPY_QTY) AS CHRG_COPY_VOL
                   FROM
                       SVC_INV_LINE_MTR              INV
                   WHERE
                       INV.GLBL_CMPY_CD              = #glblCmpyCd#
                   AND INV.EZCANCELFLAG              = '0'
                   GROUP BY
                       INV.SVC_INV_NUM
                  ) INV
                   WHERE
                       MTR.GLBL_CMPY_CD              = #glblCmpyCd#
                   AND MTR.TEST_MTR_CNT              = 0
                   AND MTR.FSR_NUM                   IS NOT NULL
                   AND MTR.FSR_VISIT_NUM             IS NOT NULL
                   AND MTR.SVC_INV_NUM               = INV.SVC_INV_NUM
                   <!-- START QC#28592 2018/10/11 [ADD]-->
                   AND MTR.VLD_MTR_FLG               = 'Y'
                   <!-- END   QC#28592 2018/10/11 [ADD]-->
                   AND MTR.EZCANCELFLAG              = '0'
            ) INV
           ,(
               SELECT
                   SVC_MACH_MSTR_PK
                  ,CASE WHEN SUM(TL_CNT) != 0 THEN SUM(TL_CNT) ELSE SUM(BW_CNT) + SUM(CL_CNT) END AS READ_MTR_CNT
               FROM
                  (
                   SELECT DISTINCT
                       MTR.SVC_MACH_MSTR_PK
                      ,CASE WHEN LB.BW_MTR_FLG    = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS BW_CNT
                      ,CASE WHEN LB.COLOR_MTR_FLG = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS CL_CNT
                      ,CASE WHEN LB.TOT_MTR_FLG   = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS TL_CNT
                   FROM
                       SVC_PHYS_MTR_READ             MTR
                      ,MTR_LB                        LB
                      ,FSR                           FSR
                      ,(
                       SELECT
                           MTR.SVC_MACH_MSTR_PK
                          ,MIN(MTR.RGTN_MTR_DT)      AS RGTN_MTR_DT
                       FROM
                           SVC_PHYS_MTR_READ         MTR
                       WHERE
                           MTR.GLBL_CMPY_CD                    = #glblCmpyCd#
                       AND SUBSTR(MTR.RGTN_MTR_DT, 0, #ymLen#) &lt;= #trgtYrMth#
                       AND SUBSTR(MTR.RGTN_MTR_DT, 0, #ymLen#) &gt;= TO_CHAR(ADD_MONTHS(TO_DATE(#trgtYrMth#, 'YYYYMM'), - #threeMth#), 'YYYYMM')
                       AND MTR.EZCANCELFLAG                    = '0'
                       <!-- START QC#28592 2018/10/11 [ADD]-->
                       AND MTR.VLD_MTR_FLG                     = 'Y'
                       <!-- END   QC#28592 2018/10/11 [ADD]-->
                       GROUP BY
                           MTR.SVC_MACH_MSTR_PK
                       ) MTR_WK
                   WHERE
                       MTR.GLBL_CMPY_CD              = #glblCmpyCd#
                   AND MTR.TEST_MTR_CNT              = 0
                   AND MTR.FSR_NUM                   IS NOT NULL
                   AND MTR.FSR_VISIT_NUM             IS NOT NULL
                   AND MTR.GLBL_CMPY_CD              = LB.GLBL_CMPY_CD
                   AND MTR.MTR_LB_CD                 = LB.MTR_LB_CD
                   AND MTR.SVC_MACH_MSTR_PK          = MTR_WK.SVC_MACH_MSTR_PK
                   AND MTR.RGTN_MTR_DT               = MTR_WK.RGTN_MTR_DT
                   AND MTR.GLBL_CMPY_CD              = FSR.GLBL_CMPY_CD
                   AND MTR.FSR_NUM                   = FSR.FSR_NUM
                   AND FSR.FSR_TP_CD                != #installCall#
                   <!-- START QC#28592 2018/10/11 [ADD]-->
                   AND MTR.VLD_MTR_FLG               = 'Y'
                   <!-- END   QC#28592 2018/10/11 [ADD]-->
                   AND MTR.EZCANCELFLAG              = '0'
                   AND LB.EZCANCELFLAG               = '0'
                   AND FSR.EZCANCELFLAG              = '0'
                  )
               GROUP BY 
                   SVC_MACH_MSTR_PK
           ) MTR_03
           ,(
               SELECT
                   SVC_MACH_MSTR_PK
                  ,CASE WHEN SUM(TL_CNT) != 0 THEN SUM(TL_CNT) ELSE SUM(BW_CNT) + SUM(CL_CNT) END AS READ_MTR_CNT
               FROM
                  (
                   SELECT DISTINCT
                       MTR.SVC_MACH_MSTR_PK
                      ,CASE WHEN LB.BW_MTR_FLG    = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS BW_CNT
                      ,CASE WHEN LB.COLOR_MTR_FLG = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS CL_CNT
                      ,CASE WHEN LB.TOT_MTR_FLG   = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS TL_CNT
                   FROM
                       SVC_PHYS_MTR_READ             MTR
                      ,MTR_LB                        LB
                      ,FSR                           FSR
                      ,(
                       SELECT
                           MTR.SVC_MACH_MSTR_PK
                          ,MIN(MTR.RGTN_MTR_DT)      AS RGTN_MTR_DT
                       FROM
                           SVC_PHYS_MTR_READ         MTR
                       WHERE
                           MTR.GLBL_CMPY_CD                    = #glblCmpyCd#
                       AND SUBSTR(MTR.RGTN_MTR_DT, 0, #ymLen#) &lt;= #trgtYrMth#
                       AND SUBSTR(MTR.RGTN_MTR_DT, 0, #ymLen#) &gt;= TO_CHAR(ADD_MONTHS(TO_DATE(#trgtYrMth#, 'YYYYMM'), - #sixMth#), 'YYYYMM')
                       <!-- START QC#28592 2018/10/11 [ADD]-->
                       AND MTR.VLD_MTR_FLG                     = 'Y'
                       <!-- END   QC#28592 2018/10/11 [ADD]-->
                       AND MTR.EZCANCELFLAG                    = '0'
                       GROUP BY
                           MTR.SVC_MACH_MSTR_PK
                       ) MTR_WK
                   WHERE
                       MTR.GLBL_CMPY_CD              = #glblCmpyCd#
                   AND MTR.TEST_MTR_CNT              = 0
                   AND MTR.FSR_NUM                   IS NOT NULL
                   AND MTR.FSR_VISIT_NUM             IS NOT NULL
                   AND MTR.GLBL_CMPY_CD              = LB.GLBL_CMPY_CD
                   AND MTR.MTR_LB_CD                 = LB.MTR_LB_CD
                   AND MTR.SVC_MACH_MSTR_PK          = MTR_WK.SVC_MACH_MSTR_PK
                   AND MTR.RGTN_MTR_DT               = MTR_WK.RGTN_MTR_DT
                   AND MTR.GLBL_CMPY_CD              = FSR.GLBL_CMPY_CD
                   AND MTR.FSR_NUM                   = FSR.FSR_NUM
                   <!-- START QC#28592 2018/10/11 [ADD]-->
                   AND MTR.VLD_MTR_FLG               = 'Y'
                   <!-- END   QC#28592 2018/10/11 [ADD]-->
                   AND FSR.FSR_TP_CD                != #installCall#
                   AND MTR.EZCANCELFLAG              = '0'
                   AND LB.EZCANCELFLAG               = '0'
                   AND FSR.EZCANCELFLAG              = '0'
                  )
               GROUP BY 
                   SVC_MACH_MSTR_PK
           ) MTR_06
           ,(
               SELECT
                   SVC_MACH_MSTR_PK
                  ,CASE WHEN SUM(TL_CNT) = 0 THEN SUM(BW_CNT) + SUM(CL_CNT) ELSE SUM(TL_CNT) END AS READ_MTR_CNT
               FROM
                  (
                   SELECT DISTINCT
                       MTR.SVC_MACH_MSTR_PK
                      ,CASE WHEN LB.BW_MTR_FLG    = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS BW_CNT
                      ,CASE WHEN LB.COLOR_MTR_FLG = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS CL_CNT
                      ,CASE WHEN LB.TOT_MTR_FLG   = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS TL_CNT
                   FROM
                       SVC_PHYS_MTR_READ             MTR
                      ,MTR_LB                        LB
                      ,FSR                           FSR
                      ,(
                       SELECT
                           MTR.SVC_MACH_MSTR_PK
                          ,MIN(MTR.RGTN_MTR_DT)      AS RGTN_MTR_DT
                       FROM
                           SVC_PHYS_MTR_READ         MTR
                       WHERE
                           MTR.GLBL_CMPY_CD                    = #glblCmpyCd#
                       AND SUBSTR(MTR.RGTN_MTR_DT, 0, #ymLen#) &lt;= #trgtYrMth#
                       AND SUBSTR(MTR.RGTN_MTR_DT, 0, #ymLen#) &gt;= TO_CHAR(ADD_MONTHS(TO_DATE(#trgtYrMth#, 'YYYYMM'), - #twelveMth#), 'YYYYMM')
                       AND MTR.EZCANCELFLAG                    = '0'
                       <!-- START QC#28592 2018/10/11 [ADD]-->
                       AND MTR.VLD_MTR_FLG                     = 'Y'
                       <!-- END   QC#28592 2018/10/11 [ADD]-->
                       GROUP BY
                           MTR.SVC_MACH_MSTR_PK
                       ) MTR_WK
                   WHERE
                       MTR.GLBL_CMPY_CD              = #glblCmpyCd#
                   AND MTR.TEST_MTR_CNT              = 0
                   AND MTR.FSR_NUM                   IS NOT NULL
                   AND MTR.FSR_VISIT_NUM             IS NOT NULL
                   AND MTR.GLBL_CMPY_CD              = LB.GLBL_CMPY_CD
                   AND MTR.MTR_LB_CD                 = LB.MTR_LB_CD
                   AND MTR.SVC_MACH_MSTR_PK          = MTR_WK.SVC_MACH_MSTR_PK
                   AND MTR.RGTN_MTR_DT               = MTR_WK.RGTN_MTR_DT
                   AND MTR.GLBL_CMPY_CD              = FSR.GLBL_CMPY_CD
                   AND MTR.FSR_NUM                   = FSR.FSR_NUM
                   AND FSR.FSR_TP_CD                != #installCall#
                   <!-- START QC#28592 2018/10/11 [ADD]-->
                   AND MTR.VLD_MTR_FLG               = 'Y'
                   <!-- END   QC#28592 2018/10/11 [ADD]-->
                   AND MTR.EZCANCELFLAG              = '0'
                   AND LB.EZCANCELFLAG               = '0'
                   AND FSR.EZCANCELFLAG              = '0'
                  )
               GROUP BY 
                   SVC_MACH_MSTR_PK
           ) MTR_12
        WHERE
            MAC.GLBL_CMPY_CD                = #glblCmpyCd#
        AND MAC.SVC_MACH_MSTR_PK            = FSR.SVC_MACH_MSTR_PK
        AND MAC.SER_NUM                     = FSR.SER_NUM
        AND MAC.SVC_MACH_MSTR_PK            = MDL_1.SVC_MACH_MSTR_PK(+)
        AND MAC.SVC_MACH_MSTR_PK            = MDL_2.SVC_MACH_MSTR_PK(+)
        AND MAC.SVC_MACH_MSTR_PK            = COA.SVC_MACH_MSTR_PK(+)
        AND MAC.SVC_MACH_MSTR_PK            = T_FLG.SVC_MACH_MSTR_PK(+)
        AND MAC.SVC_MACH_MSTR_PK            = P_MTR.SVC_MACH_MSTR_PK(+)
        AND MAC.SVC_MACH_MSTR_PK            = L_MTR.SVC_MACH_MSTR_PK(+)
        AND L_MTR.SVC_MACH_MSTR_PK          = INV.SVC_MACH_MSTR_PK(+)
        AND L_MTR.RGTN_MTR_DT               = INV.RGTN_MTR_DT(+)
        AND MAC.SVC_MACH_MSTR_PK            = C_FSR.SVC_MACH_MSTR_PK(+)
        AND MAC.SVC_MACH_MSTR_PK            = C_RTR.SVC_MACH_MSTR_PK(+)
        AND MAC.SVC_BY_LINE_BIZ_TP_CD       = CST.RPT_COND_CONST_CD(+)
        AND CST.RPT_COND_CONST_GRP_ID(+)    = #laborRate#
        AND MAC.SVC_MACH_MSTR_PK            = M_AOT.SVC_MACH_MSTR_PK(+)
        AND MAC.SVC_MACH_MSTR_PK            = I_AOT.SVC_MACH_MSTR_PK(+)
        AND MAC.SVC_MACH_MSTR_PK            = U_AOT.SVC_MACH_MSTR_PK(+)
        AND MAC.SVC_MACH_MSTR_PK            = C_CLVIS.SVC_MACH_MSTR_PK(+)
        AND MAC.SVC_MACH_MSTR_PK            = CHG.SVC_MACH_MSTR_PK(+)
        AND MAC.SVC_MACH_MSTR_PK            = C_VIS.SVC_MACH_MSTR_PK(+)
        AND MAC.SVC_MACH_MSTR_PK            = MTR_03.SVC_MACH_MSTR_PK(+)
        AND MAC.SVC_MACH_MSTR_PK            = MTR_06.SVC_MACH_MSTR_PK(+)
        AND MAC.SVC_MACH_MSTR_PK            = MTR_12.SVC_MACH_MSTR_PK(+)
        AND MAC.EZCANCELFLAG                = '0'
        AND CST.EZCANCELFLAG(+)             = '0'
        UNION ALL
        -- Tech Level Data
        SELECT
            FSR.SVC_MACH_MSTR_PK                               AS SVC_MACH_MSTR_PK
           ,FSR.TECH_CD                                        AS TECH_CD
           ,MAC.SVC_CONFIG_MSTR_PK                             AS SVC_CONFIG_MSTR_PK
           ,MAC.SVC_BY_LINE_BIZ_TP_CD                          AS SVC_BY_LINE_BIZ_TP_CD
           ,NVL(MDL_1.MDL_ID, MDL_2.MDL_ID)                    AS MDL_ID
           ,FSR.SER_NUM                                        AS SER_NUM
           ,COA.COPR_MACH_FLG                                  AS COPR_MACH_FLG
           ,NVL(T_FLG.TM_AND_MAT_FLG, 'Y')                     AS TM_AND_MAT_FLG
           ,0                                                  AS PREV_READ_MTR_CNT
           ,NVL(L_MTR.LTST_READ_MTR_CNT, 0)                    AS LTST_READ_MTR_CNT
           ,0                                                  AS MLY_COPY_VOL
           ,CASE WHEN NVL(T_FLG.TM_AND_MAT_FLG, 'Y') = 'Y' THEN NULL ELSE INV.SVC_INV_NUM END AS SVC_INV_NUM
           ,CASE WHEN NVL(T_FLG.TM_AND_MAT_FLG, 'Y') = 'Y' THEN NULL ELSE INV.INV_DT      END AS INV_DT
           ,0                                                  AS CHRG_COPY_VOL
           ,NVL(C_FSR.MLY_TOT_FSR_CNT, 0)                      AS MLY_TOT_FSR_CNT
           ,NVL(C_FSR.MLY_TOT_CM_CNT, 0)                       AS MLY_TOT_CM_CNT
           ,NVL(C_VIS.MLY_TOT_VISIT_CNT, 0)                    AS MLY_TOT_VISIT_CNT
           ,NVL(C_VIS.MLY_TOT_RTRN_VISIT_CNT, 0)               AS MLY_TOT_RTRN_VISIT_CNT
           ,TRUNC(NVL(C_VIS.MLY_TOT_RTRN_VISIT_CNT, 0) / NVL(C_VIS.MLY_TOT_VISIT_CNT, 1), #secPeriod#) * 100 AS SCD_VISIT_RATIO
           ,NVL(CST.RPT_COND_CONST_VAL_NUM_02, 0)              AS SVC_AVG_TRVL_AOT
           ,NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0)              AS SVC_LBOR_COST_UNIT_AMT
           ,NVL(M_AOT.MLY_TOT_TRVL_AOT, 0)                     AS MLY_TOT_TRVL_AOT
           ,NVL(M_AOT.MLY_TOT_LBOR_AOT, 0)                     AS MLY_TOT_LBOR_AOT
           ,NVL(I_AOT.MLY_TOT_ITRPT_AOT, 0)                    AS MLY_TOT_ITRPT_AOT
           ,TRUNC(NVL(M_AOT.MLY_TOT_TRVL_AOT,  0)/(#timeAdj# * #timeAdj#), #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0) AS MLY_TOT_TRVL_COST_AMT
           ,TRUNC(NVL(M_AOT.MLY_TOT_LBOR_AOT,  0)/(#timeAdj# * #timeAdj#), #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0) AS MLY_TOT_LBOR_COST_AMT
           ,TRUNC(NVL(I_AOT.MLY_TOT_ITRPT_AOT, 0)/(#timeAdj# * #timeAdj#), #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0) AS MLY_TOT_ITRPT_COST_AMT
           ,NVL(U_AOT.MLY_TOT_PRT_COST_AMT, 0)                 AS MLY_TOT_PRT_COST_AMT
           ,(TRUNC(NVL(M_AOT.MLY_TOT_TRVL_AOT,  0)/(#timeAdj# * #timeAdj#), #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0))
           +(TRUNC(NVL(M_AOT.MLY_TOT_LBOR_AOT,  0)/(#timeAdj# * #timeAdj#), #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0))
           +(TRUNC(NVL(I_AOT.MLY_TOT_ITRPT_AOT, 0)/(#timeAdj# * #timeAdj#), #secPeriod#) * NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0))
           + NVL(U_AOT.MLY_TOT_PRT_COST_AMT, 0)                AS MLY_TOT_COST_AMT
           ,NVL(C_CLVIS.MLY_NITL_VISIT_CNT, 0)                 AS MLY_NI_VISIT_CNT
           ,NVL(M_AOT.MLY_NI_LBOR_AOT, 0)                      AS MLY_NI_LBOR_AOT
           ,NVL(M_AOT.MLY_NI_TRVL_AOT, 0)                      AS MLY_NI_TRVL_AOT
           ,NVL(I_AOT.MLY_NI_ITRPT_AOT, 0)                     AS MLY_NI_ITRPT_AOT
           ,NVL(C_CLVIS.MLY_NISTL_SCD_VISIT_CNT, 0)             AS MLY_NI_SCD_VISIT_CNT
           ,NVL(M_AOT.MLY_NI_SCD_VISIT_TRVL_AOT, 0)            AS MLY_NI_SCD_VISIT_TRVL_AOT
           ,NVL(M_AOT.MLY_NI_SCD_VISIT_LBOR_AOT, 0)            AS MLY_NI_SCD_VISIT_LBOR_AOT
           ,NVL(I_AOT.MLY_NI_SCD_VISIT_ITRPT_AOT, 0)           AS MLY_NI_SCD_VISIT_ITRPT_AOT
           ,NVL(U_AOT.MLY_NI_SCD_VISIT_PRT_CNT, 0)             AS MLY_NI_SCD_VISIT_PRT_CNT
           ,NVL(C_CLVIS.MLY_ISTL_VISIT_CNT, 0)                 AS MLY_ISTL_VISIT_CNT
           ,NVL(C_CLVIS.MLY_ISTL_SCD_VISIT_CNT, 0)             AS MLY_ISTL_SCD_VISIT_CNT
           ,NVL(U_AOT.MLY_TOT_PRT_COST_AMT
           *TRUNC(TRUNC((LAST_DAY(TO_DATE(#trgtYrMth#, 'YYYYMM'))
                                - TO_DATE(MAC.ISTL_DT, 'YYYYMMDD'))
                                / TO_CHAR(LAST_DAY(TO_DATE(#trgtYrMth#, 'YYYYMM')), 'DD'), #secPeriod#)
                                / 12, #secPeriod#), 0)         AS CNF_YR_PRT_COST_AMT
           ,NULL                                               AS SVC_LBOR_DEAL_AMT
           ,NULL                                               AS SVC_LBOR_FUNC_AMT
           ,NULL                                               AS SVC_LBOR_DEAL_DISC_AMT
           ,NULL                                               AS SVC_LBOR_FUNC_DISC_AMT
           ,NULL                                               AS SVC_TRVL_DEAL_AMT
           ,NULL                                               AS SVC_TRVL_FUNC_AMT
           ,NULL                                               AS SVC_TRVL_DEAL_DISC_AMT
           ,NULL                                               AS SVC_TRVL_FUNC_DISC_AMT
           ,NULL                                               AS SVC_PRT_DEAL_AMT
           ,NULL                                               AS SVC_PRT_FUNC_AMT
           ,NULL                                               AS SVC_PRT_DEAL_DISC_AMT
           ,NULL                                               AS SVC_PRT_FUNC_DISC_AMT
           ,NVL(TRUNC(U_AOT.MLY_TOT_PRT_COST_AMT/ 1000, #secPeriod#), 0) AS K_CLICK_PRT_COST_AMT
           ,0                                                  AS TOT_VISIT_CNT_01
           ,0                                                  AS TOT_CM_CNT_01
           ,0                                                  AS TOT_MTR_VOL_01
           ,0                                                  AS TOT_VISIT_CNT_03
           ,0                                                  AS TOT_CM_CNT_03
           ,0                                                  AS TOT_MTR_VOL_03
           ,0                                                  AS TOT_VISIT_CNT_06
           ,0                                                  AS TOT_CM_CNT_06
           ,0                                                  AS TOT_MTR_VOL_06
           ,0                                                  AS TOT_VISIT_CNT_12
           ,0                                                  AS TOT_CM_CNT_12
           ,0                                                  AS TOT_MTR_VOL_12
           ,L_MTR.RGTN_MTR_DT                                  AS RGTN_MTR_DT
        FROM
            SVC_MACH_MSTR              MAC
           ,RPT_COND_CONST             CST
           ,(
               SELECT DISTINCT
                   FSR.SVC_MACH_MSTR_PK
                  ,FSR.SER_NUM
                  ,VIS.TECH_CD
               FROM
                   FSR                 FSR
                  ,FSR_VISIT           VIS
                 ,(
                   SELECT
                       FSR.SVC_MACH_MSTR_PK
                      ,MAX(FSR.FSR_CLO_DT) AS FSR_CLO_DT
                   FROM
                       FSR                 FSR
                   WHERE
                       FSR.GLBL_CMPY_CD                   = #glblCmpyCd#
                   AND SUBSTR(FSR.FSR_CLO_DT, 0, #ymLen#) = #trgtYrMth#
                   AND FSR.EZCANCELFLAG                   = '0'
                   GROUP BY FSR.SVC_MACH_MSTR_PK
                  ) MAX_FSR
               WHERE
                   FSR.GLBL_CMPY_CD                   = #glblCmpyCd#
               AND FSR.SVC_MACH_MSTR_PK               = MAX_FSR.SVC_MACH_MSTR_PK
               AND FSR.FSR_CLO_DT                     = MAX_FSR.FSR_CLO_DT
               AND FSR.GLBL_CMPY_CD                   = VIS.GLBL_CMPY_CD
               AND FSR.FSR_NUM                        = VIS.FSR_NUM
               AND VIS.EZCANCELFLAG                   = '0'
               AND FSR.EZCANCELFLAG                   = '0'
           ) FSR
           ,(
               SELECT 
                   MAC.SVC_MACH_MSTR_PK
                  ,MDL.MDL_ID
               FROM
                   SVC_MACH_MSTR               MAC
                  ,SVC_CONFIG_MSTR             CON
                  ,DS_MDL                      MDL
               WHERE
                   MAC.GLBL_CMPY_CD            = #glblCmpyCd#
               AND MAC.GLBL_CMPY_CD            = CON.GLBL_CMPY_CD
               AND MAC.SVC_CONFIG_MSTR_PK      = CON.SVC_CONFIG_MSTR_PK
               AND CON.GLBL_CMPY_CD            = MDL.GLBL_CMPY_CD
               AND CON.MDL_ID                  = MDL.MDL_ID
               AND MAC.EZCANCELFLAG            = '0'
               AND CON.EZCANCELFLAG            = '0'
               AND MDL.EZCANCELFLAG            = '0'
           ) MDL_1
           ,(
               SELECT 
                   SVC_MACH_MSTR_PK
                  ,MDL_ID
               FROM
                   (
                   SELECT
                       MAC.SVC_MACH_MSTR_PK
                      ,ROW_NUMBER() OVER(PARTITION BY MAC.SVC_MACH_MSTR_PK ORDER BY SVC_CONFIG_MSTR_DTL_PK DESC) ROW_NUM
                      ,MDL.MDL_ID
                   FROM
                       SVC_MACH_MSTR               MAC
                      ,SVC_CONFIG_MSTR_DTL         CON
                      ,DS_MDL                      MDL
                   WHERE
                       MAC.GLBL_CMPY_CD            = #glblCmpyCd#
                   AND MAC.GLBL_CMPY_CD            = CON.GLBL_CMPY_CD
                   AND MAC.SVC_MACH_MSTR_PK        = CON.SVC_MACH_MSTR_PK
                   AND CON.GLBL_CMPY_CD            = MDL.GLBL_CMPY_CD
                   AND CON.MDL_ID                  = MDL.MDL_ID
                   AND MAC.EZCANCELFLAG            = '0'
                   AND CON.EZCANCELFLAG            = '0'
                   AND MDL.EZCANCELFLAG            = '0'
                   )
               WHERE ROW_NUM = 1
           ) MDL_2
           ,(
               SELECT
                   MAC.SVC_MACH_MSTR_PK
                  ,CASE WHEN UPPER(COA.COA_PROD_NM) LIKE #copier# THEN 'Y' ELSE 'N' END AS COPR_MACH_FLG
               FROM
                   SVC_MACH_MSTR           MAC
                  ,MDSE                    MDS
                  ,COA_PROD                COA
               WHERE
                   MAC.GLBL_CMPY_CD        = #glblCmpyCd#
               AND MAC.GLBL_CMPY_CD        = MDS.GLBL_CMPY_CD
               AND MAC.MDSE_CD             = MDS.MDSE_CD
               AND MDS.GLBL_CMPY_CD        = COA.GLBL_CMPY_CD
               AND MDS.COA_PROD_CD         = COA.COA_PROD_CD
               AND MAC.EZCANCELFLAG        = '0'
               AND MDS.EZCANCELFLAG        = '0'
               AND COA.EZCANCELFLAG        = '0'
           ) COA
           ,(
               SELECT
                   MAC.SVC_MACH_MSTR_PK
                  ,CASE WHEN (SUM(CASE WHEN CTR.DS_CONTR_STS_CD IN (#effective#, #approved#) THEN 1 ELSE 0 END)) = 0 THEN 'Y' ELSE 'N' END AS TM_AND_MAT_FLG
               FROM
                   SVC_MACH_MSTR           MAC
                  ,DS_CONTR                CTR
                  ,DS_CONTR_DTL            CTD
               WHERE
                   MAC.GLBL_CMPY_CD        = #glblCmpyCd#
               AND MAC.GLBL_CMPY_CD        = CTD.GLBL_CMPY_CD
               AND MAC.SVC_MACH_MSTR_PK    = CTD.SVC_MACH_MSTR_PK
               AND CTD.GLBL_CMPY_CD        = CTR.GLBL_CMPY_CD
               AND CTD.DS_CONTR_PK         = CTR.DS_CONTR_PK
               AND MAC.EZCANCELFLAG        = '0'
               AND CTR.EZCANCELFLAG        = '0'
               AND CTD.EZCANCELFLAG        = '0'
               GROUP BY MAC.SVC_MACH_MSTR_PK
           ) T_FLG
           ,(
               SELECT
                   FSR.SVC_MACH_MSTR_PK
                  ,VIS.TECH_CD
                  ,COUNT(FSR.FSR_NUM)                                             AS MLY_TOT_FSR_CNT
                  ,SUM(CASE WHEN FSR.FSR_TP_CD = #serviceCall# THEN 1 ELSE 0 END) AS MLY_TOT_CM_CNT
               FROM
                   FSR                 FSR
                  ,FSR_VISIT           VIS
               WHERE
                   FSR.GLBL_CMPY_CD                    = #glblCmpyCd#
               AND SUBSTR(FSR.FSR_CRAT_DT, 0, #ymLen#) = #trgtYrMth#
               AND FSR.GLBL_CMPY_CD                    = VIS.GLBL_CMPY_CD
               AND FSR.FSR_NUM                         = VIS.FSR_NUM
               AND VIS.PREV_FSR_VISIT_NUM              IS NULL
               AND FSR.EZCANCELFLAG                    = '0'
               AND VIS.EZCANCELFLAG                    = '0'
               GROUP BY
                   FSR.SVC_MACH_MSTR_PK
                  ,VIS.TECH_CD
           ) C_FSR
           ,(
               SELECT
                   FSR.SVC_MACH_MSTR_PK
                  ,VIS.TECH_CD
                  ,COUNT(VIS.FSR_VISIT_NUM) AS MLY_TOT_VISIT_CNT
                  ,SUM(CASE WHEN TSK.FIRST_SVC_TASK_FLG = 'N' THEN 1 ELSE 0 END) AS MLY_TOT_RTRN_VISIT_CNT
               FROM
                   FSR                 FSR
                  ,FSR_VISIT_TASK      FVT
                  ,SVC_TASK            TSK
                  ,FSR_VISIT           VIS
               WHERE
                   FSR.GLBL_CMPY_CD                          = #glblCmpyCd#
               AND FSR.GLBL_CMPY_CD                          = FVT.GLBL_CMPY_CD
               AND FSR.FSR_NUM                               = FVT.FSR_NUM
               AND FVT.GLBL_CMPY_CD                          = TSK.GLBL_CMPY_CD
               AND FVT.FSR_NUM                               = TSK.FSR_NUM
               AND FVT.SVC_TASK_NUM                          = TSK.SVC_TASK_NUM
               AND FVT.GLBL_CMPY_CD                          = VIS.GLBL_CMPY_CD
               AND FVT.FSR_NUM                               = VIS.FSR_NUM
               AND FVT.FSR_VISIT_NUM                         = VIS.FSR_VISIT_NUM
               AND SUBSTR(VIS.FSR_VISIT_CPLT_DT, 0, #ymLen#) = #trgtYrMth#
               AND FSR.EZCANCELFLAG                          = '0'
               AND FVT.EZCANCELFLAG                          = '0'
               AND TSK.EZCANCELFLAG                          = '0'
               AND VIS.EZCANCELFLAG                          = '0'
               GROUP BY
                   FSR.SVC_MACH_MSTR_PK, VIS.TECH_CD
           ) C_VIS
           ,(
               SELECT
                   SVC_MACH_MSTR_PK
                  ,TECH_CD
                  ,SUM(LA_AOT)           AS MLY_TOT_LBOR_AOT
                  ,SUM(TR_AOT)           AS MLY_TOT_TRVL_AOT
                  ,SUM(LA_AOT_NINST)     AS MLY_NI_LBOR_AOT
                  ,SUM(TR_AOT_NINST)     AS MLY_NI_TRVL_AOT
                  ,SUM(LA_AOT_NI_SCD)    AS MLY_NI_SCD_VISIT_LBOR_AOT
                  ,SUM(TR_AOT_NI_SCD)    AS MLY_NI_SCD_VISIT_TRVL_AOT
               FROM
                   (
                   SELECT
                       FSR.SVC_MACH_MSTR_PK
                      ,VIS.TECH_CD
                      ,EVE.SVC_TM_EVENT_CD
                      ,CASE WHEN EVE.SVC_TM_EVENT_CD = #labor#  THEN SUM(ROUND((TO_DATE(SVC_TM_EVENT_TO_DT || SVC_TM_EVENT_TO_TM,'YYYYMMDDHH24MISS') - TO_DATE(SVC_TM_EVENT_FROM_DT || SVC_TM_EVENT_FROM_TM,'YYYYMMDDHH24MISS')) * 24 * 60 * 60)) END AS LA_AOT
                      ,CASE WHEN EVE.SVC_TM_EVENT_CD = #travel# THEN SUM(ROUND((TO_DATE(SVC_TM_EVENT_TO_DT || SVC_TM_EVENT_TO_TM,'YYYYMMDDHH24MISS') - TO_DATE(SVC_TM_EVENT_FROM_DT || SVC_TM_EVENT_FROM_TM,'YYYYMMDDHH24MISS')) * 24 * 60 * 60)) END AS TR_AOT
                      ,CASE WHEN EVE.SVC_TM_EVENT_CD = #labor#  AND FSR.FSR_TP_CD != #installCall# THEN SUM(ROUND((TO_DATE(SVC_TM_EVENT_TO_DT || SVC_TM_EVENT_TO_TM,'YYYYMMDDHH24MISS') - TO_DATE(SVC_TM_EVENT_FROM_DT || SVC_TM_EVENT_FROM_TM,'YYYYMMDDHH24MISS')) * 24 * 60 * 60)) END AS LA_AOT_NINST
                      ,CASE WHEN EVE.SVC_TM_EVENT_CD = #travel# AND FSR.FSR_TP_CD != #installCall# THEN SUM(ROUND((TO_DATE(SVC_TM_EVENT_TO_DT || SVC_TM_EVENT_TO_TM,'YYYYMMDDHH24MISS') - TO_DATE(SVC_TM_EVENT_FROM_DT || SVC_TM_EVENT_FROM_TM,'YYYYMMDDHH24MISS')) * 24 * 60 * 60)) END AS TR_AOT_NINST
                      ,CASE WHEN EVE.SVC_TM_EVENT_CD = #labor#  AND FSR.FSR_TP_CD != #installCall# AND TSK.FIRST_SVC_TASK_FLG = 'N' THEN SUM(ROUND((TO_DATE(SVC_TM_EVENT_TO_DT || SVC_TM_EVENT_TO_TM,'YYYYMMDDHH24MISS') - TO_DATE(SVC_TM_EVENT_FROM_DT || SVC_TM_EVENT_FROM_TM,'YYYYMMDDHH24MISS')) * 24 * 60 * 60)) END AS LA_AOT_NI_SCD
                      ,CASE WHEN EVE.SVC_TM_EVENT_CD = #travel# AND FSR.FSR_TP_CD != #installCall# AND TSK.FIRST_SVC_TASK_FLG = 'N' THEN SUM(ROUND((TO_DATE(SVC_TM_EVENT_TO_DT || SVC_TM_EVENT_TO_TM,'YYYYMMDDHH24MISS') - TO_DATE(SVC_TM_EVENT_FROM_DT || SVC_TM_EVENT_FROM_TM,'YYYYMMDDHH24MISS')) * 24 * 60 * 60)) END AS TR_AOT_NI_SCD
                   FROM
                       FSR                                FSR
                      ,FSR_VISIT                          VIS
                      ,FSR_VISIT_TASK                     FVT
                      ,SVC_TASK                           TSK
                      ,FSR_VISIT_TM_EVENT                 EVE
                   WHERE
                       FSR.GLBL_CMPY_CD                   = #glblCmpyCd#
                   AND SUBSTR(FSR.FSR_CLO_DT, 0, #ymLen#) = #trgtYrMth#
                   AND FSR.GLBL_CMPY_CD                   = VIS.GLBL_CMPY_CD
                   AND FSR.FSR_NUM                        = VIS.FSR_NUM
                   AND VIS.GLBL_CMPY_CD                   = FVT.GLBL_CMPY_CD
                   AND VIS.FSR_NUM                        = FVT.FSR_NUM
                   AND VIS.FSR_VISIT_NUM                  = FVT.FSR_VISIT_NUM
                   AND FVT.GLBL_CMPY_CD                   = TSK.GLBL_CMPY_CD
                   AND FVT.FSR_NUM                        = TSK.FSR_NUM
                   AND FVT.SVC_TASK_NUM                   = TSK.SVC_TASK_NUM
                   AND FVT.GLBL_CMPY_CD                   = EVE.GLBL_CMPY_CD
                   AND FVT.FSR_NUM                        = EVE.FSR_NUM
                   AND FVT.SVC_TASK_NUM                   = EVE.SVC_TASK_NUM
                   AND FVT.FSR_VISIT_NUM                  = EVE.FSR_VISIT_NUM
                   AND EVE.SVC_TM_EVENT_CD                IN (#labor#, #travel#)
                   AND FSR.EZCANCELFLAG                   = '0'
                   AND VIS.EZCANCELFLAG                   = '0'
                   AND FVT.EZCANCELFLAG                   = '0'
                   AND TSK.EZCANCELFLAG                   = '0'
                   AND EVE.EZCANCELFLAG                   = '0'
                   GROUP BY FSR.SVC_MACH_MSTR_PK, VIS.TECH_CD, EVE.SVC_TM_EVENT_CD, FSR.FSR_TP_CD, TSK.FIRST_SVC_TASK_FLG
                   )
               GROUP BY SVC_MACH_MSTR_PK, TECH_CD
           ) M_AOT
           ,(
               SELECT
                   FSR.SVC_MACH_MSTR_PK
                  ,VIS.TECH_CD
                  ,SUM(NVL(SUP.SVC_SUPPL_TM_NUM, 0)) * #timeAdj# AS MLY_TOT_ITRPT_AOT
                  ,SUM(CASE WHEN FSR.FSR_TP_CD != #installCall# THEN NVL(SUP.SVC_SUPPL_TM_NUM, 0) END ) * #timeAdj# AS MLY_NI_ITRPT_AOT
                  ,SUM(CASE WHEN FSR.FSR_TP_CD != #installCall# AND TSK.FIRST_SVC_TASK_FLG = 'N' THEN NVL(SUP.SVC_SUPPL_TM_NUM, 0) END ) * #timeAdj# AS MLY_NI_SCD_VISIT_ITRPT_AOT
               FROM
                   FSR                                FSR
                  ,FSR_VISIT                          VIS
                  ,FSR_VISIT_TASK                     FVT
                  ,SVC_TASK                           TSK
                  ,SVC_SUPPL_TASK                     SUP
                  ,SVC_SUPPL_TASK_TP                  STP
               WHERE
                   FSR.GLBL_CMPY_CD                   = #glblCmpyCd#
               AND SUBSTR(FSR.FSR_CLO_DT, 0, #ymLen#) = #trgtYrMth#
               AND FSR.GLBL_CMPY_CD                   = VIS.GLBL_CMPY_CD
               AND FSR.FSR_NUM                        = VIS.FSR_NUM
               AND VIS.GLBL_CMPY_CD                   = FVT.GLBL_CMPY_CD
               AND VIS.FSR_NUM                        = FVT.FSR_NUM
               AND VIS.FSR_VISIT_NUM                  = FVT.FSR_VISIT_NUM
               AND FVT.GLBL_CMPY_CD                   = TSK.GLBL_CMPY_CD
               AND FVT.FSR_NUM                        = TSK.FSR_NUM
               AND FVT.SVC_TASK_NUM                   = TSK.SVC_TASK_NUM
               AND FVT.GLBL_CMPY_CD                   = SUP.GLBL_CMPY_CD
               AND FVT.FSR_NUM                        = SUP.FSR_NUM
               AND FVT.SVC_TASK_NUM                   = SUP.SVC_TASK_NUM
               AND SUP.SVC_SUPPL_TASK_TP_CD           != #meal2#
               AND SUP.GLBL_CMPY_CD                   = STP.GLBL_CMPY_CD
               AND SUP.SVC_SUPPL_TASK_TP_CD           = STP.SVC_SUPPL_TASK_TP_CD
               AND STP.SVC_ITRPT_FLG                  = 'Y'
               AND FSR.EZCANCELFLAG                   = '0'
               AND VIS.EZCANCELFLAG                   = '0'
               AND FVT.EZCANCELFLAG                   = '0'
               AND TSK.EZCANCELFLAG                   = '0'
               AND SUP.EZCANCELFLAG                   = '0'
               AND STP.EZCANCELFLAG                   = '0'
               GROUP BY FSR.SVC_MACH_MSTR_PK, VIS.TECH_CD
           ) I_AOT
           ,(
               SELECT
                   SVC_MACH_MSTR_PK
                  ,TECH_CD
                  ,SUM(NVL(FSR_TOT_PRT_COST_AMT, 0)) AS MLY_TOT_PRT_COST_AMT
                  ,SUM(NVL(FSR_NI_SCD_PRT_COST_AMT, 0)) AS MLY_NI_SCD_VISIT_PRT_CNT
               FROM (
                      SELECT
                          FSR.SVC_MACH_MSTR_PK
                         ,VIS.TECH_CD
                         ,USG.MDSE_CD
                         ,NVL(USG.SVC_PRT_QTY, 0) * NVL(MDS.THIS_MTH_TOT_STD_COST_AMT, 0) AS FSR_TOT_PRT_COST_AMT
                         ,CASE WHEN FSR.FSR_TP_CD != #installCall# AND TSK.FIRST_SVC_TASK_FLG = 'N' THEN NVL(USG.SVC_PRT_QTY, 0) * NVL(MDS.THIS_MTH_TOT_STD_COST_AMT, 0) END AS FSR_NI_SCD_PRT_COST_AMT
                      FROM
                          FSR                                FSR
                         ,FSR_VISIT                          VIS
                         ,FSR_VISIT_TASK                     FVT
                         ,SVC_TASK                           TSK
                         ,FSR_USG                            USG
                         ,MDSE                               MDS
                      WHERE
                          FSR.GLBL_CMPY_CD                   = #glblCmpyCd#
                      AND SUBSTR(FSR.FSR_CLO_DT, 0, #ymLen#) = #trgtYrMth#
                      AND FSR.GLBL_CMPY_CD                   = VIS.GLBL_CMPY_CD
                      AND FSR.FSR_NUM                        = VIS.FSR_NUM
                      AND VIS.GLBL_CMPY_CD                   = FVT.GLBL_CMPY_CD
                      AND VIS.FSR_NUM                        = FVT.FSR_NUM
                      AND VIS.FSR_VISIT_NUM                  = FVT.FSR_VISIT_NUM
                      AND FVT.GLBL_CMPY_CD                   = TSK.GLBL_CMPY_CD
                      AND FVT.FSR_NUM                        = TSK.FSR_NUM
                      AND FVT.SVC_TASK_NUM                   = TSK.SVC_TASK_NUM
                      AND FVT.GLBL_CMPY_CD                   = USG.GLBL_CMPY_CD
                      AND FVT.FSR_NUM                        = USG.FSR_NUM
                      AND FVT.SVC_TASK_NUM                   = USG.SVC_TASK_NUM
                      AND FVT.FSR_VISIT_NUM                  = USG.FSR_VISIT_NUM
                      AND USG.GLBL_CMPY_CD                   = MDS.GLBL_CMPY_CD
                      AND USG.MDSE_CD                        = MDS.MDSE_CD
                      AND FSR.EZCANCELFLAG                   = '0'
                      AND VIS.EZCANCELFLAG                   = '0'
                      AND FVT.EZCANCELFLAG                   = '0'
                      AND TSK.EZCANCELFLAG                   = '0'
                      AND USG.EZCANCELFLAG                   = '0'
                      AND MDS.EZCANCELFLAG                   = '0'
               )
               GROUP BY SVC_MACH_MSTR_PK, TECH_CD
           ) U_AOT
           ,(
               SELECT
                   FSR.SVC_MACH_MSTR_PK
                  ,VIS.TECH_CD
                  ,SUM(CASE WHEN FSR.FSR_TP_CD  = #installCall# THEN 1 ELSE 0 END) AS MLY_ISTL_VISIT_CNT
                  ,SUM(CASE WHEN FSR.FSR_TP_CD != #installCall# THEN 1 ELSE 0 END) AS MLY_NITL_VISIT_CNT
                  ,SUM(CASE WHEN FSR.FSR_TP_CD  = #installCall# AND TSK.FIRST_SVC_TASK_FLG = 'N' THEN 1 ELSE 0 END) AS MLY_ISTL_SCD_VISIT_CNT
                  ,SUM(CASE WHEN FSR.FSR_TP_CD != #installCall# AND TSK.FIRST_SVC_TASK_FLG = 'N' THEN 1 ELSE 0 END) AS MLY_NISTL_SCD_VISIT_CNT
               FROM
                   FSR                 FSR
                  ,FSR_VISIT_TASK      FVT
                  ,SVC_TASK            TSK
                  ,FSR_VISIT           VIS
               WHERE
                   FSR.GLBL_CMPY_CD                    = #glblCmpyCd#
               AND SUBSTR(FSR.FSR_CLO_DT, 0, #ymLen#)  = #trgtYrMth#
               AND FSR.GLBL_CMPY_CD                    = FVT.GLBL_CMPY_CD
               AND FSR.FSR_NUM                         = FVT.FSR_NUM
               AND FVT.GLBL_CMPY_CD                    = TSK.GLBL_CMPY_CD
               AND FVT.FSR_NUM                         = TSK.FSR_NUM
               AND FVT.SVC_TASK_NUM                    = TSK.SVC_TASK_NUM
               AND FVT.GLBL_CMPY_CD                    = VIS.GLBL_CMPY_CD
               AND FVT.FSR_NUM                         = VIS.FSR_NUM
               AND FVT.FSR_VISIT_NUM                   = VIS.FSR_VISIT_NUM
               AND FSR.EZCANCELFLAG                    = '0'
               AND FVT.EZCANCELFLAG                    = '0'
               AND TSK.EZCANCELFLAG                    = '0'
               AND VIS.EZCANCELFLAG                    = '0'
               GROUP BY
                   FSR.SVC_MACH_MSTR_PK, VIS.TECH_CD
           ) C_CLVIS
           ,(
               SELECT
                   SVC_MACH_MSTR_PK
                  ,TECH_CD
                  ,RGTN_MTR_DT
                  ,CASE WHEN SUM(TL_CNT) != 0 THEN SUM(TL_CNT) ELSE SUM(BW_CNT) + SUM(CL_CNT) END AS LTST_READ_MTR_CNT
               FROM
                  (
                   SELECT DISTINCT
                       MTR.SVC_MACH_MSTR_PK
                      ,VIS.TECH_CD
                      ,MTR.RGTN_MTR_DT
                      ,CASE WHEN LB.BW_MTR_FLG    = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS BW_CNT
                      ,CASE WHEN LB.COLOR_MTR_FLG = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS CL_CNT
                      ,CASE WHEN LB.TOT_MTR_FLG   = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS TL_CNT
                   FROM
                       SVC_PHYS_MTR_READ             MTR
                      ,MTR_LB                        LB
                      ,FSR                           FSR
                      ,FSR_VISIT                     VIS
                      ,(
                       SELECT
                           MTR.SVC_MACH_MSTR_PK
                          ,MTR.FSR_VISIT_NUM
                          ,MAX(RGTN_MTR_DT)          AS RGTN_MTR_DT
                       FROM
                           SVC_PHYS_MTR_READ         MTR
                       WHERE
                           MTR.GLBL_CMPY_CD                = #glblCmpyCd#
                       AND SUBSTR(RGTN_MTR_DT, 0, #ymLen#) = #trgtYrMth#
                       AND MTR.EZCANCELFLAG                = '0'
                       <!-- START QC#28592 2018/10/11 [ADD]-->
                       AND MTR.VLD_MTR_FLG                 = 'Y'
                       <!-- END   QC#28592 2018/10/11 [ADD]-->
                       GROUP BY
                           MTR.SVC_MACH_MSTR_PK, MTR.FSR_VISIT_NUM
                       ) MTR_WK
                   WHERE
                       MTR.GLBL_CMPY_CD              = #glblCmpyCd#
                   AND MTR.TEST_MTR_CNT              = 0
                   AND MTR.FSR_NUM                   IS NOT NULL
                   AND MTR.FSR_VISIT_NUM             IS NOT NULL
                   AND MTR.GLBL_CMPY_CD              = LB.GLBL_CMPY_CD
                   AND MTR.MTR_LB_CD                 = LB.MTR_LB_CD
                   AND MTR.SVC_MACH_MSTR_PK          = MTR_WK.SVC_MACH_MSTR_PK
                   AND MTR.RGTN_MTR_DT               = MTR_WK.RGTN_MTR_DT
                   AND MTR.GLBL_CMPY_CD              = FSR.GLBL_CMPY_CD
                   AND MTR.FSR_NUM                   = FSR.FSR_NUM
                   AND MTR.SVC_MACH_MSTR_PK          = FSR.SVC_MACH_MSTR_PK
                   AND FSR.GLBL_CMPY_CD              = VIS.GLBL_CMPY_CD
                   AND FSR.FSR_NUM                   = VIS.FSR_NUM
                   AND MTR.FSR_VISIT_NUM             = VIS.FSR_VISIT_NUM
                   <!-- START QC#28592 2018/10/11 [ADD]-->
                   AND MTR.VLD_MTR_FLG               = 'Y'
                   <!-- END   QC#28592 2018/10/11 [ADD]-->
                   AND MTR.EZCANCELFLAG              = '0'
                   AND FSR.EZCANCELFLAG              = '0'
                   AND VIS.EZCANCELFLAG              = '0'
                   AND LB.EZCANCELFLAG               = '0'
                  )
               GROUP BY
                   SVC_MACH_MSTR_PK, TECH_CD, RGTN_MTR_DT
           ) L_MTR
           ,(
               SELECT
                   MTR.SVC_MACH_MSTR_PK
                  ,MTR.RGTN_MTR_DT
                  ,MTR.SVC_INV_NUM
                  ,MTR.INV_DT
                  ,VIS.TECH_CD
               FROM
                   SVC_PHYS_MTR_READ             MTR
                  ,FSR                           FSR
                  ,FSR_VISIT                     VIS
               WHERE
                   MTR.GLBL_CMPY_CD              = #glblCmpyCd#
               AND MTR.TEST_MTR_CNT              = 0
               AND MTR.FSR_NUM                   IS NOT NULL
               AND MTR.FSR_VISIT_NUM             IS NOT NULL
               AND MTR.SVC_INV_NUM               IS NOT NULL
               AND MTR.GLBL_CMPY_CD              = FSR.GLBL_CMPY_CD
               AND MTR.FSR_NUM                   = FSR.FSR_NUM
               AND MTR.SVC_MACH_MSTR_PK          = FSR.SVC_MACH_MSTR_PK
               AND MTR.GLBL_CMPY_CD              = VIS.GLBL_CMPY_CD
               AND MTR.FSR_NUM                   = VIS.FSR_NUM
               AND MTR.FSR_VISIT_NUM             = VIS.FSR_VISIT_NUM
               <!-- START QC#28592 2018/10/11 [ADD]-->
               AND MTR.VLD_MTR_FLG                     = 'Y'
               <!-- END   QC#28592 2018/10/11 [ADD]-->
               AND MTR.EZCANCELFLAG              = '0'
               AND FSR.EZCANCELFLAG              = '0'
               AND VIS.EZCANCELFLAG              = '0'
        ) INV
        WHERE
            MAC.GLBL_CMPY_CD                = #glblCmpyCd#
        AND MAC.SVC_MACH_MSTR_PK            = FSR.SVC_MACH_MSTR_PK
        AND MAC.SER_NUM                     = FSR.SER_NUM
        AND MAC.SVC_BY_LINE_BIZ_TP_CD       = CST.RPT_COND_CONST_CD(+)
        AND CST.RPT_COND_CONST_GRP_ID(+)    = #laborRate#
        AND MAC.SVC_MACH_MSTR_PK            = MDL_1.SVC_MACH_MSTR_PK(+)
        AND MAC.SVC_MACH_MSTR_PK            = MDL_2.SVC_MACH_MSTR_PK(+)
        AND MAC.SVC_MACH_MSTR_PK            = COA.SVC_MACH_MSTR_PK(+)
        AND MAC.SVC_MACH_MSTR_PK            = T_FLG.SVC_MACH_MSTR_PK(+)
        AND MAC.SVC_MACH_MSTR_PK            = L_MTR.SVC_MACH_MSTR_PK(+)
        AND FSR.TECH_CD                     = L_MTR.TECH_CD(+)
        AND L_MTR.SVC_MACH_MSTR_PK          = INV.SVC_MACH_MSTR_PK(+)
        AND L_MTR.TECH_CD                   = INV.TECH_CD(+)
        AND L_MTR.RGTN_MTR_DT               = INV.RGTN_MTR_DT(+)
        AND MAC.SVC_MACH_MSTR_PK            = C_FSR.SVC_MACH_MSTR_PK(+)
        AND FSR.TECH_CD                     = C_FSR.TECH_CD(+)
        AND MAC.SVC_MACH_MSTR_PK            = C_VIS.SVC_MACH_MSTR_PK(+)
        AND FSR.TECH_CD                     = C_VIS.TECH_CD(+)
        AND MAC.SVC_MACH_MSTR_PK            = M_AOT.SVC_MACH_MSTR_PK(+)
        AND FSR.TECH_CD                     = M_AOT.TECH_CD(+)
        AND MAC.SVC_MACH_MSTR_PK            = I_AOT.SVC_MACH_MSTR_PK(+)
        AND FSR.TECH_CD                     = I_AOT.TECH_CD(+)
        AND MAC.SVC_MACH_MSTR_PK            = U_AOT.SVC_MACH_MSTR_PK(+)
        AND FSR.TECH_CD                     = U_AOT.TECH_CD(+)
        AND MAC.SVC_MACH_MSTR_PK            = C_CLVIS.SVC_MACH_MSTR_PK(+)
        AND FSR.TECH_CD                     = C_CLVIS.TECH_CD(+)
        AND MAC.EZCANCELFLAG                = '0'
        AND CST.EZCANCELFLAG(+)             = '0'
    </statement>

    <statement id="getPrevMtrReadData" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            CASE WHEN SUM(TL_CNT) != 0 THEN SUM(TL_CNT) ELSE SUM(BW_CNT) + SUM(CL_CNT) END AS READ_MTR_CNT
        FROM
           (
            SELECT DISTINCT
                MTR.SVC_MACH_MSTR_PK
               ,CASE WHEN LB.BW_MTR_FLG    = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS BW_CNT
               ,CASE WHEN LB.COLOR_MTR_FLG = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS CL_CNT
               ,CASE WHEN LB.TOT_MTR_FLG   = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS TL_CNT
            FROM
                SVC_PHYS_MTR_READ         MTR
               ,MTR_LB                    LB
               ,FSR                       FSR
               ,(
                SELECT
                    MTR.SVC_MACH_MSTR_PK
                   ,MAX(RGTN_MTR_DT)          AS RGTN_MTR_DT
                FROM
                    SVC_PHYS_MTR_READ         MTR
                WHERE
                    MTR.GLBL_CMPY_CD          = #glblCmpyCd#
                AND MTR.RGTN_MTR_DT           &lt; #trgtDt#
                AND MTR.SVC_MACH_MSTR_PK      = #svcMachMstrPk#
               <!-- START QC#28592 2018/10/11 [ADD]-->
                AND MTR.VLD_MTR_FLG           = 'Y'
               <!-- END   QC#28592 2018/10/11 [ADD]-->
                AND MTR.EZCANCELFLAG          = '0'
                GROUP BY
                    MTR.SVC_MACH_MSTR_PK
                ) MTR_WK
            WHERE
                MTR.GLBL_CMPY_CD               = #glblCmpyCd#
            AND MTR.TEST_MTR_CNT               = 0
            AND MTR.SVC_MACH_MSTR_PK           = #svcMachMstrPk#
            <!-- START QC#28592 2018/10/11 [ADD]-->
             AND MTR.VLD_MTR_FLG               = 'Y'
            <!-- END   QC#28592 2018/10/11 [ADD]-->
            AND MTR.FSR_NUM                    IS NOT NULL
            AND MTR.FSR_VISIT_NUM              IS NOT NULL
            AND MTR.GLBL_CMPY_CD               = LB.GLBL_CMPY_CD
            AND MTR.MTR_LB_CD                  = LB.MTR_LB_CD
            AND MTR.SVC_MACH_MSTR_PK           = MTR_WK.SVC_MACH_MSTR_PK
            AND MTR.RGTN_MTR_DT                = MTR_WK.RGTN_MTR_DT
            AND MTR.GLBL_CMPY_CD               = FSR.GLBL_CMPY_CD
            AND MTR.FSR_NUM                    = FSR.FSR_NUM
            AND FSR.FSR_TP_CD                 != #installCall#
            AND MTR.EZCANCELFLAG               = '0'
            AND LB.EZCANCELFLAG                = '0'
           )
        GROUP BY 
            SVC_MACH_MSTR_PK
    </statement>

    <statement id="getMtrReadData" parameterClass="Map" resultClass="Map">
        SELECT
            SVC_MACH_MSTR_PK
           ,RGTN_MTR_DT
           ,TECH_CD
           ,FSR_TP_CD
           ,CASE WHEN SUM(TL_CNT) != 0 THEN SUM(TL_CNT) ELSE SUM(BW_CNT) + SUM(CL_CNT) END AS READ_MTR_CNT
        FROM
           (
            SELECT DISTINCT
                MTR.SVC_MACH_MSTR_PK
               ,VIS.TECH_CD
               ,FSR.FSR_TP_CD
               ,MTR.RGTN_MTR_DT
               ,CASE WHEN LB.BW_MTR_FLG    = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS BW_CNT
               ,CASE WHEN LB.COLOR_MTR_FLG = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS CL_CNT
               ,CASE WHEN LB.TOT_MTR_FLG   = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS TL_CNT
            FROM
                SVC_PHYS_MTR_READ         MTR
               ,MTR_LB                    LB
               ,FSR                       FSR
               ,FSR_VISIT                 VIS
            WHERE
                MTR.GLBL_CMPY_CD               = #glblCmpyCd#
            AND SUBSTR(MTR.RGTN_MTR_DT, 0, #ymLen#) &lt;= #trgtYrMth#
            AND SUBSTR(MTR.RGTN_MTR_DT, 0, #ymLen#) &gt;= TO_CHAR(ADD_MONTHS(TO_DATE(#trgtYrMth#, 'YYYYMM'), - #beforeMth#), 'YYYYMM')
            AND MTR.TEST_MTR_CNT               = 0
            AND MTR.SVC_MACH_MSTR_PK           = #svcMachMstrPk#
            <!-- START QC#28592 2018/10/11 [ADD]-->
            AND MTR.VLD_MTR_FLG                = 'Y'
            <!-- END   QC#28592 2018/10/11 [ADD]-->
            AND MTR.FSR_NUM                    IS NOT NULL
            AND MTR.FSR_VISIT_NUM              IS NOT NULL
            AND MTR.GLBL_CMPY_CD               = LB.GLBL_CMPY_CD
            AND MTR.MTR_LB_CD                  = LB.MTR_LB_CD
            AND MTR.GLBL_CMPY_CD               = VIS.GLBL_CMPY_CD
            AND MTR.FSR_NUM                    = VIS.FSR_NUM
            AND MTR.FSR_VISIT_NUM              = VIS.FSR_VISIT_NUM
            AND VIS.GLBL_CMPY_CD               = FSR.GLBL_CMPY_CD
            AND VIS.FSR_NUM                    = FSR.FSR_NUM
            AND MTR.EZCANCELFLAG               = '0'
            AND LB.EZCANCELFLAG                = '0'
            AND FSR.EZCANCELFLAG               = '0'
            AND VIS.EZCANCELFLAG               = '0'
           )
        GROUP BY
            SVC_MACH_MSTR_PK, RGTN_MTR_DT, TECH_CD, FSR_TP_CD
        ORDER BY
            RGTN_MTR_DT
    </statement>

</sqlMap>
