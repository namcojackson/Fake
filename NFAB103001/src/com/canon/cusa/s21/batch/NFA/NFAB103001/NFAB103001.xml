<?xml version="1.0" encoding="UTF-8"?>

<sqlMap namespace="NFAB103001">

<!-- #################### Type Alias #################### -->

<!-- #################### Statement #################### -->
	
	<statement id="getAjeIdList" parameterClass="Map" resultClass="Map">
    SELECT
          ISC.SYS_SRC_CD
         ,ISC.TRX_CD
         ,ISC.TRX_RSN_CD
    FROM
    (
		SELECT 
			 INV.SYS_SRC_CD AS SYS_SRC_CD
			,ISC.TRX_CD     AS TRX_CD
			,ISC.TRX_RSN_CD AS TRX_RSN_CD
		FROM 
			 DS_INV_SLS_CR    ISC
			,DFRD_ACCTG_RULE  DAR
			,INV              INV
		WHERE
		     ISC.GLBL_CMPY_CD            = #glblCmpyCd#
		 AND ISC.EZCANCELFLAG            = '0'
		 <!-- start mod 2017/11/28 QC#17089 -->
		 AND (ISC.NEXT_REV_RECOG_DT   &lt;= #batProcDt#
			OR EXISTS (SELECT 1 
                          FROM  INV OIV 
                          WHERE OIV.GLBL_CMPY_CD = INV.GLBL_CMPY_CD
                            AND OIV.EZCANCELFLAG = INV.EZCANCELFLAG
                            AND OIV.INV_TP_CD    = #invTpCdCm#
                            AND OIV.ORIG_INV_NUM = INV.INV_NUM)
		 )
		 <!-- end   mod 2017/11/28 QC#17089 -->
		 AND ISC.REV_RECOG_PROC_STS_CD   in (#notProcessed#, #inProcess#)
		 AND ISC.DEAL_DFRD_BAL_AMT   &lt;&gt; 0
		 AND ISC.GLBL_CMPY_CD            = DAR.GLBL_CMPY_CD
		 AND ISC.EZCANCELFLAG            = DAR.EZCANCELFLAG
		 AND ISC.DFRD_ACCTG_RULE_CD      = DAR.DFRD_ACCTG_RULE_CD
		 AND DAR.DFRD_REV_FLG            = #flgY#
		 AND ISC.GLBL_CMPY_CD            = INV.GLBL_CMPY_CD
		 AND ISC.EZCANCELFLAG            = INV.EZCANCELFLAG
		 AND ISC.INV_NUM                 = INV.INV_NUM
	UNION
        SELECT 
             INV.SYS_SRC_CD   AS SYS_SRC_CD
            ,ISC.TRX_CD       AS TRX_CD
            ,ISC.TRX_RSN_CD   AS TRX_RSN_CD
        FROM 
             DS_INV_SLS_CR    ISC
            ,DFRD_ACCTG_RULE  DAR
            ,INV              INV
            ,INV_LINE         IVL
            ,DS_CONTR_DTL     DCD
        WHERE
             ISC.GLBL_CMPY_CD            = #glblCmpyCd#
        AND ISC.EZCANCELFLAG             = '0'
        AND ISC.REV_RECOG_PROC_STS_CD   in (#notProcessed#, #inProcess#)
        AND ISC.DEAL_DFRD_BAL_AMT   &lt;&gt; 0
        AND ISC.GLBL_CMPY_CD             = DAR.GLBL_CMPY_CD
        AND ISC.EZCANCELFLAG             = DAR.EZCANCELFLAG
        AND ISC.DFRD_ACCTG_RULE_CD       = DAR.DFRD_ACCTG_RULE_CD
        AND DAR.DFRD_REV_FLG             = #flgY#
        AND ISC.GLBL_CMPY_CD             = INV.GLBL_CMPY_CD
        AND ISC.EZCANCELFLAG             = INV.EZCANCELFLAG
        AND ISC.INV_NUM                  = INV.INV_NUM
        AND ISC.GLBL_CMPY_CD             = IVL.GLBL_CMPY_CD
        AND ISC.EZCANCELFLAG             = IVL.EZCANCELFLAG
        AND ISC.INV_NUM                  = IVL.INV_NUM
        AND ISC.INV_BOL_LINE_NUM         = IVL.INV_BOL_LINE_NUM
        AND ISC.INV_LINE_NUM             = IVL.INV_LINE_NUM
        AND ISC.INV_LINE_SUB_NUM         = IVL.INV_LINE_SUB_NUM
        AND ISC.INV_TRX_LINE_SUB_NUM     = IVL.INV_LINE_SUB_TRX_NUM
        AND IVL.GLBL_CMPY_CD             = DCD.GLBL_CMPY_CD(+)
        AND IVL.EZCANCELFLAG             = DCD.EZCANCELFLAG(+)
        AND IVL.DS_CONTR_DTL_PK          = DCD.DS_CONTR_DTL_PK(+)
        <isNotNull property="contrInactvStsCdArray">
        AND DCD.DS_CONTR_DTL_STS_CD     IN (
          <iterate property="contrInactvStsCdArray" var="contrInactvStsCd[]" open="" close="" conjunction=",">
              #contrInactvStsCd[]#
          </iterate>
         )
        </isNotNull>
    UNION
        SELECT 
             INV.SYS_SRC_CD   AS SYS_SRC_CD
            ,ISC.TRX_CD       AS TRX_CD
            ,ISC.TRX_RSN_CD   AS TRX_RSN_CD
        FROM 
             DS_INV_SLS_CR    ISC
            ,DFRD_ACCTG_RULE  DAR
            ,INV              INV
            ,INV_LINE         IVL
            ,DS_CONTR_DTL     DCD
        WHERE
             ISC.GLBL_CMPY_CD            = #glblCmpyCd#
        AND ISC.EZCANCELFLAG             = '0'
        AND ISC.REV_RECOG_PROC_STS_CD   IN (#notProcessed#, #inProcess#)
        AND ISC.DEAL_DFRD_BAL_AMT   &lt;&gt; 0
        AND ISC.GLBL_CMPY_CD             = DAR.GLBL_CMPY_CD
        AND ISC.EZCANCELFLAG             = DAR.EZCANCELFLAG
        AND ISC.DFRD_ACCTG_RULE_CD       = DAR.DFRD_ACCTG_RULE_CD
        AND DAR.DFRD_REV_FLG             = #flgY#
        AND ISC.GLBL_CMPY_CD             = INV.GLBL_CMPY_CD
        AND ISC.EZCANCELFLAG             = INV.EZCANCELFLAG
        AND ISC.INV_NUM                  = INV.INV_NUM
        AND ISC.GLBL_CMPY_CD             = IVL.GLBL_CMPY_CD
        AND ISC.EZCANCELFLAG             = IVL.EZCANCELFLAG
        AND ISC.INV_NUM                  = IVL.INV_NUM
        AND ISC.INV_BOL_LINE_NUM         = IVL.INV_BOL_LINE_NUM
        AND ISC.INV_LINE_NUM             = IVL.INV_LINE_NUM
        AND ISC.INV_LINE_SUB_NUM         = IVL.INV_LINE_SUB_NUM
        AND ISC.INV_TRX_LINE_SUB_NUM     = IVL.INV_LINE_SUB_TRX_NUM
        AND IVL.GLBL_CMPY_CD             = DCD.GLBL_CMPY_CD
        AND IVL.EZCANCELFLAG             = DCD.EZCANCELFLAG
        AND IVL.SVC_MACH_MSTR_PK         = DCD.SVC_MACH_MSTR_PK
        AND NOT EXISTS (
                SELECT
                    1
                FROM
                    DS_CONTR_DTL    DCO
                WHERE
                        IVL.GLBL_CMPY_CD             = DCO.GLBL_CMPY_CD
                    AND IVL.EZCANCELFLAG             = DCO.EZCANCELFLAG
                    AND IVL.DS_CONTR_DTL_PK          = DCO.DS_CONTR_DTL_PK
                    AND NVL(DCO.CONTR_EFF_THRU_DT, #maxEndDate#)    &gt;= #batProcDt#
                    <iterate property="contrActvStsCd" var="contrActvStsCd[]" open="AND DCO.DS_CONTR_DTL_STS_CD IN (" conjunction= ", " close=")">
                    #contrActvStsCd[]#
                    </iterate>
        )
    ) ISC
    GROUP BY 
		 ISC.SYS_SRC_CD,
		 ISC.TRX_CD,
		 ISC.TRX_RSN_CD
	ORDER BY 
	     ISC.TRX_CD,
		 ISC.TRX_RSN_CD,
		 ISC.SYS_SRC_CD
    </statement>
    
    <statement id="getTargetData" parameterClass="Map">
      SELECT ISC.DS_INV_SLS_CR_PK
            ,ISC.TRX_CD
            ,ISC.TRX_RSN_CD
            ,ISC.INV_NUM
            ,ISC.INV_BOL_LINE_NUM
            ,ISC.INV_LINE_NUM
            ,ISC.INV_LINE_SUB_NUM
            ,ISC.INV_TRX_LINE_SUB_NUM
            ,ISC.DEAL_CCY_CD
            ,ISC.INV_LINE_SPL_PCT
            ,ISC.SLS_REP_CR_PCT
            ,ISC.DURN_START_DT
            ,ISC.REV_RECOG_CNT
            ,ISC.DEAL_DFRD_BAL_AMT
            ,ISC.DFRD_ACCTG_RULE_DURN_AOT
            ,GC.STD_CCY_CD
            ,IAD.DR_CR_TP_CD
            ,IAD.AJE_COA_CMPY_CD
            ,IAD.AJE_COA_BR_CD
            ,IAD.AJE_COA_CC_CD
            ,IAD.AJE_COA_ACCT_CD
            ,IAD.AJE_COA_PROD_CD
            ,IAD.AJE_COA_CH_CD
            ,IAD.AJE_COA_AFFL_CD
            ,IAD.AJE_COA_PROJ_CD
            ,IAD.AJE_COA_EXTN_CD
            ,IAD.AJE_INV_ACCT_DIST_PCT
            ,IAD.AJE_INV_ACCT_CLS_CD
            ,IAD.SYS_SRC_CD
            ,IAD.SYS_SRC_NM
            ,IAD.TRX_CD
            ,IAD.TRX_NM
            ,IAD.TRX_RSN_CD
            ,IAD.TRX_RSN_NM
            ,IAD.AJE_PTRN_IND_TP_CD_01
            ,IAD.AJE_PTRN_IND_TP_NM_01
            ,IAD.AJE_PTRN_ACTL_CD_01
            ,IAD.AJE_PTRN_ACTL_NM_01
            ,IAD.AJE_PTRN_IND_TP_CD_02
            ,IAD.AJE_PTRN_IND_TP_NM_02
            ,IAD.AJE_PTRN_ACTL_CD_02
            ,IAD.AJE_PTRN_ACTL_NM_02
            ,IAD.AJE_PTRN_IND_TP_CD_03
            ,IAD.AJE_PTRN_IND_TP_NM_03
            ,IAD.AJE_PTRN_ACTL_CD_03
            ,IAD.AJE_PTRN_ACTL_NM_03
            ,IAD.JRNL_SRC_CD
            ,IAD.JRNL_SRC_NM
            ,IAD.JRNL_CATG_CD
            ,IAD.JRNL_CATG_NM
            ,IAD.AJE_LINE_IDX_NUM
            ,IAD.AJE_LINE_IDX_DESC_TXT 
            ,CCY.AFT_DECL_PNT_DIGIT_NUM
            ,IAD.SYS_SRC_CD||'-'||ISC.TRX_CD||'-'||ISC.TRX_RSN_CD  AS AJE_ID
             <!-- start 2018/05/16 QC#26064 -->
            ,IV.LINE_BIZ_TP_CD                                     AS AJE_LINE_IND_TP_CD
             <!-- end 2018/05/16 QC#26064 -->
            <!-- start add 2019/01/07 QC#29734 -->
            ,(CASE
                WHEN
                     <iterate property="varRental" var="varRental[]" open="AILA.SVC_ALLOC_TP_CD IN (" close=")" conjunction=",">
                     #varRental[]#
                     </iterate>
                     THEN #re#
                ELSE #nonRe#
             END)                                                  AS SVC_ALLOC_IND_TP_CD
            <!-- end add 2019/01/07 QC#29734 -->
            
            -- at toc
            ,TDS.COA_BR_CD       AS "TOC_BR_CD"
            ,TDS.COA_CC_CD       AS "TOC_CC_CD"
            ,TDS.COA_EXTN_CD     AS "TOC_EXTN_CD"
            
            -- at INVTP-UNEARN
            ,DIT.UN_EARN_COA_CMPY_CD   AS "INVTP-UNEARN_CMPY_CD"
            ,DIT.UN_EARN_COA_BR_CD     AS "INVTP-UNEARN_BR_CD"
            ,DIT.UN_EARN_COA_CC_CD     AS "INVTP-UNEARN_CC_CD"
            ,DIT.UN_EARN_COA_ACCT_CD   AS "INVTP-UNEARN_ACCT_CD"
            ,DIT.UN_EARN_COA_PROD_CD   AS "INVTP-UNEARN_PROD_CD"
            ,DIT.UN_EARN_COA_CH_CD     AS "INVTP-UNEARN_CH_CD"
            ,DIT.UN_EARN_COA_AFFL_CD   AS "INVTP-UNEARN_AFFL_CD"
            ,DIT.UN_EARN_COA_PROJ_CD   AS "INVTP-UNEARN_PROJ_CD"
            ,DIT.UN_EARN_COA_EXTN_CD   AS "INVTP-UNEARN_EXTN_CD"
            
            -- at INVTP-SLS
            ,DIT.SLS_COA_CMPY_CD       AS "INVTP-SLS_CMPY_CD"
            ,DIT.SLS_COA_BR_CD         AS "INVTP-SLS_BR_CD"
            ,DIT.SLS_COA_CC_CD         AS "INVTP-SLS_CC_CD"
            ,DIT.SLS_COA_ACCT_CD       AS "INVTP-SLS_ACCT_CD"
            ,DIT.SLS_COA_PROD_CD       AS "INVTP-SLS_PROD_CD"
            ,DIT.SLS_COA_CH_CD         AS "INVTP-SLS_CH_CD"
            ,DIT.SLS_COA_AFFL_CD       AS "INVTP-SLS_AFFL_CD"
            ,DIT.SLS_COA_PROJ_CD       AS "INVTP-SLS_PROJ_CD"
            ,DIT.SLS_COA_EXTN_CD       AS "INVTP-SLS_EXTN_CD"
            
            -- at IB
            <!-- start 2016/10/26 QC#14590 -->
            <!-- ,SMM.FIN_BR_CD             AS "IB_BR_CD" -->
            <!-- start 2018/05/16 QC#26064 -->
            ,NVL(SMM.FIN_BR_CD, NVL(NVL(SBFX.FIN_BR_CD, SBPX.SVC_BR_CD), NVL(SBFX_5.FIN_BR_CD, SBPX_5.SVC_BR_CD)))
                                       AS "IB_BR_CD"
            <!-- end 2018/05/16 QC#26064 -->
            <!-- end 2016/10/26 QC#14590 -->
            <!-- start add 2017/10/26 QC#21752 -->
            ,SMM.FIN_BR_CD
            ,SBFX.FIN_BR_CD
            ,SBPX.SVC_BR_CD
            ,SBFX_5.FIN_BR_CD
            ,SBPX_5.SVC_BR_CD
            <!-- end add 2017/10/26 QC#21752 -->
            
            -- for AJE pattern indicator type
            , 'DE'                     AS AJE_ACCTG_RULE_CD
            , 'I'                      AS INV_INVTY_IND_TP_CD
            , ISC.DFRD_ACCTG_RULE_CD   AS DFRD_ACCTG_RULE_CD
            <!-- start add 2017/11/20 QC#17089 -->
            , CASE
                  WHEN EXISTS (
                      SELECT 1 
                          FROM  INV OIV 
                          WHERE OIV.GLBL_CMPY_CD = IV.GLBL_CMPY_CD
                            AND OIV.EZCANCELFLAG = IV.EZCANCELFLAG
                            AND OIV.INV_TP_CD    = #invTpCdCm#
                            AND OIV.ORIG_INV_NUM = IV.INV_NUM)
                  THEN 'Y'
                  ELSE 'N'
              END                      AS CM_EXST_FLG 
            <!-- end   add 2017/11/20 QC#17089 -->

        FROM DS_INV_SLS_CR     ISC
            ,DFRD_ACCTG_RULE   DAR
            ,AJE_INV_ACCT_DIST IAD
            ,TOC_DLY_SNAP_SHOT TDS
            ,INV               IV
            ,DS_INV_TP         DIT
            <!-- start del 2017/10/26 QC#21752 -->
            <!-- ,SVC_INV           SI -->
            <!-- end del 2017/10/26 QC#21752 -->
            ,SVC_MACH_MSTR     SMM
            ,GLBL_CMPY         GC
            ,CCY               CCY
            <!-- start 2016/10/26 QC#14590 -->
            ,INV_LINE           IVL
            ,SVC_INV_LINE       SIL
            ,DS_CONTR           DCH
            ,DS_CONTR_DTL       DCD
            ,SHIP_TO_CUST       STC
            ,SVC_BR_POST_XREF   SBPX
            ,SVC_BR_FIN_BR_XREF SBFX
            ,SVC_BR_POST_XREF   SBPX_5
            ,SVC_BR_FIN_BR_XREF SBFX_5
            <!-- end 2016/10/26 QC#14590 -->
            <!-- start add 2019/01/07 QC#29734 -->
            ,AJE_INV_LINE_ALLOC AILA
            <!-- end add 2019/01/07 QC#29734 -->
      WHERE  ISC.GLBL_CMPY_CD            = #glblCmpyCd#
		 AND ISC.EZCANCELFLAG            = '0'
		 <!-- start mod 2017/11/28 QC#17089 -->
		 AND (ISC.NEXT_REV_RECOG_DT   &lt;= #batProcDt#
			OR EXISTS (SELECT 1 
                          FROM  INV OIV 
                          WHERE OIV.GLBL_CMPY_CD = IV.GLBL_CMPY_CD
                            AND OIV.EZCANCELFLAG = IV.EZCANCELFLAG
                            AND OIV.INV_TP_CD    = #invTpCdCm#
                            AND OIV.ORIG_INV_NUM = IV.INV_NUM)
		 )
		 <!-- end   mod 2017/11/28 QC#17089 -->
		 AND ISC.REV_RECOG_PROC_STS_CD   in (#notProcessed#, #inProcess#)
		 AND ISC.DEAL_DFRD_BAL_AMT   &lt;&gt; 0
		 AND ISC.GLBL_CMPY_CD            = DAR.GLBL_CMPY_CD
		 AND ISC.EZCANCELFLAG            = DAR.EZCANCELFLAG
		 AND ISC.DFRD_ACCTG_RULE_CD      = DAR.DFRD_ACCTG_RULE_CD

		 AND ISC.DFRD_ACCTG_RULE_CD  &lt;&gt; #subscription#

		 AND DAR.DFRD_REV_FLG            = #flgY#
		 AND ISC.GLBL_CMPY_CD            = IAD.GLBL_CMPY_CD
		 AND ISC.EZCANCELFLAG            = IAD.EZCANCELFLAG
		 AND ISC.DS_INV_SLS_CR_PK        = IAD.DS_INV_SLS_CR_PK
		 AND IAD.DFRD_REV_GL_STRG_FLG    = #flgY#
		 <!--- add 2016/06/23 -->
		 AND IAD.PROC_STS_CD             = #completed#
		 <!-- end -->
		 AND ISC.GLBL_CMPY_CD            = TDS.GLBL_CMPY_CD
		 AND ISC.EZCANCELFLAG            = TDS.EZCANCELFLAG
		 AND ISC.SLS_REP_TOC_CD          = TDS.TOC_CD
		 AND ISC.GLBL_CMPY_CD            = IV.GLBL_CMPY_CD
		 AND ISC.EZCANCELFLAG            = IV.EZCANCELFLAG
		 AND ISC.INV_NUM                 = IV.INV_NUM
		 AND IV.GLBL_CMPY_CD             = DIT.GLBL_CMPY_CD
		 AND IV.EZCANCELFLAG             = DIT.EZCANCELFLAG
		 AND IV.DS_INV_TP_CD             = DIT.DS_INV_TP_CD
		 <!-- start add 2016/07/18 QC#12048 -->
		 AND DIT.POST_TO_GL_FLG          = #flgY#
		 <!-- end 2016/07/18 QC#12048 -->
		 <!-- start mod 2017/10/26 QC#21752 -->
		 AND SIL.GLBL_CMPY_CD            = SMM.GLBL_CMPY_CD(+)
		 AND SIL.EZCANCELFLAG            = SMM.EZCANCELFLAG(+)
		 AND SIL.SVC_MACH_MSTR_PK        = SMM.SVC_MACH_MSTR_PK(+)
		 <!-- start mod 2017/10/26 QC#21752 -->
		 AND ISC.GLBL_CMPY_CD            = GC.GLBL_CMPY_CD
		 AND GC.EZCANCELFLAG             = '0' 
		 AND ISC.GLBL_CMPY_CD            = CCY.GLBL_CMPY_CD
		 AND ISC.EZCANCELFLAG            = CCY.EZCANCELFLAG
		 AND ISC.DEAL_CCY_CD             = CCY.CCY_CD
         <!-- start 2016/10/26 QC#14590 -->
         AND ISC.GLBL_CMPY_CD            = IVL.GLBL_CMPY_CD
         AND ISC.INV_NUM                 = IVL.INV_NUM
         AND ISC.INV_BOL_LINE_NUM        = IVL.INV_BOL_LINE_NUM
         AND ISC.INV_LINE_NUM            = IVL.INV_LINE_NUM
         AND ISC.INV_LINE_SUB_NUM        = IVL.INV_LINE_SUB_NUM
         AND ISC.INV_TRX_LINE_SUB_NUM    = IVL.INV_LINE_SUB_TRX_NUM
         AND IVL.EZCANCELFLAG            = '0'
         AND IVL.GLBL_CMPY_CD            = SIL.GLBL_CMPY_CD(+)
         AND IVL.SVC_INV_LINE_PK         = SIL.SVC_INV_LINE_PK(+)
         AND SIL.EZCANCELFLAG(+)         = '0'
         AND SIL.GLBL_CMPY_CD            = DCH.GLBL_CMPY_CD(+)
         AND SIL.DS_CONTR_PK             = DCH.DS_CONTR_PK(+)
         AND DCH.EZCANCELFLAG(+)         = '0'
         AND SIL.GLBL_CMPY_CD            = DCD.GLBL_CMPY_CD(+)
         AND SIL.DS_CONTR_DTL_PK         = DCD.DS_CONTR_DTL_PK(+)
         AND DCD.EZCANCELFLAG(+)         = '0'
         AND DCD.GLBL_CMPY_CD            = STC.GLBL_CMPY_CD(+)
         AND DCD.SHIP_TO_CUST_CD         = STC.SHIP_TO_CUST_CD(+)
         AND STC.EZCANCELFLAG(+)         = '0'
         AND STC.GLBL_CMPY_CD            = SBPX.GLBL_CMPY_CD(+)
         AND STC.POST_CD                 = SBPX.POST_CD(+)
         AND DCH.SVC_LINE_BIZ_CD         = SBPX.SVC_LINE_BIZ_CD(+)
         AND SBPX.EZCANCELFLAG(+)        = '0'
         AND SBPX.GLBL_CMPY_CD           = SBFX.GLBL_CMPY_CD(+)
         AND SBPX.SVC_BR_CD              = SBFX.SVC_BR_CD(+)
         <!-- START 2018/09/10 K.Kitachi [QC#26260, MOD] -->
         <!-- AND SBPX.SVC_LINE_BIZ_CD        = SBFX.SVC_LINE_BIZ_CD(+) -->
         AND SBPX.SVC_LINE_BIZ_CD        = SBFX.SVC_BY_LINE_BIZ_TP_CD(+)
         AND SBPX.SVC_LINE_BIZ_CD        = SBFX.SLD_BY_LINE_BIZ_TP_CD(+)
         <!-- END 2018/09/10 K.Kitachi [QC#26260, MOD] -->
         AND SBFX.EZCANCELFLAG(+)        = '0'
         AND STC.GLBL_CMPY_CD            = SBPX_5.GLBL_CMPY_CD(+)
         AND SUBSTR(STC.POST_CD,1,5)     = SBPX_5.POST_CD(+)
         AND DCH.SVC_LINE_BIZ_CD         = SBPX_5.SVC_LINE_BIZ_CD(+)
         AND SBPX_5.EZCANCELFLAG(+)      = '0'
         AND SBPX_5.GLBL_CMPY_CD         = SBFX_5.GLBL_CMPY_CD(+)
         AND SBPX_5.SVC_BR_CD            = SBFX_5.SVC_BR_CD(+)
         <!-- START 2018/09/10 K.Kitachi [QC#26260, MOD] -->
         <!-- AND SBPX_5.SVC_LINE_BIZ_CD      = SBFX_5.SVC_LINE_BIZ_CD(+) -->
         AND SBPX_5.SVC_LINE_BIZ_CD      = SBFX_5.SVC_BY_LINE_BIZ_TP_CD(+)
         AND SBPX_5.SVC_LINE_BIZ_CD      = SBFX_5.SLD_BY_LINE_BIZ_TP_CD(+)
         <!-- END 2018/09/10 K.Kitachi [QC#26260, MOD] -->
         AND SBFX_5.EZCANCELFLAG(+)      = '0'
         <!-- end   2016/10/26 QC#14590 -->
         <!-- start add 2019/01/07 QC#29734 -->
         AND ISC.GLBL_CMPY_CD            = AILA.GLBL_CMPY_CD(+)
         AND ISC.AJE_INV_LINE_ALLOC_CD   = AILA.AJE_INV_LINE_ALLOC_CD(+)
         AND AILA.EZCANCELFLAG(+)        = '0'
         <!-- end add 2019/01/07 QC#29734 -->
    ORDER BY ISC.DS_INV_SLS_CR_PK ASC
            ,IAD.AJE_INV_ACCT_DIST_SQ_NUM
    </statement>
    
    <statement id="getTargetDataForTermination" parameterClass="Map">
      SELECT ISC.DS_INV_SLS_CR_PK
            ,ISC.TRX_CD
            ,ISC.TRX_RSN_CD
            ,ISC.INV_NUM
            ,ISC.INV_BOL_LINE_NUM
            ,ISC.INV_LINE_NUM
            ,ISC.INV_LINE_SUB_NUM
            ,ISC.INV_TRX_LINE_SUB_NUM
            ,ISC.DEAL_CCY_CD
            ,ISC.INV_LINE_SPL_PCT
            ,ISC.SLS_REP_CR_PCT
            ,ISC.DURN_START_DT
            ,ISC.REV_RECOG_CNT
            ,ISC.DEAL_DFRD_BAL_AMT
            ,ISC.DFRD_ACCTG_RULE_DURN_AOT
            ,GC.STD_CCY_CD
            ,IAD.AJE_INV_ACCT_DIST_SQ_NUM
            ,IAD.DR_CR_TP_CD
            ,IAD.AJE_COA_CMPY_CD
            ,IAD.AJE_COA_BR_CD
            ,IAD.AJE_COA_CC_CD
            ,IAD.AJE_COA_ACCT_CD
            ,IAD.AJE_COA_PROD_CD
            ,IAD.AJE_COA_CH_CD
            ,IAD.AJE_COA_AFFL_CD
            ,IAD.AJE_COA_PROJ_CD
            ,IAD.AJE_COA_EXTN_CD
            ,IAD.AJE_INV_ACCT_DIST_PCT
            ,IAD.AJE_INV_ACCT_CLS_CD 
            ,IAD.SYS_SRC_CD
            ,IAD.SYS_SRC_NM
            ,IAD.TRX_CD
            ,IAD.TRX_NM
            ,IAD.TRX_RSN_CD
            ,IAD.TRX_RSN_NM
            ,IAD.AJE_PTRN_IND_TP_CD_01
            ,IAD.AJE_PTRN_IND_TP_NM_01
            ,IAD.AJE_PTRN_ACTL_CD_01
            ,IAD.AJE_PTRN_ACTL_NM_01
            ,IAD.AJE_PTRN_IND_TP_CD_02
            ,IAD.AJE_PTRN_IND_TP_NM_02
            ,IAD.AJE_PTRN_ACTL_CD_02
            ,IAD.AJE_PTRN_ACTL_NM_02
            ,IAD.AJE_PTRN_IND_TP_CD_03
            ,IAD.AJE_PTRN_IND_TP_NM_03
            ,IAD.AJE_PTRN_ACTL_CD_03
            ,IAD.AJE_PTRN_ACTL_NM_03
            ,IAD.JRNL_SRC_CD
            ,IAD.JRNL_SRC_NM
            ,IAD.JRNL_CATG_CD
            ,IAD.JRNL_CATG_NM
            ,IAD.AJE_LINE_IDX_NUM
            ,IAD.AJE_LINE_IDX_DESC_TXT 
            ,CCY.AFT_DECL_PNT_DIGIT_NUM
            ,IAD.SYS_SRC_CD||'-'||ISC.TRX_CD||'-'||ISC.TRX_RSN_CD  AS AJE_ID
             <!-- start 2018/05/16 QC#26064 -->
            ,IV.LINE_BIZ_TP_CD                                     AS AJE_LINE_IND_TP_CD
             <!-- end 2018/05/16 QC#26064 -->
            <!-- start add 2019/01/07 QC#29734 -->
            ,(CASE
                WHEN
                     <iterate property="varRental" var="varRental[]" open="AILA.SVC_ALLOC_TP_CD IN (" close=")" conjunction=",">
                     #varRental[]#
                     </iterate>
                     THEN #re#
                ELSE #nonRe#
             END)                                                  AS SVC_ALLOC_IND_TP_CD
            <!-- end add 2019/01/07 QC#29734 -->
            -- at toc
            ,TDS.COA_BR_CD       AS "TOC_BR_CD"
            ,TDS.COA_CC_CD       AS "TOC_CC_CD"
            ,TDS.COA_EXTN_CD     AS "TOC_EXTN_CD"
            
            -- at INVTP-UNEARN
            ,DIT.UN_EARN_COA_CMPY_CD   AS "INVTP-UNEARN_CMPY_CD"
            ,DIT.UN_EARN_COA_BR_CD     AS "INVTP-UNEARN_BR_CD"
            ,DIT.UN_EARN_COA_CC_CD     AS "INVTP-UNEARN_CC_CD"
            ,DIT.UN_EARN_COA_ACCT_CD   AS "INVTP-UNEARN_ACCT_CD"
            ,DIT.UN_EARN_COA_PROD_CD   AS "INVTP-UNEARN_PROD_CD"
            ,DIT.UN_EARN_COA_CH_CD     AS "INVTP-UNEARN_CH_CD"
            ,DIT.UN_EARN_COA_AFFL_CD   AS "INVTP-UNEARN_AFFL_CD"
            ,DIT.UN_EARN_COA_PROJ_CD   AS "INVTP-UNEARN_PROJ_CD"
            ,DIT.UN_EARN_COA_EXTN_CD   AS "INVTP-UNEARN_EXTN_CD"
            
            -- at INVTP-SLS
            ,DIT.SLS_COA_CMPY_CD       AS "INVTP-SLS_CMPY_CD"
            ,DIT.SLS_COA_BR_CD         AS "INVTP-SLS_BR_CD"
            ,DIT.SLS_COA_CC_CD         AS "INVTP-SLS_CC_CD"
            ,DIT.SLS_COA_ACCT_CD       AS "INVTP-SLS_ACCT_CD"
            ,DIT.SLS_COA_PROD_CD       AS "INVTP-SLS_PROD_CD"
            ,DIT.SLS_COA_CH_CD         AS "INVTP-SLS_CH_CD"
            ,DIT.SLS_COA_AFFL_CD       AS "INVTP-SLS_AFFL_CD"
            ,DIT.SLS_COA_PROJ_CD       AS "INVTP-SLS_PROJ_CD"
            ,DIT.SLS_COA_EXTN_CD       AS "INVTP-SLS_EXTN_CD"
            
            -- at IB
            <!-- start 2016/10/26 QC#14590 -->
            <!-- ,SMM.FIN_BR_CD             AS "IB_BR_CD" -->
            ,NVL(SMM.FIN_BR_CD, NVL(NVL(SBFX.FIN_BR_CD, SBPX.SVC_BR_CD), NVL(SBFX_5.FIN_BR_CD, SBPX_5.SVC_BR_CD)))
                                       AS "IB_BR_CD"
            <!-- end 2016/10/26 QC#14590 -->
            <!-- start add 2017/10/26 QC#21752 -->
            ,SMM.FIN_BR_CD
            ,SBFX.FIN_BR_CD
            ,SBPX.SVC_BR_CD
            ,SBFX_5.FIN_BR_CD
            ,SBPX_5.SVC_BR_CD
            <!-- end add 2017/10/26 QC#21752 -->
            
            -- for AJE pattern indicator type
            , 'DE'                     AS AJE_ACCTG_RULE_CD
            , 'I'                      AS INV_INVTY_IND_TP_CD
            , ISC.DFRD_ACCTG_RULE_CD   AS DFRD_ACCTG_RULE_CD
            <!-- start add 2017/11/20 QC#17089 -->
            , CASE
                  WHEN EXISTS (
                      SELECT 1 
                          FROM  INV OIV 
                          WHERE OIV.GLBL_CMPY_CD = IV.GLBL_CMPY_CD
                            AND OIV.EZCANCELFLAG = IV.EZCANCELFLAG
                            AND OIV.INV_TP_CD    = #invTpCdCm#
                            AND OIV.ORIG_INV_NUM = IV.INV_NUM)
                  THEN 'Y'
                  ELSE 'N'
              END                      AS CM_EXST_FLG 
            <!-- end   add 2017/11/20 QC#17089 -->
        FROM DS_INV_SLS_CR     ISC
            ,INV_LINE          IVL
            ,DS_CONTR_DTL      DCD
            ,DFRD_ACCTG_RULE   DAR
            ,AJE_INV_ACCT_DIST IAD
            ,TOC_DLY_SNAP_SHOT TDS
            ,INV               IV
            ,DS_INV_TP         DIT
            <!-- start del 2017/10/26 QC#21752 -->
            <!-- ,SVC_INV           SI -->
            <!-- end del 2017/10/26 QC#21752 -->
            ,SVC_MACH_MSTR     SMM
            ,GLBL_CMPY         GC
            ,CCY               CCY
            <!-- start 2016/10/26 QC#14590 -->
            ,SVC_INV_LINE       SIL
            ,DS_CONTR           DCH
            ,SHIP_TO_CUST       STC
            ,SVC_BR_POST_XREF   SBPX
            ,SVC_BR_FIN_BR_XREF SBFX
            ,SVC_BR_POST_XREF   SBPX_5
            ,SVC_BR_FIN_BR_XREF SBFX_5
            <!-- end 2016/10/26 QC#14590 -->
            <!-- start add 2019/01/07 QC#29734 -->
            ,AJE_INV_LINE_ALLOC AILA
            <!-- end add 2019/01/07 QC#29734 -->
      WHERE  ISC.GLBL_CMPY_CD            = #glblCmpyCd#
		 AND ISC.EZCANCELFLAG            = '0'
		 AND ISC.REV_RECOG_PROC_STS_CD   in (#notProcessed#, #inProcess#)
		 AND ISC.DEAL_DFRD_BAL_AMT   &lt;&gt; 0
		 AND ISC.GLBL_CMPY_CD            = DAR.GLBL_CMPY_CD
		 AND ISC.EZCANCELFLAG            = DAR.EZCANCELFLAG
		 AND ISC.DFRD_ACCTG_RULE_CD      = DAR.DFRD_ACCTG_RULE_CD

		 AND ISC.DFRD_ACCTG_RULE_CD  &lt;&gt; #subscription#

		 AND DAR.DFRD_REV_FLG            = #flgY#
		 AND ISC.GLBL_CMPY_CD            = IVL.GLBL_CMPY_CD
		 AND ISC.EZCANCELFLAG            = IVL.EZCANCELFLAG
		 AND ISC.INV_NUM                 = IVL.INV_NUM
		 AND ISC.INV_BOL_LINE_NUM        = IVL.INV_BOL_LINE_NUM
		 AND ISC.INV_LINE_NUM            = IVL.INV_LINE_NUM
		 AND ISC.INV_LINE_SUB_NUM        = IVL.INV_LINE_SUB_NUM
		 AND ISC.INV_TRX_LINE_SUB_NUM    = IVL.INV_LINE_SUB_TRX_NUM
		 AND IVL.GLBL_CMPY_CD            = DCD.GLBL_CMPY_CD(+)
		 AND IVL.EZCANCELFLAG            = DCD.EZCANCELFLAG(+)
		 AND IVL.DS_CONTR_DTL_PK         = DCD.DS_CONTR_DTL_PK(+)
		 <!-- START 2017/02/09 S.Fujita [QC#14655,MOD] -->
		 <!-- 
         AND DCD.DS_CONTR_DTL_STS_CD     = #trmd#
          -->
         <!-- start mod 2018/10/10 QC#28022 -->
         <!-- 
         <isNotNull property="contrInactvStsCdArray">
         AND DCD.DS_CONTR_DTL_STS_CD     IN (
          <iterate property="contrInactvStsCdArray" var="contrInactvStsCd[]" open="" close="" conjunction=",">
              #contrInactvStsCd[]#
          </iterate>
            )
         </isNotNull>
         -->
         <!-- END   2017/02/09 S.Fujita [QC#14655,MOD] -->
         AND ((<isNotNull property="contrInactvStsCdArray">
               DCD.DS_CONTR_DTL_STS_CD     IN (
               <iterate property="contrInactvStsCdArray" var="contrInactvStsCd[]" open="" close="" conjunction=",">
                   #contrInactvStsCd[]#
               </iterate>
               )
               </isNotNull>
               AND NOT EXISTS (SELECT
                                      1
                                 FROM
                                      SVC_MACH_EXCH_TRK SMET
                                WHERE
                                      SMET.GLBL_CMPY_CD         = DCD.GLBL_CMPY_CD
                                  AND SMET.EZCANCELFLAG         = DCD.EZCANCELFLAG
                                  AND SMET.ORIG_DS_CONTR_DTL_PK = DCD.DS_CONTR_DTL_PK
                              )
              )
              OR (EXISTS (SELECT
                                 1
                            FROM
                                 SVC_MACH_EXCH_TRK SMET
                           WHERE
                                 SMET.GLBL_CMPY_CD         = DCD.GLBL_CMPY_CD
                             AND SMET.EZCANCELFLAG         = DCD.EZCANCELFLAG
                             AND SMET.ORIG_DS_CONTR_DTL_PK = DCD.DS_CONTR_DTL_PK
                         )
                 AND EXISTS (SELECT
                                   1
                             FROM
                                   DS_CONTR_DTL DCD2
                             WHERE
                                   DCD2.GLBL_CMPY_CD                                = DCD.GLBL_CMPY_CD
                               AND DCD2.EZCANCELFLAG                                = DCD.EZCANCELFLAG
                               <isNotNull property="contrInactvStsCdArray"> 
                               AND DCD2.DS_CONTR_DTL_STS_CD     IN (
                                    <iterate property="contrInactvStsCdArray" var="contrInactvStsCd[]" open="" close="" conjunction=",">
                                    #contrInactvStsCd[]#
                                    </iterate>
                                    )
                               </isNotNull>
                                    AND DCD2.DS_CONTR_DTL_PK IN (SELECT
                                                                        SMET2.EXCH_DS_CONTR_DTL_PK
                                                                   FROM
                                                                        SVC_MACH_EXCH_TRK SMET2
                                                                  WHERE
                                                                        SMET2.GLBL_CMPY_CD                      = DCD.GLBL_CMPY_CD
                                                                    AND SMET2.EZCANCELFLAG                      = DCD.EZCANCELFLAG
                                                                    AND CONNECT_BY_ISLEAF                       = 1
                                                                    START WITH SMET2.ORIG_DS_CONTR_DTL_PK       = DCD.DS_CONTR_DTL_PK
                                                                    CONNECT BY PRIOR SMET2.EXCH_DS_CONTR_DTL_PK = SMET2.ORIG_DS_CONTR_DTL_PK
                                                                 )
                                 )
                  )
             )
         <!-- end mod 2018/10/10 QC#28022 -->
		 AND ISC.GLBL_CMPY_CD            = IAD.GLBL_CMPY_CD
		 AND ISC.EZCANCELFLAG            = IAD.EZCANCELFLAG
		 AND ISC.DS_INV_SLS_CR_PK        = IAD.DS_INV_SLS_CR_PK
		 AND IAD.DFRD_REV_GL_STRG_FLG    = #flgY#
		 <!--- add 2016/06/23 -->
		 AND IAD.PROC_STS_CD             = #completed#
		 <!-- end -->
		 AND ISC.GLBL_CMPY_CD            = TDS.GLBL_CMPY_CD
		 AND ISC.EZCANCELFLAG            = TDS.EZCANCELFLAG
		 AND ISC.SLS_REP_TOC_CD          = TDS.TOC_CD
		 AND ISC.GLBL_CMPY_CD            = IV.GLBL_CMPY_CD
		 AND ISC.EZCANCELFLAG            = IV.EZCANCELFLAG
		 AND ISC.INV_NUM                 = IV.INV_NUM
		 AND IV.GLBL_CMPY_CD             = DIT.GLBL_CMPY_CD
		 AND IV.EZCANCELFLAG             = DIT.EZCANCELFLAG
		 AND IV.DS_INV_TP_CD             = DIT.DS_INV_TP_CD
		 <!-- start add 2016/07/18 QC#12048 -->
		 AND DIT.POST_TO_GL_FLG          = #flgY#
		 <!-- end 2016/07/18 QC#12048 -->
		 <!-- start mod 2017/10/26 QC#21752 -->
		 AND SIL.GLBL_CMPY_CD            = SMM.GLBL_CMPY_CD(+)
		 AND SIL.EZCANCELFLAG            = SMM.EZCANCELFLAG(+)
		 AND SIL.SVC_MACH_MSTR_PK        = SMM.SVC_MACH_MSTR_PK(+)
		 <!-- start mod 2017/10/26 QC#21752 -->
		 AND ISC.GLBL_CMPY_CD            = GC.GLBL_CMPY_CD
		 AND GC.EZCANCELFLAG             = '0' 
		 AND ISC.GLBL_CMPY_CD            = CCY.GLBL_CMPY_CD
		 AND ISC.EZCANCELFLAG            = CCY.EZCANCELFLAG
		 AND ISC.DEAL_CCY_CD             = CCY.CCY_CD
         <!-- start 2016/10/26 QC#14590 -->
         AND IVL.GLBL_CMPY_CD            = SIL.GLBL_CMPY_CD(+)
         AND IVL.SVC_INV_LINE_PK         = SIL.SVC_INV_LINE_PK(+)
         AND SIL.EZCANCELFLAG(+)         = '0'
         AND SIL.GLBL_CMPY_CD            = DCH.GLBL_CMPY_CD(+)
         AND SIL.DS_CONTR_PK             = DCH.DS_CONTR_PK(+)
         AND DCH.EZCANCELFLAG(+)         = '0'
         AND DCD.GLBL_CMPY_CD            = STC.GLBL_CMPY_CD(+)
         AND DCD.SHIP_TO_CUST_CD         = STC.SHIP_TO_CUST_CD(+)
         AND STC.EZCANCELFLAG(+)         = '0'
         AND STC.GLBL_CMPY_CD            = SBPX.GLBL_CMPY_CD(+)
         AND STC.POST_CD                 = SBPX.POST_CD(+)
         AND DCH.SVC_LINE_BIZ_CD         = SBPX.SVC_LINE_BIZ_CD(+)
         AND SBPX.EZCANCELFLAG(+)        = '0'
         AND SBPX.GLBL_CMPY_CD           = SBFX.GLBL_CMPY_CD(+)
         AND SBPX.SVC_BR_CD              = SBFX.SVC_BR_CD(+)
         <!-- START 2018/09/10 K.Kitachi [QC#26260, MOD] -->
         <!-- AND SBPX.SVC_LINE_BIZ_CD        = SBFX.SVC_LINE_BIZ_CD(+) -->
         AND SBPX.SVC_LINE_BIZ_CD        = SBFX.SVC_BY_LINE_BIZ_TP_CD(+)
         AND SBPX.SVC_LINE_BIZ_CD        = SBFX.SLD_BY_LINE_BIZ_TP_CD(+)
         <!-- END 2018/09/10 K.Kitachi [QC#26260, MOD] -->
         AND SBFX.EZCANCELFLAG(+)        = '0'
         AND STC.GLBL_CMPY_CD            = SBPX_5.GLBL_CMPY_CD(+)
         AND SUBSTR(STC.POST_CD,1,5)     = SBPX_5.POST_CD(+)
         AND DCH.SVC_LINE_BIZ_CD         = SBPX_5.SVC_LINE_BIZ_CD(+)
         AND SBPX_5.EZCANCELFLAG(+)      = '0'
         AND SBPX_5.GLBL_CMPY_CD         = SBFX_5.GLBL_CMPY_CD(+)
         AND SBPX_5.SVC_BR_CD            = SBFX_5.SVC_BR_CD(+)
         <!-- START 2018/09/10 K.Kitachi [QC#26260, MOD] -->
         <!-- AND SBPX_5.SVC_LINE_BIZ_CD      = SBFX_5.SVC_LINE_BIZ_CD(+) -->
         AND SBPX_5.SVC_LINE_BIZ_CD      = SBFX_5.SVC_BY_LINE_BIZ_TP_CD(+)
         AND SBPX_5.SVC_LINE_BIZ_CD      = SBFX_5.SLD_BY_LINE_BIZ_TP_CD(+)
         <!-- END 2018/09/10 K.Kitachi [QC#26260, MOD] -->
         AND SBFX_5.EZCANCELFLAG(+)      = '0'
         <!-- end   2016/10/26 QC#14590 -->
         <!-- start add 2019/01/07 QC#29734 -->
         AND ISC.GLBL_CMPY_CD            = AILA.GLBL_CMPY_CD(+)
         AND ISC.AJE_INV_LINE_ALLOC_CD   = AILA.AJE_INV_LINE_ALLOC_CD(+)
         AND AILA.EZCANCELFLAG(+)        = '0'
         <!-- end add 2019/01/07 QC#29734 -->
         <!-- start del 2018/10/10 QC#28022 -->
         <!-- start 2018/07/10 QC#26843 -->
         <!--
         AND NOT EXISTS (
                SELECT
                    1
                FROM
                    DS_CPO_RTRN_DTL    CD
                   ,CPO                CH
                   ,ORD_CATG_BIZ_CTX   CTX
                WHERE
                        IVL.GLBL_CMPY_CD             = CD.GLBL_CMPY_CD
                    AND IVL.EZCANCELFLAG             = CD.EZCANCELFLAG
                    AND IVL.SVC_CONFIG_MSTR_PK       = CD.SVC_CONFIG_MSTR_PK
                    AND IVL.SVC_MACH_MSTR_PK         = CD.SVC_MACH_MSTR_PK
                    AND CD.GLBL_CMPY_CD              = CH.GLBL_CMPY_CD
                    AND CD.EZCANCELFLAG              = CH.EZCANCELFLAG
                    AND CD.CPO_ORD_NUM               = CH.CPO_ORD_NUM
                    AND CH.GLBL_CMPY_CD              = CTX.GLBL_CMPY_CD
                    AND CH.EZCANCELFLAG              = CTX.EZCANCELFLAG
                    AND (   CH.DS_ORD_RSN_CD         = CTX.DS_ORD_RSN_CD
                         OR CTX.DS_ORD_RSN_CD        IS NULL
                         )
                    AND (   CH.DS_ORD_CATG_CD        = CTX.DS_ORD_CATG_CD
                         OR CTX.DS_ORD_CATG_CD       IS NULL
                         )
                    AND (   CH.DS_ORD_TP_CD          = CTX.DS_ORD_TP_CD
                         OR CTX.DS_ORD_TP_CD         IS NULL
                         )
                    AND CTX.ORD_CATG_CTX_TP_CD       = #svcExch#
            )
         -->
         <!-- end   2018/07/10 QC#26843 -->
         <!-- end del 2018/10/10 QC#28022 -->
	<!-- START 2017/02/09 S.Fujita [QC#14655,MOD] -->
    UNION
    SELECT   ISC.DS_INV_SLS_CR_PK
            ,ISC.TRX_CD
            ,ISC.TRX_RSN_CD
            ,ISC.INV_NUM
            ,ISC.INV_BOL_LINE_NUM
            ,ISC.INV_LINE_NUM
            ,ISC.INV_LINE_SUB_NUM
            ,ISC.INV_TRX_LINE_SUB_NUM
            ,ISC.DEAL_CCY_CD
            ,ISC.INV_LINE_SPL_PCT
            ,ISC.SLS_REP_CR_PCT
            ,ISC.DURN_START_DT
            ,ISC.REV_RECOG_CNT
            ,ISC.DEAL_DFRD_BAL_AMT
            ,ISC.DFRD_ACCTG_RULE_DURN_AOT
            ,GC.STD_CCY_CD
            ,IAD.AJE_INV_ACCT_DIST_SQ_NUM
            ,IAD.DR_CR_TP_CD
            ,IAD.AJE_COA_CMPY_CD
            ,IAD.AJE_COA_BR_CD
            ,IAD.AJE_COA_CC_CD
            ,IAD.AJE_COA_ACCT_CD
            ,IAD.AJE_COA_PROD_CD
            ,IAD.AJE_COA_CH_CD
            ,IAD.AJE_COA_AFFL_CD
            ,IAD.AJE_COA_PROJ_CD
            ,IAD.AJE_COA_EXTN_CD
            ,IAD.AJE_INV_ACCT_DIST_PCT
            ,IAD.AJE_INV_ACCT_CLS_CD 
            ,IAD.SYS_SRC_CD
            ,IAD.SYS_SRC_NM
            ,IAD.TRX_CD
            ,IAD.TRX_NM
            ,IAD.TRX_RSN_CD
            ,IAD.TRX_RSN_NM
            ,IAD.AJE_PTRN_IND_TP_CD_01
            ,IAD.AJE_PTRN_IND_TP_NM_01
            ,IAD.AJE_PTRN_ACTL_CD_01
            ,IAD.AJE_PTRN_ACTL_NM_01
            ,IAD.AJE_PTRN_IND_TP_CD_02
            ,IAD.AJE_PTRN_IND_TP_NM_02
            ,IAD.AJE_PTRN_ACTL_CD_02
            ,IAD.AJE_PTRN_ACTL_NM_02
            ,IAD.AJE_PTRN_IND_TP_CD_03
            ,IAD.AJE_PTRN_IND_TP_NM_03
            ,IAD.AJE_PTRN_ACTL_CD_03
            ,IAD.AJE_PTRN_ACTL_NM_03
            ,IAD.JRNL_SRC_CD
            ,IAD.JRNL_SRC_NM
            ,IAD.JRNL_CATG_CD
            ,IAD.JRNL_CATG_NM
            ,IAD.AJE_LINE_IDX_NUM
            ,IAD.AJE_LINE_IDX_DESC_TXT 
            ,CCY.AFT_DECL_PNT_DIGIT_NUM
            ,IAD.SYS_SRC_CD||'-'||ISC.TRX_CD||'-'||ISC.TRX_RSN_CD  AS AJE_ID
             <!-- start 2018/05/16 QC#26064 -->
            ,IV.LINE_BIZ_TP_CD                                     AS AJE_LINE_IND_TP_CD
             <!-- end 2018/05/16 QC#26064 -->
            <!-- start add 2019/01/07 QC#29734 -->
            ,(CASE
                WHEN
                     <iterate property="varRental" var="varRental[]" open="AILA.SVC_ALLOC_TP_CD IN (" close=")" conjunction=",">
                     #varRental[]#
                     </iterate>
                     THEN #re#
                ELSE #nonRe#
             END)                                                  AS SVC_ALLOC_IND_TP_CD
            <!-- end add 2019/01/07 QC#29734 -->
            -- at toc
            ,TDS.COA_BR_CD       AS "TOC_BR_CD"
            ,TDS.COA_CC_CD       AS "TOC_CC_CD"
            ,TDS.COA_EXTN_CD     AS "TOC_EXTN_CD"

            -- at INVTP-UNEARN
            ,DIT.UN_EARN_COA_CMPY_CD   AS "INVTP-UNEARN_CMPY_CD"
            ,DIT.UN_EARN_COA_BR_CD     AS "INVTP-UNEARN_BR_CD"
            ,DIT.UN_EARN_COA_CC_CD     AS "INVTP-UNEARN_CC_CD"
            ,DIT.UN_EARN_COA_ACCT_CD   AS "INVTP-UNEARN_ACCT_CD"
            ,DIT.UN_EARN_COA_PROD_CD   AS "INVTP-UNEARN_PROD_CD"
            ,DIT.UN_EARN_COA_CH_CD     AS "INVTP-UNEARN_CH_CD"
            ,DIT.UN_EARN_COA_AFFL_CD   AS "INVTP-UNEARN_AFFL_CD"
            ,DIT.UN_EARN_COA_PROJ_CD   AS "INVTP-UNEARN_PROJ_CD"
            ,DIT.UN_EARN_COA_EXTN_CD   AS "INVTP-UNEARN_EXTN_CD"

            -- at INVTP-SLS
            ,DIT.SLS_COA_CMPY_CD       AS "INVTP-SLS_CMPY_CD"
            ,DIT.SLS_COA_BR_CD         AS "INVTP-SLS_BR_CD"
            ,DIT.SLS_COA_CC_CD         AS "INVTP-SLS_CC_CD"
            ,DIT.SLS_COA_ACCT_CD       AS "INVTP-SLS_ACCT_CD"
            ,DIT.SLS_COA_PROD_CD       AS "INVTP-SLS_PROD_CD"
            ,DIT.SLS_COA_CH_CD         AS "INVTP-SLS_CH_CD"
            ,DIT.SLS_COA_AFFL_CD       AS "INVTP-SLS_AFFL_CD"
            ,DIT.SLS_COA_PROJ_CD       AS "INVTP-SLS_PROJ_CD"
            ,DIT.SLS_COA_EXTN_CD       AS "INVTP-SLS_EXTN_CD"

            -- at IB
            ,''                        AS "IB_BR_CD"
            <!-- start add 2017/10/26 QC#21752 -->
            ,'' AS FIN_BR_CD
            ,'' AS FIN_BR_CD
            ,'' AS SVC_BR_CD
            ,'' AS FIN_BR_CD
            ,'' AS SVC_BR_CD
            <!-- end add 2017/10/26 QC#21752 -->

            -- for AJE pattern indicator type
            , 'DE'                     AS AJE_ACCTG_RULE_CD
            , 'I'                      AS INV_INVTY_IND_TP_CD
            , ISC.DFRD_ACCTG_RULE_CD   AS DFRD_ACCTG_RULE_CD
            <!-- start add 2017/11/20 QC#17089 -->
            , CASE
                  WHEN EXISTS (
                      SELECT 1 
                          FROM  INV OIV 
                          WHERE OIV.GLBL_CMPY_CD = IV.GLBL_CMPY_CD
                            AND OIV.EZCANCELFLAG = IV.EZCANCELFLAG
                            AND OIV.INV_TP_CD    = #invTpCdCm#
                            AND OIV.ORIG_INV_NUM = IV.INV_NUM)
                  THEN 'Y'
                  ELSE 'N'
              END                      AS CM_EXST_FLG 
            <!-- end   add 2017/11/20 QC#17089 -->
    FROM     DS_INV_SLS_CR      ISC
            ,INV_LINE           IVL
            ,DS_CONTR_DTL       DCD
            ,DFRD_ACCTG_RULE    DAR
            ,AJE_INV_ACCT_DIST  IAD
            ,TOC_DLY_SNAP_SHOT  TDS
            ,INV                IV
            ,DS_INV_TP          DIT
            <!-- start 2018/08/28 QC#27801 -->
            <!-- ,SVC_INV            SI -->
            <!-- ,SVC_MACH_MSTR      SMM -->
            <!-- end 2018/08/28 QC#27801 -->
            ,GLBL_CMPY          GC
            ,CCY                CCY
            <!-- start 2018/08/28 QC#27801 -->
            <!-- ,SVC_INV_LINE       SIL -->
            <!-- ,DS_CONTR           DCH -->
            <!-- end 2018/08/28 QC#27801 -->
            ,SHIP_TO_CUST       STC
            <!-- start add 2019/01/07 QC#29734 -->
            ,AJE_INV_LINE_ALLOC AILA
            <!-- end add 2019/01/07 QC#29734 -->
    WHERE    ISC.GLBL_CMPY_CD            = #glblCmpyCd#
         AND ISC.EZCANCELFLAG            = '0'
         AND ISC.REV_RECOG_PROC_STS_CD   in (#notProcessed#, #inProcess#)
         AND ISC.DEAL_DFRD_BAL_AMT   &lt;&gt; 0
         <!-- START 2017/12/20 E.Kameishi [QC#22912,ADD] -->
         AND (ISC.INV_LINE_SPL_TP_CD  &lt;&gt; #invLineSplTpAlloc#
              OR ISC.INV_LINE_SPL_TP_CD IS NULL)
         <!-- END   2017/12/20 E.Kameishi [QC#22912,ADD] -->
         AND ISC.GLBL_CMPY_CD            = DAR.GLBL_CMPY_CD
         AND ISC.EZCANCELFLAG            = DAR.EZCANCELFLAG
         AND ISC.DFRD_ACCTG_RULE_CD      = DAR.DFRD_ACCTG_RULE_CD
         AND DAR.DFRD_REV_FLG            = #flgY#
         AND ISC.GLBL_CMPY_CD            = IVL.GLBL_CMPY_CD
         AND ISC.EZCANCELFLAG            = IVL.EZCANCELFLAG
         AND ISC.INV_NUM                 = IVL.INV_NUM
         AND ISC.INV_BOL_LINE_NUM        = IVL.INV_BOL_LINE_NUM
         AND ISC.INV_LINE_NUM            = IVL.INV_LINE_NUM
         AND ISC.INV_LINE_SUB_NUM        = IVL.INV_LINE_SUB_NUM
         AND ISC.INV_TRX_LINE_SUB_NUM    = IVL.INV_LINE_SUB_TRX_NUM
         AND IVL.GLBL_CMPY_CD            = DCD.GLBL_CMPY_CD
         AND IVL.EZCANCELFLAG            = DCD.EZCANCELFLAG
         AND IVL.SVC_MACH_MSTR_PK        = DCD.SVC_MACH_MSTR_PK
         <!-- QC#15410(Sol#246) Add Start -->
         AND IVL.DS_CONTR_DTL_PK         = DCD.DS_CONTR_DTL_PK
         <!-- QC#15410(Sol#246) Add End -->
         <!-- start mod 2018/10/10 QC#28022 -->
         <!--
         AND NOT EXISTS (
                SELECT
                    1
                FROM
                    DS_CONTR_DTL    DCO
                WHERE
                        IVL.GLBL_CMPY_CD             = DCO.GLBL_CMPY_CD
                    AND IVL.EZCANCELFLAG             = DCO.EZCANCELFLAG
                    AND IVL.DS_CONTR_DTL_PK          = DCO.DS_CONTR_DTL_PK
                    AND NVL(DCO.CONTR_EFF_THRU_DT, #maxEndDate#)    &gt;= #batProcDt#
                    <iterate property="contrActvStsCd" var="contrActvStsCd[]" open="AND DCO.DS_CONTR_DTL_STS_CD IN (" conjunction= ", " close=")">
                    #contrActvStsCd[]#
                    </iterate>
            )
         -->
         AND ((NOT EXISTS (
                SELECT
                    1
                FROM
                    DS_CONTR_DTL    DCO
                WHERE
                        IVL.GLBL_CMPY_CD             = DCO.GLBL_CMPY_CD
                    AND IVL.EZCANCELFLAG             = DCO.EZCANCELFLAG
                    AND IVL.DS_CONTR_DTL_PK          = DCO.DS_CONTR_DTL_PK
                    AND NVL(DCO.CONTR_EFF_THRU_DT, #maxEndDate#)    &gt;= #batProcDt#
                    <iterate property="contrActvStsCd" var="contrActvStsCd[]" open="AND DCO.DS_CONTR_DTL_STS_CD IN (" conjunction= ", " close=")">
                    #contrActvStsCd[]#
                    </iterate>
                    )
               AND NOT EXISTS (SELECT
                                      1
                                 FROM
                                      SVC_MACH_EXCH_TRK SMET
                                WHERE
                                      SMET.GLBL_CMPY_CD         = IVL.GLBL_CMPY_CD
                                  AND SMET.EZCANCELFLAG         = IVL.EZCANCELFLAG
                                  AND SMET.ORIG_DS_CONTR_DTL_PK = IVL.DS_CONTR_DTL_PK
                              )
              )
              OR (EXISTS (SELECT
                                 1
                            FROM
                                 SVC_MACH_EXCH_TRK SMET
                           WHERE
                                 SMET.GLBL_CMPY_CD         = IVL.GLBL_CMPY_CD
                             AND SMET.EZCANCELFLAG         = IVL.EZCANCELFLAG
                             AND SMET.ORIG_DS_CONTR_DTL_PK = IVL.DS_CONTR_DTL_PK
                         )
                 AND NOT EXISTS (SELECT
                                        1
                                   FROM
                                        DS_CONTR_DTL DCD2
                                  WHERE
                                        DCD2.GLBL_CMPY_CD                                = IVL.GLBL_CMPY_CD
                                    AND DCD2.EZCANCELFLAG                                = IVL.EZCANCELFLAG 
                                    AND NVL(DCD2.CONTR_EFF_THRU_DT, #maxEndDate#)    &gt;= #batProcDt#
                                    <iterate property="contrActvStsCd" var="contrActvStsCd[]" open="AND DCD2.DS_CONTR_DTL_STS_CD IN (" conjunction= ", " close=")">
                                    #contrActvStsCd[]#
                                    </iterate>
                                    AND DCD2.DS_CONTR_DTL_PK IN (SELECT
                                                                        SMET2.EXCH_DS_CONTR_DTL_PK
                                                                   FROM
                                                                        SVC_MACH_EXCH_TRK SMET2
                                                                  WHERE
                                                                        SMET2.GLBL_CMPY_CD                      = IVL.GLBL_CMPY_CD
                                                                    AND SMET2.EZCANCELFLAG                      = IVL.EZCANCELFLAG
                                                                    AND CONNECT_BY_ISLEAF                       = 1
                                                                    START WITH SMET2.ORIG_DS_CONTR_DTL_PK       = IVL.DS_CONTR_DTL_PK
                                                                    CONNECT BY PRIOR SMET2.EXCH_DS_CONTR_DTL_PK = SMET2.ORIG_DS_CONTR_DTL_PK
                                                                 )
                                 )
                  )
             )
         <!-- end mod 2018/10/10 QC#28022 -->
		 AND ISC.GLBL_CMPY_CD            = IAD.GLBL_CMPY_CD
		 AND ISC.EZCANCELFLAG            = IAD.EZCANCELFLAG
		 AND ISC.DS_INV_SLS_CR_PK        = IAD.DS_INV_SLS_CR_PK
		 AND IAD.DFRD_REV_GL_STRG_FLG    = #flgY#
		 AND IAD.PROC_STS_CD             = #completed#
		 AND ISC.GLBL_CMPY_CD            = TDS.GLBL_CMPY_CD
		 AND ISC.EZCANCELFLAG            = TDS.EZCANCELFLAG
		 AND ISC.SLS_REP_TOC_CD          = TDS.TOC_CD
		 AND ISC.GLBL_CMPY_CD            = IV.GLBL_CMPY_CD
		 AND ISC.EZCANCELFLAG            = IV.EZCANCELFLAG
		 AND ISC.INV_NUM                 = IV.INV_NUM
		 AND IV.GLBL_CMPY_CD             = DIT.GLBL_CMPY_CD
		 AND IV.EZCANCELFLAG             = DIT.EZCANCELFLAG
		 AND IV.DS_INV_TP_CD             = DIT.DS_INV_TP_CD
		 AND DIT.POST_TO_GL_FLG          = #flgY#
         <!-- start 2018/08/28 QC#27801 -->
		 <!-- AND ISC.GLBL_CMPY_CD            = SI.GLBL_CMPY_CD(+) -->
		 <!-- AND ISC.EZCANCELFLAG            = SI.EZCANCELFLAG(+)) -->
		 <!-- AND ISC.INV_NUM                 = SI.SVC_INV_NUM(+)) -->
		 <!-- AND SI.GLBL_CMPY_CD             = SMM.GLBL_CMPY_CD(+)) -->
		 <!-- AND SI.EZCANCELFLAG             = SMM.EZCANCELFLAG(+)) -->
		 <!-- AND SI.SVC_MACH_MSTR_PK         = SMM.SVC_MACH_MSTR_PK(+)) -->
         <!-- end 2018/08/28 QC#27801 -->
		 AND ISC.GLBL_CMPY_CD            = GC.GLBL_CMPY_CD
		 AND GC.EZCANCELFLAG             = '0' 
		 AND ISC.GLBL_CMPY_CD            = CCY.GLBL_CMPY_CD
		 AND ISC.EZCANCELFLAG            = CCY.EZCANCELFLAG
		 AND ISC.DEAL_CCY_CD             = CCY.CCY_CD
         <!-- start 2018/08/28 QC#27801 -->
         <!-- AND IVL.GLBL_CMPY_CD            = SIL.GLBL_CMPY_CD(+) -->
         <!-- AND IVL.SVC_INV_LINE_PK         = SIL.SVC_INV_LINE_PK(+) -->
         <!-- AND SIL.EZCANCELFLAG(+)         = '0' -->
         <!-- AND SIL.GLBL_CMPY_CD            = DCH.GLBL_CMPY_CD(+) -->
         <!-- AND SIL.DS_CONTR_PK             = DCH.DS_CONTR_PK(+) -->
         <!-- AND DCH.EZCANCELFLAG(+)         = '0' -->
         <!-- end 2018/08/28 QC#27801 -->
         AND DCD.GLBL_CMPY_CD            = STC.GLBL_CMPY_CD(+)
         AND DCD.SHIP_TO_CUST_CD         = STC.SHIP_TO_CUST_CD(+)
         AND STC.EZCANCELFLAG(+)         = '0'
         <!-- start add 2019/01/07 QC#29734 -->
         AND ISC.GLBL_CMPY_CD            = AILA.GLBL_CMPY_CD(+)
         AND ISC.AJE_INV_LINE_ALLOC_CD   = AILA.AJE_INV_LINE_ALLOC_CD(+)
         AND AILA.EZCANCELFLAG(+)        = '0'
         <!-- end add 2019/01/07 QC#29734 -->
         <!-- start del 2018/10/10 QC#28022 -->
         <!-- start 2018/07/10 QC#26843 -->
         <!--
         AND NOT EXISTS (
                SELECT
                    1
                FROM
                    DS_CPO_RTRN_DTL    CD
                   ,CPO                CH
                   ,ORD_CATG_BIZ_CTX   CTX
                WHERE
                        IVL.GLBL_CMPY_CD             = CD.GLBL_CMPY_CD
                    AND IVL.EZCANCELFLAG             = CD.EZCANCELFLAG
                    AND IVL.SVC_CONFIG_MSTR_PK       = CD.SVC_CONFIG_MSTR_PK
                    AND IVL.SVC_MACH_MSTR_PK         = CD.SVC_MACH_MSTR_PK
                    AND CD.GLBL_CMPY_CD              = CH.GLBL_CMPY_CD
                    AND CD.EZCANCELFLAG              = CH.EZCANCELFLAG
                    AND CD.CPO_ORD_NUM               = CH.CPO_ORD_NUM
                    AND CH.GLBL_CMPY_CD              = CTX.GLBL_CMPY_CD
                    AND CH.EZCANCELFLAG              = CTX.EZCANCELFLAG
                    AND (   CH.DS_ORD_RSN_CD         = CTX.DS_ORD_RSN_CD
                         OR CTX.DS_ORD_RSN_CD        IS NULL
                         )
                    AND (   CH.DS_ORD_CATG_CD        = CTX.DS_ORD_CATG_CD
                         OR CTX.DS_ORD_CATG_CD       IS NULL
                         )
                    AND (   CH.DS_ORD_TP_CD          = CTX.DS_ORD_TP_CD
                         OR CTX.DS_ORD_TP_CD         IS NULL
                         )
                    AND CTX.ORD_CATG_CTX_TP_CD       = #svcExch#
            )
         -->
         <!-- end   2018/07/10 QC#26843 -->
         <!-- end del 2018/10/10 QC#28022 -->
         <!-- start 2018/08/28 QC#27801 -->
         AND NOT EXISTS (
               SELECT
                    1
               FROM
                    SVC_INV SIV
               WHERE
                    SIV.GLBL_CMPY_CD  = ISC.GLBL_CMPY_CD
               AND  SIV.EZCANCELFLAG  = ISC.EZCANCELFLAG
               AND  SIV.SVC_INV_NUM   = ISC.INV_NUM
         )
         <!-- end   2018/08/28 QC#27801 -->

    ORDER BY DS_INV_SLS_CR_PK ASC
            ,AJE_INV_ACCT_DIST_SQ_NUM
    <!-- END   2017/02/09 S.Fujita [QC#14655,MOD] -->
    </statement>

    <statement id="getDfrdInv" parameterClass="Map">
    SELECT ISC.DS_INV_SLS_CR_PK
          ,ISC.DFRD_ACCTG_RULE_CD
          ,ISC.INV_NUM
          ,ISC.INV_BOL_LINE_NUM
          ,ISC.INV_LINE_NUM
          ,ISC.INV_LINE_SUB_NUM
          ,ISC.INV_TRX_LINE_SUB_NUM
          ,ISC.INV_LINE_SPL_TP_CD
          ,ISC.DEAL_SLS_CR_AMT
          ,INV.INV_TP_CD
          ,INV.INV_DT
          ,NVL(IL.BLLG_PER_FROM_DT, INV.INV_DT) BLLG_PER_FROM_DT
          ,IL.ORD_QTY
	      ,DECODE(CD.CONTR_EFF_FROM_DT, NULL, NULL, CD.CONTR_EFF_FROM_DT) AS CONTR_EFF_FROM_DT
	      ,DECODE(CD.CONTR_EFF_THRU_DT, NULL, '99991231', CD.CONTR_EFF_THRU_DT) AS CONTR_EFF_THRU_DT
	      ,CD.BILL_WITH_EQUIP_FLG
	      ,CD.DS_CONTR_DTL_STS_CD
	      ,DAR.DFRD_REV_FLG
	      ,DAR.FIX_DURN_FLG
	      ,DAR.DFRD_ACCTG_RULE_DURN_AOT
	      ,MDSE.COA_MDSE_TP_CD
	      ,INV.SYS_SRC_CD
	      ,CCY.AFT_DECL_PNT_DIGIT_NUM
          ,0                      SUM_TERM_MTH_NUM
          <!-- QC#22688 mod Start -->
          <!-- ,BC.BLLG_CYCLE_MTH_AOT  BLLG_CYCLE_MTH_AOT -->
          ,CEIL(MONTHS_BETWEEN(TO_DATE(BLLG_PER_THRU_DT, 'YYYYMMDD'),TO_DATE(BLLG_PER_FROM_DT,'YYYYMMDD')))  BLLG_CYCLE_MTH_AOT
          <!-- QC#22688 mod End -->
          <!-- start add 2017/12/05 QC#22740 -->
          ,INV.CR_REBIL_RSN_CATG_CD
          <!-- end add 2017/12/05 QC#22740 -->
          ,#ur#                   TRGT_DATA
      FROM DS_INV_SLS_CR      ISC
          ,DFRD_ACCTG_RULE    DAR
          ,INV                INV
          ,INV_LINE           IL
          ,DS_CONTR_DTL       CD
          ,BLLG_CYCLE         BC
          ,MDSE               MDSE
          ,CCY                CCY
          ,DS_INV_TP          DIT
     WHERE ISC.GLBL_CMPY_CD          = #glblCmpyCd#
       AND ISC.EZCANCELFLAG          = '0'
       AND ISC.GLBL_CMPY_CD          = DAR.GLBL_CMPY_CD
       AND ISC.EZCANCELFLAG          = DAR.EZCANCELFLAG
       AND ISC.GLBL_CMPY_CD          = INV.GLBL_CMPY_CD
       AND INV.EZCANCELFLAG          = '0'
       AND ISC.GLBL_CMPY_CD          = IL.GLBL_CMPY_CD
       AND IL.EZCANCELFLAG           = '0'
       AND IL.GLBL_CMPY_CD          = #glblCmpyCd#
       AND ISC.GLBL_CMPY_CD          = CD.GLBL_CMPY_CD(+)
       AND ISC.EZCANCELFLAG          = CD.EZCANCELFLAG(+)
       AND CD.GLBL_CMPY_CD           = BC.GLBL_CMPY_CD(+)
       AND CD.EZCANCELFLAG           = BC.EZCANCELFLAG(+)
       AND ISC.GLBL_CMPY_CD          = MDSE.GLBL_CMPY_CD
       AND MDSE.EZCANCELFLAG         = '0'
       AND INV.GLBL_CMPY_CD          = CCY.GLBL_CMPY_CD
       AND CCY.EZCANCELFLAG          = '0'
       AND ISC.DFRD_ACCTG_RULE_CD    = DAR.DFRD_ACCTG_RULE_CD
       AND DAR.DFRD_REV_FLG          = #flgY#
       AND (ISC.REV_RECOG_CNT        = 0
        OR  ISC.REV_RECOG_CNT        IS NULL)
       AND ISC.INV_NUM               = INV.INV_NUM
       AND ISC.INV_NUM               = IL.INV_NUM
       AND ISC.INV_BOL_LINE_NUM      = IL.INV_BOL_LINE_NUM
       AND ISC.INV_LINE_NUM          = IL.INV_LINE_NUM
       AND ISC.INV_LINE_SUB_NUM      = IL.INV_LINE_SUB_NUM
       AND ISC.INV_TRX_LINE_SUB_NUM  = IL.INV_LINE_SUB_TRX_NUM
       AND IL.DS_CONTR_DTL_PK       = CD.DS_CONTR_DTL_PK(+)
       AND CD.BASE_BLLG_CYCLE_CD     = BC.BLLG_CYCLE_CD(+)
       AND ISC.MDSE_CD               = MDSE.MDSE_CD
       AND INV.SYS_SRC_CD            &lt;&gt; #nfc#
       AND INV.DEAL_CCY_CD           = CCY.CCY_CD
       AND INV.GLBL_CMPY_CD           = DIT.GLBL_CMPY_CD
       AND INV.EZCANCELFLAG           = DIT.EZCANCELFLAG
       AND INV.DS_INV_TP_CD           = DIT.DS_INV_TP_CD
       AND #flgY#                    = DIT.POST_TO_GL_FLG
       AND (ISC.INV_LINE_SPL_TP_CD   NOT IN (#dev#, #alloc#)
        OR  ISC.INV_LINE_SPL_TP_CD   IS NULL)
    UNION ALL
    SELECT ISC.DS_INV_SLS_CR_PK
          ,CASE
                WHEN
                    INV.INV_TP_CD = #invTpCr#
                THEN
                    #dfrdAcctgRuleIm#
                ELSE
                    MDSE.DFRD_ACCTG_RULE_CD
          END                     DFRD_ACCTG_RULE_CD
          ,ISC.INV_NUM
          ,ISC.INV_BOL_LINE_NUM
          ,ISC.INV_LINE_NUM
          ,ISC.INV_LINE_SUB_NUM
          ,ISC.INV_TRX_LINE_SUB_NUM
          ,ISC.INV_LINE_SPL_TP_CD
          ,ISC.DEAL_SLS_CR_AMT
          ,INV.INV_TP_CD
          ,INV.INV_DT
          ,INV.INV_DT             BLLG_PER_FROM_DT
          ,NULL                   ORD_QTY
          ,NULL                   CONTR_EFF_FROM_DT
          ,NULL                   CONTR_EFF_THRU_DT
          ,NULL                   BILL_WITH_EQUIP_FLG
          ,NULL                   DS_CONTR_DTL_STS_CD
          ,DAR.DFRD_REV_FLG
          ,DAR.FIX_DURN_FLG
          ,DAR.DFRD_ACCTG_RULE_DURN_AOT
          ,MDSE.COA_MDSE_TP_CD
          ,INV.SYS_SRC_CD
          ,CCY.AFT_DECL_PNT_DIGIT_NUM
          ,CSV.SUM_TERM_MTH_NUM
          ,NULL                   BLLG_CYCLE_MTH_AOT
          <!-- start add 2017/12/05 QC#22740 -->
          ,INV.CR_REBIL_RSN_CATG_CD
          <!-- end add 2017/12/05 QC#22740 -->
          ,#srt#                  TRGT_DATA
      FROM DS_INV_SLS_CR      ISC
          ,INV                INV
          ,CCY                CCY
          ,DS_INV_TP          DIT
          ,MDSE               MDSE
          ,DFRD_ACCTG_RULE    DAR
          <!-- start mod 2018/05/24 QC#25311 -->
          ,INV_LINE           IL
          ,SVC_CONFIG_MSTR    SCM
          ,(
            SELECT
                PER_MTH.GLBL_CMPY_CD GLBL_CMPY_CD
                ,PER_MTH.SVC_MACH_MSTR_PK REF_SVC_MACH_MSTR_PK
                ,SUM(PER_MTH.TERM_MTH_NUM) SUM_TERM_MTH_NUM
            FROM
                (
                    SELECT /*+ NO_PUSH_PRED */
                        DCD.GLBL_CMPY_CD
                        ,DCD.SVC_MACH_MSTR_PK
                        ,DCD.DS_CONTR_PK
                        <!-- START 2022/03/17 D.Mamaril [QC#59657, MOD] -->
                        <!-- ,DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1 TERM_MTH_NUM -->
                        ,CASE
                            WHEN DCD.TO_PER_MTH_NUM  IS NOT NULL AND DCD.FROM_PER_MTH_NUM IS NOT NULL
                                THEN DCD.TO_PER_MTH_NUM - DCD.FROM_PER_MTH_NUM + 1
                            WHEN DC.TO_PER_MTH_NUM  IS NOT NULL AND DC.FROM_PER_MTH_NUM IS NOT NULL
                                THEN DC.TO_PER_MTH_NUM - DC.FROM_PER_MTH_NUM + 1
                            ELSE #defaultTermMthNum#
                         END TERM_MTH_NUM
                        <!-- END 2022/03/17 D.Mamaril [QC#59657, MOD] -->
                        ,ROW_NUMBER() OVER(PARTITION BY DCD.GLBL_CMPY_CD, DCD.SVC_MACH_MSTR_PK, DCD.DS_CONTR_PK ORDER BY DCD.GLBL_CMPY_CD, DCD.SVC_MACH_MSTR_PK, DCD.DS_CONTR_PK) ROW_NUM
                    FROM
                        DS_CONTR_DTL DCD
                      , DS_CONTR DC
                      <!-- START 2022/03/17 D.Mamaril [QC#59657, ADD] -->
                      , DS_CONTR_STS_V DCSV
                      <!-- END 2022/03/17 D.Mamaril [QC#59657, ADD] -->
                    WHERE
                        DCD.GLBL_CMPY_CD = #glblCmpyCd#
                    AND DCD.EZCANCELFLAG = '0'
                    AND DCD.GLBL_CMPY_CD = DC.GLBL_CMPY_CD
                    AND DCD.EZCANCELFLAG = DC.EZCANCELFLAG
                    AND DCD.DS_CONTR_PK  = DC.DS_CONTR_PK
                    AND DC.DS_CONTR_TP_CD &lt;&gt; #warranty#
                    <!-- START 2022/03/17 D.Mamaril [QC#59657, ADD] -->
                    AND DCSV.EZCANCELFLAG = '0'
                    AND DCSV.GLBL_CMPY_CD = DC.GLBL_CMPY_CD
                    AND DCSV.DS_CONTR_PK = DC.DS_CONTR_PK
                    AND DCSV.DS_CONTR_STS_CD &lt;&gt; #dsContrStsCancelled#
                    <!-- END 2022/03/17 D.Mamaril [QC#59657, ADD] -->
                 ) PER_MTH
            WHERE
                ROW_NUM = 1
            GROUP BY
                PER_MTH.GLBL_CMPY_CD
                ,PER_MTH.SVC_MACH_MSTR_PK
            ) CSV
          <!-- end mod 2018/05/24 QC#25311 -->
     WHERE ISC.GLBL_CMPY_CD          = #glblCmpyCd#
       AND ISC.EZCANCELFLAG          = '0'
       AND ISC.INV_LINE_SPL_TP_CD   IN (#dev#, #alloc#)
       AND (ISC.REV_RECOG_CNT        = 0
        OR  ISC.REV_RECOG_CNT        IS NULL)
       AND ISC.GLBL_CMPY_CD          = INV.GLBL_CMPY_CD
       AND ISC.INV_NUM               = INV.INV_NUM
       AND INV.EZCANCELFLAG          = '0'
       AND INV.SYS_SRC_CD            &lt;&gt; #nfc#
       AND INV.GLBL_CMPY_CD          = CCY.GLBL_CMPY_CD
       AND INV.DEAL_CCY_CD           = CCY.CCY_CD
       AND CCY.EZCANCELFLAG          = '0'
       AND INV.GLBL_CMPY_CD           = DIT.GLBL_CMPY_CD
       AND INV.DS_INV_TP_CD           = DIT.DS_INV_TP_CD
       AND DIT.POST_TO_GL_FLG        = #flgY#
       AND DIT.EZCANCELFLAG          = '0'
       AND ISC.GLBL_CMPY_CD          = MDSE.GLBL_CMPY_CD
       AND ISC.MDSE_CD               = MDSE.MDSE_CD
       AND MDSE.EZCANCELFLAG         = '0'       
       AND MDSE.GLBL_CMPY_CD         = DAR.GLBL_CMPY_CD(+)
       AND MDSE.DFRD_ACCTG_RULE_CD   = DAR.DFRD_ACCTG_RULE_CD(+)
       AND DAR.EZCANCELFLAG(+)       = '0'
       AND INV.GLBL_CMPY_CD          = CSV.GLBL_CMPY_CD
       <!-- Start mod 2018/05/24 QC#25311 -->
       AND IL.EZCANCELFLAG           = '0'
       AND ISC.GLBL_CMPY_CD          = IL.GLBL_CMPY_CD
       AND ISC.INV_NUM               = IL.INV_NUM
       AND ISC.INV_BOL_LINE_NUM      = IL.INV_BOL_LINE_NUM
       AND ISC.INV_LINE_NUM          = IL.INV_LINE_NUM
       AND ISC.INV_LINE_SUB_NUM      = IL.INV_LINE_SUB_NUM
       AND ISC.INV_TRX_LINE_SUB_NUM  = IL.INV_LINE_SUB_TRX_NUM
       AND SCM.EZCANCELFLAG          = '0'
       AND IL.GLBL_CMPY_CD           = SCM.GLBL_CMPY_CD
       AND IL.SVC_CONFIG_MSTR_PK     = SCM.SVC_CONFIG_MSTR_PK
       AND SCM.GLBL_CMPY_CD          = CSV.GLBL_CMPY_CD
       AND SCM.SVC_MACH_MSTR_PK      = CSV.REF_SVC_MACH_MSTR_PK
<!--       AND INV.GLBL_CMPY_CD          = CSV.GLBL_CMPY_CD -->
<!--       AND INV.CPO_ORD_NUM           = CSV.REF_CPO_ORD_NUM-->
       <!-- end mod 2018/05/24 QC#25311 -->
    </statement>
    
    <statement id="getErrorDist" parameterClass="Map">
    SELECT IAD2.AJE_INV_ACCT_DIST_PK
      FROM AJE_INV_ACCT_DIST IAD
          ,AJE_INV_ACCT_DIST IAD2
     WHERE IAD.GLBL_CMPY_CD          = #glblCmpyCd#
       AND IAD.EZCANCELFLAG          = '0'
       AND IAD.JRNL_CRAT_DT          IS NULL
       AND IAD.PROC_STS_CD           = #error#
       AND IAD.GLBL_CMPY_CD          = IAD2.GLBL_CMPY_CD
       AND IAD2.EZCANCELFLAG         = '0'
       AND IAD.DS_INV_SLS_CR_PK      = IAD2.DS_INV_SLS_CR_PK
       AND IAD2.PROC_STS_CD          &lt;&gt; #error#
       AND IAD2.JRNL_CRAT_DT         IS NULL
    </statement>
    
    </sqlMap>