<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSAB003001">
   
   <statement id="getRenewalTargetList" parameterClass="Map" resultClass="Map">
        WITH
            IV_RNW_ESCL AS (
                        SELECT
                            RNW.DS_CONTR_MACH_LVL_NUM
                            ,RNW.DS_CONTR_PK
                            ,RNW.DS_CONTR_DTL_PK
                            <!-- START 2017/12/15 M.Kidokoro [QC#22859, MOD] -->
                            <!-- ,RNW.BEF_END_RNW_DAYS_AOT -->
                            ,NVL(RNW.BEF_END_RNW_DAYS_AOT, IDR.BEF_END_RNW_DAYS_AOT) BEF_END_RNW_DAYS_AOT
                            <!-- END 2017/12/15 M.Kidokoro [QC#22859, MOD] -->
                            ,RNW.DS_CONTR_BASE_USG_NM
                            ,RTP.RNW_BASE_FLG
                            ,RTP.RNW_USG_FLG
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            ,RTP.AUTO_RNW_FLG
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                        FROM
                            DS_CONTR_RNW_ESCL RNW
                            ,CONTR_AUTO_RNW_TP RTP
                            <!-- START 2017/12/15 M.Kidokoro [QC#22859, ADD] -->
                            ,DS_CONTR CON
                            ,DS_CONTR_INTFC_DEF_RULE IDR
                            <!-- END 2017/12/15 M.Kidokoro [QC#22859, ADD] -->
                        WHERE
                            RNW.GLBL_CMPY_CD             = #glblCmpyCd#
                            AND RNW.EZCANCELFLAG         = '0'
                            AND RNW.RNW_PRC_METH_CD      IS NOT NULL
                            AND RTP.GLBL_CMPY_CD         = RNW.GLBL_CMPY_CD
                            AND RTP.CONTR_AUTO_RNW_TP_CD = RNW.CONTR_AUTO_RNW_TP_CD
                            AND RTP.EZCANCELFLAG         = '0'
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                            <!-- AND RTP.AUTO_RNW_FLG         = 'Y' -->
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            AND (
                                (RTP.RNW_BASE_FLG         = 'Y')
                                OR
                                (RTP.RNW_USG_FLG          = 'Y')
                                )
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            <!-- START 2017/12/15 M.Kidokoro [QC#22859, ADD] -->
                            AND RNW.GLBL_CMPY_CD         = CON.GLBL_CMPY_CD(+)
                            AND RNW.DS_CONTR_PK          = CON.DS_CONTR_PK(+)
                            AND CON.EZCANCELFLAG(+)      = '0'
                            AND CON.GLBL_CMPY_CD         = IDR.GLBL_CMPY_CD(+)
                            AND CON.DS_CONTR_SRC_TP_CD   = IDR.CONTR_INTFC_SRC_TP_CD(+)
                            AND CON.DS_CONTR_CLS_CD      = IDR.DS_CONTR_CLS_CD(+)
                            AND CON.SVC_LINE_BIZ_CD      = IDR.SVC_LINE_BIZ_CD(+)
                            AND IDR.EZCANCELFLAG(+)      = '0'
                            AND IDR.EFF_FROM_DT(+)   &lt;= #slsDt#
                            AND IDR.ENBL_FLG(+)          = 'Y'
                            <!-- END 2017/12/15 M.Kidokoro [QC#22859, ADD] -->
            )
            ,IV_RNW_ESCL_NO_AUTO AS (
                        SELECT
                            RNW.DS_CONTR_MACH_LVL_NUM
                            ,RNW.DS_CONTR_PK
                            ,RNW.DS_CONTR_DTL_PK
                            ,RNW.BEF_END_RNW_DAYS_AOT
                            ,RNW.DS_CONTR_BASE_USG_NM
                            ,CASE WHEN RNW.CONTR_AUTO_RNW_TP_CD = #doNotRenew# THEN 'Y'
                                  ELSE RTP.RNW_BASE_FLG
                             END AS RNW_BASE_FLG
                            ,CASE WHEN RNW.CONTR_AUTO_RNW_TP_CD = #doNotRenew# THEN 'Y'
                                  ELSE RTP.RNW_USG_FLG
                             END AS RNW_USG_FLG
                            ,RNW.CONTR_AUTO_RNW_TP_CD
                        FROM
                            DS_CONTR_RNW_ESCL RNW
                            ,CONTR_AUTO_RNW_TP RTP
                        WHERE
                            RNW.GLBL_CMPY_CD             = #glblCmpyCd#
                            AND RNW.EZCANCELFLAG         = '0'
                            AND RTP.GLBL_CMPY_CD         = RNW.GLBL_CMPY_CD
                            AND RTP.CONTR_AUTO_RNW_TP_CD = RNW.CONTR_AUTO_RNW_TP_CD
                            AND RTP.EZCANCELFLAG         = '0'
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                            <!-- AND RTP.AUTO_RNW_FLG         = 'N' -->
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            AND RTP.RNW_BASE_FLG         = 'N'
                            AND RTP.RNW_USG_FLG          = 'N'
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
            )
            ,IV_DTL_STS_V AS(
                        SELECT
                            DSV.DS_CONTR_PK
                            ,DSV.DS_CONTR_DTL_PK
                        FROM
                            DS_CONTR_DTL_STS_V DSV
                            <!-- START 2021/12/02 R.Cabral [QC#59401, ADD] -->
                            ,DS_CONTR_DTL DTL
                            <!-- END   2021/12/02 R.Cabral [QC#59401, ADD] -->
                        WHERE
                            DSV.GLBL_CMPY_CD            = #glblCmpyCd#
                            AND DSV.EZCANCELFLAG        = '0'
                            AND DSV.CONTR_RNW_AVAL_FLG  = 'Y'
                            AND EXISTS(SELECT * FROM IV_RNW_ESCL RNV
                                        WHERE RNV.DS_CONTR_PK = DSV.DS_CONTR_PK)
                            <!-- START 2021/12/02 R.Cabral [QC#59401, ADD] -->
                            AND DSV.GLBL_CMPY_CD        = DTL.GLBL_CMPY_CD
                            AND DSV.DS_CONTR_DTL_PK     = DTL.DS_CONTR_DTL_PK
                            AND DTL.CONTR_CLO_DT IS NULL
                            AND DTL.EZCANCELFLAG        = '0'
                            <!-- END   2021/12/02 R.Cabral [QC#59401, ADD] -->
            )
        --Regular Lv3/Base
            ,IV_REG_LV3_BASE AS (
                        SELECT
                            DTL.DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK
                            ,CON.DS_CONTR_NUM
                            ,CON.DS_CONTR_CATG_CD
                            ,DTL.DS_CONTR_DTL_TP_CD
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            ,RNV.AUTO_RNW_FLG
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                        FROM
                            DS_CONTR       CON
                            ,DS_CONTR_DTL  DTL
                            ,IV_RNW_ESCL   RNV
                        WHERE
                            CON.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND CON.DS_CONTR_CATG_CD        = #dsContrCatgReg#
                            AND CON.EZCANCELFLAG            = '0'
                            AND CON.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                            AND CON.DS_CONTR_PK             = DTL.DS_CONTR_PK
                            AND DTL.EZCANCELFLAG            = '0'
                            AND DTL.DS_CONTR_PK             = RNV.DS_CONTR_PK
                            AND DTL.DS_CONTR_DTL_PK         = RNV.DS_CONTR_DTL_PK
                            AND RNV.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                            AND RNV.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmBase#
                            AND RNV.RNW_BASE_FLG            = 'Y'
                            AND EXISTS(SELECT * FROM IV_DTL_STS_V DSV
                                        WHERE
                                        DSV.DS_CONTR_PK         = DTL.DS_CONTR_PK
                                        AND DSV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK)
                            AND DTL.CONTR_EFF_THRU_DT BETWEEN #slsDt# AND TO_CHAR(TO_DATE(#slsDt#,#dateFormat#) + NVL(RNV.BEF_END_RNW_DAYS_AOT,0),#dateFormat#)
                            <!-- START 2017/10/05 K.Kojima [QC#21544, ADD] -->
                            AND (
                                (CON.MAX_CONTR_RNW_CNT IS NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL)
                                OR
                                (CON.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL AND CON.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                OR
                                (DTL.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                )
                            <!-- END 2017/10/05 K.Kojima [QC#21544, ADD] -->
            )
        --Regular Lv3/Usage
            ,IV_REG_LV3_USAGE AS (
                        SELECT
                            DTL.DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK
                            ,CON.DS_CONTR_NUM
                            ,CON.DS_CONTR_CATG_CD
                            ,DTL.DS_CONTR_DTL_TP_CD
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            ,RNV.AUTO_RNW_FLG
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                        FROM
                            DS_CONTR       CON
                            ,DS_CONTR_DTL  DTL
                            ,IV_RNW_ESCL   RNV
                        WHERE
                            CON.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND CON.DS_CONTR_CATG_CD        = #dsContrCatgReg#
                            AND CON.EZCANCELFLAG            = '0'
                            AND CON.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                            AND CON.DS_CONTR_PK             = DTL.DS_CONTR_PK
                            AND DTL.EZCANCELFLAG            = '0'
                            <!-- START 2019/04/23 [QC#31250, ADD] -->
                            AND DTL.DS_CONTR_DTL_TP_CD      &lt;&gt; #dsContrDtlTpAcc#
                            <!-- END 2019/04/23 [QC#31250, ADD] -->
                            AND DTL.DS_CONTR_PK             = RNV.DS_CONTR_PK
                            AND DTL.DS_CONTR_DTL_PK         = RNV.DS_CONTR_DTL_PK
                            AND RNV.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                            AND RNV.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmUsage#
                            AND RNV.RNW_USG_FLG             = 'Y'
                            AND EXISTS(SELECT * FROM IV_DTL_STS_V DSV
                                        WHERE
                                        DSV.DS_CONTR_PK         = DTL.DS_CONTR_PK
                                        AND DSV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK)
                            AND DTL.CONTR_EFF_THRU_DT BETWEEN #slsDt# AND TO_CHAR(TO_DATE(#slsDt#,#dateFormat#) + NVL(RNV.BEF_END_RNW_DAYS_AOT,0),#dateFormat#)
                            <!-- START 2017/10/05 K.Kojima [QC#21544, ADD] -->
                            AND (
                                (CON.MAX_CONTR_RNW_CNT IS NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL)
                                OR
                                (CON.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL AND CON.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                OR
                                (DTL.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                )
                            <!-- END 2017/10/05 K.Kojima [QC#21544, ADD] -->
            )
        --Regular Lv2/Base
            ,IV_REG_LV2_BASE AS (
                        SELECT
                            DTL.DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK
                            ,CON.DS_CONTR_NUM
                            ,CON.DS_CONTR_CATG_CD
                            ,DTL.DS_CONTR_DTL_TP_CD
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            ,RNV.AUTO_RNW_FLG
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                        FROM
                            DS_CONTR       CON
                            ,DS_CONTR_DTL  DTL
                            ,IV_RNW_ESCL   RNV
                        WHERE
                            CON.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND CON.DS_CONTR_CATG_CD        = #dsContrCatgReg#
                            AND CON.EZCANCELFLAG            = '0'
                            AND CON.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                            AND CON.DS_CONTR_PK             = DTL.DS_CONTR_PK
                            AND DTL.EZCANCELFLAG            = '0'
                            AND DTL.DS_CONTR_PK             = RNV.DS_CONTR_PK
                            AND DTL.DS_CONTR_DTL_PK         = RNV.DS_CONTR_DTL_PK
                            AND RNV.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                            AND RNV.RNW_BASE_FLG            = 'Y'
                            AND EXISTS(SELECT * FROM IV_DTL_STS_V DSV
                                        WHERE
                                        DSV.DS_CONTR_PK         = DTL.DS_CONTR_PK
                                        AND DSV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK)
                            AND DTL.CONTR_EFF_THRU_DT BETWEEN #slsDt# AND TO_CHAR(TO_DATE(#slsDt#,#dateFormat#) + NVL(RNV.BEF_END_RNW_DAYS_AOT,0),#dateFormat#)
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV3
                                        WHERE
                                        RNV3.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                                        AND RNV3.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                        AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                        AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmBase#
                                        AND RNV3.RNW_BASE_FLG            = 'Y')
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV3
                                        WHERE
                                        RNV3.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                                        AND RNV3.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                        AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                        AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmBase#
                                        AND RNV3.RNW_BASE_FLG            = 'Y')
                            <!-- START 2017/10/05 K.Kojima [QC#21544, ADD] -->
                            AND (
                                (CON.MAX_CONTR_RNW_CNT IS NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL)
                                OR
                                (CON.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL AND CON.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                OR
                                (DTL.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                )
                            <!-- END 2017/10/05 K.Kojima [QC#21544, ADD] -->
            )
        --Regular Lv2/Usage
            ,IV_REG_LV2_USAGE AS (
                        SELECT
                            DTL.DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK
                            ,CON.DS_CONTR_NUM
                            ,CON.DS_CONTR_CATG_CD
                            ,DTL.DS_CONTR_DTL_TP_CD
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            ,RNV.AUTO_RNW_FLG
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                        FROM
                            DS_CONTR       CON
                            ,DS_CONTR_DTL  DTL
                            ,IV_RNW_ESCL   RNV
                        WHERE
                            CON.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND CON.DS_CONTR_CATG_CD        = #dsContrCatgReg#
                            AND CON.EZCANCELFLAG            = '0'
                            AND CON.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                            AND CON.DS_CONTR_PK             = DTL.DS_CONTR_PK
                            AND DTL.EZCANCELFLAG            = '0'
                            <!-- START 2019/04/23 [QC#31250, ADD] -->
                            AND DTL.DS_CONTR_DTL_TP_CD      &lt;&gt; #dsContrDtlTpAcc#
                            <!-- END 2019/04/23 [QC#31250, ADD] -->
                            AND DTL.DS_CONTR_PK             = RNV.DS_CONTR_PK
                            AND DTL.DS_CONTR_DTL_PK         = RNV.DS_CONTR_DTL_PK
                            AND RNV.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                            AND RNV.RNW_USG_FLG             = 'Y'
                            AND EXISTS(SELECT * FROM IV_DTL_STS_V DSV
                                        WHERE
                                        DSV.DS_CONTR_PK         = DTL.DS_CONTR_PK
                                        AND DSV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK)
                            AND DTL.CONTR_EFF_THRU_DT BETWEEN #slsDt# AND TO_CHAR(TO_DATE(#slsDt#,#dateFormat#) + NVL(RNV.BEF_END_RNW_DAYS_AOT,0),#dateFormat#)
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV3
                                        WHERE
                                        RNV3.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                                        AND RNV3.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                        AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                        AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmUsage#
                                        AND RNV3.RNW_USG_FLG             = 'Y')
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV3
                                        WHERE
                                        RNV3.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                                        AND RNV3.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                        AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                        AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmUsage#
                                        AND RNV3.RNW_USG_FLG             = 'Y')
                            <!-- START 2017/10/05 K.Kojima [QC#21544, ADD] -->
                            AND (
                                (CON.MAX_CONTR_RNW_CNT IS NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL)
                                OR
                                (CON.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL AND CON.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                OR
                                (DTL.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                )
                            <!-- END 2017/10/05 K.Kojima [QC#21544, ADD] -->
            )
        --Regular Lv1/Base
            ,IV_REG_LV1_BASE AS (
                        SELECT
                            DTL.DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK
                            ,CON.DS_CONTR_NUM
                            ,CON.DS_CONTR_CATG_CD
                            ,DTL.DS_CONTR_DTL_TP_CD
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            ,RNV.AUTO_RNW_FLG
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                        FROM
                            DS_CONTR       CON
                            ,DS_CONTR_DTL  DTL
                            ,IV_RNW_ESCL   RNV
                        WHERE
                            CON.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND CON.DS_CONTR_CATG_CD        = #dsContrCatgReg#
                            AND CON.EZCANCELFLAG            = '0'
                            AND CON.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                            AND CON.DS_CONTR_PK             = DTL.DS_CONTR_PK
                            AND DTL.EZCANCELFLAG            = '0'
                            AND DTL.DS_CONTR_PK             = RNV.DS_CONTR_PK
                            AND RNV.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl1#
                            AND RNV.RNW_BASE_FLG            = 'Y'
                            AND EXISTS(SELECT * FROM IV_DTL_STS_V DSV
                                        WHERE
                                        DSV.DS_CONTR_PK         = DTL.DS_CONTR_PK
                                        AND DSV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK)
                            AND DTL.CONTR_EFF_THRU_DT BETWEEN #slsDt# AND TO_CHAR(TO_DATE(#slsDt#,#dateFormat#) + NVL(RNV.BEF_END_RNW_DAYS_AOT,0),#dateFormat#)
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV3
                                        WHERE
                                        RNV3.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                                        AND RNV3.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                        AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                        AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmBase#
                                        AND RNV3.RNW_BASE_FLG            = 'Y')
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV2
                                        WHERE
                                        RNV2.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                                        AND RNV2.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                        AND RNV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                                        AND RNV2.RNW_BASE_FLG            = 'Y')
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV3
                                        WHERE
                                        RNV3.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                                        AND RNV3.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                        AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                        AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmBase#
                                        AND RNV3.RNW_BASE_FLG            = 'Y')
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV2
                                        WHERE
                                        RNV2.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                                        AND RNV2.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                        AND RNV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                                        AND RNV2.RNW_BASE_FLG            = 'Y')
                             <!-- START 2017/10/05 K.Kojima [QC#21544, ADD] -->
                            AND (
                                (CON.MAX_CONTR_RNW_CNT IS NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL)
                                OR
                                (CON.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL AND CON.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                OR
                                (DTL.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                )
                            <!-- END 2017/10/05 K.Kojima [QC#21544, ADD] -->
            )
        --Regular Lv1/Usage
            ,IV_REG_LV1_USAGE AS (
                        SELECT
                            DTL.DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK
                            ,CON.DS_CONTR_NUM
                            ,CON.DS_CONTR_CATG_CD
                            ,DTL.DS_CONTR_DTL_TP_CD
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            ,RNV.AUTO_RNW_FLG
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                        FROM
                            DS_CONTR       CON
                            ,DS_CONTR_DTL  DTL
                            ,IV_RNW_ESCL   RNV
                        WHERE
                            CON.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND CON.DS_CONTR_CATG_CD        = #dsContrCatgReg#
                            AND CON.EZCANCELFLAG            = '0'
                            AND CON.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                            AND CON.DS_CONTR_PK             = DTL.DS_CONTR_PK
                            AND DTL.EZCANCELFLAG            = '0'
                            <!-- START 2019/04/23 [QC#31250, ADD] -->
                            AND DTL.DS_CONTR_DTL_TP_CD      &lt;&gt; #dsContrDtlTpAcc#
                            <!-- END 2019/04/23 [QC#31250, ADD] -->
                            AND DTL.DS_CONTR_PK             = RNV.DS_CONTR_PK
                            AND RNV.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl1#
                            AND RNV.RNW_USG_FLG             = 'Y'
                            AND EXISTS(SELECT * FROM IV_DTL_STS_V DSV
                                        WHERE
                                        DSV.DS_CONTR_PK         = DTL.DS_CONTR_PK
                                        AND DSV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK)
                            AND DTL.CONTR_EFF_THRU_DT BETWEEN #slsDt# AND TO_CHAR(TO_DATE(#slsDt#,#dateFormat#) + NVL(RNV.BEF_END_RNW_DAYS_AOT,0),#dateFormat#)
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV3
                                        WHERE
                                        RNV3.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                                        AND RNV3.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                        AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                        AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmUsage#
                                        AND RNV3.RNW_USG_FLG             = 'Y')
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV2
                                        WHERE
                                        RNV2.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                                        AND RNV2.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                        AND RNV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                                        AND RNV2.RNW_USG_FLG             = 'Y')
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV3
                                        WHERE
                                        RNV3.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                                        AND RNV3.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                        AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                        AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmUsage#
                                        AND RNV3.RNW_USG_FLG             = 'Y')
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV2
                                        WHERE
                                        RNV2.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                                        AND RNV2.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                        AND RNV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                                        AND RNV2.RNW_USG_FLG             = 'Y')
                            <!-- START 2017/10/05 K.Kojima [QC#21544, ADD] -->
                            AND (
                                (CON.MAX_CONTR_RNW_CNT IS NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL)
                                OR
                                (CON.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL AND CON.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                OR
                                (DTL.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                )
                            <!-- END 2017/10/05 K.Kojima [QC#21544, ADD] -->
            )
        --Fleet Lv3/Base
            ,IV_FLT_LV3_BASE AS (
                        SELECT
                            DTL.DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK
                            ,CON.DS_CONTR_NUM
                            ,CON.DS_CONTR_CATG_CD
                            ,DTL.DS_CONTR_DTL_TP_CD
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            ,RNV.AUTO_RNW_FLG
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                        FROM
                            DS_CONTR       CON
                            ,DS_CONTR_DTL  DTL
                            ,IV_RNW_ESCL   RNV
                            <!-- START 2018/01/25 U.Kim [QC#23688, ADD] -->
                            ,DS_CONTR_DTL  DTLP1
                            ,DS_CONTR_DTL  DTLP2
                            <!-- END 2018/01/25 U.Kim [QC#23688, ADD] -->
                        WHERE
                            CON.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND CON.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_CATG_CD        = #dsContrCatgFlt#
                            AND CON.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                            AND DTL.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_PK             = DTL.DS_CONTR_PK
                            AND DTL.DS_CONTR_DTL_TP_CD      NOT IN 
                            <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=",">
                                               #dsContrDtlTpList[]#
                            </iterate>
                            AND DTL.DS_CONTR_PK             = RNV.DS_CONTR_PK
                            AND RNV.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                            AND RNV.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmBase#
                            AND RNV.RNW_BASE_FLG            = 'Y'
                            AND EXISTS(SELECT * FROM IV_DTL_STS_V DSV
                                        WHERE
                                        DSV.DS_CONTR_PK         = DTL.DS_CONTR_PK
                                        AND DSV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK)
                            AND DTL.CONTR_EFF_THRU_DT BETWEEN #slsDt# AND TO_CHAR(TO_DATE(#slsDt#,#dateFormat#) + NVL(RNV.BEF_END_RNW_DAYS_AOT,0),#dateFormat#)
                       <!-- START 2018/01/25 U.Kim [QC#23688, MOD] -->
                            AND DTL.GLBL_CMPY_CD           = DTLP1.GLBL_CMPY_CD
                            AND DTL.PRNT_DS_CONTR_DTL_PK   = DTLP1.DS_CONTR_DTL_PK
                            AND DTLP1.EZCANCELFLAG         = '0'
                            AND DTLP1.GLBL_CMPY_CD         = DTLP2.GLBL_CMPY_CD(+)
                            AND DTLP1.PRNT_DS_CONTR_DTL_PK = DTLP2.DS_CONTR_DTL_PK(+)
                            AND DTLP2.EZCANCELFLAG(+)      = '0'
                            AND NVL(DTLP2.DS_CONTR_DTL_PK, DTLP1.DS_CONTR_DTL_PK) = RNV.DS_CONTR_DTL_PK
                       <!-- AND EXISTS(SELECT * FROM DS_CONTR_DTL LINE --> 
                       <!--             where LINE.DS_CONTR_PK      = DTL.DS_CONTR_PK -->
                       <!--             AND LINE.EZCANCELFLAG       = '0' -->
                       <!--             AND LINE.DS_CONTR_DTL_TP_CD IN -->
                       <!--             <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=","> -->
                       <!--                  #dsContrDtlTpList[]# -->
                       <!--             </iterate> -->
                       <!--             AND LINE.DS_CONTR_PK        = RNV.DS_CONTR_PK -->
                       <!--             AND LINE.DS_CONTR_DTL_PK    = RNV.DS_CONTR_DTL_PK) -->
                       <!-- END 2018/01/25 U.Kim [QC#23688, MOD] -->
                            <!-- START 2017/10/05 K.Kojima [QC#21544, ADD] -->
                            AND (
                                (CON.MAX_CONTR_RNW_CNT IS NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL)
                                OR
                                (CON.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL AND CON.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                OR
                                (DTL.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                )
                            <!-- END 2017/10/05 K.Kojima [QC#21544, ADD] -->
            )
        --Fleet Lv3/Usage
            ,IV_FLT_LV3_USAGE AS (
                        SELECT
                            DTL.DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK
                            ,CON.DS_CONTR_NUM
                            ,CON.DS_CONTR_CATG_CD
                            ,DTL.DS_CONTR_DTL_TP_CD
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            ,RNV.AUTO_RNW_FLG
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                        FROM
                            DS_CONTR       CON
                            ,DS_CONTR_DTL  DTL
                            ,IV_RNW_ESCL   RNV
                            <!-- START 2018/01/25 U.Kim [QC#23688, ADD] -->
                            ,DS_CONTR_DTL  DTLP1
                            ,DS_CONTR_DTL  DTLP2
                            <!-- END 2018/01/25 U.Kim [QC#23688, ADD] -->
                        WHERE
                            CON.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND CON.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_CATG_CD        = #dsContrCatgFlt#
                            AND CON.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                            AND DTL.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_PK             = DTL.DS_CONTR_PK
                            AND DTL.DS_CONTR_DTL_TP_CD      NOT IN 
                            <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=",">
                                               #dsContrDtlTpList[]#
                            </iterate>
                            AND DTL.DS_CONTR_PK             = RNV.DS_CONTR_PK
                            AND RNV.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                            AND RNV.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmUsage#
                            AND RNV.RNW_USG_FLG             = 'Y'
                            AND EXISTS(SELECT * FROM IV_DTL_STS_V DSV
                                        WHERE
                                        DSV.DS_CONTR_PK         = DTL.DS_CONTR_PK
                                        AND DSV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK)
                            AND DTL.CONTR_EFF_THRU_DT BETWEEN #slsDt# AND TO_CHAR(TO_DATE(#slsDt#,#dateFormat#) + NVL(RNV.BEF_END_RNW_DAYS_AOT,0),#dateFormat#)
                       <!-- START 2018/01/25 U.Kim [QC#23688, MOD] -->
                            AND DTL.GLBL_CMPY_CD           = DTLP1.GLBL_CMPY_CD
                            AND DTL.PRNT_DS_CONTR_DTL_PK   = DTLP1.DS_CONTR_DTL_PK
                            AND DTLP1.EZCANCELFLAG         = '0'
                            AND DTLP1.GLBL_CMPY_CD         = DTLP2.GLBL_CMPY_CD(+)
                            AND DTLP1.PRNT_DS_CONTR_DTL_PK = DTLP2.DS_CONTR_DTL_PK(+)
                            AND DTLP2.EZCANCELFLAG(+)      = '0'
                            AND NVL(DTLP2.DS_CONTR_DTL_PK, DTLP1.DS_CONTR_DTL_PK) = RNV.DS_CONTR_DTL_PK
                       <!-- AND EXISTS(SELECT * FROM DS_CONTR_DTL LINE -->
                       <!--             where LINE.DS_CONTR_PK      = DTL.DS_CONTR_PK -->
                       <!--             AND LINE.EZCANCELFLAG       = '0' -->
                       <!--             AND LINE.DS_CONTR_DTL_TP_CD IN -->
                       <!--             <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=","> -->
                       <!--                    #dsContrDtlTpList[]# -->
                       <!--             </iterate> -->
                       <!--             AND LINE.DS_CONTR_PK        = RNV.DS_CONTR_PK -->
                       <!--             AND LINE.DS_CONTR_DTL_PK    = RNV.DS_CONTR_DTL_PK) -->
                       <!-- END 2018/01/25 U.Kim [QC#23688, MOD] -->
                            <!-- START 2017/10/05 K.Kojima [QC#21544, ADD] -->
                            AND (
                                (CON.MAX_CONTR_RNW_CNT IS NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL)
                                OR
                                (CON.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL AND CON.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                OR
                                (DTL.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                )
                            <!-- END 2017/10/05 K.Kojima [QC#21544, ADD] -->
            )
        --Fleet Lv2/Base
            ,IV_FLT_LV2_BASE AS (
                        SELECT
                            DTL.DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK
                            ,CON.DS_CONTR_NUM
                            ,CON.DS_CONTR_CATG_CD
                            ,DTL.DS_CONTR_DTL_TP_CD
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            ,RNV.AUTO_RNW_FLG
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                        FROM
                            DS_CONTR       CON
                            ,DS_CONTR_DTL  DTL
                            ,IV_RNW_ESCL   RNV
                            <!-- START 2018/01/25 U.Kim [QC#23688, ADD] -->
                            ,DS_CONTR_DTL  DTLP1
                            ,DS_CONTR_DTL  DTLP2
                            <!-- END 2018/01/25 U.Kim [QC#23688, ADD] -->
                        WHERE
                            CON.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND CON.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_CATG_CD        = #dsContrCatgFlt#
                            AND CON.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                            AND DTL.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_PK             = DTL.DS_CONTR_PK
                            AND DTL.DS_CONTR_DTL_TP_CD      NOT IN 
                            <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=",">
                                               #dsContrDtlTpList[]#
                            </iterate>
                            AND DTL.DS_CONTR_PK             = RNV.DS_CONTR_PK
                            AND RNV.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                            AND RNV.RNW_BASE_FLG            = 'Y'
                            AND EXISTS(SELECT * FROM IV_DTL_STS_V DSV
                                        WHERE
                                        DSV.DS_CONTR_PK         = DTL.DS_CONTR_PK
                                        AND DSV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK)
                            AND DTL.CONTR_EFF_THRU_DT BETWEEN #slsDt# AND TO_CHAR(TO_DATE(#slsDt#,#dateFormat#) + NVL(RNV.BEF_END_RNW_DAYS_AOT,0),#dateFormat#)
                       <!-- START 2018/01/25 U.Kim [QC#23688, MOD] -->
                            AND DTL.GLBL_CMPY_CD           = DTLP1.GLBL_CMPY_CD
                            AND DTL.PRNT_DS_CONTR_DTL_PK   = DTLP1.DS_CONTR_DTL_PK
                            AND DTLP1.EZCANCELFLAG         = '0'
                            AND DTLP1.GLBL_CMPY_CD         = DTLP2.GLBL_CMPY_CD(+)
                            AND DTLP1.PRNT_DS_CONTR_DTL_PK = DTLP2.DS_CONTR_DTL_PK(+)
                            AND DTLP2.EZCANCELFLAG(+)      = '0'
                            AND NVL(DTLP2.DS_CONTR_DTL_PK, DTLP1.DS_CONTR_DTL_PK) = RNV.DS_CONTR_DTL_PK
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV3
                                    WHERE
                                        RNV3.DS_CONTR_PK                 = DTLP1.DS_CONTR_PK
                                        AND RNV3.DS_CONTR_DTL_PK         = NVL(DTLP2.DS_CONTR_DTL_PK, DTLP1.DS_CONTR_DTL_PK)
                                        AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                        AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmBase#
                                        AND RNV3.RNW_BASE_FLG            = 'Y')
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV3
                                    WHERE
                                        RNV3.DS_CONTR_PK                 = DTLP1.DS_CONTR_PK
                                        AND RNV3.DS_CONTR_DTL_PK         = NVL(DTLP2.DS_CONTR_DTL_PK, DTLP1.DS_CONTR_DTL_PK)
                                        AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                        AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmBase#
                                        AND RNV3.RNW_BASE_FLG            = 'Y')
                       <!-- AND EXISTS(SELECT * FROM DS_CONTR_DTL LINE -->
                       <!--             where LINE.DS_CONTR_PK      = DTL.DS_CONTR_PK -->
                       <!--             AND LINE.EZCANCELFLAG       = '0' -->
                       <!--             AND LINE.DS_CONTR_DTL_TP_CD IN  -->
                       <!--             <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=","> -->
                       <!--                    #dsContrDtlTpList[]# -->
                       <!--             </iterate> -->
                       <!--             AND LINE.DS_CONTR_PK        = RNV.DS_CONTR_PK -->
                       <!--             AND LINE.DS_CONTR_DTL_PK    = RNV.DS_CONTR_DTL_PK -->
                       <!--             AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV3 -->
                       <!--                     WHERE -->
                       <!--                         RNV3.DS_CONTR_PK                 = LINE.DS_CONTR_PK -->
                       <!--                         AND RNV3.DS_CONTR_DTL_PK         = LINE.DS_CONTR_DTL_PK -->
                       <!--                         AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3# -->
                       <!--                         AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmBase# -->
                       <!--                         AND RNV3.RNW_BASE_FLG            = 'Y') -->
                       <!--             AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV3 -->
                       <!--                     WHERE -->
                       <!--                         RNV3.DS_CONTR_PK                 = LINE.DS_CONTR_PK -->
                       <!--                         AND RNV3.DS_CONTR_DTL_PK         = LINE.DS_CONTR_DTL_PK -->
                       <!--                         AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3# -->
                       <!--                         AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmBase# -->
                       <!--                         AND RNV3.RNW_BASE_FLG            = 'Y')) -->
                       <!-- END 2018/01/25 U.Kim [QC#23688, MOD] -->
                            <!-- START 2017/10/05 K.Kojima [QC#21544, ADD] -->
                            AND (
                                (CON.MAX_CONTR_RNW_CNT IS NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL)
                                OR
                                (CON.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL AND CON.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                OR
                                (DTL.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                )
                            <!-- END 2017/10/05 K.Kojima [QC#21544, ADD] -->
            )
        --Fleet Lv2/Usage
            ,IV_FLT_LV2_USAGE AS (
                        SELECT
                            DTL.DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK
                            ,CON.DS_CONTR_NUM
                            ,CON.DS_CONTR_CATG_CD
                            ,DTL.DS_CONTR_DTL_TP_CD
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            ,RNV.AUTO_RNW_FLG
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                        FROM
                            DS_CONTR       CON
                            ,DS_CONTR_DTL  DTL
                            ,IV_RNW_ESCL   RNV
                            <!-- START 2018/01/25 U.Kim [QC#23688, ADD] -->
                            ,DS_CONTR_DTL  DTLP1
                            ,DS_CONTR_DTL  DTLP2
                            <!-- END 2018/01/25 U.Kim [QC#23688, ADD] -->
                        WHERE
                            CON.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND CON.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_CATG_CD        = #dsContrCatgFlt#
                            AND CON.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                            AND DTL.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_PK             = DTL.DS_CONTR_PK
                            AND DTL.DS_CONTR_DTL_TP_CD      NOT IN 
                            <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=",">
                                               #dsContrDtlTpList[]#
                            </iterate>
                            AND DTL.DS_CONTR_PK             = RNV.DS_CONTR_PK
                            AND RNV.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                            AND RNV.RNW_USG_FLG             = 'Y'
                            AND EXISTS(SELECT * FROM IV_DTL_STS_V DSV
                                        WHERE
                                        DSV.DS_CONTR_PK         = DTL.DS_CONTR_PK
                                        AND DSV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK)
                            AND DTL.CONTR_EFF_THRU_DT BETWEEN #slsDt# AND TO_CHAR(TO_DATE(#slsDt#,#dateFormat#) + NVL(RNV.BEF_END_RNW_DAYS_AOT,0),#dateFormat#)
                       <!-- START 2018/01/25 U.Kim [QC#23688, MOD] -->
                            AND DTL.GLBL_CMPY_CD           = DTLP1.GLBL_CMPY_CD
                            AND DTL.PRNT_DS_CONTR_DTL_PK   = DTLP1.DS_CONTR_DTL_PK
                            AND DTLP1.EZCANCELFLAG         = '0'
                            AND DTLP1.GLBL_CMPY_CD         = DTLP2.GLBL_CMPY_CD(+)
                            AND DTLP1.PRNT_DS_CONTR_DTL_PK = DTLP2.DS_CONTR_DTL_PK(+)
                            AND DTLP2.EZCANCELFLAG(+)      = '0'
                            AND NVL(DTLP2.DS_CONTR_DTL_PK, DTLP1.DS_CONTR_DTL_PK) = RNV.DS_CONTR_DTL_PK
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV3
                                    WHERE
                                        RNV3.DS_CONTR_PK                 = DTLP1.DS_CONTR_PK
                                        AND RNV3.DS_CONTR_DTL_PK         = NVL(DTLP2.DS_CONTR_DTL_PK, DTLP1.DS_CONTR_DTL_PK)
                                        AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                        AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmUsage#
                                        AND RNV3.RNW_USG_FLG             = 'Y')
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV3
                                    WHERE
                                        RNV3.DS_CONTR_PK                 = DTLP1.DS_CONTR_PK
                                        AND RNV3.DS_CONTR_DTL_PK         = NVL(DTLP2.DS_CONTR_DTL_PK, DTLP1.DS_CONTR_DTL_PK)
                                        AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                        AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmUsage#
                                        AND RNV3.RNW_USG_FLG             = 'Y')
                       <!-- AND EXISTS(SELECT * FROM DS_CONTR_DTL LINE -->
                       <!--             where LINE.DS_CONTR_PK      = DTL.DS_CONTR_PK -->
                       <!--             AND LINE.EZCANCELFLAG       = '0' -->
                       <!--             AND LINE.DS_CONTR_DTL_TP_CD IN  -->
                       <!--             <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=","> -->
                       <!--                    #dsContrDtlTpList[]# -->
                       <!--             </iterate> -->
                       <!--             AND LINE.DS_CONTR_PK        = RNV.DS_CONTR_PK -->
                       <!--             AND LINE.DS_CONTR_DTL_PK    = RNV.DS_CONTR_DTL_PK -->
                       <!--             AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV3 -->
                       <!--                     WHERE -->
                       <!--                         RNV3.DS_CONTR_PK                 = LINE.DS_CONTR_PK -->
                       <!--                         AND RNV3.DS_CONTR_DTL_PK         = LINE.DS_CONTR_DTL_PK -->
                       <!--                         AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3# -->
                       <!--                         AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmUsage# -->
                       <!--                         AND RNV3.RNW_USG_FLG             = 'Y') -->
                       <!--             AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV3 -->
                       <!--                     WHERE -->
                       <!--                         RNV3.DS_CONTR_PK                 = LINE.DS_CONTR_PK -->
                       <!--                         AND RNV3.DS_CONTR_DTL_PK         = LINE.DS_CONTR_DTL_PK -->
                       <!--                         AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3# -->
                       <!--                         AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmUsage# -->
                       <!--                         AND RNV3.RNW_USG_FLG             = 'Y')) -->
                       <!-- END 2018/01/25 U.Kim [QC#23688, MOD] -->
                            <!-- START 2017/10/05 K.Kojima [QC#21544, ADD] -->
                            AND (
                                (CON.MAX_CONTR_RNW_CNT IS NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL)
                                OR
                                (CON.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL AND CON.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                OR
                                (DTL.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                )
                            <!-- END 2017/10/05 K.Kojima [QC#21544, ADD] -->
            )
        --Fleet Lv1/Base
            ,IV_FLT_LV1_BASE AS (
                        SELECT
                            DTL.DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK
                            ,CON.DS_CONTR_NUM
                            ,CON.DS_CONTR_CATG_CD
                            ,DTL.DS_CONTR_DTL_TP_CD
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            ,RNV.AUTO_RNW_FLG
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                        FROM
                            DS_CONTR       CON
                            ,DS_CONTR_DTL  DTL
                            ,IV_RNW_ESCL   RNV
                            <!-- START 2018/01/25 U.Kim [QC#23688, ADD] -->
                            ,DS_CONTR_DTL  DTLP1
                            ,DS_CONTR_DTL  DTLP2
                            <!-- END 2018/01/25 U.Kim [QC#23688, ADD] -->
                        WHERE
                            CON.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND CON.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_CATG_CD        = #dsContrCatgFlt#
                            AND CON.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                            AND DTL.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_PK             = DTL.DS_CONTR_PK
                            AND DTL.DS_CONTR_DTL_TP_CD      NOT IN 
                            <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=",">
                                               #dsContrDtlTpList[]#
                            </iterate>
                            AND DTL.DS_CONTR_PK             = RNV.DS_CONTR_PK
                            AND RNV.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl1#
                            AND RNV.RNW_BASE_FLG            = 'Y'
                            AND EXISTS(SELECT * FROM IV_DTL_STS_V DSV
                                        WHERE
                                        DSV.DS_CONTR_PK         = DTL.DS_CONTR_PK
                                        AND DSV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK)
                            AND DTL.CONTR_EFF_THRU_DT BETWEEN #slsDt# AND TO_CHAR(TO_DATE(#slsDt#,#dateFormat#) + NVL(RNV.BEF_END_RNW_DAYS_AOT,0),#dateFormat#)
                       <!-- START 2018/01/25 U.Kim [QC#23688, MOD] -->
                                                        AND DTL.GLBL_CMPY_CD           = DTLP1.GLBL_CMPY_CD
                            AND DTL.PRNT_DS_CONTR_DTL_PK   = DTLP1.DS_CONTR_DTL_PK
                            AND DTLP1.EZCANCELFLAG         = '0'
                            AND DTLP1.GLBL_CMPY_CD         = DTLP2.GLBL_CMPY_CD(+)
                            AND DTLP1.PRNT_DS_CONTR_DTL_PK = DTLP2.DS_CONTR_DTL_PK(+)
                            AND DTLP2.EZCANCELFLAG(+)      = '0'
                            AND DTL.DS_CONTR_PK = RNV.DS_CONTR_PK
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV3
                                    WHERE
                                        RNV3.DS_CONTR_PK                 = DTLP1.DS_CONTR_PK
                                        AND RNV3.DS_CONTR_DTL_PK         = NVL(DTLP2.DS_CONTR_DTL_PK, DTLP1.DS_CONTR_DTL_PK)
                                        AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                        AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmBase#
                                        AND RNV3.RNW_BASE_FLG            = 'Y')
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV2
                                    WHERE
                                        RNV2.DS_CONTR_PK                 = DTLP1.DS_CONTR_PK
                                        AND RNV2.DS_CONTR_DTL_PK         = NVL(DTLP2.DS_CONTR_DTL_PK, DTLP1.DS_CONTR_DTL_PK)
                                        AND RNV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                                        AND RNV2.RNW_BASE_FLG            = 'Y')
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV3
                                    WHERE
                                        RNV3.DS_CONTR_PK                 = DTLP1.DS_CONTR_PK
                                        AND RNV3.DS_CONTR_DTL_PK         = NVL(DTLP2.DS_CONTR_DTL_PK, DTLP1.DS_CONTR_DTL_PK)
                                        AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                        AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmBase#
                                        AND RNV3.RNW_BASE_FLG            = 'Y')
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV2
                                    WHERE
                                        RNV2.DS_CONTR_PK                 = DTLP1.DS_CONTR_PK
                                        AND RNV2.DS_CONTR_DTL_PK         = NVL(DTLP2.DS_CONTR_DTL_PK, DTLP1.DS_CONTR_DTL_PK)
                                        AND RNV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                                        AND RNV2.RNW_BASE_FLG            = 'Y')
                       <!-- AND EXISTS(SELECT * FROM DS_CONTR_DTL LINE -->
                       <!--             where LINE.DS_CONTR_PK      = DTL.DS_CONTR_PK -->
                       <!--             AND LINE.EZCANCELFLAG       = '0' -->
                       <!--             AND LINE.DS_CONTR_DTL_TP_CD IN  -->
                       <!--             <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=","> -->
                       <!--                    #dsContrDtlTpList[]# -->
                       <!--             </iterate> -->
                       <!--             AND LINE.DS_CONTR_PK        = RNV.DS_CONTR_PK -->
                       <!--             AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV3 -->
                       <!--                     WHERE -->
                       <!--                         RNV3.DS_CONTR_PK                 = LINE.DS_CONTR_PK -->
                       <!--                         AND RNV3.DS_CONTR_DTL_PK         = LINE.DS_CONTR_DTL_PK -->
                       <!--                         AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3# -->
                       <!--                         AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmBase# -->
                       <!--                         AND RNV3.RNW_BASE_FLG            = 'Y') -->
                       <!--             AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV2 -->
                       <!--                     WHERE -->
                       <!--                         RNV2.DS_CONTR_PK                 = LINE.DS_CONTR_PK -->
                       <!--                         AND RNV2.DS_CONTR_DTL_PK         = LINE.DS_CONTR_DTL_PK -->
                       <!--                         AND RNV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2# -->
                       <!--                         AND RNV2.RNW_BASE_FLG            = 'Y') -->
                       <!--             AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV3 -->
                       <!--                     WHERE -->
                       <!--                         RNV3.DS_CONTR_PK                 = LINE.DS_CONTR_PK -->
                       <!--                         AND RNV3.DS_CONTR_DTL_PK         = LINE.DS_CONTR_DTL_PK -->
                       <!--                         AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3# -->
                       <!--                         AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmBase# -->
                       <!--                         AND RNV3.RNW_BASE_FLG            = 'Y') -->
                       <!--             AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV2 -->
                       <!--                     WHERE -->
                       <!--                         RNV2.DS_CONTR_PK                 = LINE.DS_CONTR_PK -->
                       <!--                         AND RNV2.DS_CONTR_DTL_PK         = LINE.DS_CONTR_DTL_PK -->
                       <!--                         AND RNV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2# -->
                       <!--                         AND RNV2.RNW_BASE_FLG            = 'Y')) -->
                       <!-- END 2018/01/25 U.Kim [QC#23688, MOD] -->
                            <!-- START 2017/10/05 K.Kojima [QC#21544, ADD] -->
                            AND (
                                (CON.MAX_CONTR_RNW_CNT IS NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL)
                                OR
                                (CON.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL AND CON.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                OR
                                (DTL.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                )
                            <!-- END 2017/10/05 K.Kojima [QC#21544, ADD] -->
            )
        --Fleet Lv1/Usage
            ,IV_FLT_LV1_USAGE AS (
                        SELECT
                            DTL.DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK
                            ,CON.DS_CONTR_NUM
                            ,CON.DS_CONTR_CATG_CD
                            ,DTL.DS_CONTR_DTL_TP_CD
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            ,RNV.AUTO_RNW_FLG
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                        FROM
                            DS_CONTR       CON
                            ,DS_CONTR_DTL  DTL
                            ,IV_RNW_ESCL   RNV
                            <!-- START 2018/01/25 U.Kim [QC#23688, ADD] -->
                            ,DS_CONTR_DTL  DTLP1
                            ,DS_CONTR_DTL  DTLP2
                            <!-- END 2018/01/25 U.Kim [QC#23688, ADD] -->
                        WHERE
                            CON.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND CON.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_CATG_CD        = #dsContrCatgFlt#
                            AND CON.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                            AND DTL.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_PK             = DTL.DS_CONTR_PK
                            AND DTL.DS_CONTR_DTL_TP_CD      NOT IN 
                            <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=",">
                                               #dsContrDtlTpList[]#
                            </iterate>
                            AND DTL.DS_CONTR_PK             = RNV.DS_CONTR_PK
                            AND RNV.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl1#
                            AND RNV.RNW_USG_FLG             = 'Y'
                            AND EXISTS(SELECT * FROM IV_DTL_STS_V DSV
                                        WHERE
                                        DSV.DS_CONTR_PK         = DTL.DS_CONTR_PK
                                        AND DSV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK)
                            AND DTL.CONTR_EFF_THRU_DT BETWEEN #slsDt# AND TO_CHAR(TO_DATE(#slsDt#,#dateFormat#) + NVL(RNV.BEF_END_RNW_DAYS_AOT,0),#dateFormat#)
                       <!-- START 2018/01/25 U.Kim [QC#23688, MOD] -->
                            AND DTL.GLBL_CMPY_CD           = DTLP1.GLBL_CMPY_CD
                            AND DTL.PRNT_DS_CONTR_DTL_PK   = DTLP1.DS_CONTR_DTL_PK
                            AND DTLP1.EZCANCELFLAG         = '0'
                            AND DTLP1.GLBL_CMPY_CD         = DTLP2.GLBL_CMPY_CD(+)
                            AND DTLP1.PRNT_DS_CONTR_DTL_PK = DTLP2.DS_CONTR_DTL_PK(+)
                            AND DTLP2.EZCANCELFLAG(+)      = '0'
                            AND DTL.DS_CONTR_PK = RNV.DS_CONTR_PK
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV3
                                    WHERE
                                        RNV3.DS_CONTR_PK                 = DTLP1.DS_CONTR_PK
                                        AND RNV3.DS_CONTR_DTL_PK         = NVL(DTLP2.DS_CONTR_DTL_PK, DTLP1.DS_CONTR_DTL_PK)
                                        AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                        AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmUsage#
                                        AND RNV3.RNW_USG_FLG             = 'Y')
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV2
                                    WHERE
                                        RNV2.DS_CONTR_PK                 = DTLP1.DS_CONTR_PK
                                        AND RNV2.DS_CONTR_DTL_PK         = NVL(DTLP2.DS_CONTR_DTL_PK, DTLP1.DS_CONTR_DTL_PK)
                                        AND RNV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                                        AND RNV2.RNW_USG_FLG             = 'Y')
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV3
                                    WHERE
                                        RNV3.DS_CONTR_PK                 = DTLP1.DS_CONTR_PK
                                        AND RNV3.DS_CONTR_DTL_PK         = NVL(DTLP2.DS_CONTR_DTL_PK, DTLP1.DS_CONTR_DTL_PK)
                                        AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                        AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmUsage#
                                        AND RNV3.RNW_USG_FLG             = 'Y')
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV2
                                    WHERE
                                        RNV2.DS_CONTR_PK                 = DTLP1.DS_CONTR_PK
                                        AND RNV2.DS_CONTR_DTL_PK         = NVL(DTLP2.DS_CONTR_DTL_PK, DTLP1.DS_CONTR_DTL_PK)
                                        AND RNV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                                        AND RNV2.RNW_USG_FLG             = 'Y')
                       <!-- AND EXISTS(SELECT * FROM DS_CONTR_DTL LINE -->
                       <!--             where LINE.DS_CONTR_PK      = DTL.DS_CONTR_PK -->
                       <!--             AND LINE.EZCANCELFLAG       = '0' -->
                       <!--             AND LINE.DS_CONTR_DTL_TP_CD IN  -->
                       <!--             <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=","> -->
                       <!--                    #dsContrDtlTpList[]# -->
                       <!--             </iterate> -->
                       <!--             AND LINE.DS_CONTR_PK        = RNV.DS_CONTR_PK -->
                       <!--             AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV3 -->
                       <!--                     WHERE -->
                       <!--                         RNV3.DS_CONTR_PK                 = LINE.DS_CONTR_PK -->
                       <!--                         AND RNV3.DS_CONTR_DTL_PK         = LINE.DS_CONTR_DTL_PK -->
                       <!--                         AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3# -->
                       <!--                         AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmUsage# -->
                       <!--                         AND RNV3.RNW_USG_FLG             = 'Y') -->
                       <!--             AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV2 -->
                       <!--                     WHERE -->
                       <!--                         RNV2.DS_CONTR_PK                 = LINE.DS_CONTR_PK -->
                       <!--                         AND RNV2.DS_CONTR_DTL_PK         = LINE.DS_CONTR_DTL_PK -->
                       <!--                         AND RNV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2# -->
                       <!--                         AND RNV2.RNW_USG_FLG             = 'Y') -->
                       <!--             AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV3 -->
                       <!--                     WHERE -->
                       <!--                         RNV3.DS_CONTR_PK                 = LINE.DS_CONTR_PK -->
                       <!--                         AND RNV3.DS_CONTR_DTL_PK         = LINE.DS_CONTR_DTL_PK -->
                       <!--                         AND RNV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3# -->
                       <!--                         AND RNV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmUsage# -->
                       <!--                         AND RNV3.RNW_USG_FLG             = 'Y') -->
                       <!--             AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV2 -->
                       <!--                     WHERE -->
                       <!--                         RNV2.DS_CONTR_PK                 = LINE.DS_CONTR_PK -->
                       <!--                         AND RNV2.DS_CONTR_DTL_PK         = LINE.DS_CONTR_DTL_PK -->
                       <!--                         AND RNV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2# -->
                       <!--                         AND RNV2.RNW_USG_FLG             = 'Y')) -->
                       <!-- END 2018/01/25 U.Kim [QC#23688, MOD] -->
                            <!-- START 2017/10/05 K.Kojima [QC#21544, ADD] -->
                            AND (
                                (CON.MAX_CONTR_RNW_CNT IS NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL)
                                OR
                                (CON.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL AND CON.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                OR
                                (DTL.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                )
                            <!-- END 2017/10/05 K.Kojima [QC#21544, ADD] -->
            )
      --Aggregate Lv2/Base
            ,IV_AGG_LV2_BASE AS (
                        SELECT
                            DTL.DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK
                            ,CON.DS_CONTR_NUM
                            ,CON.DS_CONTR_CATG_CD
                            ,DTL.DS_CONTR_DTL_TP_CD
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            ,RNV.AUTO_RNW_FLG
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                        FROM
                            DS_CONTR       CON
                            ,DS_CONTR_DTL  DTL
                            ,IV_RNW_ESCL   RNV
                        WHERE
                            CON.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND CON.DS_CONTR_CATG_CD        = #dsContrCatgAgg#
                            AND CON.EZCANCELFLAG            = '0'
                            AND CON.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                            AND CON.DS_CONTR_PK             = DTL.DS_CONTR_PK
                            AND DTL.EZCANCELFLAG            = '0'
                            AND DTL.DS_CONTR_PK             = RNV.DS_CONTR_PK
                            AND DTL.DS_CONTR_DTL_PK         = RNV.DS_CONTR_DTL_PK
                            AND DTL.DS_CONTR_DTL_TP_CD      NOT IN 
                            <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=",">
                                               #dsContrDtlTpList[]#
                            </iterate>
                            AND RNV.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                            AND RNV.RNW_BASE_FLG            = 'Y'
                            AND EXISTS(SELECT * FROM IV_DTL_STS_V DSV
                                        WHERE
                                        DSV.DS_CONTR_PK         = DTL.DS_CONTR_PK
                                        AND DSV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK)
                            AND DTL.CONTR_EFF_THRU_DT BETWEEN #slsDt# AND TO_CHAR(TO_DATE(#slsDt#,#dateFormat#) + NVL(RNV.BEF_END_RNW_DAYS_AOT,0),#dateFormat#)
                            <!-- START 2017/10/05 K.Kojima [QC#21544, ADD] -->
                            AND (
                                (CON.MAX_CONTR_RNW_CNT IS NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL)
                                OR
                                (CON.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL AND CON.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                OR
                                (DTL.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                )
                            <!-- END 2017/10/05 K.Kojima [QC#21544, ADD] -->
            )
        --Aggregate Lv2/Usage
            ,IV_AGG_LV2_USAGE AS (
                        SELECT
                            DTL.DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK
                            ,CON.DS_CONTR_NUM
                            ,CON.DS_CONTR_CATG_CD
                            ,DTL.DS_CONTR_DTL_TP_CD
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            ,RNV.AUTO_RNW_FLG
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                        FROM
                            DS_CONTR       CON
                            ,DS_CONTR_DTL  DTL
                            ,IV_RNW_ESCL   RNV
                        WHERE
                            CON.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND CON.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_CATG_CD        = #dsContrCatgAgg#
                            AND CON.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                            AND DTL.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_PK             = DTL.DS_CONTR_PK
                            AND DTL.DS_CONTR_DTL_TP_CD      NOT IN 
                            <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=",">
                                               #dsContrDtlTpList[]#
                            </iterate>
                            AND DTL.DS_CONTR_PK             = RNV.DS_CONTR_PK
                            AND RNV.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                            AND RNV.RNW_USG_FLG             = 'Y'
                            AND EXISTS(SELECT * FROM IV_DTL_STS_V DSV
                                        WHERE
                                        DSV.DS_CONTR_PK         = DTL.DS_CONTR_PK
                                        AND DSV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK)
                            AND DTL.CONTR_EFF_THRU_DT BETWEEN #slsDt# AND TO_CHAR(TO_DATE(#slsDt#,#dateFormat#) + NVL(RNV.BEF_END_RNW_DAYS_AOT,0),#dateFormat#)
                            AND EXISTS(SELECT * FROM DS_CONTR_DTL LINE
                                        where LINE.DS_CONTR_PK      = DTL.DS_CONTR_PK
                                        AND LINE.EZCANCELFLAG       = '0'
                                        AND LINE.DS_CONTR_DTL_TP_CD IN
                                        <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=",">
                                               #dsContrDtlTpList[]#
                                        </iterate>
                                        AND LINE.DS_CONTR_PK        = RNV.DS_CONTR_PK
                                        AND LINE.DS_CONTR_DTL_PK    = RNV.DS_CONTR_DTL_PK)
                            <!-- add start 2019/05/30 QC#50566 -->
                            AND DTL.DS_CONTR_DTL_TP_CD              &lt;&gt; #dsContrDtlTpAcc#
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV2
                                        WHERE
                                        RNV2.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                                        AND RNV2.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                        AND RNV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                                        AND RNV2.RNW_USG_FLG             = 'Y')
                            <!-- add end 2019/05/30 QC#50566 -->
                            <!-- START 2017/10/05 K.Kojima [QC#21544, ADD] -->
                            AND (
                                (CON.MAX_CONTR_RNW_CNT IS NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL)
                                OR
                                (CON.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL AND CON.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                OR
                                (DTL.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                )
                            <!-- END 2017/10/05 K.Kojima [QC#21544, ADD] -->
            )
        --Aggregate Lv1/Base
            ,IV_AGG_LV1_BASE AS (
                        SELECT
                            DTL.DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK
                            ,CON.DS_CONTR_NUM
                            ,CON.DS_CONTR_CATG_CD
                            ,DTL.DS_CONTR_DTL_TP_CD
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            ,RNV.AUTO_RNW_FLG
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                        FROM
                            DS_CONTR       CON
                            ,DS_CONTR_DTL  DTL
                            ,IV_RNW_ESCL   RNV
                        WHERE
                            CON.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND CON.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_CATG_CD        = #dsContrCatgAgg#
                            AND CON.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                            AND DTL.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_PK             = DTL.DS_CONTR_PK
                            AND DTL.DS_CONTR_DTL_TP_CD      NOT IN 
                            <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=",">
                                               #dsContrDtlTpList[]#
                            </iterate>
                            AND DTL.DS_CONTR_PK             = RNV.DS_CONTR_PK
                            AND RNV.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl1#
                            AND RNV.RNW_BASE_FLG            = 'Y'
                            AND EXISTS(SELECT * FROM IV_DTL_STS_V DSV
                                        WHERE
                                        DSV.DS_CONTR_PK         = DTL.DS_CONTR_PK
                                        AND DSV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK)
                            AND DTL.CONTR_EFF_THRU_DT BETWEEN #slsDt# AND TO_CHAR(TO_DATE(#slsDt#,#dateFormat#) + NVL(RNV.BEF_END_RNW_DAYS_AOT,0),#dateFormat#)
                            <!-- START 2018/04/12 K.Kojima [QC#25199-1,MOD] -->
                            <!-- AND EXISTS(SELECT * FROM DS_CONTR_DTL LINE -->
                            <!--             where LINE.DS_CONTR_PK      = DTL.DS_CONTR_PK -->
                            <!--             AND LINE.EZCANCELFLAG       = '0' -->
                            <!--             AND LINE.DS_CONTR_DTL_TP_CD IN  -->
                            <!--             <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=","> -->
                            <!--                    #dsContrDtlTpList[]# -->
                            <!--             </iterate> -->
                            <!--             AND LINE.DS_CONTR_PK        = RNV.DS_CONTR_PK -->
                            <!--             AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV2 -->
                            <!--                     WHERE -->
                            <!--                         RNV2.DS_CONTR_PK                 = LINE.DS_CONTR_PK -->
                            <!--                         AND RNV2.DS_CONTR_DTL_PK         = LINE.DS_CONTR_DTL_PK -->
                            <!--                         AND RNV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2# -->
                            <!--                         AND RNV2.RNW_BASE_FLG            = 'Y')) -->
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV2
                                    WHERE
                                        RNV2.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                                        AND RNV2.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                        AND RNV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                                        AND RNV2.RNW_BASE_FLG            = 'Y')
                            <!-- END 2018/04/12 K.Kojima [QC#25199-1,MOD] -->
                            <!-- START 2017/11/28 K.Kojima [QC#22660,ADD] -->
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV2
                                    WHERE
                                        RNV2.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                                        AND RNV2.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                        AND RNV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                                        AND RNV2.RNW_BASE_FLG            = 'Y')
                            <!-- END 2017/11/28 K.Kojima [QC#22660,ADD] -->
                            <!-- START 2017/10/05 K.Kojima [QC#21544, ADD] -->
                            AND (
                                (CON.MAX_CONTR_RNW_CNT IS NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL)
                                OR
                                (CON.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL AND CON.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                OR
                                (DTL.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                )
                            <!-- END 2017/10/05 K.Kojima [QC#21544, ADD] -->
            )
        --Aggregate Lv1/Usage
            ,IV_AGG_LV1_USAGE AS (
                        SELECT
                            DTL.DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK
                            ,CON.DS_CONTR_NUM
                            ,CON.DS_CONTR_CATG_CD
                            ,DTL.DS_CONTR_DTL_TP_CD
                            <!-- START 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                            ,RNV.AUTO_RNW_FLG
                            <!-- END 2024/04/01 K.Ogasawara [QC#63550, ADD] -->
                        FROM
                            DS_CONTR       CON
                            ,DS_CONTR_DTL  DTL
                            ,IV_RNW_ESCL   RNV
                        WHERE
                            CON.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND CON.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_CATG_CD        = #dsContrCatgAgg#
                            AND CON.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                            AND DTL.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_PK             = DTL.DS_CONTR_PK
                            AND DTL.DS_CONTR_DTL_TP_CD      NOT IN 
                            <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=",">
                                               #dsContrDtlTpList[]#
                            </iterate>
                            AND DTL.DS_CONTR_PK             = RNV.DS_CONTR_PK
                            AND RNV.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl1#
                            AND RNV.RNW_USG_FLG             = 'Y'
                            AND EXISTS(SELECT * FROM IV_DTL_STS_V DSV
                                        WHERE
                                        DSV.DS_CONTR_PK         = DTL.DS_CONTR_PK
                                        AND DSV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK)
                            AND DTL.CONTR_EFF_THRU_DT BETWEEN #slsDt# AND TO_CHAR(TO_DATE(#slsDt#,#dateFormat#) + NVL(RNV.BEF_END_RNW_DAYS_AOT,0),#dateFormat#)
                            AND EXISTS(SELECT * FROM DS_CONTR_DTL LINE
                                        where LINE.DS_CONTR_PK      = DTL.DS_CONTR_PK
                                        AND LINE.EZCANCELFLAG       = '0'
                                        AND LINE.DS_CONTR_DTL_TP_CD IN 
                                        <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=",">
                                               #dsContrDtlTpList[]#
                                        </iterate>
                                        AND LINE.DS_CONTR_PK        = RNV.DS_CONTR_PK
                                        AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL RNV2
                                                WHERE
                                                    RNV2.DS_CONTR_PK                 = LINE.DS_CONTR_PK
                                                    AND RNV2.DS_CONTR_DTL_PK         = LINE.DS_CONTR_DTL_PK
                                                    AND RNV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                                                    AND RNV2.RNW_USG_FLG             = 'Y'))
                            <!-- START 2017/11/28 K.Kojima [QC#22660,ADD] -->
                            AND NOT EXISTS(SELECT * FROM IV_RNW_ESCL_NO_AUTO RNV2
                                    WHERE
                                        RNV2.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                                        AND RNV2.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                        AND RNV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                                        AND RNV2.RNW_USG_FLG             = 'Y')
                                        <!-- END 2017/11/28 K.Kojima [QC#22660,ADD] -->
                            <!-- START 2017/10/05 K.Kojima [QC#21544, ADD] -->
                            AND (
                                (CON.MAX_CONTR_RNW_CNT IS NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL)
                                OR
                                (CON.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT IS NULL AND CON.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                OR
                                (DTL.MAX_CONTR_RNW_CNT IS NOT NULL AND DTL.MAX_CONTR_RNW_CNT > DTL.CONTR_RNW_TOT_CNT)
                                )
                            <!-- END 2017/10/05 K.Kojima [QC#21544, ADD] -->
            )
        ,IV_REG_BASE AS(
                SELECT
                    *
                FROM
                    IV_REG_LV3_BASE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_REG_LV2_BASE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_REG_LV1_BASE
            )
        ,IV_REG_USAGE AS(
                SELECT
                    *
                FROM
                    IV_REG_LV3_USAGE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_REG_LV2_USAGE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_REG_LV1_USAGE
            )
        ,IV_REG AS(
                SELECT
                    BS.DS_CONTR_PK
                    ,BS.DS_CONTR_DTL_PK
                    ,BS.DS_CONTR_NUM
                    ,BS.DS_CONTR_CATG_CD
                    ,BS.DS_CONTR_DTL_TP_CD
                    ,'Y' AS BASE_FLG
                    ,'Y' AS USAGE_FLG
                    <!-- START 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                    ,CASE WHEN BS.AUTO_RNW_FLG = 'N' THEN 'N'
                          WHEN (SELECT COUNT(*) FROM IV_REG_USAGE USG WHERE USG.DS_CONTR_PK = BS.DS_CONTR_PK
                          AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK
                          AND USG.AUTO_RNW_FLG = 'N') &gt; 0 THEN 'N'
                          ELSE 'Y'
                     END AS AUTO_RNW_FLG
                    <!-- END 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                FROM
                    IV_REG_BASE BS
                WHERE
                    EXISTS(SELECT * FROM IV_REG_USAGE USG
                            WHERE
                                USG.DS_CONTR_PK         = BS.DS_CONTR_PK
                                AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK)
                UNION ALL
                SELECT
                    BS.DS_CONTR_PK
                    ,BS.DS_CONTR_DTL_PK
                    ,BS.DS_CONTR_NUM
                    ,BS.DS_CONTR_CATG_CD
                    ,BS.DS_CONTR_DTL_TP_CD
                    ,'Y' AS BASE_FLG
                    ,'N' AS USAGE_FLG
                    <!-- START 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                    ,BS.AUTO_RNW_FLG
                    <!-- END 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                FROM
                    IV_REG_BASE BS
                WHERE
                    NOT EXISTS(SELECT * FROM IV_REG_USAGE USG
                            WHERE
                                USG.DS_CONTR_PK         = BS.DS_CONTR_PK
                                AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK)
                UNION ALL
                SELECT
                    USG.DS_CONTR_PK
                    ,USG.DS_CONTR_DTL_PK
                    ,USG.DS_CONTR_NUM
                    ,USG.DS_CONTR_CATG_CD
                    ,USG.DS_CONTR_DTL_TP_CD
                    ,'N' AS BASE_FLG
                    ,'Y' AS USAGE_FLG
                    <!-- START 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                    ,USG.AUTO_RNW_FLG
                    <!-- END 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                FROM
                    IV_REG_USAGE USG
                WHERE
                    NOT EXISTS(SELECT * FROM IV_REG_BASE BS
                            WHERE
                                USG.DS_CONTR_PK         = BS.DS_CONTR_PK
                                AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK)
                )
        ,IV_FLT_BASE AS(
                SELECT
                    *
                FROM
                    IV_FLT_LV3_BASE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_FLT_LV2_BASE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_FLT_LV1_BASE
            )
        ,IV_FLT_USAGE AS(
                SELECT
                    *
                FROM
                    IV_FLT_LV3_USAGE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_FLT_LV2_USAGE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_FLT_LV1_USAGE
            )
        ,IV_FLT AS(
                SELECT
                    BS.DS_CONTR_PK
                    ,BS.DS_CONTR_DTL_PK
                    ,BS.DS_CONTR_NUM
                    ,BS.DS_CONTR_CATG_CD
                    ,BS.DS_CONTR_DTL_TP_CD
                    ,'Y' AS BASE_FLG
                    ,'Y' AS USAGE_FLG
                    <!-- START 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                    ,CASE WHEN BS.AUTO_RNW_FLG = 'N' THEN 'N'
                          WHEN (SELECT COUNT(*) FROM IV_FLT_USAGE USG WHERE USG.DS_CONTR_PK = BS.DS_CONTR_PK
                          AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK
                          AND USG.AUTO_RNW_FLG = 'N') &gt; 0 THEN 'N'
                          ELSE 'Y'
                     END AS AUTO_RNW_FLG
                    <!-- END 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                FROM
                    IV_FLT_BASE BS
                WHERE
                    EXISTS(SELECT * FROM IV_FLT_USAGE USG
                            WHERE
                                USG.DS_CONTR_PK         = BS.DS_CONTR_PK
                                AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK)
                UNION ALL
                SELECT
                    BS.DS_CONTR_PK
                    ,BS.DS_CONTR_DTL_PK
                    ,BS.DS_CONTR_NUM
                    ,BS.DS_CONTR_CATG_CD
                    ,BS.DS_CONTR_DTL_TP_CD
                    ,'Y' AS BASE_FLG
                    ,'N' AS USAGE_FLG
                    <!-- START 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                    ,BS.AUTO_RNW_FLG
                    <!-- END 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                FROM
                    IV_FLT_BASE BS
                WHERE
                    NOT EXISTS(SELECT * FROM IV_FLT_USAGE USG
                            WHERE
                                USG.DS_CONTR_PK         = BS.DS_CONTR_PK
                                AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK)
                UNION ALL
                SELECT
                    USG.DS_CONTR_PK
                    ,USG.DS_CONTR_DTL_PK
                    ,USG.DS_CONTR_NUM
                    ,USG.DS_CONTR_CATG_CD
                    ,USG.DS_CONTR_DTL_TP_CD
                    ,'N' AS BASE_FLG
                    ,'Y' AS USAGE_FLG
                    <!-- START 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                    ,USG.AUTO_RNW_FLG
                    <!-- END 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                FROM
                    IV_FLT_USAGE USG
                WHERE
                    NOT EXISTS(SELECT * FROM IV_FLT_BASE BS
                            WHERE
                                USG.DS_CONTR_PK         = BS.DS_CONTR_PK
                                AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK)
                )
        ,IV_AGG_BASE AS(
                SELECT
                    *
                FROM
                    IV_AGG_LV2_BASE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_AGG_LV1_BASE
            )
        ,IV_AGG_USAGE AS(
                SELECT
                    *
                FROM
                    IV_AGG_LV2_USAGE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_AGG_LV1_USAGE
            )
        ,IV_AGG AS(
                SELECT
                    BS.DS_CONTR_PK
                    ,BS.DS_CONTR_DTL_PK
                    ,BS.DS_CONTR_NUM
                    ,BS.DS_CONTR_CATG_CD
                    ,BS.DS_CONTR_DTL_TP_CD
                    ,'Y' AS BASE_FLG
                    ,'Y' AS USAGE_FLG
                    <!-- START 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                    ,CASE WHEN BS.AUTO_RNW_FLG ='N' THEN 'N'
                          WHEN (SELECT COUNT(*) FROM IV_AGG_USAGE USG WHERE USG.DS_CONTR_PK = BS.DS_CONTR_PK
                          AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK
                          AND USG.AUTO_RNW_FLG ='N') &gt; 0 THEN 'N'
                          ELSE 'Y'
                     END AS AUTO_RNW_FLG
                    <!-- END 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                FROM
                    IV_AGG_BASE BS
                WHERE
                    EXISTS(SELECT * FROM IV_AGG_USAGE USG
                            WHERE
                                USG.DS_CONTR_PK         = BS.DS_CONTR_PK
                                AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK)
                UNION ALL
                SELECT
                    BS.DS_CONTR_PK
                    ,BS.DS_CONTR_DTL_PK
                    ,BS.DS_CONTR_NUM
                    ,BS.DS_CONTR_CATG_CD
                    ,BS.DS_CONTR_DTL_TP_CD
                    ,'Y' AS BASE_FLG
                    ,'N' AS USAGE_FLG
                    <!-- START 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                    ,BS.AUTO_RNW_FLG
                    <!-- END 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                FROM
                    IV_AGG_BASE BS
                WHERE
                    NOT EXISTS(SELECT * FROM IV_AGG_USAGE USG
                            WHERE
                                USG.DS_CONTR_PK         = BS.DS_CONTR_PK
                                AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK)
                UNION ALL
                SELECT
                    USG.DS_CONTR_PK
                    ,USG.DS_CONTR_DTL_PK
                    ,USG.DS_CONTR_NUM
                    ,USG.DS_CONTR_CATG_CD
                    ,USG.DS_CONTR_DTL_TP_CD
                    ,'N' AS BASE_FLG
                    ,'Y' AS USAGE_FLG
                    <!-- START 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                    ,USG.AUTO_RNW_FLG
                    <!-- END 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                FROM
                    IV_AGG_USAGE USG
                WHERE
                    NOT EXISTS(SELECT * FROM IV_AGG_BASE BS
                            WHERE
                                USG.DS_CONTR_PK         = BS.DS_CONTR_PK
                                AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK)
                )
            ,IV_LINE AS(
                        SELECT
                            DTL.DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK
                            ,CON.DS_CONTR_NUM
                            ,CON.DS_CONTR_CATG_CD
                            ,DTL.DS_CONTR_DTL_TP_CD
                            ,CASE WHEN (SELECT COUNT(*) FROM IV_FLT FLT WHERE FLT.DS_CONTR_PK = CON.DS_CONTR_PK AND FLT.BASE_FLG ='Y') &gt; 0 THEN 'Y'
                                  WHEN (SELECT COUNT(*) FROM IV_AGG AGG WHERE AGG.DS_CONTR_PK = CON.DS_CONTR_PK AND AGG.BASE_FLG ='Y') &gt; 0 THEN 'Y'
                                  ELSE 'N'
                             END AS BASE_FLG
                            ,CASE WHEN (SELECT COUNT(*) FROM IV_FLT FLT WHERE FLT.DS_CONTR_PK = CON.DS_CONTR_PK AND FLT.USAGE_FLG ='Y') &gt; 0 THEN 'Y'
                                  WHEN (SELECT COUNT(*) FROM IV_AGG AGG WHERE AGG.DS_CONTR_PK = CON.DS_CONTR_PK AND AGG.USAGE_FLG ='Y') &gt; 0 THEN 'Y'
                                  ELSE 'N'
                             END AS USAGE_FLG
                            <!-- START 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                            ,CASE WHEN (SELECT COUNT(*) FROM IV_FLT FLT WHERE FLT.DS_CONTR_PK = CON.DS_CONTR_PK AND FLT.AUTO_RNW_FLG = 'N') &gt; 0 THEN 'N'
                                  WHEN (SELECT COUNT(*) FROM IV_AGG AGG WHERE AGG.DS_CONTR_PK = CON.DS_CONTR_PK AND AGG.AUTO_RNW_FLG = 'N') &gt; 0 THEN 'N'
                                  ELSE 'Y'
                             END AS AUTO_RNW_FLG
                            <!-- END 2024/04/02 K.Ogasawara [QC#63550, ADD] -->
                        FROM
                            DS_CONTR       CON
                            ,DS_CONTR_DTL  DTL
                        WHERE
                            CON.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND CON.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_CATG_CD        IN 
                            <iterate property="dsContrCatgList" var="dsContrCatgList[]" open="(" close=")" conjunction=",">
                                               #dsContrCatgList[]#
                            </iterate>
                            AND CON.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                            AND DTL.DS_CONTR_DTL_TP_CD      IN 
                            <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=",">
                                               #dsContrDtlTpList[]#
                            </iterate>
                            AND DTL.EZCANCELFLAG            = '0'
                            AND CON.DS_CONTR_PK             = DTL.DS_CONTR_PK
                            AND (EXISTS(SELECT * FROM IV_FLT FLT
                                        WHERE FLT.DS_CONTR_PK = DTL.DS_CONTR_PK)
                                OR EXISTS(SELECT * FROM IV_AGG AGG
                                        WHERE AGG.DS_CONTR_PK = DTL.DS_CONTR_PK))
            )
        SELECT
            X.*
            <!-- START 2019/02/12 K.Kitachi [QC#30147, ADD] -->
            ,DTL.CONTR_EFF_THRU_DT
            ,TO_CHAR(ADD_MONTHS(TO_DATE(DTL.CONTR_EFF_THRU_DT, #dateFormat#), IDR.RNW_EXT_MTH_AOT), #dateFormat#)  AS NEW_EFF_THRU_DT
            <!-- END 2019/02/12 K.Kitachi [QC#30147, ADD] -->
        FROM
        (
            SELECT
                *
            FROM
                IV_REG
            UNION ALL
            SELECT
                *
            FROM
                IV_FLT
            UNION ALL
            SELECT
                *
            FROM
                IV_AGG
            UNION ALL
            SELECT
                *
            FROM
                IV_LINE
        ) X
        <!-- START 2017/11/28 K.Kojima [QC#22660,ADD] -->
        ,DS_CONTR_DTL_TP DCDT
        <!-- START 2019/02/12 K.Kitachi [QC#30147, ADD] -->
        ,DS_CONTR_DTL            DTL
        ,DS_CONTR                CON
        ,DS_CONTR_INTFC_DEF_RULE IDR
        <!-- END 2019/02/12 K.Kitachi [QC#30147, ADD] -->
        WHERE
                X.DS_CONTR_DTL_TP_CD = DCDT.DS_CONTR_DTL_TP_CD
            AND DCDT.GLBL_CMPY_CD    = #glblCmpyCd#
            AND DCDT.EZCANCELFLAG    = '0'
        <!-- END 2017/11/28 K.Kojima [QC#22660,ADD] -->
        <!-- START 2019/02/12 K.Kitachi [QC#30147, ADD] -->
        AND X.DS_CONTR_DTL_PK        = DTL.DS_CONTR_DTL_PK
        AND DTL.GLBL_CMPY_CD         = #glblCmpyCd#
        AND DTL.EZCANCELFLAG         = '0'
        <!-- add start 2019/11/05 QC#54364 -->
        AND DTL.CONTR_CLO_DT         IS NULL
        <!-- add end 2019/11/05 QC#54364 -->
        AND DTL.GLBL_CMPY_CD         = CON.GLBL_CMPY_CD
        AND DTL.DS_CONTR_PK          = CON.DS_CONTR_PK
        AND CON.EZCANCELFLAG         = '0'
        AND CON.GLBL_CMPY_CD         = IDR.GLBL_CMPY_CD
        AND CON.DS_CONTR_SRC_TP_CD   = IDR.CONTR_INTFC_SRC_TP_CD
        AND CON.DS_CONTR_CLS_CD      = IDR.DS_CONTR_CLS_CD
        AND CON.SVC_LINE_BIZ_CD      = IDR.SVC_LINE_BIZ_CD
        AND IDR.EZCANCELFLAG         = '0'
        <!-- END 2019/02/12 K.Kitachi [QC#30147, ADD] -->
        ORDER BY
             X.DS_CONTR_PK
            <!-- START 2017/11/28 K.Kojima [QC#22660,ADD] -->
            <!-- START 2018/04/11 K.Kojima [QC#24798,MOD] -->
            <!-- ,DCDT.DS_CONTR_DTL_TP_SORT_NUM DESC -->
            ,CASE WHEN X.DS_CONTR_DTL_TP_CD = #dsContrDtlTpAcc# THEN 0 ELSE DCDT.DS_CONTR_DTL_TP_SORT_NUM END DESC
            <!-- END 2018/04/11 K.Kojima [QC#24798,MOD] -->
            <!-- END 2017/11/28 K.Kojima [QC#22660,ADD] -->
            ,X.DS_CONTR_DTL_PK
   </statement>

   <!-- START 2017/08/04 M.Naito [QC#18776, MOD] --> 
   <statement id="getRenewalDetail" parameterClass="Map" resultClass="Map">
        WITH
            IV_RNW_ESCL AS (
                        SELECT
                            RNW.DS_CONTR_MACH_LVL_NUM
                            ,RNW.DS_CONTR_PK
                            ,RNW.DS_CONTR_DTL_PK
                            ,RNW.BEF_END_RNW_DAYS_AOT
                            ,RNW.DS_CONTR_BASE_USG_NM
                            ,RNW.BASE_PRC_UP_RATIO
                            ,RNW.MTR_PRC_UP_RATIO
                            ,RNW.RNW_PRC_METH_CD
                            <!-- START 2018/12/19 T.Tomita [QC#29636,ADD] -->
                            ,RNW.RNW_MAX_PRC_UP_RATIO
                            <!-- END 2018/12/19 T.Tomita [QC#29636,ADD] -->
                        FROM
                            DS_CONTR_RNW_ESCL RNW
                        WHERE
                            RNW.GLBL_CMPY_CD            = #glblCmpyCd#
                            AND RNW.EZCANCELFLAG        = '0'
                            AND RNW.RNW_PRC_METH_CD     IS NOT NULL
                            AND EXISTS(SELECT * FROM CONTR_AUTO_RNW_TP RTP
                                        WHERE RTP.GLBL_CMPY_CD       = RNW.GLBL_CMPY_CD
                                        AND RTP.CONTR_AUTO_RNW_TP_CD = RNW.CONTR_AUTO_RNW_TP_CD
                                        AND RTP.EZCANCELFLAG         = '0'
                                      <isNotNull property="baseFlg">
                                        AND RTP.RNW_BASE_FLG         = 'Y'
                                      </isNotNull>
                                      <isNull property="baseFlg">
                                        AND RTP.RNW_USG_FLG          = 'Y'
                                      </isNull>
                                        <!-- START 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                                        <!-- AND RTP.AUTO_RNW_FLG         = 'Y' -->
                                        <!-- END 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                                      )
                            AND RNW.DS_CONTR_PK         = #dsContrPk#
            )
            SELECT
                CON.CCY_CD
                ,TO_CHAR(TO_DATE(DTL.CONTR_EFF_THRU_DT,#dateFormat#) + 1, #dateFormat#) AS NEW_EFF_FROM_DT
                ,TO_CHAR(ADD_MONTHS(TO_DATE(DTL.CONTR_EFF_THRU_DT, #dateFormat#), IDR.RNW_EXT_MTH_AOT), #dateFormat#)  AS NEW_EFF_THRU_DT
                ,DTL.CONTR_CLO_DAY
                ,DTL.BASE_BLLG_CYCLE_CD
                ,DTL.CONTR_RNW_TOT_CNT
                ,CASE WHEN RNV3.BASE_PRC_UP_RATIO IS NOT NULL THEN RNV3.BASE_PRC_UP_RATIO
                      WHEN RNV2.BASE_PRC_UP_RATIO IS NOT NULL THEN RNV2.BASE_PRC_UP_RATIO
                      WHEN RNV1.BASE_PRC_UP_RATIO IS NOT NULL THEN RNV1.BASE_PRC_UP_RATIO
                      ELSE NULL
                 END AS BASE_PRC_UP_RATIO
                ,CASE WHEN RNV3.MTR_PRC_UP_RATIO IS NOT NULL THEN RNV3.MTR_PRC_UP_RATIO
                      WHEN RNV2.MTR_PRC_UP_RATIO IS NOT NULL THEN RNV2.MTR_PRC_UP_RATIO
                      WHEN RNV1.MTR_PRC_UP_RATIO IS NOT NULL THEN RNV1.MTR_PRC_UP_RATIO
                      ELSE NULL
                 END AS MTR_PRC_UP_RATIO
                ,CASE WHEN RNV3.RNW_PRC_METH_CD IS NOT NULL THEN RNV3.RNW_PRC_METH_CD
                      WHEN RNV2.RNW_PRC_METH_CD IS NOT NULL THEN RNV2.RNW_PRC_METH_CD
                      WHEN RNV1.RNW_PRC_METH_CD IS NOT NULL THEN RNV1.RNW_PRC_METH_CD
                      ELSE NULL
                 END AS RNW_PRC_METH_CD
                ,CCY.AFT_DECL_PNT_DIGIT_NUM
                ,CON.DS_CONTR_NUM
                <!-- START 2017/10/06 M.Kidokoro [QC#21546,ADD] -->
                ,DTL.BASE_PRC_DEAL_AMT
                ,DTL.BASE_PRC_TERM_DEAL_AMT_RATE
                <!-- END 2017/10/06 M.Kidokoro [QC#21546,ADD] -->
                <!-- START 2018/12/19 T.Tomita [QC#29636,MOD] -->
                <!-- START 2018/06/18 U.Kim [QC#24903,ADD] -->
                <!-- ,NVL(DTL.MAX_PRC_UP_RATIO, CON.MAX_PRC_UP_RATIO) AS MAX_PRC_UP_RATIO -->
                <!-- END 2018/06/18 U.Kim [QC#24903,ADD] -->
                ,COALESCE(RNV3.RNW_MAX_PRC_UP_RATIO, RNV2.RNW_MAX_PRC_UP_RATIO, RNV1.RNW_MAX_PRC_UP_RATIO) AS MAX_PRC_UP_RATIO
                <!-- END 2018/12/19 T.Tomita [QC#29636,MOD] -->
            FROM
                DS_CONTR       CON
                ,DS_CONTR_DTL  DTL
                ,IV_RNW_ESCL   RNV3
                ,IV_RNW_ESCL   RNV2
                ,IV_RNW_ESCL   RNV1
                ,CCY           CCY
                ,DS_CONTR_INTFC_DEF_RULE IDR
            WHERE
                CON.GLBL_CMPY_CD                    = #glblCmpyCd#
                AND CON.DS_CONTR_PK                 = #dsContrPk#
                AND CON.EZCANCELFLAG                = '0'
                AND CON.GLBL_CMPY_CD                = DTL.GLBL_CMPY_CD
                AND CON.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                AND DTL.DS_CONTR_DTL_PK             = #dsContrDtlPk#
                AND DTL.EZCANCELFLAG                = '0'
                AND DTL.DS_CONTR_PK                 = RNV3.DS_CONTR_PK(+)
                AND DTL.DS_CONTR_DTL_PK             = RNV3.DS_CONTR_DTL_PK(+)
                AND RNV3.DS_CONTR_MACH_LVL_NUM(+)   = #dsContrMachLvl3#
                AND RNV3.DS_CONTR_BASE_USG_NM(+)    = #dsContrBaseUsgNm#
                AND DTL.DS_CONTR_PK                 = RNV2.DS_CONTR_PK(+)
                AND DTL.DS_CONTR_DTL_PK             = RNV2.DS_CONTR_DTL_PK(+)
                AND RNV2.DS_CONTR_MACH_LVL_NUM(+)   = #dsContrMachLvl2#
                AND DTL.DS_CONTR_PK                 = RNV1.DS_CONTR_PK(+)
                AND RNV1.DS_CONTR_MACH_LVL_NUM(+)   = #dsContrMachLvl1#
                AND DTL.DS_CONTR_PK                 = RNV1.DS_CONTR_PK(+)
                AND CON.GLBL_CMPY_CD                = CCY.GLBL_CMPY_CD(+)
                AND CON.CCY_CD                      = CCY.CCY_CD(+)
                AND CCY.EZCANCELFLAG(+)             = '0'
                AND CON.GLBL_CMPY_CD                = IDR.GLBL_CMPY_CD
                AND CON.DS_CONTR_SRC_TP_CD          = IDR.CONTR_INTFC_SRC_TP_CD
                AND CON.DS_CONTR_CLS_CD             = IDR.DS_CONTR_CLS_CD
                AND CON.SVC_LINE_BIZ_CD             = IDR.SVC_LINE_BIZ_CD
                AND IDR.EZCANCELFLAG                = '0'
   </statement>
   
   <statement id="getRenewalDetailNotRegularMachine" parameterClass="Map" resultClass="Map">
        WITH
            IV_RNW_ESCL AS (
                        SELECT
                            RNW.DS_CONTR_MACH_LVL_NUM
                            ,RNW.DS_CONTR_PK
                            ,RNW.DS_CONTR_DTL_PK
                            ,RNW.BEF_END_RNW_DAYS_AOT
                            ,RNW.DS_CONTR_BASE_USG_NM
                            ,RNW.BASE_PRC_UP_RATIO
                            ,RNW.MTR_PRC_UP_RATIO
                            ,RNW.RNW_PRC_METH_CD
                            <!-- START 2018/12/19 T.Tomita [QC#29636,ADD] -->
                            ,RNW.RNW_MAX_PRC_UP_RATIO
                            <!-- END 2018/12/19 T.Tomita [QC#29636,ADD] -->
                        FROM
                            DS_CONTR_RNW_ESCL RNW
                        WHERE
                            RNW.GLBL_CMPY_CD            = #glblCmpyCd#
                            AND RNW.EZCANCELFLAG        = '0'
                            AND RNW.RNW_PRC_METH_CD     IS NOT NULL
                            AND EXISTS(SELECT * FROM CONTR_AUTO_RNW_TP RTP
                                        WHERE RTP.GLBL_CMPY_CD       = RNW.GLBL_CMPY_CD
                                        AND RTP.CONTR_AUTO_RNW_TP_CD = RNW.CONTR_AUTO_RNW_TP_CD
                                        AND RTP.EZCANCELFLAG         = '0'
                                      <isNotNull property="baseFlg">
                                        AND RTP.RNW_BASE_FLG         = 'Y'
                                      </isNotNull>
                                      <isNull property="baseFlg">
                                        AND RTP.RNW_USG_FLG          = 'Y'
                                      </isNull>
                                        <!-- START 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                                        <!-- AND RTP.AUTO_RNW_FLG         = 'Y' -->
                                        <!-- END 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                                      )
                            AND RNW.DS_CONTR_PK         = #dsContrPk#
            )
            ,IV_LINE AS(
                        SELECT
                            DTL.DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK
                        FROM
                            DS_CONTR_DTL  DTL
                        WHERE
                            DTL.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND DTL.DS_CONTR_PK             = #dsContrPk#
                            AND DTL.EZCANCELFLAG            = '0'
                            AND DTL.DS_CONTR_DTL_TP_CD      IN 
                            <iterate property="dsContrDtlTpList" var="dsContrDtlTpList[]" open="(" close=")" conjunction=",">
                                               #dsContrDtlTpList[]#
                            </iterate>
            )
            SELECT
                CON.CCY_CD
                ,TO_CHAR(TO_DATE(DTL.CONTR_EFF_THRU_DT,#dateFormat#) + 1, #dateFormat#) AS NEW_EFF_FROM_DT
                ,TO_CHAR(ADD_MONTHS(TO_DATE(DTL.CONTR_EFF_THRU_DT, #dateFormat#), IDR.RNW_EXT_MTH_AOT), #dateFormat#)  AS NEW_EFF_THRU_DT
                ,DTL.CONTR_CLO_DAY
                ,DTL.BASE_BLLG_CYCLE_CD
                ,DTL.CONTR_RNW_TOT_CNT
                ,CASE WHEN RNV3.BASE_PRC_UP_RATIO IS NOT NULL THEN RNV3.BASE_PRC_UP_RATIO
                      WHEN RNV2.BASE_PRC_UP_RATIO IS NOT NULL THEN RNV2.BASE_PRC_UP_RATIO
                      WHEN RNV1.BASE_PRC_UP_RATIO IS NOT NULL THEN RNV1.BASE_PRC_UP_RATIO
                      ELSE NULL
                 END AS BASE_PRC_UP_RATIO
                ,CASE WHEN RNV3.MTR_PRC_UP_RATIO IS NOT NULL THEN RNV3.MTR_PRC_UP_RATIO
                      WHEN RNV2.MTR_PRC_UP_RATIO IS NOT NULL THEN RNV2.MTR_PRC_UP_RATIO
                      WHEN RNV1.MTR_PRC_UP_RATIO IS NOT NULL THEN RNV1.MTR_PRC_UP_RATIO
                      ELSE NULL
                 END AS MTR_PRC_UP_RATIO
                ,CASE WHEN RNV3.RNW_PRC_METH_CD IS NOT NULL THEN RNV3.RNW_PRC_METH_CD
                      WHEN RNV2.RNW_PRC_METH_CD IS NOT NULL THEN RNV2.RNW_PRC_METH_CD
                      WHEN RNV1.RNW_PRC_METH_CD IS NOT NULL THEN RNV1.RNW_PRC_METH_CD
                      ELSE NULL
                 END AS RNW_PRC_METH_CD
                ,CCY.AFT_DECL_PNT_DIGIT_NUM
                ,CON.DS_CONTR_NUM
                <!-- START 2017/10/06 M.Kidokoro [QC#21546,ADD] -->
                ,DTL.BASE_PRC_DEAL_AMT
                ,DTL.BASE_PRC_TERM_DEAL_AMT_RATE
                <!-- END 2017/10/06 M.Kidokoro [QC#21546,ADD] -->
                <!-- START 2018/12/19 T.Tomita [QC#29636,MOD] -->
                <!-- START 2018/06/18 U.Kim [QC#24903,ADD] -->
                <!-- ,NVL(DTL.MAX_PRC_UP_RATIO, CON.MAX_PRC_UP_RATIO) AS MAX_PRC_UP_RATIO -->
                <!-- END 2018/06/18 U.Kim [QC#24903,ADD] -->
                ,COALESCE(RNV3.RNW_MAX_PRC_UP_RATIO, RNV2.RNW_MAX_PRC_UP_RATIO, RNV1.RNW_MAX_PRC_UP_RATIO) AS MAX_PRC_UP_RATIO
                <!-- END 2018/12/19 T.Tomita [QC#29636,MOD] -->
            FROM
                DS_CONTR       CON
                ,DS_CONTR_DTL  DTL
                ,IV_LINE       LINE
                ,IV_RNW_ESCL   RNV3
                ,IV_RNW_ESCL   RNV2
                ,IV_RNW_ESCL   RNV1
                ,CCY           CCY
                ,DS_CONTR_INTFC_DEF_RULE IDR
            WHERE
                CON.GLBL_CMPY_CD                    = #glblCmpyCd#
                AND CON.DS_CONTR_PK                 = #dsContrPk#
                AND CON.EZCANCELFLAG                = '0'
                AND CON.GLBL_CMPY_CD                = DTL.GLBL_CMPY_CD
                AND DTL.EZCANCELFLAG                = '0'
                AND CON.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                AND DTL.DS_CONTR_DTL_PK             = #dsContrDtlPk#
                AND LINE.DS_CONTR_PK                = RNV3.DS_CONTR_PK(+)
                AND LINE.DS_CONTR_DTL_PK            = RNV3.DS_CONTR_DTL_PK(+)
                AND RNV3.DS_CONTR_MACH_LVL_NUM(+)   = #dsContrMachLvl3#
                AND RNV3.DS_CONTR_BASE_USG_NM(+)    = #dsContrBaseUsgNm#
                AND LINE.DS_CONTR_PK                = RNV2.DS_CONTR_PK(+)
                AND LINE.DS_CONTR_DTL_PK            = RNV2.DS_CONTR_DTL_PK(+)
                AND RNV2.DS_CONTR_MACH_LVL_NUM(+)   = #dsContrMachLvl2#
                AND DTL.DS_CONTR_PK                 = RNV1.DS_CONTR_PK(+)
                AND RNV1.DS_CONTR_MACH_LVL_NUM(+)   = #dsContrMachLvl1#
                AND DTL.DS_CONTR_PK                 = RNV1.DS_CONTR_PK(+)
                AND CON.GLBL_CMPY_CD                = CCY.GLBL_CMPY_CD(+)
                AND CON.CCY_CD                      = CCY.CCY_CD(+)
                AND CCY.EZCANCELFLAG(+)             = '0'
                AND CON.GLBL_CMPY_CD                = IDR.GLBL_CMPY_CD
                AND CON.DS_CONTR_SRC_TP_CD          = IDR.CONTR_INTFC_SRC_TP_CD
                AND CON.DS_CONTR_CLS_CD             = IDR.DS_CONTR_CLS_CD
                AND CON.SVC_LINE_BIZ_CD             = IDR.SVC_LINE_BIZ_CD
                AND IDR.EZCANCELFLAG                = '0'
    </statement>
    <!-- END 2017/08/04 M.Naito [QC#18776, MOD] -->
    <statement id="getModelUpdateRuleBase" parameterClass="Map" resultClass="BigDecimal">
        SELECT
                MUR.UPLFT_BASE_PRC_UP_RATIO       BASE_PRC_UP_RATIO
        FROM
                 DS_CONTR_DTL           DTL
                ,SVC_CONFIG_MSTR        SCM
                ,DS_MDL_ESCL_RULE       MUR
        WHERE
                DTL.GLBL_CMPY_CD                = #glblCmpyCd#
            AND DTL.DS_CONTR_DTL_PK             = #dsContrDtlPk#
            AND DTL.EZCANCELFLAG                = '0'
            AND DTL.SVC_CONFIG_MSTR_PK          = SCM.SVC_CONFIG_MSTR_PK
            AND DTL.GLBL_CMPY_CD                = SCM.GLBL_CMPY_CD
            AND SCM.EZCANCELFLAG                = '0'
            AND SCM.MDL_ID                      = MUR.MDL_ID
            AND SCM.GLBL_CMPY_CD                = MUR.GLBL_CMPY_CD
            AND MUR.EFF_FROM_DT               &lt;= #effFromDt#
            AND NVL(MUR.EFF_THRU_DT,#maxDt#)  &gt;= #effFromDt#
            AND MUR.EZCANCELFLAG                = '0'
    </statement>
    <statement id="getModelUpdateRuleBaseForLine" parameterClass="Map" resultClass="BigDecimal">
        WITH IV_DTL AS(
            SELECT
                GLBL_CMPY_CD
                ,DS_CONTR_DTL_PK
                ,SVC_CONFIG_MSTR_PK
            FROM
                (SELECT
                    DTL.GLBL_CMPY_CD
                    ,DTL.DS_CONTR_DTL_PK
                    ,DTL.SVC_CONFIG_MSTR_PK
                    ,ROW_NUMBER() OVER (PARTITION BY DTL.DS_CONTR_PK ORDER BY DTL.DS_CONTR_DTL_PK ASC) AS ROW_NUM 
                FROM
                    DS_CONTR_DTL           DTL
                WHERE
                    DTL.GLBL_CMPY_CD            = #glblCmpyCd#
                    AND DTL.EZCANCELFLAG        = '0'
                    AND DTL.SVC_MACH_MSTR_PK    IS NOT NULL
                    AND EXISTS
                        (SELECT * FROM DS_CONTR_DTL  LINE
                        WHERE
                            LINE.GLBL_CMPY_CD           = #glblCmpyCd#
                            AND LINE.DS_CONTR_DTL_PK    = #dsContrDtlPk#
                            AND LINE.DS_CONTR_PK        = DTL.DS_CONTR_PK
                            AND LINE.EZCANCELFLAG       = '0')
                )
            WHERE
                ROW_NUM = 1
            )
        SELECT
                MUR.UPLFT_BASE_PRC_UP_RATIO       BASE_PRC_UP_RATIO
        FROM
                 IV_DTL                 DTL
                ,SVC_CONFIG_MSTR        SCM
                ,DS_MDL_ESCL_RULE       MUR
        WHERE
                DTL.SVC_CONFIG_MSTR_PK          = SCM.SVC_CONFIG_MSTR_PK
            AND DTL.GLBL_CMPY_CD                = SCM.GLBL_CMPY_CD
            AND SCM.EZCANCELFLAG                = '0'
            AND SCM.MDL_ID                      = MUR.MDL_ID
            AND SCM.GLBL_CMPY_CD                = MUR.GLBL_CMPY_CD
            AND MUR.EFF_FROM_DT               &lt;= #effFromDt#
            AND NVL(MUR.EFF_THRU_DT,#maxDt#)  &gt;= #effFromDt#
            AND MUR.EZCANCELFLAG                = '0'
    </statement>
    <statement id="getUsagePrcEff" parameterClass="Map" resultClass="Map">
        SELECT
            BLLG_MTR_LB_CD
            ,DS_CONTR_BLLG_MTR_PK
            ,CONTR_XS_COPY_PK
            ,XS_MTR_COPY_QTY
            ,XS_MTR_AMT_RATE
            ,XS_MTR_FIRST_FLG
            <!-- START 2022/12/01 R.Jin [QC#60880, ADD] -->
            ,ROW_NUMBER() OVER (PARTITION BY DS_CONTR_BLLG_MTR_PK ORDER BY DS_CONTR_BLLG_MTR_PK,XS_MTR_COPY_QTY ASC) AS TIRNUM 
            <!-- END 2022/12/01 R.Jin [QC#60880, ADD] -->
        FROM
            (
            SELECT
                 CBM.BLLG_MTR_LB_CD
                ,CPE.DS_CONTR_BLLG_MTR_PK
                ,PEM.CONTR_XS_COPY_PK
                ,PEM.XS_MTR_COPY_QTY
                ,PEM.XS_MTR_AMT_RATE
                ,PEM.XS_MTR_FIRST_FLG
                ,ROW_NUMBER() OVER (PARTITION BY CPE.DS_CONTR_BLLG_MTR_PK,PEM.CONTR_XS_COPY_PK ORDER BY CPE.CONTR_PRC_EFF_THRU_DT DESC) AS ROW_NUM 
            FROM
                 DS_CONTR_PRC_EFF       CPE
                ,DS_CONTR_PRC_EFF_MTR   PEM
                ,DS_CONTR_BLLG_MTR      CBM
<!-- START 2021/11/11 L.Mandanas [QC#59305, ADD] -->
                ,CONTR_XS_COPY          CXC
<!-- NED 2021/11/11 L.Mandanas [QC#59305, ADD] -->
            WHERE
                    CPE.GLBL_CMPY_CD                = #glblCmpyCd#
                AND CPE.DS_CONTR_DTL_PK             = #dsContrDtlPk#
                AND CPE.USG_CHRG_FLG                = 'Y'
                AND CPE.EZCANCELFLAG                = '0'
                AND CPE.DS_CONTR_PRC_EFF_PK         = PEM.DS_CONTR_PRC_EFF_PK
                AND CPE.GLBL_CMPY_CD                = PEM.GLBL_CMPY_CD
                AND PEM.EZCANCELFLAG                = '0'
                AND PEM.DS_CONTR_BLLG_MTR_PK        = CBM.DS_CONTR_BLLG_MTR_PK
                AND PEM.GLBL_CMPY_CD                = CBM.GLBL_CMPY_CD
                AND CBM.EZCANCELFLAG                = '0'
<!-- START 2021/11/11 L.Mandanas [QC#59305, ADD] -->
                AND PEM.GLBL_CMPY_CD                = CXC.GLBL_CMPY_CD
                AND PEM.CONTR_XS_COPY_PK            = CXC.CONTR_XS_COPY_PK
                AND CXC.EZCANCELFLAG                = '0'
<!-- END 2021/11/11 L.Mandanas [QC#59305, ADD] -->
            )
        WHERE
            ROW_NUM = 1
        ORDER BY
            DS_CONTR_BLLG_MTR_PK       ASC
            ,XS_MTR_COPY_QTY           ASC
    </statement>
    <statement id="getModelUpdateRuleMtr" parameterClass="Map" resultClass="BigDecimal">
        SELECT
                MBM.UPLFT_MTR_PRC_UP_RATIO       MTR_PRC_UP_RATIO
        FROM
                 DS_CONTR_DTL           DTL
                ,SVC_CONFIG_MSTR        SCM
                ,DS_CONTR_BLLG_MTR      BLM
                ,DS_MDL_ESCL_RULE       MUR
                ,DS_MDL_ESCL_BLLG_MTR   MBM
        WHERE
                DTL.GLBL_CMPY_CD                = #glblCmpyCd#
            AND DTL.DS_CONTR_DTL_PK             = #dsContrDtlPk#
            AND DTL.EZCANCELFLAG                = '0'
            AND DTL.SVC_CONFIG_MSTR_PK          = SCM.SVC_CONFIG_MSTR_PK
            AND DTL.GLBL_CMPY_CD                = SCM.GLBL_CMPY_CD
            AND SCM.EZCANCELFLAG                = '0'
            AND DTL.DS_CONTR_DTL_PK             = BLM.DS_CONTR_DTL_PK
            AND DTL.GLBL_CMPY_CD                = BLM.GLBL_CMPY_CD
            AND BLM.EZCANCELFLAG                = '0'
            AND BLM.DS_CONTR_BLLG_MTR_PK        = #dsContrBllgMtrPk#
            AND SCM.MDL_ID                      = MUR.MDL_ID
            AND SCM.GLBL_CMPY_CD                = MUR.GLBL_CMPY_CD
            AND MUR.EFF_FROM_DT               &lt;= #effFromDt#
            AND NVL(MUR.EFF_THRU_DT,#maxDt#)  &gt;= #effFromDt#
            AND MUR.EZCANCELFLAG                = '0'
            AND MUR.DS_MDL_ESCL_RULE_PK         = MBM.DS_MDL_ESCL_RULE_PK
            AND MUR.GLBL_CMPY_CD                = MBM.GLBL_CMPY_CD
            AND MBM.EZCANCELFLAG                = '0'
            AND BLM.GLBL_CMPY_CD                = MBM.GLBL_CMPY_CD
            AND BLM.BLLG_MTR_LB_CD              = MBM.BLLG_MTR_LB_CD
    </statement>
    <statement id="getModelUpdateRuleMtrForLine" parameterClass="Map" resultClass="BigDecimal">
        WITH IV_DTL AS(
            SELECT
                GLBL_CMPY_CD
                ,DS_CONTR_DTL_PK
                ,SVC_CONFIG_MSTR_PK
            FROM
                (SELECT
                    DTL.GLBL_CMPY_CD
                    ,DTL.DS_CONTR_DTL_PK
                    ,DTL.SVC_CONFIG_MSTR_PK
                    ,ROW_NUMBER() OVER (PARTITION BY DTL.DS_CONTR_PK ORDER BY DTL.DS_CONTR_DTL_PK ASC) AS ROW_NUM 
                FROM
                    DS_CONTR_DTL           DTL
                WHERE
                    DTL.GLBL_CMPY_CD            = #glblCmpyCd#
                    AND DTL.EZCANCELFLAG        = '0'
                    AND DTL.SVC_MACH_MSTR_PK    IS NOT NULL
                    AND EXISTS
                        (SELECT * FROM DS_CONTR_DTL  LINE
                        WHERE
                            LINE.GLBL_CMPY_CD           = #glblCmpyCd#
                            AND LINE.DS_CONTR_DTL_PK    = #dsContrDtlPk#
                            AND LINE.DS_CONTR_PK        = DTL.DS_CONTR_PK
                            AND LINE.EZCANCELFLAG       = '0')
                )
            WHERE
                ROW_NUM = 1
            )
                SELECT
                        MBM.UPLFT_MTR_PRC_UP_RATIO       MTR_PRC_UP_RATIO
                FROM
                         IV_DTL                 DTL
                        ,SVC_CONFIG_MSTR        SCM
                        ,DS_CONTR_BLLG_MTR      BLM
                        ,DS_MDL_ESCL_RULE       MUR
                        ,DS_MDL_ESCL_BLLG_MTR   MBM
                WHERE
                        DTL.SVC_CONFIG_MSTR_PK          = SCM.SVC_CONFIG_MSTR_PK
                    AND DTL.GLBL_CMPY_CD                = SCM.GLBL_CMPY_CD
                    AND SCM.EZCANCELFLAG                = '0'
                    AND DTL.GLBL_CMPY_CD                = BLM.GLBL_CMPY_CD
                    AND BLM.EZCANCELFLAG                = '0'
                    AND BLM.DS_CONTR_BLLG_MTR_PK        = #dsContrBllgMtrPk#
                    AND SCM.MDL_ID                      = MUR.MDL_ID
                    AND SCM.GLBL_CMPY_CD                = MUR.GLBL_CMPY_CD
                    AND MUR.EFF_FROM_DT               &lt;= #effFromDt#
                    AND NVL(MUR.EFF_THRU_DT,#maxDt#)  &gt;= #effFromDt#
                    AND MUR.EZCANCELFLAG                = '0'
                    AND MUR.DS_MDL_ESCL_RULE_PK         = MBM.DS_MDL_ESCL_RULE_PK
                    AND MUR.GLBL_CMPY_CD                = MBM.GLBL_CMPY_CD
                    AND MBM.EZCANCELFLAG                = '0'
                    AND BLM.GLBL_CMPY_CD                = MBM.GLBL_CMPY_CD
                    AND BLM.BLLG_MTR_LB_CD              = MBM.BLLG_MTR_LB_CD
    </statement>
    <statement id="renewalHoldTargetByUpdateApi" parameterClass="Map" resultClass="Map">
        SELECT
            DS_CONTR_PRC_EFF_PK
        FROM
            (SELECT
                EFF.DS_CONTR_PRC_EFF_PK
                ,ROW_NUMBER() OVER (PARTITION BY EFF.DS_CONTR_DTL_PK,DS_CONTR_BLLG_MTR_PK ORDER BY DS_CONTR_PRC_EFF_SQ_NUM DESC) AS ROW_NUM 
            FROM
                DS_CONTR_PRC_EFF    EFF
            WHERE
                EFF.GLBL_CMPY_CD            = #glblCmpyCd#
                AND EFF.EZCANCELFLAG        = '0'
                AND EXISTS(SELECT * FROM
                            DS_CONTR_DTL_STS_V DSV
                        WHERE
                            DSV.GLBL_CMPY_CD        = EFF.GLBL_CMPY_CD
                            AND DSV.DS_CONTR_PK     = #dsContrPk#
                            AND DSV.DS_CONTR_DTL_PK = EFF.DS_CONTR_DTL_PK
                            AND DSV.CONTR_RNW_AVAL_FLG  = 'Y'
                            AND DSV.EZCANCELFLAG        = '0')
            )
        WHERE
            ROW_NUM = 1
        ORDER BY DS_CONTR_PRC_EFF_PK
    </statement>
    <statement id="renewalHoldTargetByQaValidation" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            DS_CONTR_PRC_EFF_PK
        FROM
            (SELECT
                EFF.DS_CONTR_PRC_EFF_PK
                ,ROW_NUMBER() OVER (PARTITION BY EFF.DS_CONTR_DTL_PK,DS_CONTR_BLLG_MTR_PK ORDER BY DS_CONTR_PRC_EFF_SQ_NUM DESC) AS ROW_NUM 
            FROM
                DS_CONTR_PRC_EFF    EFF
            WHERE
                EFF.GLBL_CMPY_CD             = #glblCmpyCd#
                AND EFF.EZCANCELFLAG         = '0'
                AND EFF.DS_CONTR_DTL_PK      = #dsContrDtlPk#
                <isNotNull  property="dsContrBllgMtrPk"> 
                AND EFF.DS_CONTR_BLLG_MTR_PK = #dsContrBllgMtrPk#
                </isNotNull>
                <isNull  property="dsContrBllgMtrPk">
                AND EFF.DS_CONTR_BLLG_MTR_PK IS NULL
                </isNull>
            )
        WHERE
            ROW_NUM = 1
     </statement>
<!-- START 2017/02/08 K.Kitachi [QC#17410, ADD] -->
    <statement id="countCfsDlr" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            COUNT(*)
        FROM
             BILL_TO_CUST    BTC
            ,SELL_TO_CUST    STC
        WHERE
                BTC.GLBL_CMPY_CD    = #glblCmpyCd#
            AND BTC.BILL_TO_CUST_CD = #billToCustCd#
            AND BTC.EZCANCELFLAG    = '0'
            AND BTC.GLBL_CMPY_CD    = STC.GLBL_CMPY_CD
            AND BTC.SELL_TO_CUST_CD = STC.SELL_TO_CUST_CD
            AND STC.DS_ACCT_DLR_CD  = #cfsDlrCd#
            AND STC.EZCANCELFLAG    = '0'
    </statement>
    <statement id="getRegAndAggBase" parameterClass="Map" resultClass="Map">
        SELECT
             X.UPLFT_EFF_FROM_DT
            ,X.SER_NUM
            ,X.MDL_ID
            ,X.MDL_NM
            ,X.PRC_UP_RATIO
            ,X.DS_CONTR_DTL_TP_CD
            ,X.SVC_MACH_MSTR_PK
        FROM
            (
                SELECT
                     DCD.RNW_EFF_FROM_DT       AS UPLFT_EFF_FROM_DT
                    ,SMM.SER_NUM               AS SER_NUM
                    ,MNM.T_MDL_ID              AS MDL_ID
                    ,MNM.T_MDL_NM              AS MDL_NM
                    ,CRE.BASE_PRC_UP_RATIO     AS PRC_UP_RATIO
                    ,DCD.DS_CONTR_DTL_TP_CD    AS DS_CONTR_DTL_TP_CD
                    ,SMM.SVC_MACH_MSTR_PK      AS SVC_MACH_MSTR_PK
                    ,CRE.DS_CONTR_MACH_LVL_NUM AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_AUTO_RNW_TP RTP
                    ,SVC_MACH_MSTR     SMM
                    ,SVC_CONFIG_MSTR   SCM
                    ,MDL_NM            MNM
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_PK           = CRE.DS_CONTR_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl1#
                    AND CRE.EZCANCELFLAG          = '0'
                    AND CRE.GLBL_CMPY_CD          = RTP.GLBL_CMPY_CD
                    AND CRE.CONTR_AUTO_RNW_TP_CD  = RTP.CONTR_AUTO_RNW_TP_CD
                    <!-- START 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    <!-- AND RTP.AUTO_RNW_FLG          = 'Y' -->
                    <!-- END 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    AND RTP.RNW_BASE_FLG          = 'Y'
                    AND RTP.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = SMM.GLBL_CMPY_CD
                    AND DCD.SVC_MACH_MSTR_PK      = SMM.SVC_MACH_MSTR_PK
                    AND SMM.EZCANCELFLAG          = '0'
                    AND SMM.GLBL_CMPY_CD          = SCM.GLBL_CMPY_CD
                    AND SMM.SVC_CONFIG_MSTR_PK    = SCM.SVC_CONFIG_MSTR_PK
                    AND SCM.EZCANCELFLAG          = '0'
                    AND SCM.GLBL_CMPY_CD          = MNM.T_GLBL_CMPY_CD
                    AND SCM.MDL_ID                = MNM.T_MDL_ID
                    AND MNM.EZCANCELFLAG          = '0'
                UNION
                SELECT
                     DCD.RNW_EFF_FROM_DT       AS UPLFT_EFF_FROM_DT
                    ,SMM.SER_NUM               AS SER_NUM
                    ,MNM.T_MDL_ID              AS MDL_ID
                    ,MNM.T_MDL_NM              AS MDL_NM
                    ,CRE.BASE_PRC_UP_RATIO     AS PRC_UP_RATIO
                    ,DCD.DS_CONTR_DTL_TP_CD    AS DS_CONTR_DTL_TP_CD
                    ,SMM.SVC_MACH_MSTR_PK      AS SVC_MACH_MSTR_PK
                    ,CRE.DS_CONTR_MACH_LVL_NUM AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_AUTO_RNW_TP RTP
                    ,SVC_MACH_MSTR     SMM
                    ,SVC_CONFIG_MSTR   SCM
                    ,MDL_NM            MNM
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CRE.DS_CONTR_DTL_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl2#
                    AND CRE.EZCANCELFLAG          = '0'
                    AND CRE.GLBL_CMPY_CD          = RTP.GLBL_CMPY_CD
                    AND CRE.CONTR_AUTO_RNW_TP_CD  = RTP.CONTR_AUTO_RNW_TP_CD
                    <!-- START 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    <!-- AND RTP.AUTO_RNW_FLG          = 'Y' -->
                    <!-- END 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    AND RTP.RNW_BASE_FLG          = 'Y'
                    AND RTP.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = SMM.GLBL_CMPY_CD
                    AND DCD.SVC_MACH_MSTR_PK      = SMM.SVC_MACH_MSTR_PK
                    AND SMM.EZCANCELFLAG          = '0'
                    AND SMM.GLBL_CMPY_CD          = SCM.GLBL_CMPY_CD
                    AND SMM.SVC_CONFIG_MSTR_PK    = SCM.SVC_CONFIG_MSTR_PK
                    AND SCM.EZCANCELFLAG          = '0'
                    AND SCM.GLBL_CMPY_CD          = MNM.T_GLBL_CMPY_CD
                    AND SCM.MDL_ID                = MNM.T_MDL_ID
                    AND MNM.EZCANCELFLAG          = '0'
                UNION
                SELECT
                     DCD.RNW_EFF_FROM_DT       AS UPLFT_EFF_FROM_DT
                    ,SMM.SER_NUM               AS SER_NUM
                    ,MNM.T_MDL_ID              AS MDL_ID
                    ,MNM.T_MDL_NM              AS MDL_NM
                    ,CRE.BASE_PRC_UP_RATIO     AS PRC_UP_RATIO
                    ,DCD.DS_CONTR_DTL_TP_CD    AS DS_CONTR_DTL_TP_CD
                    ,SMM.SVC_MACH_MSTR_PK      AS SVC_MACH_MSTR_PK
                    ,CRE.DS_CONTR_MACH_LVL_NUM AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_AUTO_RNW_TP RTP
                    ,SVC_MACH_MSTR     SMM
                    ,SVC_CONFIG_MSTR   SCM
                    ,MDL_NM            MNM
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CRE.DS_CONTR_DTL_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl3#
                    AND CRE.DS_CONTR_BASE_USG_NM  = #dsContrBaseUsgNm#
                    AND CRE.EZCANCELFLAG          = '0'
                    AND CRE.GLBL_CMPY_CD          = RTP.GLBL_CMPY_CD
                    AND CRE.CONTR_AUTO_RNW_TP_CD  = RTP.CONTR_AUTO_RNW_TP_CD
                    <!-- START 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    <!-- AND RTP.AUTO_RNW_FLG          = 'Y' -->
                    <!-- END 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    AND RTP.RNW_BASE_FLG          = 'Y'
                    AND RTP.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = SMM.GLBL_CMPY_CD
                    AND DCD.SVC_MACH_MSTR_PK      = SMM.SVC_MACH_MSTR_PK
                    AND SMM.EZCANCELFLAG          = '0'
                    AND SMM.GLBL_CMPY_CD          = SCM.GLBL_CMPY_CD
                    AND SMM.SVC_CONFIG_MSTR_PK    = SCM.SVC_CONFIG_MSTR_PK
                    AND SCM.EZCANCELFLAG          = '0'
                    AND SCM.GLBL_CMPY_CD          = MNM.T_GLBL_CMPY_CD
                    AND SCM.MDL_ID                = MNM.T_MDL_ID
                    AND MNM.EZCANCELFLAG          = '0'
                ORDER BY
                    DS_CONTR_MACH_LVL_NUM DESC
            ) X
        WHERE
            ROWNUM = 1
    </statement>
    <statement id="getRegAndAggUsg" parameterClass="Map" resultClass="Map">
        SELECT
             X.UPLFT_EFF_FROM_DT
            ,X.SER_NUM
            ,X.MDL_ID
            ,X.MDL_NM
            ,X.PRC_UP_RATIO
            ,X.DS_CONTR_DTL_TP_CD
            ,X.SVC_MACH_MSTR_PK
            ,X.DS_CONTR_BLLG_MTR_PK
            ,X.MTR_LB_CD
        FROM
            (
                SELECT
                     DCD.RNW_EFF_FROM_DT       AS UPLFT_EFF_FROM_DT
                    ,SMM.SER_NUM               AS SER_NUM
                    ,MNM.T_MDL_ID              AS MDL_ID
                    ,MNM.T_MDL_NM              AS MDL_NM
                    ,CRE.MTR_PRC_UP_RATIO      AS PRC_UP_RATIO
                    ,DCD.DS_CONTR_DTL_TP_CD    AS DS_CONTR_DTL_TP_CD
                    ,SMM.SVC_MACH_MSTR_PK      AS SVC_MACH_MSTR_PK
                    ,CBM.DS_CONTR_BLLG_MTR_PK  AS DS_CONTR_BLLG_MTR_PK
                    ,CBM.BLLG_MTR_LB_CD        AS MTR_LB_CD
                    ,CRE.DS_CONTR_MACH_LVL_NUM AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_BLLG_MTR CBM
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_AUTO_RNW_TP RTP
                    ,SVC_MACH_MSTR     SMM
                    ,SVC_CONFIG_MSTR   SCM
                    ,MDL_NM            MNM
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CBM.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CBM.DS_CONTR_DTL_PK
                    AND CBM.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
                    AND CBM.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_PK           = CRE.DS_CONTR_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl1#
                    AND CRE.EZCANCELFLAG          = '0'
                    AND CRE.GLBL_CMPY_CD          = RTP.GLBL_CMPY_CD
                    AND CRE.CONTR_AUTO_RNW_TP_CD  = RTP.CONTR_AUTO_RNW_TP_CD
                    <!-- START 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    <!-- AND RTP.AUTO_RNW_FLG          = 'Y' -->
                    <!-- END 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    AND RTP.RNW_USG_FLG           = 'Y'
                    AND RTP.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = SMM.GLBL_CMPY_CD
                    AND DCD.SVC_MACH_MSTR_PK      = SMM.SVC_MACH_MSTR_PK
                    AND SMM.EZCANCELFLAG          = '0'
                    AND SMM.GLBL_CMPY_CD          = SCM.GLBL_CMPY_CD
                    AND SMM.SVC_CONFIG_MSTR_PK    = SCM.SVC_CONFIG_MSTR_PK
                    AND SCM.EZCANCELFLAG          = '0'
                    AND SCM.GLBL_CMPY_CD          = MNM.T_GLBL_CMPY_CD
                    AND SCM.MDL_ID                = MNM.T_MDL_ID
                    AND MNM.EZCANCELFLAG          = '0'
                UNION
                SELECT
                     DCD.RNW_EFF_FROM_DT       AS UPLFT_EFF_FROM_DT
                    ,SMM.SER_NUM               AS SER_NUM
                    ,MNM.T_MDL_ID              AS MDL_ID
                    ,MNM.T_MDL_NM              AS MDL_NM
                    ,CRE.MTR_PRC_UP_RATIO      AS PRC_UP_RATIO
                    ,DCD.DS_CONTR_DTL_TP_CD    AS DS_CONTR_DTL_TP_CD
                    ,SMM.SVC_MACH_MSTR_PK      AS SVC_MACH_MSTR_PK
                    ,CBM.DS_CONTR_BLLG_MTR_PK  AS DS_CONTR_BLLG_MTR_PK
                    ,CBM.BLLG_MTR_LB_CD        AS MTR_LB_CD
                    ,CRE.DS_CONTR_MACH_LVL_NUM AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_BLLG_MTR CBM
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_AUTO_RNW_TP RTP
                    ,SVC_MACH_MSTR     SMM
                    ,SVC_CONFIG_MSTR   SCM
                    ,MDL_NM            MNM
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CBM.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CBM.DS_CONTR_DTL_PK
                    AND CBM.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
                    AND CBM.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CRE.DS_CONTR_DTL_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl2#
                    AND CRE.EZCANCELFLAG          = '0'
                    AND CRE.GLBL_CMPY_CD          = RTP.GLBL_CMPY_CD
                    AND CRE.CONTR_AUTO_RNW_TP_CD  = RTP.CONTR_AUTO_RNW_TP_CD
                    <!-- START 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    <!-- AND RTP.AUTO_RNW_FLG          = 'Y' -->
                    <!-- END 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    AND RTP.RNW_USG_FLG           = 'Y'
                    AND RTP.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = SMM.GLBL_CMPY_CD
                    AND DCD.SVC_MACH_MSTR_PK      = SMM.SVC_MACH_MSTR_PK
                    AND SMM.EZCANCELFLAG          = '0'
                    AND SMM.GLBL_CMPY_CD          = SCM.GLBL_CMPY_CD
                    AND SMM.SVC_CONFIG_MSTR_PK    = SCM.SVC_CONFIG_MSTR_PK
                    AND SCM.EZCANCELFLAG          = '0'
                    AND SCM.GLBL_CMPY_CD          = MNM.T_GLBL_CMPY_CD
                    AND SCM.MDL_ID                = MNM.T_MDL_ID
                    AND MNM.EZCANCELFLAG          = '0'
                UNION
                SELECT
                     DCD.RNW_EFF_FROM_DT       AS UPLFT_EFF_FROM_DT
                    ,SMM.SER_NUM               AS SER_NUM
                    ,MNM.T_MDL_ID              AS MDL_ID
                    ,MNM.T_MDL_NM              AS MDL_NM
                    ,CRE.MTR_PRC_UP_RATIO      AS PRC_UP_RATIO
                    ,DCD.DS_CONTR_DTL_TP_CD    AS DS_CONTR_DTL_TP_CD
                    ,SMM.SVC_MACH_MSTR_PK      AS SVC_MACH_MSTR_PK
                    ,CBM.DS_CONTR_BLLG_MTR_PK  AS DS_CONTR_BLLG_MTR_PK
                    ,CBM.BLLG_MTR_LB_CD        AS MTR_LB_CD
                    ,CRE.DS_CONTR_MACH_LVL_NUM AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_BLLG_MTR CBM
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_AUTO_RNW_TP RTP
                    ,SVC_MACH_MSTR     SMM
                    ,SVC_CONFIG_MSTR   SCM
                    ,MDL_NM            MNM
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CBM.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CBM.DS_CONTR_DTL_PK
                    AND CBM.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
                    AND CBM.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CRE.DS_CONTR_DTL_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl3#
                    AND CRE.DS_CONTR_BASE_USG_NM  = #dsContrBaseUsgNm#
                    AND CRE.EZCANCELFLAG          = '0'
                    AND CRE.GLBL_CMPY_CD          = RTP.GLBL_CMPY_CD
                    AND CRE.CONTR_AUTO_RNW_TP_CD  = RTP.CONTR_AUTO_RNW_TP_CD
                    <!-- START 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    <!-- AND RTP.AUTO_RNW_FLG          = 'Y' -->
                    <!-- END 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    AND RTP.RNW_USG_FLG           = 'Y'
                    AND RTP.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = SMM.GLBL_CMPY_CD
                    AND DCD.SVC_MACH_MSTR_PK      = SMM.SVC_MACH_MSTR_PK
                    AND SMM.EZCANCELFLAG          = '0'
                    AND SMM.GLBL_CMPY_CD          = SCM.GLBL_CMPY_CD
                    AND SMM.SVC_CONFIG_MSTR_PK    = SCM.SVC_CONFIG_MSTR_PK
                    AND SCM.EZCANCELFLAG          = '0'
                    AND SCM.GLBL_CMPY_CD          = MNM.T_GLBL_CMPY_CD
                    AND SCM.MDL_ID                = MNM.T_MDL_ID
                    AND MNM.EZCANCELFLAG          = '0'
                ORDER BY
                    DS_CONTR_MACH_LVL_NUM DESC
            ) X
        WHERE
            ROWNUM = 1
    </statement>
    <statement id="getFltBase" parameterClass="Map" resultClass="Map">
        SELECT
             X.UPLFT_EFF_FROM_DT
            ,X.PRC_UP_RATIO
            ,X.DS_CONTR_DTL_TP_CD
        FROM
            (
                SELECT
                     DCD.RNW_EFF_FROM_DT       AS UPLFT_EFF_FROM_DT
                    ,CRE.BASE_PRC_UP_RATIO     AS PRC_UP_RATIO
                    ,DCD.DS_CONTR_DTL_TP_CD    AS DS_CONTR_DTL_TP_CD
                    ,CRE.DS_CONTR_MACH_LVL_NUM AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_AUTO_RNW_TP RTP
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_PK           = CRE.DS_CONTR_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl1#
                    AND CRE.EZCANCELFLAG          = '0'
                    AND CRE.GLBL_CMPY_CD          = RTP.GLBL_CMPY_CD
                    AND CRE.CONTR_AUTO_RNW_TP_CD  = RTP.CONTR_AUTO_RNW_TP_CD
                    <!-- START 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    <!-- AND RTP.AUTO_RNW_FLG          = 'Y' -->
                    <!-- END 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    AND RTP.RNW_BASE_FLG          = 'Y'
                    AND RTP.EZCANCELFLAG          = '0'
                UNION
                SELECT
                     DCD.RNW_EFF_FROM_DT       AS UPLFT_EFF_FROM_DT
                    ,CRE.BASE_PRC_UP_RATIO     AS PRC_UP_RATIO
                    ,DCD.DS_CONTR_DTL_TP_CD    AS DS_CONTR_DTL_TP_CD
                    ,CRE.DS_CONTR_MACH_LVL_NUM AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_AUTO_RNW_TP RTP
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CRE.DS_CONTR_DTL_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl2#
                    AND CRE.EZCANCELFLAG          = '0'
                    AND CRE.GLBL_CMPY_CD          = RTP.GLBL_CMPY_CD
                    AND CRE.CONTR_AUTO_RNW_TP_CD  = RTP.CONTR_AUTO_RNW_TP_CD
                    <!-- START 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    <!-- AND RTP.AUTO_RNW_FLG          = 'Y' -->
                    <!-- END 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    AND RTP.RNW_BASE_FLG          = 'Y'
                    AND RTP.EZCANCELFLAG          = '0'
                UNION
                SELECT
                     DCD.RNW_EFF_FROM_DT       AS UPLFT_EFF_FROM_DT
                    ,CRE.BASE_PRC_UP_RATIO     AS PRC_UP_RATIO
                    ,DCD.DS_CONTR_DTL_TP_CD    AS DS_CONTR_DTL_TP_CD
                    ,CRE.DS_CONTR_MACH_LVL_NUM AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_AUTO_RNW_TP RTP
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CRE.DS_CONTR_DTL_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl3#
                    AND CRE.DS_CONTR_BASE_USG_NM  = #dsContrBaseUsgNm#
                    AND CRE.EZCANCELFLAG          = '0'
                    AND CRE.GLBL_CMPY_CD          = RTP.GLBL_CMPY_CD
                    AND CRE.CONTR_AUTO_RNW_TP_CD  = RTP.CONTR_AUTO_RNW_TP_CD
                    <!-- START 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    <!-- AND RTP.AUTO_RNW_FLG          = 'Y' -->
                    <!-- END 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    AND RTP.RNW_BASE_FLG          = 'Y'
                    AND RTP.EZCANCELFLAG          = '0'
                ORDER BY
                    DS_CONTR_MACH_LVL_NUM DESC
            ) X
        WHERE
            ROWNUM = 1
    </statement>
    <statement id="getFltUsg" parameterClass="Map" resultClass="Map">
        SELECT
             X.UPLFT_EFF_FROM_DT
            ,X.PRC_UP_RATIO
            ,X.DS_CONTR_DTL_TP_CD
            ,X.DS_CONTR_BLLG_MTR_PK
            ,X.MTR_LB_CD
        FROM
            (
                SELECT
                     DCD.RNW_EFF_FROM_DT       AS UPLFT_EFF_FROM_DT
                    ,CRE.MTR_PRC_UP_RATIO      AS PRC_UP_RATIO
                    ,DCD.DS_CONTR_DTL_TP_CD    AS DS_CONTR_DTL_TP_CD
                    ,CBM.DS_CONTR_BLLG_MTR_PK  AS DS_CONTR_BLLG_MTR_PK
                    ,CBM.BLLG_MTR_LB_CD        AS MTR_LB_CD
                    ,CRE.DS_CONTR_MACH_LVL_NUM AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_BLLG_MTR CBM
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_AUTO_RNW_TP RTP
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CBM.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CBM.DS_CONTR_DTL_PK
                    AND CBM.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
                    AND CBM.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_PK           = CRE.DS_CONTR_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl1#
                    AND CRE.EZCANCELFLAG          = '0'
                    AND CRE.GLBL_CMPY_CD          = RTP.GLBL_CMPY_CD
                    AND CRE.CONTR_AUTO_RNW_TP_CD  = RTP.CONTR_AUTO_RNW_TP_CD
                    <!-- START 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    <!-- AND RTP.AUTO_RNW_FLG          = 'Y' -->
                    <!-- END 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    AND RTP.RNW_USG_FLG           = 'Y'
                    AND RTP.EZCANCELFLAG          = '0'
                UNION
                SELECT
                     DCD.RNW_EFF_FROM_DT       AS UPLFT_EFF_FROM_DT
                    ,CRE.MTR_PRC_UP_RATIO      AS PRC_UP_RATIO
                    ,DCD.DS_CONTR_DTL_TP_CD    AS DS_CONTR_DTL_TP_CD
                    ,CBM.DS_CONTR_BLLG_MTR_PK  AS DS_CONTR_BLLG_MTR_PK
                    ,CBM.BLLG_MTR_LB_CD        AS MTR_LB_CD
                    ,CRE.DS_CONTR_MACH_LVL_NUM AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_BLLG_MTR CBM
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_AUTO_RNW_TP RTP
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CBM.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CBM.DS_CONTR_DTL_PK
                    AND CBM.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
                    AND CBM.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CRE.DS_CONTR_DTL_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl2#
                    AND CRE.EZCANCELFLAG          = '0'
                    AND CRE.GLBL_CMPY_CD          = RTP.GLBL_CMPY_CD
                    AND CRE.CONTR_AUTO_RNW_TP_CD  = RTP.CONTR_AUTO_RNW_TP_CD
                    <!-- START 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    <!-- AND RTP.AUTO_RNW_FLG          = 'Y' -->
                    <!-- END 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    AND RTP.RNW_USG_FLG           = 'Y'
                    AND RTP.EZCANCELFLAG          = '0'
                UNION
                SELECT
                     DCD.RNW_EFF_FROM_DT       AS UPLFT_EFF_FROM_DT
                    ,CRE.MTR_PRC_UP_RATIO      AS PRC_UP_RATIO
                    ,DCD.DS_CONTR_DTL_TP_CD    AS DS_CONTR_DTL_TP_CD
                    ,CBM.DS_CONTR_BLLG_MTR_PK  AS DS_CONTR_BLLG_MTR_PK
                    ,CBM.BLLG_MTR_LB_CD        AS MTR_LB_CD
                    ,CRE.DS_CONTR_MACH_LVL_NUM AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_BLLG_MTR CBM
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_AUTO_RNW_TP RTP
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CBM.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CBM.DS_CONTR_DTL_PK
                    AND CBM.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
                    AND CBM.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CRE.DS_CONTR_DTL_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl3#
                    AND CRE.DS_CONTR_BASE_USG_NM  = #dsContrBaseUsgNm#
                    AND CRE.EZCANCELFLAG          = '0'
                    AND CRE.GLBL_CMPY_CD          = RTP.GLBL_CMPY_CD
                    AND CRE.CONTR_AUTO_RNW_TP_CD  = RTP.CONTR_AUTO_RNW_TP_CD
                    <!-- START 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    <!-- AND RTP.AUTO_RNW_FLG          = 'Y' -->
                    <!-- END 2024/04/01 K.Ogasawara [QC#63550, DEL] -->
                    AND RTP.RNW_USG_FLG           = 'Y'
                    AND RTP.EZCANCELFLAG          = '0'
                ORDER BY
                    DS_CONTR_MACH_LVL_NUM DESC
            ) X
        WHERE
            ROWNUM = 1
    </statement>
<!-- END 2017/02/08 K.Kitachi [QC#17410, ADD] -->

<!-- START 2017/08/23 M.Naito [QC#8661, ADD] -->
    <statement id="getRnwLtrCtrlInfo" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             COUNT(*)
        FROM
             DS_CONTR              DC
            ,SVC_RG_BR_RELN        SRBR
            ,RNW_ESCL_LTR_CTRL     RELC
        WHERE
                DC.GLBL_CMPY_CD       = #glblCmpyCd#
            AND DC.DS_CONTR_PK        = #dsContrPk#
            AND DC.GLBL_CMPY_CD       = SRBR.GLBL_CMPY_CD
            AND DC.SVC_CONTR_BR_CD    = SRBR.SVC_CONTR_BR_CD
            AND DC.GLBL_CMPY_CD       = RELC.GLBL_CMPY_CD
            AND DC.SVC_LINE_BIZ_CD    = RELC.SVC_LINE_BIZ_CD
            AND DC.SVC_CONTR_BR_CD    = RELC.SVC_CONTR_BR_CD
            AND SRBR.SVC_RG_PK        = RELC.SVC_RG_PK
            AND RELC.RNW_LTR_FLG      = 'Y'
            AND DC.EZCANCELFLAG       = '0'
            AND SRBR.EZCANCELFLAG     = '0'
            AND RELC.EZCANCELFLAG     = '0'
    </statement>

    <statement id="getRenewalLetterList" parameterClass="Map" resultClass="Map">
        SELECT DISTINCT
             DCD.DS_CONTR_PK
            ,DCD.DS_CONTR_DTL_PK
            ,DC.DS_CONTR_NUM
            ,DC.DS_ACCT_NUM
            ,DC.ALT_PAYER_CUST_CD
            ,RELC.PRINT_OLD_PRC_FLG 
        FROM
             DS_CONTR_PRC_CHNG_REC DCPCR
            ,DS_CONTR_DTL          DCD
            ,DS_CONTR              DC
            ,SVC_RG_BR_RELN        SRBR
            ,RNW_ESCL_LTR_CTRL     RELC
        WHERE
                DCPCR.GLBL_CMPY_CD    = #glblCmpyCd#
            AND DCPCR.RNW_EFF_FROM_DT &gt;= #slsDt#
            AND DCPCR.EIP_RPT_RQST_DT IS NULL
            AND DCPCR.GLBL_CMPY_CD    = DCD.GLBL_CMPY_CD
            AND DCPCR.DS_CONTR_DTL_PK = DCD.DS_CONTR_DTL_PK
            AND DCD.GLBL_CMPY_CD      = DC.GLBL_CMPY_CD
            AND DCD.DS_CONTR_PK       = DC.DS_CONTR_PK
            AND DC.GLBL_CMPY_CD       = SRBR.GLBL_CMPY_CD
            AND DC.SVC_CONTR_BR_CD    = SRBR.SVC_CONTR_BR_CD
            AND DC.GLBL_CMPY_CD       = RELC.GLBL_CMPY_CD
            AND DC.SVC_LINE_BIZ_CD    = RELC.SVC_LINE_BIZ_CD
            AND DC.SVC_CONTR_BR_CD    = RELC.SVC_CONTR_BR_CD
            AND SRBR.SVC_RG_PK        = RELC.SVC_RG_PK
            AND RELC.RNW_LTR_FLG      = 'Y'
            AND DCPCR.EZCANCELFLAG    = '0'
            AND DCD.EZCANCELFLAG      = '0'
            AND DC.EZCANCELFLAG       = '0'
            AND SRBR.EZCANCELFLAG     = '0'
            AND RELC.EZCANCELFLAG     = '0'
        ORDER BY
             DCD.DS_CONTR_PK
            ,DCD.DS_CONTR_DTL_PK
        </statement>
<!-- END 2017/08/23 M.Naito [QC#8661, ADD] -->

<!-- START 2023/07/06 K.Watanabe [QC#61145, ADD] -->
    <statement id="getMdlNm" parameterClass="Map" resultClass="String">
        SELECT
             T_MDL_NM
        FROM
             SVC_MACH_MSTR         SMM
            ,SVC_CONFIG_MSTR       SCM
            ,MDL_NM                MN
        WHERE
                SMM.GLBL_CMPY_CD       = #glblCmpyCd#
            AND SMM.GLBL_CMPY_CD       = SCM.GLBL_CMPY_CD
            AND SMM.GLBL_CMPY_CD       = MN.T_GLBL_CMPY_CD
            AND SMM.SVC_MACH_MSTR_PK   = #svcMachMstrPk#
            AND SCM.SVC_CONFIG_MSTR_PK = SMM.SVC_CONFIG_MSTR_PK
            AND SCM.MDL_ID             = MN.T_MDL_ID
            AND SMM.EZCANCELFLAG       = '0'
            AND SCM.EZCANCELFLAG       = '0'
            AND MN.EZCANCELFLAG        = '0'
    </statement>
<!-- END 2023/07/06 K.Watanabe [QC#61145, ADD] -->
   </sqlMap>
