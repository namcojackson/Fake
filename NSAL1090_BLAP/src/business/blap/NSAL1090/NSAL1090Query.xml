<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSAL1090Query">
    <typeAlias alias="NSAL1090CMsg"  type="business.blap.NSAL1090.NSAL1090CMsg"/>
    <typeAlias alias="NSAL1090_ASMsg"  type="business.blap.NSAL1090.NSAL1090_ASMsg"/>

<!-- START 2018/05/31 M.Naito [QC#22908, MOD] -->
    <statement id="getHeaderInfo" parameterClass="Map" resultMap="result.getHeaderInfo">
            SELECT DISTINCT
                 B.SVC_CR_REBIL_STS_DESC_TXT    AS  SVC_CR_REBIL_STS_DESC_TXT
                ,A.SVC_CR_REBIL_DESC_TXT        AS  SVC_CR_REBIL_DESC_TXT
                ,A.SVC_CR_REBIL_PROC_CD         AS  SVC_CR_REBIL_PROC_CD
                ,A.SVC_CR_REBIL_PK              AS  SVC_CR_REBIL_PK
                ,A.SVC_CR_REBIL_STS_CD          AS  SVC_CR_REBIL_STS_CD
                ,D.DS_ACCT_NUM                  AS  DS_ACCT_NUM
            FROM
                 SVC_CR_REBIL         A
                ,SVC_CR_REBIL_STS     B
                ,SVC_CR_REBIL_DTL     C
                ,DS_CONTR             D
            WHERE
                    A.GLBL_CMPY_CD              = #glblCmpyCd#
                AND A.CUST_INCDT_ID             = #custIncdtId#
                AND A.EZCANCELFLAG              = '0'
                AND A.GLBL_CMPY_CD              = B.GLBL_CMPY_CD
                AND A.SVC_CR_REBIL_STS_CD       = B.SVC_CR_REBIL_STS_CD
                AND B.EZCANCELFLAG              = '0'
                AND A.GLBL_CMPY_CD              = C.GLBL_CMPY_CD
                AND A.SVC_CR_REBIL_PK           = C.SVC_CR_REBIL_PK
                AND C.EZCANCELFLAG              = '0'
                AND C.GLBL_CMPY_CD              = D.GLBL_CMPY_CD
                AND C.DS_CONTR_PK               = D.DS_CONTR_PK
                AND D.EZCANCELFLAG              = '0'
    </statement>
<!-- END 2018/05/31 M.Naito [QC#22908, MOD] -->
    <statement id="getDetailInfo" parameterClass="Map" resultMap="result.getDetailInfo">
            <!-- add start 2019/08/23 QC#52934 -->
            WITH TMP_CONSL_BILL AS (
                SELECT
                     B.GLBL_CMPY_CD
                    ,B.EZCANCELFLAG
                    ,B.CONSL_BILL_PK
                    ,B.CONSL_BILL_TRX_ID
                FROM
                     CONSL_BILL      A
                    ,CONSL_BILL_LINE B
                WHERE
                        A.GLBL_CMPY_CD       = #glblCmpyCd#
                    AND A.EZCANCELFLAG       = '0'
                    AND A.ORIG_CONSL_BILL_PK IS NULL
                    AND A.GLBL_CMPY_CD       = B.GLBL_CMPY_CD
                    AND A.CONSL_BILL_PK      = B.CONSL_BILL_PK
                    AND B.EZCANCELFLAG       = '0'
            )
            <!-- add end 2019/08/23 QC#52934 -->
            SELECT
                 ROWNUM AS XX_ROW_NUM
                ,ORIG_SVC_INV_NUM
                ,DS_CONTR_NUM
                ,CONSL_BILL_PK
                ,INV_TP_NM
                ,XX_FROM_DT
                ,XX_THRU_DT
                ,XX_INV_AMT_A1
                ,XX_INV_AMT_A2
<!-- START 2017/09/26 M.Naito [QC#21251, MOD] -->
                ,CASE WHEN XX_INV_AMT_A2 &lt; XX_INV_AMT_A1 THEN -XX_INV_AMT_A3
                 ELSE XX_INV_AMT_A3
                 END AS XX_INV_AMT_A3
<!-- END 2017/09/26 M.Naito [QC#21251, MOD] -->
                ,XX_CHK_BOX
                ,REBIL_SVC_INV_NUM
                ,CR_SVC_INV_NUM
                ,SVC_CR_REBIL_DTL_PK
<!-- START 2016/12/06 N.Arai [QC#14204, ADD] -->
                ,XX_REC_HIST_CRAT_TS
                ,XX_REC_HIST_CRAT_BY_NM
                ,XX_REC_HIST_UPD_TS
                ,XX_REC_HIST_UPD_BY_NM
                ,XX_REC_HIST_TBL_NM
<!-- END 2016/12/06 N.Arai [QC#14204, ADD] -->
            FROM (
                SELECT
                     ORIG_SVC_INV_NUM
                    ,DS_CONTR_NUM
                    ,CONSL_BILL_PK
                    ,INV_TP_NM
                    ,XX_FROM_DT
                    ,XX_THRU_DT
                    ,SUM(XX_INV_AMT_A1) AS XX_INV_AMT_A1
                    ,SUM(XX_INV_AMT_A2) AS XX_INV_AMT_A2
<!-- START 2017/10/12 K.Kim [QC#21789, MOD] -->
                    <!-- ,SUM(XX_INV_AMT_A3) AS XX_INV_AMT_A3 -->
                    ,ABS(SUM(XX_INV_AMT_A3)) AS XX_INV_AMT_A3
<!-- START 2017/10/12 K.Kim [QC#21789, MOD] -->
                    ,XX_CHK_BOX
                    ,REBIL_SVC_INV_NUM
                    ,CR_SVC_INV_NUM
                    ,SVC_CR_REBIL_DTL_PK
                    ,BLLG_PER_FROM_DT
<!-- START 2016/12/06 N.Arai [QC#14204, ADD] -->
                    ,XX_REC_HIST_CRAT_TS
                    ,XX_REC_HIST_CRAT_BY_NM
                    ,XX_REC_HIST_UPD_TS
                    ,XX_REC_HIST_UPD_BY_NM
                    ,XX_REC_HIST_TBL_NM
<!-- END 2016/12/06 N.Arai [QC#14204, ADD] -->
<!-- START 2018/03/27 M.Naito [QC#18672, ADD -->
                    ,SORT_INV_TP_NUM
<!-- END 2018/03/27 M.Naito [QC#18672, ADD -->
                FROM (
                    SELECT
                         B.ORIG_SVC_INV_NUM           AS  ORIG_SVC_INV_NUM
                        ,C.DS_CONTR_NUM               AS  DS_CONTR_NUM
                        ,E.CONSL_BILL_PK              AS  CONSL_BILL_PK
                        ,'BASE'                       AS  INV_TP_NM
                        ,D.BASE_BLLG_FROM_DT          AS  XX_FROM_DT
                        ,D.BASE_BLLG_THRU_DT          AS  XX_THRU_DT
                        ,D.OLD_BASE_DEAL_AMT          AS  XX_INV_AMT_A1
<!-- START 2018/10/30 K.Kojima [QC#29000, MOD] -->
<!--                    ,D.NEW_BASE_DEAL_AMT          AS  XX_INV_AMT_A2 -->
                        ,NVL(D.NEW_BASE_DEAL_AMT,D.OLD_BASE_DEAL_AMT) AS XX_INV_AMT_A2
<!-- END 2018/10/30 K.Kojima [QC#29000, MOD] -->
<!-- START 2017/10/12 K.Kim [QC#21789, MOD] -->
                        <!-- ,D.INV_BASE_DEAL_NET_AMT      AS  XX_INV_AMT_A3 -->
                        ,D.OLD_BASE_DEAL_AMT - D.NEW_BASE_DEAL_AMT  AS  XX_INV_AMT_A3
<!-- END 2017/10/12 K.Kim [QC#21789, MOD] -->
                        ,B.INV_PRINT_FLG              AS  XX_CHK_BOX
                        ,B.REBIL_SVC_INV_NUM          AS  REBIL_SVC_INV_NUM
                        ,B.CR_SVC_INV_NUM             AS  CR_SVC_INV_NUM
                        ,B.SVC_CR_REBIL_DTL_PK        AS  SVC_CR_REBIL_DTL_PK
                        ,C.BLLG_PER_FROM_DT           AS  BLLG_PER_FROM_DT
<!-- START 2016/12/06 N.Arai [QC#14204, ADD] -->
                        ,B.EZINTIME                   AS   XX_REC_HIST_CRAT_TS
                        ,B.EZINUSERID                 AS   XX_REC_HIST_CRAT_BY_NM
                        ,B.EZUPTIME                   AS   XX_REC_HIST_UPD_TS
                        ,B.EZUPUSERID                 AS   XX_REC_HIST_UPD_BY_NM
                        ,B.EZTABLEID                  AS   XX_REC_HIST_TBL_NM
<!-- END 2016/12/06 N.Arai [QC#14204, ADD] -->
<!-- START 2018/03/27 M.Naito [QC#18672, ADD -->
                        ,'1'                          AS   SORT_INV_TP_NUM
<!-- END 2018/03/27 M.Naito [QC#18672, ADD -->
                    FROM
                         SVC_CR_REBIL             A
                        ,SVC_CR_REBIL_DTL         B
                        ,SVC_INV                  C
                        ,SVC_CR_REBIL_BASE_BLLG   D
<!-- mod start 2019/08/23 QC#52934 -->
                        <!-- ,CONSL_BILL_LINE          E -->
                        ,TMP_CONSL_BILL           E
<!-- mod end 2019/08/23 QC#52934 -->
                        ,DS_CONTR_DTL             F
                        ,DS_CONTR                 G
                    WHERE
                            A.GLBL_CMPY_CD            = #glblCmpyCd#
                        AND A.CUST_INCDT_ID           = #custIncdtId#
                        AND A.EZCANCELFLAG            = '0'
                        AND A.GLBL_CMPY_CD            = B.GLBL_CMPY_CD
                        AND A.SVC_CR_REBIL_PK         = B.SVC_CR_REBIL_PK
                        AND B.EZCANCELFLAG            = '0'
                        AND B.GLBL_CMPY_CD            = C.GLBL_CMPY_CD
                        AND B.ORIG_SVC_INV_NUM        = C.SVC_INV_NUM
                        AND C.EZCANCELFLAG            = '0'
                        AND B.GLBL_CMPY_CD            = D.GLBL_CMPY_CD
                        AND B.SVC_CR_REBIL_DTL_PK     = D.SVC_CR_REBIL_DTL_PK
                        AND D.EZCANCELFLAG            = '0'
                        AND B.GLBL_CMPY_CD            = E.GLBL_CMPY_CD(+)
                        AND B.ORIG_SVC_INV_NUM        = E.CONSL_BILL_TRX_ID(+)
                        AND E.EZCANCELFLAG(+)         = '0'
                        AND D.GLBL_CMPY_CD            = F.GLBL_CMPY_CD
                        AND D.DS_CONTR_DTL_PK         = F.DS_CONTR_DTL_PK
                        AND F.EZCANCELFLAG            = '0'
                        AND F.GLBL_CMPY_CD            = G.GLBL_CMPY_CD
                        AND F.DS_CONTR_PK             = G.DS_CONTR_PK
                        AND G.EZCANCELFLAG            = '0'
                        AND (
                            G.DS_CONTR_CATG_CD = #dsContrCatg_reg#
                            OR  F.DS_CONTR_DTL_TP_CD = #dsContrDtlTp_flt#
                            OR (G.DS_CONTR_CATG_CD = #dsContrCatg_agg# AND F.DS_CONTR_DTL_TP_CD &lt;&gt; #dsContrDtlTp_agg#)
                        )
                    UNION ALL
                    SELECT
                         B.ORIG_SVC_INV_NUM           AS  ORIG_SVC_INV_NUM
                        ,C.DS_CONTR_NUM               AS  DS_CONTR_NUM
                        ,E.CONSL_BILL_PK              AS  CONSL_BILL_PK
                        ,'USAGE'                      AS  INV_TP_NM
                        ,D.MTR_BLLG_FROM_DT           AS  XX_FROM_DT
                        ,D.MTR_BLLG_THRU_DT           AS  XX_THRU_DT
                        ,D.OLD_MTR_CHRG_DEAL_AMT      AS  XX_INV_AMT_A1
<!-- START 2018/10/30 K.Kojima [QC#29000, MOD] -->
<!--                    ,D.NEW_MTR_CHRG_DEAL_AMT      AS  XX_INV_AMT_A2 -->
                        ,NVL(D.NEW_MTR_CHRG_DEAL_AMT,D.OLD_MTR_CHRG_DEAL_AMT) AS XX_INV_AMT_A2
<!-- END 2018/10/30 K.Kojima [QC#29000, MOD] -->
<!-- START 2017/10/12 K.Kim [QC#21789, MOD] -->
                        <!-- ,D.INV_MTR_CHRG_DEAL_NET_AMT  AS  XX_INV_AMT_A3 -->
                        ,D.OLD_MTR_CHRG_DEAL_AMT - D.NEW_MTR_CHRG_DEAL_AMT  AS  XX_INV_AMT_A3
<!-- END 2017/10/12 K.Kim [QC#21789, MOD] -->
                        ,B.INV_PRINT_FLG              AS  XX_CHK_BOX
                        ,B.REBIL_SVC_INV_NUM          AS  REBIL_SVC_INV_NUM
                        ,B.CR_SVC_INV_NUM             AS  CR_SVC_INV_NUM
                        ,B.SVC_CR_REBIL_DTL_PK        AS  SVC_CR_REBIL_DTL_PK
                        ,C.BLLG_PER_FROM_DT           AS  BLLG_PER_FROM_DT
<!-- START 2016/12/06 N.Arai [QC#14204, ADD] -->
                        ,B.EZINTIME                   AS   XX_REC_HIST_CRAT_TS
                        ,B.EZINUSERID                 AS   XX_REC_HIST_CRAT_BY_NM
                        ,B.EZUPTIME                   AS   XX_REC_HIST_UPD_TS
                        ,B.EZUPUSERID                 AS   XX_REC_HIST_UPD_BY_NM
                        ,B.EZTABLEID                  AS   XX_REC_HIST_TBL_NM
<!-- END 2016/12/06 N.Arai [QC#14204, ADD] -->
<!-- START 2018/03/27 M.Naito [QC#18672, ADD -->
                        ,'3'                          AS   SORT_INV_TP_NUM
<!-- END 2018/03/27 M.Naito [QC#18672, ADD -->
                    FROM
                         SVC_CR_REBIL             A
                        ,SVC_CR_REBIL_DTL         B
                        ,SVC_INV                  C
                        ,SVC_CR_REBIL_MTR_BLLG    D
<!-- mod start 2019/08/23 QC#52934 -->
                        <!-- ,CONSL_BILL_LINE          E -->
                        ,TMP_CONSL_BILL           E
<!-- mod end 2019/08/23 QC#52934 -->
                        ,DS_CONTR_DTL             F
                        ,DS_CONTR                 G
                    WHERE
                            A.GLBL_CMPY_CD            = #glblCmpyCd#
                        AND A.CUST_INCDT_ID           = #custIncdtId#
                        AND A.EZCANCELFLAG            = '0'
                        AND A.GLBL_CMPY_CD            = B.GLBL_CMPY_CD
                        AND A.SVC_CR_REBIL_PK         = B.SVC_CR_REBIL_PK
                        AND B.EZCANCELFLAG            = '0'
                        AND B.GLBL_CMPY_CD            = C.GLBL_CMPY_CD
                        AND B.ORIG_SVC_INV_NUM        = C.SVC_INV_NUM
                        AND C.EZCANCELFLAG            = '0'
                        AND B.GLBL_CMPY_CD            = D.GLBL_CMPY_CD
                        AND B.SVC_CR_REBIL_DTL_PK     = D.SVC_CR_REBIL_DTL_PK
                        AND D.EZCANCELFLAG            = '0'
                        AND B.GLBL_CMPY_CD            = E.GLBL_CMPY_CD(+)
                        AND B.ORIG_SVC_INV_NUM        = E.CONSL_BILL_TRX_ID(+)
                        AND E.EZCANCELFLAG(+)         = '0'
                        AND D.GLBL_CMPY_CD            = F.GLBL_CMPY_CD
                        AND D.DS_CONTR_DTL_PK         = F.DS_CONTR_DTL_PK
                        AND F.EZCANCELFLAG            = '0'
                        AND F.GLBL_CMPY_CD            = G.GLBL_CMPY_CD
                        AND F.DS_CONTR_PK             = G.DS_CONTR_PK
                        AND G.EZCANCELFLAG            = '0'
                        AND (
                            G.DS_CONTR_CATG_CD = #dsContrCatg_reg#
                            OR  F.DS_CONTR_DTL_TP_CD = #dsContrDtlTp_flt#
                            OR (G.DS_CONTR_CATG_CD = #dsContrCatg_agg# AND F.DS_CONTR_DTL_TP_CD &lt;&gt; #dsContrDtlTp_agg#)
                        )
<!-- START 2018/03/27 M.Naito [QC#18672, ADD -->
                    UNION ALL
                    SELECT
                         B.ORIG_SVC_INV_NUM           AS  ORIG_SVC_INV_NUM
                        ,C.DS_CONTR_NUM               AS  DS_CONTR_NUM
                        ,E.CONSL_BILL_PK              AS  CONSL_BILL_PK
                        ,'ADDITIONAL'                 AS  INV_TP_NM
                        ,D.ADDL_BLLG_FROM_DT          AS  XX_FROM_DT
                        ,D.ADDL_BLLG_THRU_DT          AS  XX_THRU_DT
                        ,D.OLD_ADDL_CHRG_DEAL_AMT     AS  XX_INV_AMT_A1
<!-- START 2018/10/30 K.Kojima [QC#29000, MOD] -->
<!--                    ,D.NEW_ADDL_CHRG_DEAL_AMT     AS  XX_INV_AMT_A2 -->
                        ,NVL(D.NEW_ADDL_CHRG_DEAL_AMT,D.OLD_ADDL_CHRG_DEAL_AMT) AS XX_INV_AMT_A2
<!-- END 2018/10/30 K.Kojima [QC#29000, MOD] -->
                        ,D.OLD_ADDL_CHRG_DEAL_AMT - D.NEW_ADDL_CHRG_DEAL_AMT  AS  XX_INV_AMT_A3
                        ,B.INV_PRINT_FLG              AS  XX_CHK_BOX
                        ,B.REBIL_SVC_INV_NUM          AS  REBIL_SVC_INV_NUM
                        ,B.CR_SVC_INV_NUM             AS  CR_SVC_INV_NUM
                        ,NVL(B.PRNT_SVC_CR_REBIL_DTL_PK, B.SVC_CR_REBIL_DTL_PK) AS  SVC_CR_REBIL_DTL_PK
                        ,C.BLLG_PER_FROM_DT           AS  BLLG_PER_FROM_DT
                        ,NVL(I.EZINTIME, B.EZINTIME)     AS   XX_REC_HIST_CRAT_TS
                        ,NVL(I.EZINUSERID, B.EZINUSERID) AS   XX_REC_HIST_CRAT_BY_NM
                        ,NVL(I.EZUPTIME, B.EZUPTIME)     AS   XX_REC_HIST_UPD_TS
                        ,NVL(I.EZUPUSERID, B.EZUPUSERID) AS   XX_REC_HIST_UPD_BY_NM
                        ,NVL(I.EZTABLEID, B.EZTABLEID)   AS   XX_REC_HIST_TBL_NM
                        ,CASE WHEN H.ADDL_CHRG_INV_TP_CD = #addlChrgInvTpCd# THEN '2'
                         ELSE '4'
                         END AS SORT_INV_TP_NUM
                    FROM
                         SVC_CR_REBIL             A
                        ,SVC_CR_REBIL_DTL         B
                        ,SVC_INV                  C
                        ,SVC_CR_REBIL_ADDL_BLLG   D
<!-- mod start 2019/08/23 QC#52934 -->
                        <!-- ,CONSL_BILL_LINE          E -->
                        ,TMP_CONSL_BILL           E
<!-- mod end 2019/08/23 QC#52934 -->
                        ,DS_CONTR_DTL             F
                        ,DS_CONTR                 G
                        ,DS_CONTR_ADDL_CHRG       H
                        ,SVC_CR_REBIL_DTL         I
                    WHERE
                            A.GLBL_CMPY_CD             = #glblCmpyCd#
                        AND A.CUST_INCDT_ID            = #custIncdtId#
                        AND A.EZCANCELFLAG             = '0'
                        AND A.GLBL_CMPY_CD             = B.GLBL_CMPY_CD
                        AND A.SVC_CR_REBIL_PK          = B.SVC_CR_REBIL_PK
                        AND B.EZCANCELFLAG             = '0'
                        AND B.GLBL_CMPY_CD             = C.GLBL_CMPY_CD
                        AND B.ORIG_SVC_INV_NUM         = C.SVC_INV_NUM
                        AND C.EZCANCELFLAG             = '0'
                        AND B.GLBL_CMPY_CD             = D.GLBL_CMPY_CD
                        AND B.SVC_CR_REBIL_DTL_PK      = D.SVC_CR_REBIL_DTL_PK
                        AND D.EZCANCELFLAG             = '0'
                        AND B.GLBL_CMPY_CD             = E.GLBL_CMPY_CD(+)
                        AND B.ORIG_SVC_INV_NUM         = E.CONSL_BILL_TRX_ID(+)
                        AND E.EZCANCELFLAG(+)          = '0'
                        AND D.GLBL_CMPY_CD             = F.GLBL_CMPY_CD
                        AND D.DS_CONTR_DTL_PK          = F.DS_CONTR_DTL_PK
                        AND F.EZCANCELFLAG             = '0'
                        AND F.GLBL_CMPY_CD             = G.GLBL_CMPY_CD
                        AND F.DS_CONTR_PK              = G.DS_CONTR_PK
                        AND G.EZCANCELFLAG             = '0'
                        AND (
                            G.DS_CONTR_CATG_CD = #dsContrCatg_reg#
                            OR  F.DS_CONTR_DTL_TP_CD = #dsContrDtlTp_flt#
                            OR (G.DS_CONTR_CATG_CD = #dsContrCatg_agg# AND F.DS_CONTR_DTL_TP_CD &lt;&gt; #dsContrDtlTp_agg#)
                        )
                        AND D.GLBL_CMPY_CD             = H.GLBL_CMPY_CD
                        AND D.DS_CONTR_ADDL_CHRG_PK    = H.DS_CONTR_ADDL_CHRG_PK
                        AND B.GLBL_CMPY_CD             = I.GLBL_CMPY_CD(+)
                        AND B.PRNT_SVC_CR_REBIL_DTL_PK = I.SVC_CR_REBIL_DTL_PK(+)
                        AND I.EZCANCELFLAG(+)          = '0'
<!-- END 2018/03/27 M.Naito [QC#18672, ADD -->
                )
                GROUP BY
                    ORIG_SVC_INV_NUM
                    ,DS_CONTR_NUM
                    ,CONSL_BILL_PK
                    ,INV_TP_NM
                    ,XX_FROM_DT
                    ,XX_THRU_DT
                    ,XX_CHK_BOX
                    ,REBIL_SVC_INV_NUM
                    ,CR_SVC_INV_NUM
                    ,SVC_CR_REBIL_DTL_PK
                    ,BLLG_PER_FROM_DT
<!-- START 2016/12/06 N.Arai [QC#14204, ADD] -->
                    ,XX_REC_HIST_CRAT_TS
                    ,XX_REC_HIST_CRAT_BY_NM
                    ,XX_REC_HIST_UPD_TS
                    ,XX_REC_HIST_UPD_BY_NM
                    ,XX_REC_HIST_TBL_NM
<!-- END 2016/12/06 N.Arai [QC#14204, ADD] -->
<!-- END 2018/03/27 M.Naito [QC#18672, ADD -->
                    ,SORT_INV_TP_NUM
<!-- END 2018/03/27 M.Naito [QC#18672, ADD -->
                ORDER BY
                     ORIG_SVC_INV_NUM  DESC
                    ,BLLG_PER_FROM_DT  DESC
<!-- START 2018/03/27 M.Naito [QC#18672, MOD -->
                    ,SORT_INV_TP_NUM   ASC
<!-- END 2018/03/27 M.Naito [QC#18672, MOD -->
            )
            WHERE
                ROWNUM        &lt;= #rowNum#
    </statement>

<!-- START 2018/05/31 M.Naito [QC#22908, MOD] -->
    <resultMap id="result.getHeaderInfo"           class="NSAL1090CMsg">
        <result property="svcCrRebilStsDescTxt_H"  column="SVC_CR_REBIL_STS_DESC_TXT" javaType="EZDSStringItem" />
        <result property="svcCrRebilDescTxt_H"     column="SVC_CR_REBIL_DESC_TXT"     javaType="EZDSStringItem" />
        <result property="svcCrRebilProcCd_H"      column="SVC_CR_REBIL_PROC_CD"      javaType="EZDSStringItem" />
        <result property="svcCrRebilPk_H"          column="SVC_CR_REBIL_PK"           javaType="EZDSBigDecimalItem" />
        <result property="svcCrRebilStsCd_H"       column="SVC_CR_REBIL_STS_CD"       javaType="EZDSStringItem" />
        <result property="dsAcctNum_H"             column="DS_ACCT_NUM"               javaType="EZDSStringItem" />
    </resultMap>
<!-- END 2018/05/31 M.Naito [QC#22908, MOD] -->
    <resultMap id="result.getDetailInfo"           class="NSAL1090_ASMsg">
        <result property="xxRowNum_A"              column="XX_ROW_NUM"                javaType="EZDBBigDecimalItem" />
        <result property="origSvcInvNum_A"         column="ORIG_SVC_INV_NUM"          javaType="EZDSStringItem" />
        <result property="dsContrNum_A"            column="DS_CONTR_NUM"              javaType="EZDSStringItem" />
        <result property="conslBillPk_A"           column="CONSL_BILL_PK"             javaType="EZDSBigDecimalItem" />
        <result property="invTpNm_A"               column="INV_TP_NM"                 javaType="EZDSDateItem" />
        <result property="xxFromDt_A"              column="XX_FROM_DT"                javaType="EZDSDateItem" />
        <result property="xxThruDt_A"              column="XX_THRU_DT"                javaType="EZDSDateItem" />
        <result property="xxInvAmt_A1"             column="XX_INV_AMT_A1"             javaType="EZDSBigDecimalItem" />
        <result property="xxInvAmt_A2"             column="XX_INV_AMT_A2"             javaType="EZDSBigDecimalItem" />
        <result property="xxInvAmt_A3"             column="XX_INV_AMT_A3"             javaType="EZDSBigDecimalItem" />
        <result property="xxChkBox_A"              column="XX_CHK_BOX"                javaType="EZDSStringItem" />
        <result property="rebilSvcInvNum_A"        column="REBIL_SVC_INV_NUM"         javaType="EZDSStringItem" />
        <result property="crSvcInvNum_A"           column="CR_SVC_INV_NUM"            javaType="EZDSStringItem" />
        <result property="svcCrRebilDtlPk_A"       column="SVC_CR_REBIL_DTL_PK"       javaType="EZDSBigDecimalItem" />
<!-- START 2016/12/06 N.Arai [QC#14204, ADD] -->
        <result property="xxRecHistCratTs_A"       column="XX_REC_HIST_CRAT_TS"       javaType="EZDSStringItem"/>
        <result property="xxRecHistCratByNm_A"     column="XX_REC_HIST_CRAT_BY_NM"    javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdTs_A"        column="XX_REC_HIST_UPD_TS"        javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdByNm_A"      column="XX_REC_HIST_UPD_BY_NM"     javaType="EZDSStringItem"/>
        <result property="xxRecHistTblNm_A"        column="XX_REC_HIST_TBL_NM"        javaType="EZDSStringItem"/>
<!-- END 2016/12/06 N.Arai [QC#14204, ADD] -->
    </resultMap>

<!-- START 2021/01/12 [QC#58177, ADD] -->
    <statement id="getMaxMtrBllgThruDtFromUsage" parameterClass="Map" resultClass="Map">
            SELECT
                A.DS_CONTR_BLLG_MTR_PK
               ,MAX(MTR_BLLG_THRU_DT) AS MAX_DT
            FROM
                SVC_CR_REBIL_MTR_BLLG   A
               ,SVC_CR_REBIL_DTL B
            WHERE
                A.GLBL_CMPY_CD  = #glblCmpyCd#
            AND A.EZCANCELFLAG  = '0'
            AND A.GLBL_CMPY_CD  = B.GLBL_CMPY_CD
            AND B.EZCANCELFLAG  = '0'
            AND B.CUST_INCDT_ID = #custIncdtId#
            AND A.SVC_CR_REBIL_DTL_PK = B.SVC_CR_REBIL_DTL_PK
            AND EXISTS (
                    SELECT
                        1
                    FROM
                        SVC_CR_REBIL_XS_MTR_BLLG   X
                    WHERE
                            X.GLBL_CMPY_CD  = #glblCmpyCd#
                        AND X.EZCANCELFLAG  = '0'
                        AND X.SVC_CR_REBIL_MTR_BLLG_PK = A.SVC_CR_REBIL_MTR_BLLG_PK
                        AND ((X.OLD_XS_COPY_QTY &lt;&gt; X.NEW_XS_COPY_QTY) OR (X.OLD_XS_MTR_AMT_RATE &lt;&gt; X.NEW_XS_MTR_AMT_RATE))
                )
            GROUP BY A.DS_CONTR_BLLG_MTR_PK
    </statement>
    <statement id="getMaxMtrBllgThruDtFromBase" parameterClass="Map" resultClass="Map">
            SELECT
                DS_CONTR_DTL_PK
               ,MAX(BASE_BLLG_THRU_DT) AS MAX_DT
            FROM
                SVC_CR_REBIL_BASE_BLLG   A
               ,SVC_CR_REBIL_DTL B
            WHERE
                A.GLBL_CMPY_CD        = #glblCmpyCd#
            AND A.EZCANCELFLAG        = '0'
            AND A.GLBL_CMPY_CD        = B.GLBL_CMPY_CD
            AND B.EZCANCELFLAG        = '0'
            AND B.CUST_INCDT_ID       = #custIncdtId#
            AND A.SVC_CR_REBIL_DTL_PK = B.SVC_CR_REBIL_DTL_PK
            AND A.OLD_BASE_UNIT_AMT &lt;&gt; A.NEW_BASE_UNIT_AMT
            GROUP BY DS_CONTR_DTL_PK
    </statement>
    <statement id="checkFuturePrcEffFromUsage" parameterClass="Map" resultClass="BigDecimal">
            SELECT
                COUNT(*) CNT
            FROM
                DS_CONTR_PRC_EFF  Y
            WHERE
                Y.GLBL_CMPY_CD         = #glblCmpyCd#
            AND Y.EZCANCELFLAG         = '0'
            AND Y.DS_CONTR_BLLG_MTR_PK = #dsContrBllgMtrPk#
            AND Y.CONTR_PRC_EFF_THRU_DT &gt; #maxDt#
            AND Y.DS_CONTR_PRC_EFF_STS_CD  IN('ACTV', 'SIGD')
    </statement>
    <statement id="checkFuturePrcEffFromBase" parameterClass="Map" resultClass="BigDecimal">
            SELECT
                COUNT(*) CNT
            FROM
                DS_CONTR_PRC_EFF  Y
            WHERE
                Y.GLBL_CMPY_CD    = #glblCmpyCd#
            AND Y.EZCANCELFLAG    = '0'
            AND Y.BASE_CHRG_FLG   = 'Y'
            AND Y.DS_CONTR_DTL_PK = #dsContrDtlPk#
            AND Y.CONTR_PRC_EFF_THRU_DT &gt; #maxDt#
            AND Y.DS_CONTR_PRC_EFF_STS_CD  IN('ACTV', 'SIGD')
    </statement>
<!-- END 2021/01/12 [QC#58177, ADD] -->

    <!-- START 2023/07/06 t.aizawa [QC#59538,ADD] -->
    <statement id="getInvoiceWithMoreThanOneBillingPeriod" parameterClass="Map" resultClass="Map">
        SELECT
             TBL.CUST_INCDT_ID
            ,TBL.DS_CONTR_PK
            ,TBL.ORIG_SVC_INV_NUM
            ,TBL.SVC_INV_CHRG_TP_NM
            ,TBL.DS_CONTR_DTL_PK
            ,TBL.BLLG_FROM_DT
            ,TBL.BLLG_THRU_DT
        FROM
            (
                SELECT
                     SCR.CUST_INCDT_ID
                    ,SCRD.DS_CONTR_PK
                    ,SCRD.ORIG_SVC_INV_NUM
                    ,SICT.SVC_INV_CHRG_TP_NM
                    ,SCRB.DS_CONTR_DTL_PK
                    ,SCRB.BLLG_FROM_DT
                    ,SCRB.BLLG_THRU_DT
                FROM
                     SVC_CR_REBIL       SCR
                    ,SVC_CR_REBIL_DTL   SCRD
                    ,SVC_INV_CHRG_TP    SICT
                    ,(
                        SELECT
                             SCRBB.SVC_CR_REBIL_DTL_PK
                            ,SCRBB.DS_CONTR_DTL_PK
                            ,NULL                           AS DS_CONTR_BLLG_MTR_PK
                            ,NULL                           AS DS_CONTR_ADDL_CHRG_PK
                            ,NULL                           AS SVC_CONTR_MTR_BLLG_PK
                            ,#svcInvChrgTpBC#               AS CHRG_TP_CD
                            ,MIN(SCRBB.BASE_BLLG_FROM_DT)   AS BLLG_FROM_DT
                            ,MAX(SCRBB.BASE_BLLG_THRU_DT)   AS BLLG_THRU_DT
                        FROM
                            SVC_CR_REBIL_BASE_BLLG SCRBB
                        WHERE
                                SCRBB.GLBL_CMPY_CD          = #glblCmpyCd#
                            AND SCRBB.EZCANCELFLAG          = '0'
                        GROUP BY
                             SCRBB.SVC_CR_REBIL_DTL_PK
                            ,SCRBB.DS_CONTR_DTL_PK
                        HAVING
                            COUNT(*) &gt; 1
                        UNION ALL
                        SELECT
                             SCRMB.SVC_CR_REBIL_DTL_PK
                            ,SCRMB.DS_CONTR_DTL_PK
                            ,SCRMB.DS_CONTR_BLLG_MTR_PK
                            ,NULL                           AS DS_CONTR_ADDL_CHRG_PK
                            ,NULL                           AS SVC_CONTR_MTR_BLLG_PK
                            ,#svcInvChrgTpMC#               AS CHRG_TP_CD
                            ,MIN(SCRMB.MTR_BLLG_FROM_DT)    AS BLLG_FROM_DT
                            ,MAX(SCRMB.MTR_BLLG_THRU_DT)    AS BLLG_THRU_DT
                        FROM
                            SVC_CR_REBIL_MTR_BLLG SCRMB
                        WHERE
                                SCRMB.GLBL_CMPY_CD          = #glblCmpyCd#
                            AND SCRMB.EZCANCELFLAG          = '0'
                        GROUP BY
                             SCRMB.SVC_CR_REBIL_DTL_PK
                            ,SCRMB.DS_CONTR_DTL_PK
                            ,SCRMB.DS_CONTR_BLLG_MTR_PK
                        HAVING
                            COUNT(*) &gt; 1
                        UNION ALL
                        SELECT
                             SCRAB.SVC_CR_REBIL_DTL_PK
                            ,SCRAB.DS_CONTR_DTL_PK
                            ,NULL                           AS DS_CONTR_BLLG_MTR_PK
                            ,SCRAB.DS_CONTR_ADDL_CHRG_PK
                            ,SILAC.SVC_CONTR_MTR_BLLG_PK
                            ,#svcInvChrgTpAC#               AS CHRG_TP_CD
                            ,MIN(SCRAB.ADDL_BLLG_FROM_DT)   AS BLLG_FROM_DT
                            ,MAX(SCRAB.ADDL_BLLG_THRU_DT)   AS BLLG_THRU_DT
                        FROM
                             SVC_CR_REBIL_ADDL_BLLG SCRAB
                            ,SVC_INV_LINE_ADDL_CHRG SILAC
                        WHERE
                                SCRAB.GLBL_CMPY_CD              = #glblCmpyCd#
                            AND SCRAB.EZCANCELFLAG              = '0'
                            AND SILAC.EZCANCELFLAG              = '0'
                            AND SCRAB.GLBL_CMPY_CD              = SILAC.GLBL_CMPY_CD
                            AND SCRAB.SVC_INV_LINE_ADDL_CHRG_PK = SILAC.SVC_INV_LINE_ADDL_CHRG_PK
                        GROUP BY
                             SCRAB.SVC_CR_REBIL_DTL_PK
                            ,SCRAB.DS_CONTR_DTL_PK
                            ,SCRAB.DS_CONTR_ADDL_CHRG_PK
                            ,SILAC.SVC_CONTR_MTR_BLLG_PK
                        HAVING
                            COUNT(*) &gt; 1
                     ) SCRB
                WHERE
                        SCR.GLBL_CMPY_CD            = #glblCmpyCd#
                    AND SCR.CUST_INCDT_ID           = #custIncdtId#
                    AND SCR.EZCANCELFLAG            = '0'
                    AND SCRD.EZCANCELFLAG           = '0'
                    AND SCR.GLBL_CMPY_CD            = SCRD.GLBL_CMPY_CD
                    AND SCR.SVC_CR_REBIL_PK         = SCRD.SVC_CR_REBIL_PK
                    AND SCRD.SVC_CR_REBIL_DTL_PK    = SCRB.SVC_CR_REBIL_DTL_PK
                    AND SCR.GLBL_CMPY_CD            = SICT.GLBL_CMPY_CD
                    AND SCRB.CHRG_TP_CD             = SICT.SVC_INV_CHRG_TP_CD
                ORDER BY
                     SCRB.BLLG_THRU_DT              DESC
                    ,SCRD.ORIG_SVC_INV_NUM          DESC
                    ,SICT.SVC_INV_CHRG_TP_SORT_NUM  ASC
            ) TBL
        WHERE
            ROWNUM &lt;= 1
    </statement>
    <!-- END   2023/07/06 t.aizawa [QC#59538,ADD] -->
</sqlMap>
