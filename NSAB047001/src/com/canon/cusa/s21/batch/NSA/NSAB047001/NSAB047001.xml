<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NSAB047001">

    <statement id="getInsetCfsContract" parameterClass="Map" resultClass="Map">
        SELECT DCD.DS_CONTR_PK
              ,DCD.DS_CONTR_DTL_PK
              ,DC.DS_CONTR_NUM
              ,DC.DS_CONTR_CATG_CD
<!-- START 2016/09/30 N.Arai [QC#12669, MOD] -->
              ,DC.UPLFT_PRC_METH_CD
<!-- END 2016/09/30 N.Arai [QC#12669, MOD] -->
              ,DCD.SVC_MACH_MSTR_PK
              ,DCD.DS_CONTR_DTL_TP_CD
              ,DCD.UPLFT_EFF_FROM_DT
              ,DCDT.BASE_CHRG_FLG
              ,DCDT.USG_CHRG_FLG
              ,DCDT.FLEET_LINE_FLG
              ,SMM2.SER_NUM
              ,SCM2.MDL_ID
              ,MN.T_MDL_NM
              ,CBM2.DS_CONTR_BLLG_MTR_PK
              ,CBM2.BLLG_MTR_LB_CD
              ,CRE.UPLFT_BASE_PRC_UP_RATIO
              ,CRE.UPLFT_MTR_PRC_UP_RATIO
              ,CUT.UPLFT_BASE_FLG
              ,CUT.UPLFT_USG_FLG
              ,GREATEST (DC.EZUPTIME 
                        ,DCD.EZUPTIME
                        ,STC.EZUPTIME
                        ,NVL(SMM1.EZUPTIME,'0')
                        ,NVL(SCM1.EZUPTIME,'0')
                        ,NVL(CBM1.EZUPTIME,'0')
                        ,CRE.EZUPTIME) UPTIME
        FROM   SELL_TO_CUST STC
              ,DS_CONTR DC
              ,DS_CONTR_DTL DCD
              ,DS_CONTR_DTL_TP DCDT
              ,MDL_NM MN
              ,DS_CONTR_RNW_ESCL CRE
              ,CONTR_UPLFT_TP CUT
              ,(SELECT GLBL_CMPY_CD
                      ,SVC_MACH_MSTR_PK
                      ,SVC_CONFIG_MSTR_PK
                      ,EZCANCELFLAG
                      ,EZUPTIME
                FROM   SVC_MACH_MSTR SMM
                WHERE  SMM.GLBL_CMPY_CD = #GLBL_CMPY_CD#
                <isNotNull property="DS_BIZ_LAST_PROC_TS">
                AND    SMM.EZUPTIME &gt; #DS_BIZ_LAST_PROC_TS#
                </isNotNull>
                AND    SMM.EZCANCELFLAG = '0') SMM1
              ,(SELECT GLBL_CMPY_CD
                      ,SVC_MACH_MSTR_PK
                      ,SVC_CONFIG_MSTR_PK
                      ,SER_NUM
                      ,EZCANCELFLAG
                FROM   SVC_MACH_MSTR SMM
                WHERE  SMM.GLBL_CMPY_CD = #GLBL_CMPY_CD#
                AND    SMM.EZCANCELFLAG = '0') SMM2
              ,(SELECT GLBL_CMPY_CD
                      ,SVC_CONFIG_MSTR_PK
                      ,EZCANCELFLAG
                      ,EZUPTIME
                FROM   SVC_CONFIG_MSTR SCM
                WHERE  SCM.GLBL_CMPY_CD = #GLBL_CMPY_CD#
                <isNotNull property="DS_BIZ_LAST_PROC_TS">
                AND    SCM.EZUPTIME &gt; #DS_BIZ_LAST_PROC_TS#
                </isNotNull>
                AND    SCM.EZCANCELFLAG = '0') SCM1
              ,(SELECT GLBL_CMPY_CD
                      ,SVC_CONFIG_MSTR_PK
                      ,MDL_ID
                      ,EZCANCELFLAG
                FROM   SVC_CONFIG_MSTR SCM
                WHERE  SCM.GLBL_CMPY_CD = #GLBL_CMPY_CD#
                AND    SCM.EZCANCELFLAG = '0') SCM2
              ,(SELECT GLBL_CMPY_CD
                      ,DS_CONTR_DTL_PK
                      ,EZCANCELFLAG
                      ,EZUPTIME
                FROM   DS_CONTR_BLLG_MTR CBM
                WHERE  CBM.GLBL_CMPY_CD = #GLBL_CMPY_CD#
                <isNotNull property="DS_BIZ_LAST_PROC_TS">
                AND    CBM.EZUPTIME &gt; #DS_BIZ_LAST_PROC_TS#
                </isNotNull>
                AND    CBM.EZCANCELFLAG = '0') CBM1
              ,(SELECT GLBL_CMPY_CD
                      ,DS_CONTR_DTL_PK
                      ,DS_CONTR_BLLG_MTR_PK
                      ,BLLG_MTR_LB_CD
                      ,EZCANCELFLAG
                FROM   DS_CONTR_BLLG_MTR CBM
                WHERE  CBM.GLBL_CMPY_CD = #GLBL_CMPY_CD#
                AND    CBM.EZCANCELFLAG = '0') CBM2
        WHERE  1 = 1
        AND    STC.GLBL_CMPY_CD = #GLBL_CMPY_CD#
        AND    STC.DS_ACCT_DLR_CD = #DS_ACCT_DLR_CD#
        AND    STC.EZCANCELFLAG = '0'
        AND    STC.GLBL_CMPY_CD = DC.GLBL_CMPY_CD
        AND    STC.SELL_TO_CUST_CD = DC.DS_ACCT_NUM
        AND    DC.EZCANCELFLAG = '0'
        AND    DC.GLBL_CMPY_CD = DCD.GLBL_CMPY_CD
        AND    DC.DS_CONTR_PK = DCD.DS_CONTR_PK
        <iterate property="uplftContrDtlStsCdList" var="uplftContrDtlStsCdList[]" open="AND    DCD.DS_CONTR_DTL_STS_CD IN (" close=")" conjunction=",">
                         #uplftContrDtlStsCdList[]#
        </iterate>
<!-- START 2016/09/30 N.Arai [QC#12669, MOD] -->
        AND    DCD.RNW_EFF_FROM_DT != DCD.UPLFT_EFF_FROM_DT
<!-- END 2016/09/30 N.Arai [QC#12669, MOD] -->
        AND    DCD.EZCANCELFLAG = '0'
        AND    DCD.GLBL_CMPY_CD = DCDT.GLBL_CMPY_CD
        AND    DCD.DS_CONTR_DTL_TP_CD = DCDT.DS_CONTR_DTL_TP_CD
        AND    DCDT.DS_CONTR_DTL_TP_CD &lt;&gt; #dsContrDtlTpCd#
        AND    DCDT.EZCANCELFLAG = '0'
<!-- START 2016/09/30 N.Arai [QC#12669, MOD] -->
        AND    NOT EXISTS(
               SELECT
                   1
               FROM
                   CFS_CONTR_PRC_UPLFT CPU
               WHERE
                       DCD.GLBL_CMPY_CD          = CPU.GLBL_CMPY_CD
                   AND DCD.DS_CONTR_PK           = CPU.DS_CONTR_PK
                   AND DCD.UPLFT_EFF_FROM_DT     = CPU.UPLFT_EFF_FROM_DT
                   AND CPU.EZCANCELFLAG          = '0'
        )
<!-- END 2016/09/30 N.Arai [QC#12669, MOD] -->
        AND    DCD.GLBL_CMPY_CD = SMM1.GLBL_CMPY_CD(+)
        AND    DCD.SVC_MACH_MSTR_PK = SMM1.SVC_MACH_MSTR_PK(+)
        AND    SMM1.EZCANCELFLAG(+) = '0'
        AND    DCD.GLBL_CMPY_CD = SMM2.GLBL_CMPY_CD(+)
        AND    DCD.SVC_MACH_MSTR_PK = SMM2.SVC_MACH_MSTR_PK(+)
        AND    SMM2.EZCANCELFLAG(+) = '0'
        AND    SMM1.GLBL_CMPY_CD = SCM1.GLBL_CMPY_CD(+)
        AND    SMM1.SVC_CONFIG_MSTR_PK = SCM1.SVC_CONFIG_MSTR_PK(+)
        AND    SCM1.EZCANCELFLAG(+) = '0'
        AND    SMM2.GLBL_CMPY_CD = SCM2.GLBL_CMPY_CD(+)
        AND    SMM2.SVC_CONFIG_MSTR_PK = SCM2.SVC_CONFIG_MSTR_PK(+)
        AND    SCM2.EZCANCELFLAG(+) = '0'
        AND    SCM2.GLBL_CMPY_CD = MN.T_GLBL_CMPY_CD(+)
        AND    SCM2.MDL_ID = MN.T_MDL_ID(+)
        AND    MN.EZCANCELFLAG(+) = '0'
        AND    DCD.GLBL_CMPY_CD = CBM1.GLBL_CMPY_CD(+)
        AND    DCD.DS_CONTR_DTL_PK = CBM1.DS_CONTR_DTL_PK(+)
        AND    CBM1.EZCANCELFLAG(+) = '0'
        AND    DCD.GLBL_CMPY_CD = CBM2.GLBL_CMPY_CD(+)
        AND    DCD.DS_CONTR_DTL_PK = CBM2.DS_CONTR_DTL_PK(+)
        AND    CBM2.EZCANCELFLAG(+) = '0'
        AND    DC.GLBL_CMPY_CD = CRE.GLBL_CMPY_CD
        AND    DC.DS_CONTR_PK = CRE.DS_CONTR_PK
        AND    CRE.EZCANCELFLAG = '0'
        AND    CRE.GLBL_CMPY_CD = CUT.GLBL_CMPY_CD
        AND    CRE.CONTR_UPLFT_TP_CD = CUT.CONTR_UPLFT_TP_CD
        AND  ( CUT.UPLFT_BASE_FLG = 'Y'
        OR     CUT.UPLFT_USG_FLG = 'Y' )
        AND    CUT.EZCANCELFLAG = '0'
        <isNotNull property="DS_BIZ_LAST_PROC_TS">
        AND  ( DC.EZUPTIME &gt; #DS_BIZ_LAST_PROC_TS#
        OR     DCD.EZUPTIME &gt; #DS_BIZ_LAST_PROC_TS#
        OR     STC.EZUPTIME &gt; #DS_BIZ_LAST_PROC_TS#
        OR     CRE.EZUPTIME &gt; #DS_BIZ_LAST_PROC_TS# )
        </isNotNull>
        ORDER BY DCD.DS_CONTR_PK
                ,DCD.DS_CONTR_DTL_PK
    </statement>

    <statement id="getBaseUsageInfo" parameterClass="Map" resultClass="Map">
        SELECT BU.UPLFT_BASE_PRC_UP_RATIO
              ,BU.UPLFT_MTR_PRC_UP_RATIO
        FROM  (SELECT
                      ESC.GLBL_CMPY_CD
                     ,ESC.EZUPTIME
                     ,ESC.DS_CONTR_PK
                     ,DCD.DS_CONTR_DTL_PK
                     ,ESC.UPLFT_BASE_PRC_UP_RATIO
                     ,ESC.UPLFT_MTR_PRC_UP_RATIO
                     ,DS_CONTR_MACH_LVL_NUM
                     ,CUP.UPLFT_BASE_FLG
                     ,CUP.UPLFT_USG_FLG
                     ,ESC.DS_CONTR_BASE_USG_NM
                     ,ROW_NUMBER() OVER (ORDER BY ESC.DS_CONTR_MACH_LVL_NUM DESC) AS ROW_NUM
               FROM   DS_CONTR_RNW_ESCL ESC
                     ,DS_CONTR_DTL      DCD
                     ,CONTR_UPLFT_TP    CUP
               WHERE  1 = 1
               AND    ESC.GLBL_CMPY_CD   = #GLBL_CMPY_CD#
               AND    ESC.DS_CONTR_PK    = #DS_CONTR_PK#
               AND    ESC.EZCANCELFLAG   = '0'
               AND    ESC.GLBL_CMPY_CD   = DCD.GLBL_CMPY_CD
               AND    DCD.DS_CONTR_DTL_PK = #DS_CONTR_DTL_PK#
               AND    ESC.DS_CONTR_PK  = DCD.DS_CONTR_PK
               AND    NVL(ESC.DS_CONTR_DTL_PK,DCD.DS_CONTR_DTL_PK) = DCD.DS_CONTR_DTL_PK
               AND    DCD.EZCANCELFLAG = '0'
               AND    ESC.GLBL_CMPY_CD      = CUP.GLBL_CMPY_CD
               AND    ESC.CONTR_UPLFT_TP_CD = CUP.CONTR_UPLFT_TP_CD
               AND    NVL(ESC.DS_CONTR_BASE_USG_NM,#DS_CONTR_BASE_USG_NM#) = #DS_CONTR_BASE_USG_NM#
               <isNotNull property="UPLFT_BASE_FLG">
               AND    CUP.UPLFT_BASE_FLG    = #UPLFT_BASE_FLG#
               </isNotNull>
               <isNotNull property="UPLFT_USG_FLG">
               AND    CUP.UPLFT_USG_FLG     = #UPLFT_USG_FLG#
               </isNotNull>
               AND    CUP.EZCANCELFLAG      = '0'
               ) BU
        WHERE 1 = 1
        AND   BU.ROW_NUM         = #ROW_NUM#
    </statement>

<!-- START 2016/09/30 N.Arai [QC#12669, MOD] -->
    <statement id="getDsMdlEsclRuleForNonFleetBase" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            UPLFT_BASE_PRC_UP_RATIO
        FROM (
            SELECT
                C.UPLFT_BASE_PRC_UP_RATIO
            FROM
                 SVC_MACH_MSTR    A
                ,SVC_CONFIG_MSTR  B
                ,DS_MDL_ESCL_RULE C
            WHERE
                    A.GLBL_CMPY_CD                  = #glblCmpyCd#
                AND A.SVC_MACH_MSTR_PK              = #svcMachMstrPk#
                AND A.EZCANCELFLAG                  = '0'
                AND A.GLBL_CMPY_CD                  = B.GLBL_CMPY_CD
                AND A.SVC_CONFIG_MSTR_PK            = B.SVC_CONFIG_MSTR_PK
                AND B.EZCANCELFLAG                  = '0'
                AND B.GLBL_CMPY_CD                  = C.GLBL_CMPY_CD
                AND B.MDL_ID                        = C.MDL_ID
                AND C.EFF_FROM_DT                   &lt;= #upleftEffFromDt#
<!-- START 2016/10/31 N.Arai [QC#14840, MOD] -->
                AND (C.EFF_THRU_DT                   &gt;= #upleftEffFromDt#
                     OR C.EFF_THRU_DT IS NULL)
<!-- END 2016/10/31 N.Arai [QC#14840, MOD] -->
                AND C.EZCANCELFLAG                  = '0'
            ORDER BY
                C.EFF_THRU_DT DESC
        )
        WHERE
            ROWNUM = #rowCnt#
    </statement>

    <statement id="getPrcUpRatioForNonFleetUsage" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            UPLFT_MTR_PRC_UP_RATIO
        FROM (
            SELECT
                D.UPLFT_MTR_PRC_UP_RATIO
            FROM
                 SVC_MACH_MSTR         A
                ,SVC_CONFIG_MSTR       B
                ,DS_MDL_ESCL_RULE      C
                ,DS_MDL_ESCL_BLLG_MTR  D
            WHERE
                    A.GLBL_CMPY_CD                  = #glblCmpyCd#
                AND A.SVC_MACH_MSTR_PK              = #svcMachMstrPk#
                AND A.EZCANCELFLAG                  = '0'
                AND A.GLBL_CMPY_CD                  = B.GLBL_CMPY_CD
                AND A.SVC_CONFIG_MSTR_PK            = B.SVC_CONFIG_MSTR_PK
                AND B.EZCANCELFLAG                  = '0'
                AND B.GLBL_CMPY_CD                  = C.GLBL_CMPY_CD
                AND B.MDL_ID                        = C.MDL_ID
                AND C.EFF_FROM_DT                   &lt;= #upleftEffFromDt#
<!-- START 2016/10/31 N.Arai [QC#14840, MOD] -->
                AND (C.EFF_THRU_DT                   &gt;= #upleftEffFromDt#
                     OR C.EFF_THRU_DT IS NULL)
<!-- END 2016/10/31 N.Arai [QC#14840, MOD] -->
                AND C.EZCANCELFLAG                  = '0'
                AND C.GLBL_CMPY_CD                  = D.GLBL_CMPY_CD
                AND C.DS_MDL_ESCL_RULE_PK           = D.DS_MDL_ESCL_RULE_PK
                AND D.BLLG_MTR_LB_CD                = #bllgMtrLbCd#
                AND D.EZCANCELFLAG                  = '0'
            ORDER BY
                C.EFF_THRU_DT DESC
        )
        WHERE
            ROWNUM = #rowCnt#
    </statement>

    <statement id="getDsMdlEsclRuleForBase" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            UPLFT_BASE_PRC_UP_RATIO
        FROM (
            SELECT
                A.UPLFT_BASE_PRC_UP_RATIO
            FROM
                DS_MDL_ESCL_RULE A
            WHERE
                    A.GLBL_CMPY_CD                  = #glblCmpyCd#
                AND A.MDL_ID                        = #mdlId#
                AND A.EFF_FROM_DT                   &lt;= #upleftEffFromDt#
<!-- START 2016/10/31 N.Arai [QC#14840, MOD] -->
                AND (A.EFF_THRU_DT                   &gt;= #upleftEffFromDt#
                     OR A.EFF_THRU_DT IS NULL)
<!-- END 2016/10/31 N.Arai [QC#14840, MOD] -->
                AND A.EZCANCELFLAG                  = '0'
            ORDER BY
                A.EFF_THRU_DT DESC
        )
        WHERE
            ROWNUM = #rowCnt#
    </statement>

    <statement id="getPrcUpRatioForUsage" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            UPLFT_MTR_PRC_UP_RATIO
        FROM (
            SELECT
                B.UPLFT_MTR_PRC_UP_RATIO
            FROM
                 DS_MDL_ESCL_RULE      A
                ,DS_MDL_ESCL_BLLG_MTR  B
            WHERE
                    A.GLBL_CMPY_CD                  = #glblCmpyCd#
                AND A.MDL_ID                        = #mdlId#
                AND A.EFF_FROM_DT                   &lt;= #upleftEffFromDt#
<!-- START 2016/10/31 N.Arai [QC#14840, MOD] -->
                AND (A.EFF_THRU_DT                   &gt;= #upleftEffFromDt#
                     OR A.EFF_THRU_DT IS NULL)
<!-- END 2016/10/31 N.Arai [QC#14840, MOD] -->
                AND A.EZCANCELFLAG                  = '0'
                AND A.GLBL_CMPY_CD                  = B.GLBL_CMPY_CD
                AND A.DS_MDL_ESCL_RULE_PK           = B.DS_MDL_ESCL_RULE_PK
                AND B.BLLG_MTR_LB_CD                = #bllgMtrLbCd#
                AND B.EZCANCELFLAG                  = '0'
            ORDER BY
                A.EFF_THRU_DT DESC
        )
        WHERE
            ROWNUM = #rowCnt#
    </statement>
<!-- END 2016/09/30 N.Arai [QC#12669, MOD] -->

</sqlMap>
