<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSZC053001">

    <statement id="WF_CR_REBIL_SQL" parameterClass="Map" resultClass="Map">
        WITH CONTR_HRCH AS ( 
          SELECT
            G.GLBL_CMPY_CD
            , G.SVC_CONTR_BR_CD
            , G.PSN_CD AS PRINCIPAL_CD
            , J.PSN_CD AS BOSS_CD
            <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
            <!-- , I.APVL_LIMIT_AMT -->
            , I.CR_REBIL_APVL_LIMIT_AMT
            <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
            , 'N'      AS AUTO_APVL_FLG
            , ROW_NUMBER() OVER ( 
              PARTITION BY
                G.GLBL_CMPY_CD
                , G.SVC_CONTR_BR_CD
                , G.PSN_CD 
              ORDER BY
                <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
                <!-- I.APVL_LIMIT_AMT -->
                I.CR_REBIL_APVL_LIMIT_AMT
                <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
            ) AS ROW_ID 
          FROM
            SVC_BR_RESRC_RELN G
            INNER JOIN ORG_FUNC_ROLE_TP H
              ON H.GLBL_CMPY_CD         = G.GLBL_CMPY_CD 
              AND H.ORG_FUNC_ROLE_TP_CD = G.SVC_ORG_FUNC_ROLE_TP_CD 
              AND H.ACTV_FLG            = 'Y' 
              AND H.FIRST_ORG_CD        = #condStr4#
              AND H.EZCANCELFLAG        = '0' 
            INNER JOIN ORG_FUNC_ROLE_TP I
              ON I.GLBL_CMPY_CD     = H.GLBL_CMPY_CD 
              <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
              <!-- AND I.APVL_LIMIT_AMT  &gt;= H.APVL_LIMIT_AMT  -->
              AND I.CR_REBIL_APVL_LIMIT_AMT  &gt;= H.CR_REBIL_APVL_LIMIT_AMT 
              <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
              AND I.ACTV_FLG        = 'Y' 
              AND I.FIRST_ORG_CD    = #condStr4#
              AND I.EZCANCELFLAG    = '0' 
            INNER JOIN SVC_BR_RESRC_RELN J
              ON J.GLBL_CMPY_CD             = I.GLBL_CMPY_CD 
              AND J.SVC_ORG_FUNC_ROLE_TP_CD = I.ORG_FUNC_ROLE_TP_CD 
              AND J.SVC_BR_RESRC_ACTV_FLG   = 'Y' 
              AND J.EZCANCELFLAG            = '0' 
              AND J.SVC_CONTR_BR_CD         = G.SVC_CONTR_BR_CD 
              AND ( 
                G.PSN_CD            = J.PSN_CD 
                <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
                <!-- OR H.APVL_LIMIT_AMT &lt;&gt; I.APVL_LIMIT_AMT -->
                OR H.CR_REBIL_APVL_LIMIT_AMT &lt;&gt; I.CR_REBIL_APVL_LIMIT_AMT
                <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
              )
          WHERE
            G.SVC_BR_RESRC_ACTV_FLG = 'Y' 
            AND G.EZCANCELFLAG = '0' 
          ORDER BY
            G.SVC_CONTR_BR_CD
            , G.PSN_CD
            <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
            <!-- , I.APVL_LIMIT_AMT -->
            , I.CR_REBIL_APVL_LIMIT_AMT
            <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
        ) 
        SELECT
          A.SVC_RG_PK as COND_NUM_1
          , C.SVC_CONTR_BR_CD as COND_STR_1
          <!-- START 2018/06/25 K.Kitachi [QC#22336, MOD] -->
          , #condStr2# as COND_STR_2
          <!-- END 2018/06/25 K.Kitachi [QC#22336, MOD] -->
          <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
          <!-- , F.APVL_LIMIT_AMT as COND_NUM_2 -->
          , F.CR_REBIL_APVL_LIMIT_AMT as COND_NUM_2
          <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
          , K.PSN_NUM as VAL_STR_1
        FROM
          SVC_RG A 
          INNER JOIN SVC_RG_BR_RELN B 
            ON B.GLBL_CMPY_CD   = A.GLBL_CMPY_CD 
            AND B.SVC_RG_PK     = A.SVC_RG_PK 
            AND B.EZCANCELFLAG  = '0' 
          INNER JOIN SVC_CONTR_BR C 
            ON C.GLBL_CMPY_CD           = B.GLBL_CMPY_CD 
            AND C.SVC_CONTR_BR_CD       = B.SVC_CONTR_BR_CD 
            AND C.SVC_CONTR_BR_ACTV_FLG = 'Y' 
            AND C.EZCANCELFLAG          = '0' 
          INNER JOIN SVC_BR_RESRC_RELN D 
            ON D.GLBL_CMPY_CD           = C.GLBL_CMPY_CD 
            AND D.SVC_CONTR_BR_CD       = C.SVC_CONTR_BR_CD 
            AND D.SVC_BR_RESRC_ACTV_FLG = 'Y' 
            AND D.EZCANCELFLAG          = '0' 
          INNER JOIN CONTR_HRCH F 
            ON F.GLBL_CMPY_CD       = D.GLBL_CMPY_CD 
            AND F.SVC_CONTR_BR_CD   = D.SVC_CONTR_BR_CD 
            AND F.PRINCIPAL_CD      = D.PSN_CD 
          INNER JOIN S21_PSN K 
            ON K.GLBL_CMPY_CD   = F.GLBL_CMPY_CD 
            AND K.PSN_CD        = F.BOSS_CD 
            AND K.EZCANCELFLAG  = '0' 
        WHERE
          A.SVC_RG_PK           = #condNum1#
          AND C.SVC_CONTR_BR_CD = #condStr1#
          <!-- START 2018/06/22 K.Kitachi [QC#22336, MOD] -->
          <isEqual property="condStr5" compareValue="N">
          AND D.PSN_CD          = #condStr2#
          </isEqual>
          <isEqual property="condStr5" compareValue="Y">
          AND D.PSN_CD          = #condStr3#
          </isEqual>
          <!-- END 2018/06/22 K.Kitachi [QC#22336, MOD] -->
          AND A.SVC_RG_ACTV_FLG = 'Y' 
          AND A.GLBL_CMPY_CD    = #glblCmpyCd#
          AND A.EZCANCELFLAG    = '0'  
          <!-- START 2018/06/21 K.Kitachi [QC#22336, ADD] -->
          <!-- START 2018/08/21 K.Kitachi [QC#27769, MOD] -->
          <!-- AND F.APVL_LIMIT_AMT  &gt;= #condNum2# -->
          <isNotNull property="condNum3">
          <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
          <!-- AND F.APVL_LIMIT_AMT  &gt;= #condNum3# -->
          AND F.CR_REBIL_APVL_LIMIT_AMT  &gt;= #condNum3#
          <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
          </isNotNull>
          <!-- END 2018/08/21 K.Kitachi [QC#27769, ADD] -->
          <!-- END 2018/06/21 K.Kitachi [QC#22336, ADD] -->
        ORDER BY
          A.SVC_RG_PK
          , B.SVC_CONTR_BR_CD
          , D.PSN_CD
          <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
          <!-- , F.APVL_LIMIT_AMT -->
          , F.CR_REBIL_APVL_LIMIT_AMT
          <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
    </statement>

    <statement id="WF_GRP_CR_REBIL_SQL" parameterClass="Map" resultClass="Map">
        SELECT
          'NSWP0003'        AS BIZ_ID
          , 'GRP_CR_REBIL'  AS USER_GROUP_NAME
          , ROW_NUMBER() OVER ( 
            PARTITION BY
              G.GLBL_CMPY_CD
              , G.SVC_CONTR_BR_CD
              , G.PSN_CD 
            ORDER BY
              <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
              <!-- I.APVL_LIMIT_AMT -->
              I.CR_REBIL_APVL_LIMIT_AMT
              <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
          ) AS USER_GROUP_LEVEL
          , J.PSN_CD AS WF_USR_ID 
        FROM
          SVC_BR_RESRC_RELN G
          INNER JOIN ORG_FUNC_ROLE_TP H
            ON H.GLBL_CMPY_CD           = G.GLBL_CMPY_CD 
            AND H.ORG_FUNC_ROLE_TP_CD   = G.SVC_ORG_FUNC_ROLE_TP_CD 
            AND H.ACTV_FLG              = 'Y' 
            AND H.FIRST_ORG_CD          = #condStr4#
            AND H.EZCANCELFLAG          = '0' 
          INNER JOIN ORG_FUNC_ROLE_TP I
            ON I.GLBL_CMPY_CD       = H.GLBL_CMPY_CD 
            <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
            <!-- AND I.APVL_LIMIT_AMT    &gt;= H.APVL_LIMIT_AMT  -->
            AND I.CR_REBIL_APVL_LIMIT_AMT    &gt;= H.CR_REBIL_APVL_LIMIT_AMT 
            <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
            AND I.ACTV_FLG          = 'Y' 
            AND I.FIRST_ORG_CD      = #condStr4#
            AND I.EZCANCELFLAG      = '0' 
          INNER JOIN SVC_BR_RESRC_RELN J
            ON J.GLBL_CMPY_CD               = I.GLBL_CMPY_CD 
            AND J.SVC_ORG_FUNC_ROLE_TP_CD   = I.ORG_FUNC_ROLE_TP_CD 
            AND J.SVC_BR_RESRC_ACTV_FLG     = 'Y' 
            AND J.EZCANCELFLAG              = '0' 
            AND J.SVC_CONTR_BR_CD           = G.SVC_CONTR_BR_CD 
            AND ( 
              G.PSN_CD              = J.PSN_CD 
              <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
              <!-- OR H.APVL_LIMIT_AMT   &lt;&gt; I.APVL_LIMIT_AMT -->
              OR H.CR_REBIL_APVL_LIMIT_AMT   &lt;&gt; I.CR_REBIL_APVL_LIMIT_AMT
              <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
            )
        WHERE
          G.SVC_CONTR_BR_CD             = #condStr1# 
          <!-- START 2018/06/22 K.Kitachi [QC#22336, MOD] -->
          <isEqual property="condStr5" compareValue="N">
          AND G.PSN_CD                  = #condStr2#
          </isEqual>
          <isEqual property="condStr5" compareValue="Y">
          AND G.PSN_CD                  = #condStr3#
          </isEqual>
          <!-- START 2018/08/21 K.Kitachi [QC#27769, MOD] -->
          <!-- AND I.APVL_LIMIT_AMT          &gt;= #condNum2#  -->
          <isNotNull property="condNum3">
          <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
          <!-- AND I.APVL_LIMIT_AMT          &gt;= #condNum3#  -->
          AND I.CR_REBIL_APVL_LIMIT_AMT          &gt;= #condNum3# 
          <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
          </isNotNull>
          <!-- END 2018/08/21 K.Kitachi [QC#27769, ADD] -->
          <!-- END 2018/06/22 K.Kitachi [QC#22336, MOD] -->
          AND G.SVC_BR_RESRC_ACTV_FLG   = 'Y'
          AND G.GLBL_CMPY_CD            = #glblCmpyCd#
          AND G.EZCANCELFLAG            = '0' 
        ORDER BY
          G.SVC_CONTR_BR_CD
          , G.PSN_CD
          <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
          <!-- , I.APVL_LIMIT_AMT -->
          , I.CR_REBIL_APVL_LIMIT_AMT
          <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
    </statement>

    <statement id="WF_GRP_CR_REBIL_REASG_SQL" parameterClass="Map" resultClass="Map">
        SELECT DISTINCT
          'NSWP0003' AS BIZ_ID
          , 'GRP_CRREBL_REASG' AS USER_GROUP_NAME
          , D.PSN_CD AS WF_USR_ID
        FROM
          SVC_BR_RESRC_RELN D 
        WHERE
          D.GLBL_CMPY_CD = #glblCmpyCd# 
          AND D.SVC_BR_RESRC_ACTV_FLG = 'Y' 
          AND D.SVC_ORG_FUNC_ROLE_TP_CD &lt;&gt; '006'
          AND D.EZCANCELFLAG = '0'
    </statement>

    <statement id="WF_GRP_CR_REBIL_MAIL_END_SQL" parameterClass="Map" resultClass="Map">
        SELECT
          'NSWP0003' AS BIZ_ID
          , 'CR_REBIL_ML_END' AS USER_GROUP_NAME
          , #condStr2# AS WF_USR_ID
        FROM
          DUAL
    </statement>

    <statement id="WF_GR_CR_REBIL_AUTO_APVL_USR_SQL" parameterClass="Map" resultClass="Map">
        WITH CONTR_HRCH AS ( 
          SELECT
            G.GLBL_CMPY_CD
            , G.SVC_CONTR_BR_CD
            , G.PSN_CD AS PRINCIPAL_CD
            , J.PSN_CD AS BOSS_CD
            <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
            <!-- , I.APVL_LIMIT_AMT -->
            , I.CR_REBIL_APVL_LIMIT_AMT
            <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
            <!-- START 2018/05/30 K.Kitachi [QC#22336, MOD] -->
            <isEqual property="condStr5" compareValue="N">
            , 'N'      AS AUTO_APVL_FLG
            </isEqual>
            <isEqual property="condStr5" compareValue="Y">
            , CASE WHEN G.PSN_CD = J.PSN_CD THEN 'Y'
              ELSE 'N'
              END AS AUTO_APVL_FLG
            </isEqual>
            <!-- END 2018/05/30 K.Kitachi [QC#22336, MOD] -->
            , ROW_NUMBER() OVER ( 
              PARTITION BY
                G.GLBL_CMPY_CD
                , G.SVC_CONTR_BR_CD
                , G.PSN_CD 
              ORDER BY
                <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
                <!-- I.APVL_LIMIT_AMT -->
                I.CR_REBIL_APVL_LIMIT_AMT
                <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
            ) AS ROW_ID 
          FROM
            SVC_BR_RESRC_RELN G
            INNER JOIN ORG_FUNC_ROLE_TP H
              ON H.GLBL_CMPY_CD         = G.GLBL_CMPY_CD 
              AND H.ORG_FUNC_ROLE_TP_CD = G.SVC_ORG_FUNC_ROLE_TP_CD 
              AND H.ACTV_FLG            = 'Y' 
              AND H.FIRST_ORG_CD        = #condStr4#
              AND H.EZCANCELFLAG        = '0' 
            INNER JOIN ORG_FUNC_ROLE_TP I
              ON I.GLBL_CMPY_CD     = H.GLBL_CMPY_CD 
              <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
              <!-- AND I.APVL_LIMIT_AMT  &gt;= H.APVL_LIMIT_AMT  -->
              AND I.CR_REBIL_APVL_LIMIT_AMT  &gt;= H.CR_REBIL_APVL_LIMIT_AMT 
              <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
              AND I.ACTV_FLG        = 'Y' 
              AND I.FIRST_ORG_CD    = #condStr4#
              AND I.EZCANCELFLAG    = '0' 
            INNER JOIN SVC_BR_RESRC_RELN J
              ON J.GLBL_CMPY_CD             = I.GLBL_CMPY_CD 
              AND J.SVC_ORG_FUNC_ROLE_TP_CD = I.ORG_FUNC_ROLE_TP_CD 
              AND J.SVC_BR_RESRC_ACTV_FLG   = 'Y' 
              AND J.EZCANCELFLAG            = '0' 
              AND J.SVC_CONTR_BR_CD         = G.SVC_CONTR_BR_CD 
              AND ( 
                G.PSN_CD            = J.PSN_CD 
                <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
                <!-- OR H.APVL_LIMIT_AMT &lt;&gt; I.APVL_LIMIT_AMT -->
                OR H.CR_REBIL_APVL_LIMIT_AMT &lt;&gt; I.CR_REBIL_APVL_LIMIT_AMT
                <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
              )
          WHERE
            G.SVC_BR_RESRC_ACTV_FLG = 'Y' 
            AND G.EZCANCELFLAG      = '0' 
          ORDER BY
            G.SVC_CONTR_BR_CD
            , G.PSN_CD
            <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
            <!-- , I.APVL_LIMIT_AMT -->
            , I.CR_REBIL_APVL_LIMIT_AMT
            <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
        ) 
        SELECT
          'NSWP0003'            AS BIZ_ID 
          , 'GRP_CR_REBIL_AT'   AS USER_GROUP_NAME
          , #condStr3#          AS WF_USR_ID
          , CASE WHEN F.AUTO_APVL_FLG = 'Y' THEN F.ROW_ID
            ELSE 0
            END AS USER_GROUP_LEVEL
        FROM
          SVC_RG A 
          INNER JOIN SVC_RG_BR_RELN B 
            ON B.GLBL_CMPY_CD   = A.GLBL_CMPY_CD 
            AND B.SVC_RG_PK     = A.SVC_RG_PK 
            AND B.EZCANCELFLAG  = '0' 
          INNER JOIN SVC_CONTR_BR C 
            ON C.GLBL_CMPY_CD           = B.GLBL_CMPY_CD 
            AND C.SVC_CONTR_BR_CD       = B.SVC_CONTR_BR_CD 
            AND C.SVC_CONTR_BR_ACTV_FLG = 'Y' 
            AND C.EZCANCELFLAG          = '0' 
          INNER JOIN SVC_BR_RESRC_RELN D 
            ON D.GLBL_CMPY_CD           = C.GLBL_CMPY_CD 
            AND D.SVC_CONTR_BR_CD       = C.SVC_CONTR_BR_CD 
            AND D.SVC_BR_RESRC_ACTV_FLG = 'Y' 
            AND D.EZCANCELFLAG          = '0' 
          INNER JOIN CONTR_HRCH F 
            ON F.GLBL_CMPY_CD       = D.GLBL_CMPY_CD 
            AND F.SVC_CONTR_BR_CD   = D.SVC_CONTR_BR_CD 
            AND F.PRINCIPAL_CD      = D.PSN_CD 
            <!-- START 2018/05/30 K.Kitachi [QC#22336, ADD] -->
            <!-- START 2018/08/21 K.Kitachi [QC#27769, MOD] -->
            <!-- AND F.APVL_LIMIT_AMT    &gt;= #condNum2# -->
            <isNotNull property="condNum3">
            <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
            <!-- AND F.APVL_LIMIT_AMT    &gt;= #condNum3# -->
            AND F.CR_REBIL_APVL_LIMIT_AMT    &gt;= #condNum3#
            <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
            </isNotNull>
            <!-- END 2018/08/21 K.Kitachi [QC#27769, MOD] -->
            <!-- END 2018/05/30 K.Kitachi [QC#22336, ADD] -->
        WHERE
          A.SVC_RG_PK           = #condNum1#
          AND C.SVC_CONTR_BR_CD = #condStr1#
          <!-- START 2018/05/30 K.Kitachi [QC#22336, MOD] -->
          <isEqual property="condStr5" compareValue="N">
          AND D.PSN_CD          = #condStr2#
          </isEqual>
          <isEqual property="condStr5" compareValue="Y">
          AND D.PSN_CD          = #condStr3#
          </isEqual>
          <!-- END 2018/05/30 K.Kitachi [QC#22336, MOD] -->
          AND A.SVC_RG_ACTV_FLG = 'Y' 
          AND A.GLBL_CMPY_CD    = #glblCmpyCd#
          AND A.EZCANCELFLAG    = '0'  
        ORDER BY
          A.SVC_RG_PK
          , B.SVC_CONTR_BR_CD
          , D.PSN_CD
            <!-- START 2019/01/17 W.Honda [QC#29889, MOD] -->
            <!-- , F.APVL_LIMIT_AMT -->
          , F.CR_REBIL_APVL_LIMIT_AMT
            <!-- END 2019/01/17 W.Honda [QC#29889, MOD] -->
    </statement>

</sqlMap>
