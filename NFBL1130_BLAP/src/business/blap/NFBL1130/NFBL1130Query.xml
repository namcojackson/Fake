<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NFBL1130Query">

    <typeAlias alias="NFBL1130CMsg" type="business.blap.NFBL1130.NFBL1130CMsg"/>

    <statement id="searchRecord" parameterClass="Map" resultClass="Map">
    WITH TRGT AS (
        SELECT
        <!-- 2019/02/08 QC#30240 ADD START -->
            /*+ USE_NL(M) */
        <!-- 2019/02/08 QC#30240 ADD END -->
            CAWO.GLBL_CMPY_CD
        ,   CAWO.CM_ACRL_WRITE_OFF_PK CM_ACRL_WRITE_OFF_PK
        ,   CAWO.PO_NUM
        ,   CAWO.AP_VND_CD
        ,   CAWO.MDSE_CD
        ,   CAWO.AP_VND_INV_NUM
        ,   CAWO.DELY_ORD_NUM
        ,   CAWO.STK_IN_DT
        ,   PV.PRNT_VND_CD
        ,   PV.DPLY_VND_NM
        ,   CAWO.AP_VND_INV_SQ_NUM
        ,   CASE WHEN CAWO.DR_CR_TP_CD = #crTpCd# THEN 0 ELSE NVL(CAWO.INV_RCV_QTY,0)                 END INV_RCV_QTY
        ,   NVL(CAWO.THIS_MTH_FOB_COST_AMT,0)                                                             THIS_MTH_FOB_COST_AMT
        ,   CASE WHEN CAWO.DR_CR_TP_CD = #crTpCd# THEN 0 ELSE NVL(CAWO.AC_INV_JRNL_COST_AMT,0)        END AC_INV_JRNL_COST_DR_AMT
        ,   CASE WHEN CAWO.DR_CR_TP_CD = #drTpCd# THEN 0 ELSE NVL(CAWO.AC_INV_JRNL_COST_AMT,0)        END AC_INV_JRNL_COST_CR_AMT
        ,   CAWO.COA_ACCT_CD
        ,   M.MDSE_DESC_SHORT_TXT
        ,   CAWO.INV_DT
        ,   CASE WHEN CAWO.DR_CR_TP_CD = #drTpCd# THEN 0 ELSE NVL(CAWO.INV_QTY,0)                     END INV_QTY
        <!-- start 2016/09/28 QC#14130 ADD -->
        ,   CASE WHEN CAWO.DR_CR_TP_CD = #drTpCd# THEN 0 ELSE NVL(CAWO.ENT_DEAL_NET_UNIT_PRC_AMT, 0)  END ENT_DEAL_NET_UNIT_PRC_AMT
        <!-- start 2016/09/28 QC#14130 ADD -->
        <!-- 2019/02/26 QC#30505 ADD START -->
        ,   CASE WHEN CAWO.DR_CR_TP_CD = #crTpCd# THEN 0 ELSE NVL(CAWO.ENT_DEAL_NET_UNIT_PRC_AMT, 0)  END ENT_DEAL_NET_UNIT_PRC_AMT_DR
        <!-- 2019/02/26 QC#30505 ADD end -->
        ,   CAWO.WRT_OFF_FLG
        ,   CAWO.WRT_OFF_DT
        ,   AWOR.ACRL_WRT_OFF_RSN_CD
        ,   CAWO.ACRL_WRT_OFF_CMNT_TXT
        ,   CAWO.PO_ORD_DTL_LINE_NUM
        <!-- START 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        <!-- del start 2022/08/05 QC#59245 -->
        <!--
        ,   CASE WHEN CAWO.DR_CR_TP_CD = #crTpCd# THEN
                    CASE WHEN AP.ENT_DEAL_NET_UNIT_PRC_AMT = PD.ENT_DEAL_NET_UNIT_PRC_AMT THEN AP.ENT_DEAL_NET_UNIT_PRC_AMT
                         ELSE NVL(CAWO.ENT_DEAL_NET_UNIT_PRC_AMT, 0) END
                 ELSE 0 END INV_UNIT_PRC_AMT
        ,   NVL(AP.AC_OC_TOT_INV_AMT, 0)                       AC_OC_TOT_INV_AMT
        -->
        <!-- del end 2022/08/05 QC#59245 -->
        <!-- END 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        <!-- add start 2022/08/05 QC#59245 -->
        ,   CASE WHEN CAWO.DR_CR_TP_CD = #crTpCd# THEN 0 ELSE NVL(CAWO.INV_RCV_QTY, 0) * NVL(CAWO.ENT_DEAL_NET_UNIT_PRC_AMT, 0)
                                                                                                      END RCV_TOT_AMT
        <!-- add end 2022/08/05 QC#59245 -->
        FROM
            CM_ACRL_WRITE_OFF CAWO
        ,   PO_VND_V          PV
        ,   MDSE              M
        ,   ACRL_WRT_OFF_RSN  AWOR
        <!-- START 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        <!-- del start 2022/08/05 QC#59245 -->
        <!-- ,   CM_AP_INV_DTL     AP-->
        <!-- ,   PO_DTL            PD-->
        <!-- del end 2022/08/05 QC#59245 -->
        <!-- END 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        WHERE
            CAWO.GLBL_CMPY_CD        =     #glblCmpyCd#
        <isNotNull property="poNum">
        AND CAWO.PO_NUM              LIKE  #poNum#
        </isNotNull>
        <isNotNull property="delyOrdNum">
        AND CAWO.DELY_ORD_NUM        LIKE  #delyOrdNum#
        </isNotNull>
        <isNotNull property="mdseCd">
        AND CAWO.MDSE_CD             LIKE  #mdseCd#
        </isNotNull>
        <isNotNull property="apVndInvNum">
        AND CAWO.AP_VND_INV_NUM      LIKE  #apVndInvNum#
        </isNotNull>
        <isNotNull property="prntVndCd">
        AND PV.PRNT_VND_CD           LIKE  #prntVndCd#
        </isNotNull>
        <isNotNull property="coaAcctCd">
        AND CAWO.COA_ACCT_CD         LIKE  #coaAcctCd#
        </isNotNull>
        <isNotEqual property="xxChkBox_WO" compareValue="Y">
        AND CAWO.WRT_OFF_FLG         = #wrtOffFlg#
        </isNotEqual>
        <!-- START 2021/03/12 H.Dimay [QC#57040,ADD] -->
        <isNotNull property="coaAcctCdList">
        <iterate property="coaAcctCdList" var="coaAcctCdList[]" open="AND CAWO.COA_ACCT_CD IN (" close=")" conjunction= ", " >
            #coaAcctCdList[]#
        </iterate>
        </isNotNull>
        <!-- END 2021/03/12 H.Dimay [QC#57040,ADD] -->
        AND CAWO.EZCANCELFLAG        = '0'
        AND CAWO.AP_VND_CD           = PV.VND_CD(+)
        AND CAWO.GLBL_CMPY_CD        = M.GLBL_CMPY_CD(+)
        AND CAWO.MDSE_CD             = M.MDSE_CD(+)
        AND '0'                      = M.EZCANCELFLAG(+)
        AND CAWO.GLBL_CMPY_CD        = AWOR.GLBL_CMPY_CD(+)
        AND CAWO.ACRL_WRT_OFF_RSN_CD = AWOR.ACRL_WRT_OFF_RSN_CD(+)
        AND '0'                      = AWOR.EZCANCELFLAG(+)
        <!-- START 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        AND CAWO.AJE_CM_INTFC_TP_CD  IS NULL
        <!-- del start 2022/08/05 QC#59245 -->
        <!--
        AND CAWO.GLBL_CMPY_CD        = AP.GLBL_CMPY_CD(+)
        AND CAWO.AP_VND_INV_NUM      = AP.AP_VND_INV_NUM(+)
        AND CAWO.AP_VND_INV_LINE_NUM = AP.AP_VND_INV_LINE_NUM(+)
        AND '0'                      = AP.EZCANCELFLAG(+)
        AND AP.GLBL_CMPY_CD          = PD.GLBL_CMPY_CD(+)
        AND AP.PO_NUM                = PD.PO_ORD_NUM(+)
        AND AP.PO_ORD_DTL_LINE_NUM   = PD.PO_ORD_DTL_LINE_NUM(+)
        AND '0'                      = PD.EZCANCELFLAG(+)
        -->
        <!-- del end 2022/08/05 QC#59245 -->
        <!-- END 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        <!-- 2019/02/13 QC#30240 DEL START -->
        <!--
        ORDER BY
            CAWO.PO_NUM
        ,   CAWO.AP_VND_CD
        ,   CAWO.MDSE_CD
        -->
        <!-- 2019/02/13 QC#30240 DEL END -->
    ) 
        SELECT 
            WO.GLBL_CMPY_CD
        ,   WO.PO_NUM
        ,   WO.AP_VND_CD
        <!-- del start 2022/03/28 QC#57935(56588) -->
        <!-- ,   WO.MDSE_CD -->
        <!-- del end 2022/03/28 QC#57935(56588) -->
        ,   WO.PO_ORD_DTL_LINE_NUM
        ,   TG.AP_VND_INV_NUM
        ,   TG.DELY_ORD_NUM
        ,   TG.STK_IN_DT
        ,   TG.PRNT_VND_CD
        ,   TG.DPLY_VND_NM
        ,   TG.AP_VND_INV_SQ_NUM
        ,   TG.INV_RCV_QTY
        ,   TG.THIS_MTH_FOB_COST_AMT
        ,   TG.AC_INV_JRNL_COST_DR_AMT
        ,   TG.AC_INV_JRNL_COST_CR_AMT
        ,   TG.COA_ACCT_CD
        <!-- del start 2022/03/28 QC#57935(56588) -->
        <!-- ,   TG.MDSE_DESC_SHORT_TXT -->
        <!-- del end 2022/03/28 QC#57935(56588) -->
        ,   TG.INV_DT
        ,   TG.INV_QTY
        ,   TG.ENT_DEAL_NET_UNIT_PRC_AMT
        <!-- 2019/02/26 QC#30505 ADD START -->
        ,   TG.ENT_DEAL_NET_UNIT_PRC_AMT_DR
        ,   TG.INV_RCV_QTY * ENT_DEAL_NET_UNIT_PRC_AMT_DR   RECEIPT_AMT
        <!-- 2019/02/26 QC#30505 ADD END -->
        ,   TG.WRT_OFF_FLG
        ,   TG.WRT_OFF_DT
        ,   TG.ACRL_WRT_OFF_RSN_CD
        ,   TG.ACRL_WRT_OFF_CMNT_TXT
        <!-- 2019/02/08 QC#30240 DEL START -->
        <!--
        ,   TG.RWS_NUM
        -->
        <!-- 2019/02/08 QC#30240 DEL END -->
        <!-- 2019/02/08 QC#30240 ADD START -->
        ,(
            SELECT
                CASE WHEN MIN(RH.RWS_NUM) &lt;&gt; MAX(RH.RWS_NUM) THEN NULL ELSE MIN(RH.RWS_NUM) END
            FROM
                 CM_ACRL_WRITE_OFF CAWO
                ,INVTY_TRX         IT
                ,RWS_HDR           RH
            WHERE
                TG.GLBL_CMPY_CD = CAWO.GLBL_CMPY_CD
            AND TG.PO_NUM       = CAWO.PO_NUM
            <!-- mod start 2022/03/28 QC#57935(56588) -->
            <!-- AND TG.MDSE_CD      = CAWO.MDSE_CD -->
            AND TG.PO_ORD_DTL_LINE_NUM = CAWO.PO_ORD_DTL_LINE_NUM
            <!-- mod end 2022/03/28 QC#57935(56588) -->
            AND CAWO.GLBL_CMPY_CD = IT.GLBL_CMPY_CD
            AND CAWO.DELY_ORD_NUM = IT.RWS_REF_NUM
            AND CAWO.MDSE_CD      = IT.MDSE_CD
            AND CAWO.STK_IN_DT    = IT.INVTY_TRX_DT
            AND IT.GLBL_CMPY_CD   = RH.GLBL_CMPY_CD
            AND IT.RWS_NUM        = RH.RWS_NUM
            AND CAWO.EZCANCELFLAG = '0'
            AND IT.EZCANCELFLAG   = '0'
            AND RH.EZCANCELFLAG   = '0'
        ) AS RWS_NUM
        <!-- 2019/02/08 QC#30240 ADD END -->
        ,   TI.EZUPTIME
        ,   TI.EZUPTIMEZONE
        <!-- add start 2022/03/28 QC#57935(56588) -->
        ,(
           SELECT
               X.MDSE_CD
           FROM
               PO_DTL X
           WHERE
               X.GLBL_CMPY_CD        = TG.GLBL_CMPY_CD
           AND X.PO_ORD_NUM          = TG.PO_NUM
           AND X.PO_ORD_DTL_LINE_NUM = TG.PO_ORD_DTL_LINE_NUM
           AND X.EZCANCELFLAG        = '0'
         ) AS MDSE_CD
        ,(
           SELECT
               Y.MDSE_DESC_SHORT_TXT
           FROM
                PO_DTL X
               ,MDSE   Y
           WHERE
               X.GLBL_CMPY_CD        = TG.GLBL_CMPY_CD
           AND X.PO_ORD_NUM          = TG.PO_NUM
           AND X.PO_ORD_DTL_LINE_NUM = TG.PO_ORD_DTL_LINE_NUM
           AND X.EZCANCELFLAG        = '0'
           AND X.GLBL_CMPY_CD        = Y.GLBL_CMPY_CD
           AND X.MDSE_CD             = Y.MDSE_CD
           AND Y.EZCANCELFLAG        = '0'
         ) AS MDSE_DESC_SHORT_TXT
        ,(
          SELECT
              MDSE_CD
          FROM
              (
               SELECT
                   X.MDSE_CD
               FROM
                   CM_AP_INV_DTL X
               WHERE
                   X.GLBL_CMPY_CD        = TG.GLBL_CMPY_CD
               AND X.PO_NUM              = TG.PO_NUM
               AND X.PO_ORD_DTL_LINE_NUM = TG.PO_ORD_DTL_LINE_NUM
               AND X.AP_VND_INV_NUM      = TG.AP_VND_INV_NUM
               AND X.EZCANCELFLAG        = '0'
               ORDER BY
                    X.AP_VND_CD
                   ,X.AP_VND_INV_NUM
                   ,X.AP_VND_INV_SQ_NUM
                   ,X.AP_VND_INV_LINE_NUM
              )
          WHERE ROWNUM = 1
         ) AS INV_MDSE_CD
        ,(
          SELECT
              MDSE_DESC_SHORT_TXT
          FROM
              (
               SELECT
                   Y.MDSE_DESC_SHORT_TXT
               FROM
                    CM_AP_INV_DTL X
                   ,MDSE          Y
               WHERE
                   X.GLBL_CMPY_CD        = TG.GLBL_CMPY_CD
               AND X.PO_NUM              = TG.PO_NUM
               AND X.PO_ORD_DTL_LINE_NUM = TG.PO_ORD_DTL_LINE_NUM
               AND X.AP_VND_INV_NUM      = TG.AP_VND_INV_NUM
               AND X.EZCANCELFLAG        = '0'
               AND X.GLBL_CMPY_CD        = Y.GLBL_CMPY_CD
               AND X.MDSE_CD             = Y.MDSE_CD
               AND Y.EZCANCELFLAG        = '0'
               ORDER BY
                    X.AP_VND_CD
                   ,X.AP_VND_INV_NUM
                   ,X.AP_VND_INV_SQ_NUM
                   ,X.AP_VND_INV_LINE_NUM
              )
          WHERE ROWNUM = 1
         ) AS INV_MDSE_DESC_SHORT_TXT
        <!-- START 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        <!-- del start 2022/08/05 QC#59245 -->
        <!-- ,   TG.INV_UNIT_PRC_AMT -->
        <!-- ,   TG.AC_OC_TOT_INV_AMT -->
        <!-- del end 2022/08/05 QC#59245 -->
        ,   ACCT.XX_CMNT_TXT
        <!-- END 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        <!-- add end 2022/03/28 QC#57935(56588) -->
        <!-- add start 2022/08/05 QC#59245 -->
        ,   TG.RCV_TOT_AMT
        <!-- add end 2022/08/05 QC#59245 -->
        FROM
            CM_ACRL_WRITE_OFF      WO
        ,
        (
        SELECT
            TRGT.GLBL_CMPY_CD
        ,   TRGT.PO_NUM
        <!-- del start 2022/03/28 QC#57935(56588) -->
        <!-- ,   TRGT.MDSE_CD -->
        <!-- del end 2022/03/28 QC#57935(56588) -->
        ,   TRGT.PO_ORD_DTL_LINE_NUM
        ,   MAX(TRGT.CM_ACRL_WRITE_OFF_PK)                           CM_ACRL_WRITE_OFF_PK
        ,   MAX(TRGT.AP_VND_INV_NUM)                                 AP_VND_INV_NUM
        ,   MAX(TRGT.DELY_ORD_NUM)                                   DELY_ORD_NUM
        ,   MAX(TRGT.STK_IN_DT)                                      STK_IN_DT
        ,   MAX(TRGT.PRNT_VND_CD)                                    PRNT_VND_CD
        ,   MAX(TRGT.DPLY_VND_NM)                                    DPLY_VND_NM
        ,   MAX(TRGT.AP_VND_INV_SQ_NUM)                              AP_VND_INV_SQ_NUM
        ,   SUM(TRGT.INV_RCV_QTY)                                    INV_RCV_QTY
        ,   MAX(TRGT.THIS_MTH_FOB_COST_AMT)                          THIS_MTH_FOB_COST_AMT
        ,   SUM(TRGT.AC_INV_JRNL_COST_DR_AMT)                        AC_INV_JRNL_COST_DR_AMT
        ,   SUM(TRGT.AC_INV_JRNL_COST_CR_AMT)                        AC_INV_JRNL_COST_CR_AMT
        ,   MAX(TRGT.COA_ACCT_CD)                                    COA_ACCT_CD
        <!-- del start 2022/03/28 QC#57935(56588) -->
        <!-- ,   MAX(TRGT.MDSE_DESC_SHORT_TXT)                            MDSE_DESC_SHORT_TXT -->
        <!-- del end 2022/03/28 QC#57935(56588) -->
        ,   MAX(TRGT.INV_DT)                                         INV_DT
        ,   SUM(TRGT.INV_QTY)                                        INV_QTY
        ,   MAX(TRGT.ENT_DEAL_NET_UNIT_PRC_AMT)                      ENT_DEAL_NET_UNIT_PRC_AMT
        <!-- 2019/02/26 QC#30505 ADD START -->
        ,   MAX(TRGT.ENT_DEAL_NET_UNIT_PRC_AMT_DR)                   ENT_DEAL_NET_UNIT_PRC_AMT_DR
        <!-- 2019/02/26 QC#30505 ADD END -->
        ,   MAX(TRGT.WRT_OFF_FLG)                                    WRT_OFF_FLG
        ,   MAX(TRGT.WRT_OFF_DT)                                     WRT_OFF_DT
        ,   MAX(TRGT.ACRL_WRT_OFF_RSN_CD)                            ACRL_WRT_OFF_RSN_CD
        ,   MAX(TRGT.ACRL_WRT_OFF_CMNT_TXT)                          ACRL_WRT_OFF_CMNT_TXT
        <!-- 2019/02/08 QC#30240 DEL START -->
        <!--
        ,(
            SELECT
                CASE WHEN MIN(RH.RWS_NUM) &lt;&gt; MAX(RH.RWS_NUM) THEN NULL ELSE MIN(RH.RWS_NUM) END
            FROM
                 CM_ACRL_WRITE_OFF CAWO
                ,INVTY_TRX         IT
                ,RWS_HDR           RH
            WHERE
                    TRGT.GLBL_CMPY_CD = CAWO.GLBL_CMPY_CD
                AND TRGT.PO_NUM       = CAWO.PO_NUM
                AND TRGT.MDSE_CD      = CAWO.MDSE_CD
                AND CAWO.GLBL_CMPY_CD = IT.GLBL_CMPY_CD
                AND CAWO.DELY_ORD_NUM = IT.RWS_REF_NUM
                AND CAWO.MDSE_CD      = IT.MDSE_CD
                AND CAWO.STK_IN_DT    = IT.INVTY_TRX_DT
                AND IT.GLBL_CMPY_CD   = RH.GLBL_CMPY_CD
                AND IT.RWS_NUM        = RH.RWS_NUM
                AND CAWO.EZCANCELFLAG = '0'
                AND IT.EZCANCELFLAG   = '0'
                AND RH.EZCANCELFLAG   = '0'
         ) AS RWS_NUM
        -->
        <!-- 2019/02/08 QC#30240 DEL END -->
        <!-- START 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        <!-- del start 2022/08/05 QC#59245 -->
        <!-- ,   MAX(TRGT.INV_UNIT_PRC_AMT)                                   INV_UNIT_PRC_AMT -->
        <!-- ,   MAX(TRGT.AC_OC_TOT_INV_AMT)                                  AC_OC_TOT_INV_AMT -->
        <!-- del end 2022/08/05 QC#59245 -->
        <!-- END 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        <!-- add start 2022/08/05 QC#59245 -->
        ,   SUM(TRGT.RCV_TOT_AMT)                                        RCV_TOT_AMT
        <!-- add end 2022/08/05 QC#59245 -->
        FROM
            TRGT
        WHERE
            TRGT.GLBL_CMPY_CD        =     #glblCmpyCd#
        <isNotNull property="invRcvQty">
        AND TRGT.INV_RCV_QTY         =     #invRcvQty#
        </isNotNull>
        <isNotNull property="invQty">
        AND TRGT.INV_QTY             =     #invQty#
        </isNotNull>
        <!-- 2022/03/18 QC#57935 DEL START -->
        <!-- AND TRGT.INV_DT          &gt;= #invDt_FR# -->
        <!-- AND TRGT.INV_DT          &lt;= #invDt_TO# -->
        <!-- AND TRGT.STK_IN_DT       &gt;= #stkInDt_FR# -->
        <!-- AND TRGT.STK_IN_DT       &lt;= #stkInDt_TO# -->
        <!-- 2022/03/18 QC#57935 DEL END -->
        <isNotNull property="rwsNum">
        AND EXISTS(
                SELECT
                    1
                FROM
                     CM_ACRL_WRITE_OFF CAWO
                    ,INVTY_TRX         IT
                    ,RWS_HDR           RH
                WHERE
                        TRGT.GLBL_CMPY_CD = CAWO.GLBL_CMPY_CD
                    AND TRGT.PO_NUM       = CAWO.PO_NUM
                    <!-- mod start 2022/03/28 QC#57935(56588) -->
                    <!--AND TRGT.MDSE_CD      = CAWO.MDSE_CD -->
                    AND TRGT.PO_ORD_DTL_LINE_NUM = CAWO.PO_ORD_DTL_LINE_NUM
                    <!-- mod end 2022/03/28 QC#57935(56588) -->
                    AND CAWO.GLBL_CMPY_CD = IT.GLBL_CMPY_CD
                    AND CAWO.DELY_ORD_NUM = IT.RWS_REF_NUM
                    AND CAWO.MDSE_CD      = IT.MDSE_CD
                    AND CAWO.STK_IN_DT    = IT.INVTY_TRX_DT
                    AND IT.GLBL_CMPY_CD   = RH.GLBL_CMPY_CD
                    AND IT.RWS_NUM        = RH.RWS_NUM
                    AND RH.RWS_NUM        = #rwsNum#
                    AND CAWO.EZCANCELFLAG = '0'
                    AND IT.EZCANCELFLAG   = '0'
                    AND RH.EZCANCELFLAG   = '0'
            )
        </isNotNull>
        <!-- START 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        HAVING (1=1
        <isNotNull property="invDt_FR">
        AND (MAX(TRGT.INV_DT)          &gt;= #invDt_FR#  OR MAX(TRGT.INV_DT) IS NULL)
        </isNotNull>
        <isNotNull property="invDt_TO">
        AND (MAX(TRGT.INV_DT)          &lt;= #invDt_TO#  OR MAX(TRGT.INV_DT) IS NULL)
        </isNotNull>
        <isNotNull property="stkInDt_FR">
        AND (MAX(TRGT.STK_IN_DT)       &gt;= #stkInDt_FR#  OR MAX(TRGT.STK_IN_DT) IS NULL)
        </isNotNull>
        <isNotNull property="stkInDt_TO">
        AND (MAX(TRGT.STK_IN_DT)       &lt;= #stkInDt_TO#  OR MAX(TRGT.STK_IN_DT) IS NULL)
        </isNotNull>
        <!-- END 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        <isNotEqual property="xxChkBox_PM" compareValue="Y">
        <!-- 2022/03/18 QC#57935 MOD START -->
        <!-- HAVING (SUM(TRGT.INV_QTY) = 0 AND SUM(TRGT.INV_RCV_QTY) = 0) OR (SUM(TRGT.INV_QTY) &lt;&gt; SUM(TRGT.INV_RCV_QTY)) -->
        <!-- START 2022/04/05 R.Onozuka [QC#57935, MOD] -->
        <!-- HAVING (SUM(TRGT.INV_QTY) &lt;&gt; SUM(TRGT.INV_RCV_QTY)) -->
        AND ((SUM(TRGT.INV_QTY) &lt;&gt; SUM(TRGT.INV_RCV_QTY))
        <!-- END 2022/04/05 R.Onozuka [QC#57935, MOD] -->
        <!-- 2022/03/18 QC#57935 MOD END -->
        <!-- START 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        <!-- mod start 2022/08/05 QC#59245 -->
        <!--
        OR 
        (SUM(TRGT.INV_QTY) &lt;&gt; 0 AND SUM(TRGT.INV_RCV_QTY) &lt;&gt; 0 AND (SUM(TRGT.INV_QTY) = SUM(TRGT.INV_RCV_QTY)) 
             AND (MAX(TRGT.AP_VND_INV_NUM) &lt;&gt; '0') AND (MAX(TRGT.ENT_DEAL_NET_UNIT_PRC_AMT_DR) &lt;&gt; MAX(TRGT.INV_UNIT_PRC_AMT)))
             )
        -->
        OR 
        (SUM(TRGT.INV_QTY) &lt;&gt; 0 AND SUM(TRGT.INV_RCV_QTY) &lt;&gt; 0 AND (SUM(TRGT.INV_QTY) = SUM(TRGT.INV_RCV_QTY)) 
             AND SUM(TRGT.AC_INV_JRNL_COST_CR_AMT) &lt;&gt; SUM(TRGT.RCV_TOT_AMT))
             )
        <!-- mod end 2022/08/05 QC#59245 -->
        <!-- END 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        </isNotEqual>
        <!-- add start 2022/08/05 QC#59245 -->
        <isEqual property="xxChkBox_CV" compareValue="Y">
        AND (SUM(TRGT.INV_QTY) &lt;&gt; 0 AND SUM(TRGT.INV_RCV_QTY) &lt;&gt; 0 AND (SUM(TRGT.INV_QTY) = SUM(TRGT.INV_RCV_QTY)) 
             AND SUM(TRGT.AC_INV_JRNL_COST_CR_AMT) &lt;&gt; SUM(TRGT.RCV_TOT_AMT))
        </isEqual>
        <!-- add end 2022/08/05 QC#59245 -->
        <!-- START 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        )
        <!-- END 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        GROUP BY
            TRGT.GLBL_CMPY_CD
        ,   TRGT.PO_NUM
        <!-- del start 2022/03/28 QC#57935(56588) -->
        <!-- ,   TRGT.MDSE_CD -->
        <!-- del end 2022/03/28 QC#57935(56588) -->
        ,   TRGT.PO_ORD_DTL_LINE_NUM
        <!-- START 2020/10/05 A.Marte [QC#57040,ADD] -->
        ,   TRGT.WRT_OFF_DT 
        <!-- END 2020/10/05 A.Marte [QC#57040,ADD] -->
        ) TG
       ,
       (
         SELECT
             EZUPTIME
            ,EZUPTIMEZONE
            ,GLBL_CMPY_CD
            ,PO_NUM
            ,AP_VND_CD
            ,MDSE_CD
            ,PO_ORD_DTL_LINE_NUM
            ,EZCANCELFLAG
            <!-- add start 2022/03/28 QC#57935(56588) -->
            ,WRT_OFF_FLG
            ,WRT_OFF_DT
            <!-- add end 2022/03/28 QC#57935(56588) -->
         FROM
             (SELECT
                 <!-- mod start 2022/03/28 QC#57935(56588) -->
                 <!--  ROW_NUMBER() over(PARTITION by GLBL_CMPY_CD, PO_NUM, AP_VND_CD, MDSE_CD, PO_ORD_DTL_LINE_NUM order by EZUPTIME DESC) as RNUM -->
                  ROW_NUMBER() over(PARTITION by GLBL_CMPY_CD, PO_NUM, PO_ORD_DTL_LINE_NUM, WRT_OFF_FLG, WRT_OFF_DT order by EZUPTIME DESC) as RNUM
                 <!-- mod end 2022/03/28 QC#57935(56588) -->
                 ,EZUPTIME
                 ,EZUPTIMEZONE
                 ,GLBL_CMPY_CD
                 ,PO_NUM
                 ,AP_VND_CD
                 ,MDSE_CD
                 ,PO_ORD_DTL_LINE_NUM
                 ,EZCANCELFLAG
                 <!-- add start 2022/03/28 QC#57935(56588) -->
                 ,WRT_OFF_FLG
                 ,WRT_OFF_DT
                 <!-- add end 2022/03/28 QC#57935(56588) -->
              FROM
                  CM_ACRL_WRITE_OFF
              <!-- add start 2022/03/28 QC#57935(56588) -->
              WHERE
                  EZCANCELFLAG = '0'
              <!-- add end 2022/03/28 QC#57935(56588) -->
             )
         WHERE
             RNUM = 1
        ) TI
       <!-- START 2022/04/05 R.Onozuka [QC#57935, ADD] -->
       ,
       (
         SELECT
             GLBL_CMPY_CD
            ,PO_NUM
            ,PO_ORD_DTL_LINE_NUM
            ,XX_CMNT_TXT
            ,WRT_OFF_DT
            ,EZCANCELFLAG
         FROM
             (SELECT
                  ROW_NUMBER() over(PARTITION by GLBL_CMPY_CD, PO_NUM, PO_ORD_DTL_LINE_NUM order by EZUPTIME DESC) as RNUM
                 ,EZUPTIME
                 ,GLBL_CMPY_CD
                 ,PO_NUM
                 ,PO_ORD_DTL_LINE_NUM
                 ,COA_CMPY_CD || '.' ||
                  COA_BR_CD   || '.' ||
                  COA_CC_CD   || '.' ||
                  COA_ACCT_CD || '.' ||
                  COA_PROD_CD || '.' ||
                  COA_CH_CD   || '.' ||
                  COA_AFFL_CD || '.' ||
                  COA_PROJ_CD || '.' ||
                  COA_EXTN_CD           XX_CMNT_TXT
                 ,WRT_OFF_FLG
                 ,WRT_OFF_DT
                 ,EZCANCELFLAG
              FROM
                  CM_ACRL_WRITE_OFF
              WHERE
                  GLBL_CMPY_CD = #glblCmpyCd#
              AND EZCANCELFLAG = '0'
              AND AJE_CM_INTFC_TP_CD IS NOT NULL
             )
         WHERE
               RNUM        = 1
           AND WRT_OFF_FLG = #wrtOffFlgY#
        ) ACCT
        <!-- END 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        WHERE
            TG.GLBL_CMPY_CD               = WO.GLBL_CMPY_CD
        AND TG.PO_NUM                     = WO.PO_NUM
        AND TG.CM_ACRL_WRITE_OFF_PK       = WO.CM_ACRL_WRITE_OFF_PK
        <!-- del start 2022/03/28 QC#57935(56588) -->
        <!-- AND TG.MDSE_CD                    = WO.MDSE_CD -->
        <!-- del end 2022/03/28 QC#57935(56588) -->
        AND WO.GLBL_CMPY_CD               = TI.GLBL_CMPY_CD
        AND WO.PO_NUM                     = TI.PO_NUM
        <!-- del start 2022/03/28 QC#57935(56588) -->
        <!-- AND WO.AP_VND_CD                  = TI.AP_VND_CD -->
        <!-- AND WO.MDSE_CD                    = TI.MDSE_CD-->
        <!-- del end 2022/03/28 QC#57935(56588) -->
        AND WO.PO_ORD_DTL_LINE_NUM        = TI.PO_ORD_DTL_LINE_NUM
        <!-- add start 2022/03/28 QC#57935(56588) -->
        AND WO.WRT_OFF_FLG                = TI.WRT_OFF_FLG
        AND (   (WO.WRT_OFF_DT            = TI.WRT_OFF_DT)
             OR (WO.WRT_OFF_DT IS NULL AND TI.WRT_OFF_DT IS NULL)
            )
        AND WO.EZCANCELFLAG               = '0'
        <!-- add end 2022/03/28 QC#57935(56588) -->
        AND TI.EZCANCELFLAG               = '0'
        <!-- START 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        AND WO.GLBL_CMPY_CD               = ACCT.GLBL_CMPY_CD(+)
        AND WO.PO_NUM                     = ACCT.PO_NUM(+)
        AND WO.PO_ORD_DTL_LINE_NUM        = ACCT.PO_ORD_DTL_LINE_NUM(+)
        AND WO.WRT_OFF_DT                 = ACCT.WRT_OFF_DT(+)
        AND ACCT.EZCANCELFLAG(+)          = '0'
        <!-- END 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        ORDER BY
            TG.PO_NUM
        ,   WO.PO_ORD_DTL_LINE_NUM
        <!-- mod start 2022/03/28 QC#57935(56588) -->
        <!-- ,   TG.MDSE_CD -->
        ,   TG.STK_IN_DT
        <!-- mod end 2022/03/28 QC#57935(56588) -->
    </statement>

    <statement id="getAcrlCoaAcctCdPulldownValue"  parameterClass="Map" resultClass="Map">
        SELECT 
             B.COA_ACCT_CD
            ,B.COA_ACCT_CD || ':' || B.COA_ACCT_DESC_TXT    XX_DPLY_BY_ITEM_NM
        FROM 
            (   SELECT DISTINCT 
                    A.COA_ACCT_CD
                FROM 
                    COA_PROJ_ACCT A 
                WHERE
                    A.GLBL_CMPY_CD          = #glblCmpyCd#
                AND A.COA_PROJ_ACCT_TP_CD   = #acctTpCdAccrual#
                AND A.EZCANCELFLAG          = '0'
            
                UNION
                SELECT DISTINCT 
                    A.VND_RTRN_COA_ACCT_CD
                FROM 
                    VND A
                WHERE 
                    A.VND_RTRN_COA_ACCT_CD IS NOT NULL
                AND A.GLBL_CMPY_CD          = #glblCmpyCd#
                AND A.EZCANCELFLAG          = '0'
            )           TEMP_A 
           ,COA_ACCT    B
        WHERE 
            B.GLBL_CMPY_CD  = #glblCmpyCd#
        AND B.COA_ACCT_CD   = TEMP_A.COA_ACCT_CD 
        AND B.EZCANCELFLAG  = '0'

        ORDER BY
            B.COA_ACCT_CD ASC
    </statement>
    <!-- END   2017/01/12 [QC#16928,MOD] -->

    <statement id="getAcrlWrtOffRsnPulldownValue"  parameterClass="Map" resultClass="Map">
        SELECT
            AWOR.ACRL_WRT_OFF_RSN_CD
        ,   AWOR.ACRL_WRT_OFF_RSN_NM
        FROM
            ACRL_WRT_OFF_RSN AWOR
        WHERE
            AWOR.GLBL_CMPY_CD      = #glblCmpyCd#
        AND AWOR.EZCANCELFLAG      = '0'
        ORDER BY
            AWOR.ACRL_WRT_OFF_RSN_SORT_NUM ASC
    </statement>

    <statement id="getPrntVndNm"  parameterClass="Map" resultClass="Map">
    SELECT
        A.PRNT_VND_NM
    FROM
        (
        SELECT
            PV.PRNT_VND_NM  AS PRNT_VND_NM
        FROM
            PRNT_VND PV
        WHERE
                PV.GLBL_CMPY_CD      = #glblCmpyCd#
            AND PV.PRNT_VND_CD       = #prntVndCd#
            AND PV.EZCANCELFLAG      = '0'
        ORDER BY
            PV.EZUPTIME DESC
        ) A
    WHERE
        ROWNUM = 1
    </statement>

    <statement id="getCmAcrlWriteOffPkList"  parameterClass="Map" resultClass="Map">
        SELECT
            CAWO.CM_ACRL_WRITE_OFF_PK
        ,   CAWO.EZUPTIME
        ,   CAWO.EZUPTIMEZONE
        FROM
            CM_ACRL_WRITE_OFF CAWO
        WHERE
            CAWO.GLBL_CMPY_CD      = #glblCmpyCd#
        <isNotNull property="poNum">
        AND CAWO.PO_NUM            = #poNum#
        </isNotNull>
        <isNull property="poNum">
        AND CAWO.PO_NUM            IS NULL
        </isNull>
        <!-- del start 2022/03/28 QC#57935(56588) -->
        <!-- <isNotNull property="apVndCd"> -->
        <!-- AND CAWO.AP_VND_CD         = #apVndCd# -->
        <!-- </isNotNull> -->
        <!-- <isNull property="apVndCd"> -->
        <!-- AND CAWO.AP_VND_CD         IS NULL -->
        <!-- </isNull> -->
        <!-- <isNotNull property="mdseCd">) -->
        <!-- AND CAWO.MDSE_CD           = #mdseCd#) -->
        <!-- </isNotNull>) -->
        <!-- <isNull property="mdseCd">) -->
        <!-- AND CAWO.MDSE_CD           IS NULL) -->
        <!-- </isNull>) -->
        <!-- del end 2022/03/28 QC#57935(56588) -->
        <isNotNull property="poOrdDtlLineNum">
        AND CAWO.PO_ORD_DTL_LINE_NUM = #poOrdDtlLineNum#
        </isNotNull>
        <isNull property="poOrdDtlLineNum">
        AND CAWO.PO_ORD_DTL_LINE_NUM IS NULL
        </isNull>
        <!-- add end 2022/03/28 QC#57935(56588) -->
        AND CAWO.WRT_OFF_FLG   = #wrtOffFlg#
        <isNotNull property="wrtOffDt">
        AND CAWO.WRT_OFF_DT    = #wrtOffDt#
        </isNotNull>
        <isNull property="wrtOffDt">
        AND CAWO.WRT_OFF_DT    IS NULL
        </isNull>
        <!-- add end 2022/03/28 QC#57935(56588) -->
        AND CAWO.EZCANCELFLAG      = '0' 
        <!-- START 2022/04/05 R.Onozuka [QC#57935, ADD] -->
        AND CAWO.AJE_CM_INTFC_TP_CD IS NULL
        <!-- END   2022/04/05 R.Onozuka [QC#57935, ADD] -->
    </statement>

    <statement id="getExclusiveData"  parameterClass="Map" resultClass="Map">
        SELECT
            EZUPTIME
           ,EZUPTIMEZONE
        FROM
            (SELECT
                 <!-- mod start 2022/03/28 QC#57935(56588) -->
                 <!-- ROW_NUMBER() over(PARTITION by GLBL_CMPY_CD, PO_NUM, AP_VND_CD, MDSE_CD, PO_ORD_DTL_LINE_NUM order by EZUPTIME DESC) AS RNUM -->
                 ROW_NUMBER() over(PARTITION by GLBL_CMPY_CD, PO_NUM, PO_ORD_DTL_LINE_NUM, WRT_OFF_FLG, WRT_OFF_DT order by EZUPTIME DESC) AS RNUM
                 <!-- mod end 2022/03/28 QC#57935(56588) -->
                ,EZUPTIME
                ,EZUPTIMEZONE
                ,GLBL_CMPY_CD
                ,PO_NUM
                ,AP_VND_CD
                ,MDSE_CD
                ,PO_ORD_DTL_LINE_NUM
                ,EZCANCELFLAG
                <!-- add start 2022/03/28 QC#57935(56588) -->
                ,WRT_OFF_FLG
                ,WRT_OFF_DT
                <!-- add end 2022/03/28 QC#57935(56588) -->
             FROM
                 CM_ACRL_WRITE_OFF
             <!-- add start 2022/03/28 QC#57935(56588) -->
             WHERE
                 EZCANCELFLAG = '0'
             <!-- add end 2022/03/28 QC#57935(56588) -->
           )
        WHERE
            GLBL_CMPY_CD      = #glblCmpyCd#
        <isNotNull property="poNum">
        AND PO_NUM            = #poNum#
        </isNotNull>
        <isNull property="poNum">
        AND PO_NUM            IS NULL
        </isNull>
        <!-- del start 2022/03/28 QC#57935(56588) -->
        <!-- <isNotNull property="apVndCd"> -->
        <!-- AND AP_VND_CD         = #apVndCd# -->
        <!-- </isNotNull> -->
        <!-- <isNull property="apVndCd"> -->
        <!-- AND AP_VND_CD         IS NULL -->
        <!-- </isNull> -->
        <!-- <isNotNull property="mdseCd"> -->
        <!-- AND MDSE_CD           = #mdseCd# -->
        <!-- </isNotNull> -->
        <!-- <isNull property="mdseCd"> -->
        <!-- AND MDSE_CD           IS NULL -->
        <!-- </isNull> -->
        <!-- del end 2022/03/28 QC#57935(56588) -->
        <isNotNull property="poOrdDtlLineNum">
        AND PO_ORD_DTL_LINE_NUM = #poOrdDtlLineNum#
        </isNotNull>
        <isNull property="poOrdDtlLineNum">
        AND PO_ORD_DTL_LINE_NUM IS NULL
        </isNull>
        <!-- add end 2022/03/28 QC#57935(56588) -->
        AND WRT_OFF_FLG   = #wrtOffFlg#
        <isNotNull property="wrtOffDt">
        AND WRT_OFF_DT    = #wrtOffDt#
        </isNotNull>
        <isNull property="wrtOffDt">
        AND WRT_OFF_DT    IS NULL
        </isNull>
        <!-- add end 2022/03/28 QC#57935(56588) -->
        AND EZCANCELFLAG      = '0'
        AND RNUM = 1
    </statement>
    <!-- START 2022/04/05 R.Onozuka [QC#57935, ADD] -->
    <statement id="getDefaultCoaList" parameterClass="Map" resultClass="Map">
    SELECT
        MDSE.COA_CC_CD           AS "ITEM_CC_CD"
       ,MDSE.COA_PROD_CD         AS "ITEM_PROD_CD"
       ,MDSE.COA_MDSE_TP_CD      AS "ITEM_PROJ_CD"
            
    FROM
        MDSE_DLY_SNAP_SHOT MDSE
    WHERE
            MDSE.GLBL_CMPY_CD = #glblCmpyCd#
        AND MDSE.MDSE_CD      = #mdseCd#
        AND MDSE.LTST_REC_FLG = #flgY#
        AND MDSE.EZCANCELFLAG = '0'
    </statement>
    <!-- END 2022/04/05 R.Onozuka [QC#57935, ADD] -->

</sqlMap>