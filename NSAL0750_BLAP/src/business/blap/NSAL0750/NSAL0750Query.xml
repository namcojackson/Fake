<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSAL0750Query">

    <typeAlias alias="NSAL0750SMsg"      type="business.blap.NSAL0750.NSAL0750SMsg"/>
    <typeAlias alias="NSAL0750_ASMsg"    type="business.blap.NSAL0750.NSAL0750_ASMsg"/>

    <statement id="getDSContractDetail" parameterClass="Map" resultMap="result.NSAL0750_ASMsg">
       SELECT
                  ROW_NUMBER() OVER ( 
                      ORDER BY
                           CONTR.DS_CONTR_CATG_CD
                          ,CONTR.DS_CONTR_NUM
                          ,CONTR.SVC_MACH_TP_CD NULLS FIRST
                          ,CONTR.SER_NUM NULLS FIRST) AS ROW_NUM
                 ,CONTR.DS_CONTR_PK
                 ,CONTR.DS_CONTR_CATG_CD
                 ,CONTR.DS_CONTR_NUM
                 ,CONTR.DS_CONTR_CATG_NUM
                 ,CONTR.SVC_MACH_MSTR_PK
                 ,CONTR.SER_NUM
                 ,CONTR.DS_CONTR_CTRL_STS_NM
                 ,CONTR.GLBL_CMPY_CD
                 ,CONTR.DS_CONTR_DTL_PK
                 ,CONTR.CONTR_EFF_FROM_DT
                 ,CONTR.CONTR_EFF_THRU_DT
                 ,CONTR.DS_CONTR_DTL_TP_CD
                 ,CONTR.EZUPTIME
                 ,CONTR.EZUPTIMEZONE
                 ,CONTR.BLLG_TMG_TP_CD
                 ,CONTR.BLLG_TMG_TP_NM
                 ,CONTR.INV_FLG

       FROM
       (
               SELECT
                    DC.DS_CONTR_PK                            AS DS_CONTR_PK
                   ,DC.DS_CONTR_CATG_CD                       AS DS_CONTR_CATG_CD 
                   ,DC.DS_CONTR_NUM                           AS DS_CONTR_NUM
                   ,DC.DS_CONTR_CATG_CD||'-'||DC.DS_CONTR_NUM AS DS_CONTR_CATG_NUM
                   ,NULL                                      AS SVC_MACH_MSTR_PK
                   ,NULL                                      AS SER_NUM
                   ,DCS.DS_CONTR_CTRL_STS_NM                  AS DS_CONTR_CTRL_STS_NM
                   ,DCD.GLBL_CMPY_CD                          AS GLBL_CMPY_CD
                   ,DCD.DS_CONTR_DTL_PK                       AS DS_CONTR_DTL_PK
                   ,DC.CONTR_VRSN_EFF_FROM_DT                 AS CONTR_EFF_FROM_DT
                   ,DC.CONTR_VRSN_EFF_THRU_DT                 AS CONTR_EFF_THRU_DT
                   ,DCD.DS_CONTR_DTL_TP_CD                    AS DS_CONTR_DTL_TP_CD
                   ,DCD.EZUPTIME                              AS EZUPTIME
                   ,DCD.EZUPTIMEZONE                          AS EZUPTIMEZONE
                   ,DCD.BLLG_TMG_TP_CD                        AS BLLG_TMG_TP_CD
                   ,DCD.BLLG_TMG_TP_NM                        AS BLLG_TMG_TP_NM
                   ,(
                       CASE
                           WHEN
                               EXISTS(
                                   SELECT
                                       *
                                   FROM
                                       DS_CONTR_BLLG_SCHD A
                                   WHERE
                                           DCD.GLBL_CMPY_CD    = A.GLBL_CMPY_CD
                                       AND DCD.DS_CONTR_DTL_PK = A.DS_CONTR_DTL_PK
                                       AND A.BASE_CHRG_FLG     = 'Y'
                                       AND A.INV_FLG           = 'Y'
                                       AND A.EZCANCELFLAG      = '0'
                               )
                           THEN
                               'Y'
                           ELSE
                               'N'
                       END
                   ) AS INV_FLG
                   ,NULL                                      AS SVC_MACH_TP_CD

               FROM
                     DS_CONTR DC
                    ,DS_CONTR_STS_V DCS
                    ,(SELECT
                           DCD1.GLBL_CMPY_CD
                          ,DCD1.DS_CONTR_PK
                          ,DCD1.DS_CONTR_DTL_PK
                          ,DCD1.DS_CONTR_DTL_TP_CD
                          ,DCD1.EZUPTIME
                          ,DCD1.EZUPTIMEZONE
                          ,BTT1.BLLG_TMG_TP_CD
                          ,BTT1.BLLG_TMG_TP_NM
                      FROM 
                           DS_CONTR      DC1
                          ,DS_CONTR_DTL  DCD1
                          ,BLLG_TMG_TP   BTT1
                      WHERE
                              DC1.GLBL_CMPY_CD        = #glblCmpyCd#
                          AND DC1.EZCANCELFLAG        = '0'
                          AND DC1.GLBL_CMPY_CD        = DCD1.GLBL_CMPY_CD
                          AND DC1.DS_CONTR_PK         = DCD1.DS_CONTR_PK
                          <iterate property="dsContrDtlTpCdList" var="dsContrDtlTpCdList[]" open="AND DCD1.DS_CONTR_DTL_TP_CD IN (" close=")" conjunction=",">
                              #dsContrDtlTpCdList[]#
                          </iterate>
                          AND DCD1.EZCANCELFLAG       = '0'
                          AND DCD1.GLBL_CMPY_CD       = BTT1.GLBL_CMPY_CD
                          AND DCD1.BASE_BLLG_TMG_CD   = BTT1.BLLG_TMG_TP_CD
                          AND BTT1.EZCANCELFLAG       = '0'
                     ) DCD
               WHERE
                    DC.GLBL_CMPY_CD                          = #glblCmpyCd#
                   <iterate property="dsContrPk" var="dsContrPk[]" open="AND DC.DS_CONTR_PK IN (" close=")" conjunction=",">
                            #dsContrPk[]#
                   </iterate>
                    AND DC.EZCANCELFLAG                      = '0'
                    AND DC.GLBL_CMPY_CD                      = DCS.GLBL_CMPY_CD
                    AND DC.DS_CONTR_PK                       = DCS.DS_CONTR_PK
                    AND DCS.EZCANCELFLAG                     = '0'
                    AND DC.GLBL_CMPY_CD                      = DCD.GLBL_CMPY_CD (+)
                    AND DC.DS_CONTR_PK                       = DCD.DS_CONTR_PK (+)

               UNION ALL

               SELECT
                    DC.DS_CONTR_PK                            AS DS_CONTR_PK
                   ,DC.DS_CONTR_CATG_CD                       AS DS_CONTR_CATG_CD 
                   ,DC.DS_CONTR_NUM                           AS DS_CONTR_NUM
                   ,DC.DS_CONTR_CATG_CD||'-'||DC.DS_CONTR_NUM AS DS_CONTR_CATG_NUM
                   ,SMM.SVC_MACH_MSTR_PK                      AS SVC_MACH_MSTR_PK
                   ,SMM.SER_NUM                               AS SER_NUM
                   ,DCDS.DS_CONTR_CTRL_STS_NM                 AS DS_CONTR_CTRL_STS_NM
                   ,DCD.GLBL_CMPY_CD                          AS GLBL_CMPY_CD
                   ,DCD.DS_CONTR_DTL_PK                       AS DS_CONTR_DTL_PK
                   ,DCD.CONTR_EFF_FROM_DT                     AS CONTR_EFF_FROM_DT
                   ,DCD.CONTR_EFF_THRU_DT                     AS CONTR_EFF_THRU_DT
                   ,DCD.DS_CONTR_DTL_TP_CD                    AS DS_CONTR_DTL_TP_CD
                   ,DCD.EZUPTIME                              AS EZUPTIME
                   ,DCD.EZUPTIMEZONE                          AS EZUPTIMEZONE
                   ,BTT.BLLG_TMG_TP_CD                        AS BLLG_TMG_TP_CD
                   ,BTT.BLLG_TMG_TP_NM                        AS BLLG_TMG_TP_NM
                   ,(
                       CASE
                           WHEN
                               EXISTS(
                                   SELECT
                                       *
                                   FROM
                                       DS_CONTR_BLLG_SCHD A
                                   WHERE
                                           DCD.GLBL_CMPY_CD    = A.GLBL_CMPY_CD
                                       AND DCD.DS_CONTR_DTL_PK = A.DS_CONTR_DTL_PK
                                       AND A.BASE_CHRG_FLG     = 'Y'
                                       AND A.INV_FLG           = 'Y'
                                       AND A.EZCANCELFLAG      = '0'
                               )
                           THEN
                               'Y'
                           ELSE
                               'N'
                       END
                   ) AS INV_FLG
                   ,SMM.SVC_MACH_TP_CD                        AS SVC_MACH_TP_CD

               FROM
                     DS_CONTR DC
                   , DS_CONTR_DTL DCD
                   , SVC_MACH_MSTR SMM  
                   , DS_CONTR_DTL_STS_V DCDS
                   , BLLG_TMG_TP BTT
               WHERE
                   DC.GLBL_CMPY_CD                            = #glblCmpyCd#
                  <iterate property="dsContrPk" var="dsContrPk[]" open="AND DC.DS_CONTR_PK IN (" close=")" conjunction=",">
                            #dsContrPk[]#
                   </iterate>
                   AND DC.EZCANCELFLAG                        = '0'
                   AND DC.GLBL_CMPY_CD                        = DCD.GLBL_CMPY_CD 
                   AND DC.DS_CONTR_PK                         = DCD.DS_CONTR_PK
                   <iterate property="dsContrDtlPk" var="dsContrDtlPk[]" open="AND DCD.DS_CONTR_DTL_PK IN (" close=")" conjunction=",">
                       #dsContrDtlPk[]#
                   </iterate>
                   AND DCD.EZCANCELFLAG                       = '0'
                   AND DCD.GLBL_CMPY_CD                       = SMM.GLBL_CMPY_CD
                   AND DCD.SVC_MACH_MSTR_PK                   = SMM.SVC_MACH_MSTR_PK
                   AND SMM.EZCANCELFLAG                       = '0'
                   AND DCD.GLBL_CMPY_CD                       = DCDS.GLBL_CMPY_CD
                   AND DCD.DS_CONTR_DTL_PK                    = DCDS.DS_CONTR_DTL_PK
                   AND DCDS.EZCANCELFLAG                      = '0'
                   AND DCD.GLBL_CMPY_CD                       = BTT.GLBL_CMPY_CD
                   AND DCD.BASE_BLLG_TMG_CD                   = BTT.BLLG_TMG_TP_CD
                   AND BTT.EZCANCELFLAG                       = '0'
       ) CONTR
        ORDER BY
                CONTR.DS_CONTR_CATG_CD
               ,CONTR.DS_CONTR_NUM
               ,CONTR.SVC_MACH_TP_CD NULLS FIRST
               ,CONTR.SER_NUM NULLS FIRST
     </statement>

    <resultMap id="result.NSAL0750_ASMsg" class="NSAL0750_ASMsg">
        <result property="dsContrPk_D1"           column="DS_CONTR_PK"                javaType="EZDSBigDecimalItem"/>
        <result property="dsContrCatgCd"          column="DS_CONTR_CATG_CD"           javaType="EZDSStringItem"/>
        <result property="xxScrItem34Txt"         column="DS_CONTR_CATG_NUM"          javaType="EZDSStringItem"/>
        <result property="svcMachMstrPk_D1"       column="SVC_MACH_MSTR_PK"           javaType="EZDSBigDecimalItem"/>
        <result property="serNum"                 column="SER_NUM"                    javaType="EZDSStringItem"/>
        <result property="dsContrStsDescTxt"      column="DS_CONTR_CTRL_STS_NM"       javaType="EZDSStringItem"/>
        <result property="glblCmpyCd_D1"          column="GLBL_CMPY_CD"               javaType="EZDSStringItem"/>
        <result property="dsContrDtlPk"           column="DS_CONTR_DTL_PK"            javaType="EZDSBigDecimalItem"/>
        <result property="contrVrsnEffFromDt"     column="CONTR_EFF_FROM_DT"          javaType="EZDSDateItem"/>
        <result property="contrVrsnEffThruDt"     column="CONTR_EFF_THRU_DT"          javaType="EZDSDateItem"/>
        <result property="ezUpTime"               column="EZUPTIME"                   javaType="EZDSStringItem"/>
        <result property="ezUpTimeZone"           column="EZUPTIMEZONE"               javaType="EZDSStringItem"/>
        <result property="bllgTmgTpCd"            column="BLLG_TMG_TP_CD"             javaType="EZDSStringItem"/>
        <result property="bllgTmgTpNm_D1"         column="BLLG_TMG_TP_NM"             javaType="EZDSStringItem"/>
        <result property="invFlg"                 column="INV_FLG"                    javaType="EZDSStringItem"/>
        <result property="xxRowNum_A"             column="ROW_NUM"                    javaType="EZDSBigDecimalItem"/>
    </resultMap>


     <typeAlias alias="SVC_MEMOTMsg" type="business.db.SVC_MEMOTMsg"/>
     <statement id="getSvcMemo" parameterClass="Map" resultMap="result.SVC_MEMOTMsg">
       SELECT
             GLBL_CMPY_CD
             ,SVC_MEMO_PK
       FROM
              SVC_MEMO
       WHERE

             GLBL_CMPY_CD                                  = #glblCmpyCd#
             AND DS_CONTR_PK                               = #dsContractPk#
             AND SVC_MEMO_CATG_CD                          = #contractMemo#
             AND SVC_MEMO_TP_CD                            = #updateTp#
             AND EZCANCELFLAG                              = '0'
    </statement>
    <resultMap id="result.SVC_MEMOTMsg"  class="SVC_MEMOTMsg">
           <result property="glblCmpyCd"    column="GLBL_CMPY_CD"    javaType="EZDTStringItem"/>
           <result property="svcMemoPk"     column="SVC_MEMO_PK"     javaType="EZDTBigDecimalItem"/>
    </resultMap>
    
     <statement id="getContStsV" parameterClass="Map" resultClass="BigDecimal">
      SELECT
           count(*) AS CNT
      FROM
             DS_CONTR_STS_V DCSV
      WHERE

            DCSV.GLBL_CMPY_CD                                  = #glblCmpyCd#
            AND DCSV.DS_CONTR_PK                               = #dsContrPk#
            <iterate property="dsContrStsCd" var="dsContrStsCd[]" open="AND DCSV.DS_CONTR_STS_CD IN (" close=")" conjunction=",">
                #dsContrStsCd[]#
            </iterate>
            AND DCSV.EZCANCELFLAG                              = '0'
   </statement>

   <statement id="getContrDtlStsV" parameterClass="Map" resultClass="BigDecimal">
      SELECT
           count(*) AS CNT
      FROM
             DS_CONTR_DTL_STS_V DCDSV
      WHERE

            DCDSV.GLBL_CMPY_CD                                  = #glblCmpyCd#
            AND DCDSV.DS_CONTR_PK                               = #dsContrPk#
            AND DCDSV.DS_CONTR_DTL_PK                           = #dsContractDtlPk#
            <iterate property="dsContrDtlStsCd" var="dsContrDtlStsCd[]" open="AND DCDSV.DS_CONTR_DTL_STS_CD IN (" close=")" conjunction=",">
                #dsContrDtlStsCd[]#
            </iterate>
            AND DCDSV.EZCANCELFLAG                              = '0'
   </statement>
</sqlMap>
