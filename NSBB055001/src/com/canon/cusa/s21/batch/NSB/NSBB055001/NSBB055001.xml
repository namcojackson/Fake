<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSBB055001">
    <statement id="getFsrVisitHistInfo" parameterClass="Map" resultClass="Map">
<!-- START 2023/03/03 L.Mandanas [CSA#61067, DEL] -->
<!--
        SELECT
             STA.GLBL_CMPY_CD                AS GLBL_CMPY_CD
            ,STA.SER_NUM                     AS SER_NUM
            ,STA.SVC_TASK_NUM                AS SVC_TASK_NUM
            ,STA.MDSE_CD                     AS MDSE_CD
            ,STA.SVC_RSP_TM_MN_AOT           AS SVC_RSP_TM_MN_AOT
            ,FSR.FSR_CRAT_DT                 AS FSR_CRAT_DT
            ,FSR.FSR_CRAT_TM                 AS FSR_CRAT_TM
            ,FVI.FSR_VISIT_ARV_DT            AS FSR_VISIT_ARV_DT
            ,FVI.FSR_VISIT_ARV_TM            AS FSR_VISIT_ARV_TM
            ,FVI.SVC_TRVL_TM_NUM             AS SVC_TRVL_TM_NUM
            ,FVI.FSR_VISIT_ARV_TM            AS FSR_VISIT_ARV_TM
            ,FVI.FSR_VISIT_CLO_DT            AS FSR_VISIT_CLO_DT
            ,FVI.FSR_VISIT_CLO_TM            AS FSR_VISIT_CLO_TM
            ,FVI.TECH_CD                     AS TECH_CD
            ,FVI.PREV_FSR_VISIT_NUM          AS PREV_FSR_VISIT_NUM
            ,FVT.SVC_LBOR_TM_NUM             AS SVC_LBOR_TM_NUM
            ,FVT.SVC_PBLM_CRCT_TP_CD         AS SVC_PBLM_CRCT_TP_CD
            ,FVT.SVC_PBLM_TP_CD              AS SVC_PBLM_TP_CD
            ,FVT.SVC_PBLM_LOC_TP_CD          AS SVC_PBLM_LOC_TP_CD
            ,FVT.SVC_PBLM_RSN_TP_CD          AS SVC_PBLM_RSN_TP_CD
            ,DCT.DS_SVC_CALL_TP_CD           AS DS_SVC_CALL_TP_CD
            ,DCT.DS_SVC_CALL_TP_NM           AS DS_SVC_CALL_TP_NM
            ,DCT.DS_SVC_CALL_TP_DESC_TXT     AS DS_SVC_CALL_TP_DESC_TXT
            ,DCT.SVC_RCLL_FLG                AS SVC_RCLL_FLG
            ,SPT.SVC_PBLM_TP_NM              AS SVC_PBLM_TP_NM
            ,SPT.SVC_PBLM_TP_DESC_TXT        AS SVC_PBLM_TP_DESC_TXT
            ,SPC.SVC_PBLM_CRCT_TP_NM         AS SVC_PBLM_CRCT_TP_NM
            ,SPC.SVC_PBLM_CRCT_TP_DESC_TXT   AS SVC_PBLM_CRCT_TP_DESC_TXT
            ,SPL.SVC_PBLM_LOC_TP_DESC_TXT    AS SVC_PBLM_LOC_TP_DESC_TXT
            ,SPR.SVC_PBLM_RSN_TP_DESC_TXT    AS SVC_PBLM_RSN_TP_DESC_TXT
        FROM
             FSR              FSR
            ,SVC_TASK         STA
            ,FSR_VISIT        FVI
            ,FSR_VISIT_TASK   FVT
            ,DS_SVC_CALL_TP   DCT
            ,SVC_PBLM_TP      SPT
            ,SVC_PBLM_CRCT_TP SPC
            ,SVC_PBLM_LOC_TP  SPL
            ,SVC_PBLM_RSN_TP  SPR
        WHERE
                FSR.GLBL_CMPY_CD         = #glblCmpyCd#
            AND FSR.FSR_NUM              = STA.FSR_NUM
            AND FSR.GLBL_CMPY_CD         = STA.GLBL_CMPY_CD
            AND STA.SVC_TASK_NUM         = FVI.SVC_TASK_NUM
            AND STA.GLBL_CMPY_CD         = FVI.GLBL_CMPY_CD
            AND FVI.FSR_NUM              = FVT.FSR_NUM
            AND FVI.FSR_VISIT_NUM        = FVT.FSR_VISIT_NUM
            AND FVI.GLBL_CMPY_CD         = FVT.GLBL_CMPY_CD
            AND STA.DS_SVC_CALL_TP_CD    = DCT.DS_SVC_CALL_TP_CD
            AND STA.GLBL_CMPY_CD         = DCT.GLBL_CMPY_CD
            AND FVT.SVC_PBLM_TP_CD       = SPT.SVC_PBLM_TP_CD(+)
            AND FVT.GLBL_CMPY_CD         = SPT.GLBL_CMPY_CD(+)
            AND FVT.SVC_PBLM_CRCT_TP_CD  = SPC.SVC_PBLM_CRCT_TP_CD(+)
            AND FVT.GLBL_CMPY_CD         = SPC.GLBL_CMPY_CD(+)
            AND FVT.SVC_PBLM_LOC_TP_CD   = SPL.SVC_PBLM_LOC_TP_CD(+)
            AND FVT.GLBL_CMPY_CD         = SPL.GLBL_CMPY_CD(+)
            AND FVT.SVC_PBLM_RSN_TP_CD   = SPR.SVC_PBLM_RSN_TP_CD(+)
            AND FVT.GLBL_CMPY_CD         = SPR.GLBL_CMPY_CD(+)
            AND FSR.EZCANCELFLAG         = '0'
            AND STA.EZCANCELFLAG         = '0'
            AND FVI.EZCANCELFLAG         = '0'
            AND FVT.EZCANCELFLAG         = '0'
            AND DCT.EZCANCELFLAG         = '0'
            AND SPT.EZCANCELFLAG(+)      = '0'
            AND SPC.EZCANCELFLAG(+)      = '0'
            AND SPL.EZCANCELFLAG(+)      = '0'
            AND SPR.EZCANCELFLAG(+)      = '0'
            AND EXISTS (
                SELECT 
                    1
                FROM
                    FSR_EVENT FEV
                WHERE
                        FEV.GLBL_CMPY_CD        = FVI.GLBL_CMPY_CD
                    AND FEV.FSR_NUM             = FVI.FSR_NUM
                    AND FEV.FSR_VISIT_NUM       = FVI.FSR_VISIT_NUM
                    <iterate property="svcDisptEventCdList" var="svcDisptEventCd[]" open="AND FEV.SVC_DISPT_EVENT_CD IN (" close=")" conjunction=",">
                        #svcDisptEventCd[]#
                    </iterate>
                    AND FEV.EZCANCELFLAG        = '0'
                    AND FEV.FSR_EVENT_EXE_TS &lt;= #procTs#
                    <isNotNull property="dsBizLastProcTs">
                    AND FEV.FSR_EVENT_EXE_TS &gt;  #dsBizLastProcTs#
                    </isNotNull>
            )
        ORDER BY
             SER_NUM                ASC
            ,SVC_TASK_NUM           ASC
-->
<!-- END 2023/03/03 L.Mandanas [CSA#61067, DEL] -->
<!-- START 2023/03/03 L.Mandanas [CSA#61067, ADD] -->
        WITH A AS
        (
            SELECT
                 <!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
                 DISTINCT
<!--                 STK.SER_NUM-->
                  CASE WHEN SMM.SLD_BY_LINE_BIZ_TP_CD = #crsSvcLobCd# and SMM.SVC_BY_LINE_BIZ_TP_CD &lt;&gt; #crsSvcLobCd# and STK.SER_NUM &lt;&gt; SMM.CUST_MACH_CTRL_NUM THEN SMM.CUST_MACH_CTRL_NUM
                       ELSE    STK.SER_NUM 
                  END AS SER_NUM
                 
                 <!-- END 2023/07/06 R.Jin [CSA#61067, MOD] -->
                ,STK.FSR_NUM || #colon# || STK.SVC_TASK_NUM || #hyphen# || FV.FSR_VISIT_NUM               AS SVC_TASK_NUM_AND_FSR_NUM
                ,FV.FSR_VISIT_ARV_DT
                ,FV.FSR_VISIT_ARV_TM
                ,STK.GLBL_CMPY_CD
                ,SMM.MDSE_CD
                ,STK.DS_SVC_CALL_TP_CD
                ,SVCT.DS_SVC_CALL_TP_DESC_TXT
<!-- START 2023/04/18 L.Mandanas [CSA#61067, MOD] -->
<!--                ,FSR.SVC_PBLM_TP_CD             AS SVC_PBLM_TP_CD_01 -->
<!--                ,SVPT.SVC_PBLM_TP_DESC_TXT      AS SVC_PBLM_TP_DESC_TXT_01 -->
                ,FVT.SVC_PBLM_CRCT_TP_CD        AS SVC_PBLM_TP_CD_01
<!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
                ,SPCT.SVC_PBLM_CRCT_TP_DESC_TXT AS SVC_PBLM_TP_DESC_TXT_01
<!--                ,substr(SPCT.SVC_PBLM_CRCT_TP_DESC_TXT,4,500) AS SVC_PBLM_TP_DESC_TXT_01-->
<!-- END 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!-- END 2023/04/18 L.Mandanas [CSA#61067, MOD] -->
<!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!--                ,FSR.SVC_CALL_INCDT_DT -->
<!--                ,FSR.SVC_CALL_INCDT_TM -->
                ,FSR.FSR_CRAT_DT
                ,FSR.FSR_CRAT_TM
<!-- END 2023/07/06 R.Jin [CSA#61067, MOD] -->
                ,FV.FSR_VISIT_CPLT_DT
                ,FV.FSR_VISIT_CPLT_TM
                ,FV.TECH_CD
                ,CASE WHEN FSR.SHIP_TO_CUST_UPD_FLG = #flgY#
                      THEN STC_UPD.CTRY_CD
                      ELSE STC.CTRY_CD
                 END                            AS CTRY_CD
                ,FVT.SVC_PBLM_TP_CD             AS SVC_PBLM_TP_CD_02
                ,SVPT2.SVC_PBLM_TP_DESC_TXT     AS SVC_PBLM_TP_DESC_TXT_02
                ,SVPT.SVC_PBLM_CATG_CD
                ,FVT.SVC_PBLM_LOC_TP_CD         AS SVC_PBLM_LOC_TP_CD
<!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
                ,SPLT.SVC_PBLM_LOC_TP_DESC_TXT
<!--                ,substr(SPLT.SVC_PBLM_LOC_TP_DESC_TXT,6,500) AS SVC_PBLM_LOC_TP_DESC_TXT-->
                ,FVT.SVC_PBLM_RSN_TP_CD
                ,SPRT.SVC_PBLM_RSN_TP_DESC_TXT
<!--                ,substr(SPRT.SVC_PBLM_RSN_TP_DESC_TXT,4,500) AS SVC_PBLM_RSN_TP_DESC_TXT-->
                ,FVT.SVC_PBLM_CRCT_TP_CD
                ,SPCT.SVC_PBLM_CRCT_TP_DESC_TXT
<!--                ,substr(SPCT.SVC_PBLM_CRCT_TP_DESC_TXT,4,500) AS SVC_PBLM_CRCT_TP_DESC_TXT-->
<!-- END 2023/07/06 R.Jin [CSA#61067, MOD] -->
                ,STK.SVC_RSP_TM_NUM
                ,DECODE(STK.DS_SVC_CALL_TP_CD, #dsSvcCallTpCd#, #substringStart#, #substringEnd#)         AS RE_VISIT_FLG
                ,CASE WHEN STK.MACH_DOWN_FLG = #flgY#
                     THEN ROUND((TO_DATE(SVC_TASK_CPLT_DT || SVC_TASK_CPLT_TM, #timedateFormat#)
                         - TO_DATE(SVC_TASK_RCV_DT || SVC_TASK_RCV_TM, #timedateFormat#)) * #minutesDay#)
                     ELSE #int0#
                     END AS SVC_CALL_DOWN_TM_NUM
                ,TO_CHAR(SYSDATE, #dateFormat#) AS CRAT_DT
                ,TO_CHAR(SYSDATE, #timeFormat#) AS CRAT_TM
                ,#ifProcStsCd#                  AS IF_PROC_STS_CD
                ,CASE WHEN FSR.SHIP_TO_CUST_UPD_FLG = #flgY#
                      THEN STC_UPD.POST_CD
                      ELSE STC.POST_CD
                 END                            AS POST_CD
                ,SMM.MTR_GRP_PK
                ,SMM.SVC_MACH_MSTR_PK
                ,STK.SVC_TASK_NUM
                ,FV.SVC_TRVL_TM_NUM
                ,FVT.SVC_LBOR_TM_NUM
                <!-- START 2023/07/06 R.Jin [CSA#61067, ADD] -->
<!--                ,CASE WHEN ROUND((TO_DATE(FVTE.SVC_TM_EVENT_TO_DT || FVTE.SVC_TM_EVENT_TO_TM, 'YYYYMMDDHH24MISS') - TO_DATE(FVTE.SVC_TM_EVENT_FROM_DT || FVTE.SVC_TM_EVENT_FROM_TM, 'YYYYMMDDHH24MISS')) * 1440) &lt; 0 -->
<!--                           THEN 0-->
<!--                      ELSE NVL(ROUND((TO_DATE(FVTE.SVC_TM_EVENT_TO_DT || FVTE.SVC_TM_EVENT_TO_TM, 'YYYYMMDDHH24MISS') - TO_DATE(FVTE.SVC_TM_EVENT_FROM_DT || FVTE.SVC_TM_EVENT_FROM_TM, 'YYYYMMDDHH24MISS')) * 1440),0)-->
<!--                 END AS SVC_MOD_TM_NUM-->
                 ,SUM(
                    CASE WHEN ROUND((TO_DATE(FVTE.SVC_TM_EVENT_TO_DT || FVTE.SVC_TM_EVENT_TO_TM, 'YYYYMMDDHH24MISS') - TO_DATE(FVTE.SVC_TM_EVENT_FROM_DT || FVTE.SVC_TM_EVENT_FROM_TM, 'YYYYMMDDHH24MISS')) * 1440) &lt; 0 
                              THEN 0
                         ELSE NVL(ROUND((TO_DATE(FVTE.SVC_TM_EVENT_TO_DT || FVTE.SVC_TM_EVENT_TO_TM, 'YYYYMMDDHH24MISS') - TO_DATE(FVTE.SVC_TM_EVENT_FROM_DT || FVTE.SVC_TM_EVENT_FROM_TM, 'YYYYMMDDHH24MISS')) * 1440),0)
                    END) OVER(PARTITION BY STK.SVC_TASK_NUM) SVC_MOD_TM_NUM
                <!-- END 2023/07/06 R.Jin [CSA#61067, ADD] -->
            FROM
                 SVC_TASK           STK
                ,FSR_VISIT          FV
                ,SVC_MACH_MSTR      SMM
                ,DS_SVC_CALL_TP     SVCT
                ,FSR                FSR
                ,SVC_PBLM_TP        SVPT
                ,SVC_PBLM_TP        SVPT2
                ,SHIP_TO_CUST       STC
                ,FSR_VISIT_TASK     FVT
                ,SVC_PBLM_LOC_TP    SPLT
                ,SVC_PBLM_RSN_TP    SPRT
                ,SVC_PBLM_CRCT_TP   SPCT
                ,SHIP_TO_CUST       STC_UPD
                <!-- START 2023/07/06 R.Jin [CSA#61067, ADD] -->
                ,S21_PSN            PSN
                ,FSR_VISIT_TM_EVENT  FVTE
                <!-- END 2023/07/06 R.Jin [CSA#61067, ADD] -->
            WHERE
                    STK.GLBL_CMPY_CD            = #glblCmpyCd#
                AND STK.EZCANCELFLAG            = '0'
                AND STK.SVC_TASK_STS_CD         = #svcTaskStsCd#
                AND STK.GLBL_CMPY_CD            = FV.GLBL_CMPY_CD
                AND STK.SVC_TASK_NUM            = FV.SVC_TASK_NUM
                AND FV.EZCANCELFLAG             = '0'
                AND STK.GLBL_CMPY_CD            = SMM.GLBL_CMPY_CD
                AND STK.SVC_MACH_MSTR_PK        = SMM.SVC_MACH_MSTR_PK
                AND SMM.EZCANCELFLAG            = '0'
                AND STK.GLBL_CMPY_CD            = SVCT.GLBL_CMPY_CD
                AND STK.DS_SVC_CALL_TP_CD       = SVCT.DS_SVC_CALL_TP_CD
                AND SVCT.EZCANCELFLAG           = '0'
                AND STK.GLBL_CMPY_CD            = FSR.GLBL_CMPY_CD
                AND STK.FSR_NUM                 = FSR.FSR_NUM
                AND FSR.EZCANCELFLAG            = '0'
                AND FSR.FSR_STS_CD              = #fsrStsCd#
                <!-- START 2023/07/06 R.Jin [CSA#61067, ADD] -->
                AND FSR.FSR_NUM NOT LIKE '1%'
                <!-- END 2023/07/06 R.Jin [CSA#61067, ADD] -->
                <isEqual property="isDaily" compareValue="Y">
<!-- START 2023/04/24 L.Mandanas [CSA#61067, MOD] -->
<!--
                AND FSR.FSR_CLO_DT || FSR.FSR_CLO_TM BETWEEN TO_CHAR(TO_DATE(#slsDt#, #dateFormat#) - 1, #dateFormat#) || #fromTm#
                    AND TO_CHAR(TO_DATE(#slsDt#, #dateFormat#), #dateFormat#) || #toTm# 
-->
                <!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!--                AND FSR.FSR_CLO_DT = TO_CHAR(TO_DATE(#slsDt#, #dateFormat#) - 1, #dateFormat#)-->
                AND FSR.FSR_CLO_DT BETWEEN TO_CHAR(TO_DATE(#slsDt#, #dateFormat#) - #extrDys#,  #dateFormat#) AND TO_CHAR(TO_DATE(#slsDt#, #dateFormat#)-1, #dateFormat#)
                <!-- END 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!-- END 2023/04/24 L.Mandanas [CSA#61067, MOD] -->
                </isEqual>
                <isEqual property="isMonthly" compareValue="Y">
<!-- START 2023/04/24 L.Mandanas [CSA#61067, MOD] -->
<!--                 AND FSR.FSR_CLO_DT || FSR.FSR_CLO_TM BETWEEN #fromDt# || #fromTm# AND #thruDt# || #toTm#  -->
                AND FSR.FSR_CLO_DT BETWEEN #fromDt# AND #thruDt# - 1
<!-- END 2023/04/24 L.Mandanas [CSA#61067, MOD] -->
                </isEqual>
                AND FSR.GLBL_CMPY_CD            = SVPT.GLBL_CMPY_CD
                AND FSR.SVC_PBLM_TP_CD          = SVPT.SVC_PBLM_TP_CD
                AND SVPT.EZCANCELFLAG           = '0'
                AND SMM.GLBL_CMPY_CD            = STC.GLBL_CMPY_CD
                <!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!--                AND SMM.CUR_LOC_NUM             = STC.SHIP_TO_CUST_CD-->
                AND STK.SHIP_TO_CUST_CD     = STC.SHIP_TO_CUST_CD
                <!-- END 2023/07/06 R.Jin [CSA#61067, MOD] -->
                AND STC.EZCANCELFLAG            = '0'
                AND STK.GLBL_CMPY_CD            = FVT.GLBL_CMPY_CD
                AND STK.SVC_TASK_NUM            = FVT.SVC_TASK_NUM
                AND FVT.EZCANCELFLAG            = '0'
                AND FVT.GLBL_CMPY_CD            = SPLT.GLBL_CMPY_CD
                AND FVT.SVC_PBLM_LOC_TP_CD      = SPLT.SVC_PBLM_LOC_TP_CD
                AND SPLT.EZCANCELFLAG           = '0'
                AND FVT.GLBL_CMPY_CD            = SPRT.GLBL_CMPY_CD
                AND FVT.SVC_PBLM_RSN_TP_CD      = SPRT.SVC_PBLM_RSN_TP_CD
                AND SPRT.EZCANCELFLAG           = '0'
                AND FVT.GLBL_CMPY_CD            = SPCT.GLBL_CMPY_CD
                AND FVT.SVC_PBLM_CRCT_TP_CD     = SPCT.SVC_PBLM_CRCT_TP_CD
                AND SPCT.EZCANCELFLAG           = '0'
                AND FVT.GLBL_CMPY_CD            = SVPT2.GLBL_CMPY_CD
                AND FVT.SVC_PBLM_TP_CD          = SVPT2.SVC_PBLM_TP_CD
                AND SVPT2.EZCANCELFLAG          = '0'
                AND FSR.GLBL_CMPY_CD            = STC_UPD.GLBL_CMPY_CD     (+)
                AND FSR.SHIP_TO_UPD_CUST_CD     = STC_UPD.SHIP_TO_CUST_CD  (+)
                AND STC_UPD.EZCANCELFLAG    (+) = '0'
                <!-- START 2023/07/06 R.Jin [CSA#61067, ADD] -->
                AND FV.TECH_CD               &lt;&gt; #crsSvcTechCd#
                AND PSN.PSN_CD                  = FV.TECH_CD 
                AND PSN.GLBL_CMPY_CD            = FV.GLBL_CMPY_CD
                AND PSN.EZCANCELFLAG            = '0'
                AND PSN.PSN_TP_CD           &lt;&gt; #cmpsDelerTp#
                AND STK.SVC_TASK_NUM            = FVTE.SVC_TASK_NUM(+)
                AND FVTE.SVC_TM_EVENT_CD(+)     = '30'
                AND FVTE.EZCANCELFLAG(+)        = '0'
                <!-- END 2023/07/06 R.Jin [CSA#61067, ADD] -->
        )
        ,ADCV_INFO AS (
            SELECT DISTINCT
                 A.SVC_MACH_MSTR_PK
                ,MLB.MTR_LB_CD
                ,MLB.TOT_MTR_FLG
                <!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!--                ,ADCV.AVG_MTR_READ_CNT-->
                ,ADCV.AVG_MTR_READ_CNT*30 AS AVG_MTR_READ_CNT
            FROM
<!--                 SVC_ADCV_BY_SER        ADCV-->
                 FLD_ADCV_BY_SER        ADCV
                 <!-- END 2023/07/06 R.Jin [CSA#61067, MOD] -->
                ,MTR_LB                 MLB
                ,A
            WHERE
                    A.GLBL_CMPY_CD        = ADCV.GLBL_CMPY_CD(+)
                AND A.SVC_MACH_MSTR_PK    = ADCV.SVC_MACH_MSTR_PK(+)
                AND ADCV.EZCANCELFLAG(+)  = '0'
                AND ADCV.GLBL_CMPY_CD     = MLB.GLBL_CMPY_CD(+)
                AND ADCV.MTR_LB_CD        = MLB.MTR_LB_CD(+)
        )
        ,ADCV_CHECK AS (
            SELECT
                 ADCV_INFO.SVC_MACH_MSTR_PK
                ,SUM(CASE WHEN TOT_MTR_FLG = #flgY#
                          THEN #int1#
                          ELSE #int0#
                     END) AS TOT_MTR_CNT
            FROM
                ADCV_INFO
            GROUP BY
                ADCV_INFO.SVC_MACH_MSTR_PK
        )
        ,ADCV AS (
            SELECT DISTINCT
                 A.SVC_MACH_MSTR_PK
                ,SUM(CASE WHEN ADCV_CHECK.TOT_MTR_CNT &gt; #int0#
                               AND ADCV_INFO.TOT_MTR_FLG = #flgN#
                          THEN #int0#
                          ELSE ADCV_INFO.AVG_MTR_READ_CNT
                     END) AS AVG_MTR_READ_CNT
            FROM
                 ADCV_INFO
                ,ADCV_CHECK
                ,A
            WHERE
                    A.SVC_MACH_MSTR_PK = ADCV_CHECK.SVC_MACH_MSTR_PK(+)
                AND A.SVC_MACH_MSTR_PK = ADCV_INFO.SVC_MACH_MSTR_PK(+)
            GROUP BY
                 A.SVC_MACH_MSTR_PK
                ,A.SVC_TASK_NUM
        )
        ,ALL_STK AS (
            SELECT
                ALL_STK_TMP.*
                ,RANK() OVER (
                     PARTITION BY
                         ALL_STK_TMP.SVC_MACH_MSTR_PK
                     ORDER BY
                          ALL_STK_TMP.SVC_TASK_CPLT_DT DESC
                         ,ALL_STK_TMP.SVC_TASK_CPLT_TM DESC
                         ,ALL_STK_TMP.SVC_TASK_NUM DESC
                  ) AS RANK
            FROM (
                SELECT DISTINCT
                     STK.SVC_TASK_NUM
                    ,STK.SVC_MACH_MSTR_PK
                    ,STK.SVC_TASK_CPLT_DT
                    ,STK.SVC_TASK_CPLT_TM
                    ,FVT.SVC_PBLM_TP_CD
                FROM
                    SVC_TASK       STK
                   ,FSR_VISIT_TASK FVT
                   ,A
                WHERE
                        A.GLBL_CMPY_CD       = STK.GLBL_CMPY_CD
                    AND A.SVC_MACH_MSTR_PK   = STK.SVC_MACH_MSTR_PK
                    AND STK.SVC_TASK_STS_CD  = #svcTaskStsCd#
                    AND STK.EZCANCELFLAG     = '0'
                    AND STK.GLBL_CMPY_CD     = FVT.GLBL_CMPY_CD
                    AND STK.SVC_TASK_NUM     = FVT.SVC_TASK_NUM
                    AND FVT.EZCANCELFLAG     = '0'
            ) ALL_STK_TMP
        )
        ,CURRENT_STK AS (
            SELECT
                ALL_STK.SVC_TASK_NUM
               ,ALL_STK.SVC_MACH_MSTR_PK
               ,ALL_STK.SVC_PBLM_TP_CD
               ,ALL_STK.RANK + #int1#    AS RANK
            FROM
                ALL_STK
               ,A
            WHERE
                ALL_STK.SVC_TASK_NUM = A.SVC_TASK_NUM
        )
        ,PREV_STK AS (
            SELECT DISTINCT
                 CURRENT_STK.SVC_TASK_NUM
                ,ALL_STK.SVC_TASK_NUM AS PREV_TASK_NUM
                ,CASE WHEN ALL_STK.SVC_PBLM_TP_CD = CURRENT_STK.SVC_PBLM_TP_CD
                      THEN #substringStart#
                      ELSE #substringEnd#
                 END AS RE_SVC_PBLM_TP_FLG
                ,ALL_STK.SVC_MACH_MSTR_PK
            FROM
                ALL_STK
               ,CURRENT_STK
               ,FSR_VISIT_TASK FVT
            WHERE
                ALL_STK.RANK             = CURRENT_STK.RANK
            AND ALL_STK.SVC_MACH_MSTR_PK = CURRENT_STK.SVC_MACH_MSTR_PK
            AND ALL_STK.SVC_TASK_NUM     = FVT.SVC_TASK_NUM
        )
        SELECT
            A.SER_NUM
           ,A.SVC_TASK_NUM_AND_FSR_NUM
           ,A.FSR_VISIT_ARV_DT           AS FSR_VISIT_ARV_DT_01
           ,A.FSR_VISIT_ARV_TM           AS FSR_VISIT_ARV_TM_01
           ,A.GLBL_CMPY_CD               AS GLBL_CMPY_CD_01
           ,A.MDSE_CD
           ,A.DS_SVC_CALL_TP_CD
           ,A.DS_SVC_CALL_TP_DESC_TXT
           ,A.SVC_PBLM_TP_CD_01
           ,A.SVC_PBLM_TP_DESC_TXT_01
<!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!--       ,A.SVC_CALL_INCDT_DT  -->
<!--       ,A.SVC_CALL_INCDT_TM -->
           ,A.FSR_CRAT_DT
           ,A.FSR_CRAT_TM
<!-- END 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!--           ,CASE WHEN A.SVC_TRVL_TM_NUM > #int9999# THEN #int9999# ELSE A.SVC_TRVL_TM_NUM END AS SVC_TRVL_TM_NUM-->
<!--           ,CASE WHEN A.SVC_LBOR_TM_NUM > #int9999# THEN #int9999# ELSE A.SVC_LBOR_TM_NUM END AS SVC_LBOR_TM_NUM-->
           ,CASE WHEN A.SVC_TRVL_TM_NUM > #int9999# THEN #int9999# WHEN A.SVC_TRVL_TM_NUM &lt; 0 THEN NULL ELSE A.SVC_TRVL_TM_NUM END AS SVC_TRVL_TM_NUM
<!--           ,CASE WHEN A.SVC_LBOR_TM_NUM > #int9999# THEN #int9999# WHEN A.SVC_LBOR_TM_NUM &lt; 0 THEN NULL ELSE A.SVC_LBOR_TM_NUM END AS SVC_LBOR_TM_NUM-->
           ,CASE WHEN (A.SVC_LBOR_TM_NUM + A.SVC_MOD_TM_NUM) &gt; 9999 THEN 9999 WHEN (A.SVC_LBOR_TM_NUM + A.SVC_MOD_TM_NUM) &lt; 0 THEN NULL ELSE (A.SVC_LBOR_TM_NUM + A.SVC_MOD_TM_NUM) END AS SVC_LBOR_TM_NUM
<!-- END 2023/07/06 R.Jin [CSA#61067, MOD] -->
           ,A.FSR_VISIT_ARV_DT           AS FSR_VISIT_ARV_DT_02
           ,A.FSR_VISIT_ARV_TM           AS FSR_VISIT_ARV_TM_02
           ,A.FSR_VISIT_CPLT_DT
           ,A.FSR_VISIT_CPLT_TM
           ,A.TECH_CD
           ,A.CTRY_CD
           ,A.GLBL_CMPY_CD AS GLBL_CMPY_CD_02
           ,ROUND(ADCV.AVG_MTR_READ_CNT) AS AVG_MTR_READ_CNT
<!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
           ,A.SVC_PBLM_TP_CD_02
<!--           ,CASE WHEN  SUBSTR(A.SVC_PBLM_TP_CD_02,1,1) = '0' THEN A.SVC_PBLM_TP_CD_02-->
<!--                 ELSE ''-->
<!--           END AS SVC_PBLM_TP_CD_02-->
<!--           ,A.SVC_PBLM_TP_DESC_TXT_02-->
           ,CASE WHEN A.SVC_PBLM_TP_DESC_TXT_02 = 'ERROR CODE' THEN A.SVC_PBLM_TP_DESC_TXT_02 || ' E' || SUBSTR(A.SVC_PBLM_TP_CD_02,2,4) ELSE A.SVC_PBLM_TP_DESC_TXT_02 END AS SVC_PBLM_TP_DESC_TXT_02
<!--           ,CASE WHEN SUBSTR(A.SVC_PBLM_TP_CD_02,1,1) = '0'  THEN A.SVC_PBLM_TP_DESC_TXT_02 || ' E' || SUBSTR(A.SVC_PBLM_TP_CD_02,2,4)  -->
<!--                 ELSE ''-->
<!--            END AS SVC_PBLM_TP_DESC_TXT_02-->
<!--           ,A.SVC_PBLM_CATG_CD-->
           ,''                           AS SVC_PBLM_CATG_CD
<!-- END 2023/07/06 R.Jin [CSA#61067, MOD] -->
           ,A.SVC_PBLM_LOC_TP_CD         AS SVC_PBLM_LOC_TP_CD_01
           ,A.SVC_PBLM_LOC_TP_DESC_TXT   AS SVC_PBLM_LOC_TP_DESC_TXT_01
           ,A.SVC_PBLM_RSN_TP_CD
           ,A.SVC_PBLM_RSN_TP_DESC_TXT
           ,A.SVC_PBLM_CRCT_TP_CD        AS SVC_PBLM_CRCT_CD
           ,A.SVC_PBLM_CRCT_TP_DESC_TXT  AS SVC_PBLM_CRCT_DESC_TXT
           ,A.SVC_RSP_TM_NUM
           ,A.RE_VISIT_FLG
           ,PREV_STK.RE_SVC_PBLM_TP_FLG
           ,A.SVC_CALL_DOWN_TM_NUM
<!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!--       ,A.GLBL_CMPY_CD   -->
           ,#sndrCmpyCd#                 AS GLBL_CMPY_CD_03
<!-- END 2023/07/06 R.Jin [CSA#61067, MOD] -->
           ,A.CRAT_DT
           ,A.CRAT_TM
           ,A.IF_PROC_STS_CD
           ,A.POST_CD
           ,A.MTR_GRP_PK
           ,A.SVC_MACH_MSTR_PK
           ,A.SVC_TASK_NUM
        FROM
            A
           ,ADCV
           ,PREV_STK
        WHERE
                A.SVC_MACH_MSTR_PK = ADCV.SVC_MACH_MSTR_PK
            AND A.SVC_TASK_NUM     = PREV_STK.SVC_TASK_NUM(+)
        ORDER BY
            A.SER_NUM
           ,A.SVC_TASK_NUM_AND_FSR_NUM
<!-- END 2023/03/03 L.Mandanas [CSA#61067, ADD] -->
    </statement>
<!-- START 2023/03/03 L.Mandanas [CSA#61067, ADD] -->
    <statement id="getCmpsMtrFmla" parameterClass="Map" resultClass="Map">
        SELECT
             CMF.CMPS_MTR_LB_CD
            ,CMF.MTR_FMLA_TP_CD_01
            ,CMF.FMLA_MTR_LB_CD_01
            ,CMF.MTR_FMLA_TP_CD_02
            ,CMF.FMLA_MTR_LB_CD_02
            ,CMF.MTR_FMLA_TP_CD_03
            ,CMF.FMLA_MTR_LB_CD_03
            ,CMF.MTR_FMLA_TP_CD_04
            ,CMF.FMLA_MTR_LB_CD_04
            ,CMF.MTR_FMLA_TP_CD_05
            ,CMF.FMLA_MTR_LB_CD_05
            ,CMF.MTR_FMLA_TP_CD_06
            ,CMF.FMLA_MTR_LB_CD_06
            ,CMF.MTR_FMLA_TP_CD_07
            ,CMF.FMLA_MTR_LB_CD_07
            ,CMF.MTR_FMLA_TP_CD_08
            ,CMF.FMLA_MTR_LB_CD_08
            ,CMF.MTR_FMLA_TP_CD_09
            ,CMF.FMLA_MTR_LB_CD_09
            ,CMF.MTR_FMLA_TP_CD_10
            ,CMF.FMLA_MTR_LB_CD_10
        FROM
             CMPS_MTR_FMLA CMF
        WHERE
                CMF.GLBL_CMPY_CD = #glblCmpyCd#
            AND CMF.MTR_GRP_PK   = #mtrGrpPk#
            AND CMF.EZCANCELFLAG = '0'
    </statement>
    <statement id="getSvcPhysMtrRead" parameterClass="Map" resultClass="Map">
        SELECT
             SPMR.MTR_LB_CD
            ,SPMR.READ_MTR_CNT
        FROM
            SVC_PHYS_MTR_READ SPMR
        WHERE
                SPMR.GLBL_CMPY_CD        = #glblCmpyCd#
            AND SPMR.SVC_MACH_MSTR_PK    = #svcMachMstrPk#
            AND SPMR.SVC_TASK_NUM        = #svcTaskNum#
            AND SPMR.DS_TEST_COPY_CLS_CD = #dsTestCopyClsCd#
            AND SPMR.VLD_MTR_FLG         = #flgY#
            AND SPMR.EZCANCELFLAG        = '0'
    </statement>
<!-- END 2023/03/03 L.Mandanas [CSA#61067, ADD] -->
</sqlMap>
