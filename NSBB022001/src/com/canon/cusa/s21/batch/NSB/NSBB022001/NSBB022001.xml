<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSBB022001">
    <statement id="getInputData" parameterClass="Map" resultClass="Map">
        <!-- START 2019/12/18 K.Kitachi [QC#54692, ADD] -->
        SELECT
             CRS_SVC_CRAT_TS_ORIG_TXT
            ,CRS_SVC_SR_NUM
            ,SVC_CALL_SRC_TP_CD
            ,FSR_STS_CD
            ,MDSE_CD
            ,SER_NUM
            ,SVC_TASK_NUM
            ,DS_COND_CONST_VAL_TXT_01
            ,CRS_SVC_RCV_RQST_STAGE_PK
            ,ONA_JOB_NUM
            ,CRS_SVC_TASK_NUM
            ,ONA_NOTE_ID
            ,CRS_SVC_SR_CMNT_TXT
            ,CRS_SVC_NOTE_TP_TXT
            ,CRS_SVC_NOTE_ID
            ,CRS_SVC_FILE_NM
            ,CRS_SVC_ACT_CD
        FROM (
        <!-- END 2019/12/18 K.Kitachi [QC#54692, ADD] -->
        SELECT
             STG.CRS_SVC_CRAT_TS_ORIG_TXT  AS CRS_SVC_CRAT_TS_ORIG_TXT
            ,STG.CRS_SVC_SR_NUM            AS CRS_SVC_SR_NUM
            ,FSR.SVC_CALL_SRC_TP_CD        AS SVC_CALL_SRC_TP_CD
            ,FSR.FSR_STS_CD                AS FSR_STS_CD
            ,STK.MDSE_CD                   AS MDSE_CD
            ,STK.SER_NUM                   AS SER_NUM
            <!-- START 2019/05/20 [QC#50119, MOD] -->
            <!-- ,STK.FSR_NUM                   AS FSR_NUM -->
            ,STK.SVC_TASK_NUM              AS SVC_TASK_NUM
            <!-- END 2019/05/20 [QC#50119, MOD] -->
            <!-- START 2018/06/14 K.Kim [QC#26559, MOD] -->
            <!-- ,STG.CRS_SVC_TASK_STS_CD       AS CRS_SVC_TASK_STS_CD -->
            ,DCC.DS_COND_CONST_VAL_TXT_01  AS DS_COND_CONST_VAL_TXT_01
            ,STG.CRS_SVC_RCV_RQST_STAGE_PK AS CRS_SVC_RCV_RQST_STAGE_PK
            <!-- END 2018/06/14 K.Kim [QC#26559, MOD] -->
            ,STG.ONA_JOB_NUM               AS ONA_JOB_NUM
            ,STG.CRS_SVC_TASK_NUM          AS CRS_SVC_TASK_NUM
            ,STG.ONA_NOTE_ID               AS ONA_NOTE_ID
            ,STG.CRS_SVC_SR_CMNT_TXT       AS CRS_SVC_SR_CMNT_TXT
            ,STG.CRS_SVC_NOTE_TP_TXT       AS CRS_SVC_NOTE_TP_TXT
            ,STG.CRS_SVC_NOTE_ID           AS CRS_SVC_NOTE_ID
            ,STG.CRS_SVC_FILE_NM           AS CRS_SVC_FILE_NM
            ,STG.CRS_SVC_ACT_CD            AS CRS_SVC_ACT_CD
            <!-- START 2019/12/18 K.Kitachi [QC#54692, ADD] -->
            ,RANK() OVER(PARTITION BY STG.CRS_SVC_SR_NUM ORDER BY STG.CRS_SVC_PROC_TS DESC, STG.EZINTIME DESC, STG.CRS_SVC_RCV_RQST_STAGE_PK DESC
                        ,CASE WHEN STG.CRS_SVC_RQST_SQ_ORIG_TXT IS NULL THEN NULL
                                           ELSE LPAD(STG.CRS_SVC_RQST_SQ_ORIG_TXT, 6, 0) END DESC
            ) AS RANK
            <!-- END 2019/12/18 K.Kitachi [QC#54692, ADD] -->
        FROM
             SVC_TASK                   STK
            ,FSR                        FSR
            ,CRS_SVC_RCV_RQST_STAGE     STG
            <!-- START 2018/06/14 K.Kim [QC#26559, ADD] -->
            ,DS_COND_CONST              DCC
            <!-- END 2018/06/14 K.Kim [QC#26559, ADD] -->
            <!-- START 2018/08/31 [QC#26559-1, ADD] -->
            ,FSR_VISIT                  FV
            <!-- END 2018/08/31 [QC#26559-1, ADD] -->
        WHERE
                STK.GLBL_CMPY_CD        = #glblCmpyCd#
            <iterate property="svcTaskStsCdList" var="svcTaskStsCd[]" open="AND STK.SVC_TASK_STS_CD NOT IN (" close=")" conjunction=",">
                #svcTaskStsCd[]#
            </iterate>
            <!-- add start 2019/04/26 QC#31213 -->
            AND STK.FIRST_SVC_TASK_FLG  = 'Y'
            <!-- add end 2019/04/26 QC#31213 -->
            AND STK.GLBL_CMPY_CD        = FSR.GLBL_CMPY_CD
            AND STK.FSR_NUM             = FSR.FSR_NUM
            AND FSR.SVC_CALL_SRC_TP_CD  = #svcCallSrcTp#
            AND STK.GLBL_CMPY_CD        = STG.GLBL_CMPY_CD
            AND STK.CRS_SVC_SR_NUM      = STG.CRS_SVC_SR_NUM
            <!-- START 2018/06/14 K.Kim [QC#26559, ADD] -->
            AND STK.GLBL_CMPY_CD         = DCC.GLBL_CMPY_CD
            AND DCC.DS_COND_CONST_GRP_ID = #dsCondConstGrpId#
            AND DCC.EZCANCELFLAG         = '0'
            <!-- END 2018/06/14 K.Kim [QC#26559, ADD] -->
            <!-- START 2018/08/31 [QC#26559-1, ADD] -->
            AND STK.GLBL_CMPY_CD        = FV.GLBL_CMPY_CD
            AND STK.SVC_TASK_NUM        = FV.SVC_TASK_NUM
            AND FV.FSR_VISIT_STS_CD     = DCC.DS_COND_CONST_CD
            AND FV.EZCANCELFLAG         = '0'
            <!-- END 2018/08/31 [QC#26559-1, ADD] -->
            AND STK.EZCANCELFLAG        = '0'
            AND FSR.EZCANCELFLAG        = '0'
            AND STG.EZCANCELFLAG        = '0'
            AND (EXISTS (
                SELECT
                    1
                FROM
                     FSR_EVENT                  FET
                    ,FSR_VISIT                  FVT
                WHERE 
                        STK.GLBL_CMPY_CD        = FET.GLBL_CMPY_CD
                    AND STK.SVC_TASK_NUM        = FET.SVC_TASK_NUM
                    AND STK.FSR_NUM             = FET.FSR_NUM
                    AND STK.GLBL_CMPY_CD        = FVT.GLBL_CMPY_CD
                    AND STK.SVC_TASK_NUM        = FVT.SVC_TASK_NUM
                    <!-- START 2019/08/12 [QC#51271,MOD] -->
                    <!-- <iterate property="svcDisptEventCdList" var="svcDisptEventCd[]" open="AND FET.SVC_DISPT_EVENT_CD NOT IN (" close=")" conjunction=","> -->
                    <!-- #svcDisptEventCd[]#           -->
                    <!-- </iterate>                    -->
                    AND FET.SVC_DISPT_EVENT_CD  &lt;&gt; #svcDisptEventCd#
                    <!-- END 2019/08/12 [QC#51271,MOD] -->
                    <isNotNull property="lastUpdTs">
                    AND (
                           STK.EZUPTIME      &gt; #lastUpdTs#
                        OR FVT.EZUPTIME      &gt; #lastUpdTs#
                        OR FSR.EZUPTIME      &gt; #lastUpdTs# )
                    </isNotNull>
                    AND FVT.EZCANCELFLAG        = '0'
                    AND FET.EZCANCELFLAG        = '0')
            OR EXISTS (
                SELECT
                    1
                FROM
                    SVC_MEMO                  SMO
                WHERE 
                        STK.GLBL_CMPY_CD        = SMO.GLBL_CMPY_CD
                    AND STK.SVC_TASK_NUM        = SMO.SVC_TASK_NUM
                    <isNotNull property="lastUpdTs">
                    AND SMO.EZUPTIME         &gt; #lastUpdTs#
                    </isNotNull>
                    AND SMO.EZCANCELFLAG        = '0'))
        <!-- START 2019/12/18 K.Kitachi [QC#54692, ADD] -->
        )
        WHERE
            RANK = 1
        <!-- END 2019/12/18 K.Kitachi [QC#54692, ADD] -->
    </statement>
</sqlMap>