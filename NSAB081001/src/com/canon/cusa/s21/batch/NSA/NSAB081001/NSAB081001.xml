<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSAB081001">

    <statement id="getChangedAccessoryData" getContractForMachineLevel="Map" resultClass="Map">
    WITH TARGET_DTL AS (
        SELECT
             B.GLBL_CMPY_CD               AS GLBL_CMPY_CD
            ,A.EZINTIME                   AS EZINTIME
            ,B.DS_CONTR_PK                AS DS_CONTR_PK
            ,A.DS_CONTR_DTL_PK            AS DS_CONTR_DTL_PK
            ,A.PRNT_DS_CONTR_DTL_PK       AS PRNT_DS_CONTR_DTL_PK
            ,B.DS_CONTR_CATG_CD           AS DS_CONTR_CATG_CD
            ,D.TERM_COND_OPT_TP_CD        AS TERM_COND_OPT_TP_CD
            ,D.TERM_COND_OPT_VAL_TXT      AS TERM_COND_OPT_VAL_TXT
            ,E.SVC_TERM_COND_ATTRB_PK     AS SVC_TERM_COND_ATTRB_PK
        FROM
             DS_CONTR_DTL            A
            ,DS_CONTR                B
            ,SVC_MACH_MSTR           C
            ,MDSE_TERM_COND_OPT      D
            ,TERM_COND_OPT_ATTRB_MAP E
        WHERE
        <!-- DS_CONTR_DTL-->
            A.GLBL_CMPY_CD                                  =     #glblCmpyCd#
            <isNotNull property="divisionNum">
                <isNotNull property="residue">
                    AND MOD(B.DS_CONTR_PK , #divisionNum# ) =     #residue#
                </isNotNull>
            </isNotNull>
        AND A.EZCANCELFLAG                                  =     '0'
        AND A.CONTR_EFF_FROM_DT                             &lt;= #slsDt#
        AND NVL(A.CONTR_CLO_DT, A.CONTR_EFF_THRU_DT)        &gt;= #slsDt#
        AND (
                A.TERM_COND_UPD_STS_CD                      IS NULL                         <!-- Not Updated -->
            OR  A.TERM_COND_UPD_STS_CD                      =     #termCondUpdStsCdUpdated# <!-- Updated -->
            )
        <!-- DS_CONTR -->
        AND A.GLBL_CMPY_CD               =  B.GLBL_CMPY_CD
        AND A.DS_CONTR_PK                =  B.DS_CONTR_PK
        AND B.EZCANCELFLAG               =  '0'
        <!-- SVC_MACH_MSTR -->
        AND A.GLBL_CMPY_CD               =  C.GLBL_CMPY_CD
        AND A.SVC_MACH_MSTR_PK           =  C.SVC_MACH_MSTR_PK
        AND C.EZCANCELFLAG               =  '0'
        <!-- MDSE_TERM_COND_OPT -->
        AND C.GLBL_CMPY_CD               =  D.GLBL_CMPY_CD
        AND C.MDSE_CD                    =  D.MDSE_CD
        AND D.EZCANCELFLAG               =  '0'
        <!-- TERM_COND_OPT_ATTRB_MAP -->
        AND D.GLBL_CMPY_CD               =  E.GLBL_CMPY_CD
        AND D.TERM_COND_OPT_TP_CD        =  E.TERM_COND_OPT_TP_CD
        AND E.EZCANCELFLAG               =  '0'
        AND E.ENBL_FLG                   =  'Y'
    )
    SELECT
         ADDL_DS_CONTR_DTL_PK
        ,DS_CONTR_PK
        ,DS_CONTR_DTL_PK
        ,SVC_TERM_COND_ATTRB_PK
        ,TERM_COND_OPT_VAL_TXT
        ,SVC_TERM_COND_PK
        ,SVC_TERM_ATTRB_MAP_VAL_CD
    FROM (
        <!-- Term & Condition of Accessory-->
        SELECT
             B.GLBL_CMPY_CD              AS GLBL_CMPY_CD
            ,A.DS_CONTR_DTL_PK           AS ADDL_DS_CONTR_DTL_PK
            ,B.DS_CONTR_PK               AS DS_CONTR_PK
            ,B.DS_CONTR_DTL_PK           AS DS_CONTR_DTL_PK
            ,A.SVC_TERM_COND_ATTRB_PK    AS SVC_TERM_COND_ATTRB_PK
            ,C.SVC_TERM_COND_PK          AS SVC_TERM_COND_PK
            ,A.TERM_COND_OPT_VAL_TXT     AS TERM_COND_OPT_VAL_TXT
            ,C.SVC_TERM_ATTRB_MAP_VAL_CD AS SVC_TERM_ATTRB_MAP_VAL_CD
            ,A.EZINTIME                  AS EZINTIME
        FROM
             TARGET_DTL     A
            ,DS_CONTR_DTL   B
            ,SVC_TERM_COND  C
        WHERE
            A.GLBL_CMPY_CD                           =     B.GLBL_CMPY_CD
        AND A.DS_CONTR_DTL_PK                        =     B.DS_CONTR_DTL_PK
        AND B.EZCANCELFLAG                           =     '0'
        AND B.CONTR_EFF_FROM_DT                      &lt;= #slsDt#
        AND NVL(B.CONTR_CLO_DT, B.CONTR_EFF_THRU_DT) &gt;= #slsDt#
        AND B.GLBL_CMPY_CD                           =     C.GLBL_CMPY_CD           (+)
        AND B.DS_CONTR_PK                            =     C.DS_CONTR_PK            (+)
        AND B.DS_CONTR_DTL_PK                        =     C.DS_CONTR_DTL_PK        (+)
        AND A.SVC_TERM_COND_ATTRB_PK                 =     C.SVC_TERM_COND_ATTRB_PK (+)
        AND C.EZCANCELFLAG                       (+) =     '0'
        ) Z
    WHERE
        Z.SVC_TERM_COND_PK IS NULL
    OR  NVL(Z.TERM_COND_OPT_VAL_TXT, #space#) &lt;&gt; NVL(Z.SVC_TERM_ATTRB_MAP_VAL_CD, #space#)
    ORDER BY
         Z.DS_CONTR_PK
        ,Z.DS_CONTR_DTL_PK
        ,Z.SVC_TERM_COND_ATTRB_PK
        ,Z.EZINTIME
    </statement>

    <statement id="getChangedMainUnitData" getContractForMachineLevel="Map" resultClass="Map">
    WITH TARGET_DTL AS (
    SELECT
         A.GLBL_CMPY_CD
        ,A.EZINTIME
        ,A.DS_CONTR_PK
        ,A.DS_CONTR_DTL_PK
        ,A.PRNT_DS_CONTR_DTL_PK
        ,A.DS_CONTR_CATG_CD
        ,A.TERM_COND_OPT_TP_CD
        ,A.TERM_COND_OPT_VAL_TXT
        ,A.SVC_TERM_COND_ATTRB_PK
    FROM (
        SELECT
             B.GLBL_CMPY_CD               AS GLBL_CMPY_CD
            ,A.EZINTIME                   AS EZINTIME
            ,B.DS_CONTR_PK                AS DS_CONTR_PK
            ,A.DS_CONTR_DTL_PK            AS DS_CONTR_DTL_PK
            ,A.PRNT_DS_CONTR_DTL_PK       AS PRNT_DS_CONTR_DTL_PK
            ,B.DS_CONTR_CATG_CD           AS DS_CONTR_CATG_CD
            ,D.TERM_COND_OPT_TP_CD        AS TERM_COND_OPT_TP_CD
            ,D.TERM_COND_OPT_VAL_TXT      AS TERM_COND_OPT_VAL_TXT
            ,E.SVC_TERM_COND_ATTRB_PK     AS SVC_TERM_COND_ATTRB_PK
            ,DENSE_RANK() over(PARTITION BY A.PRNT_DS_CONTR_DTL_PK, E.SVC_TERM_COND_ATTRB_PK order by A.EZINTIME DESC, A.DS_CONTR_DTL_PK DESC) AS RANK
        FROM
             DS_CONTR_DTL            A
            ,DS_CONTR                B
            ,SVC_MACH_MSTR           C
            ,MDSE_TERM_COND_OPT      D
            ,TERM_COND_OPT_ATTRB_MAP E
        WHERE
        <!-- DS_CONTR_DTL -->
            A.GLBL_CMPY_CD                              =     #glblCmpyCd#
        <isNotNull property="divisionNum">
            <isNotNull property="residue">
                AND MOD(B.DS_CONTR_PK , #divisionNum# ) =     #residue#
            </isNotNull>
        </isNotNull>
        AND A.EZCANCELFLAG                              =     '0'
        AND A.CONTR_EFF_FROM_DT                         &lt;= #slsDt#
        AND NVL(A.CONTR_CLO_DT, A.CONTR_EFF_THRU_DT)    &gt;= #slsDt#
        AND (
                A.TERM_COND_UPD_STS_CD                  IS NULL                         <!-- Not Updated -->
            OR  A.TERM_COND_UPD_STS_CD                  =     #termCondUpdStsCdUpdated# <!-- Updated -->
            )
        <!-- DS_CONTR -->
        AND A.GLBL_CMPY_CD               =  B.GLBL_CMPY_CD
        AND A.DS_CONTR_PK                =  B.DS_CONTR_PK
        AND B.EZCANCELFLAG               =  '0'
        <!-- SVC_MACH_MSTR -->
        AND A.GLBL_CMPY_CD               =  C.GLBL_CMPY_CD
        AND A.SVC_MACH_MSTR_PK           =  C.SVC_MACH_MSTR_PK
        AND C.EZCANCELFLAG               =  '0'
        <!-- MDSE_TERM_COND_OPT -->
        AND C.GLBL_CMPY_CD               =  D.GLBL_CMPY_CD
        AND C.MDSE_CD                    =  D.MDSE_CD
        AND D.EZCANCELFLAG               =  '0'
        <!-- TERM_COND_OPT_ATTRB_MAP -->
        AND D.GLBL_CMPY_CD               =  E.GLBL_CMPY_CD
        AND D.TERM_COND_OPT_TP_CD        =  E.TERM_COND_OPT_TP_CD
        AND E.EZCANCELFLAG               =  '0'
        AND E.ENBL_FLG                   =  'Y'
        ) A
    WHERE
        A.RANK = 1
    )

    SELECT
         ADDL_DS_CONTR_DTL_PK
        ,DS_CONTR_PK
        ,DS_CONTR_DTL_PK
        ,SVC_TERM_COND_ATTRB_PK
        ,TERM_COND_OPT_VAL_TXT
        ,SVC_TERM_COND_PK
        ,SVC_TERM_ATTRB_MAP_VAL_CD
    FROM (
            <!-- Term & Condition of Main unit-->
        SELECT
             B.GLBL_CMPY_CD              AS GLBL_CMPY_CD
            ,A.DS_CONTR_DTL_PK           AS ADDL_DS_CONTR_DTL_PK
            ,B.DS_CONTR_PK               AS DS_CONTR_PK
            ,B.DS_CONTR_DTL_PK           AS DS_CONTR_DTL_PK
            ,A.SVC_TERM_COND_ATTRB_PK    AS SVC_TERM_COND_ATTRB_PK
            ,D.SVC_TERM_COND_PK          AS SVC_TERM_COND_PK
            ,A.TERM_COND_OPT_VAL_TXT     AS TERM_COND_OPT_VAL_TXT
            ,D.SVC_TERM_ATTRB_MAP_VAL_CD AS SVC_TERM_ATTRB_MAP_VAL_CD
            ,A.EZINTIME                  AS EZINTIME
        FROM
             TARGET_DTL      A
            ,DS_CONTR_DTL    B
            ,DS_CONTR_DTL_TP C
            ,SVC_TERM_COND   D
        WHERE
            A.GLBL_CMPY_CD                           =  B.GLBL_CMPY_CD
        AND A.PRNT_DS_CONTR_DTL_PK                   =  B.DS_CONTR_DTL_PK
        AND B.EZCANCELFLAG                           =  '0'
        AND B.CONTR_EFF_FROM_DT                      &lt;= #slsDt#
        AND NVL(B.CONTR_CLO_DT, B.CONTR_EFF_THRU_DT) &gt;= #slsDt#
        AND B.GLBL_CMPY_CD                           =  C.GLBL_CMPY_CD
        AND B.DS_CONTR_DTL_TP_CD                     =  C.DS_CONTR_DTL_TP_CD
        AND C.MAIN_UNIT_LINE_FLG                     =  'Y'
        AND C.EZCANCELFLAG                           =  '0'
        AND B.GLBL_CMPY_CD                           =  D.GLBL_CMPY_CD           (+)
        AND B.DS_CONTR_PK                            =  D.DS_CONTR_PK            (+)
        AND B.DS_CONTR_DTL_PK                        =  D.DS_CONTR_DTL_PK        (+)
        AND A.SVC_TERM_COND_ATTRB_PK                 =  D.SVC_TERM_COND_ATTRB_PK (+)
        AND D.EZCANCELFLAG                       (+) =  '0'
        ) Z
    WHERE
        Z.SVC_TERM_COND_PK IS NULL
    OR  NVL(Z.TERM_COND_OPT_VAL_TXT, #space#) &lt;&gt; NVL(Z.SVC_TERM_ATTRB_MAP_VAL_CD, #space#)
    ORDER BY
         Z.DS_CONTR_PK
        ,Z.DS_CONTR_DTL_PK
        ,Z.SVC_TERM_COND_ATTRB_PK
        ,Z.EZINTIME
    </statement>

</sqlMap>