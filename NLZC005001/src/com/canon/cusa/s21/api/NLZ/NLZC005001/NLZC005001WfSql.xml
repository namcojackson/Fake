<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NLZC005001">

    <statement id="SPECIFY_APVL_POSN_CD" parameterClass="Map" resultClass="Map">
<!-- START 06/04/2020 [QC#56720,ADD] -->
        <isEqual property="condStr9" compareValue="Y">
        SELECT
             0                        AS COND_NUM_2
            ,''                       AS COND_STR_7
            ,0                        AS COND_NUM_3
            ,0                        AS COND_NUM_4
            ,'Next'                   AS DEC_COND
            ,1                        AS COND_STR_10
        FROM
            DUAL
        </isEqual>
        <isEqual property="condStr9" compareValue="N">
<!-- END   06/04/2020 [QC#56720,ADD] -->
         WITH APPROVAL_TEAM_POS AS (
            SELECT
                DISTINCT
                 ATE.APVL_TEAM_PK
                ,ATE.APVL_TEAM_NM
                ,ATE.APVL_HRCH_TP_CD
                ,ATM.APVL_TEAM_POSN_TP_CD
                ,ATP.APVL_TEAM_POSN_LAYER_NUM
                ,ATT.APVL_TEAM_TRX_PK
                ,ATT.APVL_HIST_SRC_TP_CD
                ,ATL.APVL_TEAM_LOC_PK
                ,ALT.APVL_LIMIT_PK
                ,ALT.APVL_LIMIT_AMT
                ,MAX(ATP.APVL_TEAM_POSN_LAYER_NUM) OVER (PARTITION BY 1) APPROVER_POS_LAYER_NUM
                ,MAX(ATE.APVL_TEAM_PK) OVER (PARTITION BY 1) APPROVER_TEAM_PK
            FROM
                 APVL_TEAM         ATE
                ,APVL_TEAM_MBR     ATM
                ,APVL_TEAM_TRX     ATT
                ,APVL_TEAM_LOC     ATL
                ,APVL_LIMIT        ALT
                ,APVL_TEAM_POSN_TP ATP
            WHERE 1=1
            -- JOIN TO APVL_TEAM
            AND ATE.GLBL_CMPY_CD         = #glblCmpyCd#
            AND ATE.APVL_HRCH_TP_CD      = #condStr3#
            AND ATE.EZCANCELFLAG         = '0'
            -- JOIN TO APVL_TEAM_MBR
            AND ATE.GLBL_CMPY_CD         = ATM.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK         = ATM.APVL_TEAM_PK
            AND ATM.EZCANCELFLAG         = '0'
            -- JOIN TO APVL_TEAM_TRX
            AND ATE.GLBL_CMPY_CD         = ATT.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK         = ATT.APVL_TEAM_PK
            AND ATT.APVL_HIST_SRC_TP_CD  = #condStr4#
            AND ATT.EZCANCELFLAG         = '0'
            -- JOIN TO APVL_TEAM_LOC
            AND ATE.GLBL_CMPY_CD         = ATL.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK         = ATL.APVL_TEAM_PK
            AND ATL.RTL_WH_CD            = #condStr1#
            AND ATL.EZCANCELFLAG         = '0'
            -- JOIN TO APVL_LIMIT
            AND ATE.GLBL_CMPY_CD         = ALT.GLBL_CMPY_CD
            AND ATE.APVL_HRCH_TP_CD      = ALT.APVL_HRCH_TP_CD
            AND ALT.APVL_TEAM_POSN_TP_CD = ATM.APVL_TEAM_POSN_TP_CD
            AND ALT.APVL_HIST_SRC_TP_CD  = ATT.APVL_HIST_SRC_TP_CD
            AND ALT.APVL_LIMIT_AMT      &gt;= ABS(#condNum1#)
            AND ALT.EZCANCELFLAG         = '0'
            -- JOIN TO APVL_TEAM_POSN_TP
            AND ATM.APVL_TEAM_POSN_TP_CD = ATP.APVL_TEAM_POSN_TP_CD
            AND ATE.GLBL_CMPY_CD         = ATP.GLBL_CMPY_CD
            AND ATP.EZCANCELFLAG         = '0'
            ORDER BY 
                ATP.APVL_TEAM_POSN_LAYER_NUM DESC
        )
        , APPROVAL_OWN AS (
            SELECT
                DISTINCT
                 ATE.APVL_TEAM_PK
                ,ATE.APVL_TEAM_NM
                ,ATE.APVL_HRCH_TP_CD
                ,ATM.APVL_TEAM_POSN_TP_CD
                ,ATP.APVL_TEAM_POSN_LAYER_NUM
                ,ATT.APVL_TEAM_TRX_PK
                ,ATT.APVL_HIST_SRC_TP_CD
                ,ATL.APVL_TEAM_LOC_PK
                ,ALT.APVL_LIMIT_PK
                ,ALT.APVL_LIMIT_AMT
                ,MAX(ATP.APVL_TEAM_POSN_LAYER_NUM) OVER (PARTITION BY 1) APPROVER_POS_LAYER_NUM
                ,MAX(ATE.APVL_TEAM_PK) OVER (PARTITION BY 1) APPROVER_TEAM_PK
            FROM
                 APVL_TEAM         ATE
                ,APVL_TEAM_MBR     ATM
                ,APVL_TEAM_TRX     ATT
                ,APVL_TEAM_LOC     ATL
                ,APVL_LIMIT        ALT
                ,APVL_TEAM_POSN_TP ATP
            WHERE 1=1
            -- JOIN TO APVL_TEAM
            AND ATE.GLBL_CMPY_CD         = #glblCmpyCd#
            AND ATE.APVL_HRCH_TP_CD      = #condStr3#
            AND ATE.EZCANCELFLAG         = '0'
            -- JOIN TO APVL_TEAM_MBR
            AND ATE.GLBL_CMPY_CD         = ATM.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK         = ATM.APVL_TEAM_PK
            <isNotNull property = "condStr2">
            AND ATM.PSN_CD               = #condStr2#
            </isNotNull>
            <isNull property = "condStr2">
            AND ATM.PSN_CD               = '0'
            </isNull>
            AND ATM.EZCANCELFLAG         = '0'
            -- JOIN TO APVL_TEAM_TRX
            AND ATE.GLBL_CMPY_CD         = ATT.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK         = ATT.APVL_TEAM_PK
            AND ATT.APVL_HIST_SRC_TP_CD  = #condStr4#
            AND ATT.EZCANCELFLAG         = '0'
            -- JOIN TO APVL_TEAM_LOC
            AND ATE.GLBL_CMPY_CD         = ATL.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK         = ATL.APVL_TEAM_PK
            AND ATL.RTL_WH_CD            = #condStr1#
            AND ATL.EZCANCELFLAG         = '0'
            -- JOIN TO APVL_LIMIT
            AND ATE.GLBL_CMPY_CD         = ALT.GLBL_CMPY_CD
            AND ATE.APVL_HRCH_TP_CD      = ALT.APVL_HRCH_TP_CD
            AND ALT.APVL_TEAM_POSN_TP_CD = ATM.APVL_TEAM_POSN_TP_CD
            AND ALT.APVL_HIST_SRC_TP_CD  = ATT.APVL_HIST_SRC_TP_CD
            AND ALT.APVL_LIMIT_AMT      &gt;= ABS(#condNum1#)
            AND ALT.EZCANCELFLAG         = '0'
            -- JOIN TO APVL_TEAM_POSN_TP
            AND ATM.APVL_TEAM_POSN_TP_CD = ATP.APVL_TEAM_POSN_TP_CD
            AND ATE.GLBL_CMPY_CD         = ATP.GLBL_CMPY_CD
            AND ATP.EZCANCELFLAG         = '0'
            ORDER BY 
                ATP.APVL_TEAM_POSN_LAYER_NUM DESC
        )
        SELECT
            APVL.COND_NUM_2
            ,APVL.COND_STR_7
            ,APVL.COND_NUM_3
            ,APVL.COND_NUM_4
            ,APVL.DEC_COND
            ,CASE WHEN APVL.DEC_COND = 'Next' THEN '0'
             ELSE '1'
             END                          AS COND_STR_10
        FROM (
            SELECT
                0                         AS SORT_KEY
                ,APVL_TEAM_PK             AS COND_NUM_2
                ,APVL_TEAM_POSN_TP_CD     AS COND_STR_7
                ,APVL_TEAM_POSN_LAYER_NUM AS COND_NUM_3
                ,APVL_LIMIT_AMT           AS COND_NUM_4
                ,'Next'                  AS DEC_COND
            FROM 
                APPROVAL_OWN A
            WHERE 
                A.APPROVER_POS_LAYER_NUM  = A.APVL_TEAM_POSN_LAYER_NUM
                AND A.APPROVER_TEAM_PK    = A.APVL_TEAM_PK
                AND ROWNUM                = 1
            UNION ALL
            SELECT
                0                         AS SORT_KEY
                ,APVL_TEAM_PK             AS COND_NUM_2
                ,APVL_TEAM_POSN_TP_CD     AS COND_STR_7
                ,APVL_TEAM_POSN_LAYER_NUM AS COND_NUM_3
                ,APVL_LIMIT_AMT           AS COND_NUM_4
                ,'Next'                   AS DEC_COND
            FROM 
                APPROVAL_TEAM_POS A
            WHERE 
                A.APPROVER_POS_LAYER_NUM  = A.APVL_TEAM_POSN_LAYER_NUM
                AND A.APPROVER_TEAM_PK    = A.APVL_TEAM_PK
                AND ROWNUM                = 1
            UNION ALL
            SELECT
                1                         AS SORT_KEY
                ,0                        AS COND_NUM_2
                ,''                       AS COND_STR_7
                ,0                        AS COND_NUM_3
                ,0                        AS COND_NUM_4
                ,'Next2'                  AS DEC_COND
            FROM
                DUAL
            ORDER BY SORT_KEY
            ) APVL
        WHERE
            ROWNUM                       = 1
<!-- START 06/04/2020 [QC#56720,ADD] -->
        </isEqual>
<!-- END   06/04/2020 [QC#56720,ADD] -->
    </statement>

<!-- ============================================================================================================================================= -->

    <statement id="SPECIFY_APVL_PSN_CD_BY_APVL_TEAM_POSN" parameterClass="Map" resultClass="Map">
<!-- START 06/04/2020 [QC#56720,ADD] -->
        <isEqual property="condStr9" compareValue="Y">
        SELECT
            CASE WHEN #condStr2# = 'SYSTEM'   THEN 'NLGB014001'
                 WHEN #condStr2# = 'NLGB0140' THEN 'NLGB014001'
                 ELSE #condStr2#
                 END AS VAL_STR_1
        FROM
            DUAL
        </isEqual>
        <isEqual property="condStr9" compareValue="N">
<!-- END   06/04/2020 [QC#56720,ADD] -->
        WITH APVL AS (
            SELECT
                ATE.APVL_TEAM_PK              AS COND_NUM_2
                ,ATM.APVL_TEAM_POSN_TP_CD     AS COND_STR_7
                ,ATP.APVL_TEAM_POSN_LAYER_NUM AS COND_NUM_3
                ,MAX(ATM.PSN_CD)              AS VAL_STR_1
            FROM
                APVL_TEAM          ATE
                ,APVL_TEAM_MBR     ATM
                ,APVL_TEAM_TRX     ATT
                ,APVL_TEAM_LOC     ATL
                ,APVL_TEAM_POSN_TP ATP
            WHERE 1=1
            -- JOIN TO APVL_TEAM
            AND ATE.GLBL_CMPY_CD             = #glblCmpyCd#
            AND ATE.APVL_HRCH_TP_CD          = #condStr3#
            AND ATE.APVL_TEAM_PK             = #condNum2#
            AND ATE.EZCANCELFLAG             = '0'
            -- JOIN TO APVL_TEAM_MBR
            AND ATE.GLBL_CMPY_CD             = ATM.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK             = ATM.APVL_TEAM_PK
            AND ATM.EZCANCELFLAG             = '0'
            -- JOIN TO APVL_TEAM_TRX
            AND ATE.GLBL_CMPY_CD             = ATT.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK             = ATT.APVL_TEAM_PK
            AND ATT.APVL_HIST_SRC_TP_CD      = #condStr4#
            AND ATT.EZCANCELFLAG             = '0'
            -- JOIN TO APVL_TEAM_LOC
            AND ATE.GLBL_CMPY_CD             = ATL.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK             = ATL.APVL_TEAM_PK 
            AND ATL.RTL_WH_CD                = #condStr1#
            AND ATL.EZCANCELFLAG             = '0'
            -- JOIN TO APVL_TEAM_POSN_TP
            AND ATM.APVL_TEAM_POSN_TP_CD     = ATP.APVL_TEAM_POSN_TP_CD
            AND ATE.GLBL_CMPY_CD             = ATP.GLBL_CMPY_CD
            AND ATP.APVL_TEAM_POSN_LAYER_NUM &gt;= #condNum3#
            AND ATP.EZCANCELFLAG             = '0'

<!-- START 04/23/2020 [QC#56461,ADD] -->
            AND EXISTS (
                SELECT
                    1
                FROM AUTH_PSN   AP
                WHERE 1=1
                AND ATM.GLBL_CMPY_CD    = AP.GLBL_CMPY_CD
                AND ATM.PSN_CD          = AP.USR_NM
                AND AP.EZCANCELFLAG     = '0'
                UNION ALL
                SELECT
                    1
                FROM SCE_SYS_USR_LIST   SSUL
                WHERE 1=1
                AND ATM.GLBL_CMPY_CD    = SSUL.GLBL_CMPY_CD
                AND ATM.PSN_CD          = SSUL.PSN_CD
                AND SSUL.EZCANCELFLAG   = '0'
            )
<!-- END   04/23/2020 [QC#56461,ADD] -->

            GROUP BY
                ATE.APVL_TEAM_PK
                ,ATM.APVL_TEAM_POSN_TP_CD
                ,ATP.APVL_TEAM_POSN_LAYER_NUM
            ORDER BY
                COND_NUM_3 DESC
        )
        <isNotNull property = "condStr2">
        , USR_OWN AS (
            SELECT
                DISTINCT
                 ATE.APVL_TEAM_PK
                ,ATE.APVL_TEAM_NM
                ,ATE.APVL_HRCH_TP_CD
                ,ATM.APVL_TEAM_POSN_TP_CD
                ,ATP.APVL_TEAM_POSN_LAYER_NUM
                ,ATT.APVL_TEAM_TRX_PK
                ,ATT.APVL_HIST_SRC_TP_CD
                ,ATL.APVL_TEAM_LOC_PK
            FROM
                 APVL_TEAM         ATE
                ,APVL_TEAM_MBR     ATM
                ,APVL_TEAM_TRX     ATT
                ,APVL_TEAM_LOC     ATL
                ,APVL_TEAM_POSN_TP ATP

            WHERE 1=1
            -- JOIN TO APVL_TEAM
            AND ATE.GLBL_CMPY_CD         = #glblCmpyCd#
            AND ATE.APVL_HRCH_TP_CD      = #condStr3#
            AND ATE.EZCANCELFLAG         = '0'
            -- JOIN TO APVL_TEAM_MBR
            AND ATE.GLBL_CMPY_CD         = ATM.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK         = ATM.APVL_TEAM_PK
            AND ATM.PSN_CD               = #condStr2#
            AND ATM.EZCANCELFLAG         = '0'
            -- JOIN TO APVL_TEAM_TRX
            AND ATE.GLBL_CMPY_CD         = ATT.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK         = ATT.APVL_TEAM_PK
            AND ATT.APVL_HIST_SRC_TP_CD  = #condStr4#
            AND ATT.EZCANCELFLAG         = '0'
            -- JOIN TO APVL_TEAM_LOC
            AND ATE.GLBL_CMPY_CD         = ATL.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK         = ATL.APVL_TEAM_PK
            AND ATL.RTL_WH_CD            = #condStr1#
            AND ATL.EZCANCELFLAG         = '0'
            -- JOIN TO APVL_TEAM_POSN_TP
            AND ATM.APVL_TEAM_POSN_TP_CD = ATP.APVL_TEAM_POSN_TP_CD
            AND ATE.GLBL_CMPY_CD         = ATP.GLBL_CMPY_CD
            AND ATP.EZCANCELFLAG         = '0'         
            ORDER BY 
                ATP.APVL_TEAM_POSN_LAYER_NUM DESC
        )
        </isNotNull>
        SELECT
<!-- START 05/21/2020 [QC#56549,MOD] -->
            CASE
        <isEqual property="condStr2" compareValue="SYSTEM">
                 WHEN A.VAL_STR_1 = 'SYSTEM' THEN 'NLGB014001'
        </isEqual>
                 WHEN A.VAL_STR_1 = #condStr2# THEN A.VAL_STR_1
<!-- END 05/21/2020 [QC#56549,MOD] -->
                 WHEN EXISTS(SELECT 1 FROM USR_OWN U WHERE APVL_TEAM_POSN_LAYER_NUM = A.COND_NUM_3) THEN #condStr2#
                 ELSE A.VAL_STR_1
            END AS VAL_STR_1
        FROM
            APVL A
       <isNotNull property = "condStr2">
        WHERE
            EXISTS(
                SELECT 1 FROM USR_OWN U WHERE U.APVL_TEAM_POSN_LAYER_NUM &gt;= A.COND_NUM_3
            ) 
         OR NOT EXISTS (SELECT 1 FROM USR_OWN U)
       </isNotNull>
<!-- START 06/04/2020 [QC#56720,ADD] -->
        </isEqual>
<!-- END   06/04/2020 [QC#56720,ADD] -->
    </statement>

<!-- ============================================================================================================================================= -->

    <statement id="SPECIFY_APVL_PSN_CD_GRP_BY_APVL_TEAM_POSN" parameterClass="Map" resultClass="Map">
    --3).set group
     <isEqual property="condStr10" compareValue="1">
         SELECT
          '' AS BIZ_ID
          , '' AS USER_GROUP_NAME
          , '' AS USER_GROUP_LEVEL
          , '' AS WF_USR_ID 
         FROM
           DUAL 
         WHERE
           ROWNUM  &gt;= 2
     </isEqual>
     <isNotEqual property="condStr10" compareValue="1">
        WITH APVL_LVEL AS (
            SELECT
                ATE.APVL_TEAM_PK              AS COND_NUM_2
                ,ATM.APVL_TEAM_POSN_TP_CD     AS COND_STR_7
                ,ATP.APVL_TEAM_POSN_LAYER_NUM AS COND_NUM_3
                ,ATM.PSN_CD                   AS VAL_STR_1
                ,DENSE_RANK()OVER(
                    ORDER BY ATP.APVL_TEAM_POSN_LAYER_NUM DESC) AS LEVEL_NUM
            FROM
                APVL_TEAM          ATE
                ,APVL_TEAM_MBR     ATM
                ,APVL_TEAM_TRX     ATT
                ,APVL_TEAM_LOC     ATL
                ,APVL_TEAM_POSN_TP ATP
            WHERE 1=1
            -- JOIN TO APVL_TEAM
            AND ATE.GLBL_CMPY_CD             = #glblCmpyCd#
            AND ATE.APVL_HRCH_TP_CD          = #condStr3#
            AND ATE.APVL_TEAM_PK             = #condNum2#
            AND ATE.EZCANCELFLAG             = '0'
            -- JOIN TO APVL_TEAM_MBR
            AND ATE.GLBL_CMPY_CD             = ATM.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK             = ATM.APVL_TEAM_PK
            AND ATM.EZCANCELFLAG             = '0'
            -- JOIN TO APVL_TEAM_TRX
            AND ATE.GLBL_CMPY_CD             = ATT.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK             = ATT.APVL_TEAM_PK
            AND ATT.APVL_HIST_SRC_TP_CD      = #condStr4#
            AND ATT.EZCANCELFLAG             = '0'
            -- JOIN TO APVL_TEAM_LOC
            AND ATE.GLBL_CMPY_CD             = ATL.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK             = ATL.APVL_TEAM_PK 
            AND ATL.RTL_WH_CD                = #condStr1#
            AND ATL.EZCANCELFLAG             = '0'
            -- JOIN TO APVL_TEAM_POSN_TP
            AND ATM.APVL_TEAM_POSN_TP_CD     = ATP.APVL_TEAM_POSN_TP_CD
            AND ATE.GLBL_CMPY_CD             = ATP.GLBL_CMPY_CD
            AND ATP.APVL_TEAM_POSN_LAYER_NUM &gt;= #condNum3#
            AND ATP.EZCANCELFLAG             = '0'

<!-- START 04/23/2020 [QC#56461,ADD] -->
            AND EXISTS (
                SELECT
                    1
                FROM AUTH_PSN   AP
                WHERE 1=1
                AND ATM.GLBL_CMPY_CD    = AP.GLBL_CMPY_CD
                AND ATM.PSN_CD          = AP.USR_NM
                AND AP.EZCANCELFLAG     = '0'
                UNION ALL
                SELECT
                    1
                FROM SCE_SYS_USR_LIST   SSUL
                WHERE 1=1
                AND ATM.GLBL_CMPY_CD    = SSUL.GLBL_CMPY_CD
                AND ATM.PSN_CD          = SSUL.PSN_CD
                AND SSUL.EZCANCELFLAG   = '0'
            )
<!-- END   04/23/2020 [QC#56461,ADD] -->

            ORDER BY
                ATP.APVL_TEAM_POSN_LAYER_NUM DESC
                ,ATM.PSN_CD
        )
        ,APVL AS (
            SELECT
                ATE.APVL_TEAM_PK              AS COND_NUM_2
                ,ATM.APVL_TEAM_POSN_TP_CD     AS COND_STR_7
                ,ATP.APVL_TEAM_POSN_LAYER_NUM AS COND_NUM_3
                ,Max(ATM.PSN_CD)              AS VAL_STR_1
            FROM
                APVL_TEAM          ATE
                ,APVL_TEAM_MBR     ATM
                ,APVL_TEAM_TRX     ATT
                ,APVL_TEAM_LOC     ATL
                ,APVL_TEAM_POSN_TP ATP
            WHERE 1=1
            -- JOIN TO APVL_TEAM
            AND ATE.GLBL_CMPY_CD             = #glblCmpyCd#
            AND ATE.APVL_HRCH_TP_CD          = #condStr3#
            AND ATE.APVL_TEAM_PK             = #condNum2#
            AND ATE.EZCANCELFLAG             = '0'
            -- JOIN TO APVL_TEAM_MBR
            AND ATE.GLBL_CMPY_CD             = ATM.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK             = ATM.APVL_TEAM_PK
            AND ATM.EZCANCELFLAG             = '0'
            -- JOIN TO APVL_TEAM_TRX
            AND ATE.GLBL_CMPY_CD             = ATT.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK             = ATT.APVL_TEAM_PK
            AND ATT.APVL_HIST_SRC_TP_CD      = #condStr4#
            AND ATT.EZCANCELFLAG             = '0'
            -- JOIN TO APVL_TEAM_LOC
            AND ATE.GLBL_CMPY_CD             = ATL.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK             = ATL.APVL_TEAM_PK 
            AND ATL.RTL_WH_CD                = #condStr1#
            AND ATL.EZCANCELFLAG             = '0'
            -- JOIN TO APVL_TEAM_POSN_TP
            AND ATM.APVL_TEAM_POSN_TP_CD     = ATP.APVL_TEAM_POSN_TP_CD
            AND ATE.GLBL_CMPY_CD             = ATP.GLBL_CMPY_CD
            AND ATP.APVL_TEAM_POSN_LAYER_NUM &gt;= #condNum3#
            AND ATP.EZCANCELFLAG             = '0'

<!-- START 04/23/2020 [QC#56461,ADD] -->
            AND EXISTS (
                SELECT
                    1
                FROM AUTH_PSN   AP
                WHERE 1=1
                AND ATM.GLBL_CMPY_CD    = AP.GLBL_CMPY_CD
                AND ATM.PSN_CD          = AP.USR_NM
                AND AP.EZCANCELFLAG     = '0'
                UNION ALL
                SELECT
                    1
                FROM SCE_SYS_USR_LIST   SSUL
                WHERE 1=1
                AND ATM.GLBL_CMPY_CD    = SSUL.GLBL_CMPY_CD
                AND ATM.PSN_CD          = SSUL.PSN_CD
                AND SSUL.EZCANCELFLAG   = '0'
            )
<!-- END   04/23/2020 [QC#56461,ADD] -->

            Group by
                ATE.APVL_TEAM_PK
                ,ATM.APVL_TEAM_POSN_TP_CD
                ,ATP.APVL_TEAM_POSN_LAYER_NUM
            ORDER BY
                COND_NUM_3 DESC
        )
        <isNotNull property = "condStr2">
        , USR_OWN AS (
            SELECT
                DISTINCT
                 ATE.APVL_TEAM_PK
                ,ATE.APVL_TEAM_NM
                ,ATE.APVL_HRCH_TP_CD
                ,ATM.APVL_TEAM_POSN_TP_CD
                ,ATP.APVL_TEAM_POSN_LAYER_NUM
                ,ATT.APVL_TEAM_TRX_PK
                ,ATT.APVL_HIST_SRC_TP_CD
                ,ATL.APVL_TEAM_LOC_PK
            FROM
                 APVL_TEAM         ATE
                ,APVL_TEAM_MBR     ATM
                ,APVL_TEAM_TRX     ATT
                ,APVL_TEAM_LOC     ATL
                ,APVL_TEAM_POSN_TP ATP

            WHERE 1=1
            -- JOIN TO APVL_TEAM
            AND ATE.GLBL_CMPY_CD         = #glblCmpyCd#
            AND ATE.APVL_HRCH_TP_CD      = #condStr3#
            AND ATE.EZCANCELFLAG         = '0'
            -- JOIN TO APVL_TEAM_MBR
            AND ATE.GLBL_CMPY_CD         = ATM.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK         = ATM.APVL_TEAM_PK
            AND ATM.PSN_CD               = #condStr2#
            AND ATM.EZCANCELFLAG         = '0'
            -- JOIN TO APVL_TEAM_TRX
            AND ATE.GLBL_CMPY_CD         = ATT.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK         = ATT.APVL_TEAM_PK
            AND ATT.APVL_HIST_SRC_TP_CD  = #condStr4#
            AND ATT.EZCANCELFLAG         = '0'
            -- JOIN TO APVL_TEAM_LOC
            AND ATE.GLBL_CMPY_CD         = ATL.GLBL_CMPY_CD
            AND ATE.APVL_TEAM_PK         = ATL.APVL_TEAM_PK
            AND ATL.RTL_WH_CD            = #condStr1#
            AND ATL.EZCANCELFLAG         = '0'
            -- JOIN TO APVL_TEAM_POSN_TP
            AND ATM.APVL_TEAM_POSN_TP_CD = ATP.APVL_TEAM_POSN_TP_CD
            AND ATE.GLBL_CMPY_CD         = ATP.GLBL_CMPY_CD
            AND ATP.EZCANCELFLAG         = '0'         
            ORDER BY 
                ATP.APVL_TEAM_POSN_LAYER_NUM DESC
        )
        </isNotNull>
        SELECT
            'NLZC00500101'                 AS BIZ_ID
            ,'GRP_APVL_PSN'                AS USER_GROUP_NAME
            ,A.LEVEL_NUM                   AS USER_GROUP_LEVEL
            ,A.VAL_STR_1                   AS WF_USR_ID
        FROM (
            SELECT
                AL.VAL_STR_1
                ,AL.LEVEL_NUM
            FROM
                APVL_LVEL AL
            WHERE
                NOT EXISTS(
                    SELECT  1 FROM APVL AP WHERE AP.VAL_STR_1 = AL.VAL_STR_1
                )
       <isNotNull property = "condStr2">
            AND (
                    EXISTS(
                        SELECT 1 FROM USR_OWN U WHERE U.APVL_TEAM_POSN_LAYER_NUM &gt; AL.COND_NUM_3
                    )
                    OR NOT EXISTS (SELECT 1 FROM USR_OWN U)
                )
       </isNotNull>
            ) A
     </isNotEqual>
    </statement>

<!-- ============================================================================================================================================= -->

    <statement id="SPECIFY_APVL_PSN_CD_BY_APVL_TEAM_POSN_NO_USER" parameterClass="Map" resultClass="Map">
        SELECT
            NULL
        FROM
            DUAL
        WHERE
            ROWNUM = 2
    </statement>

<!-- ============================================================================================================================================= -->

    <statement id="GET_REASIGN_USR_BY_TEAM_POSN_LAYER_NUM" parameterClass="Map" resultClass="Map">
        WITH VIEW01 AS (
             SELECT 
                     DISTINCT INLINE1.PSN_CD
             FROM    APVL_TEAM_MBR INLINE1
                    ,APVL_TEAM_POSN_TP INLINE2

             WHERE
                     INLINE1.GLBL_CMPY_CD                     = #glblCmpyCd# 
                 AND INLINE1.GLBL_CMPY_CD                     = INLINE2.GLBL_CMPY_CD
                 AND INLINE1.APVL_TEAM_POSN_TP_CD             = INLINE2.APVL_TEAM_POSN_TP_CD
                 AND INLINE1.APVL_TEAM_PK                     = #condNum3#
                 AND INLINE1.PSN_CD                    &lt;&gt; #condStr2#
                 AND INLINE2.APVL_TEAM_POSN_LAYER_NUM     &gt;= #condNum2#
                 AND INLINE1.EZCANCELFLAG = '0'
                 AND INLINE2.EZCANCELFLAG = '0'
                 AND #condNum3#   &lt;&gt;  -1

             UNION

             SELECT
                    DISTINCT
                    ATM.PSN_CD
             FROM
                    APVL_TEAM_MBR ATM
             WHERE
                    ATM.GLBL_CMPY_CD = #glblCmpyCd#
               AND  ATM.APVL_TEAM_PK = -1
               AND  ATM.EZCANCELFLAG = '0'
               AND  #condNum3#       = -1
            )
         SELECT
                  'NPZC005001'      AS BIZ_ID
                , 'GRP_REASIGN_PSN' AS USER_GROUP_NAME
                , '000'             AS USER_GROUP_LEVEL
                , VIEW01.PSN_CD     AS WF_USR_ID 
         FROM
           VIEW01
    </statement>

<!-- ============================================================================================================================================= -->

    <statement id="CHECK_APVL_LIMIT_BY_REQUESTER" parameterClass="Map" resultClass="Map">
    --1).Check Approval Limit by Requester
        SELECT
             RSLT.PSN_CD AS COND_STR_9
            ,RSLT.DEC_COND
        FROM
        (
            <isNotNull property="condStr2">
            SELECT
                  AL.PSN_CD
                , CASE WHEN AL.APVL_LIMIT_AMT &gt;= ABS(#condNum1#) THEN 'Next2' ELSE 'Next' END AS DEC_COND
                , 1 AS SORT_NUM
            FROM
                  APVL_LIMIT AL
            WHERE
                  AL.GLBL_CMPY_CD           = #glblCmpyCd#
              AND AL.APVL_HRCH_TP_CD        = #condStr3#
              AND AL.PSN_CD                 = #condStr2#
              AND (AL.PRCH_GRP_CD           = #condStr5# OR NVL(AL.PRCH_GRP_CD,'*') = '*' )
              AND AL.APVL_HIST_SRC_TP_CD    = #condStr4#
              AND AL.EZCANCELFLAG           = '0'
            UNION ALL
            </isNotNull>
            SELECT
                 #condStr2# AS PSN_CD
                ,CASE WHEN AL.APVL_LIMIT_AMT &gt;= ABS(#condNum1#) THEN 'Next2' ELSE 'Next' END as DEC_COND
                ,3 AS SORT_NUM
             FROM
                  APVL_LIMIT AL
            WHERE
                  AL.GLBL_CMPY_CD = #glblCmpyCd#
              AND AL.PSN_CD       = '*' --'*'=Special User.
              AND AL.EZCANCELFLAG = '0'
        ) RSLT 
        WHERE    ROWNUM = 1
    </statement>

<!-- ============================================================================================================================================= -->

    <statement id="CHECK_APVL_LIMIT_BY_SUPV" parameterClass="Map" resultClass="Map">
    --2).Check Approval Limit by Supervisor
    --If Approval Limit Amount is smaller than requested Total Amount, we should search super visor of Requester from HR Info.
         SELECT

               ,#condStr2#     AS COND_STR_2
         FROM  S21_PSN S_P
         WHERE
                 S_P.GLBL_CMPY_CD           = #glblCmpyCd#
             AND S_P.EZCANCELFLAG           = '0'
             AND S_P.PSN_CD                 = #condStr2#
    </statement>
    
<!-- ============================================================================================================================================= -->

    <statement id="CHECK_APVL_LIMIT_BY_REQUESTER_2" parameterClass="Map" resultClass="Map">
    --2).Set Group
         SELECT
            #condStr9#  AS VAL_STR_1
           ,#condStr2#  AS COND_STR_2
         FROM
           DUAL
    </statement>

<!-- ============================================================================================================================================= -->

    <statement id="GET_REASIGN_USR_BY_APPROVER" parameterClass="Map" resultClass="Map">
    --02.Inventory Ajustment Reasign
       WITH VIEW01 AS (
           SELECT
                 S_P.PSN_CD
                ,LEVEL AS LVL
            FROM
                 S21_PSN S_P
            START WITH
                        S_P.GLBL_CMPY_CD      = #glblCmpyCd#
                AND     S_P.PSN_CD            = #condStr2#
                AND     S_P.EZCANCELFLAG      = '0'
            CONNECT BY
                        PRIOR S_P.HR_SUPV_ID  = S_P.PSN_CD
                AND     S_P.GLBL_CMPY_CD      = #glblCmpyCd#
                AND     S_P.EZCANCELFLAG      = '0'
            ORDER BY LEVEL
            )
         SELECT
                  'NPZC00500101'         AS BIZ_ID
                , 'GRP_REASIGN_TECH'     AS USER_GROUP_NAME
                , '000'                  AS USER_GROUP_LEVEL
                , VIEW01.PSN_CD          AS WF_USR_ID 
         FROM
           VIEW01
        WHERE LVL &gt; 1
    </statement>
</sqlMap>