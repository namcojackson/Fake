<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NMAL0170Query">

    <typeAlias alias="NMAL0170SMsg"    type="business.blap.NMAL0170.NMAL0170SMsg"/>
    <typeAlias alias="NMAL0170_ASMsg"  type="business.blap.NMAL0170.NMAL0170_ASMsg"/>

    <statement id="searchSupersedesStage" parameterClass="Map" resultMap="result.getSupersedesStage">
    <!-- UPDATE START 2016/02/22 QC#2669 -->
        WITH
            TBL_A AS
            (
                SELECT
                        SU.SUPD_FROM_MDSE_CD
                       ,SU.SUPD_RELN_STAGE_PK
                       ,SU.SUPD_TO_MDSE_CD
                       ,SU.SUPD_RELN_STAGE_DT
                       ,MI.MDSE_ITEM_TP_NM
                       ,MC.MDSE_ITEM_CLS_TP_NM
                       ,MD_TO.MDSE_DESC_SHORT_TXT AS MDSE_DESC_SHORT_TXT_TO
                       ,MD_FR.mdse_desc_short_txt AS MDSE_DESC_SHORT_TXT_FR
                       <!-- QC#2872 -->
                       ,SU.EZINTIME     AS XX_REC_HIST_CRAT_TS
                       ,SU.EZINUSERID   AS XX_REC_HIST_CRAT_BY_NM
                       ,SU.EZUPTIME     AS XX_REC_HIST_UPD_TS
                       ,SU.EZUPUSERID   AS XX_REC_HIST_UPD_BY_NM
                       ,SU.EZTABLEID    AS XX_REC_HIST_TBL_NM
                       ,SU.EZUPTIMEZONE AS EZUPTIMEZONE<!-- ADD S21_NA #17259 -->
                FROM
                        SUPD_RELN_STAGE    SU
                       ,MDSE               MD_TO
                       ,MDSE               MD_FR
                       ,MDSE_ITEM_TP       MI
                       ,MDSE_ITEM_CLS_TP   MC
                WHERE
                           SU.GLBL_CMPY_CD           = #glblCmpyCd#
    <!-- UPDATE START 2016/03/17 QC#5353 -->
                    AND    SU.SUBMT_FLG              = #submitFlg#
    <!-- UPDATE END   2016/03/17 QC#5353 -->
                <isNotNull property="itemNumber">
                    AND    SU.SUPD_TO_MDSE_CD        = #itemNumber#
                </isNotNull>
                <isNotNull property="fromDt">
                    AND    SU.SUPD_RELN_STAGE_DT     <![CDATA[>=]]>    #fromDt#
                </isNotNull>
                <isNotNull property="toDt">
                    AND    SU.SUPD_RELN_STAGE_DT     <![CDATA[<=]]>    #toDt#
                </isNotNull>
                    AND    SU.EZCANCELFLAG           = '0'
                    
                    AND    SU.GLBL_CMPY_CD           = MD_TO.GLBL_CMPY_CD
                    AND    SU.SUPD_TO_MDSE_CD        = MD_TO.MDSE_CD
                    AND    MD_TO.EZCANCELFLAG        = '0'
                <isNotNull property="itemTp">
                    AND    MD_TO.MDSE_ITEM_TP_CD     = #itemTp#
                </isNotNull>
                <isNotNull property="itemClsTp">
                    AND    MD_TO.MDSE_ITEM_CLS_TP_CD = #itemClsTp#
                </isNotNull>
                    
                    AND    MD_TO.GLBL_CMPY_CD        = MI.GLBL_CMPY_CD(+)
                    AND    MD_TO.MDSE_ITEM_TP_CD     = MI.MDSE_ITEM_TP_CD(+)
                    AND    MI.EZCANCELFLAG(+)        = '0'
                    
                    AND    MD_TO.GLBL_CMPY_CD        = MC.GLBL_CMPY_CD(+)
                    AND    MD_TO.MDSE_ITEM_CLS_TP_CD = MC.MDSE_ITEM_CLS_TP_CD(+)
                    AND    MC.EZCANCELFLAG(+)        = '0'
                    
                    AND    SU.GLBL_CMPY_CD           = MD_FR.GLBL_CMPY_CD
                    AND    SU.SUPD_FROM_MDSE_CD      = MD_FR.MDSE_CD
                    AND    MD_FR.EZCANCELFLAG        = '0'
        )
        SELECT
             SUPD_FROM_MDSE_CD
            ,SUPD_RELN_STAGE_PK
            ,SUPD_TO_MDSE_CD
            ,SUPD_RELN_STAGE_DT
            ,MDSE_ITEM_TP_NM
            ,MDSE_ITEM_CLS_TP_NM
            ,MDSE_DESC_SHORT_TXT_TO AS MDSE_DESC_SHORT_TXT_TO
            ,MDSE_DESC_SHORT_TXT_FR AS MDSE_DESC_SHORT_TXT_FR
            <!-- QC#2872 -->
            ,XX_REC_HIST_CRAT_TS
            ,XX_REC_HIST_CRAT_BY_NM
            ,XX_REC_HIST_UPD_TS
            ,XX_REC_HIST_UPD_BY_NM
            ,XX_REC_HIST_TBL_NM
            ,EZUPTIMEZONE<!-- ADD S21_NA #17259 -->
        FROM
            TBL_A
        WHERE
            ROWNUM <![CDATA[<=]]> #rowNum#
    <!-- UPDATE END 2016/02/22 QC#2669 -->
    </statement>

    <resultMap id="result.getSupersedesStage" class="NMAL0170_ASMsg">
    <!-- UPDATE START 2016/02/22 QC#2669 -->
        <result property="supdToMdseCd_A1"       column="SUPD_TO_MDSE_CD"          javaType="EZDSStringItem" />
        <result property="mdseDescShortTxt_AT"   column="MDSE_DESC_SHORT_TXT_TO"   javaType="EZDSStringItem"   />
        <result property="supdFromMdseCd_A1"     column="SUPD_FROM_MDSE_CD"        javaType="EZDSStringItem" />
        <result property="mdseDescShortTxt_AF"   column="MDSE_DESC_SHORT_TXT_FR"   javaType="EZDSStringItem"   />
        <result property="supdRelnStageDt_A1"    column="SUPD_RELN_STAGE_DT"       javaType="EZDSDateItem"  />
        <result property="mdseItemTpNm_A1"       column="MDSE_ITEM_TP_NM"          javaType="EZDSStringItem" />
        <result property="mdseItemClsTpNm_A1"    column="MDSE_ITEM_CLS_TP_NM"      javaType="EZDSStringItem" />
        <result property="supdRelnStagePk_A1"    column="SUPD_RELN_STAGE_PK"       javaType="EZDSBigDecimalItem"/>
        <!-- QC#2872 -->
        <result property="xxRecHistCratTs_A1"    column="XX_REC_HIST_CRAT_TS"      javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdTs_A1"     column="XX_REC_HIST_UPD_TS"       javaType="EZDSStringItem"/>
        <result property="xxRecHistTblNm_A1"     column="XX_REC_HIST_TBL_NM"       javaType="EZDSStringItem"/>
        <result property="xxRecHistCratByNm_B1"  column="XX_REC_HIST_CRAT_BY_NM"   javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdByNm_B1"   column="XX_REC_HIST_UPD_BY_NM"    javaType="EZDSStringItem"/>
    <!-- UPDATE END 2016/02/22 QC#2669 -->
    <!-- ADD START S21_NA #17259 -->
        <result property="ezUpTimeZone_A1"       column="EZUPTIMEZONE"             javaType="EZDSStringItem" />
    <!-- ADD END S21_NA #17259 -->
    </resultMap>

    <statement id="findSupdRelnStagePk" parameterClass="Map" resultClass="Map">
      WITH
            TBL_A AS
            (
                SELECT
                          SU.SUPD_RELN_STAGE_PK
                FROM
                          SUPD_RELN_STAGE     SU
                         ,MDSE                MD
                WHERE
    <!-- UPDATE START 2016/03/17 QC#5353 -->
                          SU.GLBL_CMPY_CD       =  #glblCmpyCd#
                     AND  SU.SUPD_FROM_MDSE_CD  =  #supdCd#
                     AND  SU.SUPD_TO_MDSE_CD    =  #itemNumber#
                     AND  SU.SUBMT_FLG          =  #submitFlg#
                     AND  SU.EZCANCELFLAG       =  '0'
                     AND  SU.GLBL_CMPY_CD       =  MD.GLBL_CMPY_CD
                     AND  SU.EZCANCELFLAG       =  MD.EZCANCELFLAG
                     AND  SU.SUPD_TO_MDSE_CD    =  MD.MDSE_CD
    <!-- UPDATE START 2016/03/17 QC#5353 -->
             )
        SELECT
             SUPD_RELN_STAGE_PK
        FROM
            TBL_A
        WHERE
            ROWNUM <![CDATA[<=]]> 1
    </statement>
    <!-- ADD START 2016/02/22 QC#2669 -->
    <statement id="getCountSupdReln" parameterClass="Map" resultClass="Integer">
        SELECT
            COUNT(*) AS CNT
          FROM 
            SUPD_RELN
          WHERE
                GLBL_CMPY_CD      = #glblCmpyCd#
            AND SUPD_TO_MDSE_CD   = #itemNumber#
            AND SUPD_FROM_MDSE_CD = #supdCd#
            AND EZCANCELFLAG      = '0'
    </statement>
    <statement id="getCountSupdRelnStage" parameterClass="Map" resultClass="Integer">
        SELECT
            COUNT(*) AS CNT
          FROM 
            SUPD_RELN_STAGE
          WHERE
                GLBL_CMPY_CD      = #glblCmpyCd#
            AND SUPD_TO_MDSE_CD   = #itemNumber#
            AND SUPD_FROM_MDSE_CD = #supdCd#
            AND EZCANCELFLAG      = '0'
    </statement>
    <statement id="getCountSupdFrom" parameterClass="Map" resultClass="Integer">
      SELECT
          COUNT(SUPD_FROM_MDSE_CD) AS CNT
          FROM (
            SELECT
                SR.SUPD_FROM_MDSE_CD
              FROM 
                SUPD_RELN SR
              WHERE
                    SR.GLBL_CMPY_CD      = #glblCmpyCd#
                AND SR.SUPD_FROM_MDSE_CD = #supdCd#
                AND SR.EZCANCELFLAG      = '0'
          UNION ALL    
            SELECT
                SRS.SUPD_FROM_MDSE_CD
              FROM 
                SUPD_RELN_STAGE SRS
              WHERE
                    SRS.GLBL_CMPY_CD      = #glblCmpyCd#
                AND SRS.SUPD_FROM_MDSE_CD = #supdCd#
                AND SRS.SUBMT_FLG         = #submitFlg#
                AND SRS.EZCANCELFLAG      = '0'
          )
    </statement>
    <statement id ="getSupdRelnList" parameterClass="Map"  resultClass="Map">
        WITH TEMP (
           SUPD_FROM_MDSE_CD
          ,SUPD_TO_MDSE_CD
          ,TBL
          ,LVL 
        ) AS (
          SELECT
               UT.SUPD_FROM_MDSE_CD
              ,UT.SUPD_TO_MDSE_CD
              ,UT.TBL
              ,1 
            FROM (
              SELECT
                   SUPD_FROM_MDSE_CD
                  ,SUPD_TO_MDSE_CD
                  ,'SUPD_RELN' AS TBL
                FROM SUPD_RELN SR
                WHERE
                      SR.GLBL_CMPY_CD = #glblCmpyCd#
                  AND SR.EZCANCELFLAG = '0'
              UNION ALL
              SELECT
                   SUPD_FROM_MDSE_CD
                  ,SUPD_TO_MDSE_CD
                  ,'SUPD_RELN_STAGE' AS TBL
                FROM SUPD_RELN_STAGE SRS
                WHERE
                      SRS.GLBL_CMPY_CD = #glblCmpyCd#
                  AND SRS.SUBMT_FLG    = #submitFlg#
                  AND SRS.EZCANCELFLAG = '0'
            )UT
            WHERE
              UT.SUPD_TO_MDSE_CD = #supdCd#
          UNION ALL
          SELECT
               UT_B.SUPD_FROM_MDSE_CD
              ,UT_B.SUPD_TO_MDSE_CD
              ,UT_B.TBL
              ,LVL + 1 
            FROM (
              SELECT
                   SUPD_FROM_MDSE_CD
                  ,SUPD_TO_MDSE_CD
                  ,'SUPD_RELN' AS TBL
                FROM SUPD_RELN SR
                WHERE
                      SR.GLBL_CMPY_CD = #glblCmpyCd#
                  AND SR.EZCANCELFLAG = '0'
              UNION ALL
              SELECT
                   SUPD_FROM_MDSE_CD
                  ,SUPD_TO_MDSE_CD
                  ,'SUPD_RELN_STAGE' AS TBL
                FROM SUPD_RELN_STAGE SRS
                WHERE
                      SRS.GLBL_CMPY_CD = #glblCmpyCd#
                  AND SRS.SUBMT_FLG    = #submitFlg#
                  AND SRS.EZCANCELFLAG = '0'
            ) UT_B
            ,TEMP T
          WHERE
            UT_B.SUPD_TO_MDSE_CD = T.SUPD_FROM_MDSE_CD
        )
        SEARCH BREADTH FIRST BY SUPD_TO_MDSE_CD SET ORDER1
        CYCLE SUPD_FROM_MDSE_CD SET IsLoop TO 'Y' DEFAULT 'N'
        SELECT * FROM TEMP
    </statement>
    <!-- ADD END 2016/02/22 QC#2669 -->
    <!-- ADD START 2016/02/22 QC#6176 -->
    <statement id="getItemDescription" parameterClass="Map" resultClass="Map">
        SELECT
             DMI.MDSE_DESC_SHORT_TXT
            ,MIT.MDSE_ITEM_TP_NM
            ,MIC.MDSE_ITEM_CLS_TP_NM
          FROM
             MDSE               DMI
            ,MDSE_ITEM_TP       MIT
            ,MDSE_ITEM_CLS_TP   MIC
          WHERE
                DMI.GLBL_CMPY_CD = #glblCmpyCd#
            AND DMI.MDSE_CD      = #supdCd#
            AND DMI.EZCANCELFLAG = '0'
            
            AND DMI.GLBL_CMPY_CD        = MIT.GLBL_CMPY_CD(+)
            AND DMI.MDSE_ITEM_TP_CD     = MIT.MDSE_ITEM_TP_CD(+)
            AND MIT.EZCANCELFLAG(+)     = '0'
                    
            AND DMI.GLBL_CMPY_CD        = MIC.GLBL_CMPY_CD(+)
            AND DMI.MDSE_ITEM_CLS_TP_CD = MIC.MDSE_ITEM_CLS_TP_CD(+)
            AND MIC.EZCANCELFLAG(+)     = '0'
            
            AND ROWNUM           = 1
    </statement>
    <!-- ADD END 2016/02/22 QC#6176 -->
</sqlMap>
