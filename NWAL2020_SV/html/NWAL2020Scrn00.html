<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
	<meta http-equiv="x-ua-compatible" content="IE=EmulateIE7" >
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<!-- This file was auto created by Screen Definition Documentation Support Tool 4.0.0 . -->
<!-- Generated on:20160314222043                                               -->
	<link rel="stylesheet" type="text/css" href="css/common.css">
	<script type="text/javascript" src="js/common/common.js"			charset="UTF-8"></script>
	<script type="text/javascript" src="js/common/previewlayout.js"		charset="UTF-8"></script>
	<!-- Define Window Type  -->
	<!--ezd.windowTypeName = "popup"-->
	<!--ezd.openOption = "width=800,height=670,toolbar=no,location=yes,status=yes,menubar=no,resizable=no,scrollbars=no,top=0,left=0"-->
	<title></title>
</head>

<body onLoad="initForPreview(event);" onKeyDown="return keyCheck(event)">
	<!--  * Display Header Area  -->
	<div style="width:798px;height:25px; overflow:hidden;" >
		<table border="0" cellspacing="0" cellpadding="0" width="798" height="24" class="cPopupHeadCloth">
			<tr>
				<td style="width:30px;">
					&nbsp;
				</td>
				<td class="cDispid" style="width:110px;">
					<div id="pageIDArea"></div>
				</td>
				<td class="cDispname" style="width:390px;">
					<div id="pageNameArea"></div>
				</td>
				<td style="width:60px;">
				</td>
				<td class="cDate" style="width:70px;">
					<div id="defDate"></div>
				</td>
				<td class="cTime" style="width:70px;">
					<div id="defTime"></div>
				</td>
				<td>
				</td>
			</tr>
		</table>
	</div>

	<form name="mainForm" action="main" method="POST">

		<input type="hidden" name="focus" value="null">

		<!-- i18n start -->
		<input type="hidden" name="i18nCalendarType"   value="mdy">
		<input type="hidden" name="i18nMsgIDZZZM0003I" value="">
		<input type="hidden" name="i18nMsgIDZZZM0004I" value="">
		<!-- i18n end -->

		<!--  * Display Task Area  -->
		<div style="position:relative;left:2px;width:796px;height:566px;background:#fafafa;">
<!-- **** Do NOT Edit above this section **** -->

<!-- **** Task specific area starts here **** -->
<!--  For TCEPPS Start-->
<script type="text/javascript" src="./js/common/tcepps.js" charset="UTF-8"></script>
<%@page import="com.canon.usa.app.security.APPSecurityManager"%>
<%@page import="com.canon.usa.tcepps.security.TCEPPSSecurityManager"%>
<%@page import="com.canon.usa.tcepps.property.TCEPPSPropertyManager"%>
<%@page import="business.servlet.NWAL2020.NWAL2020BMsg" %>
<%@page import="parts.common.EZDSystemEnv" %>
<%
	int index = 0;
	NWAL2020BMsg scrnMsg 	= (NWAL2020BMsg)databean.getEZDBMsg();
	long tceppsTokenExp = Long.parseLong(scrnMsg.xxSrTsTxt_T.getValue());
	String tceppsApp	= scrnMsg.appNm_T.getValue();
	String tceppsToken	= (tceppsTokenExp > 0) ? TCEPPSSecurityManager.getInstance().generateToken(tceppsTokenExp) : "";
	String tceppsSign	= (tceppsTokenExp > 0) ? TCEPPSSecurityManager.getInstance().generateSign(tceppsToken, tceppsApp) : "";
	String tceppsUrl	= TCEPPSPropertyManager.getInstance().getTceppsUrl();
	String tceppsEncryptedRequest		= scrnMsg.xxGenlFldAreaTxt_T1.getValue();
	String tceppsEncryptedRequestkey	= scrnMsg.xxGenlFldAreaTxt_T2.getValue();
	String appToken						= scrnMsg.xxGenlFldAreaTxt_T3.getValue();
	String bgColor                      = EZDSystemEnv.getString("S21.mode.color");
	bgColor                             = (null == bgColor || 0 == bgColor.length()) ? "#FAFAFA" : bgColor;
	String enableNewCrCardFlag                 = "true";
	String appTokenName = APPSecurityManager.APP_TOKEN;
	session.setAttribute(appTokenName, appToken);

%>

<script>
s21TceppsUtil = {
	orgSendServer : null, // original sendServer function
	command : "",     // command name for sendServer
	tceppsCardFormPage : "", // [tceppsUrl]/jsp/creditCardFormPage.jsp
	tceppsCardFromIframe : "creditCardFormIFrame",
	ParamMap : {"tceppsEncryptedResponse": "tceppsEncryptedResponse", "tceppsEncryptedResponseKey" : "tceppsEncryptedResponseKey"},

	// setting hook Function before sendServer
	// hookEvtNames : hash (hookEventName)
	hookSendServer : function(hookEvtNames){
		if(!hookEvtNames) return;
		s21TceppsUtil.orgSendServer = sendServer;
		sendServer = function(param, num){
			if(num) s21TceppsUtil.number = num;
			var commandName = param;
			if(param.name != undefined){
				commandName = param.name;
			}
			if(!(commandName in hookEvtNames)){
				s21TceppsUtil.orgSendServer(param, num);
			}else{
				//alert(commandName);
				hookEvtNames[commandName]();
				s21TceppsUtil.command = param;
			}
		}
	},
	// return original "sendServer" Function
	postSendServer : function(){
		if(s21TceppsUtil.orgSendServer){
			try{
				s21TceppsUtil.orgSendServer(s21TceppsUtil.command, s21TceppsUtil.number);
			}catch(e){
				alert(e);
			}
			sendServer = s21TceppsUtil.orgSendServer;
			s21TceppsUtil.orgSendServer = null;
		}
	},
	// add TCEPPS Response to Main Form
	addTceppsResponseToForm : function(parameters){
		var tceppsResponce = document.getElementById("tceppsResponceForm");
		if(tceppsResponce){
			tceppsResponce.parentNode.removeChild(tceppsResponce);
		}
		tceppsResponce = document.createElement('div');
		tceppsResponce.style.display = "none";
		tceppsResponce.id = "tceppsResponceForm";

		try{
			for(key in parameters){
				if(key in s21TceppsUtil.ParamMap){
					var elm = document.createElement("input");
					elm.type = "hidden";
					elm.id = s21TceppsUtil.ParamMap[key];
					elm.name = s21TceppsUtil.ParamMap[key];
					elm.value = parameters[key];
					tceppsResponce.appendChild(elm);

				}
			}
			document.getElementsByName("mainForm")[0].appendChild(tceppsResponce);
		}catch(e){
			alert(e);
		}
	},
	// set CreditCardFrom to Iframe
	getIframePage : function(){
		var tcepps  = document.forms["tcepps"];
		tcepps.action = s21TceppsUtil.tceppsCardFormPage;
		tcepps.target = s21TceppsUtil.tceppsCardFromIframe;
		getCreditCardForm(
				tcepps
		);
	},
	// create element for cross browser
	createNamedElement : function(tag, name) {
		var isIE =/*@cc_on!@*/false;
		var element;
		if (name) {
			element = (isIE)? document.createElement('<' + tag + ' name="' + name + '">'): document.createElement(tag);
			element.name = name;
		} else {
			element = document.createElement(tag);
		}
		return element;
	},
	// append hidden input for cross browser
	appendNamedHiddenInput : function(form, name, value) {
		var hiddenInput = s21TceppsUtil.createNamedElement("input", name);
		hiddenInput.type = "hidden";
		hiddenInput.value = value;
		form.appendChild(hiddenInput);
	}
}

var forceSubmitToTCEPPS = false; // TODO Add logic to separate "profileAdd" or "newOrder_reversal"
var authorizeFunc = function(){
	if(document.getElementsByName("sellToCustCd")[0].value == ""){
		return;
	}

	var msgCd  = document.getElementById("msgCode");
	var msgFld = document.getElementById("msgfield");
	msgCd.innerText = "";
	msgFld.innerText = "";

	var tceppsProxy = document.forms["tceppsProxy"];
	tceppsProxy.serviceOperation.value = "profileAdd";

	invokeTceppsProxy(tceppsProxy);
}

// clear iFrame form
function clearForm (){
	var tceppsProxy = document.forms["tceppsProxy"];
	tceppsProxy.serviceOperation.value = "clearCreditCard";
	invokeTceppsProxy(tceppsProxy);
}
// put balloonTip for addressValidate
function putAddressValidate(){
	var tceppsProxy = document.forms["tceppsProxy"];
	tceppsProxy.serviceOperation.value = "addressValidate";
	invokeTceppsProxy(tceppsProxy);
}


var recordTceppsMessage = function(message){
	var tceppsErr = document.getElementById("tceppsErrForm");
	if(tceppsErr){
		tceppsErr.parentNode.removeChild(tceppsErr);
	}
	tceppsErr = document.createElement('div');
	tceppsErr.style.display = "none";
	tceppsErr.id = "tceppsErrForm";
	try{
		var elm = document.createElement("input");
		elm.type = "hidden";
		elm.id = "xxSrErrDescTxt_F";
		elm.name = "xxSrErrDescTxt_F";
		elm.value = message.substring(0, 99);
		tceppsErr.appendChild(elm);
		document.getElementsByName("mainForm")[0].appendChild(tceppsErr);
		s21TceppsUtil.orgSendServer("PA_RecordLog");
	}catch(e){
		alert(e);
	}
}

// This function is called when TCEPPS response success
function tceppsResponseSuccess(parameters) {
	if (parameters["tcepps.serviceOperation"] == "cancel") return;
	s21TceppsUtil.addTceppsResponseToForm(parameters);
	if(s21TceppsUtil.orgSendServer){
		s21TceppsUtil.postSendServer();
	}
}

//This function is called when TCEPPS response error
function tceppsResponseError(errorMessage) {
	if(errorMessage != "Failed to invoke TCEPPS Service." && !document.getElementById("tceppsProxyIframe")){
		// called by tceppsResponse and tceppsProxyIframe is not defined.
		var proxyIframe = document.createElement("form");
		proxyIframe.id = "tceppsProxyIframe";
		document.body.appendChild(proxyIframe);
	}
	
	if(errorMessage == "PaymentechNewOrderExecutionFailureException : Given information for the credit card is not valid."){ // TODO Add logic to addressValidate
		//forceSubmitToTCEPPS = true; // TODO Add logic to separate "profileAdd" or "newOrder_reversal"
		//setTimeout(function(){putAddressValidate()}, 20);
		errorMessage = "Given information for the credit card is not valid.";
	}else if(errorMessage == "SOAPFaultException : 839 Error validating card/account number checksum."){
		errorMessage = "Credit Card Account Number is invalid.";
	}
	//var msgCd  = document.getElementById("msgCode");
	//var msgFld = document.getElementById("msgfield");
	//msgCd.className = "cMsgI";
	//msgFld.className = "cMsgI";
	//msgCd.innerText = ""; // set message code here, if necessary
	//msgFld.innerText = errorMessage;
	// recordMessageToLog(errorMessage); // if necessary, please mount function
	if(null != errorMessage) {
		document.getElementsByName("xxRqstNumSrchTxt_T")[0].value = errorMessage;
	}

	s21TceppsUtil.orgSendServer("OnBlur_CreateCrditCard");
}

// Generate tcepps form
function generateTceppsForm() {
	var tcepps  = document.forms["tcepps"];
	if(!tcepps){
		var form = s21TceppsUtil.createNamedElement("form", "tcepps");
		form.method = "post";

		s21TceppsUtil.appendNamedHiddenInput(form, "app", "<%= tceppsApp %>");
		s21TceppsUtil.appendNamedHiddenInput(form, "token", "<%= tceppsToken %>");
		s21TceppsUtil.appendNamedHiddenInput(form, "sign", "<%= tceppsSign %>");
		s21TceppsUtil.appendNamedHiddenInput(form, "serviceOperation", "");
		s21TceppsUtil.appendNamedHiddenInput(form, "encryptedRequest", "<%= tceppsEncryptedRequest %>");
		s21TceppsUtil.appendNamedHiddenInput(form, "encryptedRequestKey", "<%= tceppsEncryptedRequestkey %>");
		s21TceppsUtil.appendNamedHiddenInput(form, "background-color", "<%= bgColor%>");
		s21TceppsUtil.appendNamedHiddenInput(form, "enableNewCrCardFlag", <%= enableNewCrCardFlag%>);
		s21TceppsUtil.appendNamedHiddenInput(form, "<%= appTokenName %>", "<%= appToken %>");

		document.body.appendChild(form);
	}
}
//Generate tceppsProxy Form
function generateTceppsProxy() {
	var tceppsProxy = document.forms["tceppsProxy"];
	if(!tceppsProxy){
		var form = s21TceppsUtil.createNamedElement("form", "tceppsProxy");
		form.action = "<%= tceppsUrl %>/jsp/creditCardFormProxy.jsp?tceppsApp=<%= tceppsApp %>";
		s21TceppsUtil.appendNamedHiddenInput(form, "serviceOperation", "");
		s21TceppsUtil.appendNamedHiddenInput(form, "addProfile", "");
		document.body.appendChild(form);
	}
}

(function(){
	// For NWAL2020 Credit tab
	var isCreditEntryAllowed = "<%= tceppsTokenExp > 0 %>";
	if (isCreditEntryAllowed != "true") return;

	var orgOnload = window.onload;
	window.onload = function(){
		if(orgOnload){
			orgOnload();
		}
		generateTceppsForm();
		generateTceppsProxy();
		var hookEvtNames = {"InsertNewCard" : authorizeFunc}; // assosiate EventName : hookFunction
		if(hookEvtNames){
			s21TceppsUtil.hookSendServer(hookEvtNames);
		}
		s21TceppsUtil.tceppsCardFormPage = "<%= tceppsUrl %>/jsp/creditCardFormPage.jsp?tceppsApp=<%= tceppsApp %>";
		s21TceppsUtil.getIframePage();
	}
})();
</script>
<!--  For TCEPPS End-->
			<!-- Set Page ID  -->
			<input type="hidden" name="pageID" value="NWAL2020Scrn00">
			<!-- Set Page Name -->
			<input type="hidden" name="pageName" value="Credit Card Entry">

<center>
	<table width="90%">
		<tr>
			<td valign="top">
				<div style="word-break:break-all">
					<table border="0" cellpadding="0" cellspacing="0" style="margin-top:200px;">
						<tr>
							<td style="word-break:keep-all;">
								<fieldset>
									<table style="table-layout:fixed;" height="152">
										<tr>
											<td>Account Code:<input type="text" name="sellToCustCd" ezfname="sellToCustCd" value="TRX_N5" size="15" ezftoupper></td>
										</tr>
										<tr>
											<td><ezf:inputHidden name="xxRqstNumSrchTxt_T" ezfName="xxRqstNumSrchTxt_T" /></td>
										</tr>
										<tr>
											<!--  credit card iframe -->
											<td rowspan="7">
												<div id="ccFrom">
													<c:set var="isCreditEntryAllowed" scope="page" value="<%= (0 < tceppsTokenExp) %>" />
													<c:if test="${isCreditEntryAllowed}" >
														<iframe name="creditCardFormIFrame" width="580px" height="115px" scrolling="no" frameBorder="0">
														</iframe>
													</c:if>
												</div>
											</td>
											<!--  credit card iframe -->
										</tr>
									</table>
								</fieldset>
							</td>
						</tr>
						<tr>
							<td align="right">
								<input type="button" class="pBtn10" value="Insert New Card" onclick="sendServer(this)" name="InsertNewCard">
							</td>
						</tr>
					</table>
				</div>
			</td>
		</tr>
	</table>
</center>

<!-- **** Task specific area ends here **** -->

<!-- **** Common area starts here **** -->
<script type="text/javascript">

//# ---------------------------------------------
//# Set Title (Displayed in the title bar)
//# ---------------------------------------------
var title = "Popup Screen";

//# ---------------------------------------------
//# User ID (Displayed in the header)
//# ---------------------------------------------
var userId = "UserID";

//# ---------------------------------------------
//# User Name (Displayed in the header)
//# ---------------------------------------------
var userName = "UserName";

//# ---------------------------------------------
//# Branch (Displayed in the header)
//# ---------------------------------------------
//#var branch = "D012345";

//# ---------------------------------------------
//# Department (Displayed in the header)
//# ---------------------------------------------
//#var department = "DEPARTNAME";

//# ---------------------------------------------
//# Message Display Area:Message Code
//#                      " " (Single Byte Blank) if not displayed
//# ---------------------------------------------
//var messageCode = "ZZM9037E";
var messageCode = "messageCode";

//# ---------------------------------------------
//# Message Area:Message
//# ---------------------------------------------
//var message = "Error message will be displayed in here.";
var message = "message";

//# ---------------------------------------------
//# Message Area:Message Type
//#                      0->Normal(Black)
//#                      1->Warning(Black)
//#                      2->Error(Red)
//# ---------------------------------------------
var messageType = 0;

//# ---------------------------------------------
//# Button Setting
//#  1st Parameter:Set Button Name
//#  2nd Parameter:Set Button Availability
//#                 0->Available
//#                 1->Not available(disabled)
//# ---------------------------------------------
//# Set Button 8 Area 
var button8 = ["Clear", 0];
//# Set Button 10 Area 
var button10 = ["Close", 0];

//#**********************************************************
//#Function Name:dspHeadHTML()
//#Functionality:Displays Page ID and Page Name 
//#Argument     :None
//#Return Code  :None
//#**********************************************************
function dspHeadHTML() {

	document.getElementById ("pageIDArea").innerHTML   = document.mainForm.pageID.value ;
	document.getElementById ("pageNameArea").innerHTML = document.mainForm.pageName.value;
	if(document.mainForm.focus.value != "null" ){
		document.mainForm[document.mainForm.focus.value].focus();
	}
	return true;
}

//#**********************************************************
//#Function Name:settingPopupHTML()
//#Functionality:Set Common Area (for the popup-template)
//#Argument     :None
//#Return Code  :None
//#**********************************************************
function settingPopupHTML(){

	document.title = title;
	nowDate = new Date();
	var w = nowDate.getYear();
	var m = nowDate.getMonth() + 1;
	var d = nowDate.getDate();
	var h = nowDate.getHours();
	var f = nowDate.getMinutes();
	var s = nowDate.getSeconds();

	if(m.toString().length == 1) m = "0" + m;
	if(d.toString().length == 1) d = "0" + d;
	if(h.toString().length == 1) h = "0" + h;
	if(f.toString().length == 1) f = "0" + f;
	if(s.toString().length == 1) s = "0" + s;

	document.getElementById ("defDate").innerText = m + "/" + d + "/" + (w+"").substring(2,4) + "";
	document.getElementById ("defTime").innerText = h + ":" + f + ":" + s;

	//Set Message Display Row
	var msgColor; //Message Display Color
	document.getElementById("msgCode").innerText = messageCode;
	document.getElementById("msgField").innerText = message;
	switch(messageType){
		case 0:
			msgColor = "black";
			break;
		case 1:
			msgColor = "black";
			break;
		case 2:
			msgColor = "red";
			break;
		default:
			msgColor = "black"
			break;
	}
	document.getElementById("msgCode").style.color = msgColor;
	document.getElementById("msgField").style.color = msgColor;
}

//#**********************************************************
//#Function Name:settingButton()
//#Functionality:Set Buttons in Common Area (for the main-template)
//#Argument     :None
//#Return Code  :None
//#**********************************************************
function settingButton(){
	//Set Buttons
	document.getElementById ("btn8").name = button8[0];
	document.getElementById ("btn10").name = button10[0];

	document.getElementById ("btn8").value = button8[0];
	document.getElementById ("btn10").value = button10[0];

	document.getElementById ("btn8").disabled = button8[1];
	document.getElementById ("btn10").disabled = button10[1];
}

//#**********************************************************
//#Function Name:addBalloonTipStyleSheet()
//#Functionality:Add Style Sheet for the Balloon Tip
//#Argument     :None
//#Return Code  :None
//#**********************************************************
//function addBalloonTipStyleSheet(){
//	if(isIE6()) {
//		appendCSS("./css/balloontip_ie6.css");
//	} else {
//		appendCSS("./css/balloontip.css");
//	}
//}

//#**********************************************************
//#Function Name:initForPreview()
//#Functionality:Initialization
//#Argument     :None
//#Return Code  :None
//#**********************************************************
function initForPreview(e) {
	//addBalloonTipStyleSheet();
	settingPopupHTML();
	settingButton();
	g_ezdDspAppOrder.executeOrder(e);
	dspHeadHTML();
}

</script>

<!-- **** Common area ends here **** -->

<!-- **** Do NOT Edit below this line **** -->
		</div>

		<!--  * Message Area  -->
		<table width="796px" border="0" cellspacing="0" height="22px" style="margin-left:2px;background:#fafafa;">
			<tr>
				<td align="center" valign="middle">
					<table border="1" cellpadding="0" cellspacing="0" width="80%" height="20px" class="cMsg">
					   <tr height="20px">
							<td class="cMsgCloth" width="15%"> 
								<span id="msgCode"></span>
							</td> 
							<td class="cMsgCloth" width="85%"> 
								<span id="msgfield"></span>
							</td>
					   </tr>
					</table>
				</td>
			</tr>
		</table>

		<!--  * Common Command Button Display Area  -->
		<table width="100%" height="28px" border="0" cellpadding="0" cellspacing="0" style="background-image:url('./img/commonbuttonbackground.png'); background-repeat:repeat-x;">
			<tr style="text-align:center;align:center;vertical-align:middle;" height="28px">
				<td>
					<table width="796px" border="0">
						<tr style="text-align: center">
							<td width="32%"></td>
							<td width="12%" class="cBtnCloth"><label ezfout>F8</label><input class="cBtn" type="button" id="btn8" name="btn8" value="btn8" onClick="sendServer(this)"></td>
							<td width="12%" class="cBtnCloth"><label ezfout>F10</label><input class="cBtn" type="button" id="btn10" name="btn10" value="btn10" onClick="sendServer(this)"></td>
							<td width="32%"></td>
						</tr>
					</table>
				</td>
			</tr>
		</table>
		
	</form>

</body>
</html>