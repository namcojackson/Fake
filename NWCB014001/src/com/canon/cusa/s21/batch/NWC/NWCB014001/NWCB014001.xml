<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NWCB014001">

    <statement id="getTargetConslBillPk" parameterClass="Map">
        SELECT 
             CBR.TRGT_CONSL_BILL_PK
            ,MAX(CASE WHEN CBR.CONSL_RGNR_ACT_TP_CD = '04' THEN 'Y' ELSE 'N' END) RETRANSMIT_FLG
            ,MAX(CASE WHEN CBR.CONSL_RGNR_ACT_TP_CD != '04' THEN 'Y' ELSE 'N' END) NOTRETRANSMIT_FLG
        FROM
             CONSL_BILL_RGNR    CBR
        WHERE
                CBR.GLBL_CMPY_CD        = #glblCmpyCd#
            AND CBR.CONSL_RGNR_PROC_CD  = #conslRgnrProcCd#
            AND CBR.CONSL_RGNR_PROC_DT  IS NULL
            AND CBR.EZCANCELFLAG        = '0'
        GROUP BY
            CBR.TRGT_CONSL_BILL_PK
        ORDER BY
            CBR.TRGT_CONSL_BILL_PK
    </statement>

    <statement id="getTargetConsolidatedBillData" parameterClass="Map" resultClass="Map">
        SELECT
             CBR.CONSL_BILL_RGNR_PK
            ,CBR.CONSL_RGNR_ACT_TP_CD
            ,CB.CONSL_BILL_PK
            ,CB.BILL_TO_CUST_ACCT_CD
            ,CB.BILL_TO_CUST_ACCT_NM
            ,CB.BILL_TO_CUST_CD
            ,CB.BILL_TO_CUST_LOC_NUM
            ,CB.CONSL_STS_CD
            ,CB.CONSL_PRINT_STS_CD
            ,CB.PMT_TERM_CD
            ,CB.CTOFF_DT
            ,CB.DUE_DT
            ,CB.CONSL_TOT_DEAL_NET_AMT
            ,CB.CONSL_TOT_FUNC_NET_AMT
            ,CB.CONSL_DUE_TOT_DEAL_NET_AMT
            ,CB.CONSL_DUE_TOT_FUNC_NET_AMT
            ,CB.CRAT_PGM_ID
            ,CB.CRAT_PSN_CD
            ,CB.CRAT_DT
            ,CB.PMT_TERM_CASH_DISC_CD
            ,CB.PMT_TERM_CASH_DISC_DESC_TXT
            <!-- START 2022/09/09 S.Naya [QC#60140,ADD] -->
            ,CB.ORIG_CONSL_BILL_PK
            <!-- END   2022/09/09 S.Naya [QC#60140,ADD] -->
            ,CBL.CONSL_BILL_LINE_NUM
            ,CBL.CONSL_BILL_TRX_ID
            ,CBL.CONSL_BILL_TRX_NUM
            ,CBL.CONSL_BILL_TRX_TP_CD
            ,CBL.CONSL_BILL_TRX_DT
            ,NVL(CBL.CONSL_TOT_DEAL_NET_AMT, 0)         LINE_TOT_DEAL_NET_AMT
            ,NVL(CBL.CONSL_TOT_FUNC_NET_AMT, 0)         LINE_TOT_FUNC_NET_AMT
            ,NVL(CBL.CONSL_DUE_TOT_DEAL_NET_AMT, 0)     LINE_DUE_TOT_DEAL_NET_AMT
            ,NVL(CBL.CONSL_DUE_TOT_FUNC_NET_AMT, 0)     LINE_DUE_TOT_FUNC_NET_AMT
            ,I.INV_NUM
            ,I.INV_TP_CD
            ,I.INV_DT
            ,I.INV_TOT_DEAL_NET_AMT
            ,I.INV_TOT_FUNC_NET_AMT
            ,NVL(ATB.DEAL_RMNG_BAL_GRS_AMT, 0)      DEAL_RMNG_BAL_GRS_AMT
            ,NVL(ATB.FUNC_RMNG_BAL_GRS_AMT, 0)      FUNC_RMNG_BAL_GRS_AMT
            ,CB.CUST_INV_SRC_CD
            ,CB.INV_GRP_NUM
            ,NVL(CB.EASY_PAC_FLG, 'N') EASY_PAC_FLG
        FROM
             CONSL_BILL_RGNR    CBR
            ,CONSL_BILL         CB
            ,CONSL_BILL_LINE    CBL
            ,INV                I
            ,AR_TRX_BAL         ATB
        WHERE
                CBR.GLBL_CMPY_CD        = #glblCmpyCd#
            AND CBR.TRGT_CONSL_BILL_PK  = #conslBillPk#
            AND CBR.EZCANCELFLAG        = '0'

            AND CB.GLBL_CMPY_CD         = CBR.GLBL_CMPY_CD
            AND CB.CONSL_BILL_PK        = CBR.TRGT_CONSL_BILL_PK
            AND CB.EZCANCELFLAG         = '0'

            AND CBL.GLBL_CMPY_CD (+)    = CBR.GLBL_CMPY_CD
            AND CBL.CONSL_BILL_PK (+)   = CBR.TRGT_CONSL_BILL_PK 
            AND CBL.CONSL_BILL_TRX_ID (+) = CBR.INV_NUM
            AND CBL.EZCANCELFLAG (+)    = '0'

            AND I.GLBL_CMPY_CD          = CBR.GLBL_CMPY_CD 
            AND I.INV_NUM               = CBR.INV_NUM
            AND I.EZCANCELFLAG          = '0'

            AND ATB.GLBL_CMPY_CD (+)    = I.GLBL_CMPY_CD
            AND ATB.AR_TRX_NUM (+)      = I.INV_NUM 
            AND ATB.EZCANCELFLAG (+)    = '0'

        UNION
        SELECT
             NULL
            ,NULL
            ,CB.CONSL_BILL_PK
            ,CB.BILL_TO_CUST_ACCT_CD
            ,CB.BILL_TO_CUST_ACCT_NM
            ,CB.BILL_TO_CUST_CD
            ,CB.BILL_TO_CUST_LOC_NUM
            ,CB.CONSL_STS_CD
            ,CB.CONSL_PRINT_STS_CD
            ,CB.PMT_TERM_CD
            ,CB.CTOFF_DT
            ,CB.DUE_DT
            ,CB.CONSL_TOT_DEAL_NET_AMT
            ,CB.CONSL_TOT_FUNC_NET_AMT
            ,CB.CONSL_DUE_TOT_DEAL_NET_AMT
            ,CB.CONSL_DUE_TOT_FUNC_NET_AMT
            ,CB.CRAT_PGM_ID
            ,CB.CRAT_PSN_CD
            ,CB.CRAT_DT
            ,CB.PMT_TERM_CASH_DISC_CD
            ,CB.PMT_TERM_CASH_DISC_DESC_TXT
            <!-- START 2022/09/09 S.Naya [QC#60140,ADD] -->
            ,CB.ORIG_CONSL_BILL_PK
            <!-- END   2022/09/09 S.Naya [QC#60140,ADD] -->
            ,CBL.CONSL_BILL_LINE_NUM
            ,CBL.CONSL_BILL_TRX_ID
            ,CBL.CONSL_BILL_TRX_NUM
            ,CBL.CONSL_BILL_TRX_TP_CD
            ,CBL.CONSL_BILL_TRX_DT
            ,NVL(CBL.CONSL_TOT_DEAL_NET_AMT, 0)         LINE_TOT_DEAL_NET_AMT
            ,NVL(CBL.CONSL_TOT_FUNC_NET_AMT, 0)         LINE_TOT_FUNC_NET_AMT
            ,NVL(CBL.CONSL_DUE_TOT_DEAL_NET_AMT, 0)     LINE_DUE_TOT_DEAL_NET_AMT
            ,NVL(CBL.CONSL_DUE_TOT_FUNC_NET_AMT, 0)     LINE_DUE_TOT_FUNC_NET_AMT
            ,CBL.CONSL_BILL_TRX_ID
            ,NULL
            ,NULL
            ,NULL
            ,NULL
            ,0                                          DEAL_RMNG_BAL_GRS_AMT
            ,0                                          FUNC_RMNG_BAL_GRS_AMT
            ,CB.CUST_INV_SRC_CD
            ,CB.INV_GRP_NUM
            ,NVL(CB.EASY_PAC_FLG, 'N') EASY_PAC_FLG
        FROM
             CONSL_BILL         CB
            ,CONSL_BILL_LINE    CBL
        WHERE
                CB.GLBL_CMPY_CD         = #glblCmpyCd#
            AND CB.CONSL_BILL_PK        = #conslBillPk#
            AND CB.EZCANCELFLAG         = '0'

            AND CBL.GLBL_CMPY_CD        = CB.GLBL_CMPY_CD
            AND CBL.CONSL_BILL_PK       = CB.CONSL_BILL_PK 
            AND CBL.EZCANCELFLAG        = '0'

            AND NOT EXISTS (
                SELECT
                    '1'
                FROM
                    CONSL_BILL_RGNR    CBR
                WHERE
                        CBR.GLBL_CMPY_CD        = CBL.GLBL_CMPY_CD
                    AND CBR.TRGT_CONSL_BILL_PK  = CBL.CONSL_BILL_PK
                    AND CBR.INV_NUM             = CBL.CONSL_BILL_TRX_ID
                    AND CBR.EZCANCELFLAG        = '0'
            )
        ORDER BY INV_NUM
    </statement>

    <statement id="getInvPrtCtrlByConslBillNum" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            INV_PRT_CTRL_PK
        FROM
            INV_PRT_CTRL
        WHERE
            GLBL_CMPY_CD    = #glblCmpyCd#
        AND CONSL_BILL_NUM  = #conslBillNum#
        AND INV_PRT_CTRL_REC_CD = 'BILL'
        AND EZCANCELFLAG    = '0'
    </statement>

    <statement id="getInvPrtHdrByConslBillNum" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            INV_PRT_CTRL_PK
        FROM
            INV_PRT_HDR
        WHERE
            GLBL_CMPY_CD    = #glblCmpyCd#
        AND INV_BILL_NUM    = #invBillNum#
        AND EZCANCELFLAG    = '0'
    </statement>

    <statement id="getInvPrtSmryByConslBillNum" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            INV_PRT_SMRY_PK
        FROM
            INV_PRT_SMRY
        WHERE
            GLBL_CMPY_CD    = #glblCmpyCd#
        AND INV_BILL_NUM    = #invBillNum#
        AND EZCANCELFLAG    = '0'
    </statement>

    <statement id="searchConslBillLineNetAmt" parameterClass="Map" resultClass="Map">
        SELECT
             CONSL_TOT_DEAL_NET_AMT
            ,CONSL_TOT_FUNC_NET_AMT
            ,CONSL_DUE_TOT_DEAL_NET_AMT
            ,CONSL_DUE_TOT_FUNC_NET_AMT
        FROM
            CONSL_BILL_LINE
        WHERE
            GLBL_CMPY_CD        = #glblCmpyCd#
        AND CONSL_BILL_PK       = #conslBillPk#
        AND CONSL_BILL_TRX_ID   = #invNum#
        AND EZCANCELFLAG        = '0'
    </statement>
    
    <statement id="searchConslBillGrpList" parameterClass="Map" resultClass="Map">
        SELECT 
             CBG.CONSL_BILL_GRP_PK
            ,CBG.DEF_INV_GRP_CD
            ,CBG.DEF_INV_GRP_TXT
        FROM
             CONSL_BILL_GRP    CBG
        WHERE
                CBG.GLBL_CMPY_CD        = #glblCmpyCd#
            AND CBG.CONSL_BILL_PK       = #conslBillPk#
            AND CBG.EZCANCELFLAG        = '0'
        ORDER BY
             CBG.CONSL_BILL_GRP_PK
    </statement>
    
    <!-- QC#17961 -->
    <statement id="getTargetInvPrtCtrl" parameterClass="Map" resultClass="Map">
        SELECT 
             IPC.INV_PRT_CTRL_PK
        FROM
             INV_PRT_CTRL    IPC
        WHERE
                IPC.GLBL_CMPY_CD        = #glblCmpyCd#
            AND IPC.EZCANCELFLAG        = '0'
            AND IPC.CONSL_BILL_NUM      = #conslBillPk#
        ORDER BY
             IPC.INV_PRT_CTRL_PK
    </statement>
    
    <statement id="getTargetConslBillRgnr" parameterClass="Map" resultClass="Map">
        SELECT 
             CBR.CONSL_BILL_RGNR_PK
        FROM
             CONSL_BILL_RGNR    CBR
        WHERE
                CBR.GLBL_CMPY_CD        = #glblCmpyCd#
            AND CBR.EZCANCELFLAG        = '0'
            AND CBR.TRGT_CONSL_BILL_PK  = #trgtConslBillPk#
        ORDER BY
             CBR.CONSL_BILL_RGNR_PK
    </statement>
    <!-- QC#18144 -->
    <statement id="getRelatedConslBillPk" parameterClass="Map" resultClass="Map">
        SELECT 
            DISTINCT TO_NUMBER(ceed.BILL_NUMBER) BILL_NUMBER
        FROM 
            canon_e479_excel_detail ceed, 
            canon_e479_excel_control ceec, 
            canon_E479_inv_Srch_Tbl srch
        WHERE 
            ceed.ref_id = ceec.ref_id 
        AND ceed.sequence_id = ceec.sequence_id 
        AND ceed.rectype = 'DETAIL' 
        and ceec.urn = srch.urn_number
        AND ( NVL (srch.REVIEW_REQUIRED, 'N') = 'N' OR ( NVL (srch.REVIEW_REQUIRED, 'N') = 'Y' 
        AND NVL (srch.PENDING_ACTION, 'Y') in ('R', 'S')))
        and ceec.urn in (
            SELECT
                DISTINCT URN_NUMBER
            FROM
                canon_e479_excel_detail ceed, 
                canon_e479_excel_control ceec, 
                canon_E479_inv_Srch_Tbl srch
            WHERE
                ceed.ref_id = ceec.ref_id 
            AND ceed.sequence_id = ceec.sequence_id 
            AND ceed.rectype = 'DETAIL' 
            and ceec.urn = srch.urn_number
            and ceed.bill_number = #conslBillPk#
            AND ( NVL (srch.REVIEW_REQUIRED, 'N') = 'N' OR ( NVL (srch.REVIEW_REQUIRED, 'N') = 'Y' 
            AND NVL (srch.PENDING_ACTION, 'Y') in ('R', 'S')))
         )
    </statement>
    <statement id="getConsolidatedinvoice" parameterClass="Map" resultClass="BigDecimal">
        SELECT 
            IPC.INV_PRT_CTRL_PK
        FROM 
            INV_PRT_CTRL IPC
        WHERE 
            IPC.GLBL_CMPY_CD        = #glblCmpyCd#
        AND IPC.EZCANCELFLAG        = '0'
        AND IPC.CONSL_BILL_NUM      = #conslBillNum#
        AND IPC.INV_PRT_CTRL_REC_CD != 'BILL'
    </statement>
</sqlMap>
