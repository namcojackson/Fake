<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NMAL7060Query">

    <typeAlias alias="NMAL7060SMsg"    type="business.blap.NMAL7060.NMAL7060SMsg"/>
    <typeAlias alias="NMAL7060_ASMsg"  type="business.blap.NMAL7060.NMAL7060_ASMsg"/>


    <statement id="getPrcMtrPkgMdl" parameterClass="Map" resultClass="Map">
        SELECT
            *
        FROM
            (SELECT
                PMP.PRC_MTR_PKG_PK                  AS PRC_MTR_PKG_PK
                ,PMP.PRC_MTR_PKG_NM                 AS PRC_MTR_PKG_NM
                ,PMP.PRC_MTR_PKG_DESC_TXT           AS PRC_MTR_PKG_DESC_TXT
                ,PMP.EFF_FROM_DT                    AS PMP_EFF_FROM_DT
                ,PMP.EFF_THRU_DT                    AS PMP_EFF_THRU_DT
                ,PMP.CORP_ADV_PRC_FLG               AS CORP_AD_PRC_FLG
                ,PMP.EZINTIME                       AS PMP_EZINTIME
                ,PMP.EZINTIMEZONE                   AS PMP_EZINTIMEZONE
                ,PMP.EZUPTIME                       AS PMP_EZUPTIME
                ,PMP.EZUPTIMEZONE                   AS PMP_EZUPTIMEZONE
                ,PMPM.PRC_MTR_PKG_MDL_PK            AS PRC_MTR_PKG_MDL_PK
                ,PMPM.MDL_ID                        AS MDL_ID
                ,PMPM.MDL_NM                        AS MDL_NM
                ,PMPM.EFF_FROM_DT                   AS PMPM_EFF_FROM_DT
                ,PMPM.EFF_THRU_DT                   AS PMPM_EFF_THRU_DT
                ,PMPM.EZINTIME                      AS EZINTIME
                ,PMPM.EZINTIMEZONE                  AS EZINTIMEZONE
                ,CASE
                     WHEN AP1.FIRST_NM IS NOT NULL THEN PMPM.EZINUSERID || '(' || AP1.FIRST_NM || ' ' || AP1.LAST_NM || ')'
                     ELSE PMPM.EZINUSERID
                 END EZINUSERNM
                ,PMPM.EZUPTIME                      AS EZUPTIME
                ,PMPM.EZUPTIMEZONE                  AS EZUPTIMEZONE
                ,CASE
                     WHEN AP2.FIRST_NM IS NOT NULL THEN PMPM.EZUPUSERID || '(' || AP2.FIRST_NM || ' ' || AP2.LAST_NM || ')'
                     ELSE PMPM.EZUPUSERID
                 END EZUPUSERNM
            FROM
                PRC_MTR_PKG      PMP
                ,PRC_MTR_PKG_MDL PMPM
                ,AUTH_PSN        AP1
                ,AUTH_PSN        AP2
            WHERE
                PMP.GLBL_CMPY_CD        = #glblCmpyCd#
            AND PMP.EZCANCELFLAG        = '0'
            <isNotNull property="prcMtrPkgPk">
            AND PMP.PRC_MTR_PKG_PK      = #prcMtrPkgPk#
            </isNotNull>
            <isNotNull property="prcMtrPkgNm">
            AND PMP.PRC_MTR_PKG_NM      = #prcMtrPkgNm#
            </isNotNull>
            AND PMPM.GLBL_CMPY_CD(+)    = #glblCmpyCd#
            AND PMPM.EZCANCELFLAG(+)    = '0'
            AND PMPM.PRC_MTR_PKG_PK(+)  = PMP.PRC_MTR_PKG_PK
            <!-- QC#17529 Add -->
            <isNotNull property="mdlNm">
            AND PMPM.MDL_NM             LIKE #mdlNm#
            </isNotNull>
            <isNotNull property="prcMtrPkgMdlPk">
            AND PMPM.PRC_MTR_PKG_MDL_PK &lt;&gt; #prcMtrPkgMdlPk#
            </isNotNull>
            <isNotNull property="effFromDt">
                <isNotNull property="effThruDt">
            AND ((PMPM.EFF_FROM_DT        &gt;= #effFromDt#
                AND PMPM.EFF_FROM_DT        &lt;= #effThruDt# )
            OR  (PMPM.EFF_THRU_DT        &gt;= #effFromDt#
                AND PMPM.EFF_THRU_DT        &lt;= #effThruDt# ))
                </isNotNull>
            </isNotNull>
            AND AP1.USR_NM(+)           = PMPM.EZINUSERID
            AND AP2.USR_NM(+)           = PMPM.EZUPUSERID
            ORDER BY
                PMPM.MDL_NM
                ,PMPM.EFF_FROM_DT)
        <!-- QC#17529 Mod -->
        <isNotNull property="rowNum">
        WHERE
            ROWNUM &lt;= #rowNum#
        </isNotNull>
    </statement>


    <statement id="getPrcMtrPkgBllgMtr" parameterClass="Map" resultClass="Map">
        SELECT
            *
        FROM
            (SELECT
                PMP.PRC_MTR_PKG_PK             AS PRC_MTR_PKG_PK
                ,PMP.PRC_MTR_PKG_NM            AS PRC_MTR_PKG_NM
                ,PMP.PRC_MTR_PKG_DESC_TXT      AS PRC_MTR_PKG_DESC_TXT
                ,PMP.EFF_FROM_DT               AS PMP_EFF_FROM_DT
                ,PMP.EFF_THRU_DT               AS PMP_EFF_THRU_DT
                ,PMP.CORP_ADV_PRC_FLG          AS CORP_AD_PRC_FLG
                ,PMP.EZINTIME                  AS PMP_EZINTIME
                ,PMP.EZINTIMEZONE              AS PMP_EZINTIMEZONE
                ,PMP.EZUPTIME                  AS PMP_EZUPTIME
                ,PMP.EZUPTIMEZONE              AS PMP_EZUPTIMEZONE
                ,PMPBM.PRC_MTR_PKG_BLLG_MTR_PK AS PRC_MTR_PKG_BLLG_MTR_PK
                ,PMPBM.MTR_LB_CD               AS MTR_LB_CD
                ,PMPBM.BLLG_MTR_LVL_NUM        AS BLLG_MTR_LVL_NUM
                ,PMPBM.MTR_LB_DESC_TXT         AS MTR_LB_DESC_TXT
                ,PMPBM.MTR_LB_NM               AS MTR_LB_NM
                ,PMPBM.MDSE_CD                 AS MDSE_CD
                ,PMPBM.EZUPTIME                AS PMPBM_EZUPTIME
                ,PMPBM.EZUPTIMEZONE            AS PMPBM_EZUPTIMEZONE
            FROM
                PRC_MTR_PKG           PMP
                ,PRC_MTR_PKG_BLLG_MTR PMPBM
            WHERE
                PMP.GLBL_CMPY_CD     = #glblCmpyCd#
            AND PMP.EZCANCELFLAG     = '0'
            <isNotNull property="prcMtrPkgPk">
            AND PMP.PRC_MTR_PKG_PK   = #prcMtrPkgPk#
            </isNotNull>
            <isNotNull property="prcMtrPkgNm">
            AND PMP.PRC_MTR_PKG_NM   = #prcMtrPkgNm#
            </isNotNull>
            AND PMPBM.GLBL_CMPY_CD   = #glblCmpyCd#
            AND PMPBM.EZCANCELFLAG   = '0'
            AND PMPBM.PRC_MTR_PKG_PK = PMP.PRC_MTR_PKG_PK
            ORDER BY
                PMPBM.MTR_LB_DESC_TXT
                ,PMPBM.BLLG_MTR_LVL_NUM)
        WHERE
            ROWNUM &lt;= #rowNum#
    </statement>


    <statement id="getRegisteredSelectHardMeter" parameterClass="Map" resultClass="Map">
        SELECT
            *
        FROM
            (SELECT
                PMPPM.PRC_MTR_PKG_BLLG_MTR_PK       AS PRC_MTR_PKG_BLLG_MTR_PK
                ,PMPPM.PRC_MTR_PKG_PHYS_MTR_PK      AS PRC_MTR_PKG_PHYS_MTR_PK
                ,PMPPM.MTR_LB_CD                    AS MTR_LB_CD
                ,ML.MTR_LB_DESC_TXT                 AS ML_MTR_LB_NM
                ,PMPPM.BLLBL_FLG                    AS BLLBL_FLG
                ,(SELECT
                    MAX(DMM.MTR_ENTRY_MND_FLG) AS MTR_ENTRY_MND_FLG
                FROM
                    DS_MDL DM
                    ,MTR_GRP MG
                    ,DS_MDL_MTR DMM
<!-- 2016.08.22 QC#13586 DEL    ,BLLG_MTR_MAP BMM  -->
                    ,MTR_LB ML
<!-- 2016.08.22 QC#13586 DEL    ,MTR_LB BLML -->
                    <!-- Mod Start 2017/02/15 QC#17529 -->
                    ,( 
                       SELECT
                             MN.T_GLBL_CMPY_CD
                           , MN.EZCANCELFLAG
                           , MN.T_MDL_ID 
                       FROM
                             MDL_NM MN
                           , PRC_MTR_PKG_MDL PMPM 
                       WHERE
                               MN.T_GLBL_CMPY_CD    = #glblCmpyCd# 
                           AND MN.EZCANCELFLAG      = '0' 
                           AND MN.T_GLBL_CMPY_CD    = PMPM.GLBL_CMPY_CD 
                           AND MN.EZCANCELFLAG      = PMPM.EZCANCELFLAG 
                           AND MN.T_MDL_ID          = PMPM.MDL_ID 
                           <isNotNull property="prcMtrPkgPk">
                           AND (PMPM.PRC_MTR_PKG_PK = #prcMtrPkgPk# 
                           </isNotNull>
                           <isNotNull property="mdlNmExist">
                           <isNotNull property="prcMtrPkgPk">
                           OR 
                           </isNotNull>
                           <isNull property="prcMtrPkgPk">
                           AND 
                           </isNull>
                           <iterate property="mdlNmList" var="mdlNm[]" open=" MN.T_MDL_NM IN (" close=")" conjunction= ", " >
                               #mdlNm[]#
                           </iterate>
                           </isNotNull>
                           <isNotNull property="prcMtrPkgPk">
                            )
                           </isNotNull>
                     ) M 
                    <!-- Mod End 2017/02/15 QC#17529 -->
                WHERE
                    DM.GLBL_CMPY_CD = #glblCmpyCd#
                AND DM.EZCANCELFLAG = '0'
                <!-- Dell 2017/02/15 QC#17529
                <iterate property="mdlNmList" var="mdlNm[]" open="AND  M.T_MDL_NM IN (" close=")" conjunction= ", " >
                    #mdlNm[]#
                </iterate>
                -->
                AND MG.GLBL_CMPY_CD      = #glblCmpyCd#
                AND MG.EZCANCELFLAG      = '0'
                AND MG.MTR_GRP_PK        = DM.MTR_GRP_PK
                AND DM.GLBL_CMPY_CD      = M.T_GLBL_CMPY_CD
                AND DM.EZCANCELFLAG      = M.EZCANCELFLAG
                AND DM.MDL_ID            = M.T_MDL_ID
                AND DMM.GLBL_CMPY_CD     = #glblCmpyCd#
                AND DMM.EZCANCELFLAG     = '0'
                AND DMM.MTR_GRP_PK       = MG.MTR_GRP_PK
                AND DMM.MDL_MTR_LB_CD    = PMPPM.MTR_LB_CD 
                GROUP BY
                    DMM.MDL_MTR_LB_CD
                    ,DMM.MDL_MTR_LB_NOTE_TXT)       AS MTR_ENTRY_MND_FLG
                ,PMPPM.ACTV_FLG                     AS ACTV_FLG
                ,PMPPM.MTR_MULT_RATE                AS MTR_MULT_RATE
                ,PMPPM.EZINTIME                     AS EZINTIME
                ,PMPPM.EZINTIMEZONE                 AS EZINTIMEZONE
                ,AP1.FIRST_NM || ' ' || AP1.LAST_NM AS EZINUSERNM
                ,PMPPM.EZUPTIME                     AS EZUPTIME
                ,PMPPM.EZUPTIMEZONE                 AS EZUPTIMEZONE
                ,AP2.FIRST_NM || ' ' || AP2.LAST_NM AS EZUPUSERNM
            FROM
                PRC_MTR_PKG_PHYS_MTR PMPPM
                ,MTR_LB              ML
                ,AUTH_PSN            AP1
                ,AUTH_PSN            AP2
            WHERE
                PMPPM.GLBL_CMPY_CD            = #glblCmpyCd#
            AND PMPPM.EZCANCELFLAG            = '0'
            AND PMPPM.PRC_MTR_PKG_BLLG_MTR_PK = #prcMtrPkgBllgMtrPk#
            AND ML.GLBL_CMPY_CD(+)            = #glblCmpyCd#
            AND ML.EZCANCELFLAG(+)            = '0'
            AND ML.MTR_LB_TP_CD               = #RegularMeter#
            AND PMPPM.MTR_LB_CD               = ML.MTR_LB_CD(+)
            AND AP1.GLBL_CMPY_CD(+)           = PMPPM.GLBL_CMPY_CD
            AND AP1.EZCANCELFLAG(+)           = '0'
            AND PMPPM.EZINUSERID              = AP1.USR_NM(+)
            AND AP2.GLBL_CMPY_CD(+)           = PMPPM.GLBL_CMPY_CD
            AND AP2.EZCANCELFLAG(+)           = '0'
            AND PMPPM.EZUPUSERID              = AP2.USR_NM(+)
            ORDER BY
                PMPPM.MTR_LB_CD
                ,ML.MTR_LB_DESC_TXT
                ,PMPPM.BLLBL_FLG)
        WHERE
            ROWNUM &lt;= #rowNum#
    </statement>

    <statement id="getUnregisteredSelectHardMeter" parameterClass="Map" resultClass="Map">
        SELECT
            *
        FROM
            (SELECT
                DMM.MDL_MTR_LB_CD           AS PHYS_MTR_LB_CD
                ,DMM.MDL_MTR_LB_NOTE_TXT    AS MDL_MTR_LB_NOTE_TXT
                ,MAX(DMM.MTR_ENTRY_MND_FLG) AS BLLG_MTR_AVAL_FLG
                ,MAX(DMM.MTR_ENTRY_MND_FLG) AS MTR_ENTRY_MND_FLG
                ,MAX(DMM.ACTV_FLG)          AS ACTV_FLG
                ,MAX(DMM.MTR_MULT_RATE)     AS MTR_MULT_RATE
            FROM
                DS_MDL DM
                ,MTR_GRP MG
                ,DS_MDL_MTR DMM
                ,BLLG_MTR_MAP BMM
                ,MTR_LB ML
                ,MTR_LB BLML
	            <!-- Mod Start 2017/02/15 QC#17529 -->
                ,( 
                   SELECT
                         MN.T_GLBL_CMPY_CD
                       , MN.EZCANCELFLAG
                       , MN.T_MDL_ID 
                   FROM
                         MDL_NM MN
                       , PRC_MTR_PKG_MDL PMPM 
                   WHERE
                           MN.T_GLBL_CMPY_CD   = #glblCmpyCd# 
                       AND MN.EZCANCELFLAG     = '0' 
                       AND MN.T_GLBL_CMPY_CD   = PMPM.GLBL_CMPY_CD 
                       AND MN.EZCANCELFLAG     = PMPM.EZCANCELFLAG 
                       AND MN.T_MDL_ID         = PMPM.MDL_ID 
                       <isNotNull property="prcMtrPkgPk">
                       AND (PMPM.PRC_MTR_PKG_PK = #prcMtrPkgPk#
                       </isNotNull>
                       <isNotNull property="mdlNmExist">
                       <isNotNull property="prcMtrPkgPk">
                       OR 
                       </isNotNull>
                       <isNull property="prcMtrPkgPk">
                       AND 
                       </isNull>
                       <iterate property="mdlNmList" var="mdlNm[]" open=" MN.T_MDL_NM IN (" close=")" conjunction= ", " >
                           #mdlNm[]#
                       </iterate>
                       </isNotNull>
                       <isNotNull property="prcMtrPkgPk">
                        )
                       </isNotNull>
                 ) M 
                <!-- Mod End 2017/02/15 QC#17529 -->
            WHERE
                DM.GLBL_CMPY_CD = #glblCmpyCd#
            AND DM.EZCANCELFLAG = '0'
            <!-- Dell 2017/02/15 QC#17529
            <iterate property="mdlNmList" var="mdlNm[]" open="AND  M.T_MDL_NM IN (" close=")" conjunction= ", " >
                #mdlNm[]#
            </iterate>
            -->
            AND MG.GLBL_CMPY_CD        = #glblCmpyCd#
            AND MG.EZCANCELFLAG        = '0'
            AND MG.MTR_GRP_PK          = DM.MTR_GRP_PK
	        AND DM.GLBL_CMPY_CD        = M.T_GLBL_CMPY_CD
	        AND DM.EZCANCELFLAG        = M.EZCANCELFLAG
	        AND DM.MDL_ID              = M.T_MDL_ID
            AND DMM.GLBL_CMPY_CD       = #glblCmpyCd#
            AND DMM.EZCANCELFLAG       = '0'
            AND DMM.MTR_GRP_PK         = MG.MTR_GRP_PK
            AND BMM.GLBL_CMPY_CD       = #glblCmpyCd#
            AND BMM.EZCANCELFLAG       = '0'
            AND BMM.MDL_MTR_LB_CD      = DMM.MDL_MTR_LB_CD
            <!-- Add Start 2017/08/14 QC#18195 -->
            AND BMM.MTR_GRP_PK         = DMM.MTR_GRP_PK
            <!-- Add End 2017/08/14 QC#18195 -->
            AND BMM.ACTV_FLG           = #actvFlgY#
            AND BMM.EFF_FROM_DT        &lt;= #salesDate#
            AND (BMM.EFF_THRU_DT       &gt;= #salesDate#
                OR  BMM.EFF_THRU_DT    IS NULL)
            AND ML.GLBL_CMPY_CD(+)     = #glblCmpyCd#
            AND ML.EZCANCELFLAG(+)     = '0'
            AND BMM.MDL_MTR_LB_CD      = ML.MTR_LB_CD(+)
            AND ML.ACTV_FLG(+)         = #actvFlgY#
            AND ML.EFF_FROM_DT(+)      &lt;= #salesDate#
            AND (ML.EFF_THRU_DT(+)     &gt;= #salesDate#
                OR  ML.EFF_THRU_DT(+)  IS NULL)
            AND BLML.GLBL_CMPY_CD(+)   = #glblCmpyCd#
            AND BLML.EZCANCELFLAG(+)   = '0'
            AND BMM.BLLG_MTR_LB_CD     = BLML.MTR_LB_CD(+)
            <isNotNull property="mtrLbDescTxt">
            AND BLML.MTR_LB_DESC_TXT   = #mtrLbDescTxt#
            </isNotNull>
            GROUP BY
                DMM.MDL_MTR_LB_CD
                ,DMM.MDL_MTR_LB_NOTE_TXT
            ORDER BY
                PHYS_MTR_LB_CD
                ,MDL_MTR_LB_NOTE_TXT
                ,BLLG_MTR_AVAL_FLG)
        WHERE
            ROWNUM &lt;= #rowNum#
    </statement>

    <statement id="getPackageName" parameterClass="Map" resultClass="Map">
        SELECT
            PMP.PRC_MTR_PKG_NM AS PRC_MTR_PKG_NM
            , PMP.PRC_MTR_PKG_PK AS PRC_MTR_PKG_PK
        FROM
            PRC_MTR_PKG PMP
        WHERE
            PMP.GLBL_CMPY_CD = #glblCmpyCd#
        AND PMP.EZCANCELFLAG = '0'
        AND PMP.PRC_MTR_PKG_NM = #prcMtrPkgNm#
    </statement>

    <statement id="getModelName" parameterClass="Map" resultClass="Map">
        SELECT
            DM.MDL_ID AS MDL_ID
            ,DM.MDL_DESC_TXT AS MDL_DESC_TXT
            ,DM.MTR_GRP_PK   AS MTR_GRP_PK
            ,M.T_MDL_NM
        FROM
            DS_MDL DM
           ,MDL_NM M
        WHERE
            DM.GLBL_CMPY_CD = #glblCmpyCd#
        AND DM.EZCANCELFLAG = '0'
        AND DM.GLBL_CMPY_CD = M.T_GLBL_CMPY_CD
        AND DM.EZCANCELFLAG = M.EZCANCELFLAG
        AND DM.MDL_ID = M.T_MDL_ID
        <iterate property="mdlNmList" var="mdlNm[]" open="AND M.T_MDL_NM IN ( " close=" )" conjunction= ", " >
            #mdlNm[]#
        </iterate>
        <!-- START 2023/01/30 R.Avelino [QC#61336, DEL] -->
        <!-- AND DM.MDL_ACTV_FLG = 'Y' -->
        <!-- END 2023/01/30 R.Avelino [QC#61336, DEL] -->
    </statement>

    <statement id="getBillingMeterName" parameterClass="Map" resultClass="Map">
        SELECT DISTINCT
            BMM.BLLG_MTR_LB_CD
            ,BMM.BLLG_MTR_MAP_LVL_NUM
            ,BLML.MTR_LB_DESC_TXT AS MTR_LB_DESC_TXT
        FROM
            DS_MDL        DM
            ,MTR_GRP      MG
            ,DS_MDL_MTR   DMM
            ,BLLG_MTR_MAP BMM
            ,MTR_LB       ML
            ,MTR_LB       BLML
            <!-- Mod Start 2017/02/15 QC#17529 -->
            ,( 
               SELECT
                     MN.T_GLBL_CMPY_CD
                   , MN.EZCANCELFLAG
                   , MN.T_MDL_ID 
               FROM
                     MDL_NM MN
                   , PRC_MTR_PKG_MDL PMPM 
               WHERE
                       MN.T_GLBL_CMPY_CD   = #glblCmpyCd# 
                   AND MN.EZCANCELFLAG     = '0' 
                   AND MN.T_GLBL_CMPY_CD   = PMPM.GLBL_CMPY_CD 
                   AND MN.EZCANCELFLAG     = PMPM.EZCANCELFLAG 
                   AND MN.T_MDL_ID         = PMPM.MDL_ID 
                   <isNotNull property="prcMtrPkgPk">
                   AND (PMPM.PRC_MTR_PKG_PK = #prcMtrPkgPk#
                   </isNotNull>
                   <isNotNull property="mdlNmExist">
                   <isNotNull property="prcMtrPkgPk">
                   OR 
                   </isNotNull>
                   <isNull property="prcMtrPkgPk">
                   AND 
                   </isNull>
                   <iterate property="mdlNmList" var="mdlNm[]" open=" MN.T_MDL_NM IN (" close=")" conjunction= ", " >
                       #mdlNm[]#
                   </iterate>
                   </isNotNull>
                   <isNotNull property="prcMtrPkgPk">
                    )
                   </isNotNull>
             ) M 
            <!-- Mod End 2017/02/15 QC#17529 -->
        WHERE
            DM.GLBL_CMPY_CD      = #glblCmpyCd#
        AND DM.EZCANCELFLAG      = '0'
        <!-- Dell 2017/02/15 QC#17529
        <iterate property="mdlNmList" var="mdlNm[]" open="AND M.T_MDL_NM IN ( " close=" )" conjunction= ", " >
            #mdlNm[]#
        </iterate>
        -->
        AND MG.GLBL_CMPY_CD       = #glblCmpyCd#
        AND MG.EZCANCELFLAG       = '0'
        AND DM.MTR_GRP_PK         = MG.MTR_GRP_PK
        AND DMM.GLBL_CMPY_CD      = #glblCmpyCd#
        AND DMM.EZCANCELFLAG      = '0'
        AND DM.GLBL_CMPY_CD       = M.T_GLBL_CMPY_CD
        AND DM.EZCANCELFLAG       = M.EZCANCELFLAG
        AND DM.MDL_ID             = M.T_MDL_ID
        AND MG.MTR_GRP_PK         = DMM.MTR_GRP_PK
        AND BMM.GLBL_CMPY_CD      = #glblCmpyCd#
        AND BMM.EZCANCELFLAG      = '0'
        AND DMM.MDL_MTR_LB_CD     = BMM.MDL_MTR_LB_CD
        <!-- Add Start 2017/08/14 QC#18195 -->
        AND DMM.MTR_GRP_PK        = BMM.MTR_GRP_PK
        <!-- Add End 2017/08/14 QC#18195 -->
        AND BMM.ACTV_FLG          = #actvFlgY#
        AND BMM.EFF_FROM_DT       &lt;= #salesDate#
        AND (BMM.EFF_THRU_DT      &gt;= #salesDate#
            OR  BMM.EFF_THRU_DT   IS NULL)
        AND ML.GLBL_CMPY_CD(+)    = #glblCmpyCd#
        AND ML.EZCANCELFLAG(+)    = '0'
        AND BMM.MDL_MTR_LB_CD     = ML.MTR_LB_CD(+)
        AND ML.ACTV_FLG(+)        = #actvFlgY#
        AND ML.EFF_FROM_DT(+)     &lt;= #salesDate#
        AND (ML.EFF_THRU_DT(+)    &gt;= #salesDate#
            OR  ML.EFF_THRU_DT(+) IS NULL)
        AND BLML.GLBL_CMPY_CD(+)  = #glblCmpyCd#
        AND BLML.EZCANCELFLAG(+)  = '0'
        AND BMM.BLLG_MTR_LB_CD    = BLML.MTR_LB_CD(+)
        <iterate property="bllgMtrNmList" var="bllgMtrNm[]" open="AND (( " close=" ))" conjunction= ") OR (" >
                BLML.MTR_LB_DESC_TXT               = #bllgMtrNm[]#
            AND BLML.EFF_FROM_DT                   &lt;= #salesDate#
            AND NVL(BLML.EFF_THRU_DT, #highValDt#) &gt;= #salesDate#
        </iterate>
        ORDER BY
            BMM.BLLG_MTR_LB_CD
            ,BMM.BLLG_MTR_MAP_LVL_NUM
    </statement>

    <statement id="getSameLevelBillingMeter" parameterClass="Map" resultClass="Map">
        SELECT DISTINCT
            BMM.BLLG_MTR_LB_CD
        FROM
            DS_MDL        DM
            ,MTR_GRP      MG
            ,DS_MDL_MTR   DMM
            ,BLLG_MTR_MAP BMM
            ,MTR_LB       ML
            ,MTR_LB       BLML
        WHERE
            DM.GLBL_CMPY_CD          = #glblCmpyCd#
        AND DM.EZCANCELFLAG          = '0'
        <iterate property="mdlIdList" var="mdlId[]" open="AND DM.MDL_ID IN ( " close=" )" conjunction= ", " >
            #mdlId[]#
        </iterate>
        AND MG.GLBL_CMPY_CD          = #glblCmpyCd#
        AND MG.EZCANCELFLAG          = '0'
        AND DM.MTR_GRP_PK            = MG.MTR_GRP_PK
        AND DMM.GLBL_CMPY_CD         = #glblCmpyCd#
        AND DMM.EZCANCELFLAG         = '0'
        AND MG.MTR_GRP_PK            = DMM.MTR_GRP_PK
        AND BMM.GLBL_CMPY_CD         = #glblCmpyCd#
        AND BMM.EZCANCELFLAG         = '0'
        AND DMM.MDL_MTR_LB_CD        = BMM.MDL_MTR_LB_CD
        AND BMM.BLLG_MTR_MAP_LVL_NUM = #bllgMtrLvlNum#
        AND BMM.ACTV_FLG             = #actvFlgY#
        AND BMM.EFF_FROM_DT          &lt;= #salesDate#
        AND (BMM.EFF_THRU_DT         &gt;= #salesDate#
            OR  BMM.EFF_THRU_DT      IS NULL)
        AND ML.GLBL_CMPY_CD          = #glblCmpyCd#
        AND ML.EZCANCELFLAG          = '0'
        AND BMM.MDL_MTR_LB_CD        = ML.MTR_LB_CD(+)
        AND ML.ACTV_FLG              = #actvFlgY#
        AND ML.EFF_FROM_DT           &lt;= #salesDate#
        AND (ML.EFF_THRU_DT          &gt;= #salesDate#
            OR  ML.EFF_THRU_DT       IS NULL)
        AND ML.GLBL_CMPY_CD          = #glblCmpyCd#
        AND ML.EZCANCELFLAG          = '0'
        AND BMM.MDL_MTR_LB_CD        = ML.MTR_LB_CD(+)
        AND ML.ACTV_FLG              = #actvFlgY#
        AND ML.EFF_FROM_DT           &lt;= #salesDate#
        AND (ML.EFF_THRU_DT          &gt;= #salesDate#
            OR  ML.EFF_THRU_DT       IS NULL)
        AND BLML.GLBL_CMPY_CD(+)     = #glblCmpyCd#
        AND BLML.EZCANCELFLAG(+)     = '0'
        AND BMM.BLLG_MTR_LB_CD       = BLML.MTR_LB_CD(+)
        AND BLML.ACTV_FLG            = #actvFlgY#
        AND BLML.EFF_FROM_DT         &lt;= #salesDate#
        AND (BLML.EFF_THRU_DT        &gt;= #salesDate#
            OR  BLML.EFF_THRU_DT     IS NULL)
    </statement>

    <statement id="getCommonCounter" parameterClass="Map" resultClass="Map">
    SELECT
        TMP.BLLG_MTR_LB_CD
    FROM
        (SELECT DISTINCT
            DM.MDL_ID
            ,BMM.BLLG_MTR_LB_CD
        FROM
            DS_MDL        DM
            ,MTR_GRP      MG
            ,DS_MDL_MTR   DMM
            ,BLLG_MTR_MAP BMM
            ,MTR_LB       ML
            ,MTR_LB       BLML
        WHERE
            DM.GLBL_CMPY_CD          = #glblCmpyCd#
        AND DM.EZCANCELFLAG          = '0'
        <iterate property="mdlIdList" var="mdlId[]" open="AND DM.MDL_ID IN ( " close=" )" conjunction= ", " >
            #mdlId[]#
        </iterate>

        AND DM.GLBL_CMPY_CD          = MG.GLBL_CMPY_CD
        AND MG.EZCANCELFLAG          = '0'
        AND DM.MTR_GRP_PK            = MG.MTR_GRP_PK

        AND DM.GLBL_CMPY_CD          = DMM.GLBL_CMPY_CD
        AND DMM.EZCANCELFLAG         = '0'
        AND MG.MTR_GRP_PK            = DMM.MTR_GRP_PK

        AND DM.GLBL_CMPY_CD          = BMM.GLBL_CMPY_CD
        AND BMM.EZCANCELFLAG         = '0'
        AND DMM.MDL_MTR_LB_CD        = BMM.MDL_MTR_LB_CD
        <isNotNull property="bllgMtrLvlNum">
        AND BMM.BLLG_MTR_MAP_LVL_NUM = #bllgMtrLvlNum#
        </isNotNull>
        AND BMM.ACTV_FLG             = #actvFlgY#
        AND BMM.EFF_FROM_DT          &lt;= #salesDate#
        AND (BMM.EFF_THRU_DT         &gt;= #salesDate#
            OR  BMM.EFF_THRU_DT      IS NULL)
        AND ML.GLBL_CMPY_CD          = #glblCmpyCd#
        AND ML.EZCANCELFLAG          = '0'
        AND BMM.MDL_MTR_LB_CD        = ML.MTR_LB_CD(+)
        AND ML.ACTV_FLG              = #actvFlgY#
        AND ML.EFF_FROM_DT           &lt;= #salesDate#
        AND (ML.EFF_THRU_DT          &gt;= #salesDate#
            OR  ML.EFF_THRU_DT       IS NULL)
        AND ML.GLBL_CMPY_CD          = #glblCmpyCd#
        AND ML.EZCANCELFLAG          = '0'
        AND BMM.MDL_MTR_LB_CD        = ML.MTR_LB_CD(+)
        AND ML.ACTV_FLG              = #actvFlgY#
        AND ML.EFF_FROM_DT           &lt;= #salesDate#
        AND (ML.EFF_THRU_DT          &gt;= #salesDate#
            OR  ML.EFF_THRU_DT       IS NULL)
        AND BLML.GLBL_CMPY_CD(+)     = #glblCmpyCd#
        AND BLML.EZCANCELFLAG(+)     = '0'
        AND BMM.BLLG_MTR_LB_CD       = BLML.MTR_LB_CD(+)
        AND BLML.ACTV_FLG            = #actvFlgY#
        AND BLML.EFF_FROM_DT         &lt;= #salesDate#
        AND (BLML.EFF_THRU_DT        &gt;= #salesDate#
            OR  BLML.EFF_THRU_DT     IS NULL)
        ) TMP
    GROUP BY
        TMP.BLLG_MTR_LB_CD
    HAVING
        COUNT(TMP.BLLG_MTR_LB_CD) = #mdlCnt#
    </statement>

    <statement id="getBllgMtrFromMdl" parameterClass="Map" resultClass="Map">
        SELECT DISTINCT
            BMM.BLLG_MTR_MAP_LVL_NUM
            ,BMM.BLLG_MTR_LB_CD
            ,BLML.MTR_LB_DESC_TXT
            ,BMM.GLBL_CMPY_CD
            ,BMM.EZCANCELFLAG
            ,BLML.MTR_LB_NM
            ,BLML.INTG_MDSE_CD
        FROM
            DS_MDL DM
            ,MTR_GRP MG
            ,DS_MDL_MTR DMM
            ,BLLG_MTR_MAP BMM
            ,MTR_LB ML
            ,MTR_LB BLML
        WHERE
            DM.GLBL_CMPY_CD      = #glblCmpyCd#
        AND DM.MDL_ID            = #mdlId#
        AND DM.EZCANCELFLAG      = '0'
        AND DM.GLBL_CMPY_CD      = MG.GLBL_CMPY_CD
        AND DM.MTR_GRP_PK        = MG.MTR_GRP_PK
        AND MG.EZCANCELFLAG      = '0'
        AND MG.GLBL_CMPY_CD      = DMM.GLBL_CMPY_CD
        AND MG.MTR_GRP_PK        = DMM.MTR_GRP_PK
        AND DMM.EZCANCELFLAG     = '0'
        AND DMM.GLBL_CMPY_CD     = BMM.GLBL_CMPY_CD
        AND DMM.MDL_MTR_LB_CD    = BMM.MDL_MTR_LB_CD
        AND BMM.ACTV_FLG         = #actvFlgY#
        AND BMM.EFF_FROM_DT      &lt;= #slsDt#
        AND (
                BMM.EFF_THRU_DT  &gt;= #slsDt#
            OR  BMM.EFF_THRU_DT  IS NULL
            )
        AND BMM.EZCANCELFLAG     = '0'
        AND BMM.GLBL_CMPY_CD      = ML.GLBL_CMPY_CD(+)
        AND BMM.MDL_MTR_LB_CD    = ML.MTR_LB_CD(+)
        AND ML.ACTV_FLG          = #actvFlgY#
        AND ML.EFF_FROM_DT       &lt;= #slsDt#
        AND (
                ML.EFF_THRU_DT   &gt;= #slsDt#
            OR  ML.EFF_THRU_DT   IS NULL
            )
        AND ML.EZCANCELFLAG(+)   = '0'
        AND BMM.GLBL_CMPY_CD     = BLML.GLBL_CMPY_CD(+)
        AND BMM.BLLG_MTR_LB_CD   = BLML.MTR_LB_CD(+)
        AND BLML.ACTV_FLG        = #actvFlgY#
        AND BLML.EFF_FROM_DT     &lt;= #slsDt#
        AND (
                BLML.EFF_THRU_DT &gt;= #slsDt#
            OR  BLML.EFF_THRU_DT IS NULL
            )
        AND BLML.EZCANCELFLAG(+) = '0'
        order by
            BMM.BLLG_MTR_LB_CD
            ,BMM.BLLG_MTR_MAP_LVL_NUM
    </statement>
</sqlMap>
