<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NFCL3080Query">

    <typeAlias alias="NFCL3080_ASMsg"  type="business.blap.NFCL3080.NFCL3080_ASMsg"/>

<statement id="getOrgInvNum" parameterClass="Map" resultClass="Integer">
        SELECT
               COUNT(*) AS ORG_CNT
            FROM
	           INV I
	        WHERE
	           I.GLBL_CMPY_CD                      = #glblCmpyCd#
	           <isNotNull property="invNum">
	           AND I.INV_NUM                       = #invNum#
	           AND I.ORIG_INV_NUM                  IS NOT NULL
	           </isNotNull>
	           AND I.EZCANCELFLAG                  = '0'
    </statement>

<statement id="getSvcInvNum" parameterClass="Map" resultClass="Integer">
        SELECT
               COUNT(*) AS SVC_CNT
            FROM
	           SVC_INV SI
	        WHERE
	           SI.GLBL_CMPY_CD                     = #glblCmpyCd#
	           AND SI.SVC_INV_NUM                  = #invNum#
	           AND SI.EZCANCELFLAG                 = '0'
    </statement>

    <statement id="getMeterList" parameterClass="Map" resultMap="result.getMeterList">
        SELECT
             X.DS_INV_MTR_DTL_PK
            ,X.INV_NUM
            ,X.INV_BOL_LINE_NUM
            ,X.INV_LINE_NUM
            ,X.INV_LINE_SUB_NUM
            ,X.INV_LINE_SUB_TRX_NUM
            ,X.BLLG_PER_FROM_DT
            ,X.BLLG_PER_TO_DT
            ,X.SER_NUM
            ,X.MTR_LB_DESC_TXT
            ,X.PREV_TOT_COPY_QTY
            ,X.TOT_COPY_QTY
            ,X.TEST_COPY_QTY
            ,X.TEST_COPY_QTY_B
            ,X.CONTR_MTR_MULT_RATE
            ,X.COPY_INCL_QTY
            ,X.BLLG_COPY_QTY
            ,X.XS_MTR_AMT_RATE
            ,X.MTR_CHRG_DEAL_AMT
            ,X.MTR_CHRG_FUNC_AMT
            ,X.SHIP_TO_CUST_CD
            ,X.CCY_CD
            ,X.EZUPTIME
            ,X.EZUPTIMEZONE
        FROM
            (SELECT
                 DIM.DS_INV_MTR_DTL_PK
                ,DIM.INV_NUM
	            ,DIM.INV_BOL_LINE_NUM
	            ,DIM.INV_LINE_NUM
	            ,DIM.INV_LINE_SUB_NUM
	            ,DIM.INV_LINE_SUB_TRX_NUM
	            ,DIM.BLLG_PER_FROM_DT
	            ,DIM.BLLG_PER_TO_DT
	            ,DIM.SER_NUM
	            ,DIM.MTR_LB_DESC_TXT
	            ,DIM.PREV_TOT_COPY_QTY
	            ,DIM.TOT_COPY_QTY
	            ,DIM.TEST_COPY_QTY
	            ,DIM.TOT_COPY_QTY - DIM.PREV_TOT_COPY_QTY - DIM.TEST_COPY_QTY TEST_COPY_QTY_B
	            ,DIM.CONTR_MTR_MULT_RATE
	            ,DIM.COPY_INCL_QTY
	            ,DIM.BLLG_COPY_QTY
	            ,DIM.XS_MTR_AMT_RATE
	            ,CASE
                    WHEN I.INV_TP_CD  = '2'
                        THEN DIM.MTR_CHRG_DEAL_AMT * -1
                        ELSE DIM.MTR_CHRG_DEAL_AMT
                 END AS MTR_CHRG_DEAL_AMT
                 ,CASE
                    WHEN I.INV_TP_CD  = '2'
                        THEN DIM.MTR_CHRG_FUNC_AMT * -1
                        ELSE DIM.MTR_CHRG_FUNC_AMT
                 END AS MTR_CHRG_FUNC_AMT
	            ,DIM.SHIP_TO_CUST_CD
	            ,DIM.CCY_CD
	            ,DIM.EZUPTIME
	            ,DIM.EZUPTIMEZONE
	            ,I.INV_TP_CD
	        FROM
	            DS_INV_MTR_DTL DIM
	           ,INV I
	        WHERE
	            DIM.GLBL_CMPY_CD                    = #glblCmpyCd#
	            <isNotNull property="invNum">
	            AND DIM.INV_NUM                     = #invNum#
	            </isNotNull>
	            AND I.GLBL_CMPY_CD                  = #glblCmpyCd#
                <isNotNull property="invNum">
                AND I.INV_NUM                       = #invNum#
                </isNotNull>
	            AND DIM.EZCANCELFLAG                = '0'
	            AND I.EZCANCELFLAG                  = '0'
	        ORDER BY
                 DIM.INV_LINE_NUM
		    ) X
       WHERE
            ROWNUM &lt;= #rowNum#
    </statement>

    <resultMap id="result.getMeterList" class="NFCL3080_ASMsg">
        <result property="dsInvMtrDtlPk_A"            column="DS_INV_MTR_DTL_PK"            javaType="EZDSStringItem"/>
        <result property="invNum_A"                   column="INV_NUM"                      javaType="EZDSStringItem"/>
        <result property="invBolLineNum_A"            column="INV_BOL_LINE_NUM"             javaType="EZDSStringItem"/>
        <result property="invLineNum_A"               column="INV_LINE_NUM"                 javaType="EZDSStringItem"/>
        <result property="invLineSubNum_A"            column="INV_LINE_SUB_NUM"             javaType="EZDSStringItem"/>
        <result property="invLineSubTrxNum_A"         column="INV_LINE_SUB_TRX_NUM"         javaType="EZDSStringItem"/>
        <result property="bllgPerFromDt_A"            column="BLLG_PER_FROM_DT"             javaType="EZDSStringItem"/>
        <result property="bllgPerThruDt_A"            column="BLLG_PER_TO_DT"               javaType="EZDSStringItem"/>
        <result property="serNum_A"                   column="SER_NUM"                      javaType="EZDSStringItem"/>
        <result property="mtrLbDescTxt_A"             column="MTR_LB_DESC_TXT"              javaType="EZDSStringItem"/>
        <result property="prevTotCopyQty_A"           column="PREV_TOT_COPY_QTY"            javaType="EZDSStringItem"/>
        <result property="totCopyQty_A"               column="TOT_COPY_QTY"                 javaType="EZDSStringItem"/>
        <result property="testCopyQty_A"              column="TEST_COPY_QTY"                javaType="EZDSStringItem"/>
        <result property="testCopyQty_B"              column="TEST_COPY_QTY_B"              javaType="EZDSStringItem"/>
        <result property="contrMtrMultRate_A"         column="CONTR_MTR_MULT_RATE"          javaType="EZDSStringItem"/>
        <result property="copyInclQty_A"              column="COPY_INCL_QTY"                javaType="EZDSStringItem"/>
        <result property="bllgCopyQty_A"              column="BLLG_COPY_QTY"                javaType="EZDSStringItem"/>
        <result property="xsMtrAmtRate_A"             column="XS_MTR_AMT_RATE"              javaType="EZDSStringItem"/>
        <result property="mtrChrgDealAmt_A"           column="MTR_CHRG_DEAL_AMT"            javaType="EZDTBigDecimalItem"/>
        <result property="mtrChrgFuncAmt_A"           column="MTR_CHRG_FUNC_AMT"            javaType="EZDTBigDecimalItem"/>
        <result property="shipToCustCd_A"             column="SHIP_TO_CUST_CD"              javaType="EZDSStringItem"/>
        <result property="ccyCd_A"                    column="CCY_CD"                       javaType="EZDSStringItem"/>
        <result property="ezUpTime_A"                 column="EZUPTIME"                     javaType="EZDSStringItem"/>
        <result property="ezUpTimeZone_A"             column="EZUPTIMEZONE"                 javaType="EZDSStringItem"/>
    </resultMap>

    <statement id="getSvcInvList" parameterClass="Map" resultMap="result.getSvcInvList">
        SELECT
             X.INV_NUM
            ,X.INV_BOL_LINE_NUM
            ,X.INV_LINE_NUM
            ,X.INV_LINE_SUB_NUM
            ,X.INV_LINE_SUB_TRX_NUM
            ,X.BLLG_PER_FROM_DT
            ,X.BLLG_PER_THRU_DT
            ,X.SER_NUM
            ,X.MTR_LB_DESC_TXT
            ,X.PREV_TOT_COPY_QTY
            ,X.TOT_COPY_QTY
            ,X.TEST_COPY_QTY
            ,X.TEST_COPY_QTY_B
            ,X.CONTR_MTR_MULT_RATE
            ,X.COPY_INCL_QTY
            ,X.BLLG_COPY_QTY
            ,X.XS_MTR_AMT_RATE
            ,X.MTR_CHRG_DEAL_AMT
            ,X.MTR_CHRG_FUNC_AMT
            ,X.SHIP_TO_CUST_CD
            ,X.CCY_CD
            <!-- START 2018/06/27 [QC#26896,ADD] -->
            ,X.SVC_CONTR_MTR_BLLG_PK
            ,X.MTR_LB_CD
            <!-- END 2018/06/27 [QC#26896,ADD] -->
        FROM
            (SELECT
                 I.INV_TP_CD
                ,IL.INV_NUM
                ,IL.INV_BOL_LINE_NUM
	            ,IL.INV_LINE_NUM
	            ,IL.INV_LINE_SUB_NUM
	            ,IL.INV_LINE_SUB_TRX_NUM
	            ,SIX.SVC_INV_LINE_MTR_PK
	            ,SIL.BLLG_PER_FROM_DT
	            ,SIL.BLLG_PER_THRU_DT
	            ,SIL.SER_NUM
	            ,SIM.MTR_LB_DESC_TXT
	            ,SIM.PREV_TOT_COPY_QTY
	            ,SIM.TOT_COPY_QTY
	            ,SIM.TEST_COPY_QTY
	            ,SIM.TOT_COPY_QTY - SIM.PREV_TOT_COPY_QTY - SIM.TEST_COPY_QTY TEST_COPY_QTY_B
	            ,SIM.CONTR_MTR_MULT_RATE
	            ,SIM.COPY_INCL_QTY
	            ,SIM.BLLG_COPY_QTY
	            ,SIX.XS_MTR_AMT_RATE
	            ,CASE
                    WHEN I.INV_TP_CD  = '2'
                        THEN SIM.MTR_CHRG_DEAL_AMT * -1
                        ELSE SIM.MTR_CHRG_DEAL_AMT
                 END AS MTR_CHRG_DEAL_AMT
                 ,CASE
                    WHEN I.INV_TP_CD  = '2'
                        THEN SIM.MTR_CHRG_FUNC_AMT * -1
                        ELSE SIM.MTR_CHRG_FUNC_AMT
                 END AS MTR_CHRG_FUNC_AMT
	            ,SIL.SHIP_TO_CUST_CD
	            ,SIM.CCY_CD
                <!-- START 2018/06/27 [QC#26896,ADD] -->
                ,SIM.SVC_CONTR_MTR_BLLG_PK
                ,SIM.MTR_LB_CD
                <!-- END 2018/06/27 [QC#26896,ADD] -->
            FROM
                 INV I
                ,INV_LINE IL
                ,SVC_INV_LINE SIL
                ,SVC_INV_LINE_MTR SIM
                ,SVC_INV_LINE_XS_MTR SIX
            WHERE
                I.GLBL_CMPY_CD                  = #glblCmpyCd#
                <isNotNull property="invNum">
                AND I.INV_NUM                   = #invNum#
                </isNotNull>
                AND IL.GLBL_CMPY_CD             = I.GLBL_CMPY_CD
                <isNotNull property="invNum">
                AND IL.INV_NUM                  = I.INV_NUM
                </isNotNull>
                AND SIL.GLBL_CMPY_CD            = IL.GLBL_CMPY_CD
                AND SIL.SVC_INV_NUM             = IL.INV_NUM
                AND SIL.SVC_INV_LINE_NUM        = IL.INV_LINE_NUM
                AND SIL.SVC_INV_CHRG_TP_CD      = 'MC'
                AND SIM.GLBL_CMPY_CD            = SIL.GLBL_CMPY_CD
                AND SIM.SVC_INV_LINE_PK         = SIL.SVC_INV_LINE_PK
                AND SIX.GLBL_CMPY_CD(+)         = SIM.GLBL_CMPY_CD
                AND SIX.SVC_INV_LINE_MTR_PK(+)  = SIM.SVC_INV_LINE_MTR_PK
                AND I.EZCANCELFLAG              = '0'
                AND IL.EZCANCELFLAG             = '0'
                AND SIL.EZCANCELFLAG            = '0'
                AND SIM.EZCANCELFLAG            = '0'
                AND SIX.EZCANCELFLAG(+)         = '0'
            ORDER BY
                 IL.INV_NUM
                ,IL.INV_LINE_NUM
                 ) X
      WHERE
        ROWNUM &lt;= #rowNum#
    </statement>

    <resultMap id="result.getSvcInvList" class="NFCL3080_ASMsg">
        <result property="invNum_A"                   column="INV_NUM"                      javaType="EZDSStringItem"/>
        <result property="invBolLineNum_A"            column="INV_BOL_LINE_NUM"             javaType="EZDSStringItem"/>
        <result property="invLineNum_A"               column="INV_LINE_NUM"                 javaType="EZDSStringItem"/>
        <result property="invLineSubNum_A"            column="INV_LINE_SUB_NUM"             javaType="EZDSStringItem"/>
        <result property="invLineSubTrxNum_A"         column="INV_LINE_SUB_TRX_NUM"         javaType="EZDSStringItem"/>
        <result property="bllgPerFromDt_A"            column="BLLG_PER_FROM_DT"             javaType="EZDSStringItem"/>
        <result property="bllgPerThruDt_A"            column="BLLG_PER_THRU_DT"             javaType="EZDSStringItem"/>
        <result property="serNum_A"                   column="SER_NUM"                      javaType="EZDSStringItem"/>
        <result property="mtrLbDescTxt_A"             column="MTR_LB_DESC_TXT"              javaType="EZDSStringItem"/>
        <result property="prevTotCopyQty_A"           column="PREV_TOT_COPY_QTY"            javaType="EZDSStringItem"/>
        <result property="totCopyQty_A"               column="TOT_COPY_QTY"                 javaType="EZDSStringItem"/>
        <result property="testCopyQty_A"              column="TEST_COPY_QTY"                javaType="EZDSStringItem"/>
        <result property="testCopyQty_B"              column="TEST_COPY_QTY_B"              javaType="EZDSStringItem"/>
        <result property="contrMtrMultRate_A"         column="CONTR_MTR_MULT_RATE"          javaType="EZDSStringItem"/>
        <result property="copyInclQty_A"              column="COPY_INCL_QTY"                javaType="EZDSStringItem"/>
        <result property="bllgCopyQty_A"              column="BLLG_COPY_QTY"                javaType="EZDSStringItem"/>
        <result property="xsMtrAmtRate_A"             column="XS_MTR_AMT_RATE"              javaType="EZDSStringItem"/>
        <result property="mtrChrgDealAmt_A"           column="MTR_CHRG_DEAL_AMT"            javaType="EZDTBigDecimalItem"/>
        <result property="mtrChrgFuncAmt_A"           column="MTR_CHRG_FUNC_AMT"            javaType="EZDTBigDecimalItem"/>
        <result property="shipToCustCd_A"             column="SHIP_TO_CUST_CD"              javaType="EZDSStringItem"/>
        <result property="ccyCd_A"                    column="CCY_CD"                       javaType="EZDSStringItem"/>
        <result property="svcContrMtrBllgPk_A"        column="SVC_CONTR_MTR_BLLG_PK"        javaType="EZDTBigDecimalItem"/>
        <result property="mtrLbCd_A"                  column="MTR_LB_CD"                    javaType="EZDSStringItem"/>
    </resultMap>

    <statement id="getInvPrt" parameterClass="Map" resultClass="Integer">
        SELECT
               COUNT(*) AS PRT_CNT
            FROM
	           INV_PRT_CTRL IPC
	        WHERE
	           IPC.GLBL_CMPY_CD                     = #glblCmpyCd#
	           <isNotNull property="invNum">
	           AND IPC.INV_NUM                      = #invNum#
	           </isNotNull>
	           AND IPC.EZCANCELFLAG                 = '0'
    </statement>
</sqlMap>
