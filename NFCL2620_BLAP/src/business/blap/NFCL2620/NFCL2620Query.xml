<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NFCL2620Query">

    <typeAlias alias="NFCL2620CMsg"      type="business.blap.NFCL2620.NFCL2620CMsg"/>
    <typeAlias alias="NFCL2620_ASMsg"    type="business.blap.NFCL2620.NFCL2620_ASMsg"/>
    <statement id="getSearchData" parameterClass="Map" resultMap="result.getSearchData">
            SELECT
                A.*
            FROM (
                SELECT
                     ART.AR_RF_TP_CD
                    ,ART.AR_RF_TP_DESC_TXT
                    ,ARR.BILL_TO_CUST_ACCT_CD
                    ,STC.DS_ACCT_NM
                    ,ARR.AR_RF_RQST_PK
                    ,CASE WHEN ARS_TRX.AR_RF_STS_DESC_TXT IS NOT NULL THEN ARS_TRX.AR_RF_STS_DESC_TXT
                          WHEN ARS.AR_RF_STS_DESC_TXT IS NOT NULL THEN ARS.AR_RF_STS_DESC_TXT
                          ELSE ADWS.AR_DS_WF_STS_DESC_TXT
                     END AS AR_RF_STS_DESC_TXT
<!-- START 2018/09/14 T.Ogura [QC#25091,ADD] -->
                    ,NVL(ATB.AR_CUST_REF_NUM, ATB.AR_TRX_NUM) AS TRX_NUM
<!-- END   2018/09/14 T.Ogura [QC#25091,ADD] -->
<!-- START 2018/09/14 T.Ogura [QC#25091,MOD] -->
<!--                ,ARRD.AR_TRX_NUM -->
                    ,ATB.AR_TRX_NUM
<!-- END   2018/09/14 T.Ogura [QC#25091,MOD] -->
                    ,NVL(ARRD.DEAL_RF_AMT, 0) AS DEAL_RF_AMT
                    ,ARR.AR_RF_RQST_USR_ID || ' ' || AP.FIRST_NM || ' ' || AP.LAST_NM AS AR_RF_RQST_USR_NM
                    ,AR_TRX.AP_VND_INV_NUM
                    ,AIS.ACCT_INV_STS_DESC_TXT
                    ,AR_TRX.AP_PMT_CHK_NUM
                    ,CASE WHEN ARR.AR_DS_WF_STS_CD = #pending# THEN ARR.AR_RF_APVL_USR_NM
                          ELSE ARR.AR_RF_APVL_USR_ID || ' ' ||  ARR.AR_RF_APVL_USR_NM
                     END  AS AR_RF_APVL_USR_NM
<!-- START 2018/09/14 T.Ogura [QC#25091,ADD] -->
                    ,ARR.VND_CD
<!-- END   2018/09/14 T.Ogura [QC#25091,ADD] -->
            FROM
                AR_RF_RQST      ARR
                ,AR_RF_RQST_DTL ARRD
                ,AR_RF_STS      ARS
                ,AR_RF_STS      ARS_TRX
                ,AR_DS_WF_STS   ADWS
                ,AR_RF_TP       ART
                ,AR_RF_TRX      AR_TRX
                ,ACCT_INV_STS   AIS
                ,SELL_TO_CUST   STC
                ,AUTH_PSN       AP
<!-- START 2018/09/14 T.Ogura [QC#25091,ADD] -->
                ,AR_TRX_BAL     ATB
<!-- END   2018/09/14 T.Ogura [QC#25091,ADD] -->
            WHERE
                     ARR.GLBL_CMPY_CD                         = #glblCmpyCd#
                     <isNotNull property="arRfRqstPk">
                     AND ARR.AR_RF_RQST_PK                    = #arRfRqstPk#
                     </isNotNull>
                     <isNotNull property="arRfTpCd">
                     AND ARR.AR_RF_TP_CD                      = #arRfTpCd#
                     </isNotNull>
                     <isNotNull property="billToCustAcctCd">
                     AND ARR.BILL_TO_CUST_ACCT_CD             = #billToCustAcctCd#
                     </isNotNull>
                     <isNotNull property="arRfStsCd">
                     <!-- add start 2022/07/27 QC#57418 -->
                     <isNotEqual property="arRfStsCd" compareValue="01" >
                     <!-- add end 2022/07/27 QC#57418 -->
                     AND (
                             AR_TRX.AR_RF_STS_CD              = #arRfStsCd#
                          OR (
                                  ARR.AR_DS_WF_STS_CD         = #arRfStsCd#
                              AND ARR.AR_RF_STS_CD            IS NULL
                             )
                          OR (
                                  ARR.AR_RF_STS_CD            = #arRfStsCd#
                              AND AR_TRX.AR_RF_STS_CD         IS NULL
                             )
                         )
                     <!-- add start 2022/07/27 QC#57418 -->
                     </isNotEqual>
                     <isEqual property="arRfStsCd" compareValue="01" >
                     AND ARR.AR_RF_STS_CD                     = #arRfStsCd#
                     </isEqual>
                     <!-- add end 2022/07/27 QC#57418 -->
                     </isNotNull>
                     <isNotNull property="arRfCratDtFrom">
                     AND ARR.AR_RF_CRAT_DT                &gt;= #arRfCratDtFrom#
                     </isNotNull>
                     <isNotNull property="arRfCratDtTo">
                     AND ARR.AR_RF_CRAT_DT                &lt;= #arRfCratDtTo#
                     </isNotNull>
                     <!-- add start 2022/07/20 QC#60113 -->
                     <isNotNull property="apPmtChkNum">
                     AND AR_TRX.AP_PMT_CHK_NUM                = #apPmtChkNum#
                     </isNotNull>
                     <!-- add end 2022/07/20 QC#60113 -->
                     <!-- add start 2022/08/01 QC#60113-1 -->
                     <isNotNull property="dealRfAmt">
                     AND NVL(ARRD.DEAL_RF_AMT, 0)             = #dealRfAmt#
                     </isNotNull>
                     <!-- add end 2022/08/01 QC#60113-1 -->
                     AND ARR.EZCANCELFLAG                     = '0'
                     AND ARR.GLBL_CMPY_CD                     = ARRD.GLBL_CMPY_CD
                     AND ARR.AR_RF_RQST_PK                    = ARRD.AR_RF_RQST_PK
                     AND ARRD.EZCANCELFLAG                    = '0'
                     AND ARR.GLBL_CMPY_CD                     = ARS.GLBL_CMPY_CD(+)
                     AND ARR.AR_RF_STS_CD                     = ARS.AR_RF_STS_CD(+)
                     AND ARS.EZCANCELFLAG(+)                  = '0'
                     AND AR_TRX.GLBL_CMPY_CD                  = ARS_TRX.GLBL_CMPY_CD(+)
                     AND AR_TRX.AR_RF_STS_CD                  = ARS_TRX.AR_RF_STS_CD(+)
                     AND ARS_TRX.EZCANCELFLAG(+)              = '0'
                     AND ARR.GLBL_CMPY_CD                     = ADWS.GLBL_CMPY_CD
                     AND ARR.AR_DS_WF_STS_CD                  = ADWS.AR_DS_WF_STS_CD
                     AND ADWS.EZCANCELFLAG                    = '0'
                     AND ARR.GLBL_CMPY_CD                     = ART.GLBL_CMPY_CD
                     AND ARR.AR_RF_TP_CD                      = ART.AR_RF_TP_CD
                     AND ART.EZCANCELFLAG                     = '0'
                     AND ARR.GLBL_CMPY_CD                     = AR_TRX.GLBL_CMPY_CD(+)
                     AND ARR.AR_RF_RQST_PK                    = AR_TRX.AR_RF_RQST_PK(+)
                     AND ARRD.AR_RF_RQST_DTL_PK               = AR_TRX.AR_RF_RQST_DTL_PK(+)
                     AND AR_TRX.EZCANCELFLAG(+)               = '0'
                     AND AR_TRX.GLBL_CMPY_CD                  = AIS.GLBL_CMPY_CD(+)
                     AND AR_TRX.ACCT_INV_STS_CD               = AIS.ACCT_INV_STS_CD(+)
                     AND AIS.EZCANCELFLAG(+)                  = '0'
                     AND ARR.GLBL_CMPY_CD                     = STC.GLBL_CMPY_CD
                     AND ARR.BILL_TO_CUST_ACCT_CD             = STC.SELL_TO_CUST_CD
                     AND STC.EZCANCELFLAG                     = '0'
                     AND ARR.GLBL_CMPY_CD                     = AP.GLBL_CMPY_CD(+)
                     AND ARR.AR_RF_RQST_USR_ID                = AP.USR_NM(+)
                     AND AP.EZCANCELFLAG(+)                   = '0'
<!-- START 2018/09/14 T.Ogura [QC#25091,ADD] -->
                     AND ARRD.GLBL_CMPY_CD                    = ATB.GLBL_CMPY_CD
                     AND ARRD.AR_TRX_BAL_PK                   = ATB.AR_TRX_BAL_PK
                     AND ATB.EZCANCELFLAG                     = '0'
<!-- END   2018/09/14 T.Ogura [QC#25091,ADD] -->
            ORDER BY
                ARR.AR_RF_RQST_PK ASC
       ) A
       WHERE
           ROWNUM                          &lt;=   #limitCount#
    </statement>

    <resultMap id="result.getSearchData"      class="NFCL2620_ASMsg">
        <result property="arRfTpCd"          column="AR_RF_TP_CD"           javaType="EZDSStringItem"/>
        <result property="arRfTpDescTxt"     column="AR_RF_TP_DESC_TXT"     javaType="EZDSStringItem"/>
        <result property="billToCustAcctCd"  column="BILL_TO_CUST_ACCT_CD"  javaType="EZDSStringItem"/>
        <result property="dsAcctNm"          column="DS_ACCT_NM"            javaType="EZDSStringItem"/>
        <result property="arRfRqstPk"        column="AR_RF_RQST_PK"         javaType="EZDSBigDecimalItem"/>
        <result property="arRfStsDescTxt"    column="AR_RF_STS_DESC_TXT"    javaType="EZDSStringItem"/>
<!-- START 2018/09/14 T.Ogura [QC#25091,ADD] -->
        <result property="arCustRefNum"      column="TRX_NUM"               javaType="EZDSStringItem"/>
<!-- END   2018/09/14 T.Ogura [QC#25091,ADD] -->
        <result property="arTrxNum"          column="AR_TRX_NUM"            javaType="EZDSStringItem"/>
        <result property="dealRfAmt"         column="DEAL_RF_AMT"           javaType="EZDSBigDecimalItem"/>
        <result property="cratUsrNm"         column="AR_RF_RQST_USR_NM"     javaType="EZDSStringItem"/>
        <result property="xxWfAsgNm"         column="AR_RF_APVL_USR_NM"     javaType="EZDSStringItem"/>
        <result property="apVndInvNum"       column="AP_VND_INV_NUM"        javaType="EZDSStringItem"/>
        <result property="acctInvStsDescTxt" column="ACCT_INV_STS_DESC_TXT" javaType="EZDSStringItem"/>
        <result property="apPmtChkNum"       column="AP_PMT_CHK_NUM"        javaType="EZDSStringItem"/>
<!-- START 2018/09/14 T.Ogura [QC#25091,ADD] -->
        <result property="vndCd"             column="VND_CD"                javaType="EZDSStringItem"/>
<!-- END   2018/09/14 T.Ogura [QC#25091,ADD] -->
    </resultMap>

    <statement id="getRfStsList" parameterClass="Map" resultClass="Map">
        SELECT
             WFS.AR_DS_WF_STS_CD        AS AR_RF_STS_CD
            ,WFS.AR_DS_WF_STS_DESC_TXT  AS AR_RF_STS_DESC_TXT
            ,0                          AS SORT_KEY
            ,WFS.AR_DS_WF_STS_SORT_NUM  AS AR_RF_STS_SORT_NUM
        FROM
             AR_DS_WF_STS      WFS
        WHERE
                WFS.GLBL_CMPY_CD = #cMsg.glblCmpyCd#
            <iterate property="arDsWfStsCdList" var="arDsWfStsCdList[]" open=" AND WFS.AR_DS_WF_STS_CD IN (" close=")" conjunction=",">
                  #arDsWfStsCdList[]#
            </iterate>
            AND WFS.EZCANCELFLAG = '0'
        UNION
        SELECT
             RFS.AR_RF_STS_CD
            ,RFS.AR_RF_STS_DESC_TXT
            ,1                          AS SORT_KEY
            ,RFS.AR_RF_STS_SORT_NUM
        FROM
             AR_RF_STS      RFS
        WHERE
                RFS.GLBL_CMPY_CD = #cMsg.glblCmpyCd#
            <iterate property="arRfStsCdList" var="arRfStsCdList[]" open=" AND RFS.AR_RF_STS_CD IN (" close=")" conjunction=",">
                  #arRfStsCdList[]#
            </iterate>
            AND RFS.EZCANCELFLAG = '0'
        ORDER BY
             SORT_KEY
            ,AR_RF_STS_SORT_NUM
    </statement>

    <!-- START 2023/06/13 [QC#61486,ADD] -->
    <statement id="getPulldownArRfTpCd" parameterClass="Map" resultClass="Map">
        SELECT
             ART.AR_RF_TP_CD
            ,ART.AR_RF_TP_DESC_TXT
        FROM
            AR_RF_TP ART
        WHERE
                ART.GLBL_CMPY_CD = #glblCmpyCd#
            AND ART.EZCANCELFLAG = '0'
            <isNotNull property="arRfTpCdCustomerRefund">
            AND ART.AR_RF_TP_CD = #arRfTpCdCustomerRefund#
            </isNotNull>
            <isNotNull property="arRfTpCdCreditCardRefund">
            AND ART.AR_RF_TP_CD &lt;&gt; #arRfTpCdCreditCardRefund#
            </isNotNull>
        ORDER BY
            ART.AR_RF_TP_SORT_NUM
    </statement>
    <!-- END 2023/06/13 [QC#61486,ADD] -->

</sqlMap>
