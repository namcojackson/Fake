<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSAL0730Query">

    <statement id="getDSContractInfo" parameterClass="Map" resultClass="Map">
       SELECT
                DC.DS_CONTR_PK                            AS DS_CONTR_PK
               ,DC.DS_CONTR_CATG_CD||'-'||DC.DS_CONTR_NUM AS CONTR_CATG_CD_NUM
               ,DC.DS_CONTR_CATG_CD                       AS DS_CONTR_CATG_CD
               ,DC.DS_CONTR_NUM                           AS DS_CONTR_NUM
               ,DC.DS_CONTR_STS_CD                        AS DS_CONTR_STS_CD
               ,DCCCP.CUST_PO_NUM                         AS CUST_PO_NUM
               <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
               ,DCCCP.PO_FROM_DT                          AS PO_FROM_DT
               <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
               ,DCCCP.PO_DT                               AS PO_DT
               ,DCCCP.LEASE_CMPY_FLG                      AS LEASE_CMPY_FLG
               ,DCCCP.DS_CONTR_CR_CARD_PO_PK              AS DS_CONTR_CR_CARD_PO_PK
               ,DCCCP.EZUPTIME                            AS EZUPTIME
               ,DCCCP.EZUPTIMEZONE                        AS EZUPTIMEZONE
               ,#dsContrMachLvlNum#                       AS DS_CONTR_MACH_LVL_NUM
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
               ,DC.EZINTIME                               AS XX_REC_HIST_CRAT_TS
               ,DC.EZINUSERID                             AS XX_REC_HIST_CRAT_BY_NM
               ,DC.EZUPTIME                               AS XX_REC_HIST_UPD_TS
               ,DC.EZUPUSERID                             AS XX_REC_HIST_UPD_BY_NM
               ,DC.EZTABLEID                              AS XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
       FROM
                DS_CONTR            DC
               ,DS_CONTR_CR_CARD_PO DCCCP
       WHERE
                DC.GLBL_CMPY_CD                     =      #glblCmpyCd#
                AND DC.DS_CONTR_PK                  =      #dsContrPk#
                AND DC.EZCANCELFLAG                 =      '0'
                AND DC.GLBL_CMPY_CD                 =      DCCCP.GLBL_CMPY_CD (+)
                AND DC.DS_CONTR_PK                  =      DCCCP.DS_CONTR_PK  (+)
                AND DCCCP.DS_CONTR_DTL_PK       (+) IS NULL
                AND DCCCP.DS_CONTR_BLLG_MTR_PK  (+) IS NULL
                AND DCCCP.DS_CONTR_MACH_LVL_NUM (+) =      #dsContrMachLvlNum#
                <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                AND DCCCP.CR_CARD_FLG           (+) =      'N'
                <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                AND DCCCP.EZCANCELFLAG          (+) =      '0'
       <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
       ORDER BY
                DCCCP.PO_FROM_DT
       <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
     </statement>

    <statement id="getDSContractDetailInfo" parameterClass="Map" resultClass="Map">
       SELECT
                DCD.DS_CONTR_DTL_PK                AS DS_CONTR_DTL_PK
               ,SMM.SVC_MACH_MSTR_PK               AS SVC_MACH_MSTR_PK
               ,DCD.DS_CONTR_DTL_STS_CD            AS DS_CONTR_DTL_STS_CD
               ,(
                   CASE
                       WHEN DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCdIsFlt# THEN 
                            TRIM(DC.DS_CONTR_CATG_CD || '-' || DC.DS_CONTR_NUM)
                       WHEN DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCdIsAgg# THEN 
                            TRIM(DC.DS_CONTR_CATG_CD || '-' || DC.DS_CONTR_NUM)
                       ELSE
                           SMM.SER_NUM
                   END
                 )                                 AS SER_NUM
               ,DCCCP.CUST_PO_NUM                  AS CUST_PO_NUM
               <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
               ,DCCCP.PO_FROM_DT                   AS PO_FROM_DT
               <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
               ,DCCCP.PO_DT                        AS PO_DT
               ,DCCCP.LEASE_CMPY_FLG               AS LEASE_CMPY_FLG
               ,#dsContrMachLvlNum#                AS DS_CONTR_MACH_LVL_NUM
               ,DCCCP.DS_CONTR_CR_CARD_PO_PK       AS DS_CONTR_CR_CARD_PO_PK
               ,DCCCP.EZUPTIME                     AS EZUPTIME
               ,DCCCP.EZUPTIMEZONE                 AS EZUPTIMEZONE
               ,(
                   CASE
                       WHEN DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCdIsFlt# THEN 
                           0
                       WHEN DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCdIsAgg# THEN 
                           0
                       <!-- START 2019/01/10 K.Kitachi [QC#26928, MOD] -->
                       <!-- WHEN DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCdIsAcc# THEN -->
                           <!-- DCD.PRNT_DS_CONTR_DTL_PK -->
                       ELSE
                           <!-- DCD.DS_CONTR_DTL_PK -->
                           1
                       <!-- END 2019/01/10 K.Kitachi [QC#26928, MOD] -->
                   END
                 )                                 AS SORT_NUM
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
               <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
               ,NVL(SMMP.SER_NUM, SMM.SER_NUM)     AS SORT_SER_NUM
               ,NVL(SMMP.MDSE_CD, SMM.MDSE_CD)     AS SORT_MDSE_CD
               <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
               ,DCCCP.EZINTIME                     AS XX_REC_HIST_CRAT_TS
               ,DCCCP.EZINUSERID                   AS XX_REC_HIST_CRAT_BY_NM
               ,DCCCP.EZUPTIME                     AS XX_REC_HIST_UPD_TS
               ,DCCCP.EZUPUSERID                   AS XX_REC_HIST_UPD_BY_NM
               ,DCCCP.EZTABLEID                    AS XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
               <!-- add start 2019/05/14 QC#50331 -->
               ,SPT.SVC_PGM_TP_SORT_NUM            AS SVC_PGM_TP_SORT_NUM
               ,NVL(DCD.DS_CONTR_CRAT_TP_CD, #dsContrCratTp#)
                                                   AS SORT_DS_CONTR_CRAT_TP_CD
               ,CASE WHEN SMMP.SVC_MACH_MSTR_PK IS NULL THEN DCD.DS_CONTR_DTL_PK
                     ELSE DCD.PRNT_DS_CONTR_DTL_PK
                END                                AS SORT_DS_CONTR_DTL_PK
               <!-- add end 2019/05/14 QC#50331 -->
       FROM
                DS_CONTR            DC
               ,DS_CONTR_DTL        DCD
               ,DS_CONTR_DTL_TP     DCDT
               ,SVC_MACH_MSTR       SMM
               ,DS_CONTR_CR_CARD_PO DCCCP
               <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
               ,DS_CONTR_DTL        DCDP
               ,SVC_MACH_MSTR       SMMP
               <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
               <!-- add start 2019/05/14 QC#50331 -->
               ,MDSE                MDSE
               ,SVC_PGM_TP          SPT
               <!-- add end 2019/05/14 QC#50331 -->
       WHERE
                    DC.GLBL_CMPY_CD                 =      #glblCmpyCd#
                AND DC.DS_CONTR_PK                  =      #dsContrPk#
                AND DC.EZCANCELFLAG                 =      '0'
                AND DC.GLBL_CMPY_CD                 =      DCD.GLBL_CMPY_CD
                AND DC.DS_CONTR_PK                  =      DCD.DS_CONTR_PK
                <!-- START 2017/06/19 T.Mizuki [QC#19256,ADD] -->
                AND DCD.DS_CONTR_DTL_STS_CD  &lt;&gt;    #dsContrDtlStsOrdr#
                <!-- END 2017/06/19 T.Mizuki [QC#19256,ADD] -->
                <isEqual property="existContrDtlPk" compareValue="Y">
                AND (
                        (
                        <iterate property="dsContrDtlPkList" var="dsContrDtlPk[]" open="DCD.DS_CONTR_DTL_PK IN (" close=")" conjunction=",">
                            #dsContrDtlPk[]#
                        </iterate>
                        ) OR (
                            DCD.DS_CONTR_DTL_TP_CD IN (#dsContrDtlTpCdIsFlt#, #dsContrDtlTpCdIsAgg#)
                        )
                    )
                </isEqual>
                AND DCD.EZCANCELFLAG                =      '0'
                AND DCD.GLBL_CMPY_CD                =      DCDT.GLBL_CMPY_CD
                AND DCD.DS_CONTR_DTL_TP_CD          =      DCDT.DS_CONTR_DTL_TP_CD
                AND DCDT.SVC_PRC_FLG                =      #flgOffN#
                AND DCDT.EZCANCELFLAG               =      '0'
                AND DCD.GLBL_CMPY_CD                =      SMM.GLBL_CMPY_CD      (+)
                AND DCD.SVC_MACH_MSTR_PK            =      SMM.SVC_MACH_MSTR_PK  (+)
                AND SMM.EZCANCELFLAG            (+) =      '0'
                AND DCD.GLBL_CMPY_CD                =      DCCCP.GLBL_CMPY_CD    (+)
                AND DCD.DS_CONTR_PK                 =      DCCCP.DS_CONTR_PK     (+)
                AND DCD.DS_CONTR_DTL_PK             =      DCCCP.DS_CONTR_DTL_PK (+)
                AND DCCCP.DS_CONTR_BLLG_MTR_PK  (+) IS NULL
                AND DCCCP.DS_CONTR_MACH_LVL_NUM (+) =      #dsContrMachLvlNum#
                <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                AND DCCCP.CR_CARD_FLG           (+) =      'N'
                <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                AND DCCCP.EZCANCELFLAG          (+) =      '0'
                <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                AND DCD.GLBL_CMPY_CD                =      DCDP.GLBL_CMPY_CD     (+)
                AND DCD.PRNT_DS_CONTR_DTL_PK        =      DCDP.DS_CONTR_DTL_PK  (+)
                AND DCDP.EZCANCELFLAG           (+) =      '0'
                AND DCDP.GLBL_CMPY_CD               =      SMMP.GLBL_CMPY_CD     (+)
                AND DCDP.SVC_MACH_MSTR_PK           =      SMMP.SVC_MACH_MSTR_PK (+)
                AND SMMP.EZCANCELFLAG           (+) =      '0'
                <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                <!-- add start 2019/05/14 QC#50331 -->
                AND DCD.GLBL_CMPY_CD                =      MDSE.GLBL_CMPY_CD     (+)
                AND DCD.SVC_PGM_MDSE_CD             =      MDSE.MDSE_CD          (+)
                AND MDSE.EZCANCELFLAG           (+) =      '0'
                AND MDSE.GLBL_CMPY_CD               =      SPT.GLBL_CMPY_CD      (+)
                AND MDSE.SVC_PGM_TP_CD              =      SPT.SVC_PGM_TP_CD     (+)
                AND SPT.EZCANCELFLAG            (+) =      '0'
                <!-- add end 2019/05/14 QC#50331 -->
        ORDER BY
                SORT_NUM
                <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                ,SORT_SER_NUM
                ,SORT_MDSE_CD
                <!-- add start 2019/05/14 QC#50331 -->
                ,SVC_PGM_TP_SORT_NUM
                ,SORT_DS_CONTR_CRAT_TP_CD
                ,SORT_DS_CONTR_DTL_PK
                <!-- add end 2019/05/14 QC#50331 -->
                ,DCDT.DS_CONTR_DTL_TP_SORT_NUM
                ,DCD.DS_CONTR_DTL_PK
                ,DCCCP.PO_FROM_DT
                <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
     </statement>
 
    <statement id="getDSContractDetailBaseOverageInfo" parameterClass="Map" resultClass="Map">
       SELECT
                 DC.DS_CONTR_DTL_PK
                ,DC.DS_CONTR_DTL_TP_CD
                ,DC.DS_CONTR_BLLG_MTR_PK
                ,DC.BLLG_MTR_LB_CD
                ,DC.DS_CONTR_BLLG_MTR_STS_CD
                ,DC.MTR_LB_DESC_TXT
                ,DC.CR_CARD_CUST_REF_NUM
                ,DC.CR_CARD_EXPR_YR_MTH
                ,DC.LEASE_CMPY_FLG
                ,DC.DS_CONTR_MACH_LVL_NUM
                ,DC.CUST_PO_NUM
                <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                ,DC.PO_FROM_DT
                <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                ,DC.PO_DT
                ,DC.DS_CONTR_CR_CARD_PO_PK
                ,DC.EZUPTIME
                ,DC.EZUPTIMEZONE
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                ,DC.XX_REC_HIST_CRAT_TS
                ,DC.XX_REC_HIST_CRAT_BY_NM
                ,DC.XX_REC_HIST_UPD_TS
                ,DC.XX_REC_HIST_UPD_BY_NM
                ,DC.XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
       FROM
       (
               SELECT
                    DCD.DS_CONTR_DTL_PK
                   ,NULL                  AS   DS_CONTR_DTL_TP_CD
                   ,NULL                  AS   DS_CONTR_BLLG_MTR_PK
                   ,NULL                  AS   BLLG_MTR_LB_CD
                   ,NULL                  AS   DS_CONTR_BLLG_MTR_STS_CD
                   ,'BASE'                AS   MTR_LB_DESC_TXT
                   ,DCCCP.CR_CARD_CUST_REF_NUM
                   ,DCCCP.CR_CARD_EXPR_YR_MTH
                   ,DCCCP.LEASE_CMPY_FLG
                   ,#dsContrMachLvlNum#   AS DS_CONTR_MACH_LVL_NUM
                   ,DCCCP.CUST_PO_NUM
                   <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                   ,DCCCP.PO_FROM_DT
                   <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                   ,DCCCP.PO_DT
                   ,DCCCP.DS_CONTR_CR_CARD_PO_PK
                   ,DCCCP.EZUPTIME
                   ,DCCCP.EZUPTIMEZONE
                   <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                   ,(
                       CASE
                           WHEN DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCdIsFlt# THEN
                               0
                           WHEN DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCdIsAgg# THEN
                               0
                           ELSE
                               1
                       END
                     )                             AS SORT_NUM
                   ,NVL(SMMP.SER_NUM, SMM.SER_NUM) AS SORT_SER_NUM
                   ,NVL(SMMP.MDSE_CD, SMM.MDSE_CD) AS SORT_MDSE_CD
                   ,DCDT.DS_CONTR_DTL_TP_SORT_NUM
                   ,0                              AS MTR_LB_SORT_NUM
                   <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                   ,DCCCP.EZINTIME        AS   XX_REC_HIST_CRAT_TS
                   ,DCCCP.EZINUSERID      AS   XX_REC_HIST_CRAT_BY_NM
                   ,DCCCP.EZUPTIME        AS   XX_REC_HIST_UPD_TS
                   ,DCCCP.EZUPUSERID      AS   XX_REC_HIST_UPD_BY_NM
                   ,DCCCP.EZTABLEID       AS   XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
                   <!-- add start 2019/05/14 QC#50331 -->
                   ,SPT.SVC_PGM_TP_SORT_NUM            AS SVC_PGM_TP_SORT_NUM
                   ,NVL(DCD.DS_CONTR_CRAT_TP_CD, #dsContrCratTp#)
                                                       AS SORT_DS_CONTR_CRAT_TP_CD
                   ,CASE WHEN SMMP.SVC_MACH_MSTR_PK IS NULL THEN DCD.DS_CONTR_DTL_PK
                         ELSE DCD.PRNT_DS_CONTR_DTL_PK
                    END                                AS SORT_DS_CONTR_DTL_PK
                   <!-- add end 2019/05/14 QC#50331 -->
               FROM
                    DS_CONTR_DTL        DCD
                   ,DS_CONTR_DTL_TP     DCDT
                   ,DS_CONTR_CR_CARD_PO DCCCP
                   <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                   ,SVC_MACH_MSTR       SMM
                   ,DS_CONTR_DTL        DCDP
                   ,SVC_MACH_MSTR       SMMP
                   <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                   <!-- add start 2019/05/14 QC#50331 -->
                   ,MDSE                MDSE
                   ,SVC_PGM_TP          SPT
                   <!-- add end 2019/05/14 QC#50331 -->
               WHERE
                DCD.GLBL_CMPY_CD                    = #glblCmpyCd#
                AND DCD.DS_CONTR_PK                 = #dsContrPk#
                <isEqual property="existContrDtlPk" compareValue="Y">
                AND (
                        (
                        <iterate property="dsContrDtlPkList" var="dsContrDtlPk[]" open="DCD.DS_CONTR_DTL_PK IN (" close=")" conjunction=",">
                            #dsContrDtlPk[]#
                        </iterate>
                        ) OR (
                            DCD.DS_CONTR_DTL_TP_CD IN (#dsContrDtlTpCdIsFlt#, #dsContrDtlTpCdIsAgg#)
                        )
                    )
                </isEqual>
                <!-- START 2017/06/19 T.Mizuki [QC#19256,ADD] -->
                AND DCD.DS_CONTR_DTL_STS_CD  &lt;&gt;    #dsContrDtlStsOrdr#
                <!-- END 2017/06/19 T.Mizuki [QC#19256,ADD] -->
                AND DCD.EZCANCELFLAG                = '0'
                AND DCD.GLBL_CMPY_CD                = DCDT.GLBL_CMPY_CD
                AND DCD.DS_CONTR_DTL_TP_CD          = DCDT.DS_CONTR_DTL_TP_CD
                AND DCDT.BASE_CHRG_FLG              = #chreFlg#
                AND DCDT.EZCANCELFLAG               = '0'
                AND DCD.GLBL_CMPY_CD                = DCCCP.GLBL_CMPY_CD    (+)
                AND DCD.DS_CONTR_PK                 = DCCCP.DS_CONTR_PK     (+)
                AND DCD.DS_CONTR_DTL_PK             = DCCCP.DS_CONTR_DTL_PK (+)
                AND DCCCP.DS_CONTR_BLLG_MTR_PK (+)  IS NULL
                AND DCCCP.DS_CONTR_MACH_LVL_NUM (+) = #dsContrMachLvlNum#
                <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                AND DCCCP.CR_CARD_FLG           (+) = 'N'
                <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                AND DCCCP.EZCANCELFLAG (+)          = '0'
                <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                AND DCD.GLBL_CMPY_CD                = SMM.GLBL_CMPY_CD      (+)
                AND DCD.SVC_MACH_MSTR_PK            = SMM.SVC_MACH_MSTR_PK  (+)
                AND SMM.EZCANCELFLAG            (+) = '0'
                AND DCD.GLBL_CMPY_CD                = DCDP.GLBL_CMPY_CD     (+)
                AND DCD.PRNT_DS_CONTR_DTL_PK        = DCDP.DS_CONTR_DTL_PK  (+)
                AND DCDP.EZCANCELFLAG           (+) = '0'
                AND DCDP.GLBL_CMPY_CD               = SMMP.GLBL_CMPY_CD     (+)
                AND DCDP.SVC_MACH_MSTR_PK           = SMMP.SVC_MACH_MSTR_PK (+)
                AND SMMP.EZCANCELFLAG           (+) = '0'
                <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                <!-- add start 2019/05/14 QC#50331 -->
                AND DCD.GLBL_CMPY_CD                = MDSE.GLBL_CMPY_CD     (+)
                AND DCD.SVC_PGM_MDSE_CD             = MDSE.MDSE_CD          (+)
                AND MDSE.EZCANCELFLAG           (+) = '0'
                AND MDSE.GLBL_CMPY_CD               = SPT.GLBL_CMPY_CD      (+)
                AND MDSE.SVC_PGM_TP_CD              = SPT.SVC_PGM_TP_CD     (+)
                AND SPT.EZCANCELFLAG            (+) = '0'
                <!-- add end 2019/05/14 QC#50331 -->
       UNION ALL
        
               SELECT
                    DCD.DS_CONTR_DTL_PK
                   ,DCD.DS_CONTR_DTL_TP_CD
                   ,DCBM.DS_CONTR_BLLG_MTR_PK
                   ,DCBM.BLLG_MTR_LB_CD
                   ,DCBM.DS_CONTR_BLLG_MTR_STS_CD
                   ,ML.MTR_LB_DESC_TXT
                   ,DCCCP.CR_CARD_CUST_REF_NUM
                   ,DCCCP.CR_CARD_EXPR_YR_MTH
                   ,DCCCP.LEASE_CMPY_FLG
                   ,#dsContrMachLvlNum# AS DS_CONTR_MACH_LVL_NUM
                   ,DCCCP.CUST_PO_NUM
                   <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                   ,DCCCP.PO_FROM_DT
                   <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                   ,DCCCP.PO_DT
                   ,DCCCP.DS_CONTR_CR_CARD_PO_PK
                   ,DCCCP.EZUPTIME
                   ,DCCCP.EZUPTIMEZONE
                   <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                   ,(
                       CASE
                           WHEN DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCdIsFlt# THEN
                               0
                           WHEN DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCdIsAgg# THEN
                               0
                           ELSE
                               1
                       END
                     )                             AS SORT_NUM
                   ,NVL(SMMP.SER_NUM, SMM.SER_NUM) AS SORT_SER_NUM
                   ,NVL(SMMP.MDSE_CD, SMM.MDSE_CD) AS SORT_MDSE_CD
                   ,DCDT.DS_CONTR_DTL_TP_SORT_NUM
                   ,ML.MTR_LB_SORT_NUM
                   <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                   ,DCCCP.EZINTIME        AS   XX_REC_HIST_CRAT_TS
                   ,DCCCP.EZINUSERID      AS   XX_REC_HIST_CRAT_BY_NM
                   ,DCCCP.EZUPTIME        AS   XX_REC_HIST_UPD_TS
                   ,DCCCP.EZUPUSERID      AS   XX_REC_HIST_UPD_BY_NM
                   ,DCCCP.EZTABLEID       AS   XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
                   <!-- add start 2019/05/14 QC#50331 -->
                   ,SPT.SVC_PGM_TP_SORT_NUM            AS SVC_PGM_TP_SORT_NUM
                   ,NVL(DCD.DS_CONTR_CRAT_TP_CD, #dsContrCratTp#)
                                                       AS SORT_DS_CONTR_CRAT_TP_CD
                   ,CASE WHEN SMMP.SVC_MACH_MSTR_PK IS NULL THEN DCD.DS_CONTR_DTL_PK
                         ELSE DCD.PRNT_DS_CONTR_DTL_PK
                    END                                AS SORT_DS_CONTR_DTL_PK
                   <!-- add end 2019/05/14 QC#50331 -->
               FROM
                    DS_CONTR_DTL        DCD
                   ,DS_CONTR_DTL_TP     DCDT
                   ,DS_CONTR_BLLG_MTR   DCBM
                   ,MTR_LB              ML
                   ,DS_CONTR_CR_CARD_PO DCCCP
                   <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                   ,SVC_MACH_MSTR       SMM
                   ,DS_CONTR_DTL        DCDP
                   ,SVC_MACH_MSTR       SMMP
                   <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                   <!-- add start 2019/05/14 QC#50331 -->
                   ,MDSE                MDSE
                   ,SVC_PGM_TP          SPT
                   <!-- add end 2019/05/14 QC#50331 -->
               WHERE
                DCD.GLBL_CMPY_CD                    = #glblCmpyCd#
                AND DCD.DS_CONTR_PK                 = #dsContrPk#
                <isEqual property="existContrDtlPk" compareValue="Y">
                AND (
                        (
                        <iterate property="dsContrDtlPkList" var="dsContrDtlPk[]" open="DCD.DS_CONTR_DTL_PK IN (" close=")" conjunction=",">
                            #dsContrDtlPk[]#
                        </iterate>
                        ) OR (
                            DCD.DS_CONTR_DTL_TP_CD IN (#dsContrDtlTpCdIsFlt#, #dsContrDtlTpCdIsAgg#)
                        )
                    )
                </isEqual>
                <!-- START 2017/06/19 T.Mizuki [QC#19256,ADD] -->
                AND DCD.DS_CONTR_DTL_STS_CD  &lt;&gt;    #dsContrDtlStsOrdr#
                <!-- END 2017/06/19 T.Mizuki [QC#19256,ADD] -->
                AND DCD.EZCANCELFLAG                = '0'
                AND DCD.GLBL_CMPY_CD                = DCDT.GLBL_CMPY_CD
                AND DCD.DS_CONTR_DTL_TP_CD          = DCDT.DS_CONTR_DTL_TP_CD
                AND DCDT.USG_CHRG_FLG               = #chreFlg#
                AND DCDT.EZCANCELFLAG               = '0'
                AND DCD.GLBL_CMPY_CD                = DCBM.GLBL_CMPY_CD
                AND DCD.DS_CONTR_DTL_PK             = DCBM.DS_CONTR_DTL_PK
                AND DCBM.EZCANCELFLAG               = '0'
                AND DCBM.GLBL_CMPY_CD               = ML.GLBL_CMPY_CD
                AND DCBM.BLLG_MTR_LB_CD             = ML.MTR_LB_CD
                AND ML.EZCANCELFLAG                 = '0'
                AND DCD.GLBL_CMPY_CD                = DCCCP.GLBL_CMPY_CD         (+)
                AND DCD.DS_CONTR_PK                 = DCCCP.DS_CONTR_PK          (+)
                AND DCD.DS_CONTR_DTL_PK             = DCCCP.DS_CONTR_DTL_PK      (+)
                AND DCBM.DS_CONTR_BLLG_MTR_PK       = DCCCP.DS_CONTR_BLLG_MTR_PK (+)
                AND DCCCP.DS_CONTR_MACH_LVL_NUM (+) = #dsContrMachLvlNum#
                <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                AND DCCCP.CR_CARD_FLG           (+) = 'N'
                <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                AND DCCCP.EZCANCELFLAG          (+) = '0'
                <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                AND DCD.GLBL_CMPY_CD                = SMM.GLBL_CMPY_CD           (+)
                AND DCD.SVC_MACH_MSTR_PK            = SMM.SVC_MACH_MSTR_PK       (+)
                AND SMM.EZCANCELFLAG            (+) = '0'
                AND DCD.GLBL_CMPY_CD                = DCDP.GLBL_CMPY_CD          (+)
                AND DCD.PRNT_DS_CONTR_DTL_PK        = DCDP.DS_CONTR_DTL_PK       (+)
                AND DCDP.EZCANCELFLAG           (+) = '0'
                AND DCDP.GLBL_CMPY_CD               = SMMP.GLBL_CMPY_CD          (+)
                AND DCDP.SVC_MACH_MSTR_PK           = SMMP.SVC_MACH_MSTR_PK      (+)
                AND SMMP.EZCANCELFLAG           (+) = '0'
                <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
                <!-- add start 2019/05/14 QC#50331 -->
                AND DCD.GLBL_CMPY_CD                = MDSE.GLBL_CMPY_CD          (+)
                AND DCD.SVC_PGM_MDSE_CD             = MDSE.MDSE_CD               (+)
                AND MDSE.EZCANCELFLAG           (+) = '0'
                AND MDSE.GLBL_CMPY_CD               = SPT.GLBL_CMPY_CD           (+)
                AND MDSE.SVC_PGM_TP_CD              = SPT.SVC_PGM_TP_CD          (+)
                AND SPT.EZCANCELFLAG            (+) = '0'
                <!-- add end 2019/05/14 QC#50331 -->
       )DC
        ORDER BY
            <!-- START 2019/01/10 K.Kitachi [QC#26928, MOD] -->
            <!--  DC.DS_CONTR_DTL_PK -->
            <!-- ,DC.DS_CONTR_DTL_TP_CD NULLS FIRST -->
            <!-- ,DC.DS_CONTR_BLLG_MTR_PK -->
             DC.SORT_NUM
            ,DC.SORT_SER_NUM
            ,DC.SORT_MDSE_CD
            <!-- add start 2019/05/14 QC#50331 -->
            ,DC.SVC_PGM_TP_SORT_NUM
            ,DC.SORT_DS_CONTR_CRAT_TP_CD
            ,DC.SORT_DS_CONTR_DTL_PK
            <!-- add end 2019/05/14 QC#50331 -->
            ,DC.DS_CONTR_DTL_TP_SORT_NUM
            ,DC.DS_CONTR_DTL_PK
            ,DC.MTR_LB_SORT_NUM
            ,DC.PO_FROM_DT
            <!-- END 2019/01/10 K.Kitachi [QC#26928, MOD] -->
     </statement>

     <typeAlias alias="SVC_MEMOTMsg" type="business.db.SVC_MEMOTMsg"/>
     <statement id="getSvcMemo" parameterClass="Map" resultMap="result.SVC_MEMOTMsg">
       SELECT
             GLBL_CMPY_CD
             ,SVC_MEMO_PK
       FROM
              SVC_MEMO
       WHERE

             GLBL_CMPY_CD                                  = #glblCmpyCd#
             AND DS_CONTR_PK                               = #dsContractPk#
             AND SVC_MEMO_CATG_CD                          = #contractMemo#
             AND SVC_MEMO_TP_CD                            = #updateTp#
             AND EZCANCELFLAG                              = '0'
    </statement>
    <resultMap id="result.SVC_MEMOTMsg"  class="SVC_MEMOTMsg">
           <result property="glblCmpyCd"    column="GLBL_CMPY_CD"    javaType="EZDTStringItem"/>
           <result property="svcMemoPk"     column="SVC_MEMO_PK"     javaType="EZDTBigDecimalItem"/>
    </resultMap>
    
     <statement id="getContStsV" parameterClass="Map" resultClass="BigDecimal">
      SELECT
           count(*) AS CNT
      FROM
             DS_CONTR_STS_V DCSV
      WHERE

            DCSV.GLBL_CMPY_CD                                  = #glblCmpyCd#
            AND DCSV.DS_CONTR_PK                               = #dsContrPk#
            <iterate property="ctrlStsCd" var="ctrlStsCd[]" open="AND DCSV.DS_CONTR_CTRL_STS_CD IN (" close=")" conjunction=",">
                #ctrlStsCd[]#
            </iterate>
            AND DCSV.EZCANCELFLAG                              = '0'
   </statement>

   <statement id="getContrDtlStsV" parameterClass="Map" resultClass="BigDecimal">
      SELECT
           count(*) AS CNT
      FROM
             DS_CONTR_DTL_STS_V DCDSV
      WHERE

            DCDSV.GLBL_CMPY_CD                                  = #glblCmpyCd#
            AND DCDSV.DS_CONTR_PK                               = #dsContrPk#
            AND DCDSV.DS_CONTR_DTL_PK                           = #dsContractDtlPk#
            <iterate property="ctrlStsCd" var="ctrlStsCd[]" open="AND DCDSV.DS_CONTR_CTRL_STS_CD IN (" close=")" conjunction=",">
                #ctrlStsCd[]#
            </iterate>
            AND DCDSV.EZCANCELFLAG                              = '0'
   </statement>

   <statement id="getContrBllgMtrStsV" parameterClass="Map" resultClass="BigDecimal">
      SELECT
           count(*) AS CNT
      FROM
             DS_CONTR_BLLG_MTR_STS_V DSBMSV
      WHERE

            DSBMSV.GLBL_CMPY_CD                                  = #glblCmpyCd#
            AND DSBMSV.DS_CONTR_DTL_PK                           = #dsContractDtlPk#
            <iterate property="ctrlStsCd" var="ctrlStsCd[]" open="AND DSBMSV.DS_CONTR_CTRL_STS_CD IN (" close=")" conjunction=",">
                #ctrlStsCd[]#
            </iterate>
            AND DSBMSV.DS_CONTR_BLLG_MTR_PK                      = #dsContrCtrBllgMtrPk#
            AND DSBMSV.EZCANCELFLAG                              = '0'
   </statement>

    <!-- START 2017/10/04 K.Kojima [QC#20523,ADD] -->
    <statement id="getRenewalHoldforPoReleaseDsContrPrcEffPk" parameterClass="Map" resultClass="BigDecimal">
        <!-- START 2019/11/06 K.Kitachi [QC#54368, MOD] -->
        <!-- SELECT -->
        <!--      DS_CONTR_PRC_EFF_PK -->
        <!-- FROM -->
        <!--     ( -->
        <!--         SELECT -->
        <!--              DCPE.DS_CONTR_PRC_EFF_PK -->
        <!--             ,DCPE.CONTR_PRC_EFF_THRU_DT -->
        <!--             ,CASE -->
        <!--                 WHEN -->
        <!--                     DCPE.BASE_CHRG_FLG = #flgY# -->
        <!--                 THEN -->
        <!--                     NVL(NVL(DCCCPB.PO_DT, DCCCPD.PO_DT), DCCCPH.PO_DT) -->
        <!--                 ELSE -->
        <!--                     NVL(NVL(DCCCPU.PO_DT, DCCCPD.PO_DT), DCCCPH.PO_DT) -->
        <!--                 END AS PO_DT -->
        <!--         FROM -->
        <!--              DS_CONTR_DTL        DCD -->
        <!--             ,DS_CONTR_PRC_EFF    DCPE -->
        <!--             ,DS_CONTR_CR_CARD_PO DCCCPH -->
        <!--             ,DS_CONTR_CR_CARD_PO DCCCPD -->
        <!--             ,DS_CONTR_CR_CARD_PO DCCCPB -->
        <!--             ,DS_CONTR_CR_CARD_PO DCCCPU -->
        <!--         WHERE -->
        <!--                 DCD.GLBL_CMPY_CD                = #glblCmpyCd# -->
        <!--             AND DCD.DS_CONTR_PK                 = #dsContrPk# -->
        <!--             AND DCD.EZCANCELFLAG                = '0' -->
        <!--             AND DCD.GLBL_CMPY_CD                = DCPE.GLBL_CMPY_CD -->
        <!--             AND DCD.DS_CONTR_DTL_PK             = DCPE.DS_CONTR_DTL_PK -->
        <!--             AND DCPE.DS_CONTR_PRC_EFF_STS_CD    = #renewalHoldForPO# -->
        <!--             AND DCPE.EZCANCELFLAG               = '0' -->
        <!--             AND DCD.GLBL_CMPY_CD                = DCCCPH.GLBL_CMPY_CD(+) -->
        <!--             AND DCD.DS_CONTR_PK                 = DCCCPH.DS_CONTR_PK(+) -->
        <!--             AND DCCCPH.DS_CONTR_MACH_LVL_NUM(+) = #dsContrMachLvlNum1# -->
                    <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
        <!--             AND DCCCPH.CR_CARD_FLG(+)           = 'N' -->
                    <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
        <!--             AND DCCCPH.EZCANCELFLAG(+)          = '0' -->
        <!--             AND DCPE.GLBL_CMPY_CD               = DCCCPD.GLBL_CMPY_CD(+) -->
        <!--             AND DCPE.DS_CONTR_DTL_PK            = DCCCPD.DS_CONTR_DTL_PK(+) -->
        <!--             AND DCCCPD.DS_CONTR_MACH_LVL_NUM(+) = #dsContrMachLvlNum2# -->
                    <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
        <!--             AND DCCCPD.CR_CARD_FLG(+)           = 'N' -->
                    <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
        <!--             AND DCCCPD.EZCANCELFLAG(+)          = '0' -->
        <!--             AND DCPE.GLBL_CMPY_CD               = DCCCPB.GLBL_CMPY_CD(+) -->
        <!--             AND DCPE.DS_CONTR_DTL_PK            = DCCCPB.DS_CONTR_DTL_PK(+) -->
        <!--             AND DCCCPB.DS_CONTR_MACH_LVL_NUM(+) = #dsContrMachLvlNum3# -->
        <!--             AND DCCCPB.DS_CONTR_BLLG_MTR_PK IS NULL -->
                    <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
        <!--             AND DCCCPB.CR_CARD_FLG(+)           = 'N' -->
                    <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
        <!--             AND DCCCPB.EZCANCELFLAG(+)          = '0' -->
        <!--             AND DCPE.GLBL_CMPY_CD               = DCCCPU.GLBL_CMPY_CD(+) -->
        <!--             AND DCPE.DS_CONTR_BLLG_MTR_PK       = DCCCPU.DS_CONTR_BLLG_MTR_PK(+) -->
        <!--             AND DCCCPU.DS_CONTR_MACH_LVL_NUM(+) = #dsContrMachLvlNum3# -->
                    <!-- START 2019/01/10 K.Kitachi [QC#26928, ADD] -->
        <!--             AND DCCCPU.CR_CARD_FLG(+)           = 'N' -->
                    <!-- END 2019/01/10 K.Kitachi [QC#26928, ADD] -->
        <!--             AND DCCCPU.EZCANCELFLAG(+)          = '0' -->
        <!--     ) -->
        <!-- WHERE -->
        <!--     CONTR_PRC_EFF_THRU_DT &lt;= PO_DT -->
        <!-- ORDER BY -->
        <!--      DS_CONTR_PRC_EFF_PK -->
        WITH DS_CONTR_PO AS (
            SELECT
                 A.DS_CONTR_PK
                ,A.DS_CONTR_DTL_PK
                ,A.DS_CONTR_BLLG_MTR_PK
                ,A.DS_CONTR_MACH_LVL_NUM
                ,A.PO_FROM_DT
                ,A.PO_DT
            FROM
                DS_CONTR_CR_CARD_PO A
            WHERE
                    A.GLBL_CMPY_CD = #glblCmpyCd#
                AND A.DS_CONTR_PK  = #dsContrPk#
                AND A.CR_CARD_FLG  = 'N'
                AND A.PO_FROM_DT   IS NOT NULL
                AND A.PO_DT        IS NOT NULL
                AND A.EZCANCELFLAG = '0'
        )
        SELECT
            B.DS_CONTR_PRC_EFF_PK
        FROM
             DS_CONTR_DTL     A
            ,DS_CONTR_PRC_EFF B
        WHERE
                A.GLBL_CMPY_CD            = #glblCmpyCd#
            AND A.DS_CONTR_PK             = #dsContrPk#
            AND A.RNW_EFF_FROM_DT         IS NOT NULL
            AND A.EZCANCELFLAG            = '0'
            AND A.GLBL_CMPY_CD            = B.GLBL_CMPY_CD
            AND A.DS_CONTR_DTL_PK         = B.DS_CONTR_DTL_PK
            AND B.DS_CONTR_PRC_EFF_STS_CD = #renewalHoldForPO#
            AND B.EZCANCELFLAG            = '0'
            AND (
                EXISTS (
                    SELECT
                        1
                    FROM
                        DS_CONTR_PO X
                    WHERE
                            A.DS_CONTR_PK           = X.DS_CONTR_PK
                        AND B.CONTR_PRC_EFF_FROM_DT BETWEEN X.PO_FROM_DT AND X.PO_DT
                        AND X.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvlNum1#
                )
             OR EXISTS (
                    SELECT
                        1
                    FROM
                        DS_CONTR_PO X
                    WHERE
                            A.DS_CONTR_DTL_PK       = X.DS_CONTR_DTL_PK
                        AND B.CONTR_PRC_EFF_FROM_DT BETWEEN X.PO_FROM_DT AND X.PO_DT
                        AND X.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvlNum2#
                )
             OR EXISTS (
                    SELECT
                        1
                    FROM
                        DS_CONTR_PO X
                    WHERE
                            A.DS_CONTR_DTL_PK               = X.DS_CONTR_DTL_PK
                        AND NVL(B.DS_CONTR_BLLG_MTR_PK, -1) = NVL(X.DS_CONTR_BLLG_MTR_PK, -1)
                        AND B.CONTR_PRC_EFF_FROM_DT BETWEEN X.PO_FROM_DT AND X.PO_DT
                        AND X.DS_CONTR_MACH_LVL_NUM         = #dsContrMachLvlNum3#
                )
            )
        ORDER BY
            B.DS_CONTR_PRC_EFF_PK
        <!-- END 2019/11/06 K.Kitachi [QC#54368, MOD] -->
    </statement>

    <statement id="getRenewalHoldforPoReleaseDsContrDtlPk" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            DCDM.DS_CONTR_DTL_PK
        FROM
             DS_CONTR_DTL DCDF
            ,DS_CONTR_DTL DCDM
        WHERE
                DCDF.GLBL_CMPY_CD        = #glblCmpyCd#
            AND DCDF.DS_CONTR_DTL_PK     = #dsContrDtlPk#
            AND DCDF.EZCANCELFLAG        = '0'
            AND DCDF.GLBL_CMPY_CD        = DCDM.GLBL_CMPY_CD
            AND DCDF.DS_CONTR_PK         = DCDM.DS_CONTR_PK
            AND DCDM.DS_CONTR_DTL_STS_CD = #renewalHoldForPO#
            AND DCDM.EZCANCELFLAG        = '0'
        ORDER BY
            DCDM.DS_CONTR_DTL_PK
    </statement>
    <!-- END 2017/10/04 K.Kojima [QC#20523,ADD] -->
<!-- START [QC#55590,ADD] -->
    <statement id="getDsPoReqFlg" parameterClass="Map" resultClass="String">
        SELECT
             B.DS_PO_REQ_FLG
        FROM
            DS_CONTR A
            ,DS_CUST_TRX_RULE B
        WHERE
            A.GLBL_CMPY_CD      = #glblCmpyCd#
        AND A.DS_CONTR_PK       = #dsContrPk#
        AND A.GLBL_CMPY_CD      = B.GLBL_CMPY_CD
        AND A.DS_ACCT_NUM       = B.DS_ACCT_NUM
        AND B.DS_TRX_RULE_TP_CD = #dsTrxRuleTpCd#
        AND A.EZCANCELFLAG      = '0'
        AND B.EZCANCELFLAG      = '0'
    </statement>
    <statement id="getRenewalHoldforPoReleaseDsContrPrcEffPk4NonPo" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            B.DS_CONTR_PRC_EFF_PK
        FROM
             DS_CONTR_DTL     A
            ,DS_CONTR_PRC_EFF B
        WHERE
                A.GLBL_CMPY_CD            = #glblCmpyCd#
            AND A.DS_CONTR_PK             = #dsContrPk#
            AND A.RNW_EFF_FROM_DT         IS NOT NULL
            AND A.EZCANCELFLAG            = '0'
            AND A.GLBL_CMPY_CD            = B.GLBL_CMPY_CD
            AND A.DS_CONTR_DTL_PK         = B.DS_CONTR_DTL_PK
            AND B.DS_CONTR_PRC_EFF_STS_CD = #renewalHoldForPO#
            AND B.EZCANCELFLAG            = '0'
        ORDER BY
            B.DS_CONTR_PRC_EFF_PK
    </statement>
<!-- END [QC#55590,ADD] -->
</sqlMap>
