<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSAB082001">
    <statement id="getMainMachContrDtlPkList" parameterClass="Map" resultClass="BigDecimal">
        SELECT DISTINCT
            A.PRNT_DS_CONTR_DTL_PK
        FROM
             DS_CONTR_DTL            A
            ,SVC_MACH_MSTR           B
            ,MDSE_TERM_COND_OPT      C
            ,TERM_COND_OPT_ATTRB_MAP D
        WHERE
                A.GLBL_CMPY_CD                               = #glblCmpyCd#
            AND A.EZCANCELFLAG                               = '0'
            AND MOD(A.DS_CONTR_PK, #divisionNum#)            = #residue#
            AND (
                    A.TERM_COND_UPD_STS_CD IS NULL
                 OR A.TERM_COND_UPD_STS_CD  = #termCondUpdStsUpdated#
                )
            <!-- AND NVL(A.CONTR_CLO_DT, A.CONTR_EFF_THRU_DT)  &lt; #slsDt# -->
            <!-- START 2019/07/01  K.Fujimoto [QC#50967, MOD] -->
            AND (
                  NVL(A.CONTR_CLO_DT, A.CONTR_EFF_THRU_DT)  &lt; #slsDt#
                  OR
                  A.CONTR_EFF_FROM_DT                       &gt; #slsDt#
                 )
            <!-- END     2019/07/01  K.Fujimoto [QC#50967, MOD] -->
            AND A.GLBL_CMPY_CD                               = B.GLBL_CMPY_CD
            AND A.SVC_MACH_MSTR_PK                           = B.SVC_MACH_MSTR_PK
            AND B.EZCANCELFLAG                               = '0'
            AND B.GLBL_CMPY_CD                               = C.GLBL_CMPY_CD
            AND B.MDSE_CD                                    = C.MDSE_CD
            AND C.EZCANCELFLAG                               = '0'
            AND C.GLBL_CMPY_CD                               = D.GLBL_CMPY_CD
            AND C.TERM_COND_OPT_TP_CD                        = D.TERM_COND_OPT_TP_CD
            AND D.EZCANCELFLAG                               = '0'
        ORDER BY
            A.PRNT_DS_CONTR_DTL_PK
    </statement>
    <!-- START 2019/07/01  K.Fujimoto [QC#50967, MOD] -->
    <!-- <statement id="getAddlChrgContrDtlPkList" parameterClass="Map" resultClass="BigDecimal"> -->
    <statement id="getAddlChrgContrDtlPkList" parameterClass="Map" resultClass="Map">
        SELECT DISTINCT
             A.DS_CONTR_DTL_PK        AS DS_CONTR_DTL_PK
            ,CASE
               WHEN A.CONTR_EFF_FROM_DT  &gt; #slsDt#
               THEN 'N'
               ELSE 'Y'
               END                    AS TRMD_FLG
            <!-- END   2019/07/01  K.Fujimoto [QC#50967, MOD] -->
        FROM
             DS_CONTR_DTL            A
            ,SVC_MACH_MSTR           B
            ,MDSE_TERM_COND_OPT      C
            ,TERM_COND_OPT_ATTRB_MAP D
            <!-- Add Start 2019/01/16 QC#29814 -->
            ,DS_CONTR_DTL            E
            <!-- Add End 2019/01/16 QC#29814 -->
        WHERE
                A.GLBL_CMPY_CD                               = #glblCmpyCd#
            AND A.EZCANCELFLAG                               = '0'
            AND A.PRNT_DS_CONTR_DTL_PK                       = #dsContrDtlPk#
            AND (
                    A.TERM_COND_UPD_STS_CD IS NULL
                 OR A.TERM_COND_UPD_STS_CD  = #termCondUpdStsUpdated#
                )
            <!-- AND NVL(A.CONTR_CLO_DT, A.CONTR_EFF_THRU_DT)  &lt; #slsDt# -->
            <!-- START 2019/07/01  K.Fujimoto [QC#50967, MOD] -->
            AND (
                  (
                        NVL(A.CONTR_CLO_DT, A.CONTR_EFF_THRU_DT)  &lt; #slsDt#
                    AND NVL(E.CONTR_CLO_DT, E.CONTR_EFF_THRU_DT)  &gt; NVL(A.CONTR_CLO_DT, A.CONTR_EFF_THRU_DT)
                  )
                  OR
                        A.CONTR_EFF_FROM_DT                       &gt; #slsDt#
                 )
            <!-- END     2019/07/01  K.Fujimoto [QC#50967, MOD] -->
            AND A.GLBL_CMPY_CD                               = B.GLBL_CMPY_CD
            AND A.SVC_MACH_MSTR_PK                           = B.SVC_MACH_MSTR_PK
            AND B.EZCANCELFLAG                               = '0'
            AND B.GLBL_CMPY_CD                               = C.GLBL_CMPY_CD
            AND B.MDSE_CD                                    = C.MDSE_CD
            AND C.EZCANCELFLAG                               = '0'
            AND C.GLBL_CMPY_CD                               = D.GLBL_CMPY_CD
            AND C.TERM_COND_OPT_TP_CD                        = D.TERM_COND_OPT_TP_CD
            AND D.EZCANCELFLAG                               = '0'
            <!-- Add Start 2019/01/16 QC#29814 -->
            AND A.PRNT_DS_CONTR_DTL_PK                       = E.DS_CONTR_DTL_PK
            AND A.GLBL_CMPY_CD                               = E.GLBL_CMPY_CD
            AND E.EZCANCELFLAG                               = '0'
            <!-- START 2019/07/01  K.Fujimoto [QC#50967, DEL] -->
            <!-- AND NVL(E.CONTR_CLO_DT, E.CONTR_EFF_THRU_DT)  &gt; NVL(A.CONTR_CLO_DT, A.CONTR_EFF_THRU_DT) -->
            <!-- END   2019/07/01  K.Fujimoto [QC#50967, DEL] -->
            <!-- Add End 2019/01/16 QC#29814 -->
        ORDER BY
            A.DS_CONTR_DTL_PK
    </statement>
    <statement id="getAddlChrgTermCondList" parameterClass="Map" resultClass="Map">
        SELECT
             E.DS_CONTR_PK
            ,E.DS_CONTR_DTL_PK
            ,D.SVC_TERM_COND_ATTRB_PK
            ,F.SVC_TERM_COND_PK
        FROM
             DS_CONTR_DTL            A
            ,SVC_MACH_MSTR           B
            ,MDSE_TERM_COND_OPT      C
            ,TERM_COND_OPT_ATTRB_MAP D
            ,DS_CONTR_DTL            E
            ,SVC_TERM_COND           F
        WHERE
                A.GLBL_CMPY_CD                               = #glblCmpyCd#
            AND A.EZCANCELFLAG                               = '0'
            AND A.DS_CONTR_DTL_PK                            = #dsContrDtlPk#
            AND A.GLBL_CMPY_CD                               = B.GLBL_CMPY_CD
            AND A.SVC_MACH_MSTR_PK                           = B.SVC_MACH_MSTR_PK
            AND B.EZCANCELFLAG                               = '0'
            AND B.GLBL_CMPY_CD                               = C.GLBL_CMPY_CD
            AND B.MDSE_CD                                    = C.MDSE_CD
            AND C.EZCANCELFLAG                               = '0'
            AND C.GLBL_CMPY_CD                               = D.GLBL_CMPY_CD
            AND C.TERM_COND_OPT_TP_CD                        = D.TERM_COND_OPT_TP_CD
            AND D.EZCANCELFLAG                               = '0'
            AND A.GLBL_CMPY_CD                               = E.GLBL_CMPY_CD
            AND A.PRNT_DS_CONTR_DTL_PK                       = E.DS_CONTR_DTL_PK
            AND E.EZCANCELFLAG                               = '0'
            AND E.GLBL_CMPY_CD                               = F.GLBL_CMPY_CD           (+)
            AND D.SVC_TERM_COND_ATTRB_PK                     = F.SVC_TERM_COND_ATTRB_PK (+)
            AND E.DS_CONTR_PK                                = F.DS_CONTR_PK            (+)
            AND E.DS_CONTR_DTL_PK                            = F.DS_CONTR_DTL_PK        (+)
            AND F.EZCANCELFLAG                           (+) = '0'
        ORDER BY
            D.SVC_TERM_COND_ATTRB_PK
    </statement>
    <statement id="countOtherAddlChrgTermCond" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            COUNT(1)
        FROM
             DS_CONTR_DTL            A
            ,SVC_MACH_MSTR           B
            ,MDSE_TERM_COND_OPT      C
            ,TERM_COND_OPT_ATTRB_MAP D
        WHERE
                A.GLBL_CMPY_CD                               = #glblCmpyCd#
            AND A.EZCANCELFLAG                               = '0'
            AND A.PRNT_DS_CONTR_DTL_PK                       = #dsContrDtlPk#
            AND A.CONTR_EFF_FROM_DT                      &lt;= #slsDt#
            AND NVL(A.CONTR_CLO_DT, A.CONTR_EFF_THRU_DT) &gt;= #slsDt#
            AND (
                    A.TERM_COND_UPD_STS_CD IS NULL
                 OR A.TERM_COND_UPD_STS_CD  = #termCondUpdStsUpdated#
                )
            AND A.GLBL_CMPY_CD                               = B.GLBL_CMPY_CD
            AND A.SVC_MACH_MSTR_PK                           = B.SVC_MACH_MSTR_PK
            AND B.EZCANCELFLAG                               = '0'
            AND B.GLBL_CMPY_CD                               = C.GLBL_CMPY_CD
            AND B.MDSE_CD                                    = C.MDSE_CD
            AND C.EZCANCELFLAG                               = '0'
            AND C.GLBL_CMPY_CD                               = D.GLBL_CMPY_CD
            AND C.TERM_COND_OPT_TP_CD                        = D.TERM_COND_OPT_TP_CD
            AND D.EZCANCELFLAG                               = '0'
            AND D.ENBL_FLG                                   = 'Y'
            AND D.SVC_TERM_COND_ATTRB_PK                     = #svcTermCondAttrbPk#
            AND ROWNUM                                       = 1
    </statement>
    <statement id="getResetAddlChrgContrDtlPkList" parameterClass="Map" resultClass="BigDecimal">
        SELECT DISTINCT
            A.DS_CONTR_DTL_PK
        FROM
             DS_CONTR_DTL            A
            ,SVC_MACH_MSTR           B
            ,MDSE_TERM_COND_OPT      C
            ,TERM_COND_OPT_ATTRB_MAP D
        WHERE
                A.GLBL_CMPY_CD                               = #glblCmpyCd#
            AND A.EZCANCELFLAG                               = '0'
            AND A.PRNT_DS_CONTR_DTL_PK                       = #dsContrDtlPk#
            AND A.CONTR_EFF_FROM_DT                      &lt;= #slsDt#
            AND NVL(A.CONTR_CLO_DT, A.CONTR_EFF_THRU_DT) &gt;= #slsDt#
            AND (
                    A.TERM_COND_UPD_STS_CD IS NULL
                 OR A.TERM_COND_UPD_STS_CD  = #termCondUpdStsUpdated#
                )
            AND A.GLBL_CMPY_CD                               = B.GLBL_CMPY_CD
            AND A.SVC_MACH_MSTR_PK                           = B.SVC_MACH_MSTR_PK
            AND B.EZCANCELFLAG                               = '0'
            AND B.GLBL_CMPY_CD                               = C.GLBL_CMPY_CD
            AND B.MDSE_CD                                    = C.MDSE_CD
            AND C.EZCANCELFLAG                               = '0'
            AND C.GLBL_CMPY_CD                               = D.GLBL_CMPY_CD
            AND C.TERM_COND_OPT_TP_CD                        = D.TERM_COND_OPT_TP_CD
            AND D.EZCANCELFLAG                               = '0'
            AND D.ENBL_FLG                                   = 'Y'
        ORDER BY
            A.DS_CONTR_DTL_PK
    </statement>
    <statement id="getResetMainMachTermCondList" parameterClass="Map" resultClass="Map">
        WITH TARGET_DTL AS (
            SELECT
                 A.GLBL_CMPY_CD
                ,A.EZINTIME
                ,A.DS_CONTR_PK
                ,A.DS_CONTR_DTL_PK
                ,A.PRNT_DS_CONTR_DTL_PK
                ,A.DS_CONTR_CATG_CD
                ,A.TERM_COND_OPT_TP_CD
                ,A.TERM_COND_OPT_VAL_TXT
                ,A.SVC_TERM_COND_ATTRB_PK
            FROM (
                SELECT
                     B.GLBL_CMPY_CD           AS GLBL_CMPY_CD
                    ,A.EZINTIME               AS EZINTIME
                    ,B.DS_CONTR_PK            AS DS_CONTR_PK
                    ,A.DS_CONTR_DTL_PK        AS DS_CONTR_DTL_PK
                    ,A.PRNT_DS_CONTR_DTL_PK   AS PRNT_DS_CONTR_DTL_PK
                    ,B.DS_CONTR_CATG_CD       AS DS_CONTR_CATG_CD
                    ,D.TERM_COND_OPT_TP_CD    AS TERM_COND_OPT_TP_CD
                    ,D.TERM_COND_OPT_VAL_TXT  AS TERM_COND_OPT_VAL_TXT
                    ,E.SVC_TERM_COND_ATTRB_PK AS SVC_TERM_COND_ATTRB_PK
                    ,DENSE_RANK() OVER(PARTITION BY A.PRNT_DS_CONTR_DTL_PK, E.SVC_TERM_COND_ATTRB_PK ORDER BY A.EZINTIME DESC, A.DS_CONTR_DTL_PK DESC) AS RANK
                FROM
                     DS_CONTR_DTL            A
                    ,DS_CONTR                B
                    ,SVC_MACH_MSTR           C
                    ,MDSE_TERM_COND_OPT      D
                    ,TERM_COND_OPT_ATTRB_MAP E
                WHERE
                        A.GLBL_CMPY_CD                               = #glblCmpyCd#
                    AND A.EZCANCELFLAG                               = '0'
                    <iterate property="dsContrDtlPkList" var="dsContrDtlPk[]" open="AND A.DS_CONTR_DTL_PK IN (" close=")" conjunction=",">
                        #dsContrDtlPk[]#
                    </iterate>
                    AND A.CONTR_EFF_FROM_DT                      &lt;= #slsDt#
                    AND NVL(A.CONTR_CLO_DT, A.CONTR_EFF_THRU_DT) &gt;= #slsDt#
                    AND (
                            A.TERM_COND_UPD_STS_CD IS NULL
                         OR A.TERM_COND_UPD_STS_CD  = #termCondUpdStsUpdated#
                        )
                    AND A.GLBL_CMPY_CD                               = B.GLBL_CMPY_CD
                    AND A.DS_CONTR_PK                                = B.DS_CONTR_PK
                    AND B.EZCANCELFLAG                               = '0'
                    AND A.GLBL_CMPY_CD                               = C.GLBL_CMPY_CD
                    AND A.SVC_MACH_MSTR_PK                           = C.SVC_MACH_MSTR_PK
                    AND C.EZCANCELFLAG                               = '0'
                    AND C.GLBL_CMPY_CD                               = D.GLBL_CMPY_CD
                    AND C.MDSE_CD                                    = D.MDSE_CD
                    AND D.EZCANCELFLAG                               = '0'
                    AND D.GLBL_CMPY_CD                               = E.GLBL_CMPY_CD
                    AND D.TERM_COND_OPT_TP_CD                        = E.TERM_COND_OPT_TP_CD
                    AND E.EZCANCELFLAG                               = '0'
                    AND E.ENBL_FLG                                   = 'Y'
                ) A
            WHERE
                A.RANK = 1
        )
        SELECT
             Z.ADDL_DS_CONTR_DTL_PK
            ,Z.DS_CONTR_PK
            ,Z.DS_CONTR_DTL_PK
            ,Z.SVC_TERM_COND_ATTRB_PK
            ,Z.TERM_COND_OPT_VAL_TXT
            ,Z.SVC_TERM_COND_PK
            ,Z.SVC_TERM_ATTRB_MAP_VAL_CD
        FROM (
            SELECT
                 B.GLBL_CMPY_CD              AS GLBL_CMPY_CD
                ,A.DS_CONTR_DTL_PK           AS ADDL_DS_CONTR_DTL_PK
                ,B.DS_CONTR_PK               AS DS_CONTR_PK
                ,B.DS_CONTR_DTL_PK           AS DS_CONTR_DTL_PK
                ,A.SVC_TERM_COND_ATTRB_PK    AS SVC_TERM_COND_ATTRB_PK
                ,D.SVC_TERM_COND_PK          AS SVC_TERM_COND_PK
                ,A.TERM_COND_OPT_VAL_TXT     AS TERM_COND_OPT_VAL_TXT
                ,D.SVC_TERM_ATTRB_MAP_VAL_CD AS SVC_TERM_ATTRB_MAP_VAL_CD
                ,A.EZINTIME                  AS EZINTIME
            FROM
                 TARGET_DTL      A
                ,DS_CONTR_DTL    B
                ,DS_CONTR_DTL_TP C
                ,SVC_TERM_COND   D
            WHERE
                    A.GLBL_CMPY_CD                               = B.GLBL_CMPY_CD
                AND A.PRNT_DS_CONTR_DTL_PK                       = B.DS_CONTR_DTL_PK
                AND B.EZCANCELFLAG                               = '0'
                AND B.CONTR_EFF_FROM_DT                      &lt;= #slsDt#
                AND NVL(B.CONTR_CLO_DT, B.CONTR_EFF_THRU_DT) &gt;= #slsDt#
                AND B.GLBL_CMPY_CD                               = C.GLBL_CMPY_CD
                AND B.DS_CONTR_DTL_TP_CD                         = C.DS_CONTR_DTL_TP_CD
                AND C.MAIN_UNIT_LINE_FLG                         = 'Y'
                AND C.EZCANCELFLAG                               = '0'
                AND B.GLBL_CMPY_CD                               = D.GLBL_CMPY_CD           (+)
                AND B.DS_CONTR_PK                                = D.DS_CONTR_PK            (+)
                AND B.DS_CONTR_DTL_PK                            = D.DS_CONTR_DTL_PK        (+)
                AND A.SVC_TERM_COND_ATTRB_PK                     = D.SVC_TERM_COND_ATTRB_PK (+)
                AND D.EZCANCELFLAG                           (+) = '0'
            ) Z
        WHERE
                Z.SVC_TERM_COND_PK                          IS NULL
             OR NVL(Z.TERM_COND_OPT_VAL_TXT, #space#) &lt;&gt; NVL(Z.SVC_TERM_ATTRB_MAP_VAL_CD, #space#)
        ORDER BY
             Z.DS_CONTR_PK
            ,Z.DS_CONTR_DTL_PK
            ,Z.SVC_TERM_COND_ATTRB_PK
            ,Z.EZINTIME
    </statement>
    <statement id="getResetAddlChrgTermCondList" parameterClass="Map" resultClass="Map">
        WITH TARGET_DTL AS (
            SELECT
                 B.GLBL_CMPY_CD           AS GLBL_CMPY_CD
                ,A.EZINTIME               AS EZINTIME
                ,B.DS_CONTR_PK            AS DS_CONTR_PK
                ,A.DS_CONTR_DTL_PK        AS DS_CONTR_DTL_PK
                ,A.PRNT_DS_CONTR_DTL_PK   AS PRNT_DS_CONTR_DTL_PK
                ,B.DS_CONTR_CATG_CD       AS DS_CONTR_CATG_CD
                ,D.TERM_COND_OPT_TP_CD    AS TERM_COND_OPT_TP_CD
                ,D.TERM_COND_OPT_VAL_TXT  AS TERM_COND_OPT_VAL_TXT
                ,E.SVC_TERM_COND_ATTRB_PK AS SVC_TERM_COND_ATTRB_PK
            FROM
                 DS_CONTR_DTL            A
                ,DS_CONTR                B
                ,SVC_MACH_MSTR           C
                ,MDSE_TERM_COND_OPT      D
                ,TERM_COND_OPT_ATTRB_MAP E
            WHERE
                    A.GLBL_CMPY_CD                               = #glblCmpyCd#
                AND A.EZCANCELFLAG                               = '0'
                <iterate property="dsContrDtlPkList" var="dsContrDtlPk[]" open="AND A.DS_CONTR_DTL_PK IN (" close=")" conjunction=",">
                    #dsContrDtlPk[]#
                </iterate>
                AND A.CONTR_EFF_FROM_DT                      &lt;= #slsDt#
                AND NVL(A.CONTR_CLO_DT, A.CONTR_EFF_THRU_DT) &gt;= #slsDt#
                AND (
                        A.TERM_COND_UPD_STS_CD IS NULL
                     OR A.TERM_COND_UPD_STS_CD  = #termCondUpdStsUpdated#
                    )
                AND A.GLBL_CMPY_CD                               = B.GLBL_CMPY_CD
                AND A.DS_CONTR_PK                                = B.DS_CONTR_PK
                AND B.EZCANCELFLAG                               = '0'
                AND A.GLBL_CMPY_CD                               = C.GLBL_CMPY_CD
                AND A.SVC_MACH_MSTR_PK                           = C.SVC_MACH_MSTR_PK
                AND C.EZCANCELFLAG                               = '0'
                AND C.GLBL_CMPY_CD                               = D.GLBL_CMPY_CD
                AND C.MDSE_CD                                    = D.MDSE_CD
                AND D.EZCANCELFLAG                               = '0'
                AND D.GLBL_CMPY_CD                               = E.GLBL_CMPY_CD
                AND D.TERM_COND_OPT_TP_CD                        = E.TERM_COND_OPT_TP_CD
                AND E.EZCANCELFLAG                               = '0'
                AND E.ENBL_FLG                                   = 'Y'
        )
        SELECT
             Z.ADDL_DS_CONTR_DTL_PK
            ,Z.DS_CONTR_PK
            ,Z.DS_CONTR_DTL_PK
            ,Z.SVC_TERM_COND_ATTRB_PK
            ,Z.TERM_COND_OPT_VAL_TXT
            ,Z.SVC_TERM_COND_PK
            ,Z.SVC_TERM_ATTRB_MAP_VAL_CD
        FROM (
            SELECT
                 B.GLBL_CMPY_CD              AS GLBL_CMPY_CD
                ,A.DS_CONTR_DTL_PK           AS ADDL_DS_CONTR_DTL_PK
                ,B.DS_CONTR_PK               AS DS_CONTR_PK
                ,B.DS_CONTR_DTL_PK           AS DS_CONTR_DTL_PK
                ,A.SVC_TERM_COND_ATTRB_PK    AS SVC_TERM_COND_ATTRB_PK
                ,C.SVC_TERM_COND_PK          AS SVC_TERM_COND_PK
                ,A.TERM_COND_OPT_VAL_TXT     AS TERM_COND_OPT_VAL_TXT
                ,C.SVC_TERM_ATTRB_MAP_VAL_CD AS SVC_TERM_ATTRB_MAP_VAL_CD
                ,A.EZINTIME                  AS EZINTIME
            FROM
                 TARGET_DTL    A
                ,DS_CONTR_DTL  B
                ,SVC_TERM_COND C
            WHERE
                    A.GLBL_CMPY_CD                               = B.GLBL_CMPY_CD
                AND A.DS_CONTR_DTL_PK                            = B.DS_CONTR_DTL_PK
                AND B.EZCANCELFLAG                               = '0'
                AND B.CONTR_EFF_FROM_DT                      &lt;= #slsDt#
                AND NVL(B.CONTR_CLO_DT, B.CONTR_EFF_THRU_DT) &gt;= #slsDt#
                AND B.GLBL_CMPY_CD                               = C.GLBL_CMPY_CD           (+)
                AND B.DS_CONTR_PK                                = C.DS_CONTR_PK            (+)
                AND B.DS_CONTR_DTL_PK                            = C.DS_CONTR_DTL_PK        (+)
                AND A.SVC_TERM_COND_ATTRB_PK                     = C.SVC_TERM_COND_ATTRB_PK (+)
                AND C.EZCANCELFLAG                           (+) = '0'
            ) Z
        WHERE
                Z.SVC_TERM_COND_PK                          IS NULL
             OR NVL(Z.TERM_COND_OPT_VAL_TXT, #space#) &lt;&gt; NVL(Z.SVC_TERM_ATTRB_MAP_VAL_CD, #space#)
        ORDER BY
             Z.DS_CONTR_PK
            ,Z.DS_CONTR_DTL_PK
            ,Z.SVC_TERM_COND_ATTRB_PK
            ,Z.EZINTIME
    </statement>
</sqlMap>
