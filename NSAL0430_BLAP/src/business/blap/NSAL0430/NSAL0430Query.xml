<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NSAL0430Query">
<statement id="getSvcMachMstrInfo" parameterClass="Map" resultClass="Map">
SELECT
	SMM.SVC_MACH_MSTR_PK
,	SMM.SER_NUM
,	SMM.MDSE_CD
<!-- START START 2016/09/16 N.Arai [QC#11616, MOD] -->
<!-- ,	MDS.MDSE_NM   -->
,   MDS.MDSE_DESC_SHORT_TXT
<!-- END START 2016/09/16 N.Arai [QC#11616, MOD] -->
,	MDN.T_MDL_ID		AS	MDL_ID
,	MDN.T_MDL_NM		AS	MDL_NM
FROM
	SVC_MACH_MSTR		SMM
,	MDSE				MDS
,	SVC_CONFIG_MSTR		SCM
,	MDL_NM				MDN
WHERE
	SMM.SVC_MACH_MSTR_PK	=	#svcMachMstrPk#
AND	SMM.GLBL_CMPY_CD		=	#glblCmpyCd#
AND	SMM.EZCANCELFLAG		=	'0'
AND	SMM.MDSE_CD				=	MDS.MDSE_CD(+)
AND	SMM.GLBL_CMPY_CD		=	MDS.GLBL_CMPY_CD(+)
AND	SMM.EZCANCELFLAG		=	MDS.EZCANCELFLAG(+)
AND	SMM.SVC_CONFIG_MSTR_PK	=	SCM.SVC_CONFIG_MSTR_PK(+)
AND	SMM.GLBL_CMPY_CD		=	SCM.GLBL_CMPY_CD(+)
AND	SMM.EZCANCELFLAG		=	SCM.EZCANCELFLAG(+)
AND	SCM.MDL_ID		    	=	MDN.T_MDL_ID(+)
AND	SCM.GLBL_CMPY_CD		=	MDN.T_GLBL_CMPY_CD(+)
AND	SCM.EZCANCELFLAG		=	MDN.EZCANCELFLAG(+)
</statement>
<statement id="getSvcPhysMtrRead" parameterClass="Map" resultClass="Map">
WITH
	X	AS (
	SELECT
		SPM.GLBL_CMPY_CD
	,	SPM.EZCANCELFLAG
	,	SPM.SVC_PHYS_MTR_PK
	,	SPM.MDL_MTR_LB_CD
	FROM
		SVC_PHYS_MTR		SPM
	WHERE
		SPM.SVC_MACH_MSTR_PK	=	#svcMachMstrPk#
	AND	SPM.GLBL_CMPY_CD		=	#glblCmpyCd#
	AND	SPM.EZCANCELFLAG		=	'0'
)
,	A	AS (
	SELECT
		PMR.GLBL_CMPY_CD
	,	PMR.EZCANCELFLAG
	,	PMR.SVC_PHYS_MTR_READ_GRP_SQ
	,	PMR.SVC_PHYS_MTR_READ_PK
	,	PMR.SVC_MACH_MSTR_PK
	,	PMR.SVC_PHYS_MTR_PK
	,	PMR.DS_MTR_READ_TP_CD
	,	PMR.MTR_LB_CD
	,	PMR.MTR_READ_DT
	,	PMR.READ_MTR_CNT
	,	PMR.DS_MTR_READ_TP_GRP_CD
	FROM
		SVC_PHYS_MTR_READ	PMR
	WHERE
		PMR.SVC_MACH_MSTR_PK	=	#svcMachMstrPk#
	AND	PMR.GLBL_CMPY_CD		=	#glblCmpyCd#
    <!-- START 2018/10/09 K.Fujimoto [QC#28592, ADD] -->
    AND PMR.VLD_MTR_FLG         = 'Y'
    <!-- END   2018/10/09 K.Fujimoto [QC#28592, ADD] -->
	AND	PMR.EZCANCELFLAG		=	'0'
)
,	B	AS (
	SELECT
		A.GLBL_CMPY_CD
	,	A.EZCANCELFLAG
	,	A.SVC_PHYS_MTR_READ_GRP_SQ
	,	A.SVC_PHYS_MTR_READ_PK
	,	A.SVC_MACH_MSTR_PK
	,	X.SVC_PHYS_MTR_PK
	,	A.DS_MTR_READ_TP_CD
	,	X.MDL_MTR_LB_CD				AS	MTR_LB_CD
	,	A.MTR_READ_DT
	,	A.READ_MTR_CNT
	,	A.DS_MTR_READ_TP_GRP_CD
	FROM
		X
	LEFT OUTER JOIN
		A
	PARTITION BY (
		A.GLBL_CMPY_CD
	,	A.EZCANCELFLAG
	,	A.SVC_PHYS_MTR_READ_GRP_SQ
	,	A.SVC_MACH_MSTR_PK
	,	A.MTR_READ_DT
	,	A.DS_MTR_READ_TP_CD
	)
	ON (
		X.SVC_PHYS_MTR_PK		=	A.SVC_PHYS_MTR_PK
	AND	X.GLBL_CMPY_CD			=	A.GLBL_CMPY_CD
	AND	X.EZCANCELFLAG			=	A.EZCANCELFLAG
	)
)
SELECT
	*
FROM
(
	SELECT
		PMR.*
	,	MRT.DS_MTR_READ_TP_DESC_TXT
	,	MLB.MTR_LB_DESC_TXT
	,	ROW_NUMBER() OVER (
			PARTITION BY
				PMR.SVC_MACH_MSTR_PK
			ORDER BY
				PMR.MTR_READ_DT					DESC
			,	PMR.SVC_PHYS_MTR_READ_GRP_SQ	DESC
			,	MRT.DS_MTR_READ_TP_SORT_NUM		ASC
			,	MLB.MTR_LB_SORT_NUM				ASC
		) AS ROW_NUM
	FROM
		B					PMR
	,	DS_MTR_READ_TP		MRT
	,	DS_MTR_READ_TP_GRP	MTG
	,	MTR_LB				MLB
	WHERE
		PMR.SVC_MACH_MSTR_PK		=	#svcMachMstrPk#
	AND	PMR.GLBL_CMPY_CD			=	#glblCmpyCd#
	AND	PMR.EZCANCELFLAG			=	'0'
	AND	MRT.DS_MTR_READ_TP_CD		=	PMR.DS_MTR_READ_TP_CD
	AND	MRT.GLBL_CMPY_CD			=	PMR.GLBL_CMPY_CD
	AND	MRT.EZCANCELFLAG			=	PMR.EZCANCELFLAG
	AND	MTG.DS_MTR_READ_TP_GRP_CD	=	PMR.DS_MTR_READ_TP_GRP_CD
	AND	MTG.GLBL_CMPY_CD			=	PMR.GLBL_CMPY_CD
	AND	MTG.EZCANCELFLAG			=	PMR.EZCANCELFLAG
	AND	MLB.MTR_LB_CD				=	PMR.MTR_LB_CD
	AND	MLB.GLBL_CMPY_CD			=	PMR.GLBL_CMPY_CD
	AND	MLB.EZCANCELFLAG			=	PMR.EZCANCELFLAG
)
<!-- START 2018/12/28 S.Kitamura [QC#29718,DEL] -->
<!-- WHERE -->
<!-- 	ROW_NUM							&lt;=	#rowNum# -->
<!-- END 2018/12/28 S.Kitamura [QC#29718,DEL] -->
ORDER BY
	ROW_NUM
</statement>
<statement id="getDsMtrReadTpGrp" parameterClass="Map" resultClass="Map">
SELECT
	MTG.*
FROM
	DS_MTR_READ_TP_GRP	MTG
WHERE
	MTG.GLBL_CMPY_CD	=	#glblCmpyCd#
AND	MTG.EZCANCELFLAG	=	'0'
</statement>
<statement id="getPhysMtrLb" parameterClass="Map" resultClass="Map">
SELECT DISTINCT
	SPM.SVC_PHYS_MTR_PK
,	SPM.MTR_LB_CD
,	MLB.MTR_LB_DESC_TXT
,	MLB.MTR_LB_SORT_NUM
FROM
	SVC_PHYS_MTR_READ		SPM
,	MTR_LB					MLB
WHERE
	SPM.SVC_MACH_MSTR_PK	=	#svcMachMstrPk#
AND	SPM.GLBL_CMPY_CD		=	#glblCmpyCd#
AND	SPM.EZCANCELFLAG		=	'0'
AND	MLB.MTR_LB_CD			=	SPM.MTR_LB_CD
AND	MLB.GLBL_CMPY_CD		=	SPM.GLBL_CMPY_CD
AND	MLB.EZCANCELFLAG		=	SPM.EZCANCELFLAG
ORDER BY
	MLB.MTR_LB_SORT_NUM		ASC
</statement>
<!-- START 2018/12/28 S.Kitamura [QC#29718,DEL] -->
<!-- <statement id="getAllPhysMtrLb" parameterClass="Map" resultClass="Map"> -->
<!-- SELECT -->
<!-- 	MLB.* -->
<!-- FROM -->
<!-- 	MTR_LB	MLB -->
<!-- WHERE -->
<!-- 	MLB.MTR_LB_TP_CD	=	#mtrLbTpCd# -->
<!-- AND	MLB.GLBL_CMPY_CD	=	#glblCmpyCd# -->
<!-- AND	MLB.EZCANCELFLAG	=	'0' -->
<!-- </statement> -->
<!-- END 2018/12/28 S.Kitamura [QC#29718,DEL] -->
</sqlMap>