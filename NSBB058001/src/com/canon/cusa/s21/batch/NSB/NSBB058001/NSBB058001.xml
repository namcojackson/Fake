<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSBB058001">
    <statement id="getConfigInfo" parameterClass="Map" resultClass="Map">
<!-- START 2023/03/03 L.Mandanas [CSA#61067, DEL] -->
<!--
        SELECT
             SMM.SER_NUM                AS SER_NUM
            ,SM2.MDSE_CD                AS MDSE_CD
            ,SM2.ISTL_DT                AS ISTL_DT
            ,SM2.SER_NUM                AS CHILD_SER_NUM
            ,MDS.MDSE_DESC_SHORT_TXT    AS MDSE_DESC_SHORT_TXT
        FROM
             SVC_MACH_MSTR        SM2
            ,MDSE                 MDS
            ,(
            SELECT
                 SM.SER_NUM                 AS SER_NUM
                ,SM.SVC_CONFIG_MSTR_PK      AS SVC_CONFIG_MSTR_PK
                ,ST.SVC_MACH_MSTR_PK        AS SVC_MACH_MSTR_PK
            FROM
                 SVC_TASK         ST
                ,SVC_MACH_MSTR    SM
            WHERE
                    ST.GLBL_CMPY_CD         = #glblCmpyCd#
                AND ST.GLBL_CMPY_CD         = SM.GLBL_CMPY_CD
                AND ST.SVC_MACH_MSTR_PK     = SM.SVC_MACH_MSTR_PK
                AND ST.EZCANCELFLAG         = '0'
                AND SM.EZCANCELFLAG         = '0'
                AND EXISTS (
                    SELECT 
                        1
                    FROM
                        FSR_EVENT    FE
                    WHERE
                            FE.GLBL_CMPY_CD         = ST.GLBL_CMPY_CD
                        AND FE.SVC_TASK_NUM         = ST.SVC_TASK_NUM
                        <iterate property="svcDisptEventCd" var="svcDisptEventCd[]" open=" AND FE.SVC_DISPT_EVENT_CD IN  (" close=")" conjunction=",">
                        #svcDisptEventCd[]#
                        </iterate>
                        <isNotNull property="lastProcTs">
                        AND FE.FSR_EVENT_EXE_TS &gt;  #lastProcTs#
                        </isNotNull>
                        AND FE.FSR_EVENT_EXE_TS &lt;= #currentSystemTs#
                        AND FE.EZCANCELFLAG         = '0'
                    GROUP BY
                        FE.SVC_TASK_NUM ) )    SMM
        WHERE
                SM2.GLBL_CMPY_CD        = #glblCmpyCd#
            AND SM2.SVC_CONFIG_MSTR_PK  = SMM.SVC_CONFIG_MSTR_PK
            AND SM2.GLBL_CMPY_CD        = MDS.GLBL_CMPY_CD
            AND SM2.MDSE_CD             = MDS.MDSE_CD
            AND SM2.EZCANCELFLAG        = '0'
            AND MDS.EZCANCELFLAG        = '0'
        ORDER BY
             SMM.SVC_CONFIG_MSTR_PK  ASC
            ,SM2.SVC_MACH_TP_CD      ASC
            ,SMM.SER_NUM             ASC
            ,SM2.MDSE_CD             ASC
-->
<!-- END 2023/03/03 L.Mandanas [CSA#61067, DEL] -->
<!-- START 2023/03/03 L.Mandanas [CSA#61067, ADD] -->
        SELECT
<!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!--             MM1.SER_NUM                    AS SER_NUM-->
             CASE WHEN MM1.SLD_BY_LINE_BIZ_TP_CD = #crsSvcLobCd# AND MM1.SVC_BY_LINE_BIZ_TP_CD &lt;&gt; #crsSvcLobCd# AND MM1.SER_NUM &lt;&gt; MM1.CUST_MACH_CTRL_NUM THEN MM1.CUST_MACH_CTRL_NUM
                  ELSE    MM1.SER_NUM 
             END AS SER_NUM
<!--            ,MM2.SER_NUM                    AS CHILD_SER_NUM-->
            ,CASE WHEN MM2.SLD_BY_LINE_BIZ_TP_CD = #crsSvcLobCd# AND MM2.SVC_BY_LINE_BIZ_TP_CD &lt;&gt;#crsSvcLobCd# AND MM2.SER_NUM &lt;&gt;MM2.CUST_MACH_CTRL_NUM THEN MM2.CUST_MACH_CTRL_NUM
                  ELSE    MM2.SER_NUM 
            END AS CHILD_SER_NUM
<!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
            ,NVL(MM2.ISTL_DT, MM1.ISTL_DT)  AS ISTL_DT
            ,M.MDSE_DESC_SHORT_TXT          AS MDSE_DESC_SHORT_TXT
            ,MM2.MDSE_CD                    AS MDSE_CD
<!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!--            ,MM2.GLBL_CMPY_CD               AS GLBL_CMPY_CD_01-->
            ,#sndrCmpyCd#               AS GLBL_CMPY_CD_01
<!-- END 2023/07/06 R.Jin [CSA#61067, MOD] -->
            ,TO_CHAR(SYSDATE, #dateFormat#) AS CRAT_DT
            ,TO_CHAR(SYSDATE, #timeFormat#) AS CRAT_TM
            ,#procStsCd#                    AS IF_PROC_STS_CD
        FROM
             SVC_MACH_MSTR                  MM2
            ,MDSE                           M
            ,SVC_MACH_MSTR                  MM1
            <!-- START 2023/07/06 R.Jin [CSA#61067, ADD] -->
            ,SHIP_TO_CUST                   SHTC
            <!-- END 2023/07/06 R.Jin [CSA#61067, ADD] -->
        WHERE
                 MM2.GLBL_CMPY_CD           = #glblCmpyCd#
             AND MM2.EZCANCELFLAG           = 0
             AND MM2.SVC_MACH_TP_CD         = #svcMachTpAcc#
             AND MM2.GLBL_CMPY_CD           = M.GLBL_CMPY_CD
             AND MM2.MDSE_CD                = M.MDSE_CD
             AND M.EZCANCELFLAG             = 0
             AND MM2.GLBL_CMPY_CD           = MM1.GLBL_CMPY_CD
             AND MM2.SVC_CONFIG_MSTR_PK     = MM1.SVC_CONFIG_MSTR_PK
             AND MM2.SER_NUM                IS NOT NULL
             AND MM1.SVC_MACH_TP_CD         = #svcMachTpMach#
             <isNull property="isMonthly">
             AND EXISTS (
                 SELECT
                      1
                 FROM
                      FSR          F
                     ,SVC_TASK     SVT
                 WHERE
                         F.GLBL_CMPY_CD       = MM1.GLBL_CMPY_CD
                     AND MM1.SVC_MACH_MSTR_PK = SVT.SVC_MACH_MSTR_PK
                     AND SVT.SVC_TASK_STS_CD  = #svcTaskStsCd#
                     AND SVT.FSR_NUM          = F.FSR_NUM
                     AND F.EZCANCELFLAG       = '0'
                     AND F.FSR_STS_CD         = #fsrStsCd#
                     <!-- START 2023/07/06 R.Jin [CSA#61067, ADD] -->
                     AND F.FSR_NUM NOT LIKE '1%'
                     <!-- END 2023/07/06 R.Jin [CSA#61067, ADD] -->
<!-- START 2023/04/24 L.Mandanas [CSA#61067, MOD] -->
<!--                     AND F.FSR_CLO_DT||F.FSR_CLO_TM BETWEEN TO_CHAR(TO_DATE(#trgtDt#, #dateFormat#), #dateFormat#)||#fromTm# AND TO_CHAR(TO_DATE(#trgtDt#, #dateFormat#) + 1, #dateFormat#)||#toTm#  -->
<!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!--                     AND F.FSR_CLO_DT = TO_CHAR(TO_DATE(#trgtDt#, #dateFormat#), #dateFormat#)-->
                     AND F.FSR_CLO_DT BETWEEN TO_CHAR(TO_DATE(#slsDt#,  #dateFormat#) - #extrDys#,  #dateFormat#) AND TO_CHAR(TO_DATE(#slsDt#,  #dateFormat#)-1,  #dateFormat#)
<!-- END 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!-- END 2023/04/24 L.Mandanas [CSA#61067, MOD] -->
             )
             </isNull>
             <isNotNull property="isMonthly">
             <iterate property ="stsCdList" var="stsCd[]" open=" AND MM1.SVC_MACH_MSTR_STS_CD IN (" close=")" conjunction=",">
                  #stsCd[]#
             </iterate>
             </isNotNull>
             <!-- START 2023/07/06 R.Jin [CSA#61067, ADD] -->
             AND (MM1.SVC_BY_LINE_BIZ_TP_CD &lt;&gt; #crsSvcLobCd# 
                  OR (MM1.SVC_BY_LINE_BIZ_TP_CD = #crsSvcLobCd# and NVL(MM1.REQ_TECH_CD,#crsSvcTechCd#) &lt;&gt; #crsSvcTechCd#))
             AND NOT EXISTS(SELECT  *  FROM   S21_CSA_APPS.S21_PSN   X
                            WHERE
                              X.PSN_CD            = MM1.REQ_TECH_CD
                              AND X.GLBL_CMPY_CD  = MM1.GLBL_CMPY_CD
                              AND X.EZCANCELFLAG  = '0'
                              AND X.PSN_TP_CD     = #cmpsDelerTp#
             )
             AND SHTC.GLBL_CMPY_CD           = MM1.GLBL_CMPY_CD
             AND SHTC.SHIP_TO_CUST_CD        = MM1.CUR_LOC_NUM
             AND SHTC.CTRY_CD                = #findsCtryCd#
             AND SHTC.EZCANCELFLAG           = '0'
             <!-- END 2023/07/06 R.Jin [CSA#61067, ADD] -->
        ORDER BY
             MM2.SVC_CONFIG_MSTR_PK
            ,MM2.SVC_MACH_SQ_NUM
<!-- END 2023/03/03 L.Mandanas [CSA#61067, ADD] -->
    </statement>
</sqlMap>
