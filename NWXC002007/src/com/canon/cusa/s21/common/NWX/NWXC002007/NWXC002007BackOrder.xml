<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NWXC002007BackOrder">


<!--	<statement id="checkMaster" parameterClass="Map" resultClass="String">-->
<!---->
        <!--  ******* Whole Sales/ROSS Regular 10 Digit Item and SetItem ******** -->
        <!--  ******* Whole Sales Regular 8Digit OrderTake ******** -->
<!--		SELECT -->
<!--    		SP.SHPG_PLN_NUM-->
<!--		FROM -->
<!--      		SHPG_PLN                  SP-->
<!--   		  , CPO_DTL                   CD-->
<!--		WHERE -->
<!--		        SP.GLBL_CMPY_CD         = #glblCmpyCd#-->
<!--		    AND SP.MDSE_CD              LIKE  #mdseCd# ||'%'-->
<!--		    AND SP.TRX_SRC_TP_CD        in (#trxSrcTpWholeSales#, #trxSrcTpRetail#)					 Whole Sales/Retail -->
<!--		    AND SP.SHPG_STS_CD          = #Validated#												 Validated -->
<!--		    AND SP.SET_MDSE_CD          IS NULL														 Not SetComponet -->
<!--		    AND (SP.TRX_LINE_SUB_NUM    = #trxLineSubNumSetMdse# OR SP.INVTY_LOC_CD IS NOT NULL)	 Not Intangible -->
<!--		    AND SP.PO_REQ_FLG           = 'N'														 Not Vendor Drop -->
<!--		    AND SP.GLBL_CMPY_CD         = CD.GLBL_CMPY_CD(+)-->
<!--		    AND SP.TRX_HDR_NUM          = CD.CPO_ORD_NUM(+)-->
<!--		    AND SP.TRX_LINE_NUM         = CD.CPO_DTL_LINE_NUM(+)-->
<!--		    AND SP.TRX_LINE_SUB_NUM     = CD.CPO_DTL_LINE_SUB_NUM(+)-->
<!--		    AND (   		  -->
                           <!--   Whole Sales -->
<!--		                CD.CPO_ORD_NUM IS NOT NULL-->
<!--		                -->
<!--		                		<isEqual property="distTpCd" compareValue="4">-->
<!--		                AND      SP.STK_STS_CD = #stkStsCdGood#-->
<!--								</isEqual>	-->
<!--		                AND CD.EZCANCELFLAG = '0'-->
<!--		            -->
<!--		        )-->
<!--		    AND SP.EZCANCELFLAG         = '0'   		  -->
<!--		    AND -->
<!--		    (-->
<!--		        SP.TRX_LINE_SUB_NUM &lt;&gt;  #trxLineSubNumSetMdse#-->
<!--		        OR EXISTS(-->
<!--		            SELECT -->
<!--		                *-->
<!--		            FROM -->
<!--		                SHPG_PLN SP_CMP-->
<!--		            WHERE -->
<!--		                    SP.GLBL_CMPY_CD     = SP_CMP.GLBL_CMPY_CD-->
<!--		                AND SP.TRX_SRC_TP_CD    = SP_CMP.TRX_SRC_TP_CD-->
<!--		                AND SP.TRX_HDR_NUM      = SP_CMP.TRX_HDR_NUM-->
<!--		                AND SP.TRX_LINE_NUM     = SP_CMP.TRX_LINE_NUM-->
<!--		                AND SP.TRX_LINE_SUB_NUM &lt;&gt; SP_CMP.TRX_LINE_SUB_NUM-->
<!--		                AND SP_CMP.SHPG_STS_CD  = #Validated# 									 Validated -->
<!--		                AND SP_CMP.INVTY_LOC_CD IS NOT NULL										 Not Intangible -->
<!--		                AND SP_CMP.PO_REQ_FLG   = 'N'											 Not Vendor Drop -->
<!--		                AND SP_CMP.EZCANCELFLAG = '0'-->
<!--		        )-->
<!--		    )-->
<!--		    AND ROWNUM                  = 1-->
            <!--    ******* Whole Sales/Retail  SetComponent（10digit）******* -->
            <!--    ******* Whole Sales SetComponent（8digit） ******** -->
<!--		UNION ALL-->
<!--		SELECT-->
<!--		    SP.SHPG_PLN_NUM-->
<!--		FROM -->
<!--		      SHPG_PLN                  SP-->
<!--		    , SHPG_PLN                  SP_SET-->
<!--		    , CPO_DTL                   CD-->
<!--		    , CPO_DTL                   CD_SET-->
<!--		    , MDSE 						M_SET-->
<!--		WHERE -->
<!--		        SP.GLBL_CMPY_CD         = #glblCmpyCd#-->
<!--		    AND SP.MDSE_CD              LIKE  #mdseCd# ||'%'-->
<!--		    AND SP.SHPG_STS_CD          = #Validated#-->
<!--		    AND SP.TRX_SRC_TP_CD        in (#trxSrcTpWholeSales#, #trxSrcTpRetail#)-->
<!--		    AND SP.SET_MDSE_CD          IS NOT NULL-->
<!--		    AND SP.INVTY_LOC_CD         IS NOT NULL-->
<!--		    AND SP.PO_REQ_FLG           = 'N'-->
<!--		    AND SP.GLBL_CMPY_CD         = SP_SET.GLBL_CMPY_CD-->
<!--		    AND SP.TRX_SRC_TP_CD        = SP_SET.TRX_SRC_TP_CD-->
<!--		    AND SP.TRX_HDR_NUM          = SP_SET.TRX_HDR_NUM-->
<!--		    AND SP.TRX_LINE_NUM         = SP_SET.TRX_LINE_NUM-->
<!--		    AND SP_SET.TRX_LINE_SUB_NUM = #trxLineSubNumSetMdse#-->
<!--		    AND SP_SET.GLBL_CMPY_CD     = M_SET.GLBL_CMPY_CD-->
<!--		    AND SP_SET.MDSE_CD          = M_SET.MDSE_CD-->
<!--		    AND SP.GLBL_CMPY_CD         = CD.GLBL_CMPY_CD(+)-->
<!--		    AND SP.TRX_HDR_NUM          = CD.CPO_ORD_NUM(+)-->
<!--		    AND SP.TRX_LINE_NUM         = CD.CPO_DTL_LINE_NUM(+)-->
<!--		    AND SP.TRX_LINE_SUB_NUM     = CD.CPO_DTL_LINE_SUB_NUM(+)-->
<!--		    AND SP_SET.GLBL_CMPY_CD     = CD_SET.GLBL_CMPY_CD(+)-->
<!--		    AND SP_SET.TRX_HDR_NUM      = CD_SET.CPO_ORD_NUM(+)-->
<!--		    AND SP_SET.TRX_LINE_NUM     = CD_SET.CPO_DTL_LINE_NUM(+)-->
<!--		    AND SP_SET.TRX_LINE_SUB_NUM = CD_SET.CPO_DTL_LINE_SUB_NUM(+)-->
<!--		    AND(-->
<!--		            (-->
<!--		            CD.CPO_ORD_NUM IS NOT NULL-->
<!--		             AND    (-->
<!--		                         M_SET.INVTY_DIST_TP_CD = #distTpNone#-->
<!--		                     OR  M_SET.INVTY_DIST_TP_CD = #distTpDistribution#-->
<!--		                     OR (M_SET.INVTY_DIST_TP_CD = #distTpNone#-->
<!--		                        AND ( 1 = 1-->
<!--				                		<isEqual property="distTpCd" compareValue="4">-->
<!--				                        AND SP.STK_STS_CD = #stkStsCdGood#-->
<!--										</isEqual>-->
<!--									)-->
<!--		                        )-->
<!--		                     OR ( M_SET.INVTY_DIST_TP_CD = #distTpDistribution#-->
<!--		                     	AND ( -->
<!--		                     			SP.STK_STS_CD = #stkStsCdGood#-->
<!--		                     		)-->
<!--		                     	)-->
<!--		                	)-->
<!--		             AND CD.EZCANCELFLAG        = '0'-->
<!--		             AND CD_SET.EZCANCELFLAG    = '0'-->
<!--		            )-->
<!--		        )-->
<!--		    AND SP.EZCANCELFLAG         = '0'-->
<!--		    AND SP_SET.EZCANCELFLAG     = '0'-->
<!--		    AND ROWNUM                  = 1-->
<!--   		  -->
<!--	 </statement>-->
	
		
	<statement id="queryEachCompTotalQty" parameterClass="Map" resultClass="Map">
	
		SELECT 
		    CD.CPO_ORD_NUM 					AS CPO_ORD_NUM 
		   ,CD.CPO_DTL_LINE_NUM 			AS CPO_DTL_LINE_NUM
		   ,CD.CPO_DTL_LINE_SUB_NUM 		AS CPO_DTL_LINE_SUB_NUM
		   ,NVL(SPWRK.SUM_ORD_QTY,0)		AS SUM_ORD_QTY
		   ,CD.MDSE_CD 						AS MDSE_CD  
           ,CD.SET_MDSE_CD 					AS SET_MDSE_CD 
           ,CD.CPO_ORD_TS 					AS CPO_ORD_TS
        FROM

				(
				 	SELECT 
				 		  CD.CPO_ORD_NUM				AS CPO_ORD_NUM 
				 		, CD.CPO_DTL_LINE_NUM 			AS CPO_DTL_LINE_NUM
				 		, CD.CPO_DTL_LINE_SUB_NUM		AS CPO_DTL_LINE_SUB_NUM
					    , CD.MDSE_CD 					AS MDSE_CD  
			            , CD.SET_MDSE_CD 				AS SET_MDSE_CD 
			            , CD.CPO_ORD_TS 				AS CPO_ORD_TS
				 	FROM
				 		CPO_DTL CD
					WHERE
				        	CD.GLBL_CMPY_CD 		  	= #glblCmpyCd#
				        AND CD.CPO_ORD_NUM 			  	= #trxHdrNum#
				        AND CD.CPO_DTL_LINE_NUM			= #trxLineNum#
				        AND CD.CPO_DTL_LINE_SUB_NUM		&lt;&gt; #trxLineNumSet#
					    AND CD.EZCANCELFLAG       	  	= '0' 
				 )  CD
				LEFT JOIN
				 (
				 	SELECT 
				 		  SP.TRX_HDR_NUM				AS CPO_ORD_NUM 
				        , SP.TRX_LINE_NUM				AS CPO_DTL_LINE_NUM
				        , SP.TRX_LINE_SUB_NUM			AS CPO_DTL_LINE_SUB_NUM
						, SUM(SP.ORD_QTY)				AS SUM_ORD_QTY
				 	FROM
				 		SHPG_PLN SP
					WHERE
				        	SP.GLBL_CMPY_CD 		  	= #glblCmpyCd#
				        AND SP.TRX_HDR_NUM 				= #trxHdrNum#
				        AND SP.TRX_LINE_NUM				= #trxLineNum#
				        AND SP.TRX_LINE_SUB_NUM			&lt;&gt; #trxLineNumSet#
				        AND SP.TRX_SRC_TP_CD 		  	= #trxSrcTpCd#
				        AND SP.SET_SHPG_PLN_NUM		  	= #setShpgPlnNum#
						AND
							(
									  SP.SHPG_STS_CD		  = #shpgStsCdHA#
								  OR  SP.SHPG_STS_CD	      = #shpgStsCdSO#	
								  OR  SP.SHPG_STS_CD	      = #shpgStsCdPO#	
								  OR  EXISTS (
												SELECT	*
				        						FROM	SHPG_STS SS
				       						 	WHERE		 SP.SHPG_STS_CD		  	= SS.SHPG_STS_CD 
				            	          				AND  SP.GLBL_CMPY_CD 		= SS.GLBL_CMPY_CD  
				                          				AND  SS.SO_PRINT_FLG 	   	= #on#
						                  				AND  SS.EZCANCELFLAG    	= '0'  
								  			 )
						 
								  OR  EXISTS (
												SELECT	*
				        						FROM	MDSE M
				       						 	WHERE	     M.GLBL_CMPY_CD 		= #glblCmpyCd#
				            	          				AND  SP.MDSE_CD 		    = M.MDSE_CD  
				            	          				AND  SP.SHPG_STS_CD		    = #shpgStsCdVA# 	
				                          				AND  M.INVTY_CTRL_FLG 	   	= #off# 
						    							AND  M.EZCANCELFLAG       	= '0'
								  			 )
								  OR  (
								  		 	SP.SHPG_STS_CD		  = #shpgStsCdVA#	
								  		AND	SP.PO_REQ_FLG		  = #on#
								  	  )   		 
							)        
						AND SP.EZCANCELFLAG       	  = '0'   
					GROUP BY
				      		SP.TRX_HDR_NUM
				        ,   SP.TRX_LINE_NUM
				        ,   SP.TRX_LINE_SUB_NUM
				) SPWRK
		ON 
				CD.CPO_ORD_NUM			= SPWRK.CPO_ORD_NUM
			AND CD.CPO_DTL_LINE_NUM		= SPWRK.CPO_DTL_LINE_NUM
			AND CD.CPO_DTL_LINE_SUB_NUM	= SPWRK.CPO_DTL_LINE_SUB_NUM
		
	</statement>

	<statement id="existsBackOrderForDistItem" parameterClass="Map">

		<!-- ****** WholeSales 10 digit Distribution Item ******** -->  
		<!-- ****** WholeSales  8 digit Distribution Item ******** -->		
		SELECT 
		    SP.SHPG_PLN_NUM
		FROM 
		      SHPG_PLN                  SP
		    , CPO_DTL                   CD
		    <!-- Del Start S21_NA#5872 -->
<!--		    , MDSE_WH_COND              MWC-->
		    <!-- Del Start S21_NA#5872 -->
		    , SOFT_ALLOC                SA
		    , DIST_PLN_TM_FRAME         DPF
		    <!-- Add Start S21_NA#5872 -->
		    ,(
SELECT
                 ALLOC_INFO_NUM.GLBL_CMPY_CD
                ,ALLOC_INFO_NUM.SHPG_PLN_NUM
                ,ALLOC_INFO_NUM.INVTY_HARD_ALLOC_TP_CD 
            FROM 
                (SELECT
                    ALLOC_INFO_ALL.*
                   ,ROW_NUMBER() OVER (PARTITION BY ALLOC_INFO_ALL.SHPG_PLN_NUM
                                        ORDER BY ALLOC_INFO_ALL.MDSE_WH_COND_TP_CD DESC)  AS PARTITION_NUM
                 FROM
                    (SELECT
                         SP.GLBL_CMPY_CD
                        ,SP.SHPG_PLN_NUM
                        ,MWC.INVTY_HARD_ALLOC_TP_CD 
                        ,MWC.MDSE_WH_COND_TP_CD
                    FROM
                        SHPG_PLN    SP
                       ,CPO_DTL     DCD
                       ,ORD_TAKE_MDSE   OTM
                       ,MDSE_WH_COND    MWC
                    WHERE
                        SP.EZCANCELFLAG = '0'
                    AND SP.SHPG_STS_CD = '10'
                    AND SP.GLBL_CMPY_CD = DCD.GLBL_CMPY_CD
                    AND SP.TRX_HDR_NUM = DCD.CPO_ORD_NUM
                    AND SP.TRX_LINE_NUM = DCD.CPO_DTL_LINE_NUM
                    AND SP.TRX_LINE_SUB_NUM = DCD.CPO_DTL_LINE_SUB_NUM
                    AND DCD.EZCANCELFLAG = '0'
                    AND SP.GLBL_CMPY_CD = OTM.GLBL_CMPY_CD(+)
                    AND SUBSTR(SP.MDSE_CD, 1, 8) = OTM.ORD_TAKE_MDSE_CD(+)
                    AND OTM.EZCANCELFLAG = '0'
                    AND DCD.GLBL_CMPY_CD = MWC.GLBL_CMPY_CD
                    AND DCD.RTL_WH_CD = MWC.RTL_WH_CD
                    AND (CASE WHEN OTM.ORD_TAKE_MDSE_CD = DCD.MDSE_CD THEN OTM.MDSE_CD
                              ELSE DCD.MDSE_CD
                              END                  = MWC.MDSE_CD
                           OR OTM.ORD_TAKE_MDSE_CD = MWC.MDSE_CD )
                    AND (DCD.RTL_SWH_CD = MWC.RTL_SWH_CD
                        OR (MWC.RTL_SWH_CD = '*'
                           AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD = DCD.GLBL_CMPY_CD
                                            AND   MWC_B.RTL_WH_CD = DCD.RTL_WH_CD 
                                            AND  (CASE WHEN OTM.ORD_TAKE_MDSE_CD = DCD.MDSE_CD THEN OTM.MDSE_CD
                                                       ELSE DCD.MDSE_CD
                                                       END               = MWC_B.MDSE_CD
                                                    OR MWC_B.MDSE_CD     = OTM.ORD_TAKE_MDSE_CD )
                                            AND   MWC_B.RTL_SWH_CD = DCD.RTL_SWH_CD
                                            AND   MWC_B.EZCANCELFLAG = '0'
                                            )
                            )
                        )
                    AND MWC.EZCANCELFLAG = '0'
                    UNION ALL
                    SELECT
                         SP.GLBL_CMPY_CD
                        ,SP.SHPG_PLN_NUM
                        ,MWC.INVTY_HARD_ALLOC_TP_CD
                        ,MWC.MDSE_WH_COND_TP_CD
                    FROM
                        SHPG_PLN SP
                       ,CPO C
                       ,CPO_DTL DCD
                       ,DS_ORD_TP_PROC_DFN DOTPD
                       ,MDSE_WH_COND MWC
                    WHERE
                        SP.EZCANCELFLAG = '0'        
                    AND SP.SHPG_STS_CD = '10'
                    AND SP.GLBL_CMPY_CD = DCD.GLBL_CMPY_CD
                    AND SP.TRX_HDR_NUM = DCD.CPO_ORD_NUM
                    AND SP.TRX_LINE_NUM = DCD.CPO_DTL_LINE_NUM
                    AND SP.TRX_LINE_SUB_NUM = DCD.CPO_DTL_LINE_SUB_NUM
                    AND DCD.EZCANCELFLAG = '0'
                    AND DCD.GLBL_CMPY_CD = C.GLBL_CMPY_CD
                    AND DCD.CPO_ORD_NUM = C.CPO_ORD_NUM
                    AND C.EZCANCELFLAG = '0'
                    AND C.GLBL_CMPY_CD = DOTPD.GLBL_CMPY_CD
                    AND C.DS_ORD_TP_CD = DOTPD.DS_ORD_TP_CD
                    AND DOTPD.EZCANCELFLAG = '0'
                    AND DOTPD.GLBL_CMPY_CD = MWC.GLBL_CMPY_CD
                    AND DOTPD.LINE_BIZ_TP_CD = MWC.LINE_BIZ_TP_CD
                    AND DCD.RTL_WH_CD = MWC.RTL_WH_CD
                    AND (
                           (    DCD.RTL_SWH_CD = MWC.RTL_SWH_CD
                            AND C.DS_ORD_CATG_CD = MWC.DS_ORD_CATG_CD
                            )
                        OR (    MWC.RTL_SWH_CD = '*'
                            AND C.DS_ORD_CATG_CD = MWC.DS_ORD_CATG_CD
                            AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD = DCD.GLBL_CMPY_CD
                                            AND   MWC_B.LINE_BIZ_TP_CD = DOTPD.LINE_BIZ_TP_CD 
                                            AND   MWC_B.RTL_WH_CD = DCD.RTL_WH_CD 
                                            AND   MWC_B.RTL_SWH_CD = DCD.RTL_SWH_CD
                                            AND   MWC_B.DS_ORD_CATG_CD = C.DS_ORD_CATG_CD
                                            AND   MWC_B.EZCANCELFLAG = '0'
                                            )
                            )
                        OR (    DCD.RTL_SWH_CD = MWC.RTL_SWH_CD
                            AND MWC.DS_ORD_CATG_CD = '*'
                            AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD = DCD.GLBL_CMPY_CD
                                            AND   MWC_B.LINE_BIZ_TP_CD = DOTPD.LINE_BIZ_TP_CD 
                                            AND   MWC_B.RTL_WH_CD = DCD.RTL_WH_CD 
                                            AND  (  MWC_B.RTL_SWH_CD = DCD.RTL_SWH_CD
                                                OR  MWC_B.RTL_SWH_CD = '*'
                                                  )
                                            AND   MWC_B.DS_ORD_CATG_CD = C.DS_ORD_CATG_CD
                                            AND   MWC_B.EZCANCELFLAG = '0'
                                            )
                            )
                        OR (    MWC.RTL_SWH_CD = '*'
                            AND MWC.DS_ORD_CATG_CD = '*'
                            AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD = DCD.GLBL_CMPY_CD
                                            AND   MWC_B.LINE_BIZ_TP_CD = DOTPD.LINE_BIZ_TP_CD 
                                            AND   MWC_B.RTL_WH_CD = DCD.RTL_WH_CD 
                                            AND  (  
                                                    (   MWC_B.RTL_SWH_CD = DCD.RTL_SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD = C.DS_ORD_CATG_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD = C.DS_ORD_CATG_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD = DCD.RTL_SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD = '*'
                                                    )
                                                 )
                                            AND   MWC_B.EZCANCELFLAG = '0'
                                            )
                            )   
                        )
                    AND MWC.EZCANCELFLAG = '0'
                    UNION ALL
                    SELECT
                         SP.GLBL_CMPY_CD
                        ,SP.SHPG_PLN_NUM
                        ,M.INVTY_HARD_ALLOC_TP_CD
                        ,'00'  MDSE_WH_COND_TP_CD
                    FROM
                        SHPG_PLN SP
                       ,MDSE M
                       ,ORD_TAKE_MDSE OTM
                    WHERE
                        SP.EZCANCELFLAG = '0'
                    AND SP.SHPG_STS_CD = '10'
                    AND SP.GLBL_CMPY_CD = OTM.GLBL_CMPY_CD(+)
                    AND SUBSTR(SP.MDSE_CD, 1, 8) = OTM.ORD_TAKE_MDSE_CD(+)
                    AND OTM.EZCANCELFLAG(+) = '0'
                    AND SP.GLBL_CMPY_CD = M.GLBL_CMPY_CD
                    AND CASE WHEN OTM.ORD_TAKE_MDSE_CD = SP.MDSE_CD THEN OTM.MDSE_CD
                             ELSE SP.MDSE_CD
                             END                  = M.MDSE_CD
                    AND M.EZCANCELFLAG = '0'
                    ) ALLOC_INFO_ALL
                ) ALLOC_INFO_NUM
                WHERE
                    ALLOC_INFO_NUM.PARTITION_NUM = 1
             ) ALLOC_INFO
		    <!-- Add End S21_NA#5872 -->
		WHERE
		        SP.GLBL_CMPY_CD         = #glblCmpyCd#
		    AND SP.MDSE_CD              LIKE #mdseCd# ||'%'
		    AND SP.TRX_SRC_TP_CD        = #trxSrcTpWholeSales#
		    AND SP.SHPG_STS_CD          = #Validated#
		    AND SP.STK_STS_CD           = #stkStsCdGood#
		    AND SP.PO_REQ_FLG   		= 'N'													<!-- Not Vendor Drop -->
		    AND SP.TRX_LINE_SUB_NUM 	!= #trxLineSubNumSetMdse#								<!-- Not SetComponent -->
		    AND SP.ORD_QTY 				&gt;0		    										<!-- More than ZERO -->
		    AND SP.SOFT_ALLOC_QTY 		&gt;0  
	        <isNotNull property="invtyLocCd">
			AND SP.INVTY_LOC_CD			= #invtyLocCd#	
			</isNotNull>	
			AND	NOT EXISTS	 (
			            SELECT  
						    * 
	 				    FROM	
						     HLD 			H
						    ,HLD_PROC_DFN 	HPD 
						    ,HLD_RSN		HR
					    WHERE
					    		SP.GLBL_CMPY_CD              = H.GLBL_CMPY_CD
								AND (
				                    	(			                    	
				                    			SP.TRX_HDR_NUM           = H.CPO_ORD_NUM
				                    		AND	H.CPO_DTL_LINE_NUM		 IS NULL
			                    			AND	H.CPO_DTL_LINE_SUB_NUM	 IS NULL
			                    			AND	HR.HLD_LVL_CD 			 = #hldLvlCd1#
			                    			
	                   					)
			                    	OR  (
				                    			SP.TRX_HDR_NUM           = H.CPO_ORD_NUM
				                    		AND	SP.TRX_LINE_NUM 		 = H.CPO_DTL_LINE_NUM
			                    			AND	SP.TRX_LINE_SUB_NUM 	 = H.CPO_DTL_LINE_SUB_NUM
			                    			AND	HR.HLD_LVL_CD			 IN 
			                    		<iterate property="hlbLvlCdList" var="hlbLvlCd[]" open="(" close=")" conjunction=",">
			                    			#hlbLvlCd[]#
			                    		</iterate>
			                    		)
							        OR  (
												SP.TRX_HDR_NUM           = H.CPO_ORD_NUM
				                    		AND	SP.TRX_LINE_NUM 		 = H.CPO_DTL_LINE_NUM
							            	AND	H.CPO_DTL_LINE_SUB_NUM	 = #trxLineSubNumSetMdse#
							            	AND	HR.HLD_LVL_CD			 IN 
							            <iterate property="hlbLvlCdList" var="hlbLvlCd[]" open="(" close=")" conjunction=",">
							                #hlbLvlCd[]#
							            </iterate>
							             )
		                    	)
			    		        AND H.GLBL_CMPY_CD               = HR.GLBL_CMPY_CD			
			                    AND H.HLD_RSN_CD                 = HR.HLD_RSN_CD 	
			    		        AND H.GLBL_CMPY_CD               = HPD.GLBL_CMPY_CD
			                    AND H.HLD_RSN_CD                 = HPD.HLD_RSN_CD 
			                    AND HPD.REL_PNT_HARD_ALLOC_FLG   = 'Y'
			    		        AND H.EZCANCELFLAG               = '0'
			    		        AND HR.EZCANCELFLAG              = '0'
			    		        AND HPD.EZCANCELFLAG             = '0'
		    	) 	
		    AND NOT (
		                SP.TRX_SRC_TP_CD    = #trxSrcTpCd#
		            AND SP.TRX_HDR_NUM      = #trxHdrNum#
		            AND SP.TRX_LINE_NUM     = #trxLineNum#
		            AND SP.TRX_LINE_SUB_NUM = #trxLineSubNum#
		        	)
		    AND SP.GLBL_CMPY_CD         = CD.GLBL_CMPY_CD
		    AND SP.TRX_HDR_NUM          = CD.CPO_ORD_NUM
		    AND SP.TRX_LINE_NUM         = CD.CPO_DTL_LINE_NUM
		    AND SP.TRX_LINE_SUB_NUM  	= CD.CPO_DTL_LINE_SUB_NUM
		    AND CD.CPO_ORD_SUBMT_TS     &lt; #ts#
<!--	Del Start S21_NA#5872	    -->
<!--		    AND SP.GLBL_CMPY_CD         = MWC.GLBL_CMPY_CD(+)-->
<!--		    AND SP.MDSE_CD              = MWC.MDSE_CD(+)-->
<!--		    AND SP.INVTY_LOC_CD         = MWC.WH_CD(+)-->
<!--		    AND (MWC.INVTY_HARD_ALLOC_TP_CD IS NULL OR  MWC.INVTY_HARD_ALLOC_TP_CD = #hardAllocTpAuto#)-->
<!--	Del End S21_NA#5872	    -->
		    AND SP.GLBL_CMPY_CD         = SA.GLBL_CMPY_CD
		    AND SP.SHPG_PLN_NUM         = SA.SHPG_PLN_NUM
		    AND SA.GLBL_CMPY_CD         = DPF.GLBL_CMPY_CD
		    AND SA.DIST_PLN_NUM         = DPF.DIST_PLN_NUM
		    AND SA.DIST_TM_FRAME_NUM    = DPF.DIST_TM_FRAME_NUM
		    AND DPF.TM_FRAME_FROM_DT    &lt;= #slsDt#
		    AND SP.EZCANCELFLAG         = '0'
		    AND CD.EZCANCELFLAG         = '0'
		    AND SA.EZCANCELFLAG         = '0'
		    AND DPF.EZCANCELFLAG        = '0'
<!--	Del Start S21_NA#5872	    -->
<!--		    AND (MWC.EZCANCELFLAG IS NULL OR  MWC.EZCANCELFLAG = '0')-->
<!--	Del End S21_NA#5872	    -->
<!--	Add End S21_NA#5872	    -->
            AND SP.GLBL_CMPY_CD         = ALLOC_INFO.GLBL_CMPY_CD
            AND SP.SHPG_PLN_NUM         = ALLOC_INFO.SHPG_PLN_NUM
            AND ALLOC_INFO.INVTY_HARD_ALLOC_TP_CD = #hardAllocTpAuto#
<!--	Add End S21_NA#5872	    -->
		    AND ROWNUM                  = 1
		    
	</statement>
	
<!-- NEW - K.Tajima : Def# 645 [Performance] NWAL0010 Order Entry (case of Auto Allocation) -->
	<statement id="getBackOrderShpgPlnNumListForNoneItem" parameterClass="Map" resultClass="String">

		WITH SP AS (
			SELECT
				*
			FROM
				(
				-- ****************************************
				-- CPO
				-- ****************************************
				SELECT
						SP.GLBL_CMPY_CD
					,	SP.TRX_SRC_TP_CD
					,	SP.TRX_HDR_NUM
					,	SP.TRX_LINE_NUM
					,	SP.TRX_LINE_SUB_NUM
					,	SP.SHPG_PLN_NUM
					,	SP.MDSE_CD
					,	SP.SET_MDSE_CD
					,	SP.INVTY_LOC_CD
				FROM
					SHPG_PLN SP
				WHERE
						GLBL_CMPY_CD     = #param.glblCmpyCd#
					AND TRX_SRC_TP_CD    = #trxSrcTp.wholeSales#	-- TRX_SRC_TP.WHOLE_SALES
					AND SHPG_STS_CD      = #shpgSts.validated#		-- SHPG_STS.VALIDATED
					AND PO_REQ_FLG       = 'N'
					AND TRX_LINE_SUB_NUM != '000'
					AND ORD_QTY          <![CDATA[ > ]]> 0
					AND MDSE_CD          LIKE #param.mdseCd# ||'%'
					<isNotNull property="param.invtyLocCd">
					AND INVTY_LOC_CD     = #param.invtyLocCd#
					</isNotNull>
					AND EZCANCELFLAG     = '0'
	
				AND EXISTS (
						SELECT
							*
						FROM
							CPO_DTL   CD
						WHERE
								CD.GLBL_CMPY_CD         = SP.GLBL_CMPY_CD
							AND CD.CPO_ORD_NUM          = SP.TRX_HDR_NUM
							AND CD.CPO_DTL_LINE_NUM     = SP.TRX_LINE_NUM
							AND CD.CPO_DTL_LINE_SUB_NUM = SP.TRX_LINE_SUB_NUM
							AND CD.CPO_ORD_SUBMT_TS     <![CDATA[ < ]]> #param.ts#
							AND TO_CHAR(TO_DATE(CD.EXPD_SHIP_DT, 'YYYYMMDD') - #param.daysPriAllocNum# , 'YYYYMMDD') <![CDATA[ <= ]]> #param.slsDt#
							AND CD.EZCANCELFLAG         = '0'
				)
	
				UNION ALL
	
				-- ****************************************
				-- ROSS
				-- ****************************************
				SELECT
						SP.GLBL_CMPY_CD
					,	SP.TRX_SRC_TP_CD
					,	SP.TRX_HDR_NUM
					,	SP.TRX_LINE_NUM
					,	SP.TRX_LINE_SUB_NUM
					,	SP.SHPG_PLN_NUM
					,	SP.MDSE_CD
					,	SP.SET_MDSE_CD
					,	SP.INVTY_LOC_CD
				FROM
					SHPG_PLN SP
				WHERE
						SP.GLBL_CMPY_CD     = #param.glblCmpyCd#
					AND SP.TRX_SRC_TP_CD    = #trxSrcTp.retail#		-- TRX_SRC_TP.RETAIL
					AND SP.SHPG_STS_CD      = #shpgSts.validated#	-- SHPG_STS.VALIDATED
					AND SP.PO_REQ_FLG       = 'N'
					AND SP.TRX_LINE_SUB_NUM != '000'
					AND SP.ORD_QTY          <![CDATA[ > ]]> 0
					AND SP.MDSE_CD          LIKE #param.mdseCd# ||'%'
					<isNotNull property="param.invtyLocCd">
					AND INVTY_LOC_CD        = #param.invtyLocCd#
					</isNotNull>
					AND SP.EZCANCELFLAG     = '0'
				) SP
				
			WHERE
				NOT EXISTS (
						SELECT
							*
						FROM
								HLD_PROC_DFN 	HPD 
							,	HLD_RSN			HR
							,	HLD 			H
						WHERE
								HPD.GLBL_CMPY_CD 			= SP.GLBL_CMPY_CD
							AND HPD.REL_PNT_HARD_ALLOC_FLG	= 'Y'
							AND HPD.EZCANCELFLAG			= '0'
		
							AND HR.GLBL_CMPY_CD				= HPD.GLBL_CMPY_CD
							AND HR.HLD_RSN_CD				= HPD.HLD_RSN_CD
							AND HR.EZCANCELFLAG				= '0'
		
							AND H.GLBL_CMPY_CD				= HR.GLBL_CMPY_CD
							AND H.HLD_RSN_CD				= HR.HLD_RSN_CD
							AND H.REL_FLG					= 'N'
							AND H.EZCANCELFLAG				= '0'
		
							AND (
									(		HR.HLD_LVL_CD          = #hldLvl.cpoLevel#
										AND H.CPO_ORD_NUM          = SP.TRX_HDR_NUM
									)
									OR
									(		HR.HLD_LVL_CD          = #hldLvl.cpoDetailLevel#
										AND H.CPO_ORD_NUM          = SP.TRX_HDR_NUM
										AND	H.CPO_DTL_LINE_NUM     = SP.TRX_LINE_NUM
										AND	H.CPO_DTL_LINE_SUB_NUM = SP.TRX_LINE_SUB_NUM 
									)
									OR
									(		HR.HLD_LVL_CD           = #hldLvl.shippingPlanLevel#
										AND H.CPO_ORD_NUM           = SP.TRX_HDR_NUM
										AND	H.CPO_DTL_LINE_NUM      = SP.TRX_LINE_NUM
										AND	H.CPO_DTL_LINE_SUB_NUM  = SP.TRX_LINE_SUB_NUM 
										AND	H.SHPG_PLN_NUM          = SP.SHPG_PLN_NUM 
									)
							)
				)
				AND NOT (
						SP.TRX_SRC_TP_CD    = #param.trxSrcTpCd#
					AND SP.TRX_HDR_NUM      = #param.trxHdrNum#
					AND SP.TRX_LINE_NUM     = #param.trxLineNum#
					AND SP.TRX_LINE_SUB_NUM = #param.trxLineSubNum#
				)
		)

		SELECT
			SP.SHPG_PLN_NUM
		
		FROM
			(
				-- ****************************************
				-- Regular
				-- ****************************************
				SELECT
					 	SP.GLBL_CMPY_CD
					,	SP.MDSE_CD
					,	SP.INVTY_LOC_CD
					,	SP.SHPG_PLN_NUM
				FROM
					SP
				WHERE
					SP.SET_MDSE_CD  IS NULL
		
				UNION ALL
		
				-- ****************************************
				-- Component (DIST_TP.NONE)
				-- ****************************************
				SELECT
					 	SP.GLBL_CMPY_CD
					,	SP.MDSE_CD
					,	SP.INVTY_LOC_CD
					,	SP.SHPG_PLN_NUM
				FROM
						SP
					,	MDSE	M_SET
				WHERE
						SP.SET_MDSE_CD          IS NOT NULL
					AND M_SET.GLBL_CMPY_CD      = SP.GLBL_CMPY_CD
					AND M_SET.MDSE_CD           = SP.SET_MDSE_CD
					AND M_SET.INVTY_DIST_TP_CD  = #distTp.none#				-- DIST_TP.NONE
					AND M_SET.EZCANCELFLAG      = '0'
		
				UNION ALL
		
				-- ****************************************
				-- Component (DIST_TP.DISTRIBUTION)
				-- ****************************************
				SELECT
					 	SP.GLBL_CMPY_CD
					,	SP.MDSE_CD
					,	SP.INVTY_LOC_CD
					,	SP.SHPG_PLN_NUM
				FROM
						SP
					,	MDSE	M_SET
				WHERE
						SP.SET_MDSE_CD          IS NOT NULL
					AND M_SET.GLBL_CMPY_CD      = SP.GLBL_CMPY_CD
					AND M_SET.MDSE_CD           = SP.SET_MDSE_CD
					AND M_SET.INVTY_DIST_TP_CD  = #distTp.distribution#		-- DIST_TP.DISTRIBUTION
					AND M_SET.EZCANCELFLAG      = '0'
			) SP
			, (
            SELECT
                 ALLOC_INFO_NUM.GLBL_CMPY_CD
                ,ALLOC_INFO_NUM.SHPG_PLN_NUM
                ,ALLOC_INFO_NUM.INVTY_HARD_ALLOC_TP_CD 
            FROM 
                (SELECT
                    ALLOC_INFO_ALL.*
                   ,ROW_NUMBER() OVER (PARTITION BY ALLOC_INFO_ALL.SHPG_PLN_NUM
                                        ORDER BY ALLOC_INFO_ALL.MDSE_WH_COND_TP_CD DESC)  AS PARTITION_NUM
                 FROM
                    (SELECT
                         SP.GLBL_CMPY_CD
                        ,SP.SHPG_PLN_NUM
                        ,MWC.INVTY_HARD_ALLOC_TP_CD 
                        ,MWC.MDSE_WH_COND_TP_CD
                    FROM
                        SHPG_PLN    SP
                       ,CPO_DTL     DCD
                       ,ORD_TAKE_MDSE   OTM
                       ,MDSE_WH_COND    MWC
                    WHERE
                        SP.EZCANCELFLAG = '0'
                    AND SP.SHPG_STS_CD = '10'
                    AND SP.GLBL_CMPY_CD = DCD.GLBL_CMPY_CD
                    AND SP.TRX_HDR_NUM = DCD.CPO_ORD_NUM
                    AND SP.TRX_LINE_NUM = DCD.CPO_DTL_LINE_NUM
                    AND SP.TRX_LINE_SUB_NUM = DCD.CPO_DTL_LINE_SUB_NUM
                    AND DCD.EZCANCELFLAG = '0'
                    AND SP.GLBL_CMPY_CD = OTM.GLBL_CMPY_CD(+)
                    AND SUBSTR(SP.MDSE_CD, 1, 8) = OTM.ORD_TAKE_MDSE_CD(+)
                    AND OTM.EZCANCELFLAG = '0'
                    AND DCD.GLBL_CMPY_CD = MWC.GLBL_CMPY_CD
                    AND DCD.RTL_WH_CD = MWC.RTL_WH_CD
                    AND (CASE WHEN OTM.ORD_TAKE_MDSE_CD = DCD.MDSE_CD THEN OTM.MDSE_CD
                              ELSE DCD.MDSE_CD
                              END                  = MWC.MDSE_CD
                           OR OTM.ORD_TAKE_MDSE_CD = MWC.MDSE_CD )
                    AND (DCD.RTL_SWH_CD = MWC.RTL_SWH_CD
                        OR (MWC.RTL_SWH_CD = '*'
                           AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD = DCD.GLBL_CMPY_CD
                                            AND   MWC_B.RTL_WH_CD = DCD.RTL_WH_CD 
                                            AND  (CASE WHEN OTM.ORD_TAKE_MDSE_CD = DCD.MDSE_CD THEN OTM.MDSE_CD
                                                       ELSE DCD.MDSE_CD
                                                       END                  = MWC_B.MDSE_CD
                                                    OR MWC_B.MDSE_CD = OTM.ORD_TAKE_MDSE_CD )
                                            AND   MWC_B.RTL_SWH_CD = DCD.RTL_SWH_CD
                                            AND   MWC_B.EZCANCELFLAG = '0'
                                            )
                            )
                        )
                    AND MWC.EZCANCELFLAG = '0'
                    UNION ALL
                    SELECT
                         SP.GLBL_CMPY_CD
                        ,SP.SHPG_PLN_NUM
                        ,MWC.INVTY_HARD_ALLOC_TP_CD
                        ,MWC.MDSE_WH_COND_TP_CD
                    FROM
                        SHPG_PLN SP
                       ,CPO C
                       ,CPO_DTL DCD
                       ,DS_ORD_TP_PROC_DFN DOTPD
                       ,MDSE_WH_COND MWC
                    WHERE
                        SP.EZCANCELFLAG = '0'        
                    AND SP.SHPG_STS_CD = '10'
                    AND SP.GLBL_CMPY_CD = DCD.GLBL_CMPY_CD
                    AND SP.TRX_HDR_NUM = DCD.CPO_ORD_NUM
                    AND SP.TRX_LINE_NUM = DCD.CPO_DTL_LINE_NUM
                    AND SP.TRX_LINE_SUB_NUM = DCD.CPO_DTL_LINE_SUB_NUM
                    AND DCD.EZCANCELFLAG = '0'
                    AND DCD.GLBL_CMPY_CD = C.GLBL_CMPY_CD
                    AND DCD.CPO_ORD_NUM = C.CPO_ORD_NUM
                    AND C.EZCANCELFLAG = '0'
                    AND C.GLBL_CMPY_CD = DOTPD.GLBL_CMPY_CD
                    AND C.DS_ORD_TP_CD = DOTPD.DS_ORD_TP_CD
                    AND DOTPD.EZCANCELFLAG = '0'
                    AND DOTPD.GLBL_CMPY_CD = MWC.GLBL_CMPY_CD
                    AND DOTPD.LINE_BIZ_TP_CD = MWC.LINE_BIZ_TP_CD
                    AND DCD.RTL_WH_CD = MWC.RTL_WH_CD
                    AND (
                           (    DCD.RTL_SWH_CD = MWC.RTL_SWH_CD
                            AND C.DS_ORD_CATG_CD = MWC.DS_ORD_CATG_CD
                            )
                        OR (    MWC.RTL_SWH_CD = '*'
                            AND C.DS_ORD_CATG_CD = MWC.DS_ORD_CATG_CD
                            AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD = DCD.GLBL_CMPY_CD
                                            AND   MWC_B.LINE_BIZ_TP_CD = DOTPD.LINE_BIZ_TP_CD 
                                            AND   MWC_B.RTL_WH_CD = DCD.RTL_WH_CD 
                                            AND   MWC_B.RTL_SWH_CD = DCD.RTL_SWH_CD
                                            AND   MWC_B.DS_ORD_CATG_CD = C.DS_ORD_CATG_CD
                                            AND   MWC_B.EZCANCELFLAG = '0'
                                            )
                            )
                        OR (    DCD.RTL_SWH_CD = MWC.RTL_SWH_CD
                            AND MWC.DS_ORD_CATG_CD = '*'
                            AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD = DCD.GLBL_CMPY_CD
                                            AND   MWC_B.LINE_BIZ_TP_CD = DOTPD.LINE_BIZ_TP_CD 
                                            AND   MWC_B.RTL_WH_CD = DCD.RTL_WH_CD 
                                            AND  (  MWC_B.RTL_SWH_CD = DCD.RTL_SWH_CD
                                                OR  MWC_B.RTL_SWH_CD = '*'
                                                  )
                                            AND   MWC_B.DS_ORD_CATG_CD = C.DS_ORD_CATG_CD
                                            AND   MWC_B.EZCANCELFLAG = '0'
                                            )
                            )
                        OR (    MWC.RTL_SWH_CD = '*'
                            AND MWC.DS_ORD_CATG_CD = '*'
                            AND NOT EXISTS ( SELECT 1 FROM MDSE_WH_COND MWC_B
                                            WHERE MWC_B.GLBL_CMPY_CD = DCD.GLBL_CMPY_CD
                                            AND   MWC_B.LINE_BIZ_TP_CD = DOTPD.LINE_BIZ_TP_CD 
                                            AND   MWC_B.RTL_WH_CD = DCD.RTL_WH_CD 
                                            AND  (  
                                                    (   MWC_B.RTL_SWH_CD = DCD.RTL_SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD = C.DS_ORD_CATG_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD = '*'
                                                    AND MWC_B.DS_ORD_CATG_CD = C.DS_ORD_CATG_CD
                                                    )
                                                OR  (   MWC_B.RTL_SWH_CD = DCD.RTL_SWH_CD
                                                    AND MWC_B.DS_ORD_CATG_CD = '*'
                                                    )
                                                 )
                                            AND   MWC_B.EZCANCELFLAG = '0'
                                            )
                            )   
                        )
                    AND MWC.EZCANCELFLAG = '0'
                    UNION ALL
                    SELECT
                         SP.GLBL_CMPY_CD
                        ,SP.SHPG_PLN_NUM
                        ,M.INVTY_HARD_ALLOC_TP_CD
                        ,'00'  MDSE_WH_COND_TP_CD
                    FROM
                        SHPG_PLN SP
                       ,MDSE M
                       ,ORD_TAKE_MDSE OTM
                    WHERE
                        SP.EZCANCELFLAG = '0'
                    AND SP.SHPG_STS_CD = '10'
                    AND SP.GLBL_CMPY_CD = OTM.GLBL_CMPY_CD(+)
                    AND SUBSTR(SP.MDSE_CD, 1, 8) = OTM.ORD_TAKE_MDSE_CD(+)
                    AND OTM.EZCANCELFLAG(+) = '0'
                    AND SP.GLBL_CMPY_CD = M.GLBL_CMPY_CD
                    AND CASE WHEN OTM.ORD_TAKE_MDSE_CD = SP.MDSE_CD THEN OTM.MDSE_CD
                             ELSE SP.MDSE_CD
                             END                  = M.MDSE_CD
                    AND M.EZCANCELFLAG = '0'
                    ) ALLOC_INFO_ALL
                ) ALLOC_INFO_NUM
                WHERE
                    ALLOC_INFO_NUM.PARTITION_NUM = 1
             ) ALLOC_INFO
             
             <!-- Del Start S21_NA#5872 -->
             <!-- ,MDSE_WH_COND     MWC -->
             <!-- Del End S21_NA#5872 -->
		WHERE
		<!-- Del Start S21_NA#5872 -->
<!--			    MWC.GLBL_CMPY_CD(+) = SP.GLBL_CMPY_CD-->
<!--			AND MWC.MDSE_CD     (+) = SP.MDSE_CD-->
<!--			AND MWC.WH_CD       (+) = SP.INVTY_LOC_CD-->
<!--			AND (-->
<!--					MWC.INVTY_HARD_ALLOC_TP_CD IS NULL -->
<!--				OR  MWC.INVTY_HARD_ALLOC_TP_CD = #hardAllocTp.auto# --> -- HARD_ALLOC_TP.AUTO
<!--			)-->
<!--			AND ( -->
<!--					MWC.EZCANCELFLAG IS NULL-->
<!--				OR  MWC.EZCANCELFLAG = '0'-->
<!--			) -->
		<!-- Del Start S21_NA#5872 -->

		<!-- Add Start S21_NA#5872 -->
				ALLOC_INFO.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
			AND ALLOC_INFO.SHPG_PLN_NUM = SP.SHPG_PLN_NUM
			AND MWC.INVTY_HARD_ALLOC_TP_CD = #hardAllocTp.auto#   -- HARD_ALLOC_TP.AUTO
		<!-- Add End S21_NA#5872 -->
		
	</statement>
	
</sqlMap>
