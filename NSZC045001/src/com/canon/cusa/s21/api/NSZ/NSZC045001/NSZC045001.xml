<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NSZC045001">
<statement id="cntSvcTaskByFsrNum" parameterClass="Map" resultClass="BigDecimal">
SELECT
	COUNT(*)	AS	CNT
FROM
	SVC_TASK	STK
WHERE
	STK.FSR_NUM			=	#fsrNum#
AND	STK.GLBL_CMPY_CD	=	#glblCmpyCd#
AND	STK.EZCANCELFLAG	=	'0'
</statement>
<statement id="cntFsrVisitByFsrNum" parameterClass="Map" resultClass="Integer">
SELECT
	COUNT(*)	AS	CNT
FROM
	FSR_VISIT	FVT
WHERE
	FVT.FSR_NUM			=	#fsrNum#
<iterate property="svcTaskNumList" var="svcTaskNumList[]" open="AND   FVT.SVC_TASK_NUM    NOT IN (" close=")" conjunction=",">
    #svcTaskNumList[]#
</iterate>
AND	FVT.GLBL_CMPY_CD	=	#glblCmpyCd#
AND	FVT.EZCANCELFLAG	=	'0'
</statement>
<statement id="cntSvcConfigMstrBySvcMachMstrPk" parameterClass="Map" resultClass="BigDecimal">
SELECT
	COUNT(*)	AS	CNT
FROM
	SVC_MACH_MSTR	SMM
,	SVC_CONFIG_MSTR	SCM
WHERE
	SMM.SVC_MACH_MSTR_PK	=	#svcMachMstrPk#
AND	SMM.GLBL_CMPY_CD		=	#glblCmpyCd#
AND	SMM.EZCANCELFLAG		=	'0'
AND	SCM.SVC_CONFIG_MSTR_PK	=	SMM.SVC_CONFIG_MSTR_PK
AND	SCM.GLBL_CMPY_CD		=	SMM.GLBL_CMPY_CD
AND	SCM.EZCANCELFLAG		=	SMM.EZCANCELFLAG
</statement>
<statement id="getMdlNmMapFromSvcConfigMstr" parameterClass="Map" resultClass="Map">
SELECT
	MDN.T_MDL_ID
,	MDN.T_MDL_NM
FROM
	SVC_CONFIG_MSTR		SCM
,	MDL_NM				MDN
WHERE
	SCM.GLBL_CMPY_CD		=	#glblCmpyCd#
AND	SCM.SVC_MACH_MSTR_PK	=	#svcMachMstrPk#
AND	SCM.EZCANCELFLAG		=	'0'
AND	MDN.T_MDL_ID			=	SCM.MDL_ID
AND	MDN.T_GLBL_CMPY_CD		=	SCM.GLBL_CMPY_CD
AND	MDN.EZCANCELFLAG		=	SCM.EZCANCELFLAG
</statement>
    <statement id="getMdlNmMapFromCpo" parameterClass="Map" resultClass="Map">
        SELECT
            MN.T_MDL_ID
           ,MN.T_MDL_NM
        FROM
            SVC_MACH_MSTR      MAC
           ,CPO_DTL            DCD
           ,DS_CPO_CONFIG      DCC
           ,MDL_NM             MN
        WHERE
            MAC.GLBL_CMPY_CD          = #glblCmpyCd#
        AND MAC.SVC_MACH_MSTR_PK      = #svcMachMstrPk#
        AND MAC.GLBL_CMPY_CD          = DCD.GLBL_CMPY_CD
        AND MAC.TRX_HDR_NUM           = DCD.CPO_ORD_NUM
        AND MAC.TRX_LINE_NUM          = DCD.CPO_DTL_LINE_NUM
        AND MAC.TRX_LINE_SUB_NUM      = DCD.CPO_DTL_LINE_SUB_NUM
        AND DCD.GLBL_CMPY_CD          = DCC.GLBL_CMPY_CD
        AND DCD.DS_CPO_CONFIG_PK      = DCC.DS_CPO_CONFIG_PK
        AND DCC.GLBL_CMPY_CD          = MN.T_GLBL_CMPY_CD
        AND DCC.MDL_ID                = MN.T_MDL_ID
        AND MAC.EZCANCELFLAG          = '0'
        AND DCD.EZCANCELFLAG          = '0'
        AND DCC.EZCANCELFLAG          = '0'
        AND MN.EZCANCELFLAG           = '0'
    </statement>

<statement id="getMdlNmMapFromDsMdlConfig" parameterClass="Map" resultClass="Map">
SELECT SYSDATE FROM DUAL
<!-- TODO
-->
</statement>
<statement id="getDsMdlGrpMapByMdlId" parameterClass="Map" resultClass="Map">
SELECT
	DMG.MDL_GRP_ID
,	DMG.MDL_GRP_NM
FROM
	DS_MDL		DML
,	DS_MDL_GRP	DMG
WHERE
	DML.MDL_ID			=	#mdlId#
AND	DML.GLBL_CMPY_CD	=	#glblCmpyCd#
AND	DML.EZCANCELFLAG	=	'0'
AND	DMG.MDL_GRP_ID		=	DML.MDL_GRP_ID
AND	DMG.GLBL_CMPY_CD	=	DML.GLBL_CMPY_CD
AND	DMG.EZCANCELFLAG	=	DML.EZCANCELFLAG
</statement>
<statement id="getFSRVisitTaskBySvcTaskNum" parameterClass="Map" resultClass="Map">
SELECT
     B.REQ_TECH_FLG             AS REQ_TECH_FLG
    ,B.ERL_FOLL_UP_START_CD     AS ERL_FOLL_UP_START_CD
    ,B.LATE_FOLL_UP_START_CD    AS LATE_FOLL_UP_START_CD
    ,B.REQ_PRT_FLG              AS REQ_PRT_FLG
    ,B.SVC_TASK_STS_CD          AS SVC_TASK_STS_CD
    ,A.SVC_PBLM_RSN_TP_CD       AS SVC_PBLM_RSN_TP_CD
FROM 
     FSR_VISIT_TASK        A
    ,SVC_PBLM_RSN_FOLL_UP  B
WHERE
        A.GLBL_CMPY_CD       = #glblCmpyCd#
    AND A.SVC_TASK_NUM       = #svcTaskNum#
    AND A.EZCANCELFLAG       = '0'
    AND A.GLBL_CMPY_CD       = B.GLBL_CMPY_CD(+)
    AND A.SVC_PBLM_RSN_TP_CD = B.SVC_PBLM_RSN_TP_CD(+)
    AND B.EZCANCELFLAG(+)    = '0'
</statement>

    <statement id="getFsrVisit" parameterClass="Map" resultClass="Map">
        SELECT
            FV.FSR_NUM
           ,FV.FSR_VISIT_NUM
           ,FV.SVC_TASK_NUM
           ,F.INV_CCY_CD
           ,F.CCY_EXCH_RATE
           ,F.PMT_TERM_CASH_DISC_CD
        FROM
            FSR_VISIT    FV
           ,FSR          F
        WHERE
            FV.GLBL_CMPY_CD          = #glblCmpyCd#
        AND FV.SVC_TASK_NUM          = #svcTaskNum#
        AND FV.GLBL_CMPY_CD          = F.GLBL_CMPY_CD
        AND FV.FSR_NUM               = F.FSR_NUM
        AND FV.EZCANCELFLAG          = '0'
        AND F.EZCANCELFLAG           = '0'
    </statement>
    <statement id="getShipToInfo" parameterClass="Map" resultClass="Map">
        SELECT
              SHIP.CTRY_CD                  AS CTRY_CD
            , SHIP.POST_CD                  AS POST_CD
            <!-- START 2022/04/11 K.Kitachi [QC#59899, ADD] -->
            , FSR.SHIP_TO_UPD_CUST_CD       AS SHIP_TO_UPD_CUST_CD
            <!-- END 2022/04/11 K.Kitachi [QC#59899, ADD] -->
        FROM
              FSR
            , SHIP_TO_CUST SHIP
        WHERE FSR.GLBL_CMPY_CD    = #glblCmpyCd#
          AND FSR.FSR_NUM         = #fsrNum#
          AND FSR.EZCANCELFLAG    = '0'
          AND FSR.GLBL_CMPY_CD    = SHIP.GLBL_CMPY_CD(+)
          AND ( CASE
	                 <!-- START 2022/03/11 [QC#59702, MOD] -->
                     <!-- WHEN FSR.SHIP_TO_CUST_UPD_FLG = 'Y' THEN FSR.SHIP_TO_UPD_CUST_CD -->
                     WHEN FSR.SHIP_TO_UPD_CUST_CD IS NOT NULL THEN FSR.SHIP_TO_UPD_CUST_CD
                     <!-- END   2022/03/11 [QC#59702, MOD] -->
                     ELSE FSR.SHIP_TO_CUST_CD
                 END
              ) = SHIP.SHIP_TO_CUST_CD(+)
          AND SHIP.EZCANCELFLAG(+) = '0'
    </statement>
    <statement id="getMdlNmMapFromSvcConfigMstrDtl" parameterClass="Map" resultClass="Map">
        SELECT
             MDN.T_MDL_ID
            ,MDN.T_MDL_NM
        FROM
             SVC_CONFIG_MSTR_DTL  SCMD
            ,SVC_CONFIG_MSTR      SCM
            ,MDL_NM               MDN
        WHERE
            SCMD.GLBL_CMPY_CD         =  #glblCmpyCd#
        AND SCMD.SVC_MACH_MSTR_PK     =  #svcMachMstrPk#
        AND SCMD.SVC_MACH_RMV_DT      IS NULL
        AND SCMD.EZCANCELFLAG         =  '0'
        AND SCMD.GLBL_CMPY_CD         =  SCM.GLBL_CMPY_CD
        AND SCMD.SVC_CONFIG_MSTR_PK   =  SCM.SVC_CONFIG_MSTR_PK
        AND SCM.EZCANCELFLAG          =  '0'
        AND SCM.GLBL_CMPY_CD          =  MDN.T_GLBL_CMPY_CD
        AND SCM.MDL_ID                =  MDN.T_MDL_ID
        AND MDN.EZCANCELFLAG          =  '0'
    </statement>
    <statement id="getFstTskVstStsCd" parameterClass="Map" resultClass="String">
        SELECT
             FVT.FSR_VISIT_STS_CD
        FROM
             SVC_TASK  STK
            ,FSR_VISIT FVT
        WHERE
            STK.GLBL_CMPY_CD       = #glblCmpyCd#
        AND STK.FSR_NUM            = #fsrNum#
        AND STK.FIRST_SVC_TASK_FLG = 'Y'
        AND STK.EZCANCELFLAG       = '0'
        AND STK.GLBL_CMPY_CD       = FVT.GLBL_CMPY_CD(+)
        AND STK.SVC_TASK_NUM       = FVT.SVC_TASK_NUM(+)
        AND FVT.EZCANCELFLAG       = '0'
    </statement>

    <!-- START 2021/10/06 R.Jabal [QC#59183, ADD] -->
    <statement id="getAccessPermits" parameterClass="Map" resultClass="Map">
        WITH PMT_WK AS (
            SELECT
                 ACCS.GLBL_CMPY_CD                          AS GLBL_CMPY_CD
                ,ACCS.SVC_PMIT_LVL_VAL_TXT                  AS SVC_ACCS_PMIT_VAL_TXT
                ,ACCS.SVC_ACCS_PMIT_NUM                     AS SVC_ACCS_PMIT_NUM
                ,ACV.SVC_ACCS_PMIT_DESC_TXT                 AS SVC_ACCS_PMIT_DESC_TXT
                ,TP.MACH_LVL_FLG                            AS MACH_LVL_FLG
                ,TP.SITE_LVL_FLG                            AS SITE_LVL_FLG
                ,TP.PTY_LVL_FLG                             AS PTY_LVL_FLG
            FROM
                 SVC_ACCS_PMIT ACCS
                ,SVC_PMIT_LVL_TP TP 
                ,SVC_ACCS_PMIT_VAL ACV
            WHERE
                    ACCS.GLBL_CMPY_CD                       = #glblCmpyCd#
                AND ACCS.EZCANCELFLAG                       = '0'
                AND ACCS.GLBL_CMPY_CD                       = ACV.GLBL_CMPY_CD
                AND ACCS.SVC_ACCS_PMIT_NUM                  = ACV.SVC_ACCS_PMIT_NUM
                AND ACV.EZCANCELFLAG                        = '0'
                AND ACCS.SVC_PMIT_LVL_TP_CD                 = TP.SVC_PMIT_LVL_TP_CD
                AND ACCS.GLBL_CMPY_CD                       = TP.GLBL_CMPY_CD
                AND TP.EZCANCELFLAG                         = '0'
        )
        ,TASK_WK AS (
            SELECT
                 SVC_TASK_NUM
                ,SER_NUM
                ,FSR_NUM
                ,GLBL_CMPY_CD
                ,SHIP_TO_CUST_CD
            FROM
                SVC_TASK TASK
            WHERE
                    TASK.SVC_TASK_NUM                       = #svcTaskNum#
                AND TASK.GLBL_CMPY_CD                       = #glblCmpyCd#
                AND TASK.EZCANCELFLAG                       = '0'
        )
        SELECT
             TASK.SVC_TASK_NUM                              AS SVC_TASK_NUM
            ,PMT.SVC_ACCS_PMIT_NUM                          AS SVC_ACCS_PMIT_NUM
            ,PMT.SVC_ACCS_PMIT_DESC_TXT                     AS SVC_ACCS_PMIT_DESC_TXT
        FROM
             TASK_WK TASK
            ,PMT_WK PMT
        WHERE
                PMT.MACH_LVL_FLG                            = 'Y'
            AND TASK.SER_NUM                                = PMT.SVC_ACCS_PMIT_VAL_TXT
        <!--UNION ALL-->
        UNION
        SELECT
             TASK.SVC_TASK_NUM                              AS SVC_TASK_NUM
            ,PMT.SVC_ACCS_PMIT_NUM                          AS SVC_ACCS_PMIT_NUM
            ,PMT.SVC_ACCS_PMIT_DESC_TXT                     AS SVC_ACCS_PMIT_DESC_TXT
        FROM
             TASK_WK TASK
            ,FSR FSR
            ,PMT_WK PMT
        WHERE
                TASK.FSR_NUM                                = FSR.FSR_NUM
            AND TASK.GLBL_CMPY_CD                           = FSR.GLBL_CMPY_CD
            AND FSR.EZCANCELFLAG                            = '0'
            AND PMT.SITE_LVL_FLG                            = 'Y'
            <!-- START 2022/03/11 [QC#59702, MOD] -->
            <!-- AND ((FSR.SHIP_TO_CUST_UPD_FLG                  = 'N' AND TASK.SHIP_TO_CUST_CD    = PMT.SVC_ACCS_PMIT_VAL_TXT)  -->
            <!--     OR (FSR.SHIP_TO_CUST_UPD_FLG                = 'Y' AND FSR.SHIP_TO_UPD_CUST_CD = PMT.SVC_ACCS_PMIT_VAL_TXT)) -->
            AND ((FSR.SHIP_TO_UPD_CUST_CD           IS NULL AND TASK.SHIP_TO_CUST_CD    = PMT.SVC_ACCS_PMIT_VAL_TXT) 
                OR (FSR.SHIP_TO_UPD_CUST_CD     IS NOT NULL AND FSR.SHIP_TO_UPD_CUST_CD = PMT.SVC_ACCS_PMIT_VAL_TXT))
            <!-- END   2022/03/11 [QC#59702, MOD] -->
        <!--UNION ALL-->
        UNION
        SELECT
             TASK.SVC_TASK_NUM                              AS SVC_TASK_NUM
            ,PMT.SVC_ACCS_PMIT_NUM                          AS SVC_ACCS_PMIT_NUM
            ,PMT.SVC_ACCS_PMIT_DESC_TXT                     AS SVC_ACCS_PMIT_DESC_TXT
        FROM
             TASK_WK TASK
            ,FSR FSR
            ,PMT_WK PMT
        WHERE
                TASK.FSR_NUM                                = FSR.FSR_NUM
            AND TASK.GLBL_CMPY_CD                           = FSR.GLBL_CMPY_CD
            AND FSR.EZCANCELFLAG                            = '0'
            AND PMT.SITE_LVL_FLG                            = 'Y'
            AND ((FSR.BILL_TO_CUST_UPD_FLG                  = 'N' AND FSR.BILL_TO_CUST_CD     = PMT.SVC_ACCS_PMIT_VAL_TXT)
                OR (FSR.BILL_TO_CUST_UPD_FLG                = 'Y' AND FSR.BILL_TO_UPD_CUST_CD = PMT.SVC_ACCS_PMIT_VAL_TXT))
        <!--UNION ALL-->
        UNION
        SELECT
             TASK.SVC_TASK_NUM                              AS SVC_TASK_NUM
            ,PMT.SVC_ACCS_PMIT_NUM                          AS SVC_ACCS_PMIT_NUM
            ,PMT.SVC_ACCS_PMIT_DESC_TXT                     AS SVC_ACCS_PMIT_DESC_TXT
        FROM
             TASK_WK TASK
            ,FSR FSR
            ,PMT_WK PMT
        WHERE
                TASK.FSR_NUM                                = FSR.FSR_NUM
            AND TASK.GLBL_CMPY_CD                           = FSR.GLBL_CMPY_CD
            AND FSR.EZCANCELFLAG                            = '0'
            AND PMT.PTY_LVL_FLG                             = 'Y'
            AND FSR.SHIP_TO_CUST_ACCT_CD                    = PMT.SVC_ACCS_PMIT_VAL_TXT
        <!--UNION ALL-->
        UNION
        SELECT
             TASK.SVC_TASK_NUM                              AS SVC_TASK_NUM
            ,PMT.SVC_ACCS_PMIT_NUM                          AS SVC_ACCS_PMIT_NUM
            ,PMT.SVC_ACCS_PMIT_DESC_TXT                     AS SVC_ACCS_PMIT_DESC_TXT
        FROM
             TASK_WK TASK
            ,FSR FSR
            ,PMT_WK PMT
        WHERE
                TASK.FSR_NUM                                = FSR.FSR_NUM
            AND TASK.GLBL_CMPY_CD                           = FSR.GLBL_CMPY_CD
            AND FSR.EZCANCELFLAG                            = '0'
            AND PMT.PTY_LVL_FLG                             = 'Y'
            AND FSR.BILL_TO_CUST_ACCT_CD                    = PMT.SVC_ACCS_PMIT_VAL_TXT
        ORDER BY SVC_ACCS_PMIT_NUM
    </statement>
    <!-- END 2021/10/06 R.Jabal [QC#59183, ADD] -->
</sqlMap>