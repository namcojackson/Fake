<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NWAB234001">

    <statement id="getSalesAndReturnConvOrdInfo" parameterClass="Map">
        SELECT
                  CPO_ORD_NUM
                , SELL_TO_CUST_CD
                , CUST_ISS_PO_NUM
                , CPO_ORD_TP_CD
                , SOLD_TO_CUST_LOC_CD
                , DS_ORD_TP_CD
                , DS_ORD_RSN_CD
<!-- QC#21550 add Start -->
                , DS_ORD_CATG_CD
<!-- QC#21550 add End -->
<!-- QC#7606 add Start -->
                , ORIG_CPO_ORD_NUM
                , ORIG_CPO_DTL_LINE_NUM
                , ORIG_CPO_DTL_LINE_SUB_NUM
<!-- QC#7606 add End -->
                , ORD_SRC_REF_NUM
                , DS_CPO_CONFIG_PK
                , BILL_TO_CUST_ACCT_CD
                , BILL_TO_CUST_LOC_CD
                , SHIP_TO_CUST_ACCT_CD
                , SHIP_TO_CUST_LOC_CD
                , SHIP_TO_LOC_NM
                , SHIP_TO_ADDL_LOC_NM
                , SHIP_TO_FIRST_LINE_ADDR
                , SHIP_TO_SCD_LINE_ADDR
                , SHIP_TO_THIRD_LINE_ADDR
                , SHIP_TO_FRTH_LINE_ADDR
                , SHIP_TO_CTY_ADDR
                , SHIP_TO_ST_CD
                , SHIP_TO_PROV_NM
                , SHIP_TO_CNTY_NM
                , SHIP_TO_POST_CD
                , SHIP_TO_CTRY_CD
                , CPO_DTL_LINE_NUM
                , CPO_DTL_LINE_SUB_NUM
                , DS_CPO_RTRN_LINE_NUM
                , DS_CPO_RTRN_LINE_SUB_NUM
                , SLS_REP_OR_SLS_TEAM_TOC_CD
                , ORD_QTY
                , MDSE_CD
                , DS_ORD_POSN_NUM
                , SVC_CONFIG_MSTR_PK
                , BASE_CMPT_FLG
                , ORD_SRC_REF_LINE_NUM
                , ORD_SRC_REF_LINE_SUB_NUM
                , DS_CONTR_NUM
                , DS_CONTR_SQ_NUM
                , SVC_MACH_MSTR_PK
                , DS_ORD_LINE_CATG_CD
                , INV_NUM
                , INV_DT
<!-- QC#8630 add Start -->
                , BILL_TO_LOC_NUM
                , SHIP_TO_LOC_NUM
<!-- QC#8630 add End -->
<!-- QC#9594 add Start -->
                , SET_MDSE_CD
<!-- QC#9594 add End -->
        FROM (
            <!-- ##### Loan to Sales, Rental to Sales ##### -->
            SELECT
                  C.CPO_ORD_NUM                 AS CPO_ORD_NUM
                , C.SELL_TO_CUST_CD             AS SELL_TO_CUST_CD
                , C.CUST_ISS_PO_NUM             AS CUST_ISS_PO_NUM
                , C.CPO_ORD_TP_CD               AS CPO_ORD_TP_CD
                , C.SOLD_TO_CUST_LOC_CD         AS SOLD_TO_CUST_LOC_CD
                , C.DS_ORD_TP_CD                AS DS_ORD_TP_CD
                , C.DS_ORD_RSN_CD               AS DS_ORD_RSN_CD
<!-- QC#21550 add Start -->
                , C.DS_ORD_CATG_CD              AS DS_ORD_CATG_CD
<!-- QC#21550 add End -->
<!-- QC#7606 add Start -->
                , CD.ORIG_CPO_ORD_NUM           AS ORIG_CPO_ORD_NUM
                , CD.ORIG_CPO_DTL_LINE_NUM      AS ORIG_CPO_DTL_LINE_NUM
                , CD.ORIG_CPO_DTL_LINE_SUB_NUM  AS ORIG_CPO_DTL_LINE_SUB_NUM
<!-- QC#7606 add End -->
                , C.ORD_SRC_REF_NUM             AS ORD_SRC_REF_NUM
                , DCC.DS_CPO_CONFIG_PK          AS DS_CPO_CONFIG_PK
                , DCC.BILL_TO_CUST_ACCT_CD      AS BILL_TO_CUST_ACCT_CD
                , DCC.BILL_TO_CUST_LOC_CD       AS BILL_TO_CUST_LOC_CD
                , DCC.SHIP_TO_CUST_ACCT_CD      AS SHIP_TO_CUST_ACCT_CD
                , DCC.SHIP_TO_CUST_LOC_CD       AS SHIP_TO_CUST_LOC_CD
                , DCC.SHIP_TO_LOC_NM            AS SHIP_TO_LOC_NM
                , DCC.SHIP_TO_ADDL_LOC_NM       AS SHIP_TO_ADDL_LOC_NM
                , DCC.SHIP_TO_FIRST_LINE_ADDR   AS SHIP_TO_FIRST_LINE_ADDR
                , DCC.SHIP_TO_SCD_LINE_ADDR     AS SHIP_TO_SCD_LINE_ADDR
                , DCC.SHIP_TO_THIRD_LINE_ADDR   AS SHIP_TO_THIRD_LINE_ADDR
                , DCC.SHIP_TO_FRTH_LINE_ADDR    AS SHIP_TO_FRTH_LINE_ADDR
                , DCC.SHIP_TO_CTY_ADDR          AS SHIP_TO_CTY_ADDR
                , DCC.SHIP_TO_ST_CD             AS SHIP_TO_ST_CD
                , DCC.SHIP_TO_PROV_NM           AS SHIP_TO_PROV_NM
                , DCC.SHIP_TO_CNTY_NM           AS SHIP_TO_CNTY_NM
                , DCC.SHIP_TO_POST_CD           AS SHIP_TO_POST_CD
                , DCC.SHIP_TO_CTRY_CD           AS SHIP_TO_CTRY_CD
                , CD.CPO_DTL_LINE_NUM           AS CPO_DTL_LINE_NUM
                , CD.CPO_DTL_LINE_SUB_NUM       AS CPO_DTL_LINE_SUB_NUM
                , ''                            AS DS_CPO_RTRN_LINE_NUM
                , ''                            AS DS_CPO_RTRN_LINE_SUB_NUM
                , CD.SLS_REP_OR_SLS_TEAM_TOC_CD AS SLS_REP_OR_SLS_TEAM_TOC_CD
                , CD.ORD_QTY                    AS ORD_QTY
                , CD.MDSE_CD                    AS MDSE_CD
                , CD.DS_ORD_POSN_NUM            AS DS_ORD_POSN_NUM
                , CD.SVC_CONFIG_MSTR_PK         AS SVC_CONFIG_MSTR_PK
                , CD.BASE_CMPT_FLG              AS BASE_CMPT_FLG
                , CD.ORD_SRC_REF_LINE_NUM       AS ORD_SRC_REF_LINE_NUM
                , CD.ORD_SRC_REF_LINE_SUB_NUM   AS ORD_SRC_REF_LINE_SUB_NUM
                , CD.DS_CONTR_NUM               AS DS_CONTR_NUM
                , CD.DS_CONTR_SQ_NUM            AS DS_CONTR_SQ_NUM
                , CD.SVC_MACH_MSTR_PK           AS SVC_MACH_MSTR_PK
                , CD.DS_ORD_LINE_CATG_CD        AS DS_ORD_LINE_CATG_CD
                , I.INV_NUM                     AS INV_NUM
                , I.INV_DT                      AS INV_DT
<!-- QC#8630 add Start -->
                , BTC.LOC_NUM                   AS BILL_TO_LOC_NUM
                , STC.LOC_NUM                   AS SHIP_TO_LOC_NUM
<!-- QC#8630 add End -->
<!-- QC#9594 add Start -->
                , CD.SET_MDSE_CD                AS SET_MDSE_CD
<!-- QC#9594 add End -->
            FROM
                  CPO C
                , CPO_DTL CD
                , SVC_MACH_MSTR SMM
                , DS_CPO_CONFIG DCC
                , INV I
                , INV_LINE IL
<!-- QC#8630 add Start -->
                , BILL_TO_CUST BTC
                , SHIP_TO_CUST STC
<!-- QC#8630 add End -->
            WHERE
                  C.GLBL_CMPY_CD            = #glblCmpyCd#
              AND C.EZCANCELFLAG            = '0'

              AND C.GLBL_CMPY_CD            = CD.GLBL_CMPY_CD
              AND C.CPO_ORD_NUM             = CD.CPO_ORD_NUM
              AND CD.ORD_LINE_STS_CD        = #ordLineStsCd#
              AND CD.EZCANCELFLAG           = '0'
<!-- QC#9594 add Start -->
              AND CD.CPO_DTL_LINE_SUB_NUM  != '000'
<!-- QC#9594 add End -->

              AND CD.CR_REBIL_CD           IS NULL

              AND C.DS_ORD_TP_CD || CD.DS_ORD_LINE_CATG_CD   IN
                <iterate property="dsOrdLineCatgCdSls" var="dsOrdLineCatgCdSls[]" open="(" close=" )" conjunction=",">
                    #dsOrdLineCatgCdSls[]#
                </iterate>
              AND CD.CONV_COMP_FLG          = #convCompFlg#

              AND CD.GLBL_CMPY_CD           = DCC.GLBL_CMPY_CD
              AND CD.DS_CPO_CONFIG_PK       = DCC.DS_CPO_CONFIG_PK
              AND DCC.EZCANCELFLAG          = '0'

              AND CD.GLBL_CMPY_CD           = SMM.GLBL_CMPY_CD (+)
              AND CD.SVC_CONFIG_MSTR_PK     = SMM.SVC_CONFIG_MSTR_PK (+)
              AND CD.SVC_MACH_MSTR_PK       = SMM.SVC_MACH_MSTR_PK (+)
<!-- QC#7758 del
              AND SMM.SVC_MACH_MAINT_AVAL_FLG = #svMachMaintAvalFlg#
 -->
              AND SMM.EZCANCELFLAG (+)          = '0'

              AND CD.GLBL_CMPY_CD            = IL.GLBL_CMPY_CD
              AND CD.CPO_ORD_NUM             = IL.CPO_ORD_NUM
              AND CD.CPO_DTL_LINE_NUM        = IL.CPO_DTL_LINE_NUM
              AND CD.CPO_DTL_LINE_SUB_NUM    = IL.CPO_DTL_LINE_SUB_NUM
              AND IL.EZCANCELFLAG            = '0'

              AND IL.GLBL_CMPY_CD            = I.GLBL_CMPY_CD
              AND IL.INV_NUM                 = I.INV_NUM
              AND IL.EZCANCELFLAG            = '0'

<!-- QC#8630 add Start -->
              AND DCC.GLBL_CMPY_CD           = BTC.GLBL_CMPY_CD
              AND DCC.BILL_TO_CUST_LOC_CD    = BTC.BILL_TO_CUST_CD
              <!-- Del Start 2019/12/20 QC#55044 -->
              <!-- AND BTC.RGTN_STS_CD            = 'P20' -->
              <!-- Del End   2019/12/20 QC#55044 -->
              AND BTC.EZCANCELFLAG           = '0'

              AND DCC.GLBL_CMPY_CD           = STC.GLBL_CMPY_CD
              AND DCC.SHIP_TO_CUST_LOC_CD    = STC.SHIP_TO_CUST_CD
              <!-- Del Start 2019/12/20 QC#55044 -->
              <!-- AND STC.RGTN_STS_CD            = 'P20' -->
              <!-- Del End   2019/12/20 QC#55044 -->
              AND STC.EZCANCELFLAG           = '0'
<!-- QC#8630 add End -->

            UNION
            <!-- ##### Loan Return ##### -->
            SELECT
                  C.CPO_ORD_NUM                 AS CPO_ORD_NUM
                , C.SELL_TO_CUST_CD             AS SELL_TO_CUST_CD
                , C.CUST_ISS_PO_NUM             AS CUST_ISS_PO_NUM
                , C.CPO_ORD_TP_CD               AS CPO_ORD_TP_CD
                , C.SOLD_TO_CUST_LOC_CD         AS SOLD_TO_CUST_LOC_CD
                , C.DS_ORD_TP_CD                AS DS_ORD_TP_CD
                , C.DS_ORD_RSN_CD               AS DS_ORD_RSN_CD
<!-- QC#21550 add Start -->
                , C.DS_ORD_CATG_CD              AS DS_ORD_CATG_CD
<!-- QC#21550 add End -->
<!-- QC#7606 add Start -->
                , NVL(DCR.ORIG_CPO_ORD_NUM, C.CPO_ORD_NUM)
                                                AS ORIG_CPO_ORD_NUM
                , DCR.ORIG_CPO_DTL_LINE_NUM     AS ORIG_CPO_DTL_LINE_NUM
                , DCR.ORIG_CPO_DTL_LINE_SUB_NUM AS ORIG_CPO_DTL_LINE_SUB_NUM
<!-- QC#7606 add End -->
                , NVL(C.ORD_SRC_REF_NUM, C.CPO_ORD_NUM)
                                                AS ORD_SRC_REF_NUM
                , DCC.DS_CPO_CONFIG_PK          AS DS_CPO_CONFIG_PK
                , DCC.BILL_TO_CUST_ACCT_CD      AS BILL_TO_CUST_ACCT_CD
                , DCC.BILL_TO_CUST_LOC_CD       AS BILL_TO_CUST_LOC_CD
                , DCC.SHIP_TO_CUST_ACCT_CD      AS SHIP_TO_CUST_ACCT_CD
                , DCC.SHIP_TO_CUST_LOC_CD       AS SHIP_TO_CUST_LOC_CD
                , DCC.SHIP_TO_LOC_NM            AS SHIP_TO_LOC_NM
                , DCC.SHIP_TO_ADDL_LOC_NM       AS SHIP_TO_ADDL_LOC_NM
                , DCC.SHIP_TO_FIRST_LINE_ADDR   AS SHIP_TO_FIRST_LINE_ADDR
                , DCC.SHIP_TO_SCD_LINE_ADDR     AS SHIP_TO_SCD_LINE_ADDR
                , DCC.SHIP_TO_THIRD_LINE_ADDR   AS SHIP_TO_THIRD_LINE_ADDR
                , DCC.SHIP_TO_FRTH_LINE_ADDR    AS SHIP_TO_FRTH_LINE_ADDR
                , DCC.SHIP_TO_CTY_ADDR          AS SHIP_TO_CTY_ADDR
                , DCC.SHIP_TO_ST_CD             AS SHIP_TO_ST_CD
                , DCC.SHIP_TO_PROV_NM           AS SHIP_TO_PROV_NM
                , DCC.SHIP_TO_CNTY_NM           AS SHIP_TO_CNTY_NM
                , DCC.SHIP_TO_POST_CD           AS SHIP_TO_POST_CD
                , DCC.SHIP_TO_CTRY_CD           AS SHIP_TO_CTRY_CD
                , ''                            AS CPO_DTL_LINE_NUM
                , ''                            AS CPO_DTL_LINE_SUB_NUM
                , DCR.DS_CPO_RTRN_LINE_NUM      AS DS_CPO_RTRN_LINE_NUM
                , DCR.DS_CPO_RTRN_LINE_SUB_NUM  AS DS_CPO_RTRN_LINE_SUB_NUM
                , DCR.SLS_REP_OR_SLS_TEAM_TOC_CD AS SLS_REP_OR_SLS_TEAM_TOC_CD
                , ABS(DCR.ORD_QTY)              AS ORD_QTY
                , DCR.MDSE_CD                   AS MDSE_CD
                , DCR.DS_ORD_POSN_NUM           AS DS_ORD_POSN_NUM
                , DCR.SVC_CONFIG_MSTR_PK        AS SVC_CONFIG_MSTR_PK
                , DCR.BASE_CMPT_FLG             AS BASE_CMPT_FLG
                , DCR.ORD_SRC_REF_LINE_NUM      AS ORD_SRC_REF_LINE_NUM
                , DCR.ORD_SRC_REF_LINE_SUB_NUM  AS ORD_SRC_REF_LINE_SUB_NUM
                , DCR.DS_CONTR_NUM              AS DS_CONTR_NUM
                , DCR.DS_CONTR_SQ_NUM           AS DS_CONTR_SQ_NUM
                , DCR.SVC_MACH_MSTR_PK          AS SVC_MACH_MSTR_PK
                , DCR.DS_ORD_LINE_CATG_CD       AS DS_ORD_LINE_CATG_CD
                , ''                            AS INV_NUM
                , ''                            AS INV_DT
<!-- QC#8630 add Start -->
                , ''                            AS BILL_TO_LOC_NUM
                , ''                            AS SHIP_TO_LOC_NUM
<!-- QC#8630 add End -->
<!-- QC#9594 add Start -->
                , DCR.SET_MDSE_CD               AS SET_MDSE_CD
<!-- QC#9594 add End -->
            FROM
                  CPO C
                , DS_CPO_RTRN_DTL DCR
                , SVC_MACH_MSTR SMM
                , DS_CPO_CONFIG DCC
            WHERE
                  C.GLBL_CMPY_CD            = #glblCmpyCd#
              AND C.EZCANCELFLAG            = '0'

              AND C.GLBL_CMPY_CD            = DCR.GLBL_CMPY_CD
              AND C.CPO_ORD_NUM             = DCR.CPO_ORD_NUM
              AND DCR.RTRN_LINE_STS_CD      = #ordLineStsCd#
              AND DCR.CR_REBIL_CD           IS NULL

              AND C.DS_ORD_TP_CD || DCR.DS_ORD_LINE_CATG_CD   IN
                <iterate property="dsOrdLineCatgCdRtrn" var="dsOrdLineCatgCdRtrn[]" open="(" close=" )" conjunction=",">
                    #dsOrdLineCatgCdRtrn[]#
                </iterate>
              AND DCR.CONV_COMP_FLG         = #convCompFlg#
              AND DCR.EZCANCELFLAG          = '0'
<!-- QC#9594 add Start -->
              AND DCR.DS_CPO_RTRN_LINE_SUB_NUM != '000'
<!-- QC#9594 add End -->

              AND DCR.GLBL_CMPY_CD          = DCC.GLBL_CMPY_CD
              AND DCR.DS_CPO_CONFIG_PK      = DCC.DS_CPO_CONFIG_PK
              AND DCC.EZCANCELFLAG          = '0'

              AND DCR.GLBL_CMPY_CD          = SMM.GLBL_CMPY_CD (+)
              AND DCR.SVC_CONFIG_MSTR_PK    = SMM.SVC_CONFIG_MSTR_PK (+)
              AND DCR.SVC_MACH_MSTR_PK      = SMM.SVC_MACH_MSTR_PK (+)
<!-- QC#7758 del
              AND SMM.SVC_MACH_MAINT_AVAL_FLG = #svMachMaintAvalFlg#
 -->
              AND SMM.EZCANCELFLAG (+)          = '0'
        )
        ORDER BY
              CPO_ORD_NUM
            , DS_CPO_CONFIG_PK
            , CPO_DTL_LINE_NUM
            , CPO_DTL_LINE_SUB_NUM
            , DS_CPO_RTRN_LINE_NUM
            , DS_CPO_RTRN_LINE_SUB_NUM
    </statement>

    <statement id="geConvTargetKehy" parameterClass="Map" resultClass="String">
        SELECT
            DOL.DS_ORD_TP_CD || DOL.DS_ORD_LINE_CATG_CD
        FROM
             ORD_PROC_TP OPT
            ,DS_ORD_LINE_PROC_DFN DOL
        WHERE
            OPT.GLBL_CMPY_CD     = #glblCmpyCd#
        AND OPT.CONV_PROC_TP_TXT = #convProcTpTxt#
        AND OPT.EFF_FROM_DT    &lt;= #slsDt#
        AND (OPT.EFF_THRU_DT   &gt;= #slsDt#
          OR OPT.EFF_THRU_DT      IS NULL)
        AND OPT.EZCANCELFLAG     = '0'
        AND DOL.GLBL_CMPY_CD     = OPT.GLBL_CMPY_CD
        AND DOL.ORD_PROC_TP_CD   = OPT.ORD_PROC_TP_CD
        AND DOL.EFF_FROM_DT    &lt;= #slsDt#
        AND (DOL.EFF_THRU_DT   &gt;= #slsDt#
          OR DOL.EFF_THRU_DT      IS NULL)
        AND DOL.EZCANCELFLAG     = '0'
        <!-- 2020/01/21 QC#55207-1 Del Start -->
        <!-- AND DOL.DS_ORD_LINE_CATG_CD  NOT IN --> 
        <!-- <iterate property="dsOrdLineCatg" var="dsOrdLineCatg[]" open="(" close=" )" conjunction=","> -->
        <!--     #dsOrdLineCatg[]# -->
        <!-- </iterate> -->
        <!-- 2020/01/21 QC#55207-1 Del End -->
    </statement>

    <statement id="getLoanBalQty" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            CD.LOAN_BAL_QTY
        FROM
             CPO C
            ,CPO_DTL CD
        WHERE
            C.GLBL_CMPY_CD           = #glblCmpyCd#
        AND C.CPO_ORD_NUM            = #origCpoOrdNum#
<!-- QC#7480
        AND C.CPO_SRC_TP_CD          = #cpoSrcTpCd#
 -->
        AND C.EZCANCELFLAG           = '0'
        AND CD.GLBL_CMPY_CD          = C.GLBL_CMPY_CD
        AND CD.CPO_ORD_NUM           = C.CPO_ORD_NUM
        AND CD.CPO_DTL_LINE_NUM      = #origCpoDtlLineNum#
        AND CD.CPO_DTL_LINE_SUB_NUM  = #origCpoDtlLineSubNum#
        AND CD.EZCANCELFLAG         = '0'
    </statement>

    <statement id="countOpenDetailData" parameterClass="Map" resultClass="Integer">
        SELECT
            COUNT(*)
        FROM
            CPO C
        WHERE
            C.GLBL_CMPY_CD  = #glblCmpyCd#
        AND C.CPO_ORD_NUM   = #origCpoOrdNum#
        AND C.EZCANCELFLAG  = '0'
        AND (
            EXISTS (
                SELECT
                    *
                FROM
                    CPO_DTL CD
                WHERE
                    CD.GLBL_CMPY_CD       = C.GLBL_CMPY_CD
                AND CD.CPO_ORD_NUM        = C.CPO_ORD_NUM
                AND CD.ORD_LINE_STS_CD  NOT IN (#ordLineStsClosed#, #ordLineStsCancelled#)
                AND CD.EZCANCELFLAG       = '0'
            )
            OR
            EXISTS (
                SELECT
                    *
                FROM
                    DS_CPO_RTRN_DTL DCR
                WHERE
                    DCR.GLBL_CMPY_CD      = C.GLBL_CMPY_CD
                AND DCR.CPO_ORD_NUM       = C.CPO_ORD_NUM
                AND DCR.RTRN_LINE_STS_CD NOT IN (#ordLineStsClosed#, #ordLineStsCancelled#)
                AND DCR.EZCANCELFLAG      = '0'
            )
        )
    </statement>
<!-- QC#9594 add Start -->
    <statement id="countOpenCompornent" parameterClass="Map" resultClass="Integer">
        SELECT
            COUNT(1)
        FROM
             CPO_DTL CD
        WHERE
            CD.GLBL_CMPY_CD           = #glblCmpyCd#
        AND CD.CPO_ORD_NUM            = #origCpoOrdNum#
        AND CD.CPO_DTL_LINE_NUM       = #origCpoDtlLineNum#
        AND CD.CPO_DTL_LINE_SUB_NUM   != #origCpoDtlLineSubNum#
        AND CD.ORD_LINE_STS_CD      NOT IN (#ordLineStsClosed#,#ordLineStsCancelled#)
        AND CD.EZCANCELFLAG           = '0'
    </statement>
    <statement id="countUnconpleteConversionCompornent" parameterClass="Map" resultClass="Integer">
        SELECT
            COUNT(1)
        FROM
             CPO_DTL        CD
        WHERE
            CD.GLBL_CMPY_CD           = #glblCmpyCd#
        AND CD.CPO_ORD_NUM            = #cpoOrdNum#
        AND CD.CPO_DTL_LINE_NUM       = #cpoDtlLineNum#
        AND CD.CPO_DTL_LINE_SUB_NUM  != #cpoDtlLineSubNum#
        AND CD.ORD_LINE_STS_CD       != #ordLineStsCancelled#
        AND CD.EZCANCELFLAG           = '0'
        AND CD.CONV_COMP_FLG          = #convCompFlgN#
    </statement>
    <statement id="countUnconpleteConversionCompornentForReturn" parameterClass="Map" resultClass="Integer">
        SELECT
            COUNT(1)
        FROM
             DS_CPO_RTRN_DTL    DCRD
        WHERE
            DCRD.GLBL_CMPY_CD               = #glblCmpyCd#
        AND DCRD.CPO_ORD_NUM                = #cpoOrdNum#
        AND DCRD.DS_CPO_RTRN_LINE_NUM       = #dsCpoRtrnLineNum#
        AND DCRD.DS_CPO_RTRN_LINE_SUB_NUM  != #dsCpoRtrnLineSubNum#
        AND DCRD.RTRN_LINE_STS_CD          != #rtrnLineStsCancelled#
        AND DCRD.CONV_COMP_FLG              = #convCompFlgN#
        AND DCRD.EZCANCELFLAG               = '0'
    </statement>

<!-- QC#9594 add End -->
<!-- 2018/03/06 S21_NA#20153 Add Start -->
    <statement id="getIbOwnerOverrideInfo" parameterClass="Map" resultClass="Map">
        SELECT
             OCBC.FIRST_BIZ_CTX_ATTRB_TXT   OWNR_LOC_NUM
            ,BTC.SELL_TO_CUST_CD            OWNR_ACCT_NUM
        FROM
             ORD_CATG_BIZ_CTX   OCBC
            ,BILL_TO_CUST       BTC
        WHERE
            OCBC.GLBL_CMPY_CD               = #glblCmpyCd#
        AND OCBC.ORD_CATG_CTX_TP_CD         = #ordCatgCtxTpCd#
        AND OCBC.DS_ORD_CATG_CD             = #dsOrdCatgCd#
        AND (
                OCBC.DS_ORD_TP_CD           IS NULL
                OR (
                        OCBC.DS_ORD_TP_CD   IS NOT NULL
                <isNotNull property="dsOrdTpCd">
                    AND OCBC.DS_ORD_TP_CD   = #dsOrdTpCd#
                </isNotNull>
                )
            )
        AND (
                OCBC.DS_ORD_RSN_CD          IS NULL
                OR (
                        OCBC.DS_ORD_RSN_CD  IS NOT NULL
                <isNotNull property="dsOrdRsnCd">
                    AND OCBC.DS_ORD_RSN_CD  = #dsOrdRsnCd#
                </isNotNull>
                )
            )
        AND OCBC.EZCANCELFLAG               = '0'

        AND OCBC.GLBL_CMPY_CD               = BTC.GLBL_CMPY_CD(+)
        AND OCBC.FIRST_BIZ_CTX_ATTRB_TXT    = BTC.BILL_TO_CUST_CD(+)
        AND BTC.EZCANCELFLAG(+)             = '0'
    </statement>
<!-- 2018/03/06 S21_NA#20153 Add End -->

    <!-- START 2019/05/09 Hd.Sugawara [QC#50075,ADD] -->
    <statement id="getSalesAndReturnConvOrdInfoForSameConfig" parameterClass="Map">
        SELECT
                  CPO_ORD_NUM
                , SELL_TO_CUST_CD
                , CUST_ISS_PO_NUM
                , CPO_ORD_TP_CD
                , SOLD_TO_CUST_LOC_CD
                , DS_ORD_TP_CD
                , DS_ORD_RSN_CD
                , DS_ORD_CATG_CD
                , ORIG_CPO_ORD_NUM
                , ORIG_CPO_DTL_LINE_NUM
                , ORIG_CPO_DTL_LINE_SUB_NUM
                , ORD_SRC_REF_NUM
                , DS_CPO_CONFIG_PK
                , BILL_TO_CUST_ACCT_CD
                , BILL_TO_CUST_LOC_CD
                , SHIP_TO_CUST_ACCT_CD
                , SHIP_TO_CUST_LOC_CD
                , SHIP_TO_LOC_NM
                , SHIP_TO_ADDL_LOC_NM
                , SHIP_TO_FIRST_LINE_ADDR
                , SHIP_TO_SCD_LINE_ADDR
                , SHIP_TO_THIRD_LINE_ADDR
                , SHIP_TO_FRTH_LINE_ADDR
                , SHIP_TO_CTY_ADDR
                , SHIP_TO_ST_CD
                , SHIP_TO_PROV_NM
                , SHIP_TO_CNTY_NM
                , SHIP_TO_POST_CD
                , SHIP_TO_CTRY_CD
                , CPO_DTL_LINE_NUM
                , CPO_DTL_LINE_SUB_NUM
                , DS_CPO_RTRN_LINE_NUM
                , DS_CPO_RTRN_LINE_SUB_NUM
                , SLS_REP_OR_SLS_TEAM_TOC_CD
                , ORD_QTY
                , MDSE_CD
                , DS_ORD_POSN_NUM
                , SVC_CONFIG_MSTR_PK
                , BASE_CMPT_FLG
                , ORD_SRC_REF_LINE_NUM
                , ORD_SRC_REF_LINE_SUB_NUM
                , DS_CONTR_NUM
                , DS_CONTR_SQ_NUM
                , SVC_MACH_MSTR_PK
                , DS_ORD_LINE_CATG_CD
                , INV_NUM
                , INV_DT
                , BILL_TO_LOC_NUM
                , SHIP_TO_LOC_NUM
                , SET_MDSE_CD
        FROM (
            <!-- ##### Loan to Sales, Rental to Sales ##### -->
            SELECT
                  C.CPO_ORD_NUM                 AS CPO_ORD_NUM
                , C.SELL_TO_CUST_CD             AS SELL_TO_CUST_CD
                , C.CUST_ISS_PO_NUM             AS CUST_ISS_PO_NUM
                , C.CPO_ORD_TP_CD               AS CPO_ORD_TP_CD
                , C.SOLD_TO_CUST_LOC_CD         AS SOLD_TO_CUST_LOC_CD
                , C.DS_ORD_TP_CD                AS DS_ORD_TP_CD
                , C.DS_ORD_RSN_CD               AS DS_ORD_RSN_CD
                , C.DS_ORD_CATG_CD              AS DS_ORD_CATG_CD
                , CD.ORIG_CPO_ORD_NUM           AS ORIG_CPO_ORD_NUM
                , CD.ORIG_CPO_DTL_LINE_NUM      AS ORIG_CPO_DTL_LINE_NUM
                , CD.ORIG_CPO_DTL_LINE_SUB_NUM  AS ORIG_CPO_DTL_LINE_SUB_NUM
                , C.ORD_SRC_REF_NUM             AS ORD_SRC_REF_NUM
                , DCC.DS_CPO_CONFIG_PK          AS DS_CPO_CONFIG_PK
                , DCC.BILL_TO_CUST_ACCT_CD      AS BILL_TO_CUST_ACCT_CD
                , DCC.BILL_TO_CUST_LOC_CD       AS BILL_TO_CUST_LOC_CD
                , DCC.SHIP_TO_CUST_ACCT_CD      AS SHIP_TO_CUST_ACCT_CD
                , DCC.SHIP_TO_CUST_LOC_CD       AS SHIP_TO_CUST_LOC_CD
                , DCC.SHIP_TO_LOC_NM            AS SHIP_TO_LOC_NM
                , DCC.SHIP_TO_ADDL_LOC_NM       AS SHIP_TO_ADDL_LOC_NM
                , DCC.SHIP_TO_FIRST_LINE_ADDR   AS SHIP_TO_FIRST_LINE_ADDR
                , DCC.SHIP_TO_SCD_LINE_ADDR     AS SHIP_TO_SCD_LINE_ADDR
                , DCC.SHIP_TO_THIRD_LINE_ADDR   AS SHIP_TO_THIRD_LINE_ADDR
                , DCC.SHIP_TO_FRTH_LINE_ADDR    AS SHIP_TO_FRTH_LINE_ADDR
                , DCC.SHIP_TO_CTY_ADDR          AS SHIP_TO_CTY_ADDR
                , DCC.SHIP_TO_ST_CD             AS SHIP_TO_ST_CD
                , DCC.SHIP_TO_PROV_NM           AS SHIP_TO_PROV_NM
                , DCC.SHIP_TO_CNTY_NM           AS SHIP_TO_CNTY_NM
                , DCC.SHIP_TO_POST_CD           AS SHIP_TO_POST_CD
                , DCC.SHIP_TO_CTRY_CD           AS SHIP_TO_CTRY_CD
                , CD.CPO_DTL_LINE_NUM           AS CPO_DTL_LINE_NUM
                , CD.CPO_DTL_LINE_SUB_NUM       AS CPO_DTL_LINE_SUB_NUM
                , ''                            AS DS_CPO_RTRN_LINE_NUM
                , ''                            AS DS_CPO_RTRN_LINE_SUB_NUM
                , CD.SLS_REP_OR_SLS_TEAM_TOC_CD AS SLS_REP_OR_SLS_TEAM_TOC_CD
                , CD.ORD_QTY                    AS ORD_QTY
                , CD.MDSE_CD                    AS MDSE_CD
                , CD.DS_ORD_POSN_NUM            AS DS_ORD_POSN_NUM
                , CD.SVC_CONFIG_MSTR_PK         AS SVC_CONFIG_MSTR_PK
                , CD.BASE_CMPT_FLG              AS BASE_CMPT_FLG
                , CD.ORD_SRC_REF_LINE_NUM       AS ORD_SRC_REF_LINE_NUM
                , CD.ORD_SRC_REF_LINE_SUB_NUM   AS ORD_SRC_REF_LINE_SUB_NUM
                , CD.DS_CONTR_NUM               AS DS_CONTR_NUM
                , CD.DS_CONTR_SQ_NUM            AS DS_CONTR_SQ_NUM
                , CD.SVC_MACH_MSTR_PK           AS SVC_MACH_MSTR_PK
                , CD.DS_ORD_LINE_CATG_CD        AS DS_ORD_LINE_CATG_CD
                , I.INV_NUM                     AS INV_NUM
                , I.INV_DT                      AS INV_DT
                , BTC.LOC_NUM                   AS BILL_TO_LOC_NUM
                , STC.LOC_NUM                   AS SHIP_TO_LOC_NUM
                , CD.SET_MDSE_CD                AS SET_MDSE_CD
            FROM
                  CPO C
                , CPO_DTL CD
                , SVC_MACH_MSTR SMM
                , DS_CPO_CONFIG DCC
                , INV I
                , INV_LINE IL
                , BILL_TO_CUST BTC
                , SHIP_TO_CUST STC
            WHERE
                  C.GLBL_CMPY_CD                = #glblCmpyCd#
              AND C.EZCANCELFLAG                = '0'
              AND C.CPO_ORD_NUM                 = #cpoOrdNum#

              AND C.GLBL_CMPY_CD                = CD.GLBL_CMPY_CD
              AND C.CPO_ORD_NUM                 = CD.CPO_ORD_NUM
              AND CD.ORD_LINE_STS_CD            = #ordLineStsCd#
              AND CD.EZCANCELFLAG               = '0'
              AND CD.CPO_DTL_LINE_SUB_NUM      != '000'

              AND CD.CR_REBIL_CD                IS NULL

              AND C.DS_ORD_TP_CD || CD.DS_ORD_LINE_CATG_CD NOT IN
                <iterate property="dsOrdLineCatgCdSls" var="dsOrdLineCatgCdSls[]" open="(" close=" )" conjunction=",">
                    #dsOrdLineCatgCdSls[]#
                </iterate>
              AND CD.CONV_COMP_FLG              = #convCompFlg#

              AND CD.GLBL_CMPY_CD               = DCC.GLBL_CMPY_CD
              AND CD.DS_CPO_CONFIG_PK           = DCC.DS_CPO_CONFIG_PK
              AND DCC.EZCANCELFLAG              = '0'

              AND CD.GLBL_CMPY_CD               = SMM.GLBL_CMPY_CD
              AND CD.SVC_CONFIG_MSTR_PK         = SMM.SVC_CONFIG_MSTR_PK
              AND CD.SVC_MACH_MSTR_PK           = SMM.SVC_MACH_MSTR_PK
              AND SMM.EZCANCELFLAG              = '0'
              AND SMM.SVC_CONFIG_MSTR_PK        = #svcConfigMstrPk#

              AND CD.GLBL_CMPY_CD               = IL.GLBL_CMPY_CD
              AND CD.CPO_ORD_NUM                = IL.CPO_ORD_NUM
              AND CD.CPO_DTL_LINE_NUM           = IL.CPO_DTL_LINE_NUM
              AND CD.CPO_DTL_LINE_SUB_NUM       = IL.CPO_DTL_LINE_SUB_NUM
              AND IL.EZCANCELFLAG               = '0'

              AND IL.GLBL_CMPY_CD               = I.GLBL_CMPY_CD
              AND IL.INV_NUM                    = I.INV_NUM
              AND IL.EZCANCELFLAG               = '0'

              AND DCC.GLBL_CMPY_CD              = BTC.GLBL_CMPY_CD
              AND DCC.BILL_TO_CUST_LOC_CD       = BTC.BILL_TO_CUST_CD
              <!-- Del Start 2019/12/20 QC#55044 -->
              <!-- AND BTC.RGTN_STS_CD               = #rgtnStsCd# -->
              <!-- Del End   2019/12/20 QC#55044 -->
              AND BTC.EZCANCELFLAG              = '0'

              AND DCC.GLBL_CMPY_CD              = STC.GLBL_CMPY_CD
              AND DCC.SHIP_TO_CUST_LOC_CD       = STC.SHIP_TO_CUST_CD
              <!-- Del Start 2019/12/20 QC#55044 -->
              <!-- AND STC.RGTN_STS_CD               = #rgtnStsCd# -->
              <!-- Del End   2019/12/20 QC#55044 -->
              AND STC.EZCANCELFLAG              = '0'

            UNION
            <!-- ##### Loan Return ##### -->
            SELECT
                  C.CPO_ORD_NUM                 AS CPO_ORD_NUM
                , C.SELL_TO_CUST_CD             AS SELL_TO_CUST_CD
                , C.CUST_ISS_PO_NUM             AS CUST_ISS_PO_NUM
                , C.CPO_ORD_TP_CD               AS CPO_ORD_TP_CD
                , C.SOLD_TO_CUST_LOC_CD         AS SOLD_TO_CUST_LOC_CD
                , C.DS_ORD_TP_CD                AS DS_ORD_TP_CD
                , C.DS_ORD_RSN_CD               AS DS_ORD_RSN_CD
                , C.DS_ORD_CATG_CD              AS DS_ORD_CATG_CD
                , NVL(DCR.ORIG_CPO_ORD_NUM, C.CPO_ORD_NUM)
                                                AS ORIG_CPO_ORD_NUM
                , DCR.ORIG_CPO_DTL_LINE_NUM     AS ORIG_CPO_DTL_LINE_NUM
                , DCR.ORIG_CPO_DTL_LINE_SUB_NUM AS ORIG_CPO_DTL_LINE_SUB_NUM
                , NVL(C.ORD_SRC_REF_NUM, C.CPO_ORD_NUM)
                                                AS ORD_SRC_REF_NUM
                , DCC.DS_CPO_CONFIG_PK          AS DS_CPO_CONFIG_PK
                , DCC.BILL_TO_CUST_ACCT_CD      AS BILL_TO_CUST_ACCT_CD
                , DCC.BILL_TO_CUST_LOC_CD       AS BILL_TO_CUST_LOC_CD
                , DCC.SHIP_TO_CUST_ACCT_CD      AS SHIP_TO_CUST_ACCT_CD
                , DCC.SHIP_TO_CUST_LOC_CD       AS SHIP_TO_CUST_LOC_CD
                , DCC.SHIP_TO_LOC_NM            AS SHIP_TO_LOC_NM
                , DCC.SHIP_TO_ADDL_LOC_NM       AS SHIP_TO_ADDL_LOC_NM
                , DCC.SHIP_TO_FIRST_LINE_ADDR   AS SHIP_TO_FIRST_LINE_ADDR
                , DCC.SHIP_TO_SCD_LINE_ADDR     AS SHIP_TO_SCD_LINE_ADDR
                , DCC.SHIP_TO_THIRD_LINE_ADDR   AS SHIP_TO_THIRD_LINE_ADDR
                , DCC.SHIP_TO_FRTH_LINE_ADDR    AS SHIP_TO_FRTH_LINE_ADDR
                , DCC.SHIP_TO_CTY_ADDR          AS SHIP_TO_CTY_ADDR
                , DCC.SHIP_TO_ST_CD             AS SHIP_TO_ST_CD
                , DCC.SHIP_TO_PROV_NM           AS SHIP_TO_PROV_NM
                , DCC.SHIP_TO_CNTY_NM           AS SHIP_TO_CNTY_NM
                , DCC.SHIP_TO_POST_CD           AS SHIP_TO_POST_CD
                , DCC.SHIP_TO_CTRY_CD           AS SHIP_TO_CTRY_CD
                , ''                            AS CPO_DTL_LINE_NUM
                , ''                            AS CPO_DTL_LINE_SUB_NUM
                , DCR.DS_CPO_RTRN_LINE_NUM      AS DS_CPO_RTRN_LINE_NUM
                , DCR.DS_CPO_RTRN_LINE_SUB_NUM  AS DS_CPO_RTRN_LINE_SUB_NUM
                , DCR.SLS_REP_OR_SLS_TEAM_TOC_CD AS SLS_REP_OR_SLS_TEAM_TOC_CD
                , ABS(DCR.ORD_QTY)              AS ORD_QTY
                , DCR.MDSE_CD                   AS MDSE_CD
                , DCR.DS_ORD_POSN_NUM           AS DS_ORD_POSN_NUM
                , DCR.SVC_CONFIG_MSTR_PK        AS SVC_CONFIG_MSTR_PK
                , DCR.BASE_CMPT_FLG             AS BASE_CMPT_FLG
                , DCR.ORD_SRC_REF_LINE_NUM      AS ORD_SRC_REF_LINE_NUM
                , DCR.ORD_SRC_REF_LINE_SUB_NUM  AS ORD_SRC_REF_LINE_SUB_NUM
                , DCR.DS_CONTR_NUM              AS DS_CONTR_NUM
                , DCR.DS_CONTR_SQ_NUM           AS DS_CONTR_SQ_NUM
                , DCR.SVC_MACH_MSTR_PK          AS SVC_MACH_MSTR_PK
                , DCR.DS_ORD_LINE_CATG_CD       AS DS_ORD_LINE_CATG_CD
                , ''                            AS INV_NUM
                , ''                            AS INV_DT
                , ''                            AS BILL_TO_LOC_NUM
                , ''                            AS SHIP_TO_LOC_NUM
                , DCR.SET_MDSE_CD               AS SET_MDSE_CD
            FROM
                  CPO C
                , DS_CPO_RTRN_DTL DCR
                , SVC_MACH_MSTR SMM
                , DS_CPO_CONFIG DCC
            WHERE
                  C.GLBL_CMPY_CD                = #glblCmpyCd#
              AND C.EZCANCELFLAG                = '0'
              AND C.CPO_ORD_NUM                 = #cpoOrdNum#

              AND C.GLBL_CMPY_CD                = DCR.GLBL_CMPY_CD
              AND C.CPO_ORD_NUM                 = DCR.CPO_ORD_NUM
              AND DCR.RTRN_LINE_STS_CD          = #ordLineStsCd#
              AND DCR.CR_REBIL_CD               IS NULL

              AND C.DS_ORD_TP_CD || DCR.DS_ORD_LINE_CATG_CD NOT IN
                <iterate property="dsOrdLineCatgCdRtrn" var="dsOrdLineCatgCdRtrn[]" open="(" close=" )" conjunction=",">
                    #dsOrdLineCatgCdRtrn[]#
                </iterate>
              AND DCR.CONV_COMP_FLG             = #convCompFlg#
              AND DCR.EZCANCELFLAG              = '0'
              AND DCR.DS_CPO_RTRN_LINE_SUB_NUM != '000'

              AND DCR.GLBL_CMPY_CD              = DCC.GLBL_CMPY_CD
              AND DCR.DS_CPO_CONFIG_PK          = DCC.DS_CPO_CONFIG_PK
              AND DCC.EZCANCELFLAG              = '0'

              AND DCR.GLBL_CMPY_CD              = SMM.GLBL_CMPY_CD
              AND DCR.SVC_CONFIG_MSTR_PK        = SMM.SVC_CONFIG_MSTR_PK
              AND DCR.SVC_MACH_MSTR_PK          = SMM.SVC_MACH_MSTR_PK
              AND SMM.EZCANCELFLAG              = '0'
              AND SMM.SVC_CONFIG_MSTR_PK        = #svcConfigMstrPk#
        )
        ORDER BY
              CPO_ORD_NUM
            , DS_CPO_CONFIG_PK
            , CPO_DTL_LINE_NUM
            , CPO_DTL_LINE_SUB_NUM
            , DS_CPO_RTRN_LINE_NUM
            , DS_CPO_RTRN_LINE_SUB_NUM
    </statement>
    <!-- END 2019/05/09 Hd.Sugawara [QC#50075,ADD] -->
</sqlMap>
