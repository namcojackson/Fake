<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSAB066001">

    <statement id="getTrgtDtRec" parameterClass="Map" resultClass="BigDecimal">
        SELECT COUNT(1)
        FROM
            DMN_MDL               MDL
        WHERE 
            MDL.GLBL_CMPY_CD      = #glblCmpyCd#
        AND MDL.DWH_TRGT_DT       = #trgtDt#
        AND MDL.EZCANCELFLAG      = '0'
    </statement>

    <statement id="getMainData" parameterClass="Map" resultClass="Map">
        SELECT 
             DM.MDL_ID
            ,DM.MDL_GRP_ID
            ,DM.SVC_SEG_CD
            ,DM.MTR_GRP_PK
            ,DM.RGTN_STS_CD                AS MDL_RGTN_STS_CD
            ,DM.MDL_ACTV_FLG
            ,DMG.MDL_GRP_DESC_TXT
            ,DM.MDL_DESC_TXT
            ,SS.SVC_SEG_DESC_TXT
            ,MG.MTR_GRP_DESC_TXT
            ,MN.T_MDL_NM
            ,ML1.MTR_GRP_TP_CD             AS MTR_GRP_TP_CD
            ,MGT.MTR_GRP_TP_DESC_TXT
            ,DM.MAX_COPY_PER_DAY_TOT_CNT
            ,DM.MAX_COPY_PER_DAY_BLACK_CNT
            ,DM.MAX_COPY_TEST_CNT
            ,DM.RCLL_INTVL_DAYS_AOT
            ,DM.RCLL_COPY_VOL_CNT
            ,DM.RCLL_GLBL_INTVL_DAYS_AOT
            ,DM.RCLL_GLBL_COPY_VOL_CNT
        FROM
             DS_MDL     DM
            ,DS_MDL_GRP DMG
            ,MDL_NM     MN
            ,SVC_SEG    SS
            ,MTR_GRP    MG
            ,MTR_GRP_TP MGT
            ,(
                SELECT 
                    ML.GLBL_CMPY_CD
                   ,ML.EZCANCELFLAG
                   ,ML.MTR_LB_CD
                   ,DMM.MTR_GRP_PK
                   ,ROW_NUMBER() OVER(PARTITION BY DMM.MTR_GRP_PK ORDER BY ML.COLOR_MTR_FLG DESC, ML.BW_MTR_FLG DESC) IDX
                   ,CASE WHEN ML.COLOR_MTR_FLG = 'Y' THEN #clrMtrGrpTpCd#
                         WHEN ML.BW_MTR_FLG = 'Y' THEN #bwMtrGrpTpCd#
                         ELSE NULL END AS MTR_GRP_TP_CD
                FROM
                    DS_MDL_MTR DMM
                   ,MTR_LB ML
                WHERE
                    DMM.GLBL_CMPY_CD   = ML.GLBL_CMPY_CD
                AND DMM.MDL_MTR_LB_CD  = ML.MTR_LB_CD
                AND DMM.EZCANCELFLAG   = '0'
                AND ML.EZCANCELFLAG    = '0'
             ) ML1
        WHERE
            DM.GLBL_CMPY_CD         = #glblCmpyCd#
        AND DM.GLBL_CMPY_CD         = DMG.GLBL_CMPY_CD(+)
        AND DM.MDL_GRP_ID           = DMG.MDL_GRP_ID(+)
        AND DM.GLBL_CMPY_CD         = MN.T_GLBL_CMPY_CD(+)
        AND DM.MDL_ID               = MN.T_MDL_ID(+)
        AND DM.GLBL_CMPY_CD         = SS.GLBL_CMPY_CD(+)
        AND DM.SVC_SEG_CD           = SS.SVC_SEG_CD(+)
        AND DM.GLBL_CMPY_CD         = MG.GLBL_CMPY_CD(+)
        AND DM.MTR_GRP_PK           = MG.MTR_GRP_PK(+)
        AND MG.GLBL_CMPY_CD         = ML1.GLBL_CMPY_CD(+)
        AND MG.MTR_GRP_PK           = ML1.MTR_GRP_PK(+)
        AND ML1.GLBL_CMPY_CD        = MGT.GLBL_CMPY_CD(+)
        AND ML1.MTR_GRP_TP_CD       = MGT.MTR_GRP_TP_CD(+)
        AND ML1.IDX(+)              = 1
        AND DM.EZCANCELFLAG         = '0'
        AND DMG.EZCANCELFLAG(+)     = '0'
        AND MN.EZCANCELFLAG(+)      = '0'
        AND SS.EZCANCELFLAG(+)      = '0'
        AND MG.EZCANCELFLAG(+)      = '0'
        AND ML1.EZCANCELFLAG(+)     = '0'
        AND MGT.EZCANCELFLAG(+)     = '0'
        ORDER BY
            DM.MDL_ID
           ,DM.MDL_GRP_ID
           ,DM.SVC_SEG_CD
           ,DM.MTR_GRP_PK
    </statement>

</sqlMap>
