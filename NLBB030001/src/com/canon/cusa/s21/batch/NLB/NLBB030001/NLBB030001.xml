<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NLBB030001">

    <statement id="findShpgList" parameterClass="Map" resultClass="Map">
        SELECT
            SP.GLBL_CMPY_CD
           ,SOD.SO_NUM
           ,SOD.SO_SLP_NUM
           ,SP.CARR_CD
           ,RW.RTL_WH_NM                           AS EDI_SHPPR_NM
           ,SUBSTR(RW.FIRST_LINE_ADDR,1,35)        AS EDI_SHPPR_ADDR
           ,RW.CTY_ADDR                            AS EDI_SHPPR_CTY_NM
           ,RW.ST_CD                               AS EDI_SHPPR_ST_CD
           ,SUBSTR(RW.POST_CD,1,10)                AS EDI_SHPPR_POST_CD
           ,SUBSTR(SLTC.DS_ACCT_NM,1,35)            AS EDI_CNSGN_NM
           ,SUBSTR(SOCD.SO_CUST_LINE_ADDR_01,1,35) AS EDI_CNSGN_ADDR
           ,SOCD.CTY_ADDR                          AS EDI_CNSGN_CTY_NM
           ,SOCD.ST_CD                             AS EDI_CNSGN_ST_CD
           ,SUBSTR(SOCD.POST_CD,1,10)              AS EDI_CNSGN_POST_CD
           ,SOCD.CTY_ADDR                          AS EDI_STS_CTY_NM
           ,SOCD.ST_CD                             AS EDI_STS_ST_CD
        FROM
            SHPG_PLN          SP
           ,SHPG_STS          ST
           ,SHPG_ORD_DTL      SOD
           ,SHPG_ORD          SO
           ,SHPG_ORD_CUST_DTL SOCD
           ,RTL_WH            RW
           ,SHIP_TO_CUST      STC
           ,SELL_TO_CUST      SLTC
           <!-- START 2018/02/26 S.Katsuma [QC#20394,ADD] -->
           ,CPO               C
           <!-- END 2018/02/26 S.Katsuma [QC#20394,ADD] -->
        WHERE
            SP.GLBL_CMPY_CD         = #glblCmpyCd#
        <!-- START 2018/02/26 S.Katsuma [QC#20394,DEL] -->
        <!-- AND SP.REV_RECOG_FLG        = #revRecogFlg# -->
        <!-- END 2018/02/26 S.Katsuma [QC#20394,DEL] -->
        AND SP.TRX_SRC_TP_CD        = #trxSrcTpCd#
        AND SP.SHIP_PLN_CANC_FLG    = #shipPlnCancFlg#
        AND SP.ACTL_ARV_DT          IS NULL
        AND SP.EZCANCELFLAG         = '0'
        AND SP.GLBL_CMPY_CD         = ST.GLBL_CMPY_CD
        AND SP.SHPG_STS_CD          = ST.SHPG_STS_CD
        AND ST.SHIP_FLG             = #shipFlg#
        AND ST.EZCANCELFLAG         = '0'
        AND SP.GLBL_CMPY_CD         = SOD.GLBL_CMPY_CD
        AND SP.SHPG_PLN_NUM         = SOD.SHPG_PLN_NUM
        AND SOD.EZCANCELFLAG        = '0'
        AND SOD.GLBL_CMPY_CD        = SO.GLBL_CMPY_CD
        AND SOD.SO_NUM              = SO.SO_NUM
        AND SO.SCE_ORD_TP_CD        = #sceOrdTpCd#
        AND TO_DATE(#batchDt#, 'YYYYMMDD') - TO_DATE(SO.SCHD_DELY_DT, 'YYYYMMDD') &gt;= #schdDelyExcdDays#
        AND SO.EZCANCELFLAG         = '0'
        AND SO.GLBL_CMPY_CD         = SOCD.GLBL_CMPY_CD
        AND SO.SO_NUM               = SOCD.SO_NUM
        AND SOCD.SO_CUST_DATA_TP_CD = #soCustDataTpCd#
        AND SOCD.EZCANCELFLAG       = '0'
        AND SO.GLBL_CMPY_CD         = RW.GLBL_CMPY_CD
        AND SO.WH_CD                = RW.RTL_WH_CD
        AND RW.EZCANCELFLAG         = '0'
        AND SO.GLBL_CMPY_CD         = STC.GLBL_CMPY_CD(+)
        AND SO.SHIP_TO_CUST_CD      = STC.SHIP_TO_CUST_CD(+)
        AND STC.EZCANCELFLAG(+)     = '0'
        AND STC.GLBL_CMPY_CD        = SLTC.GLBL_CMPY_CD(+)
        AND STC.SELL_TO_CUST_CD     = SLTC.SELL_TO_CUST_CD(+)
        AND SLTC.EZCANCELFLAG(+)    = '0'
        <!-- START 2018/02/26 S.Katsuma [QC#20394,ADD] -->
        AND SP.GLBL_CMPY_CD         = C.GLBL_CMPY_CD
        AND SP.TRX_HDR_NUM          = C.CPO_ORD_NUM
        AND C.EZCANCELFLAG          = '0'
        AND EXISTS (
            SELECT
                1
            FROM
                EXCL_SCHD_COORD ESC
            WHERE
                ESC.GLBL_CMPY_CD     = C.GLBL_CMPY_CD
            AND ESC.DS_ORD_CATG_CD   = C.DS_ORD_CATG_CD
            AND (   ESC.DS_ORD_TP_CD = C.DS_ORD_TP_CD
                 OR ESC.DS_ORD_TP_CD IS NULL
                )
            AND ESC.EZCANCELFLAG = '0'
        )
        <!-- END 2018/02/26 S.Katsuma [QC#20394,ADD] -->
        <!-- START 2023/09/11 S.Dong [QC#61274,ADD] -->
		UNION
		SELECT
            SP.GLBL_CMPY_CD
           ,SOD.SO_NUM
           ,SOD.SO_SLP_NUM
           ,SP.CARR_CD
           ,RW.RTL_WH_NM                           AS EDI_SHPPR_NM
           ,SUBSTR(RW.FIRST_LINE_ADDR,1,35)        AS EDI_SHPPR_ADDR
           ,RW.CTY_ADDR                            AS EDI_SHPPR_CTY_NM
           ,RW.ST_CD                               AS EDI_SHPPR_ST_CD
           ,SUBSTR(RW.POST_CD,1,10)                AS EDI_SHPPR_POST_CD
           ,SUBSTR(SLTC.DS_ACCT_NM,1,35)           AS EDI_CNSGN_NM
           ,SUBSTR(SOCD.SO_CUST_LINE_ADDR_01,1,35) AS EDI_CNSGN_ADDR
           ,SOCD.CTY_ADDR                          AS EDI_CNSGN_CTY_NM
           ,SOCD.ST_CD                             AS EDI_CNSGN_ST_CD
           ,SUBSTR(SOCD.POST_CD,1,10)              AS EDI_CNSGN_POST_CD
           ,SOCD.CTY_ADDR                          AS EDI_STS_CTY_NM
           ,SOCD.ST_CD                             AS EDI_STS_ST_CD
        FROM
            SHPG_PLN          SP
           ,SHPG_STS          ST
           ,SHPG_ORD_DTL      SOD
           ,SHPG_ORD          SO
           ,SHPG_ORD_CUST_DTL SOCD
           ,RTL_WH            RW
           ,SHIP_TO_CUST      STC
           ,SELL_TO_CUST      SLTC
		   ,CPO               C
		   ,PO_DTL            PD
		   ,EDI_ASN_DTL_WRK   EDD
	    WHERE
	        SP.GLBL_CMPY_CD             = #glblCmpyCd#
	        AND SP.TRX_SRC_TP_CD        = #trxSrcTpCd#
	        AND SP.SHIP_PLN_CANC_FLG    = #shipPlnCancFlg#
	        AND SP.ACTL_ARV_DT          IS NULL
	        AND SP.EZCANCELFLAG         = '0'
	        AND SP.GLBL_CMPY_CD         = ST.GLBL_CMPY_CD
	        AND SP.SHPG_STS_CD          = ST.SHPG_STS_CD
	        AND ST.SHIP_FLG             = #shipFlg#
	        AND ST.EZCANCELFLAG         = '0'
	        AND SP.GLBL_CMPY_CD         = SOD.GLBL_CMPY_CD
	        AND SP.SHPG_PLN_NUM         = SOD.SHPG_PLN_NUM
	        AND SOD.EZCANCELFLAG        = '0'
	        AND SOD.GLBL_CMPY_CD        = SO.GLBL_CMPY_CD
	        AND SOD.SO_NUM              = SO.SO_NUM
	        AND SO.SCE_ORD_TP_CD        = #sceOrdTpCd#
	        AND SO.EZCANCELFLAG         = '0'
	        AND SO.GLBL_CMPY_CD         = SOCD.GLBL_CMPY_CD
	        AND SO.SO_NUM               = SOCD.SO_NUM
	        AND SOCD.SO_CUST_DATA_TP_CD = #soCustDataTpCd#
	        AND SOCD.EZCANCELFLAG       = '0'
	        AND SO.GLBL_CMPY_CD         = RW.GLBL_CMPY_CD
	        AND SO.WH_CD                = RW.RTL_WH_CD
	        AND RW.EZCANCELFLAG         = '0'
	        AND SO.GLBL_CMPY_CD         = STC.GLBL_CMPY_CD(+)
	        AND SO.SHIP_TO_CUST_CD      = STC.SHIP_TO_CUST_CD(+)
	        AND STC.EZCANCELFLAG(+)     = '0'
	        AND STC.GLBL_CMPY_CD        = SLTC.GLBL_CMPY_CD(+)
	        AND STC.SELL_TO_CUST_CD     = SLTC.SELL_TO_CUST_CD(+)
	        AND SLTC.EZCANCELFLAG(+)    = '0'
	        AND SP.GLBL_CMPY_CD         = C.GLBL_CMPY_CD
	        AND SP.TRX_HDR_NUM          = C.CPO_ORD_NUM
	        AND C.EZCANCELFLAG          = '0'
	        AND SOD.GLBL_CMPY_CD        = PD.GLBL_CMPY_CD
	        AND SOD.TRX_HDR_NUM         = PD.CPO_ORD_NUM
	        AND SOD.TRX_LINE_NUM        = PD.CPO_DTL_LINE_NUM
	        AND SOD.TRX_LINE_SUB_NUM    = PD.CPO_DTL_LINE_SUB_NUM
	        AND PD.EZCANCELFLAG         = '0'
	        AND PD.GLBL_CMPY_CD         = EDD.GLBL_CMPY_CD
	        AND PD.PO_ORD_NUM           = EDD.PO_ORD_NUM
	        AND PD.PO_ORD_DTL_LINE_NUM  = EDD.PO_ORD_DTL_LINE_NUM
	        AND EDD.EZCANCELFLAG        = '0'
	        AND TO_DATE(#batchDt#, 'YYYYMMDD') - TO_DATE(SO.SCHD_DELY_DT, 'YYYYMMDD') &gt;= #schdDelyExcdDays#
	        AND EXISTS (SELECT
	                        1
	                    FROM
	                          PO        POX
	                        , RCV_ASN_VND   RAVX
	                    WHERE
	
	                            PD.GLBL_CMPY_CD     = POX.GLBL_CMPY_CD
	                        AND PD.PO_ORD_NUM       = POX.PO_ORD_NUM
	                        AND PD.EZCANCELFLAG     = '0'
	                        AND PD.GLBL_CMPY_CD     = RAVX.GLBL_CMPY_CD
	                        AND POX.VND_CD          = RAVX.RCV_ASN_VND_CD
	                        AND RAVX.EZCANCELFLAG   = '0'
	                    )
	        AND SOD.RTL_WH_CD
	        IN (<iterate property="avalRtlWhCdArray" var="rtlWhCd[]" open="" close="" conjunction=",">
               #rtlWhCd[]#
               </iterate>)
	    <!-- END 2023/09/11 S.Dong [QC#61274,ADD] -->
        ORDER BY
        <!-- START 2023/10/10 M.Nakajima [QC#61274,MOD] -->
        <!--    SOD.SO_NUM -->
        <!--   ,SOD.SO_SLP_NUM -->
            SO_NUM
           ,SO_SLP_NUM
        <!-- END 2023/10/10 M.Nakajima [QC#61274,MOD] -->
    </statement>

</sqlMap>
