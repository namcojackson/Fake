<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NWCL0050Query">

    <statement id="getInvPrintInfo" parameterClass="Map" resultMap="result.getInvPrintInfo">
    <!-- 2018/10/23 Add Start QC#28422 -->
    WITH IPC AS ( SELECT
                   IPC.BILL_TO_DS_ACCT_NM
                  ,IPC.BILL_TO_DS_ACCT_NUM
                  ,IPC.CONSL_BILL_INV_DT
                  ,IPC.CONSL_BILL_NUM
                  ,IPC.EZCANCELFLAG
                  ,IPC.GLBL_CMPY_CD
                  ,IPC.INV_CRAT_TS
                  ,IPC.INV_EML_ADDR
                  ,IPC.INV_FILE_URL
                  ,IPC.INV_FTP_RQST_NUM
                  ,IPC.INV_NUM
                  ,IPC.INV_PRINT_RQST_NUM
                  ,IPC.INV_PROC_TP_CD
                  ,IPC.INV_PRT_CTRL_PK
                  ,IPC.INV_PRT_CTRL_REC_CD
            <isNotNull property="cMsg.billToLocNum">
                  ,IPC.BILL_TO_LOC_NUM
            </isNotNull>
            <isNotNull property="cMsg.invPrtBatTpCd">
                  ,IPC.INV_PRT_BAT_TP_CD
            </isNotNull>
            <isNotNull property="cMsg.invPrtBrCd">
                  ,IPC.INV_PRT_BR_CD
            </isNotNull>
                  ,IPC.ORIG_CONSL_BILL_NUM <!-- QC#53014 2019/09/17 Add-->
                  FROM   INV_PRT_CTRL IPC
                  ORDER BY IPC.CONSL_BILL_INV_DT
                          ,IPC.CONSL_BILL_NUM
                          ,IPC.INV_NUM NULLS FIRST)
    <!-- 2018/10/23 Add End QC#28422 -->
    <!-- 2019/11/30 Mod Start QC#54210 -->
    <isNotNull property="cMsg.conslBillNum">
        SELECT
            *
        FROM
            (
             SELECT
    <!-- 2018/10/23 Add Start QC#28422 -->
     <isNull property="cMsg.custIssPoNum">
     <isNull property="cMsg.xxUrnNum">
            <isNotNull property="CANON_E479_INV_SRCH_TBL">
                    /*+ LEADING(IPC IPH I CEIST IPC_BILL)
                        USE_NL(IPH)
                        USE_NL(I)
                        USE_NL(CEIST)
                        USE_NL(IPC_BILL)
                        NO_EXPAND                         */
            </isNotNull>
            <isNull property="CANON_E479_INV_SRCH_TBL">
                    /*+ LEADING(IPC IPH I IPC_BILL)
                        USE_NL(IPH)
                        USE_NL(I)
                        USE_NL(IPC_BILL)
                        NO_EXPAND                         */
            </isNull>
     </isNull>
     </isNull>
    <!-- 2018/10/23 Add End QC#28422 -->
                 IPC.INV_PROC_TP_CD      AS INV_PROC_TP_CD
                 <isNotNull property="CANON_E479_INV_SRCH_TBL">
                ,CEIST.URN_NUMBER        AS URN_NUMBER
                 </isNotNull>
                 <isNull property="CANON_E479_INV_SRCH_TBL">
                ,NULL        AS URN_NUMBER
                 </isNull>
                ,IPC.CONSL_BILL_NUM      AS CONSL_BILL_NUM
                ,IPC.INV_NUM             AS INV_NUM
                ,IPC.BILL_TO_DS_ACCT_NUM AS BILL_TO_DS_ACCT_NUM
                ,IPC.BILL_TO_DS_ACCT_NM  AS BILL_TO_DS_ACCT_NM
                ,IPH.INV_DT              AS CONSL_BILL_INV_DT
                ,CASE WHEN I.INV_TP_CD = '2' THEN (IPH.INV_TOT_AMT * -1) ELSE IPH.INV_TOT_AMT END AS CONSL_BILL_TOT_AMT
                ,IPC.INV_EML_ADDR        AS INV_EML_ADDR
                ,IPC.INV_FILE_URL        AS INV_FILE_URL
                ,IPC.INV_PRT_CTRL_REC_CD AS INV_PRT_CTRL_REC_CD
                ,(CASE 
                     WHEN IPC.INV_CRAT_TS IS NOT NULL 
                     THEN TO_CHAR(TO_TIMESTAMP(IPC.INV_CRAT_TS,'YYYYMMDDHH24MISSFF'), #dateFormat#)
                     ELSE NULL
                  END) AS INV_CRAT_TS
                 <isNotNull property="CANON_E479_INV_SRCH_TBL">
                ,CEIST.INVOICE_PATH URN_FILE
                 </isNotNull>
                 <isNull property="CANON_E479_INV_SRCH_TBL">
                ,NULL URN_FILE
                 </isNull>
                 <isNotNull property="CANON_E479_INV_SRCH_TBL">
                ,CEIST.INVOICE_FILE_NAME INVOICE_FILE_NAME
                 </isNotNull>
                 <isNull property="CANON_E479_INV_SRCH_TBL">
                ,NULL INVOICE_FILE_NAME
                 </isNull>
                ,IPC.INV_PRT_CTRL_PK     AS INV_PRT_CTRL_PK
                ,(CASE
                    WHEN IPC.INV_FILE_URL IS NULL
                    THEN NVL(IPC.INV_FTP_RQST_NUM, IPC.INV_PRINT_RQST_NUM)
                    ELSE NULL
                 END) AS EIP_RPT_RQST_PK
                ,(CASE
                    WHEN IPC_BILL.INV_FILE_URL IS NULL
                    THEN NVL(IPC_BILL.INV_FTP_RQST_NUM, IPC_BILL.INV_PRINT_RQST_NUM)
                    ELSE NULL
                  END)  AS BILL_EIP_RPT_RQST_PK
                <!--  START 2018/05/28 Y.Matsui [QC#26342,ADD] -->
                ,I.CUST_ISS_PO_NUM
                <!--  END   2018/05/28 Y.Matsui [QC#26342,ADD] -->
                ,IPC.ORIG_CONSL_BILL_NUM<!-- QC#53014 2019/09/17 Add -->
             FROM
                 <!-- 2018/10/23 Mod Start QC#28422 -->
                 <!-- INV_PRT_CTRL            IPC  -->
                 IPC
                 <!-- 2018/10/23 Mod End QC#28422 -->
                ,INV_PRT_HDR             IPH
                 <isNotNull property="CANON_E479_INV_SRCH_TBL">
                <!--,CANON_E479_INV_SRCH_TBL CEIST -->
                <!--  QC#18468 add TO_CHAR()
                ,(SELECT DISTINCT urn_number, bill_number, INVOICE_PATH, INVOICE_FILE_NAME FROM (
                      SELECT DISTINCT srch.urn_number, srch.invoice_file_name, srch.invoice_path,
                      ceed.bill_number, ceed.invoice_number, ceec.bill_date
                      FROM canon_e479_excel_detail ceed, canon_e479_excel_control ceec, canon_E479_inv_Srch_Tbl srch
                      WHERE ceed.ref_id = ceec.ref_id AND ceed.sequence_id = ceec.sequence_id 
                      AND ceed.rectype = 'DETAIL' and ceec.urn = srch.urn_number)) CEIST
                -->
                ,(SELECT DISTINCT URN_NUMBER, BILL_NUMBER, INVOICE_PATH, INVOICE_FILE_NAME FROM (
                      SELECT DISTINCT SRCH.URN_NUMBER, SRCH.INVOICE_FILE_NAME, SRCH.INVOICE_PATH,
                      CEED.BILL_NUMBER, CEED.INVOICE_NUMBER, CEEC.BILL_DATE
                      FROM CANON_E479_EXCEL_DETAIL CEED, CANON_E479_EXCEL_CONTROL CEEC, CANON_E479_INV_SRCH_TBL SRCH
                      WHERE CEED.REF_ID = CEEC.REF_ID AND CEED.SEQUENCE_ID = CEEC.SEQUENCE_ID 
                      AND CEED.RECTYPE = 'DETAIL' AND TO_CHAR(CEEC.URN) = SRCH.URN_NUMBER)) CEIST
                 </isNotNull>
                ,INV                     I
                ,INV_PRT_CTRL            IPC_BILL
             WHERE
                 <!-- ### INV_PRT_CTRL Table ### -->
                 IPC.GLBL_CMPY_CD     = #glblCmpyCd#
                 AND IPC.EZCANCELFLAG = '0'
                 AND IPC.GLBL_CMPY_CD = IPH.GLBL_CMPY_CD
                 AND IPC.INV_PRT_CTRL_PK = IPH.INV_PRT_CTRL_PK
                 AND IPH.EZCANCELFLAG = '0'
                 AND IPH.GLBL_CMPY_CD = I.GLBL_CMPY_CD (+)
                 AND IPH.INV_BILL_NUM = I.INV_NUM (+)
                 AND I.EZCANCELFLAG (+) = '0'
                 AND IPC.CONSL_BILL_NUM = IPC_BILL.CONSL_BILL_NUM (+)
                 AND IPC.GLBL_CMPY_CD = IPC_BILL.GLBL_CMPY_CD (+)
                 AND IPC_BILL.EZCANCELFLAG (+) = '0'
                 AND IPC_BILL.INV_PRT_CTRL_REC_CD (+) = 'BILL'
                 AND (IPH.ESPAC_FLG = 'N' OR IPH.ESPAC_FLG = 'Y' AND IPC.INV_PRT_CTRL_REC_CD = 'BILL')
                 <isNotNull property="cMsg.invNum">
                     AND IPC.INV_NUM LIKE #cMsg.invNum#
                 </isNotNull>
                 <isNotNull property="cMsg.conslBillNum">
                     AND IPC.CONSL_BILL_NUM LIKE #cMsg.conslBillNum#
                 </isNotNull>
                 <isNotNull property="cMsg.billToDsAcctNum">
                     AND IPC.BILL_TO_DS_ACCT_NUM LIKE #cMsg.billToDsAcctNum#
                 </isNotNull>
                 <isNotNull property="cMsg.billToDsAcctNm">
                     AND IPC.BILL_TO_DS_ACCT_NM LIKE #cMsg.billToDsAcctNm#
                 </isNotNull>
                 <isNotNull property="cMsg.billToLocNum">
                     AND IPC.BILL_TO_LOC_NUM LIKE #cMsg.billToLocNum#
                 </isNotNull>
                 <isNotNull property="cMsg.invPrtBatTpCd">
                     AND IPC.INV_PRT_BAT_TP_CD = #cMsg.invPrtBatTpCd#
                 </isNotNull>
                 <isNotNull property="cMsg.invPrtBrCd">
                     AND IPC.INV_PRT_BR_CD = #cMsg.invPrtBrCd#
                 </isNotNull>
                 <isNotNull property="cMsg.invProcTpCd">
                     AND IPC.INV_PROC_TP_CD = #cMsg.invProcTpCd#
                 </isNotNull>
                 <isNotNull property="cMsg.conslBillInvDt_FR">
                     AND CASE WHEN IPC.CONSL_BILL_NUM IS NOT NULL THEN IPC.CONSL_BILL_INV_DT ELSE IPH.INV_DT END &gt;= #cMsg.conslBillInvDt_FR#
                 </isNotNull>
                 <isNotNull property="cMsg.conslBillInvDt_TO">
                     AND CASE WHEN IPC.CONSL_BILL_NUM IS NOT NULL THEN IPC.CONSL_BILL_INV_DT ELSE IPH.INV_DT END &lt;= #cMsg.conslBillInvDt_TO#
                 </isNotNull>
                 <isNotNull property="cMsg.xxCratDt_FR">
                     AND IPC.INV_CRAT_TS &gt;= #cMsg.xxCratDt_FR# || '000000'
                 </isNotNull>
                 <isNotNull property="cMsg.xxCratDt_TO">
                     AND IPC.INV_CRAT_TS &lt;= #cMsg.xxCratDt_TO# || '235959'
                 </isNotNull>
                 <!--  START 2018/05/28 Y.Matsui [QC#26342,ADD] -->
                 <isNotNull property="cMsg.custIssPoNum">
                 <!-- 2019/04/03 QC#30756 Mod Start -->
                     <!-- AND I.CUST_ISS_PO_NUM LIKE #cMsg.custIssPoNum# -->
                     AND UPPER(I.CUST_ISS_PO_NUM) LIKE #cMsg.custIssPoNum#
                 <!-- 2019/04/03 QC#30756 Mod End -->
                 </isNotNull>
                 <!--  END   2018/05/28 Y.Matsui [QC#26342,ADD] -->
                 <isEqual property="cMsg.xxChkBox_SB" compareValue="Y">
                     AND IPC.INV_PRT_CTRL_REC_CD = #consoliBill#
                 </isEqual>
                 <isEqual property="cMsg.xxChkBox_SP" compareValue="Y"> <!-- QC#53014 2019/09/17 Add -->
                     AND (IPH.EXCL_BILL_TXT = #ExclBillTxtNo# OR IPH.EXCL_BILL_TXT IS NULL)
                 </isEqual>
                 <isNotNull property="CANON_E479_INV_SRCH_TBL">
                 AND IPC.CONSL_BILL_NUM = CEIST.BILL_NUMBER (+)
                 <isNotNull property="cMsg.xxUrnNum">
                 AND CEIST.URN_NUMBER LIKE #cMsg.xxUrnNum#
                 </isNotNull>
                 </isNotNull>
                 <isEqual property="isExistSmryWrk" compareValue="Y">
                 AND EXISTS (
                    SELECT
                       'X'
                    FROM
                       INV_PRT_SMRY IPSW
                    WHERE
                       IPSW.GLBL_CMPY_CD        = IPC.GLBL_CMPY_CD
                    AND (IPSW.INV_BILL_NUM   = IPC.INV_NUM
                    OR
                    IPSW.INV_BILL_NUM   = IPC.CONSL_BILL_NUM)
                    AND IPSW.EZCANCELFLAG    = '0'
                    <isNotNull property="cMsg.ordClsCd">
                    AND EXISTS (
                       SELECT
                          'X'
                       FROM
                          ORD_CLS OC
                       WHERE
                          OC.GLBL_CMPY_CD     = #glblCmpyCd#
                       AND OC.ORD_CLS_CD   = #cMsg.ordClsCd#
                       AND OC.EZCANCELFLAG = '0'
                       AND OC.GLBL_CMPY_CD   = IPSW.GLBL_CMPY_CD
                       AND OC.ORD_CLS_NM     = IPSW.ORD_CLS_NM
                       AND IPSW.EZCANCELFLAG = '0'
                    )
                    </isNotNull>
                    <isNotNull property="cMsg.invSmryLineTpCd">
                    AND EXISTS (
                       SELECT
                          'X'
                       FROM
                          INV_SMRY_LINE_TP ISLT
                       WHERE
                          ISLT.GLBL_CMPY_CD            = #glblCmpyCd#
                       AND ISLT.INV_SMRY_LINE_TP_CD = #cMsg.invSmryLineTpCd#
                       AND ISLT.EZCANCELFLAG        = '0'
                       AND ISLT.GLBL_CMPY_CD        = IPSW.GLBL_CMPY_CD
                       AND ISLT.INV_SMRY_LINE_TP_NM = IPSW.INV_SMRY_LINE_TP_NM
                       AND IPSW.EZCANCELFLAG        = '0'
                       <!-- 2018/10/23 Mod Start QC#28422 -->
                       <!-- UNION -->
                       UNION ALL
                       <!-- 2018/10/23 Mod End QC#28422 -->
                       SELECT
                           'X'
                       FROM
                           DUAL
                       WHERE
                           IPSW.INV_SMRY_FRT_AMT_TXT IS NOT NULL 
                       AND IPSW.INV_SMRY_FRT_AMT_TXT != #zeroDollar#
                       AND #freight# = #cMsg.invSmryLineTpCd#
                    )
                    </isNotNull>
                 )
                 </isEqual>

                 <isNotNull property="cMsg.dsContrNum">
                 <!-- 2021/03/11 Mod Start QC#57920 -->
                 AND (
	                    EXISTS(
	                        SELECT
	                            'X'
	                        FROM
	                            SVC_INV SI
	                        WHERE
	                            SI.GLBL_CMPY_CD         = IPC.GLBL_CMPY_CD
	                        AND SI.SVC_INV_NUM         = IPC.INV_NUM
	                        AND SI.DS_CONTR_NUM   LIKE #cMsg.dsContrNum#
	                        AND SI.EZCANCELFLAG        = '0'
                        ) OR 
                        EXISTS(
                            SELECT
                                'X'
                            FROM
                                INV_LINE IL
                            WHERE
                                IL.GLBL_CMPY_CD    = IPC.GLBL_CMPY_CD
                            AND IL.INV_NUM         = IPC.INV_NUM
                            AND IL.DS_CONTR_NUM   LIKE #cMsg.dsContrNum#
                            AND IL.EZCANCELFLAG    = '0'
                        )
                    )
                 <!-- 2021/03/11 Mod End QC#57920 -->
                 </isNotNull>

                 <isNotNull property="cMsg.invAvgGrpNum">
                 AND EXISTS(
                    SELECT
                       'X'
                    FROM
                       SVC_INV SI
                    WHERE
                       SI.GLBL_CMPY_CD         = IPC.GLBL_CMPY_CD
                    AND SI.SVC_INV_NUM          = IPC.INV_NUM
                    AND SI.DS_CONTR_CATG_CD     = 'AGG'
                    AND SI.DS_CONTR_NUM   LIKE #cMsg.invAvgGrpNum#
                    AND SI.EZCANCELFLAG         = '0'
                 )
                 </isNotNull>

                 <isNotNull property="cMsg.cpoOrdNum">
                 AND EXISTS(
                    SELECT
                       'X'
                    FROM
                       INV_PRT_SLS_PART_SUB_TOT IPSPST
                    WHERE
                       IPSPST.GLBL_CMPY_CD     = IPC.GLBL_CMPY_CD
                    AND IPSPST.INV_NUM          = IPC.INV_NUM
                    <!-- 2017/07/06 S21_NA#18633 Mod Start -->
                    <!-- AND IPSPST.CPO_ORD_NUM      = #cMsg.cpoOrdNum# -->
                    AND IPSPST.CPO_ORD_NUM      LIKE #cMsg.cpoOrdNum#
                    <!-- 2017/07/06 S21_NA#18633 Mod End -->
                    AND IPSPST.EZCANCELFLAG     = '0'
                 )
                 </isNotNull>

                 <isNotNull property="cMsg.xxSerNumSrchTxt">
                 AND EXISTS(
                    SELECT
                       <!-- 2018/10/23 Add Start QC#28422 -->
                       /*+ LEADING(IPC DILS)
                           USE_NL(DILS) */
                       <!-- 2018/10/23 Add End QC#28422 -->
                       'X'
                    FROM
                       DS_INV_LINE_SER_NUM DILS
                    WHERE
                       DILS.GLBL_CMPY_CD     = IPC.GLBL_CMPY_CD
                    AND DILS.INV_NUM         = IPC.INV_NUM
                    AND (DILS.SER_NUM          like #convertSerNum#
                    OR  DILS.SER_NUM          like #convertSerNumTxt#)
                    AND DILS.EZCANCELFLAG     = '0'
                    <!-- 2018/10/23 Mod Start QC#28422 -->
                    <!-- UNION -->
                    UNION ALL
                    <!-- 2018/10/23 Mod End QC#28422 -->
                    SELECT
                       <!-- 2018/10/23 Add Start QC#28422 -->
                       /*+ LEADING(IPC IPSPST)
                           USE_NL(IPSPST) */
                       <!-- 2018/10/23 Add End QC#28422 -->
                       'X'
                    FROM
                       INV_PRT_SLS_PART_SUB_TOT IPSPST
                    WHERE
                       IPSPST.GLBL_CMPY_CD     = IPC.GLBL_CMPY_CD
                    AND IPSPST.INV_NUM          = IPC.INV_NUM
                    AND (
                    ( IPC.CONSL_BILL_NUM    IS NULL
                    AND IPSPST.CONSL_BILL_NUM IS NULL
                    )
                    OR
                    ( IPC.CONSL_BILL_NUM    IS NOT NULL
                    AND IPSPST.CONSL_BILL_NUM  = IPC.CONSL_BILL_NUM
                    )
                    )
                    AND (IPSPST.SER_NUM          like #convertSerNum#
                    OR  IPSPST.SER_NUM          like #convertSerNumTxt#)
                    AND IPSPST.EZCANCELFLAG     = '0'
                    <!-- 2018/10/23 Mod Start QC#28422 -->
                    <!-- UNION -->
                    UNION ALL
                    <!-- 2018/10/23 Mod End QC#28422 -->
                    SELECT
                       <!-- 2018/10/23 Add Start QC#28422 -->
                       /*+ LEADING(IPC IPHW IPFS IPFLW IPFMW)
                           USE_NL(IPHW)
                           USE_NL(IPFS)
                           USE_NL(ICFLW)
                           USE_NL(ICFMW) */
                       <!-- 2018/10/23 Add End QC#28422 -->
                       'X'
                    FROM
                       INV_PRT_HDR IPHW
                      ,INV_PRT_FLEET_MACH IPFMW
                      ,INV_PRT_FLEET_LOC  IPFLW
                      ,INV_PRT_FLEET_SUB_TOT IPFS
                    WHERE
                       IPHW.GLBL_CMPY_CD        = IPC.GLBL_CMPY_CD
                    <!-- 2018/10/23 Mod Start QC#28422 -->
                    <!--
                    AND (
                       (   IPC.CONSL_BILL_NUM IS NULL
                        AND IPHW.INV_BILL_NUM   = IPC.INV_NUM
                        )
                        OR
                        (   IPC.CONSL_BILL_NUM IS NOT NULL
                        AND IPHW.INV_BILL_NUM   = IPC.CONSL_BILL_NUM
                        )
                        )
                    -->
                    AND IPHW.INV_BILL_NUM   = NVL(IPC.CONSL_BILL_NUM,IPC.INV_NUM)
                    <!-- 2018/10/23 Mod End QC#28422 -->
                    AND IPHW.EZCANCELFLAG    = '0'
                    AND IPFS.GLBL_CMPY_CD         = IPC.GLBL_CMPY_CD
                    AND IPFS.INV_NUM              = IPC.INV_NUM
                    AND (
                       ( IPC.CONSL_BILL_NUM    IS NULL
                        AND IPFS.CONSL_BILL_NUM IS NULL
                        )
                        OR
                        ( IPC.CONSL_BILL_NUM    IS NOT NULL
                        AND IPFS.CONSL_BILL_NUM  = IPC.CONSL_BILL_NUM
                        )
                        )
                    AND IPFS.EZCANCELFLAG         = '0'
                    AND IPFLW.GLBL_CMPY_CD        = IPFS.GLBL_CMPY_CD
                    AND IPFLW.INV_PRT_FLEET_SUB_TOT_PK = IPFS.INV_PRT_FLEET_SUB_TOT_PK
                    AND IPFLW.EZCANCELFLAG      = '0'
                    AND IPFMW.GLBL_CMPY_CD        = IPFLW.GLBL_CMPY_CD
                    AND IPFMW.INV_PRT_FLEET_LOC_PK = IPFLW.INV_PRT_FLEET_LOC_PK
                    AND IPFMW.EZCANCELFLAG      = '0'
                    AND (
                       IPFMW.INV_PRT_SER_NUM_TXT LIKE #convertSerNum#
                       OR
                       IPFMW.INV_PRT_SER_NUM_TXT LIKE #convertSerNumTxt#
                    )
                    <!-- 2018/10/23 Mod Start QC#28422 -->
                    <!-- UNION -->
                    UNION ALL
                    <!-- 2018/10/23 Mod End QC#28422 -->
                    SELECT
                       <!-- 2018/10/23 Add Start QC#28422 -->
                       /*+ LEADING(IPC IPHW IPMS IPSMW)
                           USE_NL(IPHW)
                           USE_NL(IPMS)
                           USE_NL(ICSMW) */
                       <!-- 2018/10/23 Add End QC#28422 -->
                       'X'
                    FROM
                       INV_PRT_HDR IPHW
                      ,INV_PRT_MAINT_MACH ICSMW
                      ,INV_PRT_MAINT_SUB_TOT IPMS
                    WHERE
                       IPHW.GLBL_CMPY_CD        = IPC.GLBL_CMPY_CD
                    <!-- 2018/10/23 Mod Start QC#28422 -->
                    <!--
                    AND (
                       (   IPC.CONSL_BILL_NUM IS NULL
                       AND IPHW.INV_BILL_NUM   = IPC.INV_NUM
                       )
                       OR
                       (   IPC.CONSL_BILL_NUM IS NOT NULL
                       AND IPHW.INV_BILL_NUM   = IPC.CONSL_BILL_NUM
                       )
                       )
                    -->
                    AND IPHW.INV_BILL_NUM   = NVL(IPC.CONSL_BILL_NUM,IPC.INV_NUM)
                    <!-- 2018/10/23 Mod End QC#28422 -->
                    AND IPHW.EZCANCELFLAG    = '0'
                    AND IPMS.GLBL_CMPY_CD         = IPC.GLBL_CMPY_CD
                    AND IPMS.INV_NUM              = IPC.INV_NUM
                    AND (
                       ( IPC.CONSL_BILL_NUM    IS NULL
                       AND IPMS.CONSL_BILL_NUM IS NULL
                       )
                       OR
                       ( IPC.CONSL_BILL_NUM    IS NOT NULL
                       AND IPMS.CONSL_BILL_NUM  = IPC.CONSL_BILL_NUM
                       )
                       )
                    AND IPMS.EZCANCELFLAG         = '0'
                    AND ICSMW.GLBL_CMPY_CD        = IPMS.GLBL_CMPY_CD
                    AND ICSMW.INV_PRT_MAINT_SUB_TOT_PK = IPMS.INV_PRT_MAINT_SUB_TOT_PK
                    AND ICSMW.EZCANCELFLAG      = '0'
                    AND (
                       ICSMW.INV_PRT_SER_NUM_TXT LIKE #convertSerNum#
                       OR
                       ICSMW.INV_PRT_SER_NUM_TXT LIKE #convertSerNumTxt#
                     )
                 )
                 </isNotNull>
             ORDER BY
                 IPC.CONSL_BILL_INV_DT
                ,IPC.CONSL_BILL_NUM
                ,IPC.INV_NUM NULLS FIRST
            )
        WHERE
            ROWNUM &lt; #rowNum#
    </isNotNull>

    <isNull property="cMsg.conslBillNum">
        <isNotNull property="CANON_E479_INV_SRCH_TBL">
        , CEIST_LIST AS (
                 SELECT DISTINCT URN_NUMBER, BILL_NUMBER, INVOICE_PATH, INVOICE_FILE_NAME FROM (
                          SELECT DISTINCT SRCH.URN_NUMBER, SRCH.INVOICE_FILE_NAME, SRCH.INVOICE_PATH,
                          CEED.BILL_NUMBER, CEED.INVOICE_NUMBER, CEEC.BILL_DATE
                          FROM CANON_E479_EXCEL_DETAIL CEED, CANON_E479_EXCEL_CONTROL CEEC, CANON_E479_INV_SRCH_TBL SRCH
                          WHERE CEED.REF_ID = CEEC.REF_ID AND CEED.SEQUENCE_ID = CEEC.SEQUENCE_ID 
                          AND CEED.RECTYPE = 'DETAIL' AND TO_CHAR(CEEC.URN) = SRCH.URN_NUMBER)
        )
        </isNotNull>
        , INV_BILL_LIST AS (
                 SELECT
         <isNull property="cMsg.custIssPoNum">
         <isNull property="cMsg.xxUrnNum">
                <isNotNull property="CANON_E479_INV_SRCH_TBL">
                        /*+ LEADING(IPC IPH I CEIST IPC_BILL)
                            USE_NL(IPH)
                            USE_NL(I)
                            USE_NL(CEIST)
                            USE_NL(IPC_BILL)
                            NO_EXPAND                         */
                </isNotNull>
                <isNull property="CANON_E479_INV_SRCH_TBL">
                        /*+ LEADING(IPC IPH I IPC_BILL)
                            USE_NL(IPH)
                            USE_NL(I)
                            USE_NL(IPC_BILL)
                            NO_EXPAND                         */
                </isNull>
         </isNull>
         </isNull>
                    IPC.CONSL_BILL_NUM      AS CONSL_BILL_NUM
                    ,IPC.INV_NUM             AS INV_NUM
                 FROM
                     IPC
                    ,INV_PRT_HDR             IPH
                     <isNotNull property="CANON_E479_INV_SRCH_TBL">
                    ,CEIST_LIST  CEIST
                     </isNotNull>
                    ,INV                     I
                    ,INV_PRT_CTRL            IPC_BILL
                 WHERE
                     <!-- ### INV_PRT_CTRL Table ### -->
                     IPC.GLBL_CMPY_CD     = #glblCmpyCd#
                     AND IPC.EZCANCELFLAG = '0'
                     AND IPC.GLBL_CMPY_CD = IPH.GLBL_CMPY_CD
                     AND IPC.INV_PRT_CTRL_PK = IPH.INV_PRT_CTRL_PK
                     AND IPH.EZCANCELFLAG = '0'
                     AND IPH.GLBL_CMPY_CD = I.GLBL_CMPY_CD (+)
                     AND IPH.INV_BILL_NUM = I.INV_NUM (+)
                     AND I.EZCANCELFLAG (+) = '0'
                     AND IPC.CONSL_BILL_NUM = IPC_BILL.CONSL_BILL_NUM (+)
                     AND IPC.GLBL_CMPY_CD = IPC_BILL.GLBL_CMPY_CD (+)
                     AND IPC_BILL.EZCANCELFLAG (+) = '0'
                     AND IPC_BILL.INV_PRT_CTRL_REC_CD (+) = 'BILL'
                     AND (IPH.ESPAC_FLG = 'N' OR IPH.ESPAC_FLG = 'Y' AND IPC.INV_PRT_CTRL_REC_CD = 'BILL')
                     <isNotNull property="cMsg.invNum">
                         AND IPC.INV_NUM LIKE #cMsg.invNum#
                     </isNotNull>
                     <isNotNull property="cMsg.conslBillNum">
                         AND IPC.CONSL_BILL_NUM LIKE #cMsg.conslBillNum#
                     </isNotNull>
                     <isNotNull property="cMsg.billToDsAcctNum">
                         AND IPC.BILL_TO_DS_ACCT_NUM LIKE #cMsg.billToDsAcctNum#
                     </isNotNull>
                     <isNotNull property="cMsg.billToDsAcctNm">
                         AND IPC.BILL_TO_DS_ACCT_NM LIKE #cMsg.billToDsAcctNm#
                     </isNotNull>
                     <isNotNull property="cMsg.billToLocNum">
                         AND IPC.BILL_TO_LOC_NUM LIKE #cMsg.billToLocNum#
                     </isNotNull>
                     <isNotNull property="cMsg.invPrtBatTpCd">
                         AND IPC.INV_PRT_BAT_TP_CD = #cMsg.invPrtBatTpCd#
                     </isNotNull>
                     <isNotNull property="cMsg.invPrtBrCd">
                         AND IPC.INV_PRT_BR_CD = #cMsg.invPrtBrCd#
                     </isNotNull>
                     <isNotNull property="cMsg.invProcTpCd">
                         AND IPC.INV_PROC_TP_CD = #cMsg.invProcTpCd#
                     </isNotNull>
                     <isNotNull property="cMsg.conslBillInvDt_FR">
                         AND CASE WHEN IPC.CONSL_BILL_NUM IS NOT NULL THEN IPC.CONSL_BILL_INV_DT ELSE IPH.INV_DT END &gt;= #cMsg.conslBillInvDt_FR#
                     </isNotNull>
                     <isNotNull property="cMsg.conslBillInvDt_TO">
                         AND CASE WHEN IPC.CONSL_BILL_NUM IS NOT NULL THEN IPC.CONSL_BILL_INV_DT ELSE IPH.INV_DT END &lt;= #cMsg.conslBillInvDt_TO#
                     </isNotNull>
                     <isNotNull property="cMsg.xxCratDt_FR">
                         AND IPC.INV_CRAT_TS &gt;= #cMsg.xxCratDt_FR# || '000000'
                     </isNotNull>
                     <isNotNull property="cMsg.xxCratDt_TO">
                         AND IPC.INV_CRAT_TS &lt;= #cMsg.xxCratDt_TO# || '235959'
                     </isNotNull>
                     <!--  START 2018/05/28 Y.Matsui [QC#26342,ADD] -->
                     <isNotNull property="cMsg.custIssPoNum">
                     <!-- 2019/04/03 QC#30756 Mod Start -->
                         <!-- AND I.CUST_ISS_PO_NUM LIKE #cMsg.custIssPoNum# -->
                         AND UPPER(I.CUST_ISS_PO_NUM) LIKE #cMsg.custIssPoNum#
                     <!-- 2019/04/03 QC#30756 Mod End -->
                     </isNotNull>
                     <!--  END   2018/05/28 Y.Matsui [QC#26342,ADD] -->
                     <isNotNull property="CANON_E479_INV_SRCH_TBL">
                     AND IPC.CONSL_BILL_NUM = CEIST.BILL_NUMBER (+)
                     <isNotNull property="cMsg.xxUrnNum">
                     AND CEIST.URN_NUMBER LIKE #cMsg.xxUrnNum#
                     </isNotNull>
                     </isNotNull>
                     <isEqual property="isExistSmryWrk" compareValue="Y">
                     AND EXISTS (
                        SELECT
                           'X'
                        FROM
                           INV_PRT_SMRY IPSW
                        WHERE
                           IPSW.GLBL_CMPY_CD        = IPC.GLBL_CMPY_CD
                        AND (IPSW.INV_BILL_NUM   = IPC.INV_NUM
                        OR
                        IPSW.INV_BILL_NUM   = IPC.CONSL_BILL_NUM)
                        AND IPSW.EZCANCELFLAG    = '0'
                        <isNotNull property="cMsg.ordClsCd">
                        AND EXISTS (
                           SELECT
                              'X'
                           FROM
                              ORD_CLS OC
                           WHERE
                              OC.GLBL_CMPY_CD     = #glblCmpyCd#
                           AND OC.ORD_CLS_CD   = #cMsg.ordClsCd#
                           AND OC.EZCANCELFLAG = '0'
                           AND OC.GLBL_CMPY_CD   = IPSW.GLBL_CMPY_CD
                           AND OC.ORD_CLS_NM     = IPSW.ORD_CLS_NM
                           AND IPSW.EZCANCELFLAG = '0'
                        )
                        </isNotNull>
                        <isNotNull property="cMsg.invSmryLineTpCd">
                        AND EXISTS (
                           SELECT
                              'X'
                           FROM
                              INV_SMRY_LINE_TP ISLT
                           WHERE
                              ISLT.GLBL_CMPY_CD            = #glblCmpyCd#
                           AND ISLT.INV_SMRY_LINE_TP_CD = #cMsg.invSmryLineTpCd#
                           AND ISLT.EZCANCELFLAG        = '0'
                           AND ISLT.GLBL_CMPY_CD        = IPSW.GLBL_CMPY_CD
                           AND ISLT.INV_SMRY_LINE_TP_NM = IPSW.INV_SMRY_LINE_TP_NM
                           AND IPSW.EZCANCELFLAG        = '0'
                           <!-- UNION -->
                           UNION ALL
                           SELECT
                               'X'
                           FROM
                               DUAL
                           WHERE
                               IPSW.INV_SMRY_FRT_AMT_TXT IS NOT NULL 
                           AND IPSW.INV_SMRY_FRT_AMT_TXT != #zeroDollar#
                           AND #freight# = #cMsg.invSmryLineTpCd#
                        )
                        </isNotNull>
                     )
                     </isEqual>

                     <isNotNull property="cMsg.dsContrNum">
                     <!-- 2021/03/11 Mod Start QC#57920 -->
                     AND (
                        EXISTS(
                            SELECT
                                'X'
                            FROM
                                SVC_INV SI
                            WHERE
                                SI.GLBL_CMPY_CD         = IPC.GLBL_CMPY_CD
                            AND SI.SVC_INV_NUM         = IPC.INV_NUM
                            AND SI.DS_CONTR_NUM   LIKE #cMsg.dsContrNum#
                            AND SI.EZCANCELFLAG        = '0'
                        ) OR 
                        EXISTS(
                            SELECT
                                'X'
                            FROM
                                INV_LINE IL
                            WHERE
                                IL.GLBL_CMPY_CD    = IPC.GLBL_CMPY_CD
                            AND IL.INV_NUM         = IPC.INV_NUM
                            AND IL.DS_CONTR_NUM   LIKE #cMsg.dsContrNum#
                            AND IL.EZCANCELFLAG    = '0'
                        )
                     )
                     <!-- 2021/03/11 Mod End QC#57920 -->
                     </isNotNull>

                     <isNotNull property="cMsg.invAvgGrpNum">
                     AND EXISTS(
                        SELECT
                           'X'
                        FROM
                           SVC_INV SI
                        WHERE
                           SI.GLBL_CMPY_CD         = IPC.GLBL_CMPY_CD
                        AND SI.SVC_INV_NUM          = IPC.INV_NUM
                        AND SI.DS_CONTR_CATG_CD     = 'AGG'
                        AND SI.DS_CONTR_NUM   LIKE #cMsg.invAvgGrpNum#
                        AND SI.EZCANCELFLAG         = '0'
                     )
                     </isNotNull>

                     <isNotNull property="cMsg.cpoOrdNum">
                     AND EXISTS(
                        SELECT
                           'X'
                        FROM
                           INV_PRT_SLS_PART_SUB_TOT IPSPST
                        WHERE
                           IPSPST.GLBL_CMPY_CD     = IPC.GLBL_CMPY_CD
                        AND IPSPST.INV_NUM          = IPC.INV_NUM
                        <!-- 2017/07/06 S21_NA#18633 Mod Start -->
                        <!-- AND IPSPST.CPO_ORD_NUM      = #cMsg.cpoOrdNum# -->
                        AND IPSPST.CPO_ORD_NUM      LIKE #cMsg.cpoOrdNum#
                        <!-- 2017/07/06 S21_NA#18633 Mod End -->
                        AND IPSPST.EZCANCELFLAG     = '0'
                     )
                     </isNotNull>

                     <isNotNull property="cMsg.xxSerNumSrchTxt">
                     AND EXISTS(
                        SELECT
                           /*+ LEADING(IPC DILS)
                               USE_NL(DILS) */
                           'X'
                        FROM
                           DS_INV_LINE_SER_NUM DILS
                        WHERE
                           DILS.GLBL_CMPY_CD     = IPC.GLBL_CMPY_CD
                        AND DILS.INV_NUM         = IPC.INV_NUM
                        AND (DILS.SER_NUM          like #convertSerNum#
                        OR  DILS.SER_NUM          like #convertSerNumTxt#)
                        AND DILS.EZCANCELFLAG     = '0'
                        UNION ALL
                        SELECT
                           /*+ LEADING(IPC IPSPST)
                               USE_NL(IPSPST) */
                           'X'
                        FROM
                           INV_PRT_SLS_PART_SUB_TOT IPSPST
                        WHERE
                           IPSPST.GLBL_CMPY_CD     = IPC.GLBL_CMPY_CD
                        AND IPSPST.INV_NUM          = IPC.INV_NUM
                        AND (
                        ( IPC.CONSL_BILL_NUM    IS NULL
                        AND IPSPST.CONSL_BILL_NUM IS NULL
                        )
                        OR
                        ( IPC.CONSL_BILL_NUM    IS NOT NULL
                        AND IPSPST.CONSL_BILL_NUM  = IPC.CONSL_BILL_NUM
                        )
                        )
                        AND (IPSPST.SER_NUM          like #convertSerNum#
                        OR  IPSPST.SER_NUM          like #convertSerNumTxt#)
                        AND IPSPST.EZCANCELFLAG     = '0'
                        UNION ALL
                        SELECT
                           /*+ LEADING(IPC IPHW IPFS IPFLW IPFMW)
                               USE_NL(IPHW)
                               USE_NL(IPFS)
                               USE_NL(ICFLW)
                               USE_NL(ICFMW) */
                           'X'
                        FROM
                           INV_PRT_HDR IPHW
                          ,INV_PRT_FLEET_MACH IPFMW
                          ,INV_PRT_FLEET_LOC  IPFLW
                          ,INV_PRT_FLEET_SUB_TOT IPFS
                        WHERE
                           IPHW.GLBL_CMPY_CD        = IPC.GLBL_CMPY_CD
                        AND IPHW.INV_BILL_NUM   = NVL(IPC.CONSL_BILL_NUM,IPC.INV_NUM)
                        AND IPHW.EZCANCELFLAG    = '0'
                        AND IPFS.GLBL_CMPY_CD         = IPC.GLBL_CMPY_CD
                        AND IPFS.INV_NUM              = IPC.INV_NUM
                        AND (
                           ( IPC.CONSL_BILL_NUM    IS NULL
                            AND IPFS.CONSL_BILL_NUM IS NULL
                            )
                            OR
                            ( IPC.CONSL_BILL_NUM    IS NOT NULL
                            AND IPFS.CONSL_BILL_NUM  = IPC.CONSL_BILL_NUM
                            )
                            )
                        AND IPFS.EZCANCELFLAG         = '0'
                        AND IPFLW.GLBL_CMPY_CD        = IPFS.GLBL_CMPY_CD
                        AND IPFLW.INV_PRT_FLEET_SUB_TOT_PK = IPFS.INV_PRT_FLEET_SUB_TOT_PK
                        AND IPFLW.EZCANCELFLAG      = '0'
                        AND IPFMW.GLBL_CMPY_CD        = IPFLW.GLBL_CMPY_CD
                        AND IPFMW.INV_PRT_FLEET_LOC_PK = IPFLW.INV_PRT_FLEET_LOC_PK
                        AND IPFMW.EZCANCELFLAG      = '0'
                        AND (
                           IPFMW.INV_PRT_SER_NUM_TXT LIKE #convertSerNum#
                           OR
                           IPFMW.INV_PRT_SER_NUM_TXT LIKE #convertSerNumTxt#
                        )
                        UNION ALL
                        SELECT
                           /*+ LEADING(IPC IPHW IPMS IPSMW)
                               USE_NL(IPHW)
                               USE_NL(IPMS)
                               USE_NL(ICSMW) */
                           'X'
                        FROM
                           INV_PRT_HDR IPHW
                          ,INV_PRT_MAINT_MACH ICSMW
                          ,INV_PRT_MAINT_SUB_TOT IPMS
                        WHERE
                           IPHW.GLBL_CMPY_CD        = IPC.GLBL_CMPY_CD
                        AND IPHW.INV_BILL_NUM   = NVL(IPC.CONSL_BILL_NUM,IPC.INV_NUM)
                        <!-- 2018/10/23 Mod End QC#28422 -->
                        AND IPHW.EZCANCELFLAG    = '0'
                        AND IPMS.GLBL_CMPY_CD         = IPC.GLBL_CMPY_CD
                        AND IPMS.INV_NUM              = IPC.INV_NUM
                        AND (
                           ( IPC.CONSL_BILL_NUM    IS NULL
                           AND IPMS.CONSL_BILL_NUM IS NULL
                           )
                           OR
                           ( IPC.CONSL_BILL_NUM    IS NOT NULL
                           AND IPMS.CONSL_BILL_NUM  = IPC.CONSL_BILL_NUM
                           )
                           )
                        AND IPMS.EZCANCELFLAG         = '0'
                        AND ICSMW.GLBL_CMPY_CD        = IPMS.GLBL_CMPY_CD
                        AND ICSMW.INV_PRT_MAINT_SUB_TOT_PK = IPMS.INV_PRT_MAINT_SUB_TOT_PK
                        AND ICSMW.EZCANCELFLAG      = '0'
                        AND (
                           ICSMW.INV_PRT_SER_NUM_TXT LIKE #convertSerNum#
                           OR
                           ICSMW.INV_PRT_SER_NUM_TXT LIKE #convertSerNumTxt#
                         )
                     )
                     </isNotNull>
          )
          , INV_BILL_KEY_LIST AS ( 
            SELECT
                CONSL_BILL_NUM
               ,INV_NUM
            FROM
              ( 
                SELECT
                    TO_CHAR(CBL.CONSL_BILL_PK) CONSL_BILL_NUM
                   ,CASE WHEN (CBL.CONSL_BILL_PK IS NULL) OR EXISTS ( SELECT 1 FROM INV_BILL_LIST IBL2 WHERE IBL2.CONSL_BILL_NUM = TO_CHAR(CBL.CONSL_BILL_PK) ) THEN 
                        IBL.INV_NUM 
                    ELSE
                        NULL 
                    END INV_NUM 
                FROM
                    INV_BILL_LIST IBL
                   ,CONSL_BILL_LINE CBL 
                WHERE
                    IBL.INV_NUM = CBL.CONSL_BILL_TRX_NUM(+) 
                    AND CBL.GLBL_CMPY_CD(+) = #glblCmpyCd# 
                    AND CBL.EZCANCELFLAG(+) = '0' 
                UNION ALL 
                SELECT
                    IBL.CONSL_BILL_NUM
                   ,NULL INV_NUM 
                FROM
                    INV_BILL_LIST IBL 
                WHERE
                    IBL.CONSL_BILL_NUM IS NOT NULL
              ) 
            GROUP BY
                CONSL_BILL_NUM
               ,INV_NUM
          ) 
          
            SELECT
                *
            FROM
                (
                SELECT
                     NVL2(IPC2.CONSL_BILL_NUM, TO_NUMBER(IPC2.CONSL_BILL_NUM), NULL) AS SORT_CONSL_BILL_NUM
                    ,IPC2.INV_PROC_TP_CD      AS INV_PROC_TP_CD
                     <isNotNull property="CANON_E479_INV_SRCH_TBL">
                    ,CEIST.URN_NUMBER        AS URN_NUMBER
                     </isNotNull>
                     <isNull property="CANON_E479_INV_SRCH_TBL">
                    ,NULL        AS URN_NUMBER
                     </isNull>
                    ,IPC2.CONSL_BILL_NUM      AS CONSL_BILL_NUM
                    ,IPC2.INV_NUM             AS INV_NUM
                    ,IPC2.BILL_TO_DS_ACCT_NUM AS BILL_TO_DS_ACCT_NUM
                    ,IPC2.BILL_TO_DS_ACCT_NM  AS BILL_TO_DS_ACCT_NM
                    ,IPH.INV_DT              AS CONSL_BILL_INV_DT
                    ,CASE WHEN I.INV_TP_CD = '2' THEN (IPH.INV_TOT_AMT * -1) ELSE IPH.INV_TOT_AMT END AS CONSL_BILL_TOT_AMT
                    ,IPC2.INV_EML_ADDR        AS INV_EML_ADDR
                    ,IPC2.INV_FILE_URL        AS INV_FILE_URL
                    ,IPC2.INV_PRT_CTRL_REC_CD AS INV_PRT_CTRL_REC_CD
                    ,(CASE 
                         WHEN IPC2.INV_CRAT_TS IS NOT NULL 
                         THEN TO_CHAR(TO_TIMESTAMP(IPC2.INV_CRAT_TS,'YYYYMMDDHH24MISSFF'), #dateFormat#)
                         ELSE NULL
                      END) AS INV_CRAT_TS
                     <isNotNull property="CANON_E479_INV_SRCH_TBL">
                    ,CEIST.INVOICE_PATH URN_FILE
                     </isNotNull>
                     <isNull property="CANON_E479_INV_SRCH_TBL">
                    ,NULL URN_FILE
                     </isNull>
                     <isNotNull property="CANON_E479_INV_SRCH_TBL">
                    ,CEIST.INVOICE_FILE_NAME INVOICE_FILE_NAME
                     </isNotNull>
                     <isNull property="CANON_E479_INV_SRCH_TBL">
                    ,NULL INVOICE_FILE_NAME
                     </isNull>
                    ,IPC2.INV_PRT_CTRL_PK     AS INV_PRT_CTRL_PK
                    ,(CASE
                        WHEN IPC2.INV_FILE_URL IS NULL
                        THEN NVL(IPC2.INV_FTP_RQST_NUM, IPC2.INV_PRINT_RQST_NUM)
                        ELSE NULL
                     END) AS EIP_RPT_RQST_PK
                    ,(CASE
                        WHEN IPC_BILL.INV_FILE_URL IS NULL
                        THEN NVL(IPC_BILL.INV_FTP_RQST_NUM, IPC_BILL.INV_PRINT_RQST_NUM)
                        ELSE NULL
                      END)  AS BILL_EIP_RPT_RQST_PK
                    ,I.CUST_ISS_PO_NUM
                    ,IPC2.ORIG_CONSL_BILL_NUM
                FROM
                     ( 
                       SELECT
                           IPC_IN.* 
                       FROM
                         INV_PRT_CTRL IPC_IN
                         , INV_BILL_KEY_LIST IBKL 
                       WHERE
                         IPC_IN.INV_NUM = IBKL.INV_NUM 
                         AND IPC_IN.EZCANCELFLAG = '0' 
                         AND IPC_IN.GLBL_CMPY_CD = #glblCmpyCd#
                         AND IBKL.INV_NUM IS NOT NULL
                         <isEqual property="cMsg.xxChkBox_SB" compareValue="Y">
                             AND IPC_IN.INV_PRT_CTRL_REC_CD = #consoliBill#
                         </isEqual>
                     ) IPC2
                    ,INV_PRT_HDR             IPH
                    <isNotNull property="CANON_E479_INV_SRCH_TBL">
                    ,CEIST_LIST  CEIST
                    </isNotNull>
                    ,INV                     I
                    ,INV_PRT_CTRL            IPC_BILL
                   
                WHERE
                     IPC2.GLBL_CMPY_CD     = #glblCmpyCd#
                     AND IPC2.EZCANCELFLAG = '0'
                     AND IPC2.GLBL_CMPY_CD = IPH.GLBL_CMPY_CD
                     AND IPC2.INV_PRT_CTRL_PK = IPH.INV_PRT_CTRL_PK
                     AND IPH.EZCANCELFLAG = '0'
                     AND IPH.GLBL_CMPY_CD = I.GLBL_CMPY_CD (+)
                     AND IPH.INV_BILL_NUM = I.INV_NUM (+)
                     AND I.EZCANCELFLAG (+) = '0'
                     AND IPC2.CONSL_BILL_NUM = IPC_BILL.CONSL_BILL_NUM (+)
                     AND IPC2.GLBL_CMPY_CD = IPC_BILL.GLBL_CMPY_CD (+)
                     AND IPC_BILL.EZCANCELFLAG (+) = '0'
                     AND IPC_BILL.INV_PRT_CTRL_REC_CD (+) = 'BILL'
                     AND (IPH.ESPAC_FLG = 'N' OR IPH.ESPAC_FLG = 'Y' AND IPC2.INV_PRT_CTRL_REC_CD = 'BILL')
                     <isEqual property="cMsg.xxChkBox_SP" compareValue="Y"> <!-- QC#53014 2019/09/17 Add -->
                         AND (IPH.EXCL_BILL_TXT = #ExclBillTxtNo# OR IPH.EXCL_BILL_TXT IS NULL)
                     </isEqual>
                UNION ALL
                SELECT
                     NVL2(IPC2.CONSL_BILL_NUM, TO_NUMBER(IPC2.CONSL_BILL_NUM), NULL) AS SORT_CONSL_BILL_NUM
                    ,IPC2.INV_PROC_TP_CD      AS INV_PROC_TP_CD
                     <isNotNull property="CANON_E479_INV_SRCH_TBL">
                    ,CEIST.URN_NUMBER        AS URN_NUMBER
                     </isNotNull>
                     <isNull property="CANON_E479_INV_SRCH_TBL">
                    ,NULL        AS URN_NUMBER
                     </isNull>
                    ,IPC2.CONSL_BILL_NUM      AS CONSL_BILL_NUM
                    ,IPC2.INV_NUM             AS INV_NUM
                    ,IPC2.BILL_TO_DS_ACCT_NUM AS BILL_TO_DS_ACCT_NUM
                    ,IPC2.BILL_TO_DS_ACCT_NM  AS BILL_TO_DS_ACCT_NM
                    ,IPH.INV_DT              AS CONSL_BILL_INV_DT
                    ,CASE WHEN I.INV_TP_CD = '2' THEN (IPH.INV_TOT_AMT * -1) ELSE IPH.INV_TOT_AMT END AS CONSL_BILL_TOT_AMT
                    ,IPC2.INV_EML_ADDR        AS INV_EML_ADDR
                    ,IPC2.INV_FILE_URL        AS INV_FILE_URL
                    ,IPC2.INV_PRT_CTRL_REC_CD AS INV_PRT_CTRL_REC_CD
                    ,(CASE 
                         WHEN IPC2.INV_CRAT_TS IS NOT NULL 
                         THEN TO_CHAR(TO_TIMESTAMP(IPC2.INV_CRAT_TS,'YYYYMMDDHH24MISSFF'), #dateFormat#)
                         ELSE NULL
                      END) AS INV_CRAT_TS
                     <isNotNull property="CANON_E479_INV_SRCH_TBL">
                    ,CEIST.INVOICE_PATH URN_FILE
                     </isNotNull>
                     <isNull property="CANON_E479_INV_SRCH_TBL">
                    ,NULL URN_FILE
                     </isNull>
                     <isNotNull property="CANON_E479_INV_SRCH_TBL">
                    ,CEIST.INVOICE_FILE_NAME INVOICE_FILE_NAME
                     </isNotNull>
                     <isNull property="CANON_E479_INV_SRCH_TBL">
                    ,NULL INVOICE_FILE_NAME
                     </isNull>
                    ,IPC2.INV_PRT_CTRL_PK     AS INV_PRT_CTRL_PK
                    ,(CASE
                        WHEN IPC2.INV_FILE_URL IS NULL
                        THEN NVL(IPC2.INV_FTP_RQST_NUM, IPC2.INV_PRINT_RQST_NUM)
                        ELSE NULL
                     END) AS EIP_RPT_RQST_PK
                    ,(CASE
                        WHEN IPC_BILL.INV_FILE_URL IS NULL
                        THEN NVL(IPC_BILL.INV_FTP_RQST_NUM, IPC_BILL.INV_PRINT_RQST_NUM)
                        ELSE NULL
                      END)  AS BILL_EIP_RPT_RQST_PK
                    ,I.CUST_ISS_PO_NUM
                    ,IPC2.ORIG_CONSL_BILL_NUM
                FROM
                     ( 
                       SELECT
                           IPC_IN.* 
                       FROM
                         INV_PRT_CTRL IPC_IN
                         , INV_BILL_KEY_LIST IBKL 
                       WHERE
                         IPC_IN.CONSL_BILL_NUM = IBKL.CONSL_BILL_NUM 
                         AND IBKL.INV_NUM IS NULL 
                         AND IPC_IN.INV_NUM IS NULL 
                         AND IPC_IN.EZCANCELFLAG = '0' 
                         AND IPC_IN.GLBL_CMPY_CD = #glblCmpyCd#
                         <isEqual property="cMsg.xxChkBox_SB" compareValue="Y">
                             AND IPC_IN.INV_PRT_CTRL_REC_CD = #consoliBill#
                         </isEqual>
                     ) IPC2
                    ,INV_PRT_HDR             IPH
                    <isNotNull property="CANON_E479_INV_SRCH_TBL">
                    ,CEIST_LIST  CEIST
                    </isNotNull>
                    ,INV                     I
                    ,INV_PRT_CTRL            IPC_BILL
                WHERE
                     IPC2.GLBL_CMPY_CD     = #glblCmpyCd#
                     AND IPC2.EZCANCELFLAG = '0'
                     AND IPC2.GLBL_CMPY_CD = IPH.GLBL_CMPY_CD
                     AND IPC2.INV_PRT_CTRL_PK = IPH.INV_PRT_CTRL_PK
                     AND IPH.EZCANCELFLAG = '0'
                     AND IPH.GLBL_CMPY_CD = I.GLBL_CMPY_CD (+)
                     AND IPH.INV_BILL_NUM = I.INV_NUM (+)
                     AND I.EZCANCELFLAG (+) = '0'
                     AND IPC2.CONSL_BILL_NUM = IPC_BILL.CONSL_BILL_NUM (+)
                     AND IPC2.GLBL_CMPY_CD = IPC_BILL.GLBL_CMPY_CD (+)
                     AND IPC_BILL.EZCANCELFLAG (+) = '0'
                     AND IPC_BILL.INV_PRT_CTRL_REC_CD (+) = 'BILL'
                     AND (IPH.ESPAC_FLG = 'N' OR IPH.ESPAC_FLG = 'Y' AND IPC2.INV_PRT_CTRL_REC_CD = 'BILL')
                     <isEqual property="cMsg.xxChkBox_SP" compareValue="Y"> <!-- QC#53014 2019/09/17 Add -->
                         AND (IPH.EXCL_BILL_TXT = #ExclBillTxtNo# OR IPH.EXCL_BILL_TXT IS NULL)
                     </isEqual>
                 ORDER BY
                    SORT_CONSL_BILL_NUM  NULLS LAST
                    ,INV_NUM NULLS FIRST
                )
            WHERE
                ROWNUM &lt; #rowNum#
    </isNull>

    <!-- 2019/11/30 Mod End QC#54210 -->
    </statement>

    <typeAlias alias="NWCL0050_ASMsg"  type="business.blap.NWCL0050.NWCL0050_ASMsg"/>

    <resultMap id="result.getInvPrintInfo" class="NWCL0050_ASMsg">
        <result property="invProcTpCd_A"      column="INV_PROC_TP_CD"       javaType="EZDSStringItem"/>
        <result property="xxUrnNum_A"         column="URN_NUMBER"           javaType="EZDSStringItem"/>
        <result property="conslBillNum_A"     column="CONSL_BILL_NUM"       javaType="EZDSStringItem"/>
        <result property="invNum_A"           column="INV_NUM"              javaType="EZDSStringItem"/>
        <result property="billToDsAcctNum_A"  column="BILL_TO_DS_ACCT_NUM"  javaType="EZDSStringItem"/>
        <result property="billToDsAcctNm_A"   column="BILL_TO_DS_ACCT_NM"   javaType="EZDSStringItem"/>
        <result property="conslBillInvDt_A"   column="CONSL_BILL_INV_DT"    javaType="EZDSDateItem"/>
        <result property="conslBillTotAmt_A"  column="CONSL_BILL_TOT_AMT"   javaType="EZDSBigDecimalItem"/>
        <result property="origConslBillNum_A" column="ORIG_CONSL_BILL_NUM"  javaType="EZDSStringItem"/> <!-- QC#53014 2019/09/17 Add -->
        <result property="invEmlAddr_A"       column="INV_EML_ADDR"         javaType="EZDSStringItem"/>
        <result property="invFileUrl_A"       column="INV_FILE_URL"         javaType="EZDSStringItem"/>
        <result property="invPrtCtrlRecCd_A"  column="INV_PRT_CTRL_REC_CD"  javaType="EZDSStringItem"/>
        <result property="xxDtTm_A"           column="INV_CRAT_TS"          javaType="EZDSStringItem"/>
        <result property="invFileUrl_AU"      column="URN_FILE"             javaType="EZDSStringItem"/>
        <result property="invFileUrl_DF"      column="INVOICE_FILE_NAME"    javaType="EZDSStringItem"/>
        <result property="invFileUrl_AB"      column="INV_FILE_URL"         javaType="EZDSStringItem"/>
        <result property="invFileUrl_AI"      column="INV_FILE_URL"         javaType="EZDSStringItem"/>
        <result property="invPrtCtrlPk_A"     column="INV_PRT_CTRL_PK"      javaType="EZDSBigDecimalItem"/>
        <result property="eipRptRqstPk_A"     column="EIP_RPT_RQST_PK"      javaType="EZDSBigDecimalItem"/>
        <result property="eipRptRqstPk_BL"    column="BILL_EIP_RPT_RQST_PK" javaType="EZDSBigDecimalItem"/>
        <!--  START 2018/05/28 Y.Matsui [QC#26342,ADD] -->
        <result property="custIssPoNum_A"     column="CUST_ISS_PO_NUM"      javaType="EZDSStringItem"/>
        <result property="origConslBillNum_A" column="ORIG_CONSL_BILL_NUM"  javaType="EZDSStringItem"/>
        <!--  END   2018/05/28 Y.Matsui [QC#26342,ADD] -->
    </resultMap>

</sqlMap>
