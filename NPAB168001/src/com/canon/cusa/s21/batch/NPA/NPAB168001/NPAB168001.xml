<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NPAB168001">

    <!-- #################### Type Alias #################### -->

    <!-- #################### Statement #################### -->
    <statement id="getPrtRtrnReqSq" parameterClass="Map" resultClass="Map">
       WITH PRT_RTRN_RQST_INFO AS (
           SELECT
               PRR.PRT_RTRN_RQST_SQ
               <!-- START 2016/12/01 K.Kojima [QC#16033,ADD] -->
               ,MAX(PRR.PRCH_REQ_STS_TXT) AS PRCH_REQ_STS_TXT
               <!-- END 2016/12/01 K.Kojima [QC#16033,ADD] -->
               ,MAX(PRR.EZINTIME) AS EZINTIME
           FROM
               CLICK_PRT_RTRN_RQST PRR
           WHERE
               PRR.GLBL_CMPY_CD = #glblCmpyCd#
           <!-- START 2019/09/25 K.Fujimoto [QC#53675,MOD] -->
           <!-- AND PRR.PROC_STS_CD      IN (#inCompleted#, #error#) -->
           AND PRR.PROC_STS_CD       = #inCompleted#
           <!-- END   2019/09/25 K.Fujimoto [QC#53675,MOD] -->
           AND PRR.EZCANCELFLAG = '0'
           GROUP BY
               PRR.PRT_RTRN_RQST_SQ
       )
       <!-- START 2016/12/01 K.Kojima [QC#16033,ADD] -->
       ,DS_COND_CONST_INFO AS (
           SELECT
                DCC.DS_COND_CONST_DESC_TXT
               ,MAX(DCC.DS_COND_CONST_VAL_TXT_01) AS DS_COND_CONST_VAL_TXT_01
           FROM
               DS_COND_CONST DCC
           WHERE
                   DCC.GLBL_CMPY_CD         = #glblCmpyCd#
               AND DCC.DS_COND_CONST_GRP_ID = #NPAB1680_STS#
               AND DCC.EZCANCELFLAG         = '0'
           GROUP BY
               DCC.DS_COND_CONST_DESC_TXT
       )
       <!-- END 2016/12/01 K.Kojima [QC#16033,ADD] -->
       SELECT
           RRI.PRT_RTRN_RQST_SQ
          ,RRI.EZINTIME
       FROM
           PRT_RTRN_RQST_INFO RRI
           <!-- START 2016/12/01 K.Kojima [QC#16033,ADD] -->
           ,DS_COND_CONST_INFO DCCI
       WHERE
           RRI.PRCH_REQ_STS_TXT = DCCI.DS_COND_CONST_DESC_TXT(+)
           <!-- END 2016/12/01 K.Kojima [QC#16033,ADD] -->
       ORDER BY
           <!-- START 2016/12/01 K.Kojima [QC#16033,MOD] -->
            DCCI.DS_COND_CONST_VAL_TXT_01 ASC
           ,RRI.EZINTIME ASC
           <!-- END 2016/12/01 K.Kojima [QC#16033,MOD] -->
    </statement>
    <statement id="getPrtRtrnReq" parameterClass="Map" resultClass="Map">
        <!-- START 2016/12/01 K.Kojima [QC#16033,ADD] -->
        SELECT
             CLICK_PRT_RTRN_RQST_PK
            ,PRT_RTRN_RQST_SQ
            ,PRCH_REQ_NUM
            ,PRCH_REQ_RQST_STS_TXT
            ,PRCH_REQ_STS_TXT
            ,INVTY_LOC_CD
            ,PRCH_REQ_INVTY_TP_TXT
            ,MDSE_CD
            ,PRCH_REQ_QTY
            ,PRCH_REQ_LINE_CMNT_TXT
            ,CLICK_TRK_NUM
            ,CLICK_KEY_TXT
            ,CLICK_KEY_DTL_TXT
            ,PRCH_REQ_DELY_QTY
            ,PRCH_REQ_SHIP_QTY
            <!-- START 2020/08/04 K.Kitachi [QC#57300, MOD] -->
            <!-- ,CASE WHEN PRCH_REQ_STS_TXT = #prchReqStsTxtAwaitingShipment# -->
            <!--       THEN PRCH_REQ_SHORT_QTY -->
                  <!-- START 2017/07/13 K.Kojima [QC#19399,ADD] -->
            <!--       WHEN PRCH_REQ_STS_TXT = #prchReqStsTxtShipped# -->
            <!--       THEN PRCH_REQ_SHORT_QTY -->
                  <!-- END 2017/07/13 K.Kojima [QC#19399,ADD] -->
            <!--       ELSE PRCH_REQ_SHIP_QTY - PRCH_REQ_DELY_QTY END AS PRCH_REQ_SHORT_QTY -->
            ,CASE WHEN RWS_STS_CD = #rwsStsCdReceived#
                  THEN PRCH_REQ_SHIP_QTY - PRCH_REQ_DELY_QTY
                  ELSE 0 END AS PRCH_REQ_SHORT_QTY
            <!-- END 2020/08/04 K.Kitachi [QC#57300, MOD] -->
            ,PRCH_REQ_LINE_NUM
            ,PRCH_REQ_LINE_SUB_NUM
            ,SRC_RTL_WH_CD
            ,RQST_TECH_TOC_CD
            ,RTL_WH_NM
            ,MDSE_DESC_SHORT_TXT
            ,PRCH_REQ_LINE_TP_CD
        FROM
            (
        <!-- END 2016/12/01 K.Kojima [QC#16033,ADD] -->
                SELECT
                     PRR.CLICK_PRT_RTRN_RQST_PK
                    ,PRR.PRT_RTRN_RQST_SQ
                    ,PRR.PRCH_REQ_NUM
                    ,PRR.PRCH_REQ_RQST_STS_TXT
                    ,PRR.PRCH_REQ_STS_TXT
                    ,PRR.INVTY_LOC_CD
                    ,NVL(PRR.PRCH_REQ_INVTY_TP_TXT, DC.DS_COND_CONST_CD) AS PRCH_REQ_INVTY_TP_TXT
                    ,PRR.MDSE_CD
                    ,PRR.PRCH_REQ_QTY
                    ,PRR.PRCH_REQ_LINE_CMNT_TXT
                    ,PRR.CLICK_TRK_NUM
                    ,PRR.CLICK_KEY_TXT
                    ,PRR.CLICK_KEY_DTL_TXT
                    <!-- START 2016/11/29 K.Kojima [QC#16033,MOD] -->
                    ,(
                        SELECT
                            SUM(NVL(PRD.RWS_PUT_AWAY_QTY, 0))
                        FROM
                            PRCH_REQ_DTL PRD
                        WHERE
                                PRD.GLBL_CMPY_CD                = PRR.GLBL_CMPY_CD
                            AND PRD.PRCH_REQ_NUM                = PRR.PRCH_REQ_NUM
                            AND PRD.PRCH_REQ_LINE_NUM           = PRR.PRCH_REQ_LINE_NUM
                            AND PRD.PRCH_REQ_LINE_STS_CD &lt;&gt; #prchReqLineStsCdCancel#
                            AND PRD.EZCANCELFLAG                = '0'
                     ) AS PRCH_REQ_DELY_QTY
                    <!-- END 2016/11/29 K.Kojima [QC#16033,MOD] -->
                    ,NVL(DTL.SHIP_QTY, 0)           AS PRCH_REQ_SHIP_QTY
                    <!-- START 2016/12/01 K.Kojima [QC#16033,MOD] -->
                    ,NVL(PRR.PRCH_REQ_SHORT_QTY, 0) AS PRCH_REQ_SHORT_QTY
                    <!-- END 2016/12/01 K.Kojima [QC#16033,MOD] -->
                    ,PRR.PRCH_REQ_LINE_NUM
                    ,PRR.PRCH_REQ_LINE_SUB_NUM
                    ,PRR.SRC_RTL_WH_CD
                    ,PRR.RQST_TECH_TOC_CD
                    ,RW.RTL_WH_NM
                    ,MD.MDSE_DESC_SHORT_TXT
                    <!-- START 2016/11/29 K.Kojima [QC#16033,MOD] -->
                    ,DTL.PRCH_REQ_LINE_TP_CD
                    <!-- END 2016/11/29 K.Kojima [QC#16033,MOD] -->
                    <!-- START 2016/12/01 K.Kojima [QC#16033,ADD] -->
                    ,PRR.EZINTIME
                    <!-- END 2016/12/01 K.Kojima [QC#16033,ADD] -->
                    <!-- START 2020/08/04 K.Kitachi [QC#57300, ADD] -->
                    ,RD.RWS_STS_CD
                    <!-- END 2020/08/04 K.Kitachi [QC#57300, ADD] -->
                FROM
                     CLICK_PRT_RTRN_RQST PRR
                    ,PRCH_REQ           HDR
                    ,PRCH_REQ_DTL       DTL
                    ,DS_COND_CONST      DC
                    ,RTL_WH             RW
                    ,MDSE               MD
                    <!-- START 2020/08/04 K.Kitachi [QC#57300, ADD] -->
                    ,RWS_DTL            RD
                    <!-- END 2020/08/04 K.Kitachi [QC#57300, ADD] -->
                WHERE
                        PRR.GLBL_CMPY_CD      = #glblCmpyCd#
                    AND PRR.PRT_RTRN_RQST_SQ  = #prtRtrnRqstSq#
                    <!-- START 2019/09/25 K.Fujimoto [QC#53675,MOD] -->
                    <!-- AND PRR.PROC_STS_CD      IN (#inCompleted#, #error#) -->
                    AND PRR.PROC_STS_CD       = #inCompleted#
                    <!-- END   2019/09/25 K.Fujimoto [QC#53675,MOD] -->
                    AND PRR.EZCANCELFLAG      = '0'
                    AND PRR.GLBL_CMPY_CD      = HDR.GLBL_CMPY_CD(+)
                    AND PRR.PRCH_REQ_NUM      = HDR.PRCH_REQ_NUM(+)
                    AND HDR.EZCANCELFLAG(+)   = '0'
                    AND PRR.GLBL_CMPY_CD      = DTL.GLBL_CMPY_CD(+)
                    AND PRR.PRCH_REQ_NUM      = DTL.PRCH_REQ_NUM(+)
                    <!-- mod start 2016/11/08 QC#15490 -->
                    AND PRR.PRCH_REQ_LINE_NUM = DTL.PRCH_REQ_LINE_NUM(+)
                    AND PRR.PRCH_REQ_LINE_SUB_NUM = DTL.PRCH_REQ_LINE_SUB_NUM(+)
                    <!-- mod end 2016/11/08 QC#15490 -->
                    AND DTL.EZCANCELFLAG(+)   = '0'
                    AND DTL.GLBL_CMPY_CD           = DC.GLBL_CMPY_CD(+)
                    AND DTL.PRCH_REQ_LINE_TP_CD    = DC.DS_COND_CONST_VAL_TXT_01(+)
                    AND DC.DS_COND_CONST_GRP_ID(+) = #NPZC1190_RTRN_TP#
                    AND DC.EZCANCELFLAG(+)         = '0'
                    AND PRR.GLBL_CMPY_CD           = RW.GLBL_CMPY_CD(+)
                    AND PRR.SRC_RTL_WH_CD          = RW.RTL_WH_CD(+)
                    AND RW.EZCANCELFLAG(+)         = '0'
                    AND DTL.GLBL_CMPY_CD           = MD.GLBL_CMPY_CD(+)
                    AND DTL.MDSE_CD                = MD.MDSE_CD(+)
                    AND MD.EZCANCELFLAG(+)         = '0'
                    <!-- START 2020/08/04 K.Kitachi [QC#57300, ADD] -->
                    AND DTL.GLBL_CMPY_CD           = RD.GLBL_CMPY_CD(+)
                    AND DTL.PRCH_REQ_NUM           = RD.PRCH_REQ_NUM(+)
                    AND DTL.PRCH_REQ_LINE_NUM      = RD.PRCH_REQ_LINE_NUM(+)
                    AND DTL.PRCH_REQ_LINE_SUB_NUM  = RD.PRCH_REQ_LINE_SUB_NUM(+)
                    AND RD.EZCANCELFLAG(+)         = '0'
                    <!-- END 2020/08/04 K.Kitachi [QC#57300, ADD] -->
            )
        ORDER BY
            EZINTIME ASC
            <!-- START 2016/12/05 K.Kojima [QC#16079,MOD] -->
            ,PRCH_REQ_NUM
            ,PRCH_REQ_LINE_NUM
            ,PRCH_REQ_LINE_SUB_NUM
            <!-- END 2016/12/05 K.Kojima [QC#16079,MOD] -->
    </statement>
    <statement id="getUpdatePrtRtrnInfo" parameterClass="Map" resultClass="Map">
        WITH
            IV_BEF AS(
                    SELECT
                         GLBL_CMPY_CD
                        ,PRCH_REQ_NUM
                        <!-- START 2018/07/24 T.Tomita [QC#17087,ADD] -->
                        ,PRCH_REQ_LINE_NUM
                        ,PRCH_REQ_LINE_SUB_NUM
                        <!-- END 2018/07/24 T.Tomita [QC#17087,ADD] -->
                        ,PRCH_REQ_STS_TXT
                        ,CLICK_TRK_NUM
                        ,CLICK_KEY_TXT
                        <!-- START 2020/07/07 K.Kitachi [QC#57300, ADD] -->
                        ,PRT_RTRN_RQST_SEND_TS
                        <!-- END 2020/07/07 K.Kitachi [QC#57300, ADD] -->
                        <!-- add start 2022/03/14 QC#59780 -->
                        ,ORIG_CLICK_TRK_NUM
                        ,CLICK_TO_WMS_TRK_NUM
                        <!-- add end 2022/03/14 QC#59780 -->
                    FROM
                        (SELECT
                             WK.GLBL_CMPY_CD
                            ,WK.CLICK_PRT_RTRN_RQST_PK
                            ,WK.PRT_RTRN_RQST_SQ
                            ,WK.PRCH_REQ_NUM
                            <!-- START 2018/07/24 T.Tomita [QC#17087,ADD] -->
                            ,WK.PRCH_REQ_LINE_NUM
                            ,WK.PRCH_REQ_LINE_SUB_NUM
                            <!-- END 2018/07/24 T.Tomita [QC#17087,ADD] -->
                            ,WK.PRCH_REQ_RQST_STS_TXT
                            ,WK.PRCH_REQ_STS_TXT
                            ,WK.INVTY_LOC_CD
                            ,WK.PRCH_REQ_INVTY_TP_TXT
                            ,WK.MDSE_CD
                            ,WK.PRCH_REQ_QTY
                            ,WK.PRCH_REQ_LINE_CMNT_TXT
                            ,WK.CLICK_TRK_NUM
                            ,WK.PROC_STS_CD
                            ,WK.PRT_RTRN_RQST_SEND_TS
                            ,WK.CLICK_KEY_TXT
                            <!-- add start 2022/03/14 QC#59780 -->
                            ,WK.ORIG_CLICK_TRK_NUM
                            ,WK.CLICK_TO_WMS_TRK_NUM
                            <!-- add end 2022/03/14 QC#59780 -->
                            ,ROW_NUMBER() OVER (PARTITION BY WK.PRCH_REQ_NUM ORDER BY WK.PRT_RTRN_RQST_SEND_TS DESC, PRT_RTRN_RQST_SQ DESC) AS ROW_NUM 
                        FROM
                            CLICK_PRT_RTRN_RQST WK
                        WHERE
                            WK.GLBL_CMPY_CD            = #glblCmpyCd#
<!-- START 2016/11/11 K.Kojima [QC#15490,DEL] -->
<!--                        AND WK.PROC_STS_CD         = #procStsComp# -->
<!-- END 2016/11/11 K.Kojima [QC#15490,DEL] -->
                            AND WK.EZCANCELFLAG        = '0'
                            AND NOT EXISTS(SELECT 1 FROM CLICK_PRT_RTRN_RQST CLO
                                            WHERE
                                            CLO.GLBL_CMPY_CD                = WK.GLBL_CMPY_CD
                                            AND CLO.PRCH_REQ_NUM            = WK.PRCH_REQ_NUM
                                            AND CLO.PRCH_REQ_RQST_STS_TXT   = #prchReqRqstStstxt#
                                            AND CLO.EZCANCELFLAG            = '0' )
                        )
                    WHERE
                        ROW_NUM = 1
            )
            ,IV_BEF_DTL AS(
                    SELECT
                         GLBL_CMPY_CD
                        ,PRCH_REQ_NUM
                        ,PRCH_REQ_LINE_NUM
                        ,PRCH_REQ_LINE_SUB_NUM
                        ,PRCH_REQ_INVTY_TP_TXT
                        ,CLICK_KEY_DTL_TXT
                    FROM
                        (SELECT
                             WK.GLBL_CMPY_CD
                            ,WK.PRCH_REQ_NUM
                            ,WK.PRCH_REQ_LINE_NUM
                            ,WK.PRCH_REQ_LINE_SUB_NUM
                            ,WK.PRCH_REQ_INVTY_TP_TXT
                            ,WK.CLICK_KEY_DTL_TXT
                            ,ROW_NUMBER() OVER (PARTITION BY WK.GLBL_CMPY_CD,WK.PRCH_REQ_NUM,WK.PRCH_REQ_LINE_NUM,WK.PRCH_REQ_LINE_SUB_NUM ORDER BY WK.PRT_RTRN_RQST_SEND_TS DESC, PRT_RTRN_RQST_SQ DESC) AS ROW_NUM
                        FROM
                             IV_BEF              BEF
                            ,CLICK_PRT_RTRN_RQST WK
                        WHERE
                                BEF.GLBL_CMPY_CD = WK.GLBL_CMPY_CD
                            AND BEF.PRCH_REQ_NUM = WK.PRCH_REQ_NUM
                            <!-- START 2018/07/24 T.Tomita [QC#17087,ADD] -->
                            AND BEF.PRCH_REQ_LINE_NUM = WK.PRCH_REQ_LINE_NUM
                            AND BEF.PRCH_REQ_LINE_SUB_NUM = WK.PRCH_REQ_LINE_SUB_NUM
                            <!-- END 2018/07/24 T.Tomita [QC#17087,ADD] -->
                            AND WK.EZCANCELFLAG  = '0'
                        )
                    WHERE
                        ROW_NUM = 1
            )
            ,IV_PRCH AS(
                    SELECT
                        REQ.GLBL_CMPY_CD
                        ,REQ.PRCH_REQ_NUM
                        ,REQ.RQST_TECH_TOC_CD
                        ,SUBSTR(NVL(REQ.PRCH_REQ_CLO_DT_TM_TS, #saledDate#), 1, 8) AS PRCH_REQ_CLO_DT
                        ,DTL.PRCH_REQ_LINE_NUM
                        ,DTL.PRCH_REQ_LINE_SUB_NUM
                        ,CASE
                            WHEN
                                    DTL.PRCH_REQ_LINE_STS_CD = #prchReqLineStsReceived#
                                AND (
                                       REQ.PRCH_REQ_STS_CD = #prchReqStsClosed#
                                    OR REQ.PRCH_REQ_STS_CD = #prchReqStsCancelled#
                                )
                            THEN REQ.PRCH_REQ_STS_CD
                            ELSE DTL.PRCH_REQ_LINE_STS_CD
                            END AS PRCH_REQ_LINE_STS_CD
                        ,DTL.MDSE_CD
                        ,DTL.SRC_RTL_WH_CD
                        ,DTL.SRC_RTL_SWH_CD
                        ,DTL.PRCH_REQ_QTY
                        ,DTL.PRCH_REQ_LINE_CMNT_TXT
                        ,DTL.BACK_TO_TECH_QTY
                        <!-- START 2020/07/07 K.Kitachi [QC#57300, ADD] -->
                        ,DTL.EZUPTIME
                        <!-- END 2020/07/07 K.Kitachi [QC#57300, ADD] -->
                    FROM
<!-- START 2018/07/24 T.Tomita [QC#17087,MOD] -->
<!--                    PRCH_REQ            REQ -->
<!--                    ,PRCH_REQ_DTL       DTL -->
<!--                WHERE -->
<!--                    REQ.GLBL_CMPY_CD                    = #glblCmpyCd# -->
<!--                    AND REQ.PRCH_REQ_REC_TP_CD          = #prchReqRecTpTech# -->
<!--                    AND REQ.EZCANCELFLAG                = '0' -->
<!--                    AND REQ.GLBL_CMPY_CD                = DTL.GLBL_CMPY_CD -->
<!--                    AND REQ.PRCH_REQ_NUM                = DTL.PRCH_REQ_NUM -->
<!--                    AND DTL.PRCH_REQ_LINE_SUB_NUM       = 0 -->
<!--                    AND DTL.EZCANCELFLAG                = '0' -->
<!--                    AND EXISTS(SELECT 1 FROM PRCH_REQ_LINE_TP   LTP -->
<!--                                    WHERE -->
<!--                                    LTP.GLBL_CMPY_CD                    = DTL.GLBL_CMPY_CD -->
<!--                                    AND LTP.PRCH_REQ_LINE_TP_CD         = DTL.PRCH_REQ_LINE_TP_CD -->
<!--                                    AND LTP.PRCH_REQ_REC_TP_CD          = #prchReqRecTpTech# -->
<!--                                    AND LTP.EZCANCELFLAG                = '0') -->
<!--                    AND NOT EXISTS(SELECT 1 FROM CLICK_PRT_RTRN_RQST CLO -->
<!--                                    WHERE -->
<!--                                    CLO.GLBL_CMPY_CD                = REQ.GLBL_CMPY_CD -->
<!--                                    AND CLO.PRCH_REQ_NUM            = REQ.PRCH_REQ_NUM -->
<!--                                    AND CLO.PRCH_REQ_RQST_STS_TXT   = #prchReqRqstStstxt# -->
<!--                                    AND CLO.EZCANCELFLAG            = '0' ) -->
                        (
                            SELECT
                                 REQ.GLBL_CMPY_CD
                                ,REQ.PRCH_REQ_NUM
                                ,DTL.PRCH_REQ_LINE_NUM
                                ,MAX(DTL.PRCH_REQ_LINE_SUB_NUM) AS PRCH_REQ_LINE_SUB_NUM
                            FROM
                                 PRCH_REQ           REQ
                                ,PRCH_REQ_DTL       DTL
                            WHERE
                                    REQ.GLBL_CMPY_CD                = #glblCmpyCd#
                                AND REQ.PRCH_REQ_REC_TP_CD          = #prchReqRecTpTech#
                                AND REQ.EZCANCELFLAG                = '0'
                                AND REQ.GLBL_CMPY_CD                = DTL.GLBL_CMPY_CD
                                AND REQ.PRCH_REQ_NUM                = DTL.PRCH_REQ_NUM
                                AND DTL.EZCANCELFLAG                = '0'
                                AND EXISTS(SELECT 1 FROM PRCH_REQ_LINE_TP   LTP
                                                WHERE
                                                LTP.GLBL_CMPY_CD                    = DTL.GLBL_CMPY_CD
                                                AND LTP.PRCH_REQ_LINE_TP_CD         = DTL.PRCH_REQ_LINE_TP_CD
                                                AND LTP.PRCH_REQ_REC_TP_CD          = #prchReqRecTpTech#
                                                AND LTP.EZCANCELFLAG                = '0')
                                AND NOT EXISTS(SELECT 1 FROM CLICK_PRT_RTRN_RQST CLO
                                                WHERE
                                                CLO.GLBL_CMPY_CD                = REQ.GLBL_CMPY_CD
                                                AND CLO.PRCH_REQ_NUM            = REQ.PRCH_REQ_NUM
                                                AND CLO.PRCH_REQ_RQST_STS_TXT   = #prchReqRqstStstxt#
                                                AND CLO.EZCANCELFLAG            = '0' )
                            GROUP BY
                                 REQ.GLBL_CMPY_CD
                                ,REQ.PRCH_REQ_NUM
                                ,DTL.PRCH_REQ_LINE_NUM
                        )                   TGT
                        ,PRCH_REQ_DTL       DTL
                        ,PRCH_REQ           REQ
                    WHERE
                        TGT.GLBL_CMPY_CD          = DTL.GLBL_CMPY_CD
                    AND TGT.PRCH_REQ_NUM          = DTL.PRCH_REQ_NUM
                    AND TGT.PRCH_REQ_LINE_NUM     = DTL.PRCH_REQ_LINE_NUM
                    AND TGT.PRCH_REQ_LINE_SUB_NUM = DTL.PRCH_REQ_LINE_SUB_NUM
                    AND DTL.EZCANCELFLAG          = '0'
                    AND DTL.GLBL_CMPY_CD          = REQ.GLBL_CMPY_CD
                    AND DTL.PRCH_REQ_NUM          = REQ.PRCH_REQ_NUM
                    AND REQ.EZCANCELFLAG          = '0'
                    AND DECODE(DTL.PRCH_REQ_LINE_TP_CD, #lineTpMissParts#, DTL.RWS_NUM, DTL.PRCH_REQ_NUM) IS NOT NULL
<!-- END 2018/07/24 T.Tomita [QC#17087,MOD] -->
                    <!-- START 2019/09/25 K.Fujimoto [QC#53675,MOD] -->
                    AND REQ.PRCH_REQ_SRC_TP_CD    = #prchReqSrcTpCd#
                    <!-- END   2019/09/25 K.Fujimoto [QC#53675,MOD] -->
            )
            ,IV_PRCH_STS AS(
                    SELECT
                        PRCH_REQ_NUM
                        ,DS_COND_CONST_DESC_TXT AS PRCH_REQ_RQST_STS_TXT
                    FROM
                       (SELECT
                            PRCH.PRCH_REQ_NUM
                            ,DCON.DS_COND_CONST_DESC_TXT
                            ,ROW_NUMBER() OVER (PARTITION BY PRCH.PRCH_REQ_NUM ORDER BY DCON.DS_COND_CONST_SORT_NUM) AS ROW_NUM
                        FROM
                            IV_PRCH         PRCH
                            ,DS_COND_CONST  DCON
                        WHERE
                            PRCH.GLBL_CMPY_CD                = DCON.GLBL_CMPY_CD
                            AND PRCH.PRCH_REQ_LINE_STS_CD    = DCON.DS_COND_CONST_CD
                            AND DCON.DS_COND_CONST_GRP_ID    = #NPAB1680_STS#
                            AND DCON.EZCANCELFLAG            = '0'
                        )
                    WHERE
                        ROW_NUM = 1
            )
        SELECT
            PRCH.PRCH_REQ_NUM
            ,PRCH.RQST_TECH_TOC_CD
            ,PRCH.PRCH_REQ_LINE_NUM
            ,PRCH.PRCH_REQ_LINE_SUB_NUM
            ,PRCH.PRCH_REQ_LINE_STS_CD
            ,PRCH.MDSE_CD
            ,PRCH.SRC_RTL_WH_CD
            ,PRCH.SRC_RTL_SWH_CD
            ,PRCH.SRC_RTL_WH_CD || PRCH.SRC_RTL_SWH_CD AS INVTY_LOC_CD
            ,PRCH.PRCH_REQ_QTY
            ,PRCH.BACK_TO_TECH_QTY
            ,PRCH.PRCH_REQ_LINE_CMNT_TXT
            ,STS.PRCH_REQ_RQST_STS_TXT
            ,BEF.CLICK_TRK_NUM
            ,BEF.CLICK_KEY_TXT
            ,BEF_DTL.PRCH_REQ_INVTY_TP_TXT
            ,BEF_DTL.CLICK_KEY_DTL_TXT
            <!-- add start 2022/03/14 QC#59780 -->
            ,BEF.ORIG_CLICK_TRK_NUM
            ,BEF.CLICK_TO_WMS_TRK_NUM
            <!-- add end 2022/03/14 QC#59780 -->
        FROM
            IV_PRCH         PRCH
            ,IV_PRCH_STS    STS
            ,IV_BEF         BEF
            ,IV_BEF_DTL     BEF_DTL
        WHERE
            PRCH.PRCH_REQ_NUM             = STS.PRCH_REQ_NUM
            AND BEF.PRCH_REQ_NUM(+)       = STS.PRCH_REQ_NUM
            AND (
                BEF.PRCH_REQ_NUM IS NULL
                OR (
                        BEF.PRCH_REQ_NUM IS NOT NULL
                    <!-- START 2020/07/07 K.Kitachi [QC#57300, MOD] -->
                    <!-- AND BEF.PRCH_REQ_STS_TXT &lt;&gt; STS.PRCH_REQ_RQST_STS_TXT -->
                    AND (
                        BEF.PRCH_REQ_STS_TXT &lt;&gt; STS.PRCH_REQ_RQST_STS_TXT
                        OR EXISTS (SELECT 1 FROM IV_PRCH X
                                    WHERE X.PRCH_REQ_NUM = BEF.PRCH_REQ_NUM
                                      AND X.EZUPTIME  &gt; BEF.PRT_RTRN_RQST_SEND_TS)
                    )
                    <!-- END 2020/07/07 K.Kitachi [QC#57300, MOD] -->
                )
            )
            AND PRCH.GLBL_CMPY_CD          = BEF_DTL.GLBL_CMPY_CD(+)
            AND PRCH.PRCH_REQ_NUM          = BEF_DTL.PRCH_REQ_NUM(+)
            AND PRCH.PRCH_REQ_LINE_NUM     = BEF_DTL.PRCH_REQ_LINE_NUM(+)
            AND PRCH.PRCH_REQ_LINE_SUB_NUM = BEF_DTL.PRCH_REQ_LINE_SUB_NUM(+)
            AND (
                STS.PRCH_REQ_RQST_STS_TXT &lt;&gt; #prchReqRqstStstxt#
                OR (
                        STS.PRCH_REQ_RQST_STS_TXT = #prchReqRqstStstxt#
                    AND PRCH.PRCH_REQ_CLO_DT      = #saledDate#
                )
            )
        ORDER BY
            PRCH.PRCH_REQ_NUM
            ,PRCH.PRCH_REQ_LINE_NUM
            ,PRCH.PRCH_REQ_LINE_SUB_NUM
    </statement>
    <statement id="getPrchReqInvtyTpTxtForMissingLine" parameterClass="Map" resultClass="String">
        SELECT
             DC.DS_COND_CONST_CD AS PRCH_REQ_INVTY_TP_TXT
        FROM
             (
                SELECT
                     PRD.GLBL_CMPY_CD
                    ,PRD.PRCH_REQ_NUM
                    ,PRD.PRCH_REQ_LINE_NUM
                    ,PRD.PRCH_REQ_LINE_SUB_NUM
                    ,PRD.PRCH_REQ_LINE_TP_CD
                    ,PRD.PRCH_REQ_QTY
                    ,PRD.SHIP_QTY
                    ,PRD.RWS_PUT_AWAY_QTY
                    ,ROW_NUMBER() OVER (PARTITION BY PRD.GLBL_CMPY_CD, PRD.PRCH_REQ_NUM, PRD.PRCH_REQ_LINE_NUM ORDER BY PRD.PRCH_REQ_LINE_SUB_NUM ASC) AS ROW_NUM
                FROM
                    PRCH_REQ_DTL  PRD
                WHERE
                        PRD.GLBL_CMPY_CD                = #glblCmpyCd#
                    AND PRD.PRCH_REQ_NUM                = #prchReqNum#
                    AND PRD.PRCH_REQ_LINE_NUM           = #prchReqLineNum#
                    AND PRD.PRCH_REQ_LINE_STS_CD &lt;&gt; #prchReqLineStsCdCancel#
                    AND PRD.EZCANCELFLAG                = '0'
              ) PRD1
            ,DS_COND_CONST      DC
        WHERE
                PRD1.ROW_NUM = 1
            AND PRD1.GLBL_CMPY_CD = DC.GLBL_CMPY_CD(+)
            AND PRD1.PRCH_REQ_LINE_TP_CD = DC.DS_COND_CONST_VAL_TXT_01(+)
            AND DC.DS_COND_CONST_GRP_ID(+) = #NPZC1190_RTRN_TP#
            AND DC.EZCANCELFLAG(+) = '0'
    </statement>
    <statement id="getMissingLineData" parameterClass="Map" resultClass="Map">
        SELECT
             PRD2.GLBL_CMPY_CD
            ,PRD2.PRCH_REQ_NUM
            ,PRD2.PRCH_REQ_LINE_NUM
            ,PRD2.PRCH_REQ_LINE_SUB_NUM
            ,NVL(PRD2.PRCH_REQ_QTY, 0)      AS PRCH_REQ_QTY
            ,NVL(PRD2.PRCH_REQ_SHIP_QTY, 0) AS PRCH_REQ_SHIP_QTY
            ,NVL(PRD2.PRCH_REQ_DELY_QTY, 0) AS PRCH_REQ_DELY_QTY
            <!-- START 2016/11/29 K.Kojima [QC#16033,MOD] -->
            ,CASE WHEN DC.DS_COND_CONST_DESC_TXT = #prchReqStsTxtAwaitingShipment#
                  THEN 0
                  ELSE NVL(PRD2.PRCH_REQ_SHIP_QTY, 0) - NVL(PRD2.PRCH_REQ_DELY_QTY, 0) END AS PRCH_REQ_SHORT_QTY
            <!-- END 2016/11/29 K.Kojima [QC#16033,MOD] -->
        FROM
             (
                SELECT
                     PRD1.GLBL_CMPY_CD
                    ,PRD1.PRCH_REQ_NUM
                    ,PRD1.PRCH_REQ_LINE_NUM
                    ,MAX(CASE WHEN PRD1.ROW_NUM = 1 THEN PRD1.PRCH_REQ_LINE_STS_CD  ELSE NULL END) AS PRCH_REQ_LINE_STS_CD
                    ,MAX(CASE WHEN PRD1.ROW_NUM = 1 THEN PRD1.PRCH_REQ_LINE_SUB_NUM ELSE NULL END) AS PRCH_REQ_LINE_SUB_NUM
                    ,MAX(CASE WHEN PRD1.ROW_NUM = 1 THEN PRD1.PRCH_REQ_QTY          ELSE NULL END) AS PRCH_REQ_QTY
                    ,MAX(CASE WHEN PRD1.ROW_NUM = 1 THEN PRD1.SHIP_QTY              ELSE NULL END) AS PRCH_REQ_SHIP_QTY
                    ,SUM(PRD1.RWS_PUT_AWAY_QTY)                                                    AS PRCH_REQ_DELY_QTY
                FROM
                    (
                        SELECT
                             PRD.GLBL_CMPY_CD
                            ,PRD.PRCH_REQ_NUM
                            ,PRD.PRCH_REQ_LINE_NUM
                            ,PRD.PRCH_REQ_LINE_SUB_NUM
                            ,PRD.PRCH_REQ_LINE_STS_CD
                            ,PRD.PRCH_REQ_QTY
                            ,PRD.SHIP_QTY
                            ,PRD.RWS_PUT_AWAY_QTY
                            ,ROW_NUMBER() OVER (PARTITION BY PRD.GLBL_CMPY_CD, PRD.PRCH_REQ_NUM, PRD.PRCH_REQ_LINE_NUM ORDER BY PRD.PRCH_REQ_LINE_SUB_NUM ASC) AS ROW_NUM
                        FROM
                            PRCH_REQ_DTL  PRD
                        WHERE
                                PRD.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND PRD.PRCH_REQ_NUM                = #prchReqNum#
                            AND PRD.PRCH_REQ_LINE_NUM           = #prchReqLineNum#
                            AND PRD.PRCH_REQ_LINE_STS_CD &lt;&gt; #prchReqLineStsCdCancel#
                            AND PRD.EZCANCELFLAG                = '0'
                    ) PRD1
                GROUP BY
                     PRD1.GLBL_CMPY_CD
                    ,PRD1.PRCH_REQ_NUM
                    ,PRD1.PRCH_REQ_LINE_NUM
             )             PRD2
            ,DS_COND_CONST DC
        WHERE
                PRD2.GLBL_CMPY_CD         = DC.GLBL_CMPY_CD
            AND PRD2.PRCH_REQ_LINE_STS_CD = DC.DS_COND_CONST_CD
            AND DC.DS_COND_CONST_GRP_ID    = #NPAB1680_STS#
            AND DC.EZCANCELFLAG            = '0'
    </statement>
</sqlMap>
