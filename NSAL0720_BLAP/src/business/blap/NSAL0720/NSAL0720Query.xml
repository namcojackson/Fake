<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSAL0720Query">
    <typeAlias alias="NSAL0720_ASMsg" type="business.blap.NSAL0720.NSAL0720_ASMsg"/>
    <statement id="getContrHdrInfo" parameterClass="Map" resultMap="result.getContrHdrInfo">
        SELECT
                 DS_CONTR_PK
                ,DS_CONTR_DTL_PK
                ,DS_CONTR_BLLG_MTR_PK
                ,PRNT_DS_CONTR_DTL_PK
                ,SER_SORT_NUM
                ,MTR_LB_SORT_NUM
                ,DS_CONTR_CATG_CD
                ,DS_CONTR_NUM
                ,HDR_STS_CD
                ,DTL_STS_CD
                ,BLLG_MTR_STS_CD
                ,DS_CONTR_SRC_TP_CD
                ,LOC_NM
                ,XX_SCR_ITEM_34_TXT
                ,SER_NUM
                ,MTR_LB_DESC_TXT
                ,CUR_BILL_TO_CUST_CD
                ,CUR_BILL_TO_CUST_LOC_ADDR
                ,DPLY_CTRL_FLG
                ,SORT_NUM
                ,DS_CONTR_DTL_TP_CD
                ,DS_ACCT_NUM
                ,EZUPTIME_HD
                ,EZUPTIMEZONE_HD
                ,EZUPTIME_DT
                ,EZUPTIMEZONE_DT
                ,EZUPTIME_BL
                ,EZUPTIMEZONE_BL
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                ,XX_REC_HIST_CRAT_TS
                ,XX_REC_HIST_CRAT_BY_NM
                ,XX_REC_HIST_UPD_TS
                ,XX_REC_HIST_UPD_BY_NM
                ,XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
            FROM (
        --Header
                SELECT
                     HDR.DS_CONTR_PK                    DS_CONTR_PK
                    ,0                                  DS_CONTR_DTL_PK
                    ,0                                  DS_CONTR_BLLG_MTR_PK
                    ,0                                  PRNT_DS_CONTR_DTL_PK
                    ,NULL                               SER_SORT_NUM
                    ,NULL                               MTR_LB_SORT_NUM
                    ,HDR.DS_CONTR_CATG_CD               DS_CONTR_CATG_CD
                    ,HDR.DS_CONTR_NUM                   DS_CONTR_NUM
                    ,STH.DS_CONTR_CTRL_STS_CD           HDR_STS_CD
                    ,NULL                               DTL_STS_CD
                    ,NULL                               BLLG_MTR_STS_CD
                    ,HDR.DS_CONTR_SRC_TP_CD             DS_CONTR_SRC_TP_CD
                    ,BTC.LOC_NM                         LOC_NM
                    ,TRIM(HDR.DS_CONTR_CATG_CD
                        || '-' || HDR.DS_CONTR_NUM)  AS XX_SCR_ITEM_34_TXT
                    ,NULL                               SER_NUM
                    ,NULL                               MTR_LB_DESC_TXT
                    ,HDR.ALT_PAYER_CUST_CD              CUR_BILL_TO_CUST_CD
                    ,TRIM(BTC.FIRST_LINE_ADDR
                        || ' ' || BTC.SCD_LINE_ADDR
                        || ' ' || BTC.CTY_ADDR
                        || ' ' || BTC.ST_CD
                        || ' ' || BTC.POST_CD)          CUR_BILL_TO_CUST_LOC_ADDR
                    ,'Y'                                DPLY_CTRL_FLG
                    ,1                                  SORT_NUM
                    ,''                                 DS_CONTR_DTL_TP_CD
                    ,HDR.DS_ACCT_NUM                    DS_ACCT_NUM
                    ,HDR.EZUPTIME                       EZUPTIME_HD
                    ,HDR.EZUPTIMEZONE                   EZUPTIMEZONE_HD
                    ,''                                 EZUPTIME_DT
                    ,''                                 EZUPTIMEZONE_DT
                    ,''                                 EZUPTIME_BL
                    ,''                                 EZUPTIMEZONE_BL
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                    ,HDR.EZINTIME                       XX_REC_HIST_CRAT_TS
                    ,HDR.EZINUSERID                     XX_REC_HIST_CRAT_BY_NM
                    ,HDR.EZUPTIME                       XX_REC_HIST_UPD_TS
                    ,HDR.EZUPUSERID                     XX_REC_HIST_UPD_BY_NM
                    ,HDR.EZTABLEID                      XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
                FROM
                     DS_CONTR               HDR
                    ,BILL_TO_CUST           BTC
                    ,DS_CONTR_STS_V         STH
                WHERE
                        HDR.GLBL_CMPY_CD        = #glblCmpyCd#
                    <iterate property="dsContrPkArray" var="dsContrPk[]" open="AND HDR.DS_CONTR_PK IN (" close=")" conjunction=",">
                        #dsContrPk[]#
                    </iterate>
                    AND HDR.EZCANCELFLAG        = '0'
                    AND HDR.GLBL_CMPY_CD        = BTC.GLBL_CMPY_CD
                    AND HDR.ALT_PAYER_CUST_CD   = BTC.BILL_TO_CUST_CD
                    AND BTC.EZCANCELFLAG        = '0'
                    AND HDR.GLBL_CMPY_CD        = STH.GLBL_CMPY_CD
                    AND HDR.DS_CONTR_PK         = STH.DS_CONTR_PK
                    AND STH.EZCANCELFLAG        = '0'
        --Detail
        UNION ALL
                SELECT
                     HDR.DS_CONTR_PK                    DS_CONTR_PK
                    ,DTL.DS_CONTR_DTL_PK                DS_CONTR_DTL_PK
                    ,0                                  DS_CONTR_BLLG_MTR_PK
                    ,CASE WHEN DTL.PRNT_DS_CONTR_DTL_PK IS NULL THEN DTL.DS_CONTR_DTL_PK
                          ELSE DTL.PRNT_DS_CONTR_DTL_PK
                     END                                PRNT_DS_CONTR_DTL_PK
                    ,SMM.SER_NUM                        SER_SORT_NUM
                    ,NULL                               MTR_LB_SORT_NUM
                    ,HDR.DS_CONTR_CATG_CD               DS_CONTR_CATG_CD
                    ,HDR.DS_CONTR_NUM                   DS_CONTR_NUM
                    ,STH.DS_CONTR_CTRL_STS_CD           HDR_STS_CD
                    ,STD.DS_CONTR_CTRL_STS_CD           DTL_STS_CD
                    ,NULL                               BLLG_MTR_STS_CD
                    ,HDR.DS_CONTR_SRC_TP_CD             DS_CONTR_SRC_TP_CD
                    ,BTC.LOC_NM                         LOC_NM
                    ,NULL                               XX_SCR_ITEM_34_TXT
                    ,SMM.SER_NUM                        SER_NUM
                    ,NULL                               MTR_LB_DESC_TXT
                    ,DTL.DTL_BILL_TO_CUST_CD            CUR_BILL_TO_CUST_CD
                    ,TRIM(BTC.FIRST_LINE_ADDR
                        || ' ' || BTC.SCD_LINE_ADDR
                        || ' ' || BTC.CTY_ADDR
                        || ' ' || BTC.ST_CD
                        || ' ' || BTC.POST_CD)          CUR_BILL_TO_CUST_LOC_ADDR
                    ,'Y'                                DPLY_CTRL_FLG
                    ,2                                  SORT_NUM
                    ,DTL.DS_CONTR_DTL_TP_CD             DS_CONTR_DTL_TP_CD
                    ,HDR.DS_ACCT_NUM                    DS_ACCT_NUM
                    ,HDR.EZUPTIME                       EZUPTIME_HD
                    ,HDR.EZUPTIMEZONE                   EZUPTIMEZONE_HD
                    ,DTL.EZUPTIME                       EZUPTIME_DT
                    ,DTL.EZUPTIMEZONE                   EZUPTIMEZONE_DT
                    ,''                                 EZUPTIME_BL
                    ,''                                 EZUPTIMEZONE_BL
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                    ,DTL.EZINTIME                       XX_REC_HIST_CRAT_TS
                    ,DTL.EZINUSERID                     XX_REC_HIST_CRAT_BY_NM
                    ,DTL.EZUPTIME                       XX_REC_HIST_UPD_TS
                    ,DTL.EZUPUSERID                     XX_REC_HIST_UPD_BY_NM
                    ,DTL.EZTABLEID                      XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
                FROM
                     DS_CONTR               HDR
                    ,DS_CONTR_DTL           DTL
                    ,SVC_MACH_MSTR          SMM
                    ,BILL_TO_CUST           BTC
                    ,DS_CONTR_STS_V         STH
                    ,DS_CONTR_DTL_STS_V     STD
                WHERE
                        HDR.GLBL_CMPY_CD        = #glblCmpyCd#
                    <iterate property="dsContrPkArray" var="dsContrPk[]" open="AND HDR.DS_CONTR_PK IN (" close=")" conjunction=",">
                        #dsContrPk[]#
                    </iterate>
                    AND HDR.EZCANCELFLAG        = '0'
                    AND HDR.GLBL_CMPY_CD        = DTL.GLBL_CMPY_CD
                    AND HDR.DS_CONTR_PK         = DTL.DS_CONTR_PK
                    <isEqual property="existContrDtlPk" compareValue="Y">
                        <iterate property="dsContrDtlPkArray" var="dsContrDtlPk[]" open="AND DTL.DS_CONTR_DTL_PK IN (" close=")" conjunction=",">
                            #dsContrDtlPk[]#
                        </iterate>
                    </isEqual>
                    AND DTL.EZCANCELFLAG        = '0'
                    AND DTL.GLBL_CMPY_CD        = BTC.GLBL_CMPY_CD(+)
                    AND DTL.DTL_BILL_TO_CUST_CD = BTC.BILL_TO_CUST_CD(+)
                    AND BTC.EZCANCELFLAG(+)     = '0'
                    AND DTL.GLBL_CMPY_CD        = SMM.GLBL_CMPY_CD
                    AND DTL.SVC_MACH_MSTR_PK    = SMM.SVC_MACH_MSTR_PK
                    AND SMM.EZCANCELFLAG        = '0'
                    AND HDR.GLBL_CMPY_CD        = STH.GLBL_CMPY_CD
                    AND HDR.DS_CONTR_PK         = STH.DS_CONTR_PK
                    AND STH.EZCANCELFLAG        = '0'
                    AND DTL.GLBL_CMPY_CD        = STD.GLBL_CMPY_CD
                    AND DTL.DS_CONTR_PK         = STD.DS_CONTR_PK
                    AND DTL.DS_CONTR_DTL_PK     = STD.DS_CONTR_DTL_PK
                    AND STD.EZCANCELFLAG        = '0'
        --Base Line
        UNION ALL
                SELECT
                     HDR.DS_CONTR_PK                    DS_CONTR_PK
                    ,DTL.DS_CONTR_DTL_PK                DS_CONTR_DTL_PK
                    ,0                                  DS_CONTR_BLLG_MTR_PK
                    ,CASE WHEN DTL.PRNT_DS_CONTR_DTL_PK IS NULL THEN DTL.DS_CONTR_DTL_PK
                          ELSE DTL.PRNT_DS_CONTR_DTL_PK
                     END                                PRNT_DS_CONTR_DTL_PK
                    ,SMM.SER_NUM                        SER_SORT_NUM
                    ,NULL                               MTR_LB_SORT_NUM
                    ,HDR.DS_CONTR_CATG_CD               DS_CONTR_CATG_CD
                    ,HDR.DS_CONTR_NUM                   DS_CONTR_NUM
                    ,STH.DS_CONTR_CTRL_STS_CD           HDR_STS_CD
                    ,STD.DS_CONTR_CTRL_STS_CD           DTL_STS_CD
                    ,NULL                               BLLG_MTR_STS_CD
                    ,HDR.DS_CONTR_SRC_TP_CD             DS_CONTR_SRC_TP_CD
                    ,BTC.LOC_NM                         LOC_NM
                    ,NULL                               XX_SCR_ITEM_34_TXT
                    ,NULL                               SER_NUM
                    ,#mtrLbNm#                          MTR_LB_DESC_TXT
                    ,DTL.BASE_BILL_TO_CUST_CD           CUR_BILL_TO_CUST_CD
                    ,TRIM(BTC.FIRST_LINE_ADDR
                        || ' ' || BTC.SCD_LINE_ADDR
                        || ' ' || BTC.CTY_ADDR
                        || ' ' || BTC.ST_CD
                        || ' ' || BTC.POST_CD)          CUR_BILL_TO_CUST_LOC_ADDR
                    ,'N'                                DPLY_CTRL_FLG
                    ,3                                  SORT_NUM
                    ,DTL.DS_CONTR_DTL_TP_CD             DS_CONTR_DTL_TP_CD
                    ,HDR.DS_ACCT_NUM                    DS_ACCT_NUM
                    ,HDR.EZUPTIME                       EZUPTIME_HD
                    ,HDR.EZUPTIMEZONE                   EZUPTIMEZONE_HD
                    ,DTL.EZUPTIME                       EZUPTIME_DT
                    ,DTL.EZUPTIMEZONE                   EZUPTIMEZONE_DT
                    ,''                                 EZUPTIME_BL
                    ,''                                 EZUPTIMEZONE_BL
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                    ,DTL.EZINTIME                       XX_REC_HIST_CRAT_TS
                    ,DTL.EZINUSERID                     XX_REC_HIST_CRAT_BY_NM
                    ,DTL.EZUPTIME                       XX_REC_HIST_UPD_TS
                    ,DTL.EZUPUSERID                     XX_REC_HIST_UPD_BY_NM
                    ,DTL.EZTABLEID                      XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
                FROM
                     DS_CONTR               HDR
                    ,DS_CONTR_DTL           DTL
                    ,SVC_MACH_MSTR          SMM
                    ,BILL_TO_CUST           BTC
                    ,DS_CONTR_STS_V         STH
                    ,DS_CONTR_DTL_STS_V     STD
                    ,DS_CONTR_DTL_TP        CDT
                WHERE
                        HDR.GLBL_CMPY_CD        = #glblCmpyCd#
                    <iterate property="dsContrPkArray" var="dsContrPk[]" open="AND HDR.DS_CONTR_PK IN (" close=")" conjunction=",">
                        #dsContrPk[]#
                    </iterate>
                    AND HDR.EZCANCELFLAG        = '0'
                    AND HDR.GLBL_CMPY_CD        = DTL.GLBL_CMPY_CD
                    AND HDR.DS_CONTR_PK         = DTL.DS_CONTR_PK
                    <isEqual property="existContrDtlPk" compareValue="Y">
                    AND (
                            (
                            <iterate property="dsContrDtlPkArray" var="dsContrDtlPk[]" open="DTL.DS_CONTR_DTL_PK IN (" close=")" conjunction=",">
                                #dsContrDtlPk[]#
                            </iterate>
                            ) OR (
                                DTL.DS_CONTR_DTL_TP_CD IN (#dsContrDtlTpCdFleet#, #dsContrDtlTpCdAgg#)
                            )
                        )
                    </isEqual>
                    AND DTL.EZCANCELFLAG        = '0'
                    AND DTL.GLBL_CMPY_CD        = BTC.GLBL_CMPY_CD(+)
                    AND DTL.BASE_BILL_TO_CUST_CD = BTC.BILL_TO_CUST_CD(+)
                    AND BTC.EZCANCELFLAG(+)     = '0'
                    AND DTL.GLBL_CMPY_CD        = SMM.GLBL_CMPY_CD(+)
                    AND DTL.SVC_MACH_MSTR_PK    = SMM.SVC_MACH_MSTR_PK(+)
                    AND SMM.EZCANCELFLAG(+)     = '0'
                    AND HDR.GLBL_CMPY_CD        = STH.GLBL_CMPY_CD
                    AND HDR.DS_CONTR_PK         = STH.DS_CONTR_PK
                    AND STH.EZCANCELFLAG        = '0'
                    AND DTL.GLBL_CMPY_CD        = STD.GLBL_CMPY_CD
                    AND DTL.DS_CONTR_PK         = STD.DS_CONTR_PK
                    AND DTL.DS_CONTR_DTL_PK     = STD.DS_CONTR_DTL_PK
                    AND STD.EZCANCELFLAG        = '0'
                    AND DTL.GLBL_CMPY_CD        = CDT.GLBL_CMPY_CD
                    AND DTL.DS_CONTR_DTL_TP_CD  = CDT.DS_CONTR_DTL_TP_CD
                    AND CDT.BASE_CHRG_FLG       = #baseChrgFlg#
                    AND CDT.EZCANCELFLAG        = '0'
        --Usage Line
        UNION ALL
                SELECT
                     HDR.DS_CONTR_PK                    DS_CONTR_PK
                    ,DTL.DS_CONTR_DTL_PK                DS_CONTR_DTL_PK
                    ,BLM.DS_CONTR_BLLG_MTR_PK           DS_CONTR_BLLG_MTR_PK
                    ,CASE WHEN DTL.PRNT_DS_CONTR_DTL_PK IS NULL THEN DTL.DS_CONTR_DTL_PK
                          ELSE DTL.PRNT_DS_CONTR_DTL_PK
                     END                                PRNT_DS_CONTR_DTL_PK
                    ,SMM.SER_NUM                        SER_SORT_NUM
                    ,MLB.MTR_LB_SORT_NUM                MTR_LB_SORT_NUM
                    ,HDR.DS_CONTR_CATG_CD               DS_CONTR_CATG_CD
                    ,HDR.DS_CONTR_NUM                   DS_CONTR_NUM
                    ,STH.DS_CONTR_CTRL_STS_CD           HDR_STS_CD
                    ,STD.DS_CONTR_CTRL_STS_CD           DTL_STS_CD
                    ,STB.DS_CONTR_CTRL_STS_CD           BLLG_MTR_STS_CD
                    ,HDR.DS_CONTR_SRC_TP_CD             DS_CONTR_SRC_TP_CD
                    ,BTC.LOC_NM                         LOC_NM
                    ,NULL                               XX_SCR_ITEM_34_TXT
                    ,NULL                               SER_NUM
                    ,MLB.MTR_LB_DESC_TXT                MTR_LB_DESC_TXT
                    ,BLM.BLLG_MTR_BILL_TO_CUST_CD       CUR_BILL_TO_CUST_CD
                    ,TRIM(BTC.FIRST_LINE_ADDR
                        || ' ' || BTC.SCD_LINE_ADDR
                        || ' ' || BTC.CTY_ADDR
                        || ' ' || BTC.ST_CD
                        || ' ' || BTC.POST_CD)          CUR_BILL_TO_CUST_LOC_ADDR
                    ,'N'                                DPLY_CTRL_FLG
                    ,4                                  SORT_NUM
                    ,DTL.DS_CONTR_DTL_TP_CD             DS_CONTR_DTL_TP_CD
                    ,HDR.DS_ACCT_NUM                    DS_ACCT_NUM
                    ,HDR.EZUPTIME                       EZUPTIME_HD
                    ,HDR.EZUPTIMEZONE                   EZUPTIMEZONE_HD
                    ,DTL.EZUPTIME                       EZUPTIME_DT
                    ,DTL.EZUPTIMEZONE                   EZUPTIMEZONE_DT
                    ,BLM.EZUPTIME                       EZUPTIME_BL
                    ,BLM.EZUPTIMEZONE                   EZUPTIMEZONE_BL
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                    ,BLM.EZINTIME                       XX_REC_HIST_CRAT_TS
                    ,BLM.EZINUSERID                     XX_REC_HIST_CRAT_BY_NM
                    ,BLM.EZUPTIME                       XX_REC_HIST_UPD_TS
                    ,BLM.EZUPUSERID                     XX_REC_HIST_UPD_BY_NM
                    ,BLM.EZTABLEID                      XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
                FROM
                     DS_CONTR               HDR
                    ,DS_CONTR_DTL           DTL
                    ,DS_CONTR_BLLG_MTR      BLM
                    ,MTR_LB                 MLB
                    ,BILL_TO_CUST           BTC
                    ,DS_CONTR_STS_V         STH
                    ,DS_CONTR_DTL_STS_V     STD
                    ,DS_CONTR_BLLG_MTR_STS_V STB
                    ,DS_CONTR_DTL_TP        CDT
                    ,SVC_MACH_MSTR          SMM
                WHERE
                        HDR.GLBL_CMPY_CD        = #glblCmpyCd#
                   <iterate property="dsContrPkArray" var="dsContrPk[]" open="AND HDR.DS_CONTR_PK IN (" close=")" conjunction=",">
                        #dsContrPk[]#
                    </iterate>
                    AND HDR.EZCANCELFLAG        = '0'
                    AND HDR.GLBL_CMPY_CD        = DTL.GLBL_CMPY_CD
                    AND HDR.DS_CONTR_PK         = DTL.DS_CONTR_PK
                    <isEqual property="existContrDtlPk" compareValue="Y">
                    AND (
                            (
                            <iterate property="dsContrDtlPkArray" var="dsContrDtlPk[]" open="DTL.DS_CONTR_DTL_PK IN (" close=")" conjunction=",">
                                #dsContrDtlPk[]#
                            </iterate>
                            ) OR (
                                DTL.DS_CONTR_DTL_TP_CD IN (#dsContrDtlTpCdFleet#, #dsContrDtlTpCdAgg#)
                            )
                        )
                    </isEqual>
                    AND DTL.EZCANCELFLAG        = '0'
                    AND DTL.GLBL_CMPY_CD        = BLM.GLBL_CMPY_CD
                    AND DTL.DS_CONTR_DTL_PK     = BLM.DS_CONTR_DTL_PK
                    AND BLM.EZCANCELFLAG        = '0'
                    AND BLM.GLBL_CMPY_CD        = MLB.GLBL_CMPY_CD
                    AND BLM.BLLG_MTR_LB_CD      = MLB.MTR_LB_CD
                    AND MLB.EZCANCELFLAG        = '0'
                    AND BLM.GLBL_CMPY_CD        = BTC.GLBL_CMPY_CD(+)
                    AND BLM.BLLG_MTR_BILL_TO_CUST_CD = BTC.BILL_TO_CUST_CD(+)
                    AND BTC.EZCANCELFLAG(+)     = '0'
                    AND HDR.GLBL_CMPY_CD        = STH.GLBL_CMPY_CD
                    AND HDR.DS_CONTR_PK         = STH.DS_CONTR_PK
                    AND STH.EZCANCELFLAG        = '0'
                    AND DTL.GLBL_CMPY_CD        = STD.GLBL_CMPY_CD
                    AND DTL.DS_CONTR_PK         = STD.DS_CONTR_PK
                    AND DTL.DS_CONTR_DTL_PK     = STD.DS_CONTR_DTL_PK
                    AND STD.EZCANCELFLAG        = '0'
                    AND BLM.GLBL_CMPY_CD        = STB.GLBL_CMPY_CD(+)
                    AND BLM.DS_CONTR_DTL_PK     = STB.DS_CONTR_DTL_PK(+)
                    AND BLM.DS_CONTR_BLLG_MTR_PK = STB.DS_CONTR_BLLG_MTR_PK(+)
                    AND STB.EZCANCELFLAG(+)     = '0'
                    AND DTL.GLBL_CMPY_CD        = CDT.GLBL_CMPY_CD
                    AND DTL.DS_CONTR_DTL_TP_CD  = CDT.DS_CONTR_DTL_TP_CD
                    AND CDT.USG_CHRG_FLG        = #usgChrgFlg#
                    AND CDT.EZCANCELFLAG        = '0'
                    AND DTL.GLBL_CMPY_CD        = SMM.GLBL_CMPY_CD(+)
                    AND DTL.SVC_MACH_MSTR_PK    = SMM.SVC_MACH_MSTR_PK(+)
                    AND SMM.EZCANCELFLAG(+)     = '0'
                ORDER BY
                     DS_CONTR_CATG_CD
                    ,DS_CONTR_PK
                    ,PRNT_DS_CONTR_DTL_PK
                    ,SER_SORT_NUM NULLS FIRST
                    ,SORT_NUM
                    ,MTR_LB_SORT_NUM
            ) 
    </statement>
    <resultMap id="result.getContrHdrInfo" class="NSAL0720_ASMsg">
        <result property="dsContrPk_A1" column="DS_CONTR_PK"  javaType="EZDSBigDecimalItem" />
        <result property="dsContrCatgCd_A1" column="DS_CONTR_CATG_CD"  javaType="EZDSStringItem" />
        <result property="dsContrNum_A1" column="DS_CONTR_NUM"  javaType="EZDSStringItem" />
        <result property="dsContrDtlPk_A1" column="DS_CONTR_DTL_PK"  javaType="EZDSBigDecimalItem" />
        <result property="dsContrBllgMtrPk_A1" column="DS_CONTR_BLLG_MTR_PK"  javaType="EZDCBigDecimalItem" />
        <result property="dsContrCtrlStsCd_AH" column="HDR_STS_CD"  javaType="EZDSStringItem" />
        <result property="dsContrCtrlStsCd_AD" column="DTL_STS_CD"  javaType="EZDSStringItem" />
        <result property="dsContrCtrlStsCd_AB" column="BLLG_MTR_STS_CD"  javaType="EZDSStringItem" />
        <result property="dsContrSrcTpCd_A1" column="DS_CONTR_SRC_TP_CD"  javaType="EZDSStringItem" />
        <result property="locNm_A1" column="LOC_NM"  javaType="EZDSStringItem" />
        <result property="xxScrItem34Txt_A1" column="XX_SCR_ITEM_34_TXT"  javaType="EZDSStringItem" />
        <result property="serNum_A1" column="SER_NUM"  javaType="EZDSStringItem" />
        <result property="mtrLbDescTxt_A1" column="MTR_LB_DESC_TXT"  javaType="EZDSStringItem" />
        <result property="billToCustCd_A1" column="CUR_BILL_TO_CUST_CD"  javaType="EZDSStringItem" />
        <result property="billToCustLocAddr_A1" column="CUR_BILL_TO_CUST_LOC_ADDR"  javaType="EZDSStringItem" />
        <result property="xxDplyCtrlFlg" column="DPLY_CTRL_FLG"  javaType="EZDSStringItem" />
        <result property="dsContrDtlTpCd_A1" column="DS_CONTR_DTL_TP_CD"  javaType="EZDSStringItem" />
        <result property="dsAcctNum_A1" column="DS_ACCT_NUM"  javaType="EZDSStringItem" />
        <result property="ezUpTime_HD" column="EZUPTIME_HD"  javaType="EZDSStringItem" />
        <result property="ezUpTimeZone_HD" column="EZUPTIMEZONE_HD"  javaType="EZDSStringItem" />
        <result property="ezUpTime_DT" column="EZUPTIME_DT"  javaType="EZDSStringItem" />
        <result property="ezUpTimeZone_DT" column="EZUPTIMEZONE_DT"  javaType="EZDSStringItem" />
        <result property="ezUpTime_BL" column="EZUPTIME_BL"  javaType="EZDSStringItem" />
        <result property="ezUpTimeZone_BL" column="EZUPTIMEZONE_BL"  javaType="EZDSStringItem" />
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
        <result property="xxRecHistCratTs_A"   column="XX_REC_HIST_CRAT_TS"       javaType="EZDSStringItem"/>
        <result property="xxRecHistCratByNm_A" column="XX_REC_HIST_CRAT_BY_NM"    javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdTs_A"    column="XX_REC_HIST_UPD_TS"        javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdByNm_A"  column="XX_REC_HIST_UPD_BY_NM"     javaType="EZDSStringItem"/>
        <result property="xxRecHistTblNm_A"    column="XX_REC_HIST_TBL_NM"        javaType="EZDSStringItem"/>
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
    </resultMap>
    <statement id="getDsContrDtlPk" parameterClass="Map" resultClass="Map">
        SELECT
            DTL.DS_CONTR_DTL_PK
        FROM
            DS_CONTR_DTL           DTL
           ,DS_CONTR_DTL_STS_V     CDV
           ,DS_CONTR_DTL_TP        CDT
        WHERE
                DTL.GLBL_CMPY_CD          = #glblCmpyCd#
            AND DTL.DS_CONTR_PK           = #dsContrPk#
            <isNotNull property="dsContrDtlPk">
            AND DTL.DS_CONTR_DTL_PK       = #dsContrDtlPk#
            </isNotNull>
            AND DTL.EZCANCELFLAG          = '0'
            AND DTL.GLBL_CMPY_CD          = CDV.GLBL_CMPY_CD
            AND DTL.DS_CONTR_DTL_PK       = CDV.DS_CONTR_DTL_PK
            <iterate property="dsContrCtrlStsCdList" var="dsContrCtrlStsCd[]" open="AND CDV.DS_CONTR_CTRL_STS_CD  NOT IN (" close=")" conjunction=",">
                #dsContrCtrlStsCd[]#
            </iterate>
            AND CDV.EZCANCELFLAG          = '0'
            AND DTL.GLBL_CMPY_CD          = CDT.GLBL_CMPY_CD
            AND DTL.DS_CONTR_DTL_TP_CD    = CDT.DS_CONTR_DTL_TP_CD
            AND CDT.BASE_CHRG_FLG         = #baseChrgFlg#
            AND CDT.EZCANCELFLAG          = '0'
        ORDER BY
            DTL.DS_CONTR_DTL_PK
    </statement>
    <!-- START 2022/03/16 R.Cabral [QC#59748, ADD] -->
    <statement id="getDsContrDtlPkAgg" parameterClass="Map" resultClass="Map">
        SELECT
            DTL.DS_CONTR_DTL_PK
        FROM
            DS_CONTR_DTL           DTL
           ,DS_CONTR_DTL_STS_V     CDV
           ,DS_CONTR_DTL_TP        CDT
        WHERE
                DTL.GLBL_CMPY_CD          = #glblCmpyCd#
            AND DTL.DS_CONTR_PK           = #dsContrPk#
            <isNotNull property="dsContrDtlPk">
            AND DTL.DS_CONTR_DTL_PK       = #dsContrDtlPk#
            </isNotNull>
            AND DTL.EZCANCELFLAG          = '0'
            AND DTL.GLBL_CMPY_CD          = CDV.GLBL_CMPY_CD
            AND DTL.DS_CONTR_DTL_PK       = CDV.DS_CONTR_DTL_PK
            <iterate property="dsContrCtrlStsCdList" var="dsContrCtrlStsCd[]" open="AND CDV.DS_CONTR_CTRL_STS_CD  NOT IN (" close=")" conjunction=",">
                #dsContrCtrlStsCd[]#
            </iterate>
            AND CDV.EZCANCELFLAG          = '0'
            AND DTL.GLBL_CMPY_CD          = CDT.GLBL_CMPY_CD
            AND DTL.DS_CONTR_DTL_TP_CD    = CDT.DS_CONTR_DTL_TP_CD
            AND CDT.BASE_CHRG_FLG         = #baseChrgFlg#
            AND CDT.EZCANCELFLAG          = '0'
            AND DTL.DS_CONTR_DTL_TP_CD    = #dsContrDtlTpCd#
        ORDER BY
            DTL.DS_CONTR_DTL_PK
    </statement>
    <!-- END   2022/03/16 R.Cabral [QC#59748, ADD] -->   
    <statement id="getLeaseAcctFlg" parameterClass="Map" resultClass="String">
        SELECT
            D.LEASE_CMPY_FLG 
        FROM 
            BILL_TO_CUST A
            ,SELL_TO_CUST C
            ,DS_ACCT_CLS D
        WHERE
            A.GLBL_CMPY_CD      = #glblCmpyCd#
        AND A.BILL_TO_CUST_CD   = #billToCustCd#
        AND A.EZCANCELFLAG      = '0'
        AND A.GLBL_CMPY_CD      = C.GLBL_CMPY_CD
        AND A.SELL_TO_CUST_CD   = C.SELL_TO_CUST_CD
        AND C.EZCANCELFLAG      = '0'
        AND C.GLBL_CMPY_CD      = D.GLBL_CMPY_CD
        AND C.DS_ACCT_CLS_CD    = D.DS_ACCT_CLS_CD
        AND D.EZCANCELFLAG      = '0'
    </statement>
    <!-- START 2021/10/01 T.Wada [QC#59240, ADD] -->
    <statement id="getInvoicedTermAmountForBase" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            SUM(A.BASE_ACTL_PRC_DEAL_AMT)
        FROM
            DS_CONTR_BLLG_SCHD A
        WHERE
                A.GLBL_CMPY_CD          =   #glblCmpyCd#
            AND A.DS_CONTR_DTL_PK       =   #dsContrDtlPk#
            AND A.BASE_CHRG_FLG         =   'Y'
            AND A.INV_FLG               =   'Y'
            AND A.DS_CONTR_PRC_EFF_PK   IS  NOT NULL
            AND A.EZCANCELFLAG          =   '0'
    </statement>
    <statement id="getMinUnbilledFromDt" parameterClass="Map" resultClass="String">
        SELECT
            TO_CHAR(TO_DATE(MAX(A.BLLG_SCHD_THRU_DT),'YYYYMMDD' ) + 1 ,'YYYYMMDD')
        FROM
            DS_CONTR_BLLG_SCHD A
        WHERE
                A.GLBL_CMPY_CD    = #glblCmpyCd#
            AND A.EZCANCELFLAG    = '0'
            AND A.DS_CONTR_DTL_PK = #dsContrDtlPk#
            AND A.BASE_CHRG_FLG   = 'Y'
            AND A.INV_FLG         = 'Y'
            AND A.INV_TP_CD       = #invTpCd#
            AND A.SVC_CR_REBIL_PK IS NULL
    </statement>
    <statement id="getDtAfterMaxInvThruDt" parameterClass="Map" resultClass="String">
        SELECT
            TO_CHAR(TO_DATE(MAX(A.BLLG_SCHD_THRU_DT),'YYYYMMDD' ) + 1 ,'YYYYMMDD')
        FROM
            DS_CONTR_BLLG_SCHD A
        WHERE
                A.GLBL_CMPY_CD    = #glblCmpyCd#
            AND A.EZCANCELFLAG    = '0'
            AND A.DS_CONTR_DTL_PK = #dsContrDtlPk#
            AND A.BASE_CHRG_FLG   = 'Y'
            AND A.INV_FLG         = 'Y'
            AND A.INV_TP_CD       = #invTpCd#
            AND A.SVC_CR_REBIL_PK IS NULL
    </statement>
    <statement id="getTotalAmtOfUninvBefFinInv" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            SUM(A.BASE_ACTL_PRC_DEAL_AMT)
        FROM
            DS_CONTR_BLLG_SCHD A
        WHERE
                A.GLBL_CMPY_CD          =   #glblCmpyCd#
            AND A.DS_CONTR_DTL_PK       =   #dsContrDtlPk#
            AND A.BASE_CHRG_FLG         =   'Y'
            AND A.INV_FLG               =   'N'
            AND A.SKIP_RECOV_TP_CD      &lt;&gt;  #none#
            AND A.EZCANCELFLAG          =   '0'
            AND A.BLLG_SCHD_THRU_DT &lt;=(
                SELECT
                    MAX(A.BLLG_SCHD_THRU_DT)
                FROM
                    DS_CONTR_BLLG_SCHD A
                WHERE
                    A.GLBL_CMPY_CD    = #glblCmpyCd#
                AND A.EZCANCELFLAG    = '0'
                AND A.DS_CONTR_DTL_PK = #dsContrDtlPk#
                AND A.BASE_CHRG_FLG   = 'Y'
                AND A.INV_FLG         = 'Y'
                AND A.INV_TP_CD       = '1'
            )
    </statement>
<!-- END 2021/10/01 T.Wada [QC#59240, ADD] -->
</sqlMap>
