<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NFBB008501">

    <statement id="GET_PO_NUM" parameterClass="Map" resultClass="String">
        SELECT
            CAID.PO_NUM
        FROM
            CM_AP_INV_DTL CAID
        WHERE
            CAID.GLBL_CMPY_CD       =  #glblCmpyCd#
        AND CAID.AP_VND_CD          =  #apVndCd#
        AND CAID.AP_VND_INV_NUM     =  #apVndInvNum#
        AND CAID.AP_VND_INV_SQ_NUM  =  #apVndInvSqNum#
        AND CAID.EZCANCELFLAG       =  '0'
        GROUP BY
            CAID.PO_NUM
    </statement>


    <statement id="SELECT_OPEN_AP_HDR_RECORD" parameterClass="Map">
        SELECT
            TO_CHAR($cmProcDd$ + ROW_NUMBER() OVER (PARTITION BY CAIH.GLBL_CMPY_CD ORDER BY CAIH.AP_VND_CD,CAIH.AP_VND_INV_NUM,CAIH.AP_VND_INV_SQ_NUM),'FM00000000') AP_INV_ID
        ,   CAIH.AP_VND_CD
        ,   CAIH.AP_VND_INV_NUM
        ,   CAIH.AP_VND_INV_SQ_NUM
        <!-- start 2016/10/25 QC#14501 MOD -->
        ,   CAIH.INV_AUTH_DT
        <!-- end   2016/10/25 QC#14501 MOD -->
        ,   CAIH.AC_INV_TOT_COST_AMT
        ,   CAIH.AP_INV_SRC_NM
        ,   CAIH.AP_INV_DESC_TXT
        ,   CAIH.VND_PMT_TERM_CD
        ,   CAIH.ACCT_BANK_CD
        ,   CAIH.ACCT_BANK_ACCT_PAY_TP_CD
        ,   CAIH.PMT_DUE_DT
        <!-- start 2016/09/30 QC#14874 MOD -->
        ,   GLCM.STD_CCY_CD                  CCY_CD
        <!-- end 2016/09/30 QC#14874 MOD -->
        ,   CIAD.EXCH_RATE                   ACTL_EXCH_RATE
        ,   CIAD.CR_COA_CMPY_CD              COA_CMPY_CD
        ,   CIAD.CR_COA_BR_CD                COA_BR_CD
        ,   CIAD.CR_COA_CC_CD                COA_CC_CD
        ,   CIAD.CR_COA_ACCT_CD              COA_ACCT_CD
        ,   CIAD.CR_COA_PROD_CD              COA_PROD_CD
        ,   CIAD.CR_COA_CH_CD                COA_CH_CD
        ,   CIAD.CR_COA_AFFL_CD              COA_AFFL_CD
        ,   CIAD.CR_COA_PROJ_CD              COA_PROJ_CD
        ,   CIAD.CR_COA_EXTN_CD              COA_EXTN_CD
        <!-- start 2018/05/31 QC#26158 ADD -->
        ,   CAIH.PAY_ALONE_FLG
        <!-- end 2018/05/31 QC#26158 ADD -->
        <!-- start 2018/09/05 QC#28040 ADD -->
        ,   CAIH.INV_HDR_DESC_TXT
        <!-- end 2018/09/05 QC#28040 ADD -->
        ,   CAIH.INV_DT
        <!-- START 2019/08/28 S.Takami [QC#52946,ADD] -->
        ,   CAIH.PO_NUM
        <!-- END 2019/08/28 S.Takami [QC#52946,ADD] -->

        FROM
            CM_AP_INV_HDR     CAIH
        ,   (
                SELECT
                    CIAD.AP_VND_CD
                ,   CIAD.AP_VND_INV_NUM
                ,   CIAD.AP_VND_INV_SQ_NUM
                ,   MIN(NVL(CIAD.EXCH_RATE,0)) EXCH_RATE
                ,   CIAD.CR_COA_CMPY_CD          CR_COA_CMPY_CD
                ,   CIAD.CR_COA_BR_CD            CR_COA_BR_CD
                ,   CIAD.CR_COA_CC_CD            CR_COA_CC_CD
                ,   CIAD.CR_COA_ACCT_CD          CR_COA_ACCT_CD
                ,   CIAD.CR_COA_PROD_CD          CR_COA_PROD_CD
                ,   CIAD.CR_COA_CH_CD            CR_COA_CH_CD
                ,   CIAD.CR_COA_AFFL_CD          CR_COA_AFFL_CD
                ,   CIAD.CR_COA_PROJ_CD          CR_COA_PROJ_CD
                ,   CIAD.CR_COA_EXTN_CD          CR_COA_EXTN_CD
                FROM
                    CM_INV_ACCT_DIST     CIAD
                WHERE
                    CIAD.GLBL_CMPY_CD = #glblCmpyCd#
                AND CIAD.EZCANCELFLAG = '0'
                AND EXISTS
                        (
                            SELECT
                                1
                            FROM
                                CM_AP_INV_HDR CAIH
                            WHERE
                                CAIH.GLBL_CMPY_CD      = CIAD.GLBL_CMPY_CD
                            AND CAIH.AP_VND_CD         = CIAD.AP_VND_CD
                            AND CAIH.AP_VND_INV_NUM    = CIAD.AP_VND_INV_NUM
                            AND CAIH.AP_VND_INV_SQ_NUM = CIAD.AP_VND_INV_SQ_NUM
                            AND CAIH.ACCT_INV_STS_CD   IN (#acctInvStsCd_20#,#acctInvStsCd_21#)
                            AND CAIH.EZCANCELFLAG      = '0'
                        )
                GROUP BY
                    CIAD.AP_VND_CD
                ,   CIAD.AP_VND_INV_NUM
                ,   CIAD.AP_VND_INV_SQ_NUM
                ,   CIAD.CR_COA_CMPY_CD
                ,   CIAD.CR_COA_BR_CD
                ,   CIAD.CR_COA_CC_CD
                ,   CIAD.CR_COA_ACCT_CD
                ,   CIAD.CR_COA_PROD_CD
                ,   CIAD.CR_COA_CH_CD
                ,   CIAD.CR_COA_AFFL_CD
                ,   CIAD.CR_COA_PROJ_CD
                ,   CIAD.CR_COA_EXTN_CD
            )                   CIAD
        <!-- start 2016/09/30 QC#14874 ADD -->
        ,   GLBL_CMPY           GLCM
        <!-- end 2016/09/30 QC#14874 ADD -->
        WHERE
            CAIH.GLBL_CMPY_CD       =  #glblCmpyCd#
        AND CAIH.ACCT_INV_STS_CD    IN (#acctInvStsCd_20#,#acctInvStsCd_21#)
        AND CAIH.EZCANCELFLAG       =  '0'
        AND CAIH.AP_VND_CD          =  CIAD.AP_VND_CD
        AND CAIH.AP_VND_INV_NUM     =  CIAD.AP_VND_INV_NUM
        AND CAIH.AP_VND_INV_SQ_NUM  =  CIAD.AP_VND_INV_SQ_NUM
        <!-- start 2016/09/30 QC#14874 ADD -->
        AND CAIH.GLBL_CMPY_CD       =  GLCM.GLBL_CMPY_CD
        AND GLCM.EZCANCELFLAG       =  '0'
        <!-- end 2016/09/30 QC#14874 ADD -->
        ORDER BY
            CAIH.AP_VND_CD
        ,   CAIH.AP_VND_INV_NUM
        ,   CAIH.AP_VND_INV_SQ_NUM
    </statement>
<!-- QC#20316(Sol#202) END-->

    <statement id="SELECT_OPEN_AP_DTL_RECORD" parameterClass="Map">
        SELECT
            CIAD.AP_VND_CD
        ,   CIAD.AP_VND_INV_NUM
        ,   CIAD.AP_VND_INV_SQ_NUM
<!-- QC#20316(Sol#202) START-->
        ,   CIAD.AP_VND_INV_LINE_NUM
        ,   CIAD.CM_INV_ACCT_DIST_LINE_NUM
<!-- QC#20316(Sol#202) END-->
        ,   #remSqNum#                REM_SQ_NUM
        ,   #vndInvSqNum#             VND_INV_SQ_NUM
<!-- START 2019/09/10 S.Takami [QC#53324,DEL -->
<!--         ,   TO_CHAR(ROW_NUMBER() OVER (PARTITION BY CIAD.GLBL_CMPY_CD,CIAD.AP_VND_CD,CIAD.AP_VND_INV_NUM,CIAD.AP_VND_INV_SQ_NUM -->
<!-- QC#20316(Sol#202) START-->
<!--             ORDER BY CIAD.AP_VND_INV_LINE_NUM),'FM00000') --> 
<!-- QC#20316(Sol#202) END-->
<!-- END 2019/09/10 S.Takami [QC#53324,DEL -->
<!-- START 2019/09/10 S.Takami [QC#53324,ADD -->
        ,   LTRIM(CIAD.AP_VND_INV_LINE_NUM, '0') || LTRIM(CIAD.CM_INV_ACCT_DIST_LINE_NUM, '0')
<!-- END 2019/09/10 S.Takami [QC#53324,ADD] -->
                                      AP_INV_LINE_NUM
        <!-- START 2024/03/01 S.Fujita [QC#63580,MOD] -->
        <!-- ,   CIAD.AP_INV_DESC_TXT      AP_INV_DESC_TXT -->
        ,   NVL(SUBSTR(CAID.MDSE_DESC_SHORT_TXT, 1, 32), ALT.AP_LINE_TP_DESC_TXT)    AP_INV_DESC_TXT
        <!-- END 2024/03/01 S.Fujita [QC#63580,MOD] -->
        ,   CIAD.AC_INV_JRNL_COST_AMT AC_INV_JRNL_COST_AMT
<!-- QC#20316(Sol#202) START-->
        ,   CIAD.DR_COA_CMPY_CD          DR_COA_CMPY_CD
        ,   CIAD.DR_COA_BR_CD            DR_COA_BR_CD
        ,   CIAD.DR_COA_CC_CD            DR_COA_CC_CD
        ,   CIAD.DR_COA_ACCT_CD          DR_COA_ACCT_CD
        ,   CIAD.DR_COA_PROD_CD          DR_COA_PROD_CD
        ,   CIAD.DR_COA_CH_CD            DR_COA_CH_CD
        ,   CIAD.DR_COA_AFFL_CD          DR_COA_AFFL_CD
        ,   CIAD.DR_COA_PROJ_CD          DR_COA_PROJ_CD
        ,   CIAD.DR_COA_EXTN_CD          DR_COA_EXTN_CD
<!-- QC#20316(Sol#202) END-->
        FROM
            CM_INV_ACCT_DIST     CIAD
            <!-- START 2024/03/01 S.Fujita [QC#63580,ADD] -->
           ,CM_AP_INV_DTL        CAID
           ,AP_LINE_TP           ALT
            <!-- END 2024/03/01 S.Fujita [QC#63580,ADD] -->
        WHERE
            CIAD.GLBL_CMPY_CD       =  #glblCmpyCd#
        AND CIAD.EZCANCELFLAG       =  '0'
        AND EXISTS
                (
                    SELECT
                        1
                    FROM
                        CM_AP_INV_HDR     CAIH
                    WHERE
                        CAIH.GLBL_CMPY_CD      =  CIAD.GLBL_CMPY_CD
                    AND CAIH.AP_VND_CD         =  CIAD.AP_VND_CD
                    AND CAIH.AP_VND_INV_NUM    =  CIAD.AP_VND_INV_NUM
                    AND CAIH.AP_VND_INV_SQ_NUM =  CIAD.AP_VND_INV_SQ_NUM
                    AND CAIH.ACCT_INV_STS_CD   IN (#acctInvStsCd_20#,#acctInvStsCd_21#)
                    AND CAIH.EZCANCELFLAG      =  '0'
                )
        <!-- START 2024/03/01 S.Fujita [QC#63580,ADD] -->
        AND CIAD.GLBL_CMPY_CD                   =     CAID.GLBL_CMPY_CD(+)
        AND CIAD.AP_VND_CD                      =     CAID.AP_VND_CD(+)
        AND CIAD.AP_VND_INV_NUM                 =     CAID.AP_VND_INV_NUM(+)
        AND CIAD.AP_VND_INV_SQ_NUM              =     CAID.AP_VND_INV_SQ_NUM(+)
        AND CIAD.AP_VND_INV_LINE_NUM            =     CAID.AP_VND_INV_LINE_NUM(+)
        AND CAID.EZCANCELFLAG(+)                =     '0'
        AND CIAD.GLBL_CMPY_CD                   =     ALT.GLBL_CMPY_CD(+)
        AND CIAD.AP_LINE_TP_CD                  =     ALT.AP_LINE_TP_CD(+)
        AND ALT.EZCANCELFLAG(+)                 =     '0'
        <!-- END 2024/03/01 S.Fujita [QC#63580,ADD] -->
        ORDER BY
            CIAD.AP_VND_CD
        ,   CIAD.AP_VND_INV_NUM
        ,   CIAD.AP_VND_INV_SQ_NUM
        ,   CIAD.AP_VND_INV_LINE_NUM
<!-- QC#20316(Sol#202) END-->
    </statement>
    
<!-- QC#20316(Sol#202) START-->
    <statement id="SELECT_CM_AP_INV_HDR_RECORD_FOR_UPDATE" parameterClass="Map">
        SELECT
            CAIH.AP_VND_CD
        ,   CAIH.AP_VND_INV_NUM
        ,   CAIH.AP_VND_INV_SQ_NUM
        FROM
            CM_AP_INV_HDR     CAIH
        WHERE
            CAIH.GLBL_CMPY_CD       =  #glblCmpyCd#
        AND CAIH.ACCT_INV_STS_CD    IN (#acctInvStsCd_20#,#acctInvStsCd_21#)
        AND CAIH.EZCANCELFLAG       =  '0'
        ORDER BY
            CAIH.AP_VND_CD
        ,   CAIH.AP_VND_INV_NUM
        ,   CAIH.AP_VND_INV_SQ_NUM
<!-- QC#20316(Sol#202) END-->
    </statement>

</sqlMap>
