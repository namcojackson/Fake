<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NLCB202001">
    <statement id="getDemandInfo" parameterClass="Map">
        WITH
            DMDD_INFO AS (
                <!-- CPO (Saved Status) -->
                SELECT DISTINCT
                    SUM(ORD_QTY) VIS_QTY
                   ,MDSE_CD
                   ,WH_RG_CD
                   ,INP_SRC_CD
                   ,MAT_ORD_DT
                   ,MAT_ORD_TM
                   ,MAT_SHIP_QTY
                   ,MAT_SHIP_DT
                   ,MAT_SHIP_TM
                   ,MAT_REQ_DT
                   ,MAT_REQ_TM
                   ,MAT_RCV_DT
                   ,MAT_RCV_TM
                   ,DMND_INFO_ID
                   ,CUST_ORD_ID
                   ,SER_NUM
                   ,DELY_POST_CD
                   ,DELY_CTRY_CD
                   ,DELY_CTY_ADDR
                   ,DELY_ST_CD
                   ,DELY_CUST_NM
                   ,TRX_TP_CD
                   ,DMND_RSP_COMIT_CD
                   ,COV_DAYS_NUM
                   ,COV_HOURS_NUM
                   ,MAJ_ACCT_ID
                   ,DMND_PRTY_CD
                   ,DMND_PROD_CD
                   ,SPEC_RG_CD
                   ,SPEC_SITE_CD
                   ,SHIP_FROM_RG_CD
                   ,SHIP_FROM_SITE_CD
                   ,SHIP_TO_RG_CD
                   ,SHIP_TO_SITE_CD
                   ,NTWK_CONFIG_NM
                   ,CUST_RPT_HIT_FLG
                FROM (
                    SELECT DISTINCT
                        CASE
                            WHEN CPD.ORD_LINE_STS_CD = #CANCELLED# THEN 0
                            ELSE CPD.ORD_QTY
                        END AS ORD_QTY
                       ,CPD.MDSE_CD
                       ,#WH_RG_CD# AS WH_RG_CD
                       ,#S21# AS INP_SRC_CD
                       ,SUBSTR(CPO.DS_CPO_CRAT_TS, 0, 8) AS MAT_ORD_DT
                       ,SUBSTR(CPO.DS_CPO_CRAT_TS, 9, 6) AS MAT_ORD_TM
                       ,CASE
                           WHEN CPD.ORD_LINE_STS_CD = #CANCELLED# THEN 0
                           ELSE CPD.SHIP_QTY
                       END AS MAT_SHIP_QTY
                       ,NULL AS MAT_SHIP_DT
                       ,NULL AS MAT_SHIP_TM
                       ,NULL AS MAT_REQ_DT
                       ,NULL AS MAT_REQ_TM
                       ,NULL AS MAT_RCV_DT
                       ,NULL AS MAT_RCV_TM
                       ,CPD.CPO_ORD_NUM || #hyphen# || CPD.CPO_DTL_LINE_NUM || #hyphen# || CPD.CPO_DTL_LINE_SUB_NUM AS DMND_INFO_ID
                       ,NULL AS CUST_ORD_ID
                       ,CPD.SER_NUM
                       ,SUBSTR(CPD.SHIP_TO_POST_CD, 1,10) AS DELY_POST_CD
                       ,SUBSTR(CPD.SHIP_TO_CTRY_CD, 1,2) AS DELY_CTRY_CD
                       ,SUBSTR(CPD.SHIP_TO_CTY_ADDR, 1,20) AS DELY_CTY_ADDR
                       ,CPD.SHIP_TO_ST_CD AS DELY_ST_CD
                       ,SUBSTR(CPD.SHIP_TO_LOC_NM, 1,20) AS DELY_CUST_NM
                       ,#SO# AS TRX_TP_CD
                       ,CASE
                            WHEN CPD.SER_NUM IS NOT NULL
                                THEN(SELECT
                                         TO_CHAR(DM.RSP_TM_DOWN_MN_AOT / 60) || 'H'
                                     FROM
                                         DS_MDL          DM
                                        ,SVC_MACH_MSTR   SMM
                                        ,SVC_CONFIG_MSTR SCM
                                     WHERE
                                         DM.GLBL_CMPY_CD        = #GLBL_CMPY_CD#
                                     AND DM.MDL_ID              = SCM.MDL_ID
                                     AND DM.EZCANCELFLAG        = '0'
                                     AND SMM.GLBL_CMPY_CD       = DM.GLBL_CMPY_CD
                                     AND SMM.SER_NUM            = CPD.SER_NUM
                                     AND SMM.EZCANCELFLAG       = '0'
                                     AND SCM.GLBL_CMPY_CD       = SMM.GLBL_CMPY_CD
                                     AND SCM.SVC_CONFIG_MSTR_PK = SMM.SVC_CONFIG_MSTR_PK
                                     AND SCM.EZCANCELFLAG       = '0'
                                     AND ROWNUM                 = 1)  
                                ELSE NULL
                        END AS DMND_RSP_COMIT_CD
                       ,NULL AS COV_DAYS_NUM
                       ,NULL AS COV_HOURS_NUM
                       ,NULL AS MAJ_ACCT_ID
                       ,CASE
                           WHEN CPD.SER_NUM IS NOT NULL
                           THEN (SELECT
                                     SUBSTR(A.AHS_CD, 1, 10)
                                 FROM
                                     SVC_TERM_COND STC
                                    ,AHS           A
                                    ,DS_CONTR_DTL  CD
                                    ,SVC_MACH_MSTR SMM
                                 WHERE
                                     STC.GLBL_CMPY_CD           = #GLBL_CMPY_CD#
                                 AND STC.SVC_TERM_COND_ATTRB_PK = #SVC_TERM_COND_ATTRB_PK#
                                 AND STC.EZCANCELFLAG           = '0'
                                 AND A.GLBL_CMPY_CD             = STC.GLBL_CMPY_CD
                                 AND A.AHS_CD                   = STC.SVC_TERM_ATTRB_MAP_VAL_CD
                                 AND A.EZCANCELFLAG             = '0'
                                 AND CD.GLBL_CMPY_CD            = STC.GLBL_CMPY_CD
                                 AND CD.DS_CONTR_DTL_PK         = STC.DS_CONTR_DTL_PK
                                 AND CD.EZCANCELFLAG            = '0'
                                 AND SMM.GLBL_CMPY_CD           = CD.GLBL_CMPY_CD
                                 AND SMM.SVC_MACH_MSTR_PK       = CD.SVC_MACH_MSTR_PK
                                 AND SMM.SER_NUM                = CPD.SER_NUM
                                 AND SMM.EZCANCELFLAG           = '0'
                                 AND ROWNUM                     = 1)
                           ELSE NULL
                       END AS DMND_PRTY_CD
                       ,CASE
                           WHEN CPD.SVC_CONFIG_MSTR_PK IS NOT NULL 
                           THEN MN.T_MDL_NM
                           ELSE NULL
                       END DMND_PROD_CD
                       ,NULL AS SPEC_RG_CD
                       ,NULL AS SPEC_SITE_CD
                       ,NULL AS SHIP_FROM_RG_CD
                       ,CPD.RTL_WH_CD AS SHIP_FROM_SITE_CD
                       ,NULL AS SHIP_TO_RG_CD
                       ,NULL AS SHIP_TO_SITE_CD
                       ,NULL AS NTWK_CONFIG_NM
                       ,NULL AS CUST_RPT_HIT_FLG
                       ,CPD.DS_ORD_POSN_NUM
                       ,CPD.DS_CPO_LINE_NUM
                       ,CPD.DS_CPO_LINE_SUB_NUM
                    FROM
                        CPO_DTL             CPD
                       ,CPO                 CPO
                       ,CPO_ORD_TP          COT
                       ,ORD_HDR_DPLY_STS    HDS
                       ,MDSE                M
                       ,MDL_NM              MN
                       ,SVC_CONFIG_MSTR     SCM
                       ,(SELECT
                             MDSE.GLBL_CMPY_CD
                            ,MDSE.MDSE_CD
                         FROM
                             MDSE          MDSE
                            ,MDSE_ITEM_STS MT
                            ,CPO_DTL       CPD
                         WHERE
                             MDSE.GLBL_CMPY_CD      = #GLBL_CMPY_CD#
                         AND MDSE.MDSE_CD           LIKE CONCAT (CPD.MDSE_CD, '%')
                         AND MDSE.GLBL_CMPY_CD      = MT.GLBL_CMPY_CD
                         AND MDSE.MDSE_ITEM_STS_CD  = MT.MDSE_ITEM_STS_CD
                         AND MDSE.GLBL_CMPY_CD      = CPD.GLBL_CMPY_CD
                         AND MDSE.MDSE_CD           = CPD.MDSE_CD
                         AND MT.PRCH_PLN_AVAL_FLG   = #FLG_ON_Y#
                         AND MDSE.EZCANCELFLAG      = '0'
                         AND MT.EZCANCELFLAG        = '0'
                         AND CPD.EZCANCELFLAG       = '0'
                        ) MD
                    WHERE
                        CPD.GLBL_CMPY_CD          = #GLBL_CMPY_CD#
                    AND CPD.EZCANCELFLAG          = '0'
                    AND CPD.STK_STS_CD            = #GOOD#
                    AND CPD.SHIP_TO_CTRY_CD       = #US#
                    AND CPD.RTL_SWH_CD            IS NOT NULL
                    AND SUBSTR(CPD.EZUPTIME, 1, 8) BETWEEN TO_CHAR(SYSDATE - 7, 'YYYYMMDD') AND TO_CHAR(SYSDATE, 'YYYYMMDD')
                    AND CPD.GLBL_CMPY_CD          = CPO.GLBL_CMPY_CD
                    AND CPD.CPO_ORD_NUM           = CPO.CPO_ORD_NUM
                    AND CPO.ORD_HDR_DPLY_STS_CD   &lt; #ORD_HDR_DPLY_STS_BOOK#
                    AND CPO.DS_ORD_TP_CD NOT IN   (#INVENTORY_TRANSFER#)
                    <!-- START 2022/05/25 F.Fadriquela [QC#60051 ADD] -->
                    <iterate property="DS_ORD_CATG_CD" var="DS_ORD_CATG_CD[]"
                    open="AND CPO.DS_ORD_CATG_CD IN   (" conjunction=", " close=")"> #DS_ORD_CATG_CD[]#
                    </iterate>
                    <!-- END 2022/05/25 F.Fadriquela [QC#60051, ADD] -->
                    AND CPO.EZCANCELFLAG          = '0'
                    AND CPD.GLBL_CMPY_CD          = COT.GLBL_CMPY_CD
                    AND CPD.CPO_ORD_TP_CD         = COT.CPO_ORD_TP_CD
                    AND COT.EZCANCELFLAG          = '0'
                    AND CPO.GLBL_CMPY_CD          = HDS.GLBL_CMPY_CD
                    AND CPO.ORD_HDR_DPLY_STS_CD   = HDS.ORD_HDR_DPLY_STS_CD
                    AND HDS.EZCANCELFLAG          = '0'
                    AND M.GLBL_CMPY_CD            = CPD.GLBL_CMPY_CD
                    AND M.GLBL_CMPY_CD            = MD.GLBL_CMPY_CD
                    AND M.MDSE_CD                 = CPD.MDSE_CD
                    AND M.MDSE_CD                 = MD.MDSE_CD
                    AND M.EXP_ITEM_FLG            &lt;&gt; #FLG_ON_Y#
                    <iterate property="MDSE_ITEM_STS_CD" var="MDSE_ITEM_STS_CD[]"
                    open="AND M.MDSE_ITEM_STS_CD IN   (" conjunction=", " close=")"> #MDSE_ITEM_STS_CD[]#
                    </iterate>
                    <iterate property="MDSE_ITEM_TP_CD" var="MDSE_ITEM_TP_CD[]"
                    open="AND M.MDSE_ITEM_TP_CD IN   (" conjunction=", " close=")"> #MDSE_ITEM_TP_CD[]#
                    </iterate>
                    AND M.MDSE_ITEM_CLS_TP_CD     = #MDSE_ITEM_CLS_TP_OCEOEM#
                    AND M.EZCANCELFLAG            = '0'
                    AND SCM.GLBL_CMPY_CD(+)       = CPD.GLBL_CMPY_CD
                    AND SCM.SVC_CONFIG_MSTR_PK(+) = CPD.SVC_CONFIG_MSTR_PK
                    AND SCM.EZCANCELFLAG(+)       = '0'
                    AND MN.T_GLBL_CMPY_CD(+)      = SCM.GLBL_CMPY_CD
                    AND MN.T_MDL_ID(+)            = SCM.MDL_ID
                    AND MN.EZCANCELFLAG(+)        = '0'
                )
                GROUP BY
                    MDSE_CD
                   ,WH_RG_CD
                   ,INP_SRC_CD
                   ,MAT_ORD_DT
                   ,MAT_ORD_TM
                   ,MAT_SHIP_QTY
                   ,MAT_SHIP_DT
                   ,MAT_SHIP_TM
                   ,MAT_REQ_DT
                   ,MAT_REQ_TM
                   ,MAT_RCV_DT
                   ,MAT_RCV_TM
                   ,DMND_INFO_ID
                   ,CUST_ORD_ID
                   ,SER_NUM
                   ,DELY_POST_CD
                   ,DELY_CTRY_CD
                   ,DELY_CTY_ADDR
                   ,DELY_ST_CD
                   ,DELY_CUST_NM
                   ,TRX_TP_CD
                   ,DMND_RSP_COMIT_CD
                   ,COV_DAYS_NUM
                   ,COV_HOURS_NUM
                   ,MAJ_ACCT_ID
                   ,DMND_PRTY_CD
                   ,DMND_PROD_CD
                   ,SPEC_RG_CD
                   ,SPEC_SITE_CD
                   ,SHIP_FROM_RG_CD
                   ,SHIP_FROM_SITE_CD
                   ,SHIP_TO_RG_CD
                   ,SHIP_TO_SITE_CD
                   ,NTWK_CONFIG_NM
                   ,CUST_RPT_HIT_FLG
                <!-- CPO (Booked Status, Before Allocation) -->
                UNION ALL
                SELECT DISTINCT
                    SUM(ORD_QTY) VIS_QTY
                   ,MDSE_CD
                   ,WH_RG_CD
                   ,INP_SRC_CD
                   ,MAT_ORD_DT
                   ,MAT_ORD_TM
                   ,MAT_SHIP_QTY
                   ,MAT_SHIP_DT
                   ,MAT_SHIP_TM
                   ,MAT_REQ_DT
                   ,MAT_REQ_TM
                   ,MAT_RCV_DT
                   ,MAT_RCV_TM
                   ,DMND_INFO_ID
                   ,CUST_ORD_ID
                   ,SER_NUM
                   ,DELY_POST_CD
                   ,DELY_CTRY_CD
                   ,DELY_CTY_ADDR
                   ,DELY_ST_CD
                   ,DELY_CUST_NM
                   ,TRX_TP_CD
                   ,DMND_RSP_COMIT_CD
                   ,COV_DAYS_NUM
                   ,COV_HOURS_NUM
                   ,MAJ_ACCT_ID
                   ,DMND_PRTY_CD
                   ,DMND_PROD_CD
                   ,SPEC_RG_CD
                   ,SPEC_SITE_CD
                   ,SHIP_FROM_RG_CD
                   ,SHIP_FROM_SITE_CD
                   ,SHIP_TO_RG_CD
                   ,SHIP_TO_SITE_CD
                   ,NTWK_CONFIG_NM
                   ,CUST_RPT_HIT_FLG
                FROM (
                    SELECT DISTINCT
                        CASE
                            WHEN CPD.ORD_LINE_STS_CD = #CANCELLED# THEN 0
                            ELSE SHP.ORD_QTY
                        END AS ORD_QTY
                       ,SHP.MDSE_CD
                       ,#WH_RG_CD# AS WH_RG_CD
                       ,#S21# AS INP_SRC_CD
                       ,SUBSTR(CPD.CPO_ORD_SUBMT_TS, 0, 8) AS MAT_ORD_DT
                       ,SUBSTR(CPD.CPO_ORD_SUBMT_TS, 9, 6) AS MAT_ORD_TM
                       ,CASE
                           WHEN CPD.ORD_LINE_STS_CD = #CANCELLED# THEN 0
                           ELSE CPD.SHIP_QTY
                       END AS MAT_SHIP_QTY
                       ,NULL AS MAT_SHIP_DT
                       ,NULL AS MAT_SHIP_TM
                       ,NULL AS MAT_REQ_DT
                       ,NULL AS MAT_REQ_TM
                       ,NULL AS MAT_RCV_DT
                       ,NULL AS MAT_RCV_TM
                       ,CPD.CPO_ORD_NUM || #hyphen# || CPD.CPO_DTL_LINE_NUM || #hyphen# || CPD.CPO_DTL_LINE_SUB_NUM AS DMND_INFO_ID
                       ,NULL AS CUST_ORD_ID
                       ,CPD.SER_NUM
                       ,SUBSTR(CPD.SHIP_TO_POST_CD, 1,10) AS DELY_POST_CD
                       ,SUBSTR(CPD.SHIP_TO_CTRY_CD, 1,2) AS DELY_CTRY_CD
                       ,SUBSTR(CPD.SHIP_TO_CTY_ADDR, 1,20) AS DELY_CTY_ADDR
                       ,CPD.SHIP_TO_ST_CD AS DELY_ST_CD
                       ,SUBSTR(CPD.SHIP_TO_LOC_NM, 1,20) AS DELY_CUST_NM
                       ,#SO# AS TRX_TP_CD
                       ,CASE
                            WHEN CPD.SER_NUM IS NOT NULL
                            THEN(SELECT
                                     TO_CHAR(DM.RSP_TM_DOWN_MN_AOT / 60) || 'H'
                                 FROM
                                     DS_MDL DM
                                    ,SVC_MACH_MSTR SMM
                                    ,SVC_CONFIG_MSTR SCM
                                 WHERE
                                     DM.GLBL_CMPY_CD        = #GLBL_CMPY_CD#
                                 AND DM.MDL_ID              = SCM.MDL_ID
                                 AND DM.EZCANCELFLAG        = '0'
                                 AND SMM.GLBL_CMPY_CD       = DM.GLBL_CMPY_CD
                                 AND SMM.SER_NUM            = CPD.SER_NUM
                                 AND SMM.EZCANCELFLAG       = '0'
                                 AND SCM.GLBL_CMPY_CD       = SMM.GLBL_CMPY_CD
                                 AND SCM.SVC_CONFIG_MSTR_PK = SMM.SVC_CONFIG_MSTR_PK
                                 AND SCM.EZCANCELFLAG       = '0'
                                 AND ROWNUM                 = 1)  
                            ELSE NULL
                       END AS DMND_RSP_COMIT_CD
                       ,NULL AS COV_DAYS_NUM
                       ,NULL AS COV_HOURS_NUM
                       ,NULL AS MAJ_ACCT_ID
                       ,CASE
                           WHEN CPD.SER_NUM IS NOT NULL
                           THEN (SELECT
                                     SUBSTR(A.AHS_CD, 1, 10)
                                 FROM
                                     SVC_TERM_COND STC
                                    ,AHS           A
                                    ,DS_CONTR_DTL  CD
                                    ,SVC_MACH_MSTR SMM
                                 WHERE
                                     STC.GLBL_CMPY_CD           = #GLBL_CMPY_CD#
                                 AND STC.SVC_TERM_COND_ATTRB_PK = #SVC_TERM_COND_ATTRB_PK#
                                 AND STC.EZCANCELFLAG           = '0'
                                 AND A.GLBL_CMPY_CD             = STC.GLBL_CMPY_CD
                                 AND A.AHS_CD                   = STC.SVC_TERM_ATTRB_MAP_VAL_CD
                                 AND A.EZCANCELFLAG             = '0'
                                 AND CD.GLBL_CMPY_CD            = STC.GLBL_CMPY_CD
                                 AND CD.DS_CONTR_DTL_PK         = STC.DS_CONTR_DTL_PK
                                 AND CD.EZCANCELFLAG            = '0'
                                 AND SMM.GLBL_CMPY_CD           = CD.GLBL_CMPY_CD
                                 AND SMM.SVC_MACH_MSTR_PK       = CD.SVC_MACH_MSTR_PK
                                 AND SMM.SER_NUM                = CPD.SER_NUM
                                 AND SMM.EZCANCELFLAG           = '0'
                                 AND ROWNUM                     = 1)
                           ELSE NULL
                       END AS DMND_PRTY_CD
                       ,CASE
                           WHEN CPD.SVC_CONFIG_MSTR_PK IS NOT NULL 
                           THEN MN.T_MDL_NM
                           ELSE NULL
                       END DMND_PROD_CD
                       ,NULL AS SPEC_RG_CD
                       ,NULL AS SPEC_SITE_CD
                       ,NULL AS SHIP_FROM_RG_CD
                       ,CPD.RTL_WH_CD AS SHIP_FROM_SITE_CD
                       ,NULL AS SHIP_TO_RG_CD
                       ,NULL AS SHIP_TO_SITE_CD
                       ,NULL AS NTWK_CONFIG_NM
                       ,NULL AS CUST_RPT_HIT_FLG
                       ,CPD.DS_ORD_POSN_NUM
                       ,CPD.DS_CPO_LINE_NUM
                       ,CPD.DS_CPO_LINE_SUB_NUM
                    FROM
                        SHPG_PLN          SHP
                       ,CPO_DTL           CPD
                       ,CPO               CPO
                       ,CPO_ORD_TP        COT
                       ,ORD_HDR_DPLY_STS  HDS
                       ,SHPG_STS          SS
                       ,(SELECT
                            P.GLBL_CMPY_CD
                           ,P.SO_NUM
                           ,P.SO_SLP_NUM
                           ,P.PKT_STS_TS
                         FROM
                            PKT P
                            ,(SELECT
                                  MP.GLBL_CMPY_CD
                                 ,MP.SO_NUM
                                 ,MP.SO_SLP_NUM
                                 ,MAX(MP.PKT_SQ_NUM) MAX_PKT_SQ_NUM
                              FROM
                                  PKT MP
                              WHERE
                                  MP.EZCANCELFLAG = '0'
                              GROUP BY
                                  MP.GLBL_CMPY_CD
                                 ,MP.SO_NUM
                                 ,MP.SO_SLP_NUM
                             ) M
                         WHERE
                             P.GLBL_CMPY_CD = M.GLBL_CMPY_CD
                         AND P.SO_NUM       = M.SO_NUM
                         AND P.SO_SLP_NUM   = M.SO_SLP_NUM
                         AND P.PKT_SQ_NUM   = M.MAX_PKT_SQ_NUM
                        ) PKT
                       ,MDSE                M
                       ,MDL_NM              MN
                       ,SVC_CONFIG_MSTR     SCM
                       ,(SELECT
                             MDSE.MDSE_CD
                            ,MDSE.GLBL_CMPY_CD
                         FROM
                             MDSE MDSE
                            ,MDSE_ITEM_STS MT
                            ,SHPG_PLN SHP
                         WHERE
                             MDSE.GLBL_CMPY_CD      = #GLBL_CMPY_CD#
                         AND MDSE.MDSE_CD           LIKE CONCAT (SHP.MDSE_CD, '%')
                         AND MDSE.GLBL_CMPY_CD      = MT.GLBL_CMPY_CD
                         AND MDSE.MDSE_ITEM_STS_CD  = MT.MDSE_ITEM_STS_CD
                         AND MDSE.GLBL_CMPY_CD      = SHP.GLBL_CMPY_CD
                         AND MDSE.MDSE_CD           = SHP.MDSE_CD
                         AND MT.PRCH_PLN_AVAL_FLG   = #FLG_ON_Y#
                         AND MDSE.EZCANCELFLAG      = '0'
                         AND MT.EZCANCELFLAG        = '0'
                         AND SHP.EZCANCELFLAG       = '0'
                        ) MD
                    WHERE
                        SHP.GLBL_CMPY_CD          = #GLBL_CMPY_CD#
                    AND SHP.EZCANCELFLAG          = '0'
                    <!-- START 2021/11/16 [QC#58989-2,DEL] -->
                    <!-- AND SHP.SHPG_STS_CD BETWEEN #VALIDATED# AND #INSHED# -->
                    <!-- END   2021/11/16 [QC#58989-2,DEL] -->
                    AND SHP.STK_STS_CD            = #GOOD#
                    AND SHP.GLBL_CMPY_CD          = CPD.GLBL_CMPY_CD
                    AND SHP.TRX_HDR_NUM           = CPD.CPO_ORD_NUM
                    AND SHP.TRX_LINE_NUM          = CPD.CPO_DTL_LINE_NUM
                    AND SHP.TRX_LINE_SUB_NUM      = CPD.CPO_DTL_LINE_SUB_NUM
                    AND CPD.EZCANCELFLAG          = '0'
                    AND CPD.SHIP_TO_CTRY_CD       = #US#
                    AND CPD.RTL_SWH_CD            IS NOT NULL
                    AND SUBSTR(CPD.EZUPTIME, 1, 8) BETWEEN TO_CHAR(SYSDATE - 7, 'YYYYMMDD') AND TO_CHAR(SYSDATE, 'YYYYMMDD')
                    AND CPD.GLBL_CMPY_CD          = CPO.GLBL_CMPY_CD
                    AND CPD.CPO_ORD_NUM           = CPO.CPO_ORD_NUM
                    AND CPO.ORD_HDR_DPLY_STS_CD   &gt;= #ORD_HDR_DPLY_STS_BOOK#
                    AND CPO.DS_ORD_TP_CD NOT IN   (#INVENTORY_TRANSFER#)
                    <!-- START 2022/05/25 F.Fadriquela [QC#60051 ADD] -->
                    <iterate property="DS_ORD_CATG_CD" var="DS_ORD_CATG_CD[]"
                    open="AND CPO.DS_ORD_CATG_CD IN   (" conjunction=", " close=")"> #DS_ORD_CATG_CD[]#
                    </iterate>
                    <!-- END 2022/05/25 F.Fadriquela [QC#60051, ADD] -->
                    AND CPO.EZCANCELFLAG          = '0'
                    AND CPD.GLBL_CMPY_CD          = COT.GLBL_CMPY_CD
                    AND CPD.CPO_ORD_TP_CD         = COT.CPO_ORD_TP_CD
                    AND COT.EZCANCELFLAG          = '0'
                    AND CPO.GLBL_CMPY_CD          = HDS.GLBL_CMPY_CD
                    AND CPO.ORD_HDR_DPLY_STS_CD   = HDS.ORD_HDR_DPLY_STS_CD
                    AND HDS.EZCANCELFLAG          = '0'
                    AND SHP.GLBL_CMPY_CD          = SS.GLBL_CMPY_CD
                    AND SHP.SHPG_STS_CD           = SS.SHPG_STS_CD
                    AND SS.EZCANCELFLAG           = '0'
                    AND SHP.GLBL_CMPY_CD          = PKT.GLBL_CMPY_CD(+)
                    AND SHP.SO_NUM                = PKT.SO_NUM(+)
                    AND SHP.SO_SLP_NUM            = PKT.SO_SLP_NUM(+)
                    AND M.GLBL_CMPY_CD            = CPD.GLBL_CMPY_CD
                    AND M.GLBL_CMPY_CD            = MD.GLBL_CMPY_CD
                    AND M.MDSE_CD                 = CPD.MDSE_CD
                    AND M.MDSE_CD                 = MD.MDSE_CD
                    AND M.EXP_ITEM_FLG            &lt;&gt; #FLG_ON_Y#
                    <iterate property="MDSE_ITEM_STS_CD" var="MDSE_ITEM_STS_CD[]"
                    open="AND M.MDSE_ITEM_STS_CD IN   (" conjunction=", " close=")"> #MDSE_ITEM_STS_CD[]#
                    </iterate>
                    <iterate property="MDSE_ITEM_TP_CD" var="MDSE_ITEM_TP_CD[]"
                    open="AND M.MDSE_ITEM_TP_CD IN   (" conjunction=", " close=")"> #MDSE_ITEM_TP_CD[]#
                    </iterate>
                    AND M.MDSE_ITEM_CLS_TP_CD     = #MDSE_ITEM_CLS_TP_OCEOEM#
                    AND M.EZCANCELFLAG            = '0'
                    AND SCM.GLBL_CMPY_CD(+)       = CPD.GLBL_CMPY_CD
                    AND SCM.SVC_CONFIG_MSTR_PK(+) = CPD.SVC_CONFIG_MSTR_PK
                    AND SCM.EZCANCELFLAG(+)       = '0'
                    AND MN.T_GLBL_CMPY_CD(+)      = SCM.GLBL_CMPY_CD
                    AND MN.T_MDL_ID(+)            = SCM.MDL_ID
                    AND MN.EZCANCELFLAG(+)        = '0'
                )
                GROUP BY
                    MDSE_CD
                   ,WH_RG_CD
                   ,INP_SRC_CD
                   ,MAT_ORD_DT
                   ,MAT_ORD_TM
                   ,MAT_SHIP_QTY
                   ,MAT_SHIP_DT
                   ,MAT_SHIP_TM
                   ,MAT_REQ_DT
                   ,MAT_REQ_TM
                   ,MAT_RCV_DT
                   ,MAT_RCV_TM
                   ,DMND_INFO_ID
                   ,CUST_ORD_ID
                   ,SER_NUM
                   ,DELY_POST_CD
                   ,DELY_CTRY_CD
                   ,DELY_CTY_ADDR
                   ,DELY_ST_CD
                   ,DELY_CUST_NM
                   ,TRX_TP_CD
                   ,DMND_RSP_COMIT_CD
                   ,COV_DAYS_NUM
                   ,COV_HOURS_NUM
                   ,MAJ_ACCT_ID
                   ,DMND_PRTY_CD
                   ,DMND_PROD_CD
                   ,SPEC_RG_CD
                   ,SPEC_SITE_CD
                   ,SHIP_FROM_RG_CD
                   ,SHIP_FROM_SITE_CD
                   ,SHIP_TO_RG_CD
                   ,SHIP_TO_SITE_CD
                   ,NTWK_CONFIG_NM
                   ,CUST_RPT_HIT_FLG
                <!-- Purchase Request (Before Insourcing) -->
                UNION ALL
                SELECT DISTINCT
                    SUM(PRCH_REQ_BAL_QTY) VIS_QTY
                   ,MDSE_CD
                   ,WH_RG_CD
                   ,INP_SRC_CD
                   ,MAT_ORD_DT
                   ,MAT_ORD_TM
                   ,MAT_SHIP_QTY
                   ,MAT_SHIP_DT
                   ,MAT_SHIP_TM
                   ,MAT_REQ_DT
                   ,MAT_REQ_TM
                   ,MAT_RCV_DT
                   ,MAT_RCV_TM
                   ,DMND_INFO_ID
                   ,CUST_ORD_ID
                   ,SER_NUM, DELY_POST_CD
                   ,DELY_CTRY_CD
                   ,DELY_CTY_ADDR
                   ,DELY_ST_CD
                   ,DELY_CUST_NM
                   ,TRX_TP_CD
                   ,DMND_RSP_COMIT_CD
                   ,COV_DAYS_NUM
                   ,COV_HOURS_NUM
                   ,MAJ_ACCT_ID
                   ,DMND_PRTY_CD
                   ,DMND_PROD_CD
                   ,SPEC_RG_CD
                   ,SPEC_SITE_CD
                   ,SHIP_FROM_RG_CD
                   ,SHIP_FROM_SITE_CD
                   ,SHIP_TO_RG_CD
                   ,SHIP_TO_SITE_CD
                   ,NTWK_CONFIG_NM
                   ,CUST_RPT_HIT_FLG
                FROM (
                    SELECT DISTINCT
                        CASE
                            WHEN PRDT.PRCH_REQ_LINE_STS_CD = #CANCELLED# THEN 0
                            ELSE PRDT.PRCH_REQ_BAL_QTY
                        END AS PRCH_REQ_BAL_QTY
                       ,PRDT.MDSE_CD
                       ,#WH_RG_CD# AS WH_RG_CD
                       ,#S21# AS INP_SRC_CD
                       ,PRRQ.PRCH_REQ_CRAT_DT AS MAT_ORD_DT
                       ,PRRQ.PRCH_REQ_CRAT_TM AS MAT_ORD_TM
                       ,CASE
                           WHEN PRDT.PRCH_REQ_LINE_STS_CD = #CANCELLED# THEN 0
                           ELSE PRDT.SHIP_QTY
                       END AS MAT_SHIP_QTY
                       ,NULL AS MAT_SHIP_DT
                       ,NULL AS MAT_SHIP_TM
                       ,NULL AS MAT_REQ_DT
                       ,NULL AS MAT_REQ_TM
                       ,NULL AS MAT_RCV_DT
                       ,NULL AS MAT_RCV_TM
                       ,PRDT.PRCH_REQ_NUM || #hyphen# || PRDT.PRCH_REQ_LINE_NUM || #hyphen# || PRDT.PRCH_REQ_LINE_SUB_NUM AS DMND_INFO_ID
                       ,NULL AS CUST_ORD_ID
                       ,PRRQ.SVC_MACH_SER_NUM AS SER_NUM
                       ,CASE
                           WHEN PRRQ.SHIP_TO_POST_CD IS NULL
                           THEN(SELECT
                                    SUBSTR(TL.POST_CD, 1,10)
                                FROM
                                    TECH_LOC TL
                                WHERE
                                    TL.GLBL_CMPY_CD = #GLBL_CMPY_CD#
                                <!-- START 2021/11/16 [QC#58989-2,MOD] -->
                                <!-- AND TL.TECH_TOC_CD  = PRRQ.RQST_TECH_TOC_CD -->
                                AND TL.TECH_LOC_CD = PRDT.DEST_INVTY_LOC_CD
                                <!-- END   2021/11/16 [QC#58989-2,MOD] -->
                                AND TL.EZCANCELFLAG = '0'
                                AND ROWNUM = 1)
                           ELSE SUBSTR(PRRQ.SHIP_TO_POST_CD, 1,10)
                       END AS DELY_POST_CD
                       ,CASE
                           WHEN PRRQ.SHIP_TO_CTRY_CD IS NULL
                           THEN(SELECT
                                    SUBSTR(TL.CTRY_CD, 1,2)
                                FROM
                                    TECH_LOC TL
                                WHERE
                                    TL.GLBL_CMPY_CD = #GLBL_CMPY_CD#
                                <!-- START 2021/11/16 [QC#58989-2,MOD] -->
                                <!-- AND TL.TECH_TOC_CD  = PRRQ.RQST_TECH_TOC_CD -->
                                AND TL.TECH_LOC_CD = PRDT.DEST_INVTY_LOC_CD
                                <!-- END   2021/11/16 [QC#58989-2,MOD] -->
                                AND TL.EZCANCELFLAG = '0'
                                AND ROWNUM = 1)
                           ELSE SUBSTR(PRRQ.SHIP_TO_CTRY_CD, 1,2)
                       END AS DELY_CTRY_CD
                       ,CASE
                           WHEN PRRQ.SHIP_TO_CTY_ADDR IS NULL
                           THEN(SELECT
                                    SUBSTR(TL.CTY_ADDR, 1,20)
                                FROM
                                    TECH_LOC TL
                                WHERE
                                    TL.GLBL_CMPY_CD = #GLBL_CMPY_CD#
                                <!-- START 2021/11/16 [QC#58989-2,MOD] -->
                                <!-- AND TL.TECH_TOC_CD  = PRRQ.RQST_TECH_TOC_CD -->
                                AND TL.TECH_LOC_CD = PRDT.DEST_INVTY_LOC_CD
                                <!-- END   2021/11/16 [QC#58989-2,MOD] -->
                                AND TL.EZCANCELFLAG = '0'
                                AND ROWNUM = 1)
                           ELSE SUBSTR(PRRQ.SHIP_TO_CTY_ADDR, 1,20)
                       END AS DELY_CTY_ADDR
                       ,CASE
                           WHEN PRRQ.SHIP_TO_ST_CD IS NULL
                           THEN(SELECT
                                    SUBSTR(TL.ST_CD, 1,3)
                                FROM
                                    TECH_LOC TL
                                WHERE
                                    TL.GLBL_CMPY_CD = #GLBL_CMPY_CD#
                                <!-- START 2021/11/16 [QC#58989-2,MOD] -->
                                <!-- AND TL.TECH_TOC_CD  = PRRQ.RQST_TECH_TOC_CD -->
                                AND TL.TECH_LOC_CD = PRDT.DEST_INVTY_LOC_CD
                                <!-- END   2021/11/16 [QC#58989-2,MOD] -->
                                AND TL.EZCANCELFLAG = '0'
                                AND ROWNUM = 1)
                           ELSE PRRQ.SHIP_TO_ST_CD
                       END AS DELY_ST_CD
                       ,CASE
                           WHEN PRRQ.SHIP_TO_LOC_NM IS NULL
                           THEN(SELECT
                                    SUBSTR(TL.LOC_NM, 1,20)
                                FROM
                                    TECH_LOC TL
                                WHERE
                                    TL.GLBL_CMPY_CD = #GLBL_CMPY_CD#
                                <!-- START 2021/11/16 [QC#58989-2,MOD] -->
                                <!-- AND TL.TECH_TOC_CD  = PRRQ.RQST_TECH_TOC_CD -->
                                AND TL.TECH_LOC_CD = PRDT.DEST_INVTY_LOC_CD
                                <!-- END   2021/11/16 [QC#58989-2,MOD] -->
                                AND TL.EZCANCELFLAG = '0'
                                AND ROWNUM = 1)
                           ELSE SUBSTR(PRRQ.SHIP_TO_LOC_NM, 1,20)
                       END AS DELY_CUST_NM
                       ,CASE
                           WHEN PRRQ.PRCH_REQ_TP_CD IS NOT NULL
                           THEN(SELECT
                                    #TR# || UPPER(PRCH_REQ_TP_NM)
                                FROM
                                    PRCH_REQ_TP PRT
                                WHERE
                                    PRT.GLBL_CMPY_CD   = #GLBL_CMPY_CD#
                                AND PRT.PRCH_REQ_TP_CD = PRRQ.PRCH_REQ_TP_CD
                                AND PRT.EZCANCELFLAG   = '0')
                           ELSE NULL
                       END AS TRX_TP_CD
                       ,CASE
                           WHEN PRRQ.SVC_MACH_SER_NUM IS NOT NULL
                           THEN(SELECT
                                    TO_CHAR(DM.RSP_TM_DOWN_MN_AOT / 60) || 'H'
                                FROM
                                    DS_MDL DM
                                   ,SVC_MACH_MSTR SMM
                                   ,SVC_CONFIG_MSTR SCM
                                WHERE
                                    DM.GLBL_CMPY_CD        = #GLBL_CMPY_CD#
                                AND DM.MDL_ID              = SCM.MDL_ID
                                AND DM.EZCANCELFLAG        = '0'
                                AND SMM.GLBL_CMPY_CD       = DM.GLBL_CMPY_CD
                                AND SMM.SER_NUM            = PRRQ.SVC_MACH_SER_NUM
                                AND SMM.EZCANCELFLAG       = '0'
                                AND SCM.GLBL_CMPY_CD       = SMM.GLBL_CMPY_CD
                                AND SCM.SVC_CONFIG_MSTR_PK = SMM.SVC_CONFIG_MSTR_PK
                                AND SCM.EZCANCELFLAG       = '0'
                                AND ROWNUM                 = 1)  
                           ELSE NULL
                       END AS DMND_RSP_COMIT_CD
                       ,NULL AS COV_DAYS_NUM
                       ,NULL AS COV_HOURS_NUM
                       ,NULL AS MAJ_ACCT_ID
                       ,CASE
                           WHEN PRRQ.SVC_MACH_SER_NUM IS NOT NULL
                           THEN (SELECT
                                     SUBSTR(A.AHS_CD, 1, 10)
                                 FROM
                                     SVC_TERM_COND STC
                                    ,AHS A
                                    ,DS_CONTR_DTL CD
                                    ,SVC_MACH_MSTR SMM
                                 WHERE
                                     STC.GLBL_CMPY_CD           = #GLBL_CMPY_CD#
                                 AND STC.SVC_TERM_COND_ATTRB_PK = #SVC_TERM_COND_ATTRB_PK#
                                 AND STC.EZCANCELFLAG           = '0'
                                 AND A.GLBL_CMPY_CD             = STC.GLBL_CMPY_CD
                                 AND A.AHS_CD                   = STC.SVC_TERM_ATTRB_MAP_VAL_CD
                                 AND A.EZCANCELFLAG             = '0'
                                 AND CD.GLBL_CMPY_CD            = STC.GLBL_CMPY_CD
                                 AND CD.DS_CONTR_DTL_PK         = STC.DS_CONTR_DTL_PK
                                 AND CD.EZCANCELFLAG            = '0'
                                 AND SMM.GLBL_CMPY_CD           = CD.GLBL_CMPY_CD
                                 AND SMM.SVC_MACH_MSTR_PK       = CD.SVC_MACH_MSTR_PK
                                 AND SMM.SER_NUM                = PRRQ.SVC_MACH_SER_NUM
                                 AND SMM.EZCANCELFLAG           = '0'
                                 AND ROWNUM = 1)
                           ELSE NULL
                       END AS DMND_PRTY_CD
                       ,CASE
                           WHEN PRDT.SVC_CONFIG_MSTR_PK IS NOT NULL 
                           THEN MN.T_MDL_NM
                           ELSE NULL
                       END DMND_PROD_CD
                       ,NULL AS SPEC_RG_CD
                       ,NULL AS SPEC_SITE_CD
                       ,NULL AS SHIP_FROM_RG_CD
                       <!-- START 2021/11/16 [QC#58989-2,MOD] -->
                       <!-- ,PRDT.SRC_RTL_WH_CD AS SHIP_FROM_SITE_CD -->
                       ,SUBSTR(PRDT.SRC_RTL_WH_CD, 1, 12) AS SHIP_FROM_SITE_CD
                       <!-- END   2021/11/16 [QC#58989-2,MOD] -->
                       ,NULL AS SHIP_TO_RG_CD
                       ,NULL AS SHIP_TO_SITE_CD
                       ,NULL AS NTWK_CONFIG_NM
                       ,NULL AS CUST_RPT_HIT_FLG
                    FROM
                        PRCH_REQ            PRRQ
                       ,PRCH_REQ_DTL        PRDT
                       ,PRCH_REQ_TP         PRRT
                       ,MDSE                M
                       ,MDL_NM              MN
                       ,SVC_CONFIG_MSTR     SCM
                    WHERE
                        PRRQ.GLBL_CMPY_CD               = #GLBL_CMPY_CD#
                    AND PRRQ.EZCANCELFLAG               = '0'
                    AND PRRQ.PRCH_REQ_REC_TP_CD         = #PRCH_REQ_REC_TP_CD#
                    AND NOT (
                        PRRQ.PRCH_REQ_APVL_STS_CD       = #PRCH_REQ_APVL_STS_CD#
                        AND PRRQ.PRCH_REQ_SRC_TP_CD     = #PRCH_REQ_SRC_TP_PLANNING#
                    )
                    <iterate property="PRCH_REQ_TP_CD" var="PRCH_REQ_TP_CD[]"
                    open="AND PRRQ.PRCH_REQ_TP_CD IN  (" conjunction=", " close=")"> #PRCH_REQ_TP_CD[]#
                    </iterate>
                    AND PRRQ.GLBL_CMPY_CD               = PRDT.GLBL_CMPY_CD
                    AND PRRQ.PRCH_REQ_NUM               = PRDT.PRCH_REQ_NUM
                    AND PRDT.EZCANCELFLAG               = '0'
                    AND PRDT.PRCH_REQ_LINE_SUB_NUM      = 0
                    AND NVL(PRDT.TO_STK_STS_CD, #GOOD#) = #GOOD#
                    AND PRDT.PRCH_REQ_FRZ_FLG           = #FLG_ON_Y#
                    <!-- START 2021/12/15 [QC#58989-4,ADD] -->
                    AND PRDT.PRCH_REQ_BAL_QTY           &gt;= 0
                    <!-- END 2021/12/15 [QC#58989-4,ADD] -->
                    <!-- START 2021/11/16 [QC#58989-2,DEL] -->
                    <!-- AND PRDT.PRCH_REQ_BAL_QTY           &gt; 0 -->
                    <!-- AND PRDT.SRC_RTL_SWH_CD             IS NOT NULL -->
                    <!-- END   2021/11/16 [QC#58989-2,DEL] -->
                    AND SUBSTR(PRDT.EZUPTIME, 1, 8) BETWEEN TO_CHAR(SYSDATE - 7, 'YYYYMMDD') AND TO_CHAR(SYSDATE, 'YYYYMMDD')
                    AND PRRQ.GLBL_CMPY_CD               = PRRT.GLBL_CMPY_CD
                    AND PRRQ.PRCH_REQ_TP_CD             = PRRT.PRCH_REQ_TP_CD
                    AND PRRT.EZCANCELFLAG               = '0'
                    AND M.GLBL_CMPY_CD                  = PRDT.GLBL_CMPY_CD
                    AND M.MDSE_CD                       = PRDT.MDSE_CD
                    AND M.EXP_ITEM_FLG                  &lt;&gt; #FLG_ON_Y#
                    <iterate property="MDSE_ITEM_STS_CD" var="MDSE_ITEM_STS_CD[]"
                    open="AND M.MDSE_ITEM_STS_CD IN   (" conjunction=", " close=")"> #MDSE_ITEM_STS_CD[]#
                    </iterate>
                    <iterate property="MDSE_ITEM_TP_CD" var="MDSE_ITEM_TP_CD[]"
                    open="AND M.MDSE_ITEM_TP_CD IN   (" conjunction=", " close=")"> #MDSE_ITEM_TP_CD[]#
                    </iterate>
                    <iterate property="MDSE_ITEM_CLS_TP_CD" var="MDSE_ITEM_CLS_TP_CD[]"
                    open="AND M.MDSE_ITEM_CLS_TP_CD IN   (" conjunction=", " close=")"> #MDSE_ITEM_CLS_TP_CD[]#
                    </iterate>
                    AND M.EZCANCELFLAG                  = '0'
                    AND SCM.GLBL_CMPY_CD(+)             = PRDT.GLBL_CMPY_CD
                    AND SCM.SVC_CONFIG_MSTR_PK(+)       = PRDT.SVC_CONFIG_MSTR_PK
                    AND SCM.EZCANCELFLAG(+)             = '0'
                    AND MN.T_GLBL_CMPY_CD(+)            = SCM.GLBL_CMPY_CD
                    AND MN.T_MDL_ID(+)                  = SCM.MDL_ID
                    AND MN.EZCANCELFLAG(+)              = '0'
                )
                GROUP BY
                    MDSE_CD
                    ,WH_RG_CD
                    ,INP_SRC_CD
                    ,MAT_ORD_DT
                    ,MAT_ORD_TM
                    ,MAT_SHIP_QTY
                    ,MAT_SHIP_DT
                    ,MAT_SHIP_TM
                    ,MAT_REQ_DT
                    ,MAT_REQ_TM
                    ,MAT_RCV_DT
                    ,MAT_RCV_TM
                    ,DMND_INFO_ID
                    ,CUST_ORD_ID
                    ,SER_NUM
                    ,DELY_POST_CD
                    ,DELY_CTRY_CD
                    ,DELY_CTY_ADDR
                    ,DELY_ST_CD
                    ,DELY_CUST_NM
                    ,TRX_TP_CD
                    ,DMND_RSP_COMIT_CD
                    ,COV_DAYS_NUM
                    ,COV_HOURS_NUM
                    ,MAJ_ACCT_ID
                    ,DMND_PRTY_CD
                    ,DMND_PROD_CD
                    ,SPEC_RG_CD
                    ,SPEC_SITE_CD
                    ,SHIP_FROM_RG_CD
                    ,SHIP_FROM_SITE_CD
                    ,SHIP_TO_RG_CD
                    ,SHIP_TO_SITE_CD
                    ,NTWK_CONFIG_NM
                    ,CUST_RPT_HIT_FLG
                <!-- Open Outbound Inventory Request -->
                UNION ALL
                SELECT DISTINCT
                    SUM(SCHD_OTBD_QTY) VIS_QTY
                   ,MDSE_CD
                   ,WH_RG_CD
                   ,INP_SRC_CD
                   ,MAT_ORD_DT
                   ,MAT_ORD_TM
                   ,MAT_SHIP_QTY
                   ,MAT_SHIP_DT
                   ,MAT_SHIP_TM
                   ,MAT_REQ_DT
                   ,MAT_REQ_TM
                   ,MAT_RCV_DT
                   ,MAT_RCV_TM
                   ,DMND_INFO_ID
                   ,CUST_ORD_ID
                   ,SER_NUM
                   ,DELY_POST_CD
                   ,DELY_CTRY_CD
                   ,DELY_CTY_ADDR
                   ,DELY_ST_CD
                   ,DELY_CUST_NM
                   ,TRX_TP_CD
                   ,DMND_RSP_COMIT_CD
                   ,COV_DAYS_NUM
                   ,COV_HOURS_NUM
                   ,MAJ_ACCT_ID
                   ,DMND_PRTY_CD
                   ,DMND_PROD_CD
                   ,SPEC_RG_CD
                   ,SPEC_SITE_CD
                   ,SHIP_FROM_RG_CD
                   ,SHIP_FROM_SITE_CD
                   ,SHIP_TO_RG_CD
                   ,SHIP_TO_SITE_CD
                   ,NTWK_CONFIG_NM
                   ,CUST_RPT_HIT_FLG
                FROM (
                    SELECT DISTINCT
                        CASE
                            WHEN PRDT.PRCH_REQ_LINE_STS_CD = #CANCELLED# THEN 0
                            ELSE PRDT.PRCH_REQ_QTY
                        END AS SCHD_OTBD_QTY
                       ,PRDT.MDSE_CD
                       ,#WH_RG_CD# AS WH_RG_CD
                       ,#S21# AS INP_SRC_CD
                       ,PRRQ.PRCH_REQ_CRAT_DT AS MAT_ORD_DT
                       ,PRRQ.PRCH_REQ_CRAT_TM AS MAT_ORD_TM
                       ,CASE
                           WHEN PRDT.PRCH_REQ_LINE_STS_CD = #CANCELLED# THEN 0
                           ELSE PRDT.SHIP_QTY
                        END AS MAT_SHIP_QTY
                       ,NULL AS MAT_SHIP_DT
                       ,NULL AS MAT_SHIP_TM
                       ,NULL AS MAT_REQ_DT
                       ,NULL AS MAT_REQ_TM
                       ,NULL AS MAT_RCV_DT
                       ,NULL AS MAT_RCV_TM
                       ,PRDT.PRCH_REQ_NUM || #hyphen# || PRDT.PRCH_REQ_LINE_NUM || #hyphen# || PRDT.PRCH_REQ_LINE_SUB_NUM AS DMND_INFO_ID
                       ,NULL AS CUST_ORD_ID
                       ,PRRQ.SVC_MACH_SER_NUM AS SER_NUM
                       ,CASE
                           WHEN PRRQ.SHIP_TO_POST_CD IS NULL
                           THEN(SELECT
                                    SUBSTR(TL.POST_CD, 1,10)
                                FROM
                                    TECH_LOC TL
                                WHERE
                                    TL.GLBL_CMPY_CD = #GLBL_CMPY_CD#
                                <!-- START 2021/11/16 [QC#58989-2,MOD] -->
                                <!-- AND TL.TECH_TOC_CD = PRRQ.RQST_TECH_TOC_CD -->
                                AND TL.TECH_LOC_CD = PRDT.DEST_INVTY_LOC_CD
                                <!-- END   2021/11/16 [QC#58989-2,MOD] -->
                                AND TL.EZCANCELFLAG = '0'
                                AND ROWNUM = 1)
                           ELSE SUBSTR(PRRQ.SHIP_TO_POST_CD, 1,10)
                       END AS DELY_POST_CD
                       ,CASE
                           WHEN PRRQ.SHIP_TO_CTRY_CD IS NULL
                           THEN(SELECT
                                    SUBSTR(TL.CTRY_CD, 1,2)
                                FROM
                                    TECH_LOC TL
                                WHERE
                                    TL.GLBL_CMPY_CD = #GLBL_CMPY_CD#
                                <!-- START 2021/11/16 [QC#58989-2,MOD] -->
                                <!-- AND TL.TECH_TOC_CD  = PRRQ.RQST_TECH_TOC_CD -->
                                AND TL.TECH_LOC_CD = PRDT.DEST_INVTY_LOC_CD
                                <!-- END   2021/11/16 [QC#58989-2,MOD] -->
                                AND TL.EZCANCELFLAG = '0'
                                AND ROWNUM = 1)
                           ELSE SUBSTR(PRRQ.SHIP_TO_CTRY_CD, 1,2)
                       END AS DELY_CTRY_CD
                       ,CASE
                           WHEN PRRQ.SHIP_TO_CTY_ADDR IS NULL
                           THEN(SELECT
                                    SUBSTR(TL.CTY_ADDR, 1,20)
                                FROM
                                    TECH_LOC TL
                                WHERE
                                    TL.GLBL_CMPY_CD = #GLBL_CMPY_CD#
                                <!-- START 2021/11/16 [QC#58989-2,MOD] -->
                                <!-- AND TL.TECH_TOC_CD  = PRRQ.RQST_TECH_TOC_CD -->
                                AND TL.TECH_LOC_CD = PRDT.DEST_INVTY_LOC_CD
                                <!-- END   2021/11/16 [QC#58989-2,MOD] -->
                                AND TL.EZCANCELFLAG = '0'
                                AND ROWNUM = 1)
                           ELSE SUBSTR(PRRQ.SHIP_TO_CTY_ADDR, 1,20)
                       END AS DELY_CTY_ADDR
                       ,CASE
                           WHEN PRRQ.SHIP_TO_ST_CD IS NULL
                           THEN(SELECT
                                    SUBSTR(TL.ST_CD, 1,3)
                                FROM
                                    TECH_LOC TL
                                WHERE
                                    TL.GLBL_CMPY_CD = #GLBL_CMPY_CD#
                                <!-- START 2021/11/16 [QC#58989-2,MOD] -->
                                <!-- AND TL.TECH_TOC_CD  = PRRQ.RQST_TECH_TOC_CD -->
                                AND TL.TECH_LOC_CD = PRDT.DEST_INVTY_LOC_CD
                                <!-- END   2021/11/16 [QC#58989-2,MOD] -->
                                AND TL.EZCANCELFLAG = '0'
                                AND ROWNUM          = 1)
                           ELSE PRRQ.SHIP_TO_ST_CD
                       END AS DELY_ST_CD
                       ,CASE
                           WHEN PRRQ.SHIP_TO_LOC_NM IS NULL
                           THEN(SELECT
                                    SUBSTR(TL.LOC_NM, 1,20)
                                FROM
                                    TECH_LOC TL
                                WHERE
                                    TL.GLBL_CMPY_CD = #GLBL_CMPY_CD#
                                <!-- START 2021/11/16 [QC#58989-2,MOD] -->
                                <!-- AND TL.TECH_TOC_CD  = PRRQ.RQST_TECH_TOC_CD -->
                                AND TL.TECH_LOC_CD = PRDT.DEST_INVTY_LOC_CD
                                <!-- END   2021/11/16 [QC#58989-2,MOD] -->
                                AND TL.EZCANCELFLAG = '0'
                                AND ROWNUM          = 1)
                           ELSE SUBSTR(PRRQ.SHIP_TO_LOC_NM, 1,20)
                       END AS DELY_CUST_NM
                       ,CASE
                           WHEN PRRQ.PRCH_REQ_TP_CD IS NOT NULL
                           THEN(SELECT
                                    #TR# || UPPER(PRCH_REQ_TP_NM)
                                FROM
                                    PRCH_REQ_TP PRT
                                WHERE
                                    PRT.GLBL_CMPY_CD   = #GLBL_CMPY_CD#
                                AND PRT.PRCH_REQ_TP_CD = PRRQ.PRCH_REQ_TP_CD
                                AND PRT.EZCANCELFLAG   = '0')
                           ELSE NULL
                       END AS TRX_TP_CD
                       ,CASE
                           WHEN PRRQ.SVC_MACH_SER_NUM IS NOT NULL
                           THEN(SELECT
                                    TO_CHAR(DM.RSP_TM_DOWN_MN_AOT / 60) || 'H'
                                FROM
                                    DS_MDL          DM
                                   ,SVC_MACH_MSTR   SMM
                                   ,SVC_CONFIG_MSTR SCM
                                WHERE
                                    DM.GLBL_CMPY_CD        = #GLBL_CMPY_CD#
                                AND DM.MDL_ID              = SCM.MDL_ID
                                AND DM.EZCANCELFLAG        = '0'
                                AND SMM.GLBL_CMPY_CD       = DM.GLBL_CMPY_CD
                                AND SMM.SER_NUM            = PRRQ.SVC_MACH_SER_NUM
                                AND SMM.EZCANCELFLAG       = '0'
                                AND SCM.GLBL_CMPY_CD       = SMM.GLBL_CMPY_CD
                                AND SCM.SVC_CONFIG_MSTR_PK = SMM.SVC_CONFIG_MSTR_PK
                                AND SCM.EZCANCELFLAG       = '0'
                                AND ROWNUM                 = 1)  
                           ELSE NULL
                       END AS DMND_RSP_COMIT_CD
                       ,NULL AS COV_DAYS_NUM
                       ,NULL AS COV_HOURS_NUM
                       ,NULL AS MAJ_ACCT_ID
                       ,CASE
                           WHEN PRRQ.SVC_MACH_SER_NUM IS NOT NULL
                           THEN (SELECT
                                     SUBSTR(A.AHS_CD, 1, 10)
                                 FROM
                                     SVC_TERM_COND STC
                                    ,AHS           A
                                    ,DS_CONTR_DTL  CD
                                    ,SVC_MACH_MSTR SMM
                                 WHERE
                                     STC.GLBL_CMPY_CD           = #GLBL_CMPY_CD#
                                 AND STC.SVC_TERM_COND_ATTRB_PK = #SVC_TERM_COND_ATTRB_PK#
                                 AND STC.EZCANCELFLAG           = '0'
                                 AND A.GLBL_CMPY_CD             = STC.GLBL_CMPY_CD
                                 AND A.AHS_CD                   = STC.SVC_TERM_ATTRB_MAP_VAL_CD
                                 AND A.EZCANCELFLAG             = '0'
                                 AND CD.GLBL_CMPY_CD            = STC.GLBL_CMPY_CD
                                 AND CD.DS_CONTR_DTL_PK         = STC.DS_CONTR_DTL_PK
                                 AND CD.EZCANCELFLAG            = '0'
                                 AND SMM.GLBL_CMPY_CD           = CD.GLBL_CMPY_CD
                                 AND SMM.SVC_MACH_MSTR_PK       = CD.SVC_MACH_MSTR_PK
                                 AND SMM.SER_NUM                = PRRQ.SVC_MACH_SER_NUM
                                 AND SMM.EZCANCELFLAG           = '0'
                                 AND ROWNUM                     = 1)
                           ELSE NULL
                       END AS DMND_PRTY_CD
                       ,CASE
                           WHEN PRDT.SVC_CONFIG_MSTR_PK IS NOT NULL 
                           THEN MN.T_MDL_NM
                           ELSE NULL
                       END DMND_PROD_CD
                       ,NULL AS SPEC_RG_CD
                       ,NULL AS SPEC_SITE_CD
                       ,NULL AS SHIP_FROM_RG_CD
                       <!-- START 2021/11/16 [QC#58989-2,MOD] -->
                       <!-- ,PRDT.SRC_RTL_WH_CD AS SHIP_FROM_SITE_CD -->
                       ,SUBSTR(PRDT.SRC_RTL_WH_CD, 1, 12) AS SHIP_FROM_SITE_CD
                       <!-- START 2021/11/16 [QC#58989-2,MOD] -->
                       ,NULL AS SHIP_TO_RG_CD
                       ,NULL AS SHIP_TO_SITE_CD
                       ,NULL AS NTWK_CONFIG_NM
                       ,NULL AS CUST_RPT_HIT_FLG
                    FROM
                        PRCH_REQ           PRRQ
                       ,PRCH_REQ_DTL       PRDT
                       ,PRCH_REQ_TP        PRRT
                       ,PRCH_REQ_REC_TP    PRRRT
                       ,SHPG_PLN           SP
                       ,SHPG_STS           SS
                       ,(SELECT
                             P.GLBL_CMPY_CD
                            ,P.SO_NUM
                            ,P.SO_SLP_NUM
                            ,P.PKT_STS_TS
                         FROM
                             PKT P
                             ,(SELECT
                                   MP.GLBL_CMPY_CD
                                  ,MP.SO_NUM
                                  ,MP.SO_SLP_NUM
                                  ,MAX(MP.PKT_SQ_NUM) MAX_PKT_SQ_NUM
                              FROM
                                   PKT MP
                              WHERE
                                   MP.EZCANCELFLAG = '0'
                              GROUP BY
                                   MP.GLBL_CMPY_CD
                                  ,MP.SO_NUM
                                  ,MP.SO_SLP_NUM
                              ) M
                         WHERE
                             P.GLBL_CMPY_CD = M.GLBL_CMPY_CD
                         AND P.SO_NUM       = M.SO_NUM
                         AND P.SO_SLP_NUM   = M.SO_SLP_NUM
                         AND P.PKT_SQ_NUM   = M.MAX_PKT_SQ_NUM
                       ) PKT
                       ,MDSE            M
                       ,MDL_NM          MN
                       ,SVC_CONFIG_MSTR SCM
                    WHERE
                        PRRQ.GLBL_CMPY_CD                 = #GLBL_CMPY_CD#
                    AND PRRQ.EZCANCELFLAG                 = '0'
                    AND PRRQ.PRCH_REQ_TP_CD              != #PRCH_REQ_TP_KT#
                    AND NOT (
                        PRRQ.PRCH_REQ_APVL_STS_CD         = #PRCH_REQ_APVL_STS_CD#
                        <iterate property="PRCH_REQ_SRC_TP_CD" var="PRCH_REQ_SRC_TP_CD[]"
                        open="AND PRRQ.PRCH_REQ_SRC_TP_CD IN    (" conjunction=", " close=")"> #PRCH_REQ_SRC_TP_CD[]#
                        </iterate>
                    )
                    <iterate property="PRCH_REQ_TP_CD" var="PRCH_REQ_TP_CD[]"
                    open="AND PRRQ.PRCH_REQ_TP_CD IN    (" conjunction=", " close=")"> #PRCH_REQ_TP_CD[]#
                    </iterate>
                    AND PRRQ.GLBL_CMPY_CD                 = PRRRT.GLBL_CMPY_CD
                    AND PRRQ.PRCH_REQ_REC_TP_CD           = PRRRT.PRCH_REQ_REC_TP_CD
                    AND PRRRT.EZCANCELFLAG                = '0'
                    AND PRRQ.GLBL_CMPY_CD                 = PRDT.GLBL_CMPY_CD
                    AND PRRQ.PRCH_REQ_NUM                 = PRDT.PRCH_REQ_NUM
                    AND PRDT.EZCANCELFLAG                 = '0'
                    AND PRDT.PRCH_REQ_LINE_SUB_NUM        = 0
                    AND (
                        PRDT.PRCH_REQ_FRZ_FLG             = #FLG_OFF_N# 
                        OR (
                            PRDT.PRCH_REQ_FRZ_FLG         = #FLG_ON_Y#  
                        AND PRDT.PRCH_REQ_REL_STS_CD      = #PRCH_REQ_REL_STS_COMPLEATED#
                        )
                    )
                    AND PRDT.ORIG_PRCH_REQ_LINE_NUM       IS NULL
                    <!-- START 2021/11/16 [QC#58989-2,DEL] -->
                    <!-- AND PRDT.SRC_RTL_SWH_CD               IS NOT NULL -->
                    <!-- END   2021/11/16 [QC#58989-2,DEL] -->
                    AND SUBSTR(PRDT.EZUPTIME, 1, 8) BETWEEN TO_CHAR(SYSDATE - 7, 'YYYYMMDD') AND TO_CHAR(SYSDATE, 'YYYYMMDD')
                    AND PRRQ.GLBL_CMPY_CD                 = PRRT.GLBL_CMPY_CD
                    AND PRRQ.PRCH_REQ_TP_CD               = PRRT.PRCH_REQ_TP_CD
                    AND PRRT.SCE_ORD_TP_CD                = #SCE_ORD_TP_CD#
                    AND PRRT.EZCANCELFLAG                 = '0'
                    AND PRDT.GLBL_CMPY_CD                 = SP.GLBL_CMPY_CD(+)
                    AND PRDT.PRCH_REQ_NUM                 = SP.TRX_HDR_NUM(+)
                    AND PRDT.PRCH_REQ_LINE_NUM            = SP.TRX_LINE_NUM(+)
                    AND SP.EZCANCELFLAG(+)                = '0'
                    AND SP.GLBL_CMPY_CD                   = SS.GLBL_CMPY_CD(+)
                    AND SP.SHPG_STS_CD                    = SS.SHPG_STS_CD(+)
                    AND SS.EZCANCELFLAG(+)                = '0'
                    AND SP.GLBL_CMPY_CD                   = PKT.GLBL_CMPY_CD(+)
                    AND SP.SO_NUM                         = PKT.SO_NUM(+)
                    AND SP.SO_SLP_NUM                     = PKT.SO_SLP_NUM(+)
                    <!-- START 2021/11/16 [QC#58989-2,DEL] -->
                    <!-- AND (
                        NOT EXISTS (
                            SELECT 
                                1
                            FROM   
                                SHPG_ORD_DTL SOD
                            WHERE  
                                SOD.PRCH_REQ_NUM             = PRDT.PRCH_REQ_NUM
                            AND    SOD.PRCH_REQ_LINE_NUM     = PRDT.PRCH_REQ_LINE_NUM
                            AND    SOD.PRCH_REQ_LINE_SUB_NUM = TO_CHAR(PRDT.PRCH_REQ_LINE_SUB_NUM)
                            <iterate property="DS_SO_LINE_STS_CD" var="DS_SO_LINE_STS_CD[]"
                            open="AND    SOD.DS_SO_LINE_STS_CD IN    (" conjunction=", " close=")"> #DS_SO_LINE_STS_CD[]#
                            </iterate>
                            AND    SOD.GLBL_CMPY_CD          = PRDT.GLBL_CMPY_CD
                            AND    SOD.EZCANCELFLAG          = '0'
                        )
                        AND NOT EXISTS (
                            SELECT 
                                1
                            FROM   CPO     CPO
                                  ,CPO_DTL CD
                            WHERE  CPO.ORD_SRC_REF_NUM          = PRDT.PRCH_REQ_NUM
                            AND    CPO.GLBL_CMPY_CD             = PRDT.GLBL_CMPY_CD
                            AND    CPO.EZCANCELFLAG             = '0'
                            AND    CPO.CPO_ORD_NUM              = CD.CPO_ORD_NUM
                            AND    CPO.GLBL_CMPY_CD             = CD.GLBL_CMPY_CD
                            AND    CD.ORD_SRC_REF_LINE_NUM      = PRDT.PRCH_REQ_LINE_NUM
                            AND    CD.ORD_SRC_REF_LINE_SUB_NUM  = TO_CHAR(PRDT.PRCH_REQ_LINE_SUB_NUM)
                            AND    CD.GLBL_CMPY_CD              = PRDT.GLBL_CMPY_CD
                            AND    CD.EZCANCELFLAG              = '0'
                        )
                    ) -->
                    <!-- END   2021/11/16 [QC#58989-2,DEL] -->
                    AND M.GLBL_CMPY_CD            = PRDT.GLBL_CMPY_CD
                    AND M.MDSE_CD                 = PRDT.MDSE_CD
                    AND M.EXP_ITEM_FLG            &lt;&gt; #FLG_ON_Y#
                    <iterate property="MDSE_ITEM_STS_CD" var="MDSE_ITEM_STS_CD[]"
                    open="AND M.MDSE_ITEM_STS_CD IN   (" conjunction=", " close=")"> #MDSE_ITEM_STS_CD[]#
                    </iterate>
                    <iterate property="MDSE_ITEM_TP_CD" var="MDSE_ITEM_TP_CD[]"
                    open="AND M.MDSE_ITEM_TP_CD IN   (" conjunction=", " close=")"> #MDSE_ITEM_TP_CD[]#
                    </iterate>
                    <iterate property="MDSE_ITEM_CLS_TP_CD" var="MDSE_ITEM_CLS_TP_CD[]"
                    open="AND M.MDSE_ITEM_CLS_TP_CD IN   (" conjunction=", " close=")"> #MDSE_ITEM_CLS_TP_CD[]#
                    </iterate>
                    AND M.EZCANCELFLAG            = '0'
                    AND SCM.GLBL_CMPY_CD(+)       = PRDT.GLBL_CMPY_CD
                    AND SCM.SVC_CONFIG_MSTR_PK(+) = PRDT.SVC_CONFIG_MSTR_PK
                    AND SCM.EZCANCELFLAG(+)       = '0'
                    AND MN.T_GLBL_CMPY_CD(+)      = SCM.GLBL_CMPY_CD
                    AND MN.T_MDL_ID(+)            = SCM.MDL_ID
                    AND MN.EZCANCELFLAG(+)        = '0'
                )
                GROUP BY
                    MDSE_CD
                   ,WH_RG_CD
                   ,INP_SRC_CD
                   ,MAT_ORD_DT
                   ,MAT_ORD_TM
                   ,MAT_SHIP_QTY
                   ,MAT_SHIP_DT
                   ,MAT_SHIP_TM
                   ,MAT_REQ_DT
                   ,MAT_REQ_TM
                   ,MAT_RCV_DT
                   ,MAT_RCV_TM
                   ,DMND_INFO_ID
                   ,CUST_ORD_ID
                   ,SER_NUM
                   ,DELY_POST_CD
                   ,DELY_CTRY_CD
                   ,DELY_CTY_ADDR
                   ,DELY_ST_CD
                   ,DELY_CUST_NM
                   ,TRX_TP_CD
                   ,DMND_RSP_COMIT_CD
                   ,COV_DAYS_NUM
                   ,COV_HOURS_NUM
                   ,MAJ_ACCT_ID
                   ,DMND_PRTY_CD
                   ,DMND_PROD_CD
                   ,SPEC_RG_CD
                   ,SPEC_SITE_CD
                   ,SHIP_FROM_RG_CD
                   ,SHIP_FROM_SITE_CD
                   ,SHIP_TO_RG_CD
                   ,SHIP_TO_SITE_CD
                   ,NTWK_CONFIG_NM
                   ,CUST_RPT_HIT_FLG
                <!-- Field Service Report (Usage Orders) -->
                UNION ALL
                SELECT DISTINCT
                    SUM(SVC_PRT_QTY) VIS_QTY
                    ,MDSE_CD
                    ,WH_RG_CD
                    ,INP_SRC_CD
                    ,MAT_ORD_DT
                    ,MAT_ORD_TM
                    ,MAT_SHIP_QTY
                    ,MAT_SHIP_DT
                    ,MAT_SHIP_TM
                    ,MAT_REQ_DT
                    ,MAT_REQ_TM
                    ,MAT_RCV_DT
                    ,MAT_RCV_TM
                    ,DMND_INFO_ID
                    ,CUST_ORD_ID
                    ,SER_NUM
                    ,DELY_POST_CD
                    ,DELY_CTRY_CD
                    ,DELY_CTY_ADDR
                    ,DELY_ST_CD
                    ,DELY_CUST_NM
                    ,TRX_TP_CD
                    ,DMND_RSP_COMIT_CD
                    ,COV_DAYS_NUM
                    ,COV_HOURS_NUM
                    ,MAJ_ACCT_ID
                    ,DMND_PRTY_CD
                    ,DMND_PROD_CD
                    ,SPEC_RG_CD
                    ,SPEC_SITE_CD
                    ,SHIP_FROM_RG_CD
                    ,SHIP_FROM_SITE_CD
                    ,SHIP_TO_RG_CD
                    ,SHIP_TO_SITE_CD
                    ,NTWK_CONFIG_NM
                    ,CUST_RPT_HIT_FLG
                FROM (
                    SELECT DISTINCT
                        CASE
                            WHEN F.FSR_STS_CD = #CANCELLED# THEN 0
                            ELSE FU.SVC_PRT_QTY
                        END AS SVC_PRT_QTY
                       ,FU.MDSE_CD
                       ,#WH_RG_CD# AS WH_RG_CD
                       ,#S21# AS INP_SRC_CD
                       ,SUBSTR(F.FSR_CRAT_DT, 1,8) AS MAT_ORD_DT
                       ,SUBSTR(F.FSR_CRAT_TM, 1,6) AS MAT_ORD_TM
                       ,CASE
                           WHEN F.FSR_STS_CD = #CANCELLED# THEN 0
                           ELSE FU.SVC_PRT_QTY
                        END AS MAT_SHIP_QTY
                       ,NULL AS MAT_SHIP_DT
                       ,NULL AS MAT_SHIP_TM
                       ,NULL AS MAT_REQ_DT
                       ,NULL AS MAT_REQ_TM
                       ,NULL AS MAT_RCV_DT
                       ,NULL AS MAT_RCV_TM
                       ,F.FSR_NUM || #hyphen# || ST.SVC_TASK_NUM || #hyphen# || FU.FSR_USG_PK AS DMND_INFO_ID
                       ,NULL AS CUST_ORD_ID
                       ,F.SER_NUM AS SER_NUM
                       ,CASE
                           WHEN F.SHIP_TO_CUST_CD IS NOT NULL
                           THEN(SELECT
                                    SUBSTR(STC.POST_CD, 1,10)
                                FROM
                                    SHIP_TO_CUST STC
                                WHERE
                                    STC.GLBL_CMPY_CD    = #GLBL_CMPY_CD#
                                <!-- 2023/11/06 QC#61856 K.Ikeda START -->
                                <!-- AND STC.SHIP_TO_CUST_CD = F.SHIP_TO_CUST_CD -->
                                AND STC.SHIP_TO_CUST_CD = NVL(F.SHIP_TO_UPD_CUST_CD, F.SHIP_TO_CUST_CD)
                                <!-- 2023/11/06 QC#61856 K.Ikeda END -->
                                AND STC.EZCANCELFLAG    = '0'
                                AND ROWNUM              = 1)
                           ELSE NULL
                       END AS DELY_POST_CD
                       ,CASE
                           WHEN F.SHIP_TO_CUST_CD IS NOT NULL
                           THEN(SELECT
                                    SUBSTR(STC.CTRY_CD, 1,2)
                                FROM
                                    SHIP_TO_CUST STC
                                WHERE
                                    STC.GLBL_CMPY_CD    = #GLBL_CMPY_CD#
                                <!-- 2023/11/06 QC#61856 K.Ikeda START -->
                                <!-- AND STC.SHIP_TO_CUST_CD = F.SHIP_TO_CUST_CD -->
                                AND STC.SHIP_TO_CUST_CD = NVL(F.SHIP_TO_UPD_CUST_CD, F.SHIP_TO_CUST_CD)
                                <!-- 2023/11/06 QC#61856 K.Ikeda END -->
                                AND STC.EZCANCELFLAG    = '0'
                                AND ROWNUM              = 1)
                           ELSE NULL
                       END AS DELY_CTRY_CD
                       ,CASE
                           WHEN F.SHIP_TO_CUST_CD IS NOT NULL
                           THEN(SELECT
                                    SUBSTR(STC.CTY_ADDR, 1,20)
                                FROM
                                    SHIP_TO_CUST STC
                                WHERE
                                    STC.GLBL_CMPY_CD    = #GLBL_CMPY_CD#
                                <!-- 2023/11/06 QC#61856 K.Ikeda START -->
                                <!-- AND STC.SHIP_TO_CUST_CD = F.SHIP_TO_CUST_CD -->
                                AND STC.SHIP_TO_CUST_CD = NVL(F.SHIP_TO_UPD_CUST_CD, F.SHIP_TO_CUST_CD)
                                <!-- 2023/11/06 QC#61856 K.Ikeda END -->
                                AND STC.EZCANCELFLAG    = '0'
                                AND ROWNUM              = 1)
                           ELSE NULL
                       END AS DELY_CTY_ADDR
                       ,CASE
                           WHEN F.SHIP_TO_CUST_CD IS NOT NULL
                           THEN(SELECT
                                    SUBSTR(STC.ST_CD, 1,3)
                                FROM
                                    SHIP_TO_CUST STC
                                WHERE
                                    STC.GLBL_CMPY_CD    = #GLBL_CMPY_CD#
                                <!-- 2023/11/06 QC#61856 K.Ikeda START -->
                                <!-- AND STC.SHIP_TO_CUST_CD = F.SHIP_TO_CUST_CD -->
                                AND STC.SHIP_TO_CUST_CD = NVL(F.SHIP_TO_UPD_CUST_CD, F.SHIP_TO_CUST_CD)
                                <!-- 2023/11/06 QC#61856 K.Ikeda END -->
                                AND STC.EZCANCELFLAG    = '0'
                                AND ROWNUM              = 1)
                           ELSE NULL
                       END AS DELY_ST_CD
                       ,CASE
                           WHEN F.SHIP_TO_CUST_CD IS NOT NULL
                           THEN(SELECT
                                    SUBSTR(STC.LOC_NM, 1,20)
                                FROM
                                    SHIP_TO_CUST STC
                                WHERE
                                    STC.GLBL_CMPY_CD    = #GLBL_CMPY_CD#
                                <!-- 2023/11/06 QC#61856 K.Ikeda START -->
                                <!-- AND STC.SHIP_TO_CUST_CD = F.SHIP_TO_CUST_CD -->
                                AND STC.SHIP_TO_CUST_CD = NVL(F.SHIP_TO_UPD_CUST_CD, F.SHIP_TO_CUST_CD)
                                <!-- 2023/11/06 QC#61856 K.Ikeda END -->
                                AND STC.EZCANCELFLAG    = '0'
                                AND ROWNUM              = 1)
                           ELSE NULL
                       END AS DELY_CUST_NM
                       ,#SR# AS TRX_TP_CD
                       ,CASE
                            WHEN F.SER_NUM IS NOT NULL
                            THEN(SELECT
                                     TO_CHAR(DM.RSP_TM_DOWN_MN_AOT / 60) || 'H'
                                 FROM
                                     DS_MDL          DM
                                    ,SVC_MACH_MSTR   SMM
                                    ,SVC_CONFIG_MSTR SCM
                                 WHERE
                                     DM.GLBL_CMPY_CD        = #GLBL_CMPY_CD#
                                 AND DM.MDL_ID              = SCM.MDL_ID
                                 AND DM.EZCANCELFLAG        = '0'
                                 AND SMM.GLBL_CMPY_CD       = DM.GLBL_CMPY_CD
                                 AND SMM.SER_NUM            = F.SER_NUM
                                 AND SMM.EZCANCELFLAG       = '0'
                                 AND SCM.GLBL_CMPY_CD       = SMM.GLBL_CMPY_CD
                                 AND SCM.SVC_CONFIG_MSTR_PK = SMM.SVC_CONFIG_MSTR_PK
                                 AND SCM.EZCANCELFLAG       = '0'
                                 AND ROWNUM                 = 1)  
                            ELSE NULL
                       END AS DMND_RSP_COMIT_CD
                       ,NULL AS COV_DAYS_NUM
                       ,NULL AS COV_HOURS_NUM
                       ,NULL AS MAJ_ACCT_ID
                       ,CASE
                           WHEN F.SER_NUM IS NOT NULL
                           THEN (SELECT
                                     SUBSTR(A.AHS_CD, 1, 10)
                                 FROM
                                     SVC_TERM_COND STC
                                    ,AHS A
                                    ,DS_CONTR_DTL CD
                                    ,SVC_MACH_MSTR SMM
                                 WHERE
                                     STC.GLBL_CMPY_CD           = #GLBL_CMPY_CD#
                                 AND STC.SVC_TERM_COND_ATTRB_PK = #SVC_TERM_COND_ATTRB_PK#
                                 AND STC.EZCANCELFLAG           = '0'
                                 AND A.GLBL_CMPY_CD             = STC.GLBL_CMPY_CD
                                 AND A.AHS_CD                   = STC.SVC_TERM_ATTRB_MAP_VAL_CD
                                 AND A.EZCANCELFLAG             = '0'
                                 AND CD.GLBL_CMPY_CD            = STC.GLBL_CMPY_CD
                                 AND CD.DS_CONTR_DTL_PK         = STC.DS_CONTR_DTL_PK
                                 AND CD.EZCANCELFLAG            = '0'
                                 AND SMM.GLBL_CMPY_CD           = CD.GLBL_CMPY_CD
                                 AND SMM.SVC_MACH_MSTR_PK       = CD.SVC_MACH_MSTR_PK
                                 AND SMM.SER_NUM                = F.SER_NUM
                                 AND SMM.EZCANCELFLAG           = '0'
                                 AND ROWNUM                     = 1)
                           ELSE NULL
                       END AS DMND_PRTY_CD
                       ,CASE
                           WHEN F.SER_NUM IS NOT NULL
                           THEN(SELECT
                                    SUBSTR(STA.MDL_NM, 1, 35)
                                FROM
                                    SVC_TASK STA
                                WHERE
                                    STA.GLBL_CMPY_CD = #GLBL_CMPY_CD#
                                AND STA.SER_NUM      = F.SER_NUM
                                AND STA.EZCANCELFLAG = '0'
                                AND ROWNUM           = 1)
                           ELSE NULL
                       END AS DMND_PROD_CD
                       <!-- START 2022/06/16 F.Fadriquela [QC#60241 MOD] -->
                       <!-- ,NULL AS SPEC_RG_CD -->
                       <!-- ,NULL AS SPEC_SITE_CD -->
                       <!-- ,NULL AS SHIP_FROM_RG_CD -->
                       <!-- ,FU.PRT_USED_BY_TECH_LOC_CD AS SHIP_FROM_SITE_CD -->
                       ,#PPS_TECH_TM# AS SPEC_RG_CD
                       <!-- 2023/11/15 QC#61856 K.Ikeda START -->
                       <!-- ,(SELECT -->
                         <!--     SVC_BR_POST_XREF_PK -->
                         <!-- FROM -->
                         <!--     ( -->
                                 <!-- (SELECT -->
                                  <!--     SVC_BR_POST_XREF_PK -->
                                  <!--    ,1 AS SORT_NUM -->
                                  <!-- FROM (SELECT -->
                                        <!--     SBPX.* -->
                                        <!-- FROM -->
                                        <!--     SVC_BR_POST_XREF SBPX -->
                                        <!-- WHERE -->
                                        <!--     SBPX.GLBL_CMPY_CD      = #GLBL_CMPY_CD# -->
                                        <!-- AND SBPX.EZCANCELFLAG      = '0' -->
                                        <!-- AND SBPX.SVC_TRTY_DESC_TXT = (SELECT DISTINCT -->
                                                                      <!--     SBPXR.SVC_TRTY_DESC_TXT -->
                                                                      <!-- FROM -->
                                                                      <!--     SVC_BR_POST_XREF SBPXR -->
                                                                      <!--    ,SHIP_TO_CUST STC -->
                                                                      <!-- WHERE -->
                                                                      <!--     SBPXR.GLBL_CMPY_CD    = #GLBL_CMPY_CD# -->
                                                                      <!-- AND SBPXR.EZCANCELFLAG    = '0' -->
                                                                      <!-- AND SBPXR.POST_CD         = STC.POST_CD -->
                                                                      <!-- 2023/11/06 QC#61856 K.Ikeda START -->
                                                                      <!-- AND SBPXR.SVC_LINE_BIZ_CD = #PPS# -->
                                                                      <!-- AND SBPXR.SVC_LINE_BIZ_CD = (SELECT -->
                                                                           <!--    SMM.SVC_BY_LINE_BIZ_TP_CD -->
                                                                           <!-- FROM -->
                                                                           <!--     SVC_MACH_MSTR SMM -->
                                                                           <!-- WHERE -->
                                                                           <!--     ST.GLBL_CMPY_CD = SMM.GLBL_CMPY_CD -->
                                                                           <!-- AND ST.SVC_MACH_MSTR_PK = SMM.SVC_MACH_MSTR_PK -->
                                                                           <!-- AND SMM.EZCANCELFLAG = '0') --> 
                                                                      <!-- 2023/11/06 QC#61856 K.Ikeda END -->
                                                                      <!-- AND STC.GLBL_CMPY_CD      = F.GLBL_CMPY_CD -->
                                                                      <!-- 2023/11/06 QC#61856 K.Ikeda START -->
                                                                      <!-- AND STC.SHIP_TO_CUST_CD = F.SHIP_TO_CUST_CD -->
                                                                      <!-- AND STC.SHIP_TO_CUST_CD = NVL(F.SHIP_TO_UPD_CUST_CD, F.SHIP_TO_CUST_CD) -->
                                                                      <!-- 2023/11/06 QC#61856 K.Ikeda END -->
                                                                      <!-- AND STC.EZCANCELFLAG      = '0') -->
                                       <!-- 2023/11/06 QC#61856 K.Ikeda START -->
                                       <!-- AND SBPX.SVC_LINE_BIZ_CD    = #PPS#) -->
                                       <!-- AND SBPX.SVC_LINE_BIZ_CD    = (SELECT --> 
                                                     <!--    SMM.SVC_BY_LINE_BIZ_TP_CD -->
                                                     <!-- FROM -->
                                                     <!--    SVC_MACH_MSTR SMM -->
                                                     <!-- WHERE --> 
                                                     <!--     ST.GLBL_CMPY_CD = SMM.GLBL_CMPY_CD -->
                                                     <!-- AND ST.SVC_MACH_MSTR_PK = SMM.SVC_MACH_MSTR_PK -->
                                                     <!-- AND SMM.EZCANCELFLAG = '0')) -->
                                      <!-- 2023/11/06 QC#61856 K.Ikeda END -->
                                  <!-- UNION ALL -->
                                  <!-- SELECT -->
                                  <!--     SVC_BR_POST_XREF_PK  -->
                                  <!--    ,2 AS SORT_NUM -->
                                  <!-- FROM (SELECT -->
                                        <!--     SBPX.* -->
                                        <!-- FROM -->
                                        <!--     SVC_BR_POST_XREF SBPX -->
                                        <!-- WHERE -->
                                        <!--     SBPX.GLBL_CMPY_CD      = #GLBL_CMPY_CD# -->
                                        <!-- AND SBPX.EZCANCELFLAG      ='0' -->
                                        <!-- AND SBPX.SVC_TRTY_DESC_TXT = (SELECT DISTINCT -->
                                                                      <!--     SBPXR.SVC_TRTY_DESC_TXT -->
                                                                      <!-- FROM -->
                                                                      <!--     SVC_BR_POST_XREF SBPXR -->
                                                                      <!--    ,SHIP_TO_CUST STC -->
                                                                      <!-- WHERE -->
                                                                      <!--     SBPXR.GLBL_CMPY_CD    = #GLBL_CMPY_CD# -->
                                                                      <!-- AND SBPXR.EZCANCELFLAG    ='0' -->
                                                                      <!-- AND SBPXR.POST_CD         = SUBSTR(STC.POST_CD, 1, 5) -->
                                                                      <!-- 2023/11/06 QC#61856 K.Ikeda START -->
                                                                      <!-- AND SBPXR.SVC_LINE_BIZ_CD = #PPS# -->
                                                                      <!-- AND SBPXR.SVC_LINE_BIZ_CD = (SELECT  -->
                                                                           <!--    SMM.SVC_BY_LINE_BIZ_TP_CD -->
                                                                           <!-- FROM -->
                                                                           <!--    SVC_MACH_MSTR SMM -->
                                                                           <!-- WHERE --> 
                                                                           <!--    ST.GLBL_CMPY_CD = SMM.GLBL_CMPY_CD -->
                                                                           <!-- AND ST.SVC_MACH_MSTR_PK = SMM.SVC_MACH_MSTR_PK -->
                                                                           <!-- AND SMM.EZCANCELFLAG = '0') -->
                                                                      <!-- 2023/11/06 QC#61856 K.Ikeda END -->
                                                                      <!-- AND STC.GLBL_CMPY_CD      = F.GLBL_CMPY_CD -->
                                                                      <!-- 2023/11/06 QC#61856 K.Ikeda START -->
                                                                      <!-- AND STC.SHIP_TO_CUST_CD = F.SHIP_TO_CUST_CD -->
                                                                      <!-- AND STC.SHIP_TO_CUST_CD = NVL(F.SHIP_TO_UPD_CUST_CD, F.SHIP_TO_CUST_CD) -->
                                                                      <!-- 2023/11/06 QC#61856 K.Ikeda END -->
                                                                      <!-- AND STC.EZCANCELFLAG      = '0') -->
                                 <!-- 2023/11/06 QC#61856 K.Ikeda START -->
                                        <!-- AND SBPX.SVC_LINE_BIZ_CD   = #PPS#) -->
                                        <!-- AND SBPX.SVC_LINE_BIZ_CD   = (SELECT -->
                                                     <!--    SMM.SVC_BY_LINE_BIZ_TP_CD -->
                                                     <!-- FROM -->
                                                     <!--    SVC_MACH_MSTR SMM -->
                                                     <!-- WHERE -->
                                                     <!--    ST.GLBL_CMPY_CD = SMM.GLBL_CMPY_CD -->
                                                     <!-- AND ST.SVC_MACH_MSTR_PK = SMM.SVC_MACH_MSTR_PK -->
                                                     <!-- AND SMM.EZCANCELFLAG = '0')) -->
                                 <!-- UNION ALL
                                  SELECT
                                      SVC_BR_POST_XREF_PK
                                     ,3 AS SORT_NUM
                                  FROM (SELECT
                                            SBPX.*
                                        FROM
                                            SVC_BR_POST_XREF SBPX
                                        WHERE
                                            SBPX.GLBL_CMPY_CD = #GLBL_CMPY_CD#
                                        AND SBPX.EZCANCELFLAG = '0'
                                        AND SBPX.SVC_TRTY_DESC_TXT = (SELECT DISTINCT
                                                                          SBPXR.SVC_TRTY_DESC_TXT
                                                                      FROM
                                                                          SVC_BR_POST_XREF SBPXR
                                                                         ,SHIP_TO_CUST STC
                                                                      WHERE
                                                                          SBPXR.GLBL_CMPY_CD    = #GLBL_CMPY_CD#
                                                                      AND SBPXR.EZCANCELFLAG    = '0'
                                                                      AND SBPXR.POST_CD         = SUBSTR(STC.POST_CD, 1, 5) || -9999
                                                                      AND SBPXR.SVC_LINE_BIZ_CD = #PPS#
                                                                      AND STC.GLBL_CMPY_CD      = F.GLBL_CMPY_CD
                                                                      AND STC.SHIP_TO_CUST_CD   = F.SHIP_TO_CUST_CD
                                                                      AND STC.EZCANCELFLAG      = '0')
                                        AND SBPX.SVC_LINE_BIZ_CD = #PPS#) -->
                                 <!-- 2023/11/06 QC#61856 K.Ikeda END -->
                                 <!-- ) ORDER BY SORT_NUM, SVC_BR_POST_XREF_PK -->
                        <!--     ) WHERE ROWNUM = 1 -->
                        ,(SELECT
                             SBPX.SVC_BR_POST_XREF_PK
                         FROM
                             SVC_BR_POST_XREF SBPX
                            ,SHIP_TO_CUST STC
                         WHERE
                             SBPX.GLBL_CMPY_CD    = #GLBL_CMPY_CD#
                         AND SBPX.EZCANCELFLAG    ='0'
                         AND STC.GLBL_CMPY_CD     = F.GLBL_CMPY_CD
                         AND STC.SHIP_TO_CUST_CD  = NVL(F.SHIP_TO_UPD_CUST_CD, F.SHIP_TO_CUST_CD)
                         AND (SBPX.POST_CD        = STC.POST_CD OR SBPX.POST_CD = SUBSTR(STC.POST_CD, 1, 5))
                         AND STC.EZCANCELFLAG     = '0'
                         AND SBPX.SVC_LINE_BIZ_CD = (
                             SELECT 
                                 SMM.SVC_BY_LINE_BIZ_TP_CD
                             FROM
                                 SVC_MACH_MSTR SMM
                             WHERE
                                 ST.GLBL_CMPY_CD = SMM.GLBL_CMPY_CD
                             AND ST.SVC_MACH_MSTR_PK = SMM.SVC_MACH_MSTR_PK
                             AND SMM.EZCANCELFLAG = '0'
                         )
                         AND ROWNUM = 1
                         <!-- 2023/11/15 QC#61856 K.Ikeda END -->
                        ) AS SPEC_SITE_CD
                       ,TPWRX.TRD_PTNR_WH_RG_NM AS SHIP_FROM_RG_CD
                       ,FU.PRT_USED_BY_TECH_CD AS SHIP_FROM_SITE_CD
                       <!-- END 2022/06/16 F.Fadriquela [QC#60241 MOD] -->
                       ,NULL AS SHIP_TO_RG_CD
                       ,NULL AS SHIP_TO_SITE_CD
                       ,NULL AS NTWK_CONFIG_NM
                       ,NULL AS CUST_RPT_HIT_FLG
                    FROM
                        FSR      F
                       ,FSR_USG  FU
                       ,SVC_TASK ST
                       ,MDSE     M
                       <!-- START 2022/06/16 F.Fadriquela [QC#60241 ADD] -->
                       ,TRD_PTNR_WH_RG_XREF TPWRX
                       <!-- END 2022/06/16 F.Fadriquela [QC#60241 ADD] -->
                       <!-- 2023/09/20 QC#61856 F.Komaki START -->
                       ,FSR_VISIT FV
                       ,S21_PSN   SP
                       <!-- 2023/09/20 QC#61856 F.Komaki END -->
                    WHERE
                        F.GLBL_CMPY_CD          = #GLBL_CMPY_CD#
                    AND F.EZCANCELFLAG          = '0'
                    <!-- 2023/09/20 QC#61856 F.Komaki START -->
                    <!-- AND SUBSTR(F.EZUPTIME, 1, 8) BETWEEN TO_CHAR(SYSDATE - 7, 'YYYYMMDD') AND TO_CHAR(SYSDATE, 'YYYYMMDD') -->
                    AND SUBSTR(FV.FSR_VISIT_CPLT_DT, 1, 8) BETWEEN TO_CHAR(SYSDATE - 7, 'YYYYMMDD') AND TO_CHAR(SYSDATE, 'YYYYMMDD')
                    <!-- START 2022/05/25 F.Fadriquela [QC#60051 ADD] -->
                    <!-- <iterate property="FSR_STS_CD" var="FSR_STS_CD[]" -->
                    <!-- open="AND F.FSR_STS_CD IN   (" conjunction=", " close=")"> #FSR_STS_CD[]# -->
                    <!-- </iterate> -->
                    <!-- END 2022/05/25 F.Fadriquela [QC#60051 ADD] -->
                    <!-- 2023/11/06 QC#61856 K.Ikeda START -->
                    <iterate property="FSR_VISIT_STS_CD" var="FSR_VISIT_STS_CD[]"
                    open="AND FV.FSR_VISIT_STS_CD IN   (" conjunction=", " close=")"> #FSR_VISIT_STS_CD[]# 
                    </iterate> 
                    <!-- AND FV.FSR_VISIT_STS_CD     = #FSR_VISIT_STS_CD# -->
                    <!-- 2023/11/06 QC#61856 K.Ikeda END -->
                    AND F.GLBL_CMPY_CD          = ST.GLBL_CMPY_CD
                    AND F.FSR_NUM               = ST.FSR_NUM
                    AND ST.EZCANCELFLAG         = '0'
                    <!-- AND FU.PRT_USED_BY_TECH_CD  &lt;&gt; #PRT_USED_BY_TECH_CD# -->
                    AND FU.GLBL_CMPY_CD         = ST.GLBL_CMPY_CD
                    AND FU.FSR_NUM              = ST.FSR_NUM
                    AND FU.SVC_TASK_NUM         = ST.SVC_TASK_NUM
                    AND FU.EZCANCELFLAG         = '0'
                    <!-- AND ST.SVC_BR_CD            IS NOT NULL -->
                    <!-- AND ST.SVC_BR_CD            &lt;&gt; #SVC_BR_CD# -->
                    AND F.GLBL_CMPY_CD          = FV.GLBL_CMPY_CD
                    AND F.FSR_NUM               = FV.FSR_NUM
                    AND FV.EZCANCELFLAG         = '0'
                    AND FV.GLBL_CMPY_CD         = SP.GLBL_CMPY_CD
                    AND FV.TECH_CD              = SP.PSN_CD
                    AND SP.EZCANCELFLAG         = '0'
                    AND SP.PSN_TP_CD            = '1'
                    <!-- 2023/11/06 QC#61856 K.Ikeda START -->
                    AND FV.SVC_TASK_NUM         = ST.SVC_TASK_NUM
                    <!-- 2023/11/06 QC#61856 K.Ikeda END -->
                    <!-- 2023/09/20 QC#61856 F.Komaki END -->
                    AND M.GLBL_CMPY_CD          = FU.GLBL_CMPY_CD
                    AND M.MDSE_CD               = FU.MDSE_CD
                    AND M.EXP_ITEM_FLG          &lt;&gt; #FLG_ON_Y#
                    <iterate property="MDSE_ITEM_STS_CD" var="MDSE_ITEM_STS_CD[]"
                    open="AND M.MDSE_ITEM_STS_CD IN   (" conjunction=", " close=")"> #MDSE_ITEM_STS_CD[]#
                    </iterate>
                    <iterate property="MDSE_ITEM_TP_CD" var="MDSE_ITEM_TP_CD[]"
                    open="AND M.MDSE_ITEM_TP_CD IN   (" conjunction=", " close=")"> #MDSE_ITEM_TP_CD[]#
                    </iterate>
                    <iterate property="MDSE_ITEM_CLS_TP_CD" var="MDSE_ITEM_CLS_TP_CD[]"
                    open="AND M.MDSE_ITEM_CLS_TP_CD IN   (" conjunction=", " close=")"> #MDSE_ITEM_CLS_TP_CD[]#
                    </iterate>
                    AND M.EZCANCELFLAG          = '0'
                    <!-- START 2022/06/16 F.Fadriquela [QC#60241 ADD] -->
                    AND TPWRX.GLBL_CMPY_CD(+)   = FU.GLBL_CMPY_CD
                    AND TPWRX.RTL_WH_CD(+) || TPWRX.RTL_SWH_CD(+) = FU.PRT_USED_BY_TECH_LOC_CD
                    AND TPWRX.EZCANCELFLAG(+)   = '0'
                    <!-- END 2022/06/16 F.Fadriquela [QC#60241 ADD] -->
                )
                GROUP BY
                    MDSE_CD
                   ,WH_RG_CD
                   ,INP_SRC_CD
                   ,MAT_ORD_DT
                   ,MAT_ORD_TM
                   ,MAT_SHIP_QTY
                   ,MAT_SHIP_DT
                   ,MAT_SHIP_TM
                   ,MAT_REQ_DT
                   ,MAT_REQ_TM
                   ,MAT_RCV_DT
                   ,MAT_RCV_TM
                   ,DMND_INFO_ID
                   ,CUST_ORD_ID
                   ,SER_NUM
                   ,DELY_POST_CD
                   ,DELY_CTRY_CD
                   ,DELY_CTY_ADDR
                   ,DELY_ST_CD
                   ,DELY_CUST_NM
                   ,TRX_TP_CD
                   ,DMND_RSP_COMIT_CD
                   ,COV_DAYS_NUM
                   ,COV_HOURS_NUM
                   ,MAJ_ACCT_ID
                   ,DMND_PRTY_CD
                   ,DMND_PROD_CD
                   ,SPEC_RG_CD
                   ,SPEC_SITE_CD
                   ,SHIP_FROM_RG_CD
                   ,SHIP_FROM_SITE_CD
                   ,SHIP_TO_RG_CD
                   ,SHIP_TO_SITE_CD
                   ,NTWK_CONFIG_NM
                   ,CUST_RPT_HIT_FLG
                <!-- START 2022/06/16 F.Fadriquela [QC#60241 ADD] -->
                <!-- Tool Expense and Field Adjustment (Inventory Transaction) -->
                UNION ALL
                SELECT DISTINCT
                    SUM(INVTY_TRX_QTY) AS VIS_QTY
                   ,MDSE_CD
                   ,WH_RG_CD
                   ,INP_SRC_CD
                   ,MAT_ORD_DT
                   ,MAT_ORD_TM
                   ,MAT_SHIP_QTY
                   ,MAT_SHIP_DT
                   ,MAT_SHIP_TM
                   ,MAT_REQ_DT
                   ,MAT_REQ_TM
                   ,MAT_RCV_DT
                   ,MAT_RCV_TM
                   ,DMND_INFO_ID
                   ,CUST_ORD_ID
                   ,SER_NUM
                   ,DELY_POST_CD
                   ,DELY_CTRY_CD
                   ,DELY_CTY_ADDR
                   ,DELY_ST_CD
                   ,DELY_CUST_NM
                   ,TRX_TP_CD
                   ,DMND_RSP_COMIT_CD
                   ,COV_DAYS_NUM
                   ,COV_HOURS_NUM
                   ,MAJ_ACCT_ID
                   ,DMND_PRTY_CD
                   ,DMND_PROD_CD
                   ,SPEC_RG_CD
                   ,SPEC_SITE_CD
                   ,SHIP_FROM_RG_CD
                   ,SHIP_FROM_SITE_CD
                   ,SHIP_TO_RG_CD
                   ,SHIP_TO_SITE_CD
                   ,NTWK_CONFIG_NM
                   ,CUST_RPT_HIT_FLG
                FROM (
                    SELECT DISTINCT
                        ABS(IT.INVTY_TRX_QTY) AS INVTY_TRX_QTY
                       ,IT.MDSE_CD
                       ,#WH_RG_CD# AS WH_RG_CD
                       ,#S21# AS INP_SRC_CD
                       ,SUBSTR(IT.EZINTIME, 0, 8) AS MAT_ORD_DT
                       ,SUBSTR(IT.EZINTIME, 9, 6) AS MAT_ORD_TM
                       ,ABS(IT.INVTY_TRX_QTY) AS MAT_SHIP_QTY
                       ,NULL AS MAT_SHIP_DT
                       ,NULL AS MAT_SHIP_TM
                       ,NULL AS MAT_REQ_DT
                       ,NULL AS MAT_REQ_TM
                       ,NULL AS MAT_RCV_DT
                       ,NULL AS MAT_RCV_TM
                       ,CASE
                            <!-- START 2022/07/22 F.Fadriquela [QC#60241-1 MOD] -->
                            <!-- WHEN IT.PO_ORD_NUM    IS NOT NULL THEN IT.INVTY_TRX_SLP_NUM || #hyphen# || IT.PO_ORD_DTL_LINE_NUM || #hyphen# || '0' -->
                            <!-- WHEN IT.INVTY_ORD_NUM IS NOT NULL THEN IT.INVTY_TRX_SLP_NUM || #hyphen# || IT.INVTY_ORD_LINE_NUM  || #hyphen# || '0' -->
                            WHEN IT.PO_ORD_NUM    IS NOT NULL THEN IT.INVTY_TRX_SLP_NUM || #hyphen# || IT.PO_ORD_DTL_LINE_NUM || #hyphen# || IT.INVTY_TRX_PK
                            WHEN IT.INVTY_ORD_NUM IS NOT NULL THEN IT.INVTY_TRX_SLP_NUM || #hyphen# || IT.INVTY_ORD_LINE_NUM  || #hyphen# || IT.INVTY_TRX_PK
                            <!-- END 2022/07/22 F.Fadriquela [QC#60241-1 MOD] -->
                            ELSE NULL
                        END AS DMND_INFO_ID
                       ,NULL AS CUST_ORD_ID
                       ,CASE
                            WHEN PSN.SER_NUM IS NOT NULL THEN PSN.SER_NUM
                            WHEN PRS.SER_NUM IS NOT NULL THEN PRS.SER_NUM
                            WHEN IOS.SER_NUM IS NOT NULL THEN IOS.SER_NUM
                            ELSE NULL
                        END AS SER_NUM
                       <!-- START 2022/07/26 F.Fadriquela [QC#60241-1 MOD] -->
                       <!-- ,RW.POST_CD AS DELY_POST_CD -->
                       <!-- ,RW.CTRY_CD AS DELY_CTRY_CD -->
                       <!-- ,RW.CTY_ADDR AS DELY_CTY_ADDR -->
                       <!-- ,RW.ST_CD AS DELY_ST_CD -->
                       <!-- ,IT.SHIP_TO_LOC_CUST_NM AS DELY_CUST_NM -->
                       ,SUBSTR(RW.POST_CD, 1, 10)  AS DELY_POST_CD
                       ,SUBSTR(RW.CTRY_CD, 1, 2)   AS DELY_CTRY_CD
                       ,SUBSTR(RW.CTY_ADDR, 1, 20) AS DELY_CTY_ADDR
                       ,SUBSTR(RW.ST_CD, 1, 3)     AS DELY_ST_CD
                       ,SUBSTR(IT.SHIP_TO_LOC_CUST_NM, 1, 20) AS DELY_CUST_NM
                       <!-- END 2022/07/26 F.Fadriquela [QC#60241-1 MOD] -->
                       ,CASE
                            WHEN IT.TRX_CD = #TRX_CD_ADJ# AND IT.TRX_RSN_CD = #TRX_RSN_CD_TOOL_EXPN# THEN #TOOL_EXPENSE#
                            WHEN IT.TRX_CD = #TRX_CD_ADJ# AND IT.TRX_RSN_CD = #TRX_RSN_CD_FIELD_ADJ# THEN #FIELD_ADJUSTMENT#
                            ELSE NULL
                        END AS TRX_TP_CD
                       ,CASE
                            WHEN PSN.SER_NUM IS NOT NULL OR PRS.SER_NUM IS NOT NULL OR IOS.SER_NUM IS NOT NULL
                            THEN(SELECT
                                     TO_CHAR(DM.RSP_TM_DOWN_MN_AOT / 60) || 'H'
                                 FROM
                                     DS_MDL DM
                                    ,SVC_MACH_MSTR SMM
                                    ,SVC_CONFIG_MSTR SCM
                                 WHERE
                                     DM.GLBL_CMPY_CD        = #GLBL_CMPY_CD#
                                 AND DM.MDL_ID              = SCM.MDL_ID
                                 AND DM.EZCANCELFLAG        = '0'
                                 AND SMM.GLBL_CMPY_CD       = DM.GLBL_CMPY_CD
                                 AND (SMM.SER_NUM = PSN.SER_NUM OR SMM.SER_NUM = PRS.SER_NUM OR SMM.SER_NUM = IOS.SER_NUM)
                                 AND SMM.EZCANCELFLAG       = '0'
                                 AND SCM.GLBL_CMPY_CD       = SMM.GLBL_CMPY_CD
                                 AND SCM.SVC_CONFIG_MSTR_PK = SMM.SVC_CONFIG_MSTR_PK
                                 AND SCM.EZCANCELFLAG       = '0'
                                 AND ROWNUM                 = 1)
                            ELSE NULL
                        END AS DMND_RSP_COMIT_CD
                       ,NULL AS COV_DAYS_NUM
                       ,NULL AS COV_HOURS_NUM
                       ,NULL AS MAJ_ACCT_ID
                       ,CASE
                            WHEN PSN.SER_NUM IS NOT NULL OR PRS.SER_NUM IS NOT NULL OR IOS.SER_NUM IS NOT NULL
                            THEN (SELECT
                                      SUBSTR(A.AHS_CD, 1, 10)
                                  FROM
                                      SVC_TERM_COND STC
                                     ,AHS A
                                     ,DS_CONTR_DTL CD
                                     ,SVC_MACH_MSTR SMM
                                  WHERE
                                      STC.GLBL_CMPY_CD           = #GLBL_CMPY_CD#
                                  AND STC.SVC_TERM_COND_ATTRB_PK = #SVC_TERM_COND_ATTRB_PK#
                                  AND STC.EZCANCELFLAG           = '0'
                                  AND A.GLBL_CMPY_CD             = STC.GLBL_CMPY_CD
                                  AND A.AHS_CD                   = STC.SVC_TERM_ATTRB_MAP_VAL_CD
                                  AND A.EZCANCELFLAG             = '0'
                                  AND CD.GLBL_CMPY_CD            = STC.GLBL_CMPY_CD
                                  AND CD.DS_CONTR_DTL_PK         = STC.DS_CONTR_DTL_PK
                                  AND CD.EZCANCELFLAG            = '0'
                                  AND SMM.GLBL_CMPY_CD           = CD.GLBL_CMPY_CD
                                  AND SMM.SVC_MACH_MSTR_PK       = CD.SVC_MACH_MSTR_PK
                                  AND (SMM.SER_NUM = PSN.SER_NUM OR SMM.SER_NUM = PRS.SER_NUM OR SMM.SER_NUM = IOS.SER_NUM)
                                  AND SMM.EZCANCELFLAG           = '0'
                                  AND ROWNUM                     = 1)
                            ELSE NULL
                        END AS DMND_PRTY_CD
                       ,CASE
                            WHEN PD.SVC_CONFIG_MSTR_PK   IS NOT NULL THEN MN1.T_MDL_NM
                            WHEN PRDT.SVC_CONFIG_MSTR_PK IS NOT NULL THEN MN2.T_MDL_NM
                            WHEN IOD.SVC_CONFIG_MSTR_PK  IS NOT NULL THEN MN3.T_MDL_NM
                            ELSE NULL
                        END AS DMND_PROD_CD
                       ,NULL AS SPEC_RG_CD
                       ,NULL AS SPEC_SITE_CD
                       ,NULL AS SHIP_FROM_RG_CD
                       ,TPWRX.RTL_WH_CD AS SHIP_FROM_SITE_CD
                       ,NULL AS SHIP_TO_RG_CD
                       ,NULL AS SHIP_TO_SITE_CD
                       ,NULL AS NTWK_CONFIG_NM
                       ,NULL AS CUST_RPT_HIT_FLG
                    FROM
                        INVTY_TRX             IT
                       ,MDSE                  M
                       ,TRD_PTNR_WH_RG_XREF   TPWRX
                       ,PO_DTL                PD
                       ,PO_SER_NUM            PSN
                       ,PRCH_REQ_DTL          PRDT
                       ,PRCH_REQ_SER          PRS
                       ,INVTY_ORD_DTL         IOD
                       ,INVTY_ORD_SER         IOS
                       ,SVC_CONFIG_MSTR       SCM
                       ,MDL_NM                MN1
                       ,MDL_NM                MN2
                       ,MDL_NM                MN3
                       ,RTL_WH                RW
                    WHERE
                        IT.GLBL_CMPY_CD                     = #GLBL_CMPY_CD#
                    AND IT.LOC_STS_CD                       = #LOC_STS_CD_DC_STOCK#
                    AND IT.TRX_CD                           = #TRX_CD_ADJ#
                    <iterate property="TRX_RSN_CD" var="TRX_RSN_CD[]"
                    open="AND IT.TRX_RSN_CD IN   (" conjunction=", " close=")"> #TRX_RSN_CD[]#
                    </iterate>
                    AND SUBSTR(IT.EZUPTIME, 1, 8) BETWEEN TO_CHAR(SYSDATE - 7, 'YYYYMMDD') AND TO_CHAR(SYSDATE, 'YYYYMMDD')
                    AND IT.EZCANCELFLAG                     = '0'
                    AND M.GLBL_CMPY_CD                      = IT.GLBL_CMPY_CD
                    AND M.MDSE_CD                           = IT.MDSE_CD
                    AND M.EXP_ITEM_FLG               &lt;&gt; #FLG_ON_Y#
                    <iterate property="MDSE_ITEM_STS_CD" var="MDSE_ITEM_STS_CD[]"
                    open="AND M.MDSE_ITEM_STS_CD IN   (" conjunction=", " close=")"> #MDSE_ITEM_STS_CD[]#
                    </iterate>
                    <iterate property="MDSE_ITEM_TP_CD" var="MDSE_ITEM_TP_CD[]"
                    open="AND M.MDSE_ITEM_TP_CD IN   (" conjunction=", " close=")"> #MDSE_ITEM_TP_CD[]#
                    </iterate>
                    AND M.MDSE_ITEM_CLS_TP_CD               = #MDSE_ITEM_CLS_TP_OCEOEM#
                    AND M.EZCANCELFLAG                      = '0'
                    AND TPWRX.GLBL_CMPY_CD                  = IT.GLBL_CMPY_CD
                    AND TPWRX.RTL_WH_CD || TPWRX.RTL_SWH_CD = IT.INVTY_LOC_CD
                    AND TPWRX.RTL_WH_CD                     = SUBSTR(IT.INVTY_LOC_CD, 1, LENGTH(IT.INVTY_LOC_CD)-1)
                    AND TPWRX.RTL_SWH_CD                    = #RTL_SWH_CD_GOOD_PARTS#
                    AND TPWRX.EZCANCELFLAG                  = '0'
                    AND PD.GLBL_CMPY_CD(+)                  = IT.GLBL_CMPY_CD
                    AND PD.PO_ORD_NUM(+)                    = IT.PO_ORD_NUM
                    AND PD.PO_ORD_DTL_LINE_NUM(+)           = IT.PO_ORD_DTL_LINE_NUM
                    AND PD.PO_ORD_DTL_LINE_NUM(+)        &gt; 0
                    AND PD.EZCANCELFLAG(+)                  = '0'
                    AND SCM.GLBL_CMPY_CD(+)                 = PD.GLBL_CMPY_CD
                    AND SCM.SVC_CONFIG_MSTR_PK(+)           = PD.SVC_CONFIG_MSTR_PK
                    AND SCM.EZCANCELFLAG(+)                 = '0'
                    AND MN1.T_GLBL_CMPY_CD(+)               = SCM.GLBL_CMPY_CD
                    AND MN1.T_MDL_ID(+)                     = SCM.MDL_ID
                    AND MN1.EZCANCELFLAG(+)                 = '0'
                    AND PSN.GLBL_CMPY_CD(+)                 = PD.GLBL_CMPY_CD
                    AND PSN.KEY_INFO_CD_04(+)               = PD.PO_ORD_NUM
                    AND PSN.KEY_INFO_CD_05(+)               = PD.PO_ORD_DTL_LINE_NUM
                    AND PSN.EZCANCELFLAG(+)                 = '0'
                    AND PRDT.GLBL_CMPY_CD(+)                = IT.GLBL_CMPY_CD
                    AND PRDT.PRCH_REQ_NUM(+)                = IT.INVTY_TRX_SLP_NUM
                    AND PRDT.INVTY_ORD_NUM(+)               = IT.INVTY_ORD_NUM
                    AND PRDT.INVTY_ORD_LINE_NUM(+)          = IT.INVTY_ORD_LINE_NUM
                    AND PRDT.INVTY_ORD_LINE_NUM(+)       &gt; 0
                    AND PRDT.EZCANCELFLAG(+)                = '0'
                    AND SCM.GLBL_CMPY_CD(+)                 = PRDT.GLBL_CMPY_CD
                    AND SCM.SVC_CONFIG_MSTR_PK(+)           = PRDT.SVC_CONFIG_MSTR_PK
                    AND SCM.EZCANCELFLAG(+)                 = '0'
                    AND MN2.T_GLBL_CMPY_CD(+)               = SCM.GLBL_CMPY_CD
                    AND MN2.T_MDL_ID(+)                     = SCM.MDL_ID
                    AND MN2.EZCANCELFLAG(+)                 = '0'
                    AND PRS.GLBL_CMPY_CD(+)                 = PRDT.GLBL_CMPY_CD
                    AND PRS.PRCH_REQ_NUM(+)                 = PRDT.PRCH_REQ_NUM
                    AND PRS.PRCH_REQ_LINE_NUM(+)            = PRDT.PRCH_REQ_LINE_NUM
                    AND PRS.PRCH_REQ_LINE_SUB_NUM(+)        = PRDT.PRCH_REQ_LINE_SUB_NUM
                    AND PRS.EZCANCELFLAG(+)                 = '0'
                    AND IOD.GLBL_CMPY_CD(+)                 = IT.GLBL_CMPY_CD
                    AND IOD.INVTY_ORD_NUM(+)                = IT.INVTY_ORD_NUM
                    AND IOD.INVTY_ORD_LINE_NUM(+)           = IT.INVTY_ORD_LINE_NUM
                    AND IOD.INVTY_ORD_LINE_NUM(+)        &gt; 0
                    AND IOD.EZCANCELFLAG(+)                 = '0'
                    AND SCM.GLBL_CMPY_CD(+)                 = IOD.GLBL_CMPY_CD
                    AND SCM.SVC_CONFIG_MSTR_PK(+)           = IOD.SVC_CONFIG_MSTR_PK
                    AND SCM.EZCANCELFLAG(+)                 = '0'
                    AND MN3.T_GLBL_CMPY_CD(+)               = SCM.GLBL_CMPY_CD
                    AND MN3.T_MDL_ID(+)                     = SCM.MDL_ID
                    AND MN3.EZCANCELFLAG(+)                 = '0'
                    AND IOS.GLBL_CMPY_CD(+)                 = IOD.GLBL_CMPY_CD
                    AND IOS.INVTY_ORD_NUM(+)                = IOD.INVTY_ORD_NUM
                    AND IOS.INVTY_ORD_LINE_NUM(+)           = IOD.INVTY_ORD_LINE_NUM
                    AND IOS.EZCANCELFLAG(+)                 = '0'
                    AND RW.GLBL_CMPY_CD(+)                  = IT.GLBL_CMPY_CD
                    AND RW.RTL_WH_CD(+)                     = SUBSTR(IT.INVTY_LOC_CD, 1, LENGTH(IT.INVTY_LOC_CD)-1)
                    AND RW.EZCANCELFLAG(+)                  = '0'
                )
                GROUP BY
                    MDSE_CD
                   ,WH_RG_CD
                   ,INP_SRC_CD
                   ,MAT_ORD_DT
                   ,MAT_ORD_TM
                   ,MAT_SHIP_QTY
                   ,MAT_SHIP_DT
                   ,MAT_SHIP_TM
                   ,MAT_REQ_DT
                   ,MAT_REQ_TM
                   ,MAT_RCV_DT
                   ,MAT_RCV_TM
                   ,DMND_INFO_ID
                   ,CUST_ORD_ID
                   ,SER_NUM
                   ,DELY_POST_CD
                   ,DELY_CTRY_CD
                   ,DELY_CTY_ADDR
                   ,DELY_ST_CD
                   ,DELY_CUST_NM
                   ,TRX_TP_CD
                   ,DMND_RSP_COMIT_CD
                   ,COV_DAYS_NUM
                   ,COV_HOURS_NUM
                   ,MAJ_ACCT_ID
                   ,DMND_PRTY_CD
                   ,DMND_PROD_CD
                   ,SPEC_RG_CD
                   ,SPEC_SITE_CD
                   ,SHIP_FROM_RG_CD
                   ,SHIP_FROM_SITE_CD
                   ,SHIP_TO_RG_CD
                   ,SHIP_TO_SITE_CD
                   ,NTWK_CONFIG_NM
                   ,CUST_RPT_HIT_FLG
                <!-- END 2022/06/16 F.Fadriquela [QC#60241 ADD] -->
            )
            SELECT
                DI.MDSE_CD
               ,DI.WH_RG_CD
               ,DI.INP_SRC_CD
               ,SUM(DI.VIS_QTY) AS MAT_ORD_QTY
               ,DI.MAT_ORD_DT
               ,DI.MAT_ORD_TM
               ,DI.MAT_SHIP_QTY
               ,DI.MAT_SHIP_DT
               ,DI.MAT_SHIP_TM
               ,DI.MAT_REQ_DT
               ,DI.MAT_REQ_TM
               ,DI.MAT_RCV_DT
               ,DI.MAT_RCV_TM
               ,DI.DMND_INFO_ID
               ,DI.CUST_ORD_ID
               ,DI.SER_NUM
               ,DI.DELY_POST_CD
               ,DI.DELY_CTRY_CD
               ,DI.DELY_CTY_ADDR
               ,DI.DELY_ST_CD
               ,DI.DELY_CUST_NM
               ,UPPER(DI.TRX_TP_CD) AS TRX_TP_CD
               ,DI.DMND_RSP_COMIT_CD
               ,DI.COV_DAYS_NUM
               ,DI.COV_HOURS_NUM
               ,DI.MAJ_ACCT_ID
               ,DI.DMND_PRTY_CD
               ,DI.DMND_PROD_CD
               ,DI.SPEC_RG_CD
               ,DI.SPEC_SITE_CD
               ,DI.SHIP_FROM_RG_CD
               ,DI.SHIP_FROM_SITE_CD
               ,DI.SHIP_TO_RG_CD
               ,DI.SHIP_TO_SITE_CD
               ,DI.NTWK_CONFIG_NM
               ,DI.CUST_RPT_HIT_FLG
            FROM
                DMDD_INFO DI
            GROUP BY
                DI.MDSE_CD
               ,DI.WH_RG_CD
               ,DI.INP_SRC_CD
               ,DI.MAT_ORD_DT
               ,DI.MAT_ORD_TM
               ,DI.MAT_SHIP_QTY
               ,DI.MAT_SHIP_DT
               ,DI.MAT_SHIP_TM
               ,DI.MAT_REQ_DT
               ,DI.MAT_REQ_TM
               ,DI.MAT_RCV_DT
               ,DI.MAT_RCV_TM
               ,DI.DMND_INFO_ID
               ,DI.CUST_ORD_ID
               ,DI.SER_NUM
               ,DI.DELY_POST_CD
               ,DI.DELY_CTRY_CD
               ,DI.DELY_CTY_ADDR
               ,DI.DELY_ST_CD
               ,DI.DELY_CUST_NM
               ,DI.TRX_TP_CD
               ,DI.DMND_RSP_COMIT_CD
               ,DI.COV_DAYS_NUM
               ,DI.COV_HOURS_NUM
               ,DI.MAJ_ACCT_ID
               ,DI.DMND_PRTY_CD
               ,DI.DMND_PROD_CD
               ,DI.SPEC_RG_CD
               ,DI.SPEC_SITE_CD
               ,DI.SHIP_FROM_RG_CD
               ,DI.SHIP_FROM_SITE_CD
               ,DI.SHIP_TO_RG_CD
               ,DI.SHIP_TO_SITE_CD
               ,DI.NTWK_CONFIG_NM
               ,DI.CUST_RPT_HIT_FLG
            ORDER BY DI.MDSE_CD
    </statement>
</sqlMap>