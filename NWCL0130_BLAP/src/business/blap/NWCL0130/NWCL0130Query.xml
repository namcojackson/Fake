<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NWCL0130Query">

    <typeAlias alias="NWCL0130_ASMsg"    type="business.blap.NWCL0130.NWCL0130_ASMsg"/>
    <resultMap id="result.NWCL0130_ASMsg"       class="NWCL0130_ASMsg">
        <result property="conslBillRgnrPk_A1"   column="CONSL_BILL_RGNR_PK"     javaType="EZDCBigDecimalItem"   />
        <result property="billToCustCd_A1"      column="BILL_TO_CUST_CD"        javaType="EZDCStringItem"       />
        <result property="billToDsAcctNum_A1"   column="BILL_TO_CUST_ACCT_CD"   javaType="EZDCStringItem"       />
        <result property="billToDsAcctNm_A1"    column="BILL_TO_CUST_ACCT_NM"   javaType="EZDCStringItem"       />
        <result property="conslBillNum_A1"      column="CONSL_BILL_NUM"         javaType="EZDCStringItem"       />
        <result property="invNum_A1"            column="INV_NUM"                javaType="EZDCStringItem"       />
        <result property="custCareTktNum_A1"    column="CUST_CARE_TKT_NUM"      javaType="EZDCStringItem"       />
        <result property="xxUrnNum_A1"          column="URN_NUMBER"             javaType="EZDCStringItem"       />
        <result property="invDt_A1"             column="INV_DT"                 javaType="EZDCStringItem"       />
        <result property="invTotDealNetAmt_A1"  column="INV_TOT_DEAL_NET_AMT"   javaType="EZDCBigDecimalItem"   />
        <result property="conslRgnrActTpCd_A1"  column="CONSL_RGNR_ACT_TP_CD"   javaType="EZDCStringItem"       />
        <result property="conslRgnrActTpNm_A1"  column="CONSL_RGNR_ACT_TP_NM"   javaType="EZDCStringItem"       />
        <result property="ezUpTime_A1"          column="EZUPTIME"               javaType="EZDCStringItem"       />
        <result property="ezUpTimeZone_A1"      column="EZUPTIMEZONE"           javaType="EZDCStringItem"       />
    </resultMap>
    <statement id ="search" parameterClass="Map" resultMap="result.NWCL0130_ASMsg">
        SELECT * FROM (
        SELECT
            CBR.CONSL_BILL_RGNR_PK
           ,I.BILL_TO_CUST_CD
           ,I.BILL_TO_CUST_ACCT_CD
           ,I.BILL_TO_CUST_ACCT_NM
           ,TO_CHAR(CBR.TRGT_CONSL_BILL_PK) CONSL_BILL_NUM
           ,CBR.INV_NUM
           ,I.CUST_CARE_TKT_NUM
           <isNotNull property="CANON_E479_INV_SRCH_TBL">
           ,CEIST.URN_NUMBER
           </isNotNull>
           <isNull property="CANON_E479_INV_SRCH_TBL">
           ,NULL URN_NUMBER
           </isNull>
           ,I.INV_DT
           ,I.INV_TOT_DEAL_NET_AMT
           ,CBR.CONSL_RGNR_ACT_TP_CD
           ,CRAT.CONSL_RGNR_ACT_TP_NM
           ,CBR.EZUPTIME
           ,CBR.EZUPTIMEZONE
        FROM 
            CONSL_BILL_RGNR CBR
           ,INV I
           <isNotNull property="CANON_E479_INV_SRCH_TBL">
           <!--  ,CANON_E479_INV_SRCH_TBL CEIST-->
           ,(SELECT DISTINCT urn_number, bill_number, INVOICE_PATH, INVOICE_FILE_NAME FROM (
                   SELECT DISTINCT srch.urn_number, srch.invoice_file_name, srch.invoice_path,
                   ceed.bill_number, ceed.invoice_number, ceec.bill_date
                   FROM canon_e479_excel_detail ceed, canon_e479_excel_control ceec, canon_E479_inv_Srch_Tbl srch
                   WHERE ceed.ref_id = ceec.ref_id AND ceed.sequence_id = ceec.sequence_id 
                   AND ceed.rectype = 'DETAIL' and ceec.urn = srch.urn_number
                   AND ( NVL (srch.REVIEW_REQUIRED, 'N') = 'N' OR ( NVL (srch.REVIEW_REQUIRED, 'N') = 'Y' 
                   AND NVL (srch.PENDING_ACTION, 'Y') in ('R', 'S')))
                   )) CEIST
           </isNotNull>
           ,CONSL_RGNR_ACT_TP CRAT
        WHERE
            CBR.EZCANCELFLAG = '0'
        AND CBR.GLBL_CMPY_CD = #glblCmpyCd#
        AND CBR.GLBL_CMPY_CD = I.GLBL_CMPY_CD
        AND I.EZCANCELFLAG = '0'
        AND CBR.INV_NUM = I.INV_NUM
        <isNotNull property="CANON_E479_INV_SRCH_TBL">
        AND TO_CHAR(CBR.TRGT_CONSL_BILL_PK) = CEIST.BILL_NUMBER (+)
        </isNotNull>
        AND CBR.CONSL_RGNR_PROC_CD = #conslRgnrProcCd#
        AND CBR.GLBL_CMPY_CD = CRAT.GLBL_CMPY_CD (+)
        AND CRAT.EZCANCELFLAG (+) = '0'
        AND CBR.CONSL_RGNR_ACT_TP_CD = CRAT.CONSL_RGNR_ACT_TP_CD (+)
        ORDER BY
            I.BILL_TO_CUST_CD
           ,I.BILL_TO_CUST_ACCT_CD
           ,I.BILL_TO_CUST_ACCT_NM
           ,TO_CHAR(CBR.TRGT_CONSL_BILL_PK)
           ,CBR.INV_NUM
           ,I.CUST_CARE_TKT_NUM
           <isNotNull property="CANON_E479_INV_SRCH_TBL">
           ,CEIST.URN_NUMBER
           </isNotNull>
        ) TMP 
        WHERE ROWNUM &lt;= #rowNum#
    </statement>

    <statement id ="searchTotCnt" parameterClass="Map" resultClass="Integer">
        SELECT
            COUNT(*)
        FROM 
            CONSL_BILL_RGNR CBR
           ,INV I
           <isNotNull property="CANON_E479_INV_SRCH_TBL">
           <!--  ,CANON_E479_INV_SRCH_TBL CEIST-->
           ,(SELECT DISTINCT urn_number, bill_number, INVOICE_PATH, INVOICE_FILE_NAME FROM (
                   SELECT DISTINCT srch.urn_number, srch.invoice_file_name, srch.invoice_path,
                   ceed.bill_number, ceed.invoice_number, ceec.bill_date
                   FROM canon_e479_excel_detail ceed, canon_e479_excel_control ceec, canon_E479_inv_Srch_Tbl srch
                   WHERE ceed.ref_id = ceec.ref_id AND ceed.sequence_id = ceec.sequence_id 
                   AND ceed.rectype = 'DETAIL' and ceec.urn = srch.urn_number
                   AND ( NVL (srch.REVIEW_REQUIRED, 'N') = 'N' OR ( NVL (srch.REVIEW_REQUIRED, 'N') = 'Y' 
                   AND NVL (srch.PENDING_ACTION, 'Y') in ('R', 'S')))
                   )) CEIST
           </isNotNull>
        WHERE
            CBR.EZCANCELFLAG = '0'
        AND CBR.GLBL_CMPY_CD = #glblCmpyCd#
        AND CBR.GLBL_CMPY_CD = I.GLBL_CMPY_CD
        AND I.EZCANCELFLAG = '0'
        AND CBR.INV_NUM = I.INV_NUM
        <isNotNull property="CANON_E479_INV_SRCH_TBL">
        AND TO_CHAR(CBR.TRGT_CONSL_BILL_PK) = CEIST.BILL_NUMBER (+)
        </isNotNull>
        AND CBR.CONSL_RGNR_PROC_CD = #conslRgnrProcCd#
    </statement>
    
   <statement id="getInvInfo" parameterClass="Map" resultClass="Map">
        SELECT
            I.INV_NUM
           ,I.BILL_TO_CUST_CD
           ,I.BILL_TO_CUST_ACCT_CD
           ,I.BILL_TO_CUST_ACCT_NM
           ,I.INV_DT
           ,I.PMT_TERM_CASH_DISC_DESC_TXT
           ,I.INV_TOT_DEAL_NET_AMT
           ,I.DS_ORD_CATG_CD
           ,I.DS_ORD_TP_CD
           ,I.DS_ORD_RSN_CD
           ,I.CUST_CARE_TKT_NUM
           ,I.DS_BIZ_AREA_CD
           ,I.CUST_ISS_PO_NUM
           ,SI.DS_CONTR_NUM
           ,SI.BLLG_PER_FROM_DT
                 || DECODE(SI.BLLG_PER_TO_DT, NULL, '', '-')
                 || SI.BLLG_PER_TO_DT BLLG_PER
           ,SI.SER_NUM
           ,SI.MDL_NM
        FROM
            INV I
           ,SVC_INV SI
        WHERE
            I.EZCANCELFLAG = '0'
        AND I.GLBL_CMPY_CD = #glblCmpyCd#
        AND I.INV_NUM = #invNum#
        AND I.GLBL_CMPY_CD = SI.GLBL_CMPY_CD(+)
        AND I.INV_NUM = SI.SVC_INV_NUM(+)
        AND SI.EZCANCELFLAG(+) = '0'
    </statement>
    
   <statement id="getConslBill" parameterClass="Map" resultClass="Map">
		SELECT 
		    TO_CHAR(CB.CONSL_BILL_PK) CONSL_BILL_NUM
		   ,CB.CUST_INV_SRC_CD
		   ,CB.INV_GRP_NUM
		FROM 
		    CONSL_BILL CB 
		WHERE
		    CB.EZCANCELFLAG = '0'
        AND CB.GLBL_CMPY_CD = #glblCmpyCd#
        AND TO_CHAR(CB.CONSL_BILL_PK) = #conslBillNum#
    </statement>

    <statement id="getBillInvReln" parameterClass="Map" resultClass="Map">
        SELECT 
            TO_CHAR(CBL.CONSL_BILL_PK) CONSL_BILL_NUM
        FROM 
            CONSL_BILL_LINE CBL 
        WHERE
            CBL.EZCANCELFLAG = '0'
        AND CBL.GLBL_CMPY_CD = #glblCmpyCd#
        AND TO_CHAR(CBL.CONSL_BILL_PK) = #conslBillNum#
        AND CBL.CONSL_BILL_TRX_ID = #invNum#
    </statement>
    
    <statement id="getBillInvBillToCust" parameterClass="Map" resultClass="Map">
        SELECT 
            INV.BILL_TO_CUST_CD
        FROM
            (
            SELECT 
                I.BILL_TO_CUST_CD
            FROM 
                INV I
            WHERE
                I.EZCANCELFLAG = '0'
            AND I.GLBL_CMPY_CD = #glblCmpyCd#
            AND I.INV_NUM = #invNum#
            ) INV
           ,(
            SELECT 
                CB.BILL_TO_CUST_CD
            FROM 
                CONSL_BILL CB
            WHERE
                CB.EZCANCELFLAG = '0'
            AND CB.GLBL_CMPY_CD = #glblCmpyCd#
            AND TO_CHAR(CB.CONSL_BILL_PK) = #conslBillNum#
            ) BILL
        WHERE
            INV.BILL_TO_CUST_CD = BILL.BILL_TO_CUST_CD
    </statement>
    
    <statement id="getEasyPackInvoice" parameterClass="Map" resultClass="Map">
        SELECT
            I.INV_NUM
        FROM
            INV I
           ,ORD_CATG_BIZ_CTX OCBC
        WHERE
            I.EZCANCELFLAG = '0'
		AND I.GLBL_CMPY_CD = #glblCmpyCd#
		AND I.INV_NUM = #invNum#
		AND OCBC.EZCANCELFLAG = '0'
		AND OCBC.GLBL_CMPY_CD = #glblCmpyCd#
		AND (I.DS_ORD_CATG_CD = OCBC.DS_ORD_CATG_CD
		  OR OCBC.DS_ORD_CATG_CD IS NULL)
		AND (I.DS_ORD_TP_CD = OCBC.DS_ORD_TP_CD
		  OR OCBC.DS_ORD_TP_CD IS NULL)
		AND (I.DS_ORD_RSN_CD = OCBC.DS_ORD_RSN_CD
		  OR OCBC.DS_ORD_RSN_CD IS NULL)
		AND OCBC.ORD_CATG_CTX_TP_CD IN (#easyPack1#,#easyPack1Return#)
		AND EXISTS (
	        SELECT 
	            '1'
	        FROM
	            SPLY_PGM_CONTR SPC
	        WHERE
	            SPC.GLBL_CMPY_CD     = #glblCmpyCd#
	        AND SPC.EZCANCELFLAG     = '0'
	        AND SPC.BILL_TO_CUST_ACCT_CD = I.BILL_TO_CUST_ACCT_CD
	        AND SPC.EFF_FROM_DT &lt;= I.INV_DT
	        AND NVL(SPC.EFF_THRU_DT,'99991231') &gt;= I.INV_DT
		)
    </statement>
    
    <statement id="getEasyPackBill" parameterClass="Map" resultClass="Map">
        SELECT
            TO_CHAR(CBL.CONSL_BILL_PK) CONSL_BILL_NUM
        FROM
            CONSL_BILL_LINE CBL
        WHERE
            CBL.EZCANCELFLAG = '0'
        AND GLBL_CMPY_CD = #glblCmpyCd#
        AND TO_CHAR(CBL.CONSL_BILL_PK) = #conslBillNum#
        AND EXISTS (
	        SELECT
	            '1'
	        FROM
	            INV I
	           ,ORD_CATG_BIZ_CTX OCBC
	        WHERE
	            I.EZCANCELFLAG = '0'
	        AND I.GLBL_CMPY_CD = #glblCmpyCd#
	        AND I.INV_NUM = CBL.CONSL_BILL_TRX_ID
	        AND OCBC.EZCANCELFLAG = '0'
	        AND OCBC.GLBL_CMPY_CD = #glblCmpyCd#
	        AND (I.DS_ORD_CATG_CD = OCBC.DS_ORD_CATG_CD
	          OR OCBC.DS_ORD_CATG_CD IS NULL)
	        AND (I.DS_ORD_TP_CD = OCBC.DS_ORD_TP_CD
	          OR OCBC.DS_ORD_TP_CD IS NULL)
	        AND (I.DS_ORD_RSN_CD = OCBC.DS_ORD_RSN_CD
	          OR OCBC.DS_ORD_RSN_CD IS NULL)
	        AND OCBC.ORD_CATG_CTX_TP_CD IN (#easyPack1#,#easyPack1Return#)
	        AND EXISTS (
	            SELECT 
	                '1'
	            FROM
	                SPLY_PGM_CONTR SPC
	            WHERE
	                SPC.GLBL_CMPY_CD     = #glblCmpyCd#
	            AND SPC.EZCANCELFLAG     = '0'
	            AND SPC.BILL_TO_CUST_ACCT_CD = I.BILL_TO_CUST_ACCT_CD
	            AND SPC.EFF_FROM_DT &lt;= I.INV_DT
	            AND NVL(SPC.EFF_THRU_DT,'99991231') &gt;= I.INV_DT
	        )
        )
    </statement>
    <statement id="getInvInfoSpecialBill" parameterClass="Map" resultClass="Map">
        SELECT
            IPC.INV_NUM
        FROM
            INV_PRT_CTRL IPC
        WHERE
            IPC.GLBL_CMPY_CD     = #glblCmpyCd#
        AND IPC.EZCANCELFLAG     = '0'
        AND IPC.INV_PROC_TP_CD IN ('SB', 'MSB')
        AND IPC.INV_NUM          = #invNum#
    </statement>
    <statement id="getProcessedInvInfoSpecialBill" parameterClass="Map" resultClass="Map">
        SELECT
            IPC.INV_NUM
        FROM
            INV_PRT_CTRL IPC
        WHERE
            IPC.GLBL_CMPY_CD     = #glblCmpyCd#
        AND IPC.EZCANCELFLAG     = '0'
        AND IPC.INV_PROC_TP_CD IN ('SB', 'MSB')
        AND IPC.INV_NUM          = #invNum#
        <isNull property="conslRgnrActTpCd">
        AND IPC.INV_SPCL_BILL_PROC_STS_CD = '2'
        </isNull>
        <isNotNull property="CANON_E479_INV_SRCH_TBL">
        AND ((IPC.CONSL_BILL_NUM IS NOT NULL 
        AND EXISTS (SELECT '1' FROM canon_e479_excel_detail ceed, 
         canon_e479_excel_control ceec, canon_E479_inv_Srch_Tbl srch
         WHERE ceed.ref_id = ceec.ref_id 
         AND ceed.sequence_id = ceec.sequence_id 
         AND ceed.rectype = 'DETAIL'
         and ceec.urn = srch.urn_number
         AND ( NVL (srch.REVIEW_REQUIRED, 'N') = 'N' OR ( NVL (srch.REVIEW_REQUIRED, 'N') = 'Y'
         AND NVL (srch.PENDING_ACTION, 'Y') in ('R', 'S')))
         AND ceed.BILL_NUMBER = IPC.CONSL_BILL_NUM)
        ) OR 
        (IPC.CONSL_BILL_NUM IS NULL)
        )
        </isNotNull>
    </statement>
    <statement id="getProcessedBillInfoSpecialBill" parameterClass="Map" resultClass="Map">
        SELECT
            IPC.INV_NUM
        FROM
            INV_PRT_CTRL IPC
        WHERE
            IPC.GLBL_CMPY_CD     = #glblCmpyCd#
        AND IPC.EZCANCELFLAG     = '0'
        AND IPC.CONSL_BILL_NUM   = #conslBillNum#
        AND IPC.INV_PRT_CTRL_REC_CD = 'BILL'
        AND IPC.INV_SPCL_BILL_PROC_STS_CD = '2'
        <isNotNull property="CANON_E479_INV_SRCH_TBL">
        AND EXISTS (SELECT '1' FROM canon_e479_excel_detail ceed, 
         canon_e479_excel_control ceec, canon_E479_inv_Srch_Tbl srch
         WHERE ceed.ref_id = ceec.ref_id 
         AND ceed.sequence_id = ceec.sequence_id 
         AND ceed.rectype = 'DETAIL'
         and ceec.urn = srch.urn_number
         AND ( NVL (srch.REVIEW_REQUIRED, 'N') = 'N' OR ( NVL (srch.REVIEW_REQUIRED, 'N') = 'Y'
         AND NVL (srch.PENDING_ACTION, 'Y') in ('R', 'S')))
         AND ceed.BILL_NUMBER = IPC.CONSL_BILL_NUM)
        </isNotNull>
    </statement>
    <statement id="getConslBillGrp" parameterClass="Map" resultClass="Map">
        SELECT
             DEF_INV_GRP_CD
            ,DEF_INV_GRP_TXT
        FROM
            CONSL_BILL_GRP
        WHERE
            GLBL_CMPY_CD        = #glblCmpyCd#
        AND TO_CHAR(CONSL_BILL_PK)       = #conslBillNum#
        AND EZCANCELFLAG        = '0'
    </statement>
    <statement id="getOriginalConslBillForAdd" parameterClass="Map" resultClass="Map">
        SELECT
             TO_CHAR(CBL.CONSL_BILL_PK) CONSL_BILL_NUM
        FROM
            CONSL_BILL_LINE CBL
           ,CONSL_BILL CB
        WHERE
            CBL.GLBL_CMPY_CD = #glblCmpyCd#
        AND CBL.EZCANCELFLAG = '0'
        AND CBL.CONSL_BILL_TRX_ID = #invNum#
        AND CBL.GLBL_CMPY_CD = CB.GLBL_CMPY_CD
        AND CBL.CONSL_BILL_PK = CB.CONSL_BILL_PK
        AND CB.EZCANCELFLAG = '0'
        AND CB.CONSL_STS_CD = '10'
    </statement>
</sqlMap>
