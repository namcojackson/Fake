<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NWAL1540Query">

    <statement id="getVrsnNumList" parameterClass="Map" resultClass="BigDecimal">
        SELECT
                  OP.ORD_PRFT_VRSN_NUM 
            FROM
                ORD_PRFT OP 
            WHERE
                OP.GLBL_CMPY_CD     = #glblCmpyCd#
                AND OP.TRX_HDR_NUM  = #trxHdrNum#
                AND OP.EZCANCELFLAG = '0' 
            ORDER BY
                OP.ORD_PRFT_VRSN_NUM DESC
    </statement>

    <statement id="getOrdPrftHeaderInfo" parameterClass="Map" resultMap="rm.getOrdPrftHeaderInfo">
        SELECT
                FUNC_NEGO_DEAL_AMT
                , TOT_FUNC_REP_REV_AMT
                , TOT_FUNC_FINAL_FL_AMT
                , TOT_FUNC_DLR_CR_AMT
                , LAST_PRFT_CALC_USR_ID
                , AP.LAST_NM            AS PSN_LAST_NM
                , AP.FIRST_NM           AS PSN_FIRST_NM
                , LAST_PRFT_CALC_TS
                , GRS_PRFT_PCT
                , FUNC_GRS_PRFT_AMT     -- 2016/03/10 S21_NA2939
                , FUNC_ALT_GRS_PRFT_AMT
                , ALT_GRS_PRFT_PCT
                , TOT_FUNC_MSRP_AMT
                , TOT_FUNC_STD_FL_AMT
                , TOT_FUNC_FL_ADJ_AMT
                , CSMP_ORD_FLG
                , TOT_FUNC_CSMP_CR_AMT
                , CSMP_CONTR_NUM
                , TOT_FUNC_BYOT_AMT
                , TOT_FUNC_SVC_REV_TRNSF_AMT
                , TOT_FUNC_SVC_COST_TRNSF_AMT
                , TOT_FUNC_PRO_SVC_AMT
                , LAST_PRFT_CALC_USR_ID -- 2016/03/10 S21_NA2939
                , LAST_PRFT_CALC_TS     -- 2016/03/10 S21_NA2939
                , ORD_PRFT_VRSN_NUM     -- 2016/03/24 S21_NA5985
                , TOT_FUNC_FNDR_FEE_AMT       -- 2016/04/03 S21_NA6298
                , TOT_FUNC_ISTL_CR_AMT        -- 2016/04/03 S21_NA6298
                , TOT_FUNC_SPLY_AMT           -- 2016/04/03 S21_NA6298
                , TOT_FUNC_OM_MAINT_BLLBL_AMT -- 2016/04/03 S21_NA6298
            FROM
                ORD_PRFT  OP
                , AUTH_PSN AP
            WHERE
                OP.GLBL_CMPY_CD          = #glblCmpyCd#
                AND OP.TRX_HDR_NUM       = #trxHdrNum#
                AND OP.ORD_PRFT_VRSN_NUM = (
                    <isNull property="ordPrftVrsnNum">
                    SELECT
                              MAX(P.ORD_PRFT_VRSN_NUM) 
                        FROM
                            ORD_PRFT P 
                        WHERE
                            P.GLBL_CMPY_CD     = #glblCmpyCd#
                            AND P.TRX_HDR_NUM  = #trxHdrNum#
                            AND P.EZCANCELFLAG = '0'
                    </isNull>
                    <isNotNull property="ordPrftVrsnNum">
                    #ordPrftVrsnNum#
                    </isNotNull>
                )
                AND OP.EZCANCELFLAG          = '0'
                AND OP.GLBL_CMPY_CD          = AP.GLBL_CMPY_CD(+)
                AND OP.LAST_PRFT_CALC_USR_ID = AP.USR_NM(+)
                AND AP.EZCANCELFLAG(+)        = '0'
    </statement>

    <typeAlias alias="NWAL1540CMsg"    type="business.blap.NWAL1540.NWAL1540CMsg"/>

    <resultMap id="rm.getOrdPrftHeaderInfo" class="NWAL1540CMsg">
        <result property="funcNegoDealAmt"              column="FUNC_NEGO_DEAL_AMT"             javaType="EZDCBigDecimalItem"/>
        <result property="totFuncRepRevAmt"             column="TOT_FUNC_REP_REV_AMT"           javaType="EZDCBigDecimalItem"/>
        <result property="totFuncFinalFlAmt"            column="TOT_FUNC_FINAL_FL_AMT"          javaType="EZDCBigDecimalItem"/>
        <result property="totFuncDlrCrAmt"              column="TOT_FUNC_DLR_CR_AMT"            javaType="EZDCBigDecimalItem"/>
        <result property="lastPrftCalcUsrId"            column="LAST_PRFT_CALC_USR_ID"          javaType="EZDCStringItem"/>
        <result property="psnLastNm"                    column="PSN_LAST_NM"                    javaType="EZDCStringItem"/>
        <result property="psnFirstNm"                   column="PSN_FIRST_NM"                   javaType="EZDCStringItem"/>
        <result property="lastPrftCalcTs"               column="LAST_PRFT_CALC_TS"              javaType="EZDCStringItem"/>
        <result property="grsPrftPct"                   column="GRS_PRFT_PCT"                   javaType="EZDCBigDecimalItem"/>
        <result property="funcGrsPrftAmt"               column="FUNC_GRS_PRFT_AMT"              javaType="EZDCBigDecimalItem"/>
        <result property="funcAltGrsPrftAmt"            column="FUNC_ALT_GRS_PRFT_AMT"          javaType="EZDCBigDecimalItem"/>
        <result property="altGrsPrftPct"                column="ALT_GRS_PRFT_PCT"               javaType="EZDCBigDecimalItem"/>
        <result property="totFuncMsrpAmt"               column="TOT_FUNC_MSRP_AMT"              javaType="EZDCBigDecimalItem"/>
        <result property="totFuncStdFlAmt"              column="TOT_FUNC_STD_FL_AMT"            javaType="EZDCBigDecimalItem"/>
        <result property="totFuncFlAdjAmt"              column="TOT_FUNC_FL_ADJ_AMT"            javaType="EZDCBigDecimalItem"/>
        <result property="csmpOrdFlg"                   column="CSMP_ORD_FLG"                   javaType="EZDCStringItem"/>
        <result property="totFuncCsmpCrAmt"             column="TOT_FUNC_CSMP_CR_AMT"           javaType="EZDCBigDecimalItem"/>
        <result property="csmpContrNum"                 column="CSMP_CONTR_NUM"                 javaType="EZDCStringItem"/>
        <result property="totFuncByotAmt"               column="TOT_FUNC_BYOT_AMT"              javaType="EZDCBigDecimalItem"/>
        <result property="totFuncSvcRevTrnsfAmt"        column="TOT_FUNC_SVC_REV_TRNSF_AMT"     javaType="EZDCBigDecimalItem"/>
        <result property="totFuncSvcCostTrnsfAmt"       column="TOT_FUNC_SVC_COST_TRNSF_AMT"    javaType="EZDCBigDecimalItem"/>
        <result property="totFuncProSvcAmt"             column="TOT_FUNC_PRO_SVC_AMT"           javaType="EZDCBigDecimalItem"/>
        <result property="xxScrItem81Txt"               column="LAST_PRFT_CALC_USR_ID"          javaType="EZDCStringItem"/>
        <result property="xxScrItem19Txt"               column="LAST_PRFT_CALC_TS"              javaType="EZDCStringItem"/>
        <result property="ordPrftVrsnNum"               column="ORD_PRFT_VRSN_NUM"              javaType="EZDCBigDecimalItem"/>
        <result property="xxOrdPrftFndrFeeAmt"          column="TOT_FUNC_FNDR_FEE_AMT"          javaType="EZDCBigDecimalItem"/>
        <result property="xxOrdPrftIstlCrAmt"           column="TOT_FUNC_ISTL_CR_AMT"           javaType="EZDCBigDecimalItem"/>
        <result property="xxOrdPrftSplyAmt"             column="TOT_FUNC_SPLY_AMT"              javaType="EZDCBigDecimalItem"/>
        <result property="xxOrdPrftSvcAmt"              column="TOT_FUNC_OM_MAINT_BLLBL_AMT"    javaType="EZDCBigDecimalItem"/>
    </resultMap>

    <statement id="getPrftCalcInfoForOrder" parameterClass="Map" resultClass="Map">
        WITH V AS ( 
            SELECT
                      C.GLBL_CMPY_CD
                    , C.ORD_HDR_STS_CD
                    , LC.DS_ORD_LINE_DRCTN_CD
                    , C.DS_ORD_CATG_CD
                    , C.DS_ORD_TP_CD
                    , C.DS_ORD_RSN_CD
                    , C.PRC_BASE_DT
                    , C.PRC_CALC_DT
                    , C.NEGO_DEAL_AMT
                    , C.CSMP_CONTR_NUM
                    , C.DLR_REF_NUM
                    , CD.CPO_DTL_LINE_NUM           TRX_LINE_NUM
                    , CD.CPO_DTL_LINE_SUB_NUM       TRX_LINE_SUB_NUM
                    , CD.DS_ORD_POSN_NUM
                    , CD.DS_CPO_LINE_NUM
                    , CD.DS_CPO_LINE_SUB_NUM
                    , CD.MDSE_CD
                    , CD.RTL_WH_CD
                    , CD.RTL_SWH_CD
                    , CD.DS_ORD_LINE_CATG_CD
                    , CD.ORD_QTY
                    , CD.CUST_UOM_CD
                    , CD.REF_CPO_DTL_LINE_NUM
                    , CD.REF_CPO_DTL_LINE_SUB_NUM
                    , CD.FL_PRC_LIST_CD
                    , CD.FUNC_PRC_LIST_PRC_AMT
                    , CD.ENT_FUNC_NET_UNIT_PRC_AMT  FUNC_NET_UNIT_PRC_AMT
                    , CD.CPO_DTL_FUNC_NET_AMT       FUNC_NET_AMT
                    , CD.FUNC_MAN_FL_ADJ_AMT
                    , CD.FUNC_SVC_COST_TRNSF_AMT
                    , CD.FUNC_MAN_REP_REV_ADJ_AMT
                    , CD.FUNC_SVC_REV_TRNSF_AMT
                    , DCC.CONFIG_CATG_CD
                    , #ordPrftTrxCatgOutBound#      ORD_PRFT_TRX_CATG_CD
                    , CD.CSMP_PRC_LIST_CD          -- 2016/03/10 S21_NA2939
                  --  , CD.CPO_DTL_FUNC_SLS_AMT       -- 2016/03/10 S21_NA2939
                    , CD.CPO_DTL_FUNC_NET_AMT       CPO_DTL_FUNC_SLS_AMT  -- QC7301
                    , CD.ORD_CUST_UOM_QTY           -- 2016/03/10 S21_NA2939
                    , CD.CSMP_CONTR_NUM            DTL_CSMP_CONTR_NUM -- 2016/03/10 S21_NA2939
                    , CD.DLR_REF_NUM               DTL_DLR_REF_NUM    -- 2016/03/10 S21_NA2939
                    , CD.PRC_CATG_CD                -- QC7707
                    , CP.COA_PROJ_NM                -- QC15193
                    --, CMT.COA_MDSE_TP_NM          -- QC7707  --QC15193
                    --
                    , CD.ORD_LINE_STS_CD            LINE_STS_CD
                    , C.BILL_TO_CUST_CD
                    , C.SELL_TO_CUST_CD
                    , CD.SHIP_TO_CUST_CD
                    , DCC.BILL_TO_CUST_ACCT_CD
                    , DCC.BILL_TO_CUST_LOC_CD
                    , DCC.SHIP_TO_CUST_ACCT_CD
                    , DCC.SHIP_TO_CUST_LOC_CD
                    --
                    , M.THIS_MTH_TOT_STD_COST_AMT
                    , CD.PRC_BASE_DT              LINE_PRC_BASE_DT-- QC9347
                    , CD.FUNC_UNIT_FL_PRC_AMT
                FROM
                    CPO                 C
                    , DS_CPO_CONFIG     DCC
                    , CPO_DTL           CD
                    , DS_ORD_LINE_CATG  LC
                    , ALL_MDSE_V        M
                    , COA_PROJ          CP                            --QC15193
                    --, COA_MDSE_TP       CMT                           -- QC7707
                WHERE
                    C.GLBL_CMPY_CD              = #glblCmpyCd#
                    AND C.CPO_ORD_NUM           = #trxHdrNum#
                    AND C.EZCANCELFLAG          = '0'
                    AND DCC.GLBL_CMPY_CD        = CD.GLBL_CMPY_CD
                    AND DCC.CPO_ORD_NUM         = CD.CPO_ORD_NUM
                    AND DCC.DS_ORD_POSN_NUM     = CD.DS_ORD_POSN_NUM
                    AND DCC.CONFIG_CATG_CD      = #outBound#
                    AND DCC.EZCANCELFLAG        = '0'
                    AND C.GLBL_CMPY_CD          = CD.GLBL_CMPY_CD
                    AND C.CPO_ORD_NUM           = CD.CPO_ORD_NUM
                    AND CD.CPO_DTL_CANC_FLG     = 'N'
                    AND CD.SET_MDSE_CD         IS NULL
                    AND CD.EZCANCELFLAG         = '0'
                    AND CD.GLBL_CMPY_CD         = LC.GLBL_CMPY_CD
                    AND CD.DS_ORD_LINE_CATG_CD  = LC.DS_ORD_LINE_CATG_CD
                    AND LC.EZCANCELFLAG         = '0'
                    --
                    AND CD.GLBL_CMPY_CD         = M.GLBL_CMPY_CD(+)
                    AND CD.MDSE_CD              = M.MDSE_CD(+)
                    <!--AND M.RGTN_STS_CD(+)        = #rgtnStsCd#--> -- 2016/03/10 S21_NA2939
                    AND M.EZCANCELFLAG(+)       = '0'
                    AND CP.GLBL_CMPY_CD(+)     = M.GLBL_CMPY_CD     -- QC15193
                    AND CP.COA_PROJ_CD(+)      = M.COA_MDSE_TP_CD   -- QC15193
                    AND CP.EZCANCELFLAG(+)     = '0'                -- QC15193
                    --AND CMT.GLBL_CMPY_CD(+)     = M.GLBL_CMPY_CD     -- QC7707
                    --AND CMT.COA_MDSE_TP_CD(+)   = M.COA_MDSE_TP_CD   -- QC7707
                    --AND CMT.EZCANCELFLAG(+)     = '0'                -- QC7707
            UNION ALL 
            SELECT
                      C.GLBL_CMPY_CD
                    , C.ORD_HDR_STS_CD
                    , LC.DS_ORD_LINE_DRCTN_CD
                    , C.DS_ORD_CATG_CD
                    , C.DS_ORD_TP_CD
                    , C.DS_ORD_RSN_CD
                    , C.PRC_BASE_DT
                    , C.PRC_CALC_DT
                    , C.NEGO_DEAL_AMT
                    , C.CSMP_CONTR_NUM
                    , C.DLR_REF_NUM
                    , DCRD.DS_CPO_RTRN_LINE_NUM         TRX_LINE_NUM
                    , DCRD.DS_CPO_RTRN_LINE_SUB_NUM     TRX_LINE_SUB_NUM
                    , DCRD.DS_ORD_POSN_NUM
                    , DCRD.DS_CPO_LINE_NUM
                    , DCRD.DS_CPO_LINE_SUB_NUM
                    , DCRD.MDSE_CD
                    , DCRD.RTL_WH_CD
                    , DCRD.RTL_SWH_CD
                    , DCRD.DS_ORD_LINE_CATG_CD
                    , DCRD.ORD_QTY
                    , DCRD.CUST_UOM_CD
                    , DCRD.REF_CPO_DTL_LINE_NUM
                    , DCRD.REF_CPO_DTL_LINE_SUB_NUM
                    , DCRD.FL_PRC_LIST_CD
                    , DCRD.FUNC_PRC_LIST_PRC_AMT
                    , DCRD.ENT_FUNC_NET_UNIT_PRC_AMT    FUNC_NET_UNIT_PRC_AMT
                    , DCRD.CPO_DTL_FUNC_NET_AMT         FUNC_NET_AMT
                    , DCRD.FUNC_MAN_FL_ADJ_AMT
                    , DCRD.FUNC_SVC_COST_TRNSF_AMT
                    , DCRD.FUNC_MAN_REP_REV_ADJ_AMT
                    , DCRD.FUNC_SVC_REV_TRNSF_AMT
                    , DCC.CONFIG_CATG_CD
                    , #ordPrftTrxCatgInBound#           ORD_PRFT_TRX_CATG_CD
                    , DCRD.CSMP_PRC_LIST_CD          -- 2016/03/10 S21_NA2939
                   -- , DCRD.CPO_DTL_FUNC_SLS_AMT      -- 2016/03/10 S21_NA2939
                    , DCRD.CPO_DTL_FUNC_NET_AMT      CPO_DTL_FUNC_SLS_AMT  -- QC7301
                    , DCRD.ORD_CUST_UOM_QTY          -- 2016/03/10 S21_NA2939
                    , DCRD.CSMP_CONTR_NUM            DTL_CSMP_CONTR_NUM -- 2016/03/10 S21_NA2939
                    , DCRD.DLR_REF_NUM               DTL_DLR_REF_NUM    -- 2016/03/10 S21_NA2939
                    , DCRD.PRC_CATG_CD               -- QC7707
                    , CP.COA_PROJ_NM                 -- QC15193
                    --, CMT.COA_MDSE_TP_NM            -- QC7707
                    --
                    , DCRD.RTRN_LINE_STS_CD             LINE_STS_CD
                    , C.BILL_TO_CUST_CD
                    , C.SELL_TO_CUST_CD
                    , DCRD.SHIP_TO_CUST_CD
                    , DCC.BILL_TO_CUST_ACCT_CD
                    , DCC.BILL_TO_CUST_LOC_CD
                    , DCC.SHIP_TO_CUST_ACCT_CD
                    , DCC.SHIP_TO_CUST_LOC_CD
                    --
                    , M.THIS_MTH_TOT_STD_COST_AMT
                    , DCRD.PRC_BASE_DT              LINE_PRC_BASE_DT -- QC9347
                    , DCRD.FUNC_UNIT_FL_PRC_AMT
                FROM
                    CPO C
                    , DS_CPO_CONFIG    DCC
                    , DS_CPO_RTRN_DTL  DCRD
                    , DS_ORD_LINE_CATG LC
                    , ALL_MDSE_V       M
                    , COA_PROJ         CP
                    --, COA_MDSE_TP       CMT                           -- QC7707
                WHERE
                    C.GLBL_CMPY_CD               = #glblCmpyCd#
                    AND C.CPO_ORD_NUM            = #trxHdrNum#
                    AND C.EZCANCELFLAG           = '0'
                    AND DCC.GLBL_CMPY_CD         = DCRD.GLBL_CMPY_CD
                    AND DCC.CPO_ORD_NUM          = DCRD.CPO_ORD_NUM
                    AND DCC.DS_ORD_POSN_NUM      = DCRD.DS_ORD_POSN_NUM
                    AND DCC.CONFIG_CATG_CD       = #inBound#
                    AND DCC.EZCANCELFLAG         = '0'
                    AND C.GLBL_CMPY_CD           = DCRD.GLBL_CMPY_CD
                    AND C.CPO_ORD_NUM            = DCRD.CPO_ORD_NUM
                    AND DCRD.CPO_DTL_CANC_FLG    = 'N'
                    AND DCRD.SET_MDSE_CD        IS NULL
                    AND DCRD.EZCANCELFLAG        = '0'
                    AND DCRD.GLBL_CMPY_CD        = LC.GLBL_CMPY_CD
                    AND DCRD.DS_ORD_LINE_CATG_CD = LC.DS_ORD_LINE_CATG_CD
                    AND LC.EZCANCELFLAG          = '0'
                    --
                    AND DCRD.GLBL_CMPY_CD       = M.GLBL_CMPY_CD(+)
                    AND DCRD.MDSE_CD            = M.MDSE_CD(+)
                    <!--AND M.RGTN_STS_CD(+)        = #rgtnStsCd#--> -- 2016/03/10 S21_NA2939
                    AND M.EZCANCELFLAG(+)       = '0'
                    AND CP.GLBL_CMPY_CD(+)      = M.GLBL_CMPY_CD     -- QC15193
                    AND CP.COA_PROJ_CD(+)       = M.COA_MDSE_TP_CD   -- QC15193
                    AND CP.EZCANCELFLAG(+)      = '0'                -- QC15193
                    --AND CMT.GLBL_CMPY_CD(+)     = M.GLBL_CMPY_CD     -- QC7707
                    --AND CMT.COA_MDSE_TP_CD(+)   = M.COA_MDSE_TP_CD   -- QC7707
                    --AND CMT.EZCANCELFLAG(+)     = '0'                -- QC7707
        ) 
        SELECT
                  V.*
            FROM
                V
                , ORD_PRFT_TRX_CATG TC 
            WHERE
                TC.GLBL_CMPY_CD             = #glblCmpyCd#
                AND TC.ORD_PRFT_TRX_CATG_CD = V.ORD_PRFT_TRX_CATG_CD
                AND TC.EZCANCELFLAG         = '0'
                AND NOT EXISTS( -- 2016/03/30 S21_NA6292
                               SELECT '1'
                               FROM
                                     DS_ORD_TP_PROC_DFN      PD
                                   , ORD_PRFT_LINE_CATG_RULE LCR
                               WHERE 
                                   PD.GLBL_CMPY_CD  = V.GLBL_CMPY_CD
                               AND PD.DS_ORD_TP_CD  = V.DS_ORD_TP_CD
                               AND PD.EFF_FROM_DT   &lt;= #slsDt#
                               AND ( PD.EFF_THRU_DT &gt;= #slsDt# OR PD.EFF_THRU_DT IS NULL )
                               AND PD.ACTV_FLG      = 'Y'
                               AND PD.EZCANCELFLAG  = '0'
                               AND PD.GLBL_CMPY_CD  = LCR.GLBL_CMPY_CD
                               AND LCR.ORD_PROC_NODE_PRFL_CD = PD.PRFT_APVL_NODE_PRFL_CD
                               AND LCR.DS_ORD_LINE_CATG_CD   = V.DS_ORD_LINE_CATG_CD
                               AND LCR.EFF_FROM_DT   &lt;= #slsDt#
                               AND ( LCR.EFF_THRU_DT &gt;= #slsDt# OR LCR.EFF_THRU_DT IS NULL )
                               AND LCR.ACTV_FLG     = 'Y'
                               AND LCR.EZCANCELFLAG = '0'
                    )
                AND NOT EXISTS( -- 2016/03/30 S21_NA6292
                               SELECT '1'
                               FROM
                                     DS_ORD_TP_PROC_DFN      PD
                                   , ORD_PRFT_WH_RULE        WHR
                               WHERE 
                                   PD.GLBL_CMPY_CD  = V.GLBL_CMPY_CD
                               AND PD.DS_ORD_TP_CD  = V.DS_ORD_TP_CD
                               AND PD.EFF_FROM_DT   &lt;= #slsDt#
                               AND ( PD.EFF_THRU_DT &gt;= #slsDt# OR PD.EFF_THRU_DT IS NULL )
                               AND PD.ACTV_FLG      = 'Y'
                               AND PD.EZCANCELFLAG  = '0'
                               AND PD.GLBL_CMPY_CD  = WHR.GLBL_CMPY_CD
                               AND WHR.ORD_PROC_NODE_PRFL_CD = PD.PRFT_APVL_NODE_PRFL_CD
                               AND WHR.RTL_WH_CD    = V.RTL_WH_CD
                               AND NVL (WHR.RTL_SWH_CD, '1') = NVL (V.RTL_SWH_CD, '1')
                               AND WHR.EFF_FROM_DT   &lt;= #slsDt#
                               AND ( WHR.EFF_THRU_DT &gt;= #slsDt# OR WHR.EFF_THRU_DT IS NULL )
                               AND WHR.ACTV_FLG     = 'Y'
                               AND WHR.EZCANCELFLAG = '0'
                    )
            ORDER BY
                TC.ORD_PRFT_TRX_CATG_SORT_NUM
                , CAST(V.DS_ORD_POSN_NUM AS NUMBER) -- 2016/09/23 QC14388
                , CAST(V.DS_CPO_LINE_NUM AS NUMBER) -- 2016/09/23 QC14388
    </statement>

    <statement id="getPrftCalcInfoForQuote" parameterClass="Map" resultClass="Map">
        SELECT
                  SQ.SPLY_QUOTE_STS_CD
                , SQ.DS_ORD_CATG_CD
                , SQ.DS_ORD_TP_CD
                , SQ.DS_ORD_RSN_CD
                , SQ.PRC_BASE_DT
                , SQ.PRC_CALC_DT
                , SQ.CPO_ORD_TP_CD
                , ''                                NEGO_DEAL_AMT -- 2016/03/10 S21_NA2939
                , ''                                CSMP_CONTR_NUM
                , ''                                DLR_REF_NUM
                , SQD.SPLY_QUOTE_DTL_LINE_NUM       TRX_LINE_NUM
                , SQD.SPLY_QUOTE_DTL_LINE_SUB_NUM   TRX_LINE_SUB_NUM
                , '1'                               DS_ORD_POSN_NUM
                , SQD.DPLY_QUOTE_LINE_NUM           DS_CPO_LINE_NUM
                , SQD.DPLY_QUOTE_LINE_SUB_NUM       DS_CPO_LINE_SUB_NUM
                , SQD.MDSE_CD
                , SQD.RTL_WH_CD
                , SQD.RTL_SWH_CD
                , SQD.DS_ORD_LINE_CATG_CD
                , SQD.ORD_QTY
                , SQD.CUST_UOM_CD
                , ''                                REF_CPO_DTL_LINE_NUM
                , ''                                REF_CPO_DTL_LINE_SUB_NUM
                , SQD.FL_PRC_LIST_CD
                , SQD.FUNC_PRC_LIST_PRC_AMT
                , SQD.FUNC_NET_UNIT_PRC_AMT         FUNC_NET_UNIT_PRC_AMT
                , SQD.FUNC_SPLY_QUOTE_DTL_SLS_AMT
                , SQD.FUNC_SPLY_QUOTE_DTL_NET_AMT   FUNC_NET_AMT         -- 2016/03/10 S21_NA2939
                , 0                                 FUNC_MAN_FL_ADJ_AMT
                , 0                                 FUNC_SVC_COST_TRNSF_AMT
                , 0                                 FUNC_MAN_REP_REV_ADJ_AMT
                , 0                                 FUNC_SVC_REV_TRNSF_AMT
                , #configCatgCdOutBound#            CONFIG_CATG_CD
                , #ordPrftTrxCatgOutBound#          ORD_PRFT_TRX_CATG_CD
                , ''                                CSMP_PRC_LIST_CD     -- 2016/03/10 S21_NA2939
                , 0                                 CPO_DTL_FUNC_SLS_AMT -- 2016/03/10 S21_NA2939
                , SQD.ORD_CUST_UOM_QTY                                   -- 2016/03/10 S21_NA2939
                , ''                                DTL_CSMP_CONTR_NUM   -- 2016/03/10 S21_NA2939
                , ''                                DTL_DLR_REF_NUM      -- 2016/03/10 S21_NA2939
                , SQD.PRC_CATG_CD                   -- QC7707
                --
                , SQD.SPLY_QUOTE_LINE_STS_CD        LINE_STS_CD
                , SQ.BILL_TO_CUST_CD
                , SQ.SELL_TO_CUST_CD
                , SQ.SHIP_TO_CUST_CD
                , SQ.BILL_TO_CUST_ACCT_CD
                , SQ.SOLD_TO_CUST_LOC_CD            BILL_TO_CUST_LOC_CD
                , SQ.SHIP_TO_CUST_ACCT_CD
                , SQ.SOLD_TO_CUST_LOC_CD            SHIP_TO_CUST_LOC_CD
                --
                , M.THIS_MTH_TOT_STD_COST_AMT
                , CP.COA_PROJ_NM                    -- QC15193
                --, CMT.COA_MDSE_TP_NM                -- QC9123
                , SQ.SPLY_QUOTE_DT                  LINE_PRC_BASE_DT   -- QC9437
                , NULL                              FUNC_UNIT_FL_PRC_AMT
            FROM
                SPLY_QUOTE          SQ
                , SPLY_QUOTE_DTL    SQD
                , ALL_MDSE_V        M
                , COA_PROJ          CP                            -- QC15193
                --, COA_MDSE_TP       CMT                           -- QC9123
            WHERE
                SQ.GLBL_CMPY_CD       = #glblCmpyCd#
                AND SQ.SPLY_QUOTE_NUM = #trxHdrNum#
                AND SQ.EZCANCELFLAG   = '0'
                AND SQ.GLBL_CMPY_CD   = SQD.GLBL_CMPY_CD
                AND SQ.SPLY_QUOTE_NUM = SQD.SPLY_QUOTE_NUM
                AND SQD.DPLY_QUOTE_LINE_SUB_NUM IS NULL
                AND SQD.EZCANCELFLAG  = '0'
                --
                AND SQD.GLBL_CMPY_CD       = M.GLBL_CMPY_CD(+)   -- 2016/03/10 S21_NA2939
                AND SQD.MDSE_CD            = M.MDSE_CD(+)        -- 2016/03/10 S21_NA2939
                <!--AND M.RGTN_STS_CD(+)        = #rgtnStsCd#--> -- 2016/03/10 S21_NA2939
                AND M.EZCANCELFLAG(+)       = '0'
                AND NOT EXISTS(                                  -- 2016/03/30 S21_NA6292
                               SELECT '1'
                               FROM
                                     DS_ORD_TP_PROC_DFN      PD
                                   , ORD_PRFT_LINE_CATG_RULE LCR
                               WHERE 
                                   PD.GLBL_CMPY_CD  = SQ.GLBL_CMPY_CD
                               AND PD.DS_ORD_TP_CD  = SQ.DS_ORD_TP_CD
                               AND PD.EFF_FROM_DT   &lt;= #slsDt#
                               AND ( PD.EFF_THRU_DT &gt;= #slsDt# OR PD.EFF_THRU_DT IS NULL )
                               AND PD.ACTV_FLG      = 'Y'
                               AND PD.EZCANCELFLAG  = '0'
                               AND PD.GLBL_CMPY_CD  = LCR.GLBL_CMPY_CD
                               AND LCR.ORD_PROC_NODE_PRFL_CD = PD.PRFT_APVL_NODE_PRFL_CD
                               AND LCR.DS_ORD_LINE_CATG_CD   = SQD.DS_ORD_LINE_CATG_CD
                               AND LCR.EFF_FROM_DT   &lt;= #slsDt#
                               AND ( LCR.EFF_THRU_DT &gt;= #slsDt# OR LCR.EFF_THRU_DT IS NULL )
                               AND LCR.ACTV_FLG     = 'Y'
                               AND LCR.EZCANCELFLAG = '0'
                    )
                AND NOT EXISTS(                                  -- 2016/03/30 S21_NA6292
                               SELECT '1'
                               FROM
                                     DS_ORD_TP_PROC_DFN      PD
                                   , ORD_PRFT_WH_RULE        WHR
                               WHERE 
                                   PD.GLBL_CMPY_CD  = SQ.GLBL_CMPY_CD
                               AND PD.DS_ORD_TP_CD  = SQ.DS_ORD_TP_CD
                               AND PD.EFF_FROM_DT   &lt;= #slsDt#
                               AND ( PD.EFF_THRU_DT &gt;= #slsDt# OR PD.EFF_THRU_DT IS NULL )
                               AND PD.ACTV_FLG      = 'Y'
                               AND PD.EZCANCELFLAG  = '0'
                               AND PD.GLBL_CMPY_CD  = WHR.GLBL_CMPY_CD
                               AND WHR.ORD_PROC_NODE_PRFL_CD = PD.PRFT_APVL_NODE_PRFL_CD
                               AND WHR.RTL_WH_CD    = SQD.RTL_WH_CD
                               AND NVL (WHR.RTL_SWH_CD, '1') = NVL (SQD.RTL_SWH_CD, '1')
                               AND WHR.EFF_FROM_DT   &lt;= #slsDt#
                               AND ( WHR.EFF_THRU_DT &gt;= #slsDt# OR WHR.EFF_THRU_DT IS NULL )
                               AND WHR.ACTV_FLG     = 'Y'
                               AND WHR.EZCANCELFLAG = '0'
                    )
                AND SQD.SPLY_QUOTE_LINE_STS_CD != #cancelSts#    -- 2016/04/19 S21_NA6974
                AND CP.GLBL_CMPY_CD(+)          = M.GLBL_CMPY_CD     -- QC15193
                AND CP.COA_PROJ_CD(+)           = M.COA_MDSE_TP_CD   -- QC15193
                AND CP.EZCANCELFLAG(+)          = '0'                -- QC15193
                --AND CMT.GLBL_CMPY_CD(+)         = M.GLBL_CMPY_CD     -- QC9123
                --AND CMT.COA_MDSE_TP_CD(+)       = M.COA_MDSE_TP_CD   -- QC9123
                --AND CMT.EZCANCELFLAG(+)         = '0'                -- QC9123
            ORDER BY
                SQD.SPLY_QUOTE_DTL_LINE_NUM
                , SQD.SPLY_QUOTE_DTL_LINE_SUB_NUM
    </statement>

    <statement id="getSearchDetailInfoToSMsg" parameterClass="Map" resultMap="rm.getSearchInfoToSMsg">
        WITH DTL_DATA AS (
            SELECT
                      '' ORD_HDR_STS_CD
                    , '' DS_ORD_CATG_CD
                    , '' DS_ORD_TP_CD
                    , OP.FUNC_NEGO_DEAL_AMT
                    , OP.CSMP_CONTR_NUM
                    , OP.DLR_REF_NUM
                    , OPD.DS_ORD_POSN_NUM || '.' || OPD.DS_CPO_LINE_NUM || ( 
                        CASE 
                            WHEN OPD.DS_CPO_LINE_SUB_NUM IS NULL 
                            THEN '' 
                            ELSE '.' || OPD.DS_CPO_LINE_SUB_NUM 
                            END
                    ) XX_LINE_NUM
                    , ROW_NUMBER() OVER (
                        ORDER BY OPD.DS_ORD_POSN_NUM
                                ,OPD.DS_CPO_LINE_NUM
                                ,OPD.DS_CPO_LINE_SUB_NUM
                    ) ROW_NUM                              -- QC7285
                    , OPD.TRX_LINE_NUM
                    , OPD.TRX_LINE_SUB_NUM
                    , OPD.DS_ORD_POSN_NUM      -- QC7707
                    , OPD.MDSE_CD
                    <!--, OPD.MDSE_NM-->       -- 2016/03/10 S21_NA2939
                    , MV.MDSE_DESC_SHORT_TXT   -- 2016/03/10 S21_NA2939
                    , CP.COA_PROJ_NM           -- QC15193
                    --, CMT.COA_MDSE_TP_NM       -- QC7707
                    , OPD.RTL_WH_CD
                    , OPD.RTL_SWH_CD
                    , OPD.DS_ORD_LINE_CATG_CD
                    , OPD.ORD_QTY
                    , OPD.CUST_UOM_CD
                    , OPD.DS_CPO_LINE_NUM
                    , OPD.DS_CPO_LINE_SUB_NUM
                    , OPD.FL_PRC_LIST_CD
                    , OPD.FUNC_UNIT_LIST_PRC_AMT
                    , OPD.FUNC_NET_UNIT_PRC_AMT
                    , OPD.FUNC_NET_SELL_PRC_AMT
                    , OPD.FUNC_MAN_FL_ADJ_AMT
                    , OPD.FUNC_SVC_COST_TRNSF_AMT
                    , OPD.FUNC_MAN_REP_REV_ADJ_AMT
                    , OPD.FUNC_SVC_REV_TRNSF_AMT
                    , OPD.ORD_PRFT_TRX_CATG_CD 
                    --
                    , OPD.FUNC_CSMP_FL_PRC_AMT
                    , OPD.FUNC_FINAL_UNIT_FL_PRC_AMT    -- QC7707
                    , OPD.FUNC_FINAL_UNIT_REV_AMT       -- QC7707
                    , OPD.FUNC_FINAL_FL_PRC_AMT
                    , OPD.FUNC_FINAL_REP_REV_AMT
                    , OPD.FUNC_CSMP_UNIT_CR_AMT         -- QC7791
                    , OPD.FUNC_CSMP_CR_AMT
                    , OPD.CSMP_CONTR_NUM    CSMP_CONTR_NUM_D
                    , OPD.DLR_REF_NUM       DLR_REF_NUM_D
                    , OPD.CSMP_PRC_LIST_CD
                    , OPD.PRC_CATG_CD                   -- QC7707
                    , OPD.FUNC_UNIT_FL_PRC_AMT
                    , OPD.FUNC_UNIT_MSRP_AMT
                    , (OPD.LINE_WT_AMT_RATE * 100)   LINE_WT_AMT_RATE
                    , OPD.FUNC_FL_ADJ_AMT
                    , OPD.FUNC_REP_REV_ADJ_AMT
                    , OPD.FUNC_UNIT_STD_COST_AMT
                    , OPD.FUNC_WT_SVC_REV_TRNSF_AMT     -- QC7707
                    , OPD.FUNC_WT_SVC_COST_TRNSF_AMT    -- QC7707
                    , OPD.FUNC_WT_MAN_FL_ADJ_AMT        -- QC7707
                    , OPD.FUNC_WT_MAN_REV_ADJ_AMT       -- QC7707
                    , OTC.ORD_PRFT_TRX_CATG_SORT_NUM             -- 2016/03/25 S21_NA6083
                    , CPC.PRC_CATG_NM                CSMP_PRC_LIST_NM
                    , FPC.PRC_CATG_NM                FL_PRC_LIST_NM
                    , PC.PRC_CATG_NM                    -- QC7707
                    , ORD_PRFT_RULE_TP_CD               -- QC9123
                FROM
                    ORD_PRFT       OP
                    , ORD_PRFT_DTL OPD
                    , ALL_MDSE_V   MV                            -- 2016/03/10 S21_NA2939
                    , ORD_PRFT_TRX_CATG OTC                      -- 2016/03/25 S21_NA6083
                    , PRC_CATG     CPC
                    , PRC_CATG     FPC
                    , PRC_CATG     PC                            -- QC7707
                    , COA_PROJ     CP                            -- QC15193
                    --, COA_MDSE_TP  CMT                           -- QC7707
                WHERE
                    OP.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND OP.TRX_HDR_NUM       = #trxHdrNum#
                    AND OP.ORD_PRFT_VRSN_NUM = (
	                    <isNull property="ordPrftVrsnNum">
	                    SELECT
	                              MAX(P.ORD_PRFT_VRSN_NUM) 
	                        FROM
	                            ORD_PRFT P 
	                        WHERE
	                            P.GLBL_CMPY_CD     = #glblCmpyCd#
	                            AND P.TRX_HDR_NUM  = #trxHdrNum#
	                            AND P.EZCANCELFLAG = '0'
	                    </isNull>
	                    <isNotNull property="ordPrftVrsnNum">
	                    #ordPrftVrsnNum#
	                    </isNotNull>
                    )
                    AND OP.EZCANCELFLAG      = '0'
                    AND OP.GLBL_CMPY_CD      = OPD.GLBL_CMPY_CD
                    AND OP.ORD_PRFT_PK       = OPD.ORD_PRFT_PK
                    AND OPD.EZCANCELFLAG     = '0' 
                    AND MV.GLBL_CMPY_CD      = OPD.GLBL_CMPY_CD -- 2016/03/10 S21_NA2939
                    AND MV.MDSE_CD           = OPD.MDSE_CD      -- 2016/03/10 S21_NA2939
                    AND OPD.GLBL_CMPY_CD          = OTC.GLBL_CMPY_CD         -- 2016/03/25 S21_NA6083
                    AND OPD.ORD_PRFT_TRX_CATG_CD  = OTC.ORD_PRFT_TRX_CATG_CD -- 2016/03/25 S21_NA6083
                    AND OTC.EZCANCELFLAG          = '0'                      -- 2016/03/25 S21_NA6083
                    AND CPC.GLBL_CMPY_CD(+)  = OPD.GLBL_CMPY_CD
                    AND CPC.PRC_CATG_CD(+)   = OPD.CSMP_PRC_LIST_CD
                    AND CPC.EZCANCELFLAG(+)  = '0'
                    AND FPC.GLBL_CMPY_CD(+)  = OPD.GLBL_CMPY_CD
                    AND FPC.PRC_CATG_CD(+)   = OPD.FL_PRC_LIST_CD
                    AND FPC.EZCANCELFLAG(+)  = '0'
                    AND PC.GLBL_CMPY_CD(+)   = OPD.GLBL_CMPY_CD
                    AND PC.PRC_CATG_CD(+)    = OPD.PRC_CATG_CD
                    AND PC.EZCANCELFLAG(+)   = '0'
                    AND CP.GLBL_CMPY_CD(+)   = MV.GLBL_CMPY_CD   -- QC15193
                    AND CP.COA_PROJ_CD(+)    = MV.COA_MDSE_TP_CD -- QC15193
                    AND CP.EZCANCELFLAG(+)   = '0'               -- QC15193
                    --AND CMT.GLBL_CMPY_CD(+)   = MV.GLBL_CMPY_CD
                    --AND CMT.COA_MDSE_TP_CD(+) = MV.COA_MDSE_TP_CD
                    --AND CMT.EZCANCELFLAG(+)   = '0'
            )
            SELECT
                      ORD_HDR_STS_CD
                    , DS_ORD_CATG_CD
                    , DS_ORD_TP_CD
                    , FUNC_NEGO_DEAL_AMT
                    , CSMP_CONTR_NUM
                    , DLR_REF_NUM
                    , XX_LINE_NUM
                    , TRX_LINE_NUM
                    , TRX_LINE_SUB_NUM
                    , DS_ORD_POSN_NUM          -- QC7707
                    , MDSE_CD
                    <!--, MDSE_NM-->           -- 2016/03/10 S21_NA2939
                    , MDSE_DESC_SHORT_TXT      -- 2016/03/10 S21_NA2939
                    , COA_PROJ_NM              -- QC15193
                    --, COA_MDSE_TP_NM           -- QC7707
                    , RTL_WH_CD
                    , RTL_SWH_CD
                    , DS_ORD_LINE_CATG_CD
                    , ORD_QTY
                    , CUST_UOM_CD
                    , DS_CPO_LINE_NUM
                    , DS_CPO_LINE_SUB_NUM
                    , FL_PRC_LIST_CD
                    , FUNC_UNIT_LIST_PRC_AMT
                    , FUNC_NET_UNIT_PRC_AMT
                    , FUNC_NET_SELL_PRC_AMT
                    , FUNC_MAN_FL_ADJ_AMT
                    , FUNC_SVC_COST_TRNSF_AMT
                    , FUNC_MAN_REP_REV_ADJ_AMT
                    , FUNC_SVC_REV_TRNSF_AMT
                    , ORD_PRFT_TRX_CATG_CD 
                    --
                    , FUNC_CSMP_FL_PRC_AMT
                    , FUNC_FINAL_UNIT_FL_PRC_AMT      -- QC7707
                    , FUNC_FINAL_UNIT_REV_AMT         -- QC7707
                    , FUNC_FINAL_FL_PRC_AMT
                    , FUNC_FINAL_REP_REV_AMT
                    , FUNC_CSMP_UNIT_CR_AMT           -- QC7791
                    , FUNC_CSMP_CR_AMT
                    , CSMP_CONTR_NUM_D
                    , DLR_REF_NUM_D
                    , CSMP_PRC_LIST_CD
                    , PRC_CATG_CD                     -- QC7707
                    , FUNC_UNIT_FL_PRC_AMT
                    , FUNC_UNIT_MSRP_AMT
                    , LINE_WT_AMT_RATE
                    , FUNC_FL_ADJ_AMT
                    , FUNC_REP_REV_ADJ_AMT
                    , FUNC_UNIT_STD_COST_AMT
                    , FUNC_WT_SVC_REV_TRNSF_AMT       -- QC7707
                    , FUNC_WT_SVC_COST_TRNSF_AMT      -- QC7707
                    , FUNC_WT_MAN_FL_ADJ_AMT          -- QC7707
                    , FUNC_WT_MAN_REV_ADJ_AMT         -- QC7707
                    , CSMP_PRC_LIST_NM       -- QC7301
                    , FL_PRC_LIST_NM         -- QC7301
                    , PRC_CATG_NM                     -- QC7707
                    , ORD_PRFT_RULE_TP_CD             -- QC9123
                FROM
                    DTL_DATA
                WHERE
                    ROWNUM &lt; #limitRownum#
                ORDER BY
                      ORD_PRFT_TRX_CATG_SORT_NUM    -- 2016/03/25 S21_NA6083
                     ,ROW_NUM                       -- QC7285
                <!--    , XX_LINE_NUM               // QC7285 -->
    </statement>

    <typeAlias alias="NWAL1540SMsg"    type="business.blap.NWAL1540.NWAL1540SMsg"/>
    <typeAlias alias="NWAL1540_ASMsg"  type="business.blap.NWAL1540.NWAL1540_ASMsg"/>

    <resultMap id="rm.getSearchInfoToSMsg" class="NWAL1540_ASMsg">
        <result property="ordPrftTrxCatgCd_A"       column="ORD_PRFT_TRX_CATG_CD"       javaType="EZDSStringItem"/>
        <result property="xxLineNum_A"              column="XX_LINE_NUM"                javaType="EZDSStringItem"/>
        <result property="dsOrdPosnNum_A"           column="DS_ORD_POSN_NUM"            javaType="EZDSStringItem"/>
        <result property="mdseCd_A"                 column="MDSE_CD"                    javaType="EZDSStringItem"/>
        <result property="mdseDescShortTxt_A"       column="MDSE_DESC_SHORT_TXT"        javaType="EZDSStringItem"/>
        <result property="coaProjNm_A"              column="COA_PROJ_NM"                javaType="EZDSStringItem"/>
        <result property="ordQty_A"                 column="ORD_QTY"                    javaType="EZDSBigDecimalItem"/>
        <result property="funcCsmpFlPrcAmt_A"       column="FUNC_CSMP_FL_PRC_AMT"       javaType="EZDSBigDecimalItem"/>
        <result property="funcNetUnitPrcAmt_A"      column="FUNC_NET_UNIT_PRC_AMT"      javaType="EZDSBigDecimalItem"/>
        <result property="funcNetSellPrcAmt_A"      column="FUNC_NET_SELL_PRC_AMT"      javaType="EZDSBigDecimalItem"/>
        <result property="funcFinalUnitFlPrcAmt_A"  column="FUNC_FINAL_UNIT_FL_PRC_AMT" javaType="EZDSBigDecimalItem"/>
        <result property="funcFinalUnitRevAmt_A"    column="FUNC_FINAL_UNIT_REV_AMT"    javaType="EZDSBigDecimalItem"/>
        <result property="funcFinalFlPrcAmt_A"      column="FUNC_FINAL_FL_PRC_AMT"      javaType="EZDSBigDecimalItem"/>
        <result property="funcFinalRepRevAmt_A"     column="FUNC_FINAL_REP_REV_AMT"     javaType="EZDSBigDecimalItem"/>
        <result property="funcCsmpUnitCrAmt_A"      column="FUNC_CSMP_UNIT_CR_AMT"      javaType="EZDSBigDecimalItem"/>
        <result property="funcCsmpCrAmt_A"          column="FUNC_CSMP_CR_AMT"           javaType="EZDSBigDecimalItem"/>
        <result property="csmpContrNum_A"           column="CSMP_CONTR_NUM_D"           javaType="EZDSStringItem"/>
        <result property="dlrRefNum_A"              column="DLR_REF_NUM_D"              javaType="EZDSStringItem"/>
        <result property="csmpPrcListCd_A"          column="CSMP_PRC_LIST_CD"           javaType="EZDSStringItem"/>
        <result property="flPrcListCd_A"            column="FL_PRC_LIST_CD"             javaType="EZDSStringItem"/>
        <result property="prcCatgCd_A"              column="PRC_CATG_CD"                javaType="EZDSStringItem"/>
        <result property="funcUnitListPrcAmt_A"     column="FUNC_UNIT_LIST_PRC_AMT"     javaType="EZDSBigDecimalItem"/>
        <result property="funcUnitFlPrcAmt_A"       column="FUNC_UNIT_FL_PRC_AMT"       javaType="EZDSBigDecimalItem"/>
        <result property="funcUnitMsrpAmt_A"        column="FUNC_UNIT_MSRP_AMT"         javaType="EZDSBigDecimalItem"/>
        <result property="lineWtAmtRate_A"          column="LINE_WT_AMT_RATE"           javaType="EZDSBigDecimalItem"/>
        <result property="funcFlAdjAmt_A"           column="FUNC_FL_ADJ_AMT"            javaType="EZDSBigDecimalItem"/>
        <result property="funcRepRevAdjAmt_A"       column="FUNC_REP_REV_ADJ_AMT"       javaType="EZDSBigDecimalItem"/>
        <result property="funcUnitStdCostAmt_A"     column="FUNC_UNIT_STD_COST_AMT"     javaType="EZDSBigDecimalItem"/>
        <result property="funcWtSvcRevTrnsfAmt_A"   column="FUNC_WT_SVC_REV_TRNSF_AMT"  javaType="EZDSBigDecimalItem"/>
        <result property="funcWtSvcCostTrnsfAmt_A"  column="FUNC_WT_SVC_COST_TRNSF_AMT" javaType="EZDSBigDecimalItem"/>
        <result property="funcWtManFlAdjAmt_A"      column="FUNC_WT_MAN_FL_ADJ_AMT"     javaType="EZDSBigDecimalItem"/>
        <result property="funcWtManRevAdjAmt_A"     column="FUNC_WT_MAN_REV_ADJ_AMT"    javaType="EZDSBigDecimalItem"/>
        <result property="prcCatgNm_A"              column="CSMP_PRC_LIST_NM"           javaType="EZDSStringItem"/>
        <result property="flPrcListNm_A"            column="FL_PRC_LIST_NM"             javaType="EZDSStringItem"/>
        <result property="prcCatgNm_A2"             column="PRC_CATG_NM"                javaType="EZDSStringItem"/>
        <result property="ordPrftRuleTpCd_A"        column="ORD_PRFT_RULE_TP_CD"        javaType="EZDSStringItem"/>
    </resultMap>

    <statement id="getCsvInfo" parameterClass="Map" resultClass="Map">
        WITH CSV_INFO AS (
            SELECT
                    OP.GLBL_CMPY_CD
                    , OP.ORD_PRFT_PK
                    , OP.TRX_HDR_NUM
                    , OP.ORD_PRFT_VRSN_NUM
                    , OP.FUNC_NEGO_DEAL_AMT
                    , OP.TOT_FUNC_REP_REV_AMT
                    , OP.TOT_FUNC_REP_REV_ADJ_AMT
                    , OP.TOT_FUNC_FINAL_FL_AMT
                    , OP.FUNC_GRS_PRFT_AMT
                    , OP.GRS_PRFT_PCT
                    , OP.TOT_FUNC_MSRP_AMT
                    , OP.TOT_FUNC_STD_FL_AMT
                    , OP.TOT_FUNC_FL_ADJ_AMT
                    , OP.CSMP_ORD_FLG
                    , OP.TOT_FUNC_CSMP_CR_AMT
                    , OP.TOT_FUNC_CSMP_FL_AMT
                    , OP.CSMP_CONTR_NUM             CSMP_CONTR_NUM_H
                    , OP.DLR_REF_NUM                DLR_REF_NUM_H
                    , OP.CSMP_CONTR_START_DT        CSMP_CONTR_START_DT_H
                    , OP.CSMP_CONTR_END_DT          CSMP_CONTR_END_DT_H
                    , OP.LAST_PRFT_CALC_USR_ID      LAST_PRFT_CALC_USR_ID_H
                    , OP.LAST_PRFT_CALC_TS          LAST_PRFT_CALC_TS_H
                    , OP.TOT_FUNC_BYOT_AMT
                    , OP.TOT_FUNC_SVC_REV_TRNSF_AMT
                    , OP.TOT_FUNC_SVC_COST_TRNSF_AMT
                    , OP.TOT_FUNC_PRO_SVC_AMT
                    , OP.TOT_FUNC_OM_MAINT_BLLBL_AMT
                    , OP.FUNC_ALT_GRS_PRFT_AMT
                    , OP.ALT_GRS_PRFT_PCT
                    , OP.TOT_FUNC_DLR_CR_AMT
                    , OP.TOT_FUNC_DLR_INV_AMT
                    , OP.TOT_FUNC_RED_COMP_AMT
                    , OPD.ORD_PRFT_DTL_PK
                    , OPD.ORD_PRFT_TRX_CATG_CD
                    , OPD.TRX_LINE_NUM
                    , OPD.TRX_LINE_SUB_NUM
                    , OPD.DS_ORD_POSN_NUM
                    , OPD.DS_CPO_LINE_NUM
                    , OPD.DS_CPO_LINE_SUB_NUM
                    , OPD.MDSE_CD
                    , OPD.MDSE_NM
                    , OPD.RTL_WH_CD
                    , OPD.RTL_SWH_CD
                    , OPD.MDSE_INVTY_COST_PCT
                    , OPD.DS_ORD_LINE_CATG_CD
                    , OPD.ORD_QTY
                    , OPD.CUST_UOM_CD
                    , OPD.FL_PRC_LIST_CD
                    , OPD.CSMP_PRC_LIST_CD
                    , OPD.FUNC_DLR_CR_AMT
                    , OPD.FUNC_RED_COMP_AMT
                    , OPD.FUNC_UNIT_FL_PRC_AMT
                    , OPD.FUNC_INIT_FL_PRC_AMT
                    , OPD.LINE_WT_AMT_RATE
                    , OPD.FUNC_GENL_FL_ADJ_AMT
                    , OPD.FUNC_SPEC_FL_ADJ_AMT
                    , OPD.FUNC_MAN_FL_ADJ_AMT
                    , OPD.FUNC_FL_ADJ_AMT
                    , OPD.FUNC_CSMP_UNIT_CR_AMT
                    , OPD.FUNC_CSMP_CR_AMT
                    , OPD.FUNC_CSMP_FL_PRC_AMT
                    , OPD.FUNC_SVC_COST_TRNSF_AMT
                    , OPD.FUNC_WT_SVC_COST_TRNSF_AMT
                    , OPD.FUNC_FINAL_FL_PRC_AMT
                    , OPD.FUNC_UNIT_LIST_PRC_AMT
                    , OPD.FUNC_NET_UNIT_PRC_AMT
                    , OPD.FUNC_NET_SELL_PRC_AMT
                    , OPD.FUNC_INIT_REP_REV_AMT
                    , OPD.FUNC_GENL_REP_REV_ADJ_AMT
                    , OPD.FUNC_SPEC_REP_REV_ADJ_AMT
                    , OPD.FUNC_MAN_REP_REV_ADJ_AMT
                    , OPD.FUNC_REP_REV_ADJ_AMT
                    , OPD.FUNC_SVC_REV_TRNSF_AMT
                    , OPD.FUNC_WT_SVC_REV_TRNSF_AMT
                    , OPD.FUNC_FINAL_REP_REV_AMT
                    , OPD.FUNC_UNIT_MSRP_AMT
                    , OPD.FUNC_UNIT_STD_COST_AMT
                    , OPD.FUNC_FINAL_STD_COST_AMT
                    , OPD.CSMP_CONTR_NUM            CSMP_CONTR_NUM_D
                    , OPD.DLR_REF_NUM               DLR_REF_NUM_D
                    , OPD.CSMP_CONTR_START_DT       CSMP_CONTR_START_DT_D
                    , OPD.CSMP_CONTR_END_DT         CSMP_CONTR_END_DT_D
                    , OPD.CHNG_ORD_FLG
                    , OPD.COA_MDSE_TP_CD
                    , OPD.COA_PROD_CD
                    , OPD.MDSE_ITEM_TP_CD
                    , OPD.LAST_PRFT_CALC_USR_ID     LAST_PRFT_CALC_USR_ID_D
                    , OPD.LAST_PRFT_CALC_TS         LAST_PRFT_CALC_TS_D
                    , OPD.ORD_PRFT_RULE_TP_CD
                    , OPD.FL_PRC_CALC_INCL_FLG
                    , OPD.REP_REV_CALC_INCL_FLG
                    , OPD.DISC_MDSE_TP_FLG
                    , OPD.RED_FL_PRC_FLG
                    , OPD.RED_REP_REV_FLG
                    , OPD.DISC_ALLOC_METH_CD
                    , OPD.DLR_CR_PRFT_INCL_FLG
                    , OPD.RED_COMP_AMT_FLG
                FROM
                    ORD_PRFT       OP
                    , ORD_PRFT_DTL OPD
                WHERE
                    OP.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND OP.TRX_HDR_NUM       = #trxHdrNum#
                    AND OP.ORD_PRFT_VRSN_NUM = (
                        <isNull property="ordPrftVrsnNum">
                        SELECT
                                  MAX(P.ORD_PRFT_VRSN_NUM) 
                            FROM
                                ORD_PRFT P 
                            WHERE
                                P.GLBL_CMPY_CD     = #glblCmpyCd#
                                AND P.TRX_HDR_NUM  = #trxHdrNum#
                                AND P.EZCANCELFLAG = '0'
                        </isNull>
                        <isNotNull property="ordPrftVrsnNum">
                        #ordPrftVrsnNum#
                        </isNotNull>
                    )
                    AND OP.EZCANCELFLAG      = '0'
                    AND OP.GLBL_CMPY_CD      = OPD.GLBL_CMPY_CD
                    AND OP.ORD_PRFT_PK       = OPD.ORD_PRFT_PK
                    AND OPD.EZCANCELFLAG     = '0'
            )
            SELECT
                      C.GLBL_CMPY_CD                          GLBL_CMPY_CD_H
                    , C.ORD_PRFT_PK                           ORD_PRFT_PK_H
                    , C.TRX_HDR_NUM                           TRX_HDR_NUM_H
                    , C.ORD_PRFT_VRSN_NUM                     ORD_PRFT_VRSN_NUM_H
                    , C.FUNC_NEGO_DEAL_AMT                    FUNC_NEGO_DEAL_AMT_H
                    , C.TOT_FUNC_REP_REV_AMT                  TOT_FUNC_REP_REV_AMT_H
                    , C.TOT_FUNC_REP_REV_ADJ_AMT              TOT_FUNC_REP_REV_ADJ_AMT_H
                    , C.TOT_FUNC_FINAL_FL_AMT                 TOT_FUNC_FINAL_FL_AMT_H
                    , C.FUNC_GRS_PRFT_AMT                     FUNC_GRS_PRFT_AMT_H
                    , C.GRS_PRFT_PCT                          GRS_PRFT_PCT_H
                    , C.TOT_FUNC_MSRP_AMT                     TOT_FUNC_MSRP_AMT_H
                    , C.TOT_FUNC_STD_FL_AMT                   TOT_FUNC_STD_FL_AMT_H
                    , C.TOT_FUNC_FL_ADJ_AMT                   TOT_FUNC_FL_ADJ_AMT_H
                    , C.CSMP_ORD_FLG                          CSMP_ORD_FLG_H
                    , C.TOT_FUNC_CSMP_CR_AMT                  TOT_FUNC_CSMP_CR_AMT_H
                    , C.TOT_FUNC_CSMP_FL_AMT                  TOT_FUNC_CSMP_FL_AMT_H
                    , C.CSMP_CONTR_NUM_H                      CSMP_CONTR_NUM_H
                    , C.DLR_REF_NUM_H                         DLR_REF_NUM_H
                    , C.CSMP_CONTR_START_DT_H                 CSMP_CONTR_START_DT_H
                    , C.CSMP_CONTR_END_DT_H                   CSMP_CONTR_END_DT_H
                    , C.LAST_PRFT_CALC_USR_ID_H               LAST_PRFT_CALC_USR_ID_H
                    , C.LAST_PRFT_CALC_TS_H                   LAST_PRFT_CALC_TS_H
                    , C.TOT_FUNC_BYOT_AMT                     TOT_FUNC_BYOT_AMT_H
                    , C.TOT_FUNC_SVC_REV_TRNSF_AMT            TOT_FUNC_SVC_REV_TRNSF_AMT_H
                    , C.TOT_FUNC_SVC_COST_TRNSF_AMT           TOT_FUNC_SVC_COST_TRNSF_AMT_H
                    , C.TOT_FUNC_PRO_SVC_AMT                  TOT_FUNC_PRO_SVC_AMT_H
                    , C.TOT_FUNC_OM_MAINT_BLLBL_AMT           TOT_FUNC_OM_MAINT_BLLBL_AMT_H
                    , C.FUNC_ALT_GRS_PRFT_AMT                 FUNC_ALT_GRS_PRFT_AMT_H
                    , C.ALT_GRS_PRFT_PCT                      ALT_GRS_PRFT_PCT_H
                    , C.TOT_FUNC_DLR_CR_AMT                   TOT_FUNC_DLR_CR_AMT_H
                    , C.TOT_FUNC_DLR_INV_AMT                  TOT_FUNC_DLR_INV_AMT_H
                    , C.TOT_FUNC_RED_COMP_AMT                 TOT_FUNC_RED_COMP_AMT_H
                    --
                    , C.ORD_PRFT_DTL_PK                       ORD_PRFT_DTL_PK_D
                    , C.ORD_PRFT_TRX_CATG_CD                  ORD_PRFT_TRX_CATG_CD_D
                    , C.TRX_LINE_NUM                          TRX_LINE_NUM_D
                    , C.TRX_LINE_SUB_NUM                      TRX_LINE_SUB_NUM_D
                    , C.DS_ORD_POSN_NUM                       DS_ORD_POSN_NUM_D
                    , C.DS_CPO_LINE_NUM                       DS_CPO_LINE_NUM_D
                    , C.DS_CPO_LINE_SUB_NUM                   DS_CPO_LINE_SUB_NUM_D
                    , C.MDSE_CD                               MDSE_CD_D
                    , C.MDSE_NM                               MDSE_NM_D
                    , C.RTL_WH_CD                             RTL_WH_CD_D
                    , C.RTL_SWH_CD                            RTL_SWH_CD_D
                    , C.MDSE_INVTY_COST_PCT                   MDSE_INVTY_COST_PCT_D
                    , C.DS_ORD_LINE_CATG_CD                   DS_ORD_LINE_CATG_CD_D
                    , C.ORD_QTY                               ORD_QTY_D
                    , C.CUST_UOM_CD                           CUST_UOM_CD_D
                    , C.FL_PRC_LIST_CD                        FL_PRC_LIST_CD_D
                    , C.CSMP_PRC_LIST_CD                      CSMP_PRC_LIST_CD_D
                    , C.FUNC_DLR_CR_AMT                       FUNC_DLR_CR_AMT_D
                    , C.FUNC_RED_COMP_AMT                     FUNC_RED_COMP_AMT_D
                    , C.FUNC_UNIT_FL_PRC_AMT                  FUNC_UNIT_FL_PRC_AMT_D
                    , C.FUNC_INIT_FL_PRC_AMT                  FUNC_INIT_FL_PRC_AMT_D
                    , C.LINE_WT_AMT_RATE                      LINE_WT_AMT_RATE_D
                    , C.FUNC_GENL_FL_ADJ_AMT                  FUNC_GENL_FL_ADJ_AMT_D
                    , C.FUNC_SPEC_FL_ADJ_AMT                  FUNC_SPEC_FL_ADJ_AMT_D
                    , C.FUNC_MAN_FL_ADJ_AMT                   FUNC_MAN_FL_ADJ_AMT_D
                    , C.FUNC_FL_ADJ_AMT                       FUNC_FL_ADJ_AMT_D
                    , C.FUNC_CSMP_UNIT_CR_AMT                 FUNC_CSMP_UNIT_CR_AMT_D
                    , C.FUNC_CSMP_CR_AMT                      FUNC_CSMP_CR_AMT_D
                    , C.FUNC_CSMP_FL_PRC_AMT                  FUNC_CSMP_FL_PRC_AMT_D
                    , C.FUNC_SVC_COST_TRNSF_AMT               FUNC_SVC_COST_TRNSF_AMT_D
                    , C.FUNC_WT_SVC_COST_TRNSF_AMT            FUNC_WT_SVC_COST_TRNSF_AMT_D
                    , C.FUNC_FINAL_FL_PRC_AMT                 FUNC_FINAL_FL_PRC_AMT_D
                    , C.FUNC_UNIT_LIST_PRC_AMT                FUNC_UNIT_LIST_PRC_AMT_D
                    , C.FUNC_NET_UNIT_PRC_AMT                 FUNC_NET_UNIT_PRC_AMT_D
                    , C.FUNC_NET_SELL_PRC_AMT                 FUNC_NET_SELL_PRC_AMT_D
                    , C.FUNC_INIT_REP_REV_AMT                 FUNC_INIT_REP_REV_AMT_D
                    , C.FUNC_GENL_REP_REV_ADJ_AMT             FUNC_GENL_REP_REV_ADJ_AMT_D
                    , C.FUNC_SPEC_REP_REV_ADJ_AMT             FUNC_SPEC_REP_REV_ADJ_AMT_D
                    , C.FUNC_MAN_REP_REV_ADJ_AMT              FUNC_MAN_REP_REV_ADJ_AMT_D
                    , C.FUNC_REP_REV_ADJ_AMT                  FUNC_REP_REV_ADJ_AMT_D
                    , C.FUNC_SVC_REV_TRNSF_AMT                FUNC_SVC_REV_TRNSF_AMT_D
                    , C.FUNC_WT_SVC_REV_TRNSF_AMT             FUNC_WT_SVC_REV_TRNSF_AMT_D
                    , C.FUNC_FINAL_REP_REV_AMT                FUNC_FINAL_REP_REV_AMT_D
                    , C.FUNC_UNIT_MSRP_AMT                    FUNC_UNIT_MSRP_AMT_D
                    , C.FUNC_UNIT_STD_COST_AMT                FUNC_UNIT_STD_COST_AMT_D
                    , C.FUNC_FINAL_STD_COST_AMT               FUNC_FINAL_STD_COST_AMT_D
                    , C.CSMP_CONTR_NUM_D                      CSMP_CONTR_NUM_D
                    , C.DLR_REF_NUM_D                         DLR_REF_NUM_D
                    , C.CSMP_CONTR_START_DT_D                 CSMP_CONTR_START_DT_D
                    , C.CSMP_CONTR_END_DT_D                   CSMP_CONTR_END_DT_D
                    , C.CHNG_ORD_FLG                          CHNG_ORD_FLG_D
                    , C.COA_MDSE_TP_CD                        COA_MDSE_TP_CD_D
                    , C.COA_PROD_CD                           COA_PROD_CD_D
                    , C.MDSE_ITEM_TP_CD                       MDSE_ITEM_TP_CD_D
                    , C.LAST_PRFT_CALC_USR_ID_D               LAST_PRFT_CALC_USR_ID_D
                    , C.LAST_PRFT_CALC_TS_D                   LAST_PRFT_CALC_TS_D
                    , C.ORD_PRFT_RULE_TP_CD                   ORD_PRFT_RULE_TP_CD_D
                    , C.FL_PRC_CALC_INCL_FLG                  FL_PRC_CALC_INCL_FLG_D
                    , C.REP_REV_CALC_INCL_FLG                 REP_REV_CALC_INCL_FLG_D
                    , C.DISC_MDSE_TP_FLG                      DISC_MDSE_TP_FLG_D
                    , C.RED_FL_PRC_FLG                        RED_FL_PRC_FLG_D
                    , C.RED_REP_REV_FLG                       RED_REP_REV_FLG_D
                    , C.DISC_ALLOC_METH_CD                    DISC_ALLOC_METH_CD_D
                    , C.DLR_CR_PRFT_INCL_FLG                  DLR_CR_PRFT_INCL_FLG_D
                    , C.RED_COMP_AMT_FLG                      RED_COMP_AMT_FLG_D
                FROM
                    CSV_INFO            C
                    , ORD_PRFT_TRX_CATG TC
                WHERE
                    C.GLBL_CMPY_CD             = TC.GLBL_CMPY_CD
                    AND C.ORD_PRFT_TRX_CATG_CD = TC.ORD_PRFT_TRX_CATG_CD
                    AND TC.EZCANCELFLAG        = '0'
                    AND ROWNUM                 &lt; #limitRownum#
                ORDER BY
                    TC.ORD_PRFT_TRX_CATG_SORT_NUM
                    , C.TRX_LINE_NUM
                    , C.TRX_LINE_SUB_NUM
    </statement>

    <!-- 2016/03/10 S21_NA#2939 -->
    <statement id="getMaxVerGrossProfit" parameterClass="Map" resultClass="Map">
        SELECT
                 GRS_PRFT_PCT
                , FUNC_GRS_PRFT_AMT
                , FUNC_ALT_GRS_PRFT_AMT
                , ALT_GRS_PRFT_PCT
                , ORD_PRFT_VRSN_NUM
            FROM
                ORD_PRFT  OP
            WHERE
                OP.GLBL_CMPY_CD          = #glblCmpyCd#
                AND OP.TRX_HDR_NUM       = #trxHdrNum#
                AND OP.ORD_PRFT_VRSN_NUM = (
                    SELECT
                              MAX(P.ORD_PRFT_VRSN_NUM) 
                        FROM
                            ORD_PRFT P 
                        WHERE
                            P.GLBL_CMPY_CD     = #glblCmpyCd#
                            AND P.TRX_HDR_NUM  = #trxHdrNum#
                            AND P.EZCANCELFLAG = '0'
                )
                AND OP.EZCANCELFLAG          = '0'
    </statement>

    <!-- 2016/07/25 QC#11636 -->
    <statement id="getCreditRebillCd" parameterClass="Map" resultClass="String">
        SELECT
                CASE WHEN CPOD.CR_REBIL_CD IS NULL THEN RTRND.CR_REBIL_CD
                     ELSE CPOD.CR_REBIL_CD END AS CR_REBIL_CD
        FROM
                CPO         CPO
              , CPO_DTL     CPOD
              , DS_CPO_RTRN_DTL RTRND
        WHERE
                CPO.GLBL_CMPY_CD          = #glblCmpyCd#
            AND CPO.CPO_ORD_NUM           = #trxHdrNum#
            AND CPO.EZCANCELFLAG          = '0'
            AND CPO.GLBL_CMPY_CD          = CPOD.GLBL_CMPY_CD(+)
            AND CPO.CPO_ORD_NUM           = CPOD.CPO_ORD_NUM(+)
            AND CPOD.CR_REBIL_CD(+)       IS NOT NULL
            AND CPOD.EZCANCELFLAG(+)      = '0'
            AND CPO.GLBL_CMPY_CD          = RTRND.GLBL_CMPY_CD(+)
            AND CPO.CPO_ORD_NUM           = RTRND.CPO_ORD_NUM(+)
            AND RTRND.CR_REBIL_CD(+)      IS NOT NULL
            AND RTRND.EZCANCELFLAG(+)     = '0'
            AND ROWNUM                    = 1
    </statement>

    <!-- Add Start 2017/10/11 QC#21664 -->
    <statement id="getPrftRuleTp" parameterClass="Map" resultClass="Map">
        SELECT
             NP.ORD_PRFT_RULE_TP_CD
           , NP.ORD_PROC_NODE_PRFL_CD
        FROM
             DS_ORD_TP_PROC_DFN PD
           , ORD_PRFT_NODE_PRFL NP
        WHERE
                 PD.GLBL_CMPY_CD = #glblCmpyCd#
             AND PD.DS_ORD_TP_CD = #dsOrdTpCd#
             AND PD.ACTV_FLG     = 'Y'
             AND PD.EZCANCELFLAG = '0'
             AND PD.GLBL_CMPY_CD = NP.GLBL_CMPY_CD
             AND PD.PRFT_APVL_NODE_PRFL_CD = NP.ORD_PROC_NODE_PRFL_CD
             AND PD.EFF_FROM_DT  &lt;= #slsDt#
             AND (PD.EFF_THRU_DT &gt;= #slsDt# OR PD.EFF_THRU_DT IS NULL )
             AND NP.EZCANCELFLAG = '0'
    </statement>
    <!-- Add End 2017/10/11 QC#21664 -->
</sqlMap>
