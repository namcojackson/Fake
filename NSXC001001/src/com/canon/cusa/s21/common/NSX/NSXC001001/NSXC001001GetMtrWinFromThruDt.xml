<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSXC001001GetMtrWinFromThruDt">

    <statement id="getWinBefAot" parameterClass="Map" resultClass="BigDecimal">
        <!-- START 2022/09/20 [QC#60045,ADD] -->
        <!-- START 2023/05/09 K.Kitachi [QC#61469, DEL] -->
<!--        WITH DEF_WIN_DAYS AS ( -->
<!--            SELECT -->
<!--                 A.MTR_READ_WIN_MLY_DAYS_AOT -->
<!--                ,A.MTR_READ_WIN_OTH_DAYS_AOT -->
<!--            FROM -->
<!--                DS_WIN_DAYS A -->
<!--            WHERE -->
<!--                    A.GLBL_CMPY_CD             = #glblCmpyCd# -->
<!--                AND A.EZCANCELFLAG             = '0' -->
<!--                AND A.DS_WIN_DAYS_TRGT_PER_TXT = '*' -->
<!--                AND A.SVC_LINE_BIZ_CD          = '*' -->
<!--            ) -->
        <!-- END 2023/05/09 K.Kitachi [QC#61469, DEL] -->
        <!-- END   2022/09/20 [QC#60045,ADD] -->
        SELECT
            <!-- START 2022/09/20 [QC#60045,MOD] -->
            <!-- DECODE(NVL(F.BLLG_CYCLE_UOM_CD, PF.BLLG_CYCLE_UOM_CD), #months#, D.MTR_READ_WIN_MLY_DAYS_AOT, D.MTR_READ_WIN_OTH_DAYS_AOT) -->
            <!-- START 2023/02/09 S.Naya [QC#60045, MOD] -->
            <!-- DECODE(NVL(F.BLLG_CYCLE_UOM_CD, PF.BLLG_CYCLE_UOM_CD), #months#, NVL(D.MTR_READ_WIN_MLY_DAYS_AOT, (SELECT MTR_READ_WIN_MLY_DAYS_AOT FROM DEF_WIN_DAYS)), NVL(D.MTR_READ_WIN_OTH_DAYS_AOT, (SELECT MTR_READ_WIN_OTH_DAYS_AOT FROM DEF_WIN_DAYS))) AS BEF_DAYS -->
            <!-- START 2023/05/09 K.Kitachi [QC#61469, MOD] -->
            <!-- DECODE(NVL(F.BLLG_CYCLE_UOM_CD, PF.BLLG_CYCLE_UOM_CD), #months#, COALESCE(D.MTR_READ_WIN_MLY_DAYS_AOT, D2.MTR_READ_WIN_MLY_DAYS_AOT, (SELECT MTR_READ_WIN_MLY_DAYS_AOT FROM DEF_WIN_DAYS)), COALESCE(D.MTR_READ_WIN_OTH_DAYS_AOT, D2.MTR_READ_WIN_OTH_DAYS_AOT, (SELECT MTR_READ_WIN_OTH_DAYS_AOT FROM DEF_WIN_DAYS))) AS BEF_DAYS -->
            DECODE(NVL(F.BLLG_CYCLE_UOM_CD, PF.BLLG_CYCLE_UOM_CD), #months#, COALESCE(D.MTR_READ_WIN_MLY_DAYS_AOT, D2.MTR_READ_WIN_MLY_DAYS_AOT, #mtrReadWinMlyDaysAot#), COALESCE(D.MTR_READ_WIN_OTH_DAYS_AOT, D2.MTR_READ_WIN_OTH_DAYS_AOT, #mtrReadWinOthDaysAot#)) AS BEF_DAYS
            <!-- END 2023/05/09 K.Kitachi [QC#61469, MOD] -->
            <!-- END   2023/02/09 S.Naya [QC#60045, MOD] -->
            <!-- END   2022/09/20 [QC#60045,MOD] -->
        FROM
             DS_CONTR_BLLG_SCHD       A
            ,DS_CONTR_DTL             B
            ,DS_CONTR                 C
            <!-- START 2022/09/20 [QC#60045,MOD] -->
            <!-- ,DS_CONTR_INTFC_DEF_RULE  D -->
            ,DS_WIN_DAYS              D
            <!-- END   2022/09/20 [QC#60045,MOD] -->
            <!-- START 2023/02/09 S.Naya [QC#60045, ADD] -->
            ,DS_WIN_DAYS              D2
            <!-- END   2023/02/09 S.Naya [QC#60045, ADD] -->
            ,DS_CONTR_BLLG_MTR        E
            ,BLLG_CYCLE               F
            ,DS_CONTR_BLLG_SCHD       PA
            ,DS_CONTR_BLLG_MTR        PE
            ,BLLG_CYCLE               PF
        WHERE
                A.GLBL_CMPY_CD            = #glblCmpyCd#
            AND A.DS_CONTR_BLLG_SCHD_PK   = #dsContrBllgSchdPk#
            AND A.EZCANCELFLAG            = '0'
            AND A.GLBL_CMPY_CD            = B.GLBL_CMPY_CD
            AND A.DS_CONTR_DTL_PK         = B.DS_CONTR_DTL_PK
            AND A.EZCANCELFLAG            = '0'
            AND B.GLBL_CMPY_CD            = C.GLBL_CMPY_CD
            AND B.DS_CONTR_PK             = C.DS_CONTR_PK 
            AND C.EZCANCELFLAG            = '0'
            <!-- START 2022/09/20 [QC#60045,MOD] -->
            <!-- AND C.GLBL_CMPY_CD            = D.GLBL_CMPY_CD          (+) -->
            <!-- AND C.DS_CONTR_SRC_TP_CD      = D.CONTR_INTFC_SRC_TP_CD (+) -->
            <!-- AND C.DS_CONTR_CLS_CD         = D.DS_CONTR_CLS_CD       (+) -->
            <!-- AND C.SVC_LINE_BIZ_CD         = D.SVC_LINE_BIZ_CD       (+) -->
            <!-- AND D.EFF_FROM_DT  (+)        &lt;= #salesDate# -->
            <!-- AND D.ENBL_FLG     (+)        = 'Y' -->
            <!-- AND D.EZCANCELFLAG (+)        = '0' -->
            AND A.GLBL_CMPY_CD            = D.GLBL_CMPY_CD          (+)
            <!-- END   2022/09/20 [QC#60045,MOD] -->
            AND D.EZCANCELFLAG (+)        = '0'
            <!-- START 2022/09/20 [QC#60045,ADD] -->
            AND SUBSTR(A.BLLG_SCHD_THRU_DT, 0, 6) = D.DS_WIN_DAYS_TRGT_PER_TXT(+)
            AND C.SVC_LINE_BIZ_CD                 = D.SVC_LINE_BIZ_CD(+)
            <!-- END   2022/09/20 [QC#60045,ADD] -->
            <!-- START 2023/02/09 S.Naya [QC#60045, ADD] -->
            AND A.GLBL_CMPY_CD                    = D2.GLBL_CMPY_CD(+)
            AND D2.EZCANCELFLAG (+)               = '0'
            AND SUBSTR(A.BLLG_SCHD_THRU_DT, 0, 6) = D2.DS_WIN_DAYS_TRGT_PER_TXT(+)
            AND D2.SVC_LINE_BIZ_CD(+)             = '*'
            <!-- END   2023/02/09 S.Naya [QC#60045, ADD] -->
            AND A.GLBL_CMPY_CD            = E.GLBL_CMPY_CD
            AND A.DS_CONTR_BLLG_MTR_PK    = E.DS_CONTR_BLLG_MTR_PK
            AND E.EZCANCELFLAG (+)        = '0'
            AND E.GLBL_CMPY_CD            = F.GLBL_CMPY_CD          (+)
            AND E.BLLG_MTR_BLLG_CYCLE_CD  = F.BLLG_CYCLE_CD         (+)
            AND F.EZCANCELFLAG (+)        = '0'
            AND A.GLBL_CMPY_CD            = PA.GLBL_CMPY_CD         (+)
            AND A.PRNT_DS_CONTR_BLLG_SCHD_PK
                                          = PA.DS_CONTR_BLLG_SCHD_PK(+)
            AND PA.EZCANCELFLAG (+)       = '0'
            AND PA.GLBL_CMPY_CD           = PE.GLBL_CMPY_CD         (+)
            AND PA.DS_CONTR_BLLG_MTR_PK   = PE.DS_CONTR_BLLG_MTR_PK (+)
            AND PE.EZCANCELFLAG (+)       = '0'
            AND PE.GLBL_CMPY_CD           = PF.GLBL_CMPY_CD         (+)
            AND PE.BLLG_MTR_BLLG_CYCLE_CD = PF.BLLG_CYCLE_CD        (+)
            AND PF.EZCANCELFLAG (+)       = '0'
    </statement>
</sqlMap>
