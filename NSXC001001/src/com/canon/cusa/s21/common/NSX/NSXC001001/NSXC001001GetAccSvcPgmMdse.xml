<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSXC001001GetAccSvcPgmMdse">
    <statement id="getCoaInfo" parameterClass="Map" resultClass="Map">
        SELECT
             A.COA_PROD_CD
            ,A.COA_MDSE_TP_CD
        FROM
            MDSE    A
        WHERE
                A.GLBL_CMPY_CD      = #glblCmpyCd#
            AND A.EZCANCELFLAG      = '0'
            AND A.MDSE_CD           = #mdseCd#
        UNION ALL
        SELECT
             A.COA_PROD_CD
            ,A.COA_MDSE_TP_CD
        FROM
            MDSE            A
           ,ORD_TAKE_MDSE   B
        WHERE
                A.GLBL_CMPY_CD      = #glblCmpyCd#
            AND A.EZCANCELFLAG      = '0'
            AND A.GLBL_CMPY_CD      = B.GLBL_CMPY_CD
            AND B.EZCANCELFLAG      = '0'
            AND A.MDSE_CD           = B.MDSE_CD
            AND B.ORD_TAKE_MDSE_CD  = #mdseCd#
    </statement>
    <statement id="getAccSvcPgmMdseCd" parameterClass="Map" resultClass="String">
        SELECT
            SVC_PGM_MDSE_CD
        FROM
            (
                SELECT
                    AA.SVC_PGM_MDSE_CD
                   ,RANK() OVER (ORDER BY AA.SORT_NUM) AS  RANK_NUM
                FROM (
                        SELECT
                            A.SVC_PGM_MDSE_CD
                           ,1                   AS SORT_NUM
                        FROM
                            DEF_SVC_PGM_RULE
                        A
                        WHERE
                                A.GLBL_CMPY_CD      = #glblCmpyCd#
                            AND A.EZCANCELFLAG      = '0'
                            AND A.SVC_LINE_BIZ_CD   = #svcLineBizCd#
                            AND A.SVC_MACH_TP_CD    = #svcMachTpAcc#
                            AND A.COA_PROD_CD       = #coaProdCd#
                            AND A.COA_MDSE_TP_CD    = #coaMdseTp#
                            AND A.SVC_PGM_RNTL_FLG  = #rntlFlg#
                    UNION
                        SELECT
                            A.SVC_PGM_MDSE_CD
                           ,2                   AS SORT_NUM
                        FROM
                            DEF_SVC_PGM_RULE
                        A
                        WHERE
                                A.GLBL_CMPY_CD      = #glblCmpyCd#
                            AND A.EZCANCELFLAG      = '0'
                            AND A.SVC_LINE_BIZ_CD   = #svcLineBizCd#
                            AND A.SVC_MACH_TP_CD    = #svcMachTpAcc#
                            AND A.COA_PROD_CD       = #coaProdCd#
                            AND A.COA_MDSE_TP_CD    = #allCd#
                            AND A.SVC_PGM_RNTL_FLG  = #rntlFlg#
                    UNION
                        SELECT
                            A.SVC_PGM_MDSE_CD
                           ,3                   AS SORT_NUM
                        FROM
                            DEF_SVC_PGM_RULE
                        A
                        WHERE
                                A.GLBL_CMPY_CD      = #glblCmpyCd#
                            AND A.EZCANCELFLAG      = '0'
                            AND A.SVC_LINE_BIZ_CD   = #svcLineBizCd#
                            AND A.SVC_MACH_TP_CD    = #svcMachTpAcc#
                            AND A.COA_PROD_CD       = #allCd#
                            AND A.COA_MDSE_TP_CD    = #coaMdseTp#
                            AND A.SVC_PGM_RNTL_FLG  = #rntlFlg#
                    UNION
                        SELECT
                            A.SVC_PGM_MDSE_CD
                           ,4                   AS SORT_NUM
                        FROM
                            DEF_SVC_PGM_RULE
                        A
                        WHERE
                                A.GLBL_CMPY_CD      = #glblCmpyCd#
                            AND A.EZCANCELFLAG      = '0'
                            AND A.SVC_LINE_BIZ_CD   = #svcLineBizCd#
                            AND A.SVC_MACH_TP_CD    = #svcMachTpAcc#
                            AND A.COA_PROD_CD       = #allCd#
                            AND A.COA_MDSE_TP_CD    = #allCd#
                            AND A.SVC_PGM_RNTL_FLG  = #rntlFlg#
                ) AA
            )
        WHERE
            RANK_NUM = 1
    </statement>
</sqlMap>
