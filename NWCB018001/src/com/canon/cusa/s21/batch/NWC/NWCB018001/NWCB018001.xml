<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NWCB018001">
    <statement id="selectInvPrtCtrl" parameterClass="Map" resultClass="Map">
        SELECT
             'B' AS TYPE
            ,IPC.INV_PRT_CTRL_PK
            ,IPC.CONSL_BILL_NUM   AS NUM
            ,IPC.INV_EML_ADDR
            ,IPC.BILL_TO_CUST_CD
            ,IPC.BILL_TO_DS_ACCT_NUM
            ,DS_BIZ_AREA_CD
            ,'Y' CONSL_BILL_FLG
            ,IPC.INV_FTP_RQST_NUM
            ,IPC.INV_PRT_BAT_TP_CD <!--QC#53015 2019/09/13  -->
            ,IPH. LINE_BIZ_TP_CD <!-- QC#54520 2019/11/11 Add -->
        FROM 
             INV_PRT_CTRL IPC
            ,INV_PRT_HDR  IPH <!-- QC#54520 2019/11/11 Add -->
            ,(SELECT
                IPC.GLBL_CMPY_CD
               ,IPC.CONSL_BILL_NUM
               ,MAX(DI.DS_BIZ_AREA_CD) AS DS_BIZ_AREA_CD
             FROM
                INV_PRT_CTRL IPC
               ,INV DI
             WHERE
                 IPC.GLBL_CMPY_CD = #glblCmpyCd#
             AND IPC.EZCANCELFLAG = '0'
             AND IPC.GLBL_CMPY_CD = DI.GLBL_CMPY_CD
             AND IPC.EZCANCELFLAG = DI.EZCANCELFLAG
             AND IPC.INV_NUM = DI.INV_NUM
             GROUP BY IPC.GLBL_CMPY_CD
                     ,IPC.CONSL_BILL_NUM
            ) DI
        WHERE
            IPC.GLBL_CMPY_CD = #glblCmpyCd#
        AND IPC.EZCANCELFLAG = '0'
        AND IPC.INV_PRT_CTRL_REC_CD = #invPrtCtrlRecCd#
        AND IPC.INV_EML_PROC_STS_CD =  #invPrtProcStsCd#
        AND IPC.INV_OTPT_REQ_FLG = #invOtptReqFlg#
        <!-- QC#54520 2019/11/11 Add Start-->
        AND IPC.GLBL_CMPY_CD = IPH.GLBL_CMPY_CD
        AND IPC.EZCANCELFLAG = IPH.EZCANCELFLAG
        AND IPC.INV_PRT_CTRL_PK = IPH.INV_PRT_CTRL_PK
        <!-- QC#54520 2019/11/11 Add End-->
        AND IPC.GLBL_CMPY_CD = DI.GLBL_CMPY_CD
        AND IPC.CONSL_BILL_NUM = DI.CONSL_BILL_NUM
        UNION ALL
        SELECT
             'I' AS TYPE
            ,IPC.INV_PRT_CTRL_PK
            ,IPC.INV_NUM          AS NUM
            ,IPC.INV_EML_ADDR
            ,IPC.BILL_TO_CUST_CD
            ,IPC.BILL_TO_DS_ACCT_NUM
            ,DS_BIZ_AREA_CD
            ,'N' CONSL_BILL_FLG
            ,IPC.INV_FTP_RQST_NUM
            ,IPC.INV_PRT_BAT_TP_CD <!--QC#53015 2019/09/13  -->
            ,IPH. LINE_BIZ_TP_CD <!-- QC#54520 2019/11/11 Add -->
        FROM 
             INV_PRT_CTRL IPC
            ,INV_PRT_HDR  IPH <!-- QC#54520 2019/11/11 Add -->
            ,INV DI
        WHERE
            IPC.GLBL_CMPY_CD = #glblCmpyCd#
        AND IPC.EZCANCELFLAG = '0'
        AND IPC.INV_PRT_CTRL_REC_CD &lt;&gt; #invPrtCtrlRecCd#
        AND IPC.INV_EML_PROC_STS_CD =  #invPrtProcStsCd#
        AND IPC.INV_OTPT_REQ_FLG = #invOtptReqFlg#
        AND IPC.CONSL_BILL_NUM IS NULL
        <!-- QC#54520 2019/11/11 Add Start-->
        AND IPC.GLBL_CMPY_CD = IPH.GLBL_CMPY_CD
        AND IPC.EZCANCELFLAG = IPH.EZCANCELFLAG
        AND IPC.INV_PRT_CTRL_PK = IPH.INV_PRT_CTRL_PK
        <!-- QC#54520 2019/11/11 Add End-->
        AND IPC.GLBL_CMPY_CD = DI.GLBL_CMPY_CD
        AND IPC.EZCANCELFLAG = DI.EZCANCELFLAG
        AND IPC.INV_NUM = DI.INV_NUM
        ORDER BY 5, 3
    </statement>

    <statement id="selectInvPrtCtrlByBillToCust" parameterClass="Map" resultClass="Map">
        SELECT
             'B' AS TYPE
            ,IPC.INV_PRT_CTRL_PK
            ,IPC.CONSL_BILL_NUM   AS NUM
            ,IPC.INV_EML_ADDR
            ,IPC.BILL_TO_CUST_CD
            ,IPC.BILL_TO_DS_ACCT_NUM
            ,DS_BIZ_AREA_CD
           ,'Y' CONSL_BILL_FLG
           ,IPC.INV_FTP_RQST_NUM
           ,IPC.INV_PRT_BAT_TP_CD <!--QC#53015 2019/09/13  -->
        FROM 
             INV_PRT_CTRL IPC
            ,(SELECT
                IPC.GLBL_CMPY_CD
               ,IPC.CONSL_BILL_NUM
               ,MAX(DI.DS_BIZ_AREA_CD) AS DS_BIZ_AREA_CD
             FROM
                INV_PRT_CTRL IPC
               ,INV DI
             WHERE
                 IPC.GLBL_CMPY_CD = #glblCmpyCd#
             AND IPC.EZCANCELFLAG = '0'
             AND IPC.GLBL_CMPY_CD = DI.GLBL_CMPY_CD
             AND IPC.EZCANCELFLAG = DI.EZCANCELFLAG
             AND IPC.INV_NUM = DI.INV_NUM
             GROUP BY IPC.GLBL_CMPY_CD
                     ,IPC.CONSL_BILL_NUM
            ) DI
        WHERE
            IPC.GLBL_CMPY_CD = #glblCmpyCd#
        AND IPC.EZCANCELFLAG = '0'
        AND IPC.INV_PRT_CTRL_REC_CD = #invPrtCtrlRecCd#
        AND IPC.INV_EML_PROC_STS_CD =  #invPrtProcStsCd#
        AND IPC.INV_OTPT_REQ_FLG = #invOtptReqFlg#
        AND IPC.GLBL_CMPY_CD = DI.GLBL_CMPY_CD
        AND IPC.CONSL_BILL_NUM = DI.CONSL_BILL_NUM
        AND IPC.BILL_TO_CUST_CD = #billToCustCd#
        UNION ALL
        SELECT
             'I' AS TYPE
            ,IPC.INV_PRT_CTRL_PK
            ,IPC.INV_NUM          AS NUM
            ,IPC.INV_EML_ADDR
            ,IPC.BILL_TO_CUST_CD
            ,IPC.BILL_TO_DS_ACCT_NUM
            ,DS_BIZ_AREA_CD
           ,'N' CONSL_BILL_FLG
           ,IPC.INV_FTP_RQST_NUM
           ,IPC.INV_PRT_BAT_TP_CD <!--QC#53015 2019/09/13  -->
        FROM 
             INV_PRT_CTRL IPC
            ,INV DI
        WHERE
            IPC.GLBL_CMPY_CD = #glblCmpyCd#
        AND IPC.EZCANCELFLAG = '0'
        AND IPC.INV_PRT_CTRL_REC_CD &lt;&gt; #invPrtCtrlRecCd#
        AND IPC.INV_EML_PROC_STS_CD =  #invPrtProcStsCd#
        AND IPC.INV_OTPT_REQ_FLG = #invOtptReqFlg#
        AND IPC.CONSL_BILL_NUM IS NULL
        AND IPC.GLBL_CMPY_CD = DI.GLBL_CMPY_CD
        AND IPC.EZCANCELFLAG = DI.EZCANCELFLAG
        AND IPC.INV_NUM = DI.INV_NUM
        AND IPC.BILL_TO_CUST_CD = #billToCustCd#
        ORDER BY 3
    </statement>

    <statement id="getFromAddr" parameterClass="Map" resultClass="Map">
        SELECT 
            '1'       NUM
            , PSN.EML_ADDR
        FROM
            BILL_TO_CUST BTC
           ,CLT_PTFO CP
           ,S21_PSN PSN
        WHERE
            BTC.GLBL_CMPY_CD = #glblCmpyCd#
        AND BTC.EZCANCELFLAG = '0'
        AND BTC.BILL_TO_CUST_CD = #billToCustCd#
        AND BTC.GLBL_CMPY_CD = CP.GLBL_CMPY_CD
        AND BTC.EZCANCELFLAG = CP.EZCANCELFLAG
        AND BTC.CLT_PTFO_PK = CP.CLT_PTFO_PK
        AND CP.GLBL_CMPY_CD = PSN.GLBL_CMPY_CD
        AND CP.EZCANCELFLAG = PSN.EZCANCELFLAG
        AND CP.CLT_PSN_CD = PSN.PSN_CD
        <!-- QC#54520 2019/11/11 Add Start -->
        AND PSN.EML_ADDR IS NOT NULL
        UNION ALL
        SELECT
            '2'       NUM
            , PSN.EML_ADDR
        FROM
            SELL_TO_CUST STC
           ,CLT_PTFO CP
           ,S21_PSN PSN
        WHERE
            STC.GLBL_CMPY_CD = #glblCmpyCd#
        AND STC.EZCANCELFLAG = '0'
        AND STC.SELL_TO_CUST_CD = #sellToCustCd#
        AND STC.GLBL_CMPY_CD = CP.GLBL_CMPY_CD
        AND STC.EZCANCELFLAG = CP.EZCANCELFLAG
        AND STC.CLT_PTFO_PK  = CP.CLT_PTFO_PK
        AND CP.GLBL_CMPY_CD  = PSN.GLBL_CMPY_CD
        AND CP.EZCANCELFLAG  = PSN.EZCANCELFLAG
        AND CP.CLT_PSN_CD = PSN.PSN_CD
        AND PSN.EML_ADDR IS NOT NULL
        ORDER BY  NUM
                , EML_ADDR
        <!-- QC#54520 2019/11/11 Add End -->
    </statement>
    
</sqlMap>
