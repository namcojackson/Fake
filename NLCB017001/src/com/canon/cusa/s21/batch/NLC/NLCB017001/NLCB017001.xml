<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!--
 Date         Company         Name            Create/Update   Defect No
 ======================================================================
 03/19/2010   Fujitsu         M.Yamada        UPdate          5007
 03/22/2010   Fujitsu         M.Yamada        UPdate          5081
 09/27/2012   CSAI            M.Takahashi     Update          S21_PRD#410759
 09/19/2013   Fujitsu         S.Yoshida       Update          CMEX localize
 10/29/2013   Fujitsu         S.Yoshida       Update          Def.2928
 11/19/2013   Fujitsu         S.Yoshida       Update          Def.3149
 12/19/2013   Hitachi         T.Kanasaka      Update          CCH-QC200
 07/07/2016   CITS            T.Kikuhara      Update          Ver2.0
 08/22/2018   CITS            Y.Iwasaki       Update          QC#27230
-->
<sqlMap namespace="NLCB017001">

<!-- START Renwal 2016/07/05 T.Kikuhara V2.0-->
<statement id="getInventoryData" parameterClass="Map">
    WITH  ISS_V  AS (
    -- For Except In-Transit
    SELECT
          ISS.GLBL_CMPY_CD
         ,ISS.MDSE_CD
         ,ISS.INVTY_LOC_CD INVTY_LOC_CD_ORG
         ,CASE  ISS.LOC_STS_CD
              WHEN  #locStsCd07#  THEN  #dummyLocCdBA20#
              WHEN  #locStsCd08#  THEN  #dummyLocCdBA20#
              WHEN  #locStsCd09#  THEN  #dummyLocCdBB20#
              WHEN  #locStsCd10#  THEN  #dummyLocCdBB20#
              WHEN  #locStsCd11#  THEN  #dummyLocCdBA22#
              WHEN  #locStsCd12#  THEN  #dummyLocCdBA21#
              WHEN  #locStsCd21#  THEN  #dummyLocCdBB21#
          ELSE
              ISS.INVTY_LOC_CD
          END INVTY_LOC_CD
         ,ISS.LOC_STS_CD
         ,ISS.LOC_TP_CD
         ,ISS.STK_STS_CD
         ,ISS.INVTY_QTY
         ,ISS.INVTY_AVAL_QTY
         ,#vndCdOther# AS IMPT_VND_CD
      FROM
          INVTY_SNAP_SHOT ISS
     WHERE
               ISS.GLBL_CMPY_CD        =  #glblCmpyCd#
          AND  ISS.INVTY_SNAP_SHOT_DT  =  #invtySnapShotDt#
          AND  (
                ( ISS.LOC_STS_CD  =  #locStsCd02#  AND  ISS.LOC_TP_CD  =  #locTpCd01# )
            OR  ( ISS.LOC_STS_CD  =  #locStsCd03#  AND  ISS.LOC_TP_CD  =  #locTpCd01# )
            OR  ( ISS.LOC_STS_CD  =  #locStsCd04#  AND  ISS.LOC_TP_CD  =  #locTpCd01# )
            OR  ( ISS.LOC_STS_CD  =  #locStsCd05#  AND  ISS.LOC_TP_CD  =  #locTpCd01# )
            OR  ( ISS.LOC_STS_CD  =  #locStsCd06#  AND  ISS.LOC_TP_CD  =  #locTpCd01# )
            OR  ( ISS.LOC_STS_CD  =  #locStsCd07#  AND  ISS.LOC_TP_CD  =  #locTpCd01# )
            OR  ( ISS.LOC_STS_CD  =  #locStsCd08#  AND  ISS.LOC_TP_CD  =  #locTpCd01# )
            OR  ( ISS.LOC_STS_CD  =  #locStsCd09#  AND  ISS.LOC_TP_CD  =  #locTpCd03# )
            OR  ( ISS.LOC_STS_CD  =  #locStsCd10#  AND  ISS.LOC_TP_CD  =  #locTpCd03# )
            OR  ( ISS.LOC_STS_CD  =  #locStsCd11# )
            OR  ( ISS.LOC_STS_CD  =  #locStsCd12# )
            OR  ( ISS.LOC_STS_CD  =  #locStsCd16#  AND  ISS.LOC_TP_CD  =  #locTpCd01# )
            OR  ( ISS.LOC_STS_CD  =  #locStsCd21#  )
            <isNotNull property="inclTechInvtyFlg">
            --
            OR  ( ISS.LOC_STS_CD  =  #locStsCd02#  AND  ISS.LOC_TP_CD  =  #locTpCd06# )
            OR  ( ISS.LOC_STS_CD  =  #locStsCd03#  AND  ISS.LOC_TP_CD  =  #locTpCd06# )
            OR  ( ISS.LOC_STS_CD  =  #locStsCd04#  AND  ISS.LOC_TP_CD  =  #locTpCd06# )
            OR  ( ISS.LOC_STS_CD  =  #locStsCd05#  AND  ISS.LOC_TP_CD  =  #locTpCd06# )
            OR  ( ISS.LOC_STS_CD  =  #locStsCd06#  AND  ISS.LOC_TP_CD  =  #locTpCd06# )
            OR  ( ISS.LOC_STS_CD  =  #locStsCd16#  AND  ISS.LOC_TP_CD  =  #locTpCd06# )
            </isNotNull>
            --
          )
           AND  ISS.EZCANCELFLAG  =  '0'
           AND
             EXISTS (
                 SELECT
                     1
                 FROM
                     MDSE DMI
                 WHERE
                         DMI.GLBL_CMPY_CD    = ISS.GLBL_CMPY_CD
                     AND DMI.MDSE_CD         = ISS.MDSE_CD
                     AND DMI.MDSE_RGTN_TP_CD = #rgtnTpCd1#
                     AND DMI.EZCANCELFLAG    = '0'
             )
    UNION ALL
    -- For In-Transit
    SELECT
          ISS.GLBL_CMPY_CD
         ,ISS.MDSE_CD
         ,ISS.INVTY_LOC_CD INVTY_LOC_CD_ORG
         ,ISS.INVTY_LOC_CD
         ,ISS.LOC_STS_CD
         ,ISS.LOC_TP_CD
         ,ISS.STK_STS_CD
         ,NVL(IMPT_VND_V.INVTY_QTY , ISS.INVTY_QTY_ISS ) INVTY_QTY
         ,ISS.INVTY_AVAL_QTY
         ,NVL(IMPT_VND_V.IMPT_VND_CD , #vndCdOther# ) IMPT_VND_CD
    FROM (  SELECT
                INV.IMPT_VND_CD
               ,STS.MDSE_CD
               ,DECODE (RDTL.WH_CD,NULL,DTL.DEF_INVTY_LOC_CD,RDTL.WH_CD) DEF_INVTY_LOC_CD
               ,SUM (STS.REQ_STK_IN_QTY - STS.CONF_STK_IN_QTY) INVTY_QTY
            FROM
                IMPT_INV INV
               ,IMPT_PACK_SLP_STS STS
               ,IMPT_PACK_SLP_DTL DTL
               ,(SELECT
                       RHDR.WH_CD
                      ,RDTL.IMPT_PACK_SLP_STS_PK
                   FROM
                       RWS_HDR RHDR
                      ,RWS_DTL RDTL
                  WHERE
                       RDTL.RWS_NUM             = RHDR.RWS_NUM
                   AND RHDR.RWS_STS_CD NOT     IN (#rwsCanceled#,#rwsReceived#)
                   AND RDTL.RWS_STS_CD NOT     IN (#rwsCanceled#,#rwsReceived#)
                   AND RHDR.EZCANCELFLAG        = 0
                   AND RDTL.EZCANCELFLAG        = 0
                   AND RHDR.GLBL_CMPY_CD        =  #glblCmpyCd#
                   AND RHDR.GLBL_CMPY_CD        =  RDTL.GLBL_CMPY_CD
                 ) RDTL
           WHERE
                 INV.IMPT_INV_PK               = STS.IMPT_INV_PK
             AND INV.IMPT_INV_STS_CD NOT      IN (#invStatusClosed#)
             AND STS.IMPT_PACK_SLP_DTL_PK      = DTL.IMPT_PACK_SLP_DTL_PK
             AND STS.IMPT_PACK_SLP_STS_PK      = RDTL.IMPT_PACK_SLP_STS_PK(+)
             AND STS.IMPT_PACK_SLP_STS_CD NOT IN (#invStatusClosed#,#invStatusReceived#)
             AND INV.EZCANCELFLAG              = 0
             AND STS.EZCANCELFLAG              = 0
             AND DTL.EZCANCELFLAG              = 0
             AND INV.GLBL_CMPY_CD              =  #glblCmpyCd#
             AND INV.GLBL_CMPY_CD              =  STS.GLBL_CMPY_CD
             AND STS.GLBL_CMPY_CD              =  DTL.GLBL_CMPY_CD
        GROUP BY
                 INV.IMPT_VND_CD
                ,STS.MDSE_CD
                ,DECODE (RDTL.WH_CD,NULL,DTL.DEF_INVTY_LOC_CD,RDTL.WH_CD)
         ) IMPT_VND_V
        ,(  SELECT
                  ISS_01.MDSE_CD
                 ,SUM (ISS_01.INVTY_QTY) INVTY_QTY_ISS
                 ,SUM (ISS_01.INVTY_AVAL_QTY) INVTY_AVAL_QTY
                 ,ISS_01.INVTY_LOC_CD
                 ,ISS_01.LOC_TP_CD
                 ,ISS_01.GLBL_CMPY_CD
                 ,ISS_01.LOC_STS_CD
                 ,ISS_01.STK_STS_CD
            FROM
                  INVTY_SNAP_SHOT ISS_01
           WHERE (
                ( ISS_01.LOC_STS_CD  =  #locStsCd01#  AND  ISS_01.LOC_TP_CD  =  #locTpCd01# )
            OR  ( ISS_01.LOC_STS_CD  =  #locStsCd01#  AND  ISS_01.LOC_TP_CD  =  #locTpCd03# )
            OR  ( ISS_01.LOC_STS_CD  =  #locStsCd01#  AND  ISS_01.LOC_TP_CD  =  #locTpCd05# )
            <isNotNull property="inclTechInvtyFlg">
            --
            OR  ( ISS_01.LOC_STS_CD  =  #locStsCd01#  AND  ISS_01.LOC_TP_CD  =  #locTpCd06# )
            </isNotNull>
            --
                )
              AND ISS_01.INVTY_SNAP_SHOT_DT  =  #invtySnapShotDt#
              AND ISS_01.GLBL_CMPY_CD        =  #glblCmpyCd#
              AND ISS_01.EZCANCELFLAG        =  '0'
        GROUP BY
                  ISS_01.MDSE_CD
                 ,ISS_01.INVTY_LOC_CD
                 ,ISS_01.LOC_TP_CD
                 ,ISS_01.LOC_STS_CD
                 ,ISS_01.STK_STS_CD
                 ,ISS_01.GLBL_CMPY_CD
         ) ISS
    WHERE
         ISS.MDSE_CD       = IMPT_VND_V.MDSE_CD(+)
     AND ISS.INVTY_LOC_CD  = IMPT_VND_V.DEF_INVTY_LOC_CD(+)
     AND
        EXISTS (
           SELECT
               1
           FROM
               MDSE DMI
           WHERE
                   DMI.GLBL_CMPY_CD    = ISS.GLBL_CMPY_CD
               AND DMI.MDSE_CD         = ISS.MDSE_CD
               AND DMI.MDSE_RGTN_TP_CD = #rgtnTpCd1#
               AND DMI.EZCANCELFLAG    = '0'
       )
-- Refurbish_recycle_stock_qty
    UNION ALL
    SELECT
        RO.GLBL_CMPY_CD
       ,RO.RMNF_MAIN_UNIT_MDSE_CD
       ,RO.RMNF_INVTY_LOC_CD              INVTY_LOC_CD_ORG
       ,#dummyLocCdBB20#                  INVTY_LOC_CD
       ,''                                LOC_STS_CD
       ,''                                LOC_TP_CD
       ,RD.STK_STS_CD
       ,COUNT(RO.RMNF_MAIN_UNIT_MDSE_CD)  INVTY_QTY
       ,COUNT(RO.RMNF_MAIN_UNIT_MDSE_CD)  INVTY_AVAL_QTY
       ,#vndCdOther#                      IMPT_VND_CD
    FROM
        RMNF_ORD       RO
       ,RMNF_ORD_DTL   RD
       ,RMNF_ORD_STS   RS
    WHERE
        RO.GLBL_CMPY_CD           = #glblCmpyCd#
    AND RO.EZCANCELFLAG           = '0'
    AND RO.GLBL_CMPY_CD           = RD.GLBL_CMPY_CD
    AND RO.RMNF_ORD_NUM           = RD.RMNF_ORD_NUM
    AND RO.RMNF_MAIN_UNIT_SER_NUM = RD.CMPT_SER_NUM
    AND RD.EZCANCELFLAG           = '0'
    AND RO.GLBL_CMPY_CD           = RS.GLBL_CMPY_CD
    AND RO.RMNF_ORD_STS_CD        = RS.RMNF_ORD_STS_CD
    AND RS.IN_PROC_STS_FLG        = #flgOnY#
    AND RS.EZCANCELFLAG           = '0'
    AND
      EXISTS (
          SELECT
              1
          FROM
              MDSE DMI
          WHERE
                  DMI.GLBL_CMPY_CD    = RO.GLBL_CMPY_CD
              AND DMI.MDSE_CD         = RO.RMNF_MAIN_UNIT_MDSE_CD
              AND DMI.MDSE_RGTN_TP_CD = #rgtnTpCd1#
              AND DMI.EZCANCELFLAG    = '0'
      )
    GROUP BY
        RO.GLBL_CMPY_CD
       ,RO.RMNF_MAIN_UNIT_MDSE_CD
       ,RO.RMNF_INVTY_LOC_CD
       ,RD.STK_STS_CD
-- Waiting_install_stock_qty
    UNION ALL
    SELECT
        SP.GLBL_CMPY_CD
       ,SP.MDSE_CD
       ,SP.INVTY_LOC_CD   INVTY_LOC_CD_ORG
       ,#dummyLocCdBA24#  INVTY_LOC_CD
       ,''                LOC_STS_CD
       ,''                LOC_TP_CD
       ,''                STK_STS_CD
       ,SUM(ORD_QTY)      INVTY_QTY
       ,SUM(ORD_QTY)      INVTY_AVAL_QTY
       ,#vndCdOther#      IMPT_VND_CD
    FROM
        SHPG_PLN     SP
       ,SHPG_STS     SS
    WHERE
        SP.GLBL_CMPY_CD   = #glblCmpyCd#
    AND SP.REV_RECOG_FLG  = #flgOffN#
    AND SP.EZCANCELFLAG   = '0'
    AND SP.GLBL_CMPY_CD   = SS.GLBL_CMPY_CD
    AND SP.SHPG_STS_CD    = SS.SHPG_STS_CD
    AND SS.SHIP_FLG       = #flgOnY#
    AND SS.EZCANCELFLAG   = '0'
    AND EXISTS
        ( SELECT
              1
          FROM
              CPO                     OH
             ,CPO_DTL                 OD
             ,DS_ORD_LINE_PROC_DFN    PD
             ,AJE_ACCT_BAT            AC
         WHERE
             OH.GLBL_CMPY_CD         = SP.GLBL_CMPY_CD
         AND OH.CPO_ORD_NUM          = SP.TRX_HDR_NUM
         AND OH.EZCANCELFLAG         = '0'
         AND OD.GLBL_CMPY_CD         = SP.GLBL_CMPY_CD
         AND OD.CPO_ORD_NUM          = SP.TRX_HDR_NUM
         AND OD.CPO_DTL_LINE_NUM     = SP.TRX_LINE_NUM
         AND OD.CPO_DTL_LINE_SUB_NUM = SP.TRX_LINE_SUB_NUM
         AND OD.EZCANCELFLAG         = '0'
         AND OH.GLBL_CMPY_CD         = PD.GLBL_CMPY_CD
         AND OH.DS_ORD_TP_CD         = PD.DS_ORD_TP_CD
         AND OD.DS_ORD_LINE_CATG_CD  = PD.DS_ORD_LINE_CATG_CD
         AND PD.EZCANCELFLAG         = '0'
         AND PD.GLBL_CMPY_CD         = AC.GLBL_CMPY_CD
         AND PD.AJE_ACCT_BAT_CD      = AC.AJE_ACCT_BAT_CD
         AND AC.TRX_CD               = #trxRental#
         AND AC.EZCANCELFLAG         = '0'
        )
    AND
      EXISTS (
          SELECT
              1
          FROM
              MDSE DMI
          WHERE
                  DMI.GLBL_CMPY_CD    = SP.GLBL_CMPY_CD
              AND DMI.MDSE_CD         = SP.MDSE_CD
              AND DMI.MDSE_RGTN_TP_CD = #rgtnTpCd1#
              AND DMI.EZCANCELFLAG    = '0'
      )
    GROUP BY SP.GLBL_CMPY_CD, SP.MDSE_CD, SP.INVTY_LOC_CD
<!-- START ADD Y.Imazu [ITG.508447] -->
--Not_revenue_qty
    UNION ALL
    SELECT
         SP.GLBL_CMPY_CD
        ,SP.MDSE_CD
        ,CASE WHEN SP.PO_REQ_FLG = #flgOnY# THEN #drctShipWh#
              ELSE SP.INVTY_LOC_CD
         END AS INVTY_LOC_CD_ORG
        ,CASE WHEN SP.PO_REQ_FLG = #flgOnY# THEN #drctShipWh#
              WHEN SP.INVTY_LOC_CD IS NULL THEN #nonShipWh#
              ELSE SP.INVTY_LOC_CD
         END             AS INVTY_LOC_CD
        ,#locStsCd03#    AS LOC_STS_CD
        ,#locTpCd01#     AS LOC_TP_CD
        ,SP.STK_STS_CD
        ,SP.ORD_QTY      AS INVTY_QTY
        ,SP.ORD_QTY      AS INVTY_AVAL_QTY
        ,#vndCdOther#    AS IMPT_VND_CD
    FROM
        SHPG_PLN SP
       ,MDSE     MD
    WHERE
        SP.GLBL_CMPY_CD      = #glblCmpyCd#
    AND SP.REV_RECOG_FLG     = #flgOffN#
    AND SP.TRX_SRC_TP_CD     = #trxSrcWholeSales#
    AND SP.TRX_CD            IN (#trxSalas#, #trxExpense#)
    AND SP.SHPG_STS_CD       IN (#shpgStsShipped#, #shpgStsArrived#, #shpgStsInstalled#)
    AND SP.SHIP_PLN_CANC_FLG = #flgOffN#
    AND SP.ACTL_SHIP_DT      &lt;= #invtySnapShotDt#
    AND SP.EZCANCELFLAG      = '0'
    AND MD.GLBL_CMPY_CD      = SP.GLBL_CMPY_CD
    AND MD.MDSE_CD           = SP.MDSE_CD
    AND (MD.INVTY_CTRL_FLG   = #flgOnY#
     OR (MD.INVTY_CTRL_FLG   = #flgOffN# AND MD.INVTY_VAL_FLG = #flgOnY#))
    AND MD.EZCANCELFLAG      = '0'
    AND
       EXISTS (
          SELECT
              1
          FROM
              MDSE DMI
          WHERE
                  DMI.GLBL_CMPY_CD    = SP.GLBL_CMPY_CD
              AND DMI.MDSE_CD         = SP.MDSE_CD
              AND DMI.MDSE_RGTN_TP_CD = #rgtnTpCd1#
              AND DMI.EZCANCELFLAG    = '0'
      )
    AND NOT EXISTS(
        SELECT
            1
        FROM
            SHPG_ORD SO
        WHERE
            SO.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
        AND SO.SO_NUM = SP.SO_NUM
        AND SO.SCE_ORD_TP_CD = #sceOrdTpCdDT#
        AND SO.EZCANCELFLAG = '0'
)
<!-- END   ADD Y.Imazu [ITG.508447] -->
    )
-- END WITH
    SELECT
          ISS_V.GLBL_CMPY_CD
         ,ISS_V.MDSE_CD
         ,ISS_V.INVTY_LOC_CD
         ,ISS_V.LOC_STS_CD
         ,ISS_V.LOC_TP_CD
         ,ISS_V.STK_STS_CD
         ,ISS_V.INVTY_QTY
         ,ISS_V.INVTY_AVAL_QTY
         ,ISS_V.IMPT_VND_CD
         ,WH.RTL_WH_CATG_CD
         ,NVL(SWH.MDSE_INVTY_COST_PCT, 100) AS MDSE_INVTY_COST_PCT
    FROM
          ISS_V
          ,DS_INVTY_LOC_V  IVL
          ,RTL_WH WH
          ,SWH SWH
    WHERE
            IVL.GLBL_CMPY_CD    = ISS_V.GLBL_CMPY_CD
        AND IVL.INVTY_LOC_CD    = ISS_V.INVTY_LOC_CD_ORG
        AND IVL.EZCANCELFLAG    = '0'
        AND IVL.GLBL_CMPY_CD    = WH.GLBL_CMPY_CD
        AND IVL.RTL_WH_CD       = WH.RTL_WH_CD
        AND WH.EZCANCELFLAG     = '0'
        AND IVL.GLBL_CMPY_CD    = SWH.GLBL_CMPY_CD(+)
        AND IVL.RTL_SWH_CD      = SWH.RTL_SWH_CD(+)
        AND SWH.EZCANCELFLAG(+) = '0'
        AND
          EXISTS (
              SELECT
                  1
              FROM
                  INVTY_OWNR IO
              WHERE
                      IO.GLBL_CMPY_CD    = WH.GLBL_CMPY_CD
                  AND IO.INVTY_OWNR_CD   = WH.INVTY_OWNR_CD
                  AND IO.CMPY_INVTY_FLG  = #flgOnY#
                  AND IO.EZCANCELFLAG    = '0'
          )
-- Rental_stock_qty
    UNION ALL
    SELECT
         AM.GLBL_CMPY_CD
        ,AM.MDSE_CD
        ,#dummyLocCdZA20#   INVTY_LOC_CD
        ,''                 LOC_STS_CD
        ,''                 LOC_TP_CD
        ,''                 STK_STS_CD
        ,COUNT(AM.MDSE_CD)  INVTY_QTY
        ,COUNT(AM.MDSE_CD)  INVTY_AVAL_QTY
        ,#vndCdOther#       IMPT_VND_CD
        ,''                 RTL_WH_CATG_CD
        ,#costPct100#       MDSE_INVTY_COST_PCT
    FROM
        DS_ASSET_MSTR       AM
    WHERE
        AM.GLBL_CMPY_CD     = #glblCmpyCd#
    AND AM.ASSET_TP_CD      = #rentalAsset#
    AND AM.EZCANCELFLAG     = '0'
    AND ( AM.ACTV_ASSET_FLG = #flgOnY#
    OR   AM.ASSET_STS_CD   = #pending#)
    AND EXISTS (
            SELECT
                1
            FROM
                MDSE DMI
            WHERE
                DMI.GLBL_CMPY_CD    = AM.GLBL_CMPY_CD
            AND DMI.MDSE_CD         = AM.MDSE_CD
            AND DMI.MDSE_RGTN_TP_CD = #rgtnTpCd1#
            AND DMI.EZCANCELFLAG    = '0'
    )
    GROUP BY AM.GLBL_CMPY_CD, AM.MDSE_CD
-- UNION END
    ORDER BY
          GLBL_CMPY_CD
         ,MDSE_CD
         <isNull property="InterfaceWE">
         --
         ,INVTY_LOC_CD
         </isNull>
         --
         ,LOC_STS_CD
         ,LOC_TP_CD
         ,STK_STS_CD
</statement>
<!-- END Renewal 2016/07/05 T.Kikuhara V2.0-->

    <statement id="getLocRoleTp" parameterClass="Map">
     SELECT
          U.LOC_ROLE_TP_CD
     FROM
          WH      W
         ,LOC_USG U
     WHERE
             W.GLBL_CMPY_CD = #glblCmpyCd#
         AND W.WH_CD        = #whCd#
         AND W.EZCANCELFLAG = '0'
         AND U.GLBL_CMPY_CD = W.GLBL_CMPY_CD
         AND U.PTY_LOC_PK   = W.PTY_LOC_PK
         AND U.EZCANCELFLAG = '0'
    </statement>

</sqlMap>
