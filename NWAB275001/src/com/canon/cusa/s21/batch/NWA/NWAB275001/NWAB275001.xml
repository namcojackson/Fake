<?xml version="1.0" encoding="UTF-8"?>

<sqlMap namespace="NWAB275001">

    <statement id="getTargetData" parameterClass="Map" resultClass="Map">
        SELECT
             SP.TRX_HDR_NUM
             , SP.TRX_LINE_NUM
             , SP.TRX_LINE_SUB_NUM
             , SP.SHPG_PLN_NUM
             , SMM2.SVC_MACH_MSTR_PK
             , SMM2.SVC_MACH_MSTR_STS_CD
             , SMM2.SVC_CONFIG_MSTR_PK
             , SMM2.SVC_MACH_MSTR_LOC_STS_CD
             , SMM2.STK_STS_CD
        FROM
             SVC_MACH_MSTR SMM
             , SVC_MACH_MSTR SMM2
             , SHPG_PLN        SP
             , CPO_DTL       CD
             , MDSE          M
             , DS_CPO_ISTL_INFO DCII
             , SVC_ISTL_RULE SIR
             , DS_CPO_CONFIG DCC
             , SHPG_ORD_DTL SOD
        WHERE
             SMM.SVC_MACH_TP_CD              = #mainMachTp#
             AND SMM.SVC_MACH_MSTR_STS_CD    = #svcMachMstrStsInstalled#
             AND SMM.GLBL_CMPY_CD            = #glblCmpyCd#
             AND SMM.EZCANCELFLAG            = '0'
             AND SMM.SVC_CONFIG_MSTR_PK      = SMM2.SVC_CONFIG_MSTR_PK
             AND SMM2.SVC_MACH_MSTR_STS_CD   = #svcMachMstrStsW4I#
             AND SMM2.SVC_MACH_TP_CD         = #machTp#
             AND SMM.GLBL_CMPY_CD            = SMM2.GLBL_CMPY_CD
             AND SMM2.EZCANCELFLAG           = '0'
             AND SMM2.SHPG_PLN_NUM           = SP.SHPG_PLN_NUM
             AND SMM2.GLBL_CMPY_CD           = SP.GLBL_CMPY_CD
             AND SP.EZCANCELFLAG             = '0'
             AND SP.REV_RECOG_FLG            = 'N'
             AND SP.SHPG_STS_CD              &gt;= #shpgStsArrived#
             AND SP.SO_NUM                   = SOD.SO_NUM
             AND SP.SO_SLP_NUM               = SOD.SO_SLP_NUM
             AND SOD.ACTL_DELY_DT            IS NOT NULL
             AND SP.GLBL_CMPY_CD             = SOD.GLBL_CMPY_CD
             AND SOD.EZCANCELFLAG            = '0'
             AND SP.TRX_HDR_NUM              = CD.CPO_ORD_NUM 
             AND SP.TRX_LINE_NUM             = CD.CPO_DTL_LINE_NUM 
             AND SP.TRX_LINE_SUB_NUM         = CD.CPO_DTL_LINE_SUB_NUM
             AND SP.GLBL_CMPY_CD             = CD.GLBL_CMPY_CD
             AND CD.EZCANCELFLAG             = '0'
             AND CD.DS_CPO_CONFIG_PK         = DCII.DS_CPO_CONFIG_PK
             AND CD.GLBL_CMPY_CD             = DCII.GLBL_CMPY_CD
             AND DCII.EZCANCELFLAG           = '0'
             AND DCII.SVC_ISTL_RULE_NUM      = SIR.SVC_ISTL_RULE_NUM
             AND DCII.GLBL_CMPY_CD           = SIR.GLBL_CMPY_CD
             AND SIR.EZCANCELFLAG            = '0'
             AND SIR.SVC_CUST_ISTL_FLG       = 'N'
             AND M.EZCANCELFLAG              = '0'
             AND M.INVTY_CTRL_FLG            = 'Y'
             AND M.INSTL_BASE_CTRL_FLG       = 'Y'
             AND SP.MDSE_CD                  = M.MDSE_CD
             AND SP.GLBL_CMPY_CD             = M.GLBL_CMPY_CD
             AND CD.DS_CPO_CONFIG_PK         = DCC.DS_CPO_CONFIG_PK
             AND DCC.CONFIG_TP_CD            = #newCfgActTp#
             AND CD.GLBL_CMPY_CD             = DCC.GLBL_CMPY_CD
             AND DCC.EZCANCELFLAG            = '0'
             AND EXISTS (
                 SELECT 
                        1
                 FROM 
                        MDSE_VAL_SET MVS
                 WHERE 
                        MVS.MDSE_CD            = M.MDSE_CD
                        AND MVS.MDSE_CTX_TP_CD = #CtxTpInstalled#
                        AND MVS.GLBL_CMPY_CD   = M.GLBL_CMPY_CD
                        AND MVS.EZCANCELFLAG   = '0'
             )
             AND NOT EXISTS (
                  SELECT
                        1
                  FROM
                        SVC_TASK        ST
                        ,DS_SVC_CALL_TP  DSCT
                  WHERE
                         SMM.GLBL_CMPY_CD           = ST.GLBL_CMPY_CD
                         AND SMM.SVC_MACH_MSTR_PK   = ST.SVC_MACH_MSTR_PK
                         AND SMM.SHIP_DT            &gt;= ST.SVC_TASK_RCV_DT
                         AND ST.EZCANCELFLAG        = '0'
                         AND ST.GLBL_CMPY_CD        = DSCT.GLBL_CMPY_CD
                         AND ST.DS_SVC_CALL_TP_CD   = DSCT.DS_SVC_CALL_TP_CD
                         AND DSCT.SVC_ISTL_REQ_FLG  = 'Y'
                         AND DSCT.EZCANCELFLAG      = '0'
             )
             ORDER BY
                  TRX_HDR_NUM
                  , TRX_LINE_NUM
                  , TRX_LINE_SUB_NUM
                  , SHPG_PLN_NUM
                 , SVC_MACH_MSTR_PK
    </statement>

</sqlMap>
