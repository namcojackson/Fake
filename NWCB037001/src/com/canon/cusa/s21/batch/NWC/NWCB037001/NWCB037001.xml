<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NWCB037001">

    <statement id="getErrorHeader" parameterClass="Map" resultClass="Map">
        SELECT
                  H.FM_INV_IMPT_HDR_PK
            FROM
                FM_INV_IMPT_HDR H
            WHERE
                H.GLBL_CMPY_CD          = #glblCmpyCd#
                AND H.PROC_ERR_FLG      = 'Y'
                AND H.EZCANCELFLAG      = '0'
            ORDER BY
                H.FM_BAT_ID
    </statement>

    <statement id="getErrorDetail" parameterClass="Map" resultClass="Map">
        SELECT
                  D.FM_INV_IMPT_DTL_PK
            FROM
                FM_INV_IMPT_DTL D
            WHERE
                D.GLBL_CMPY_CD          = #glblCmpyCd#
                AND D.PROC_ERR_FLG      = 'Y'
                AND D.EZCANCELFLAG      = '0'
            ORDER BY
                D.FM_BAT_ID
    </statement>

    <statement id="getInvoiceTarget" parameterClass="Map" resultClass="Map">
        SELECT
                  FID.GLBL_CMPY_CD
                , FID.FM_INV_IMPT_DTL_PK
                , FID.FM_INV_IMPT_HDR_PK
                , FID.FM_BAT_ID
                , FID.AR_INTFC_FLG
                , FID.INV_IMPT_PROC_FLG
                , FID.FM_CRAT_TS
                , FID.FM_CRAT_USR_ID
                , FID.FM_UPD_TS
                , FID.FM_UPD_USR_ID
                , FID.FM_ACCT_NUM
                , FID.FM_BID_TXT
                , FID.BLLG_PER_FROM_DT
                , FID.BLLG_PER_THRU_DT
                , FID.SHIP_TO_CUST_CD
                , FID.BILL_TO_CUST_CD
                , FID.FM_MDSE_CD
                , FID.FM_DESC_TXT
                , CASE 
                    WHEN FID.FM_LINE_AMT >= 0
                    THEN '+' 
                    ELSE '-' 
                    END FM_LINE_AMT_SIGN
                , FID.FM_LINE_AMT
                , FID.FM_LINE_TAX_AMT
                , FID.FM_AR_INTFC_ID
                , FID.FM_ITEM_ID
                , FID.FM_MDSE_DESC_TXT
                , FID.BILL_TO_LOC_NUM
                , FID.SHIP_TO_LOC_NUM
                , FID.BILL_TO_CUST_ACCT_CD
                , FID.SHIP_TO_CUST_ACCT_CD
                , FID.SLS_REP_CR_PCT
                , FID.SLS_REP_TOC_CD
                , FID.INTFC_LINE_ATTRB_TXT_01
                , FID.INTFC_LINE_ATTRB_TXT_02
                , FID.INTFC_LINE_ATTRB_TXT_03
                , FID.INTFC_LINE_ATTRB_TXT_04
                , FID.INTFC_LINE_ATTRB_TXT_05
                , FID.INTFC_LINE_ATTRB_TXT_06
                , FID.INTFC_LINE_ATTRB_TXT_07
                , FID.INTFC_LINE_ATTRB_TXT_08
                , FID.INTFC_LINE_ATTRB_TXT_09
                , FID.INTFC_LINE_ATTRB_TXT_10
                , FID.INTFC_LINE_ATTRB_TXT_11
                , FID.INTFC_LINE_ATTRB_TXT_12
                , FID.INTFC_LINE_ATTRB_TXT_13
                , FID.INTFC_LINE_ATTRB_TXT_14
                , FID.INTFC_LINE_ATTRB_TXT_15
                , NVL(
                    FID.DFRD_ACCTG_RULE_CD
                    , (
                        SELECT
                                  M.DFRD_ACCTG_RULE_CD
                            FROM
                                ALL_MDSE_V  M
                            WHERE
                                M.GLBL_CMPY_CD      = FID.GLBL_CMPY_CD
                                AND M.MDSE_CD       = FID.FM_MDSE_CD
                                AND M.EZCANCELFLAG  = '0'
                                AND ROWNUM          = 1
                    )
                ) DFRD_ACCTG_RULE_CD
                , FID.SHIP_QTY
                , FID.INV_TP_CD
                , FID.PROC_ERR_FLG
                , FID.PROC_ERR_MSG_TXT
                , FID.PMT_TERM_CASH_DISC_CD
            FROM
                FM_INV_IMPT_HDR     FIH
                , FM_INV_IMPT_DTL   FID
            WHERE
                FIH.GLBL_CMPY_CD            = #glblCmpyCd#
                AND FIH.INV_IMPT_PROC_FLG   = 'N'
                AND FIH.PROC_ERR_FLG        = 'N'
                AND FIH.EZCANCELFLAG        = '0'
                AND FIH.GLBL_CMPY_CD        = FID.GLBL_CMPY_CD
                AND FIH.FM_BAT_ID           = FID.FM_BAT_ID
                AND FID.INV_IMPT_PROC_FLG   = 'N'
                AND FID.PROC_ERR_FLG        = 'N'
                AND FID.EZCANCELFLAG        = '0'
            ORDER BY
                FID.FM_BAT_ID
                , FID.BILL_TO_CUST_CD
                , FID.PMT_TERM_CASH_DISC_CD
                , FID.SHIP_TO_CUST_CD
                , FM_LINE_AMT_SIGN
                , FID.FM_INV_IMPT_DTL_PK
                , FID.FM_AR_INTFC_ID <!-- 2018/01/29 S21_NA#23243 Add -->
    </statement>

    <statement id="checkHeaderExistsDetail" parameterClass="Map" resultClass="BigDecimal">
        SELECT
                  FIH.FM_INV_IMPT_HDR_PK
            FROM
                FM_INV_IMPT_HDR FIH
            WHERE
                FIH.GLBL_CMPY_CD            = #glblCmpyCd#
                AND FIH.INV_IMPT_PROC_FLG   = 'N'
                AND FIH.PROC_ERR_FLG        = 'N'
                AND FIH.EZCANCELFLAG        = '0'
                AND NOT EXISTS (
                    SELECT
                              1
                        FROM
                            FM_INV_IMPT_DTL FID
                        WHERE
                            FID.GLBL_CMPY_CD            = FIH.GLBL_CMPY_CD
                            AND FID.FM_BAT_ID           = FIH.FM_BAT_ID
                            AND FID.INV_IMPT_PROC_FLG   = 'N'
                            AND FID.PROC_ERR_FLG        = 'N'
                            AND FID.EZCANCELFLAG        = '0'
                )
    </statement>

    <statement id="checkDetailExistsHeader" parameterClass="Map" resultClass="BigDecimal">
        SELECT
                  FID.FM_INV_IMPT_DTL_PK
            FROM
                FM_INV_IMPT_DTL FID
            WHERE
                FID.GLBL_CMPY_CD            = #glblCmpyCd#
                AND FID.INV_IMPT_PROC_FLG   = 'N'
                AND FID.PROC_ERR_FLG        = 'N'
                AND FID.EZCANCELFLAG        = '0'
                AND NOT EXISTS (
                    SELECT
                              1
                        FROM
                            FM_INV_IMPT_HDR FIH
                        WHERE
                            FIH.GLBL_CMPY_CD            = FID.GLBL_CMPY_CD
                            AND FIH.FM_BAT_ID           = FID.FM_BAT_ID
                            AND FIH.INV_IMPT_PROC_FLG   = 'N'
                            AND FIH.PROC_ERR_FLG        = 'N'
                            AND FIH.EZCANCELFLAG        = '0'
                )
    </statement>

    <statement id="checkBatIdDuplicated" parameterClass="Map" resultClass="BigDecimal">
        SELECT
                  FIH.FM_INV_IMPT_HDR_PK
            FROM
                FM_INV_IMPT_HDR FIH
            WHERE
                FIH.GLBL_CMPY_CD    = #glblCmpyCd#
                AND FIH.FM_BAT_ID IN (
                    SELECT
                              H.FM_BAT_ID
                        FROM
                            FM_INV_IMPT_HDR H
                        WHERE
                            H.GLBL_CMPY_CD          = FIH.GLBL_CMPY_CD
                            AND H.INV_IMPT_PROC_FLG = 'N'
                            AND H.PROC_ERR_FLG      = 'N'
                            AND H.EZCANCELFLAG      = '0'
                        GROUP BY
                            H.FM_BAT_ID
                        HAVING
                            COUNT(H.FM_BAT_ID) > 1
                )
                AND FIH.EZCANCELFLAG = '0'
    </statement>



    <statement id="getBillToTaxGrpExemCd" parameterClass="Map" resultClass="String">
        SELECT
            NVL(
                (SELECT
                      BT.DS_TAX_GRP_EXEM_CD
                FROM
                      BILL_TO_CUST      BT
                WHERE
                        BT.GLBL_CMPY_CD     = #glblCmpyCd#
                    AND BT.BILL_TO_CUST_CD  = #billToCustCd#
                    AND BT.EZCANCELFLAG     = '0'
                ),
                (SELECT
                      STC.DS_TAX_GRP_EXEM_CD
                FROM
                      SELL_TO_CUST      STC
                WHERE
                        STC.GLBL_CMPY_CD    = #glblCmpyCd#
                    AND STC.SELL_TO_CUST_CD = #billToAcctCd#
                    AND STC.EZCANCELFLAG    = '0'
                )
            )   DS_TAX_GRP_EXEM_CD
        FROM DUAL
    </statement>

    <statement id="getShipToTaxGrpExemCd" parameterClass="Map" resultClass="String">
        SELECT
            NVL(
                (SELECT
                      ST.DS_TAX_GRP_EXEM_CD
                FROM
                      SHIP_TO_CUST      ST
                WHERE
                        ST.GLBL_CMPY_CD     = #glblCmpyCd#
                    AND ST.SHIP_TO_CUST_CD  = #shipToCustCd#
                    AND ST.EZCANCELFLAG     = '0'
                ),
                (SELECT
                      STC.DS_TAX_GRP_EXEM_CD
                 FROM
                      SELL_TO_CUST      STC
                 WHERE
                        STC.GLBL_CMPY_CD    = #glblCmpyCd#
                    AND STC.SELL_TO_CUST_CD = #shipToAcctCd#
                    AND STC.EZCANCELFLAG    = '0'
                )
            )   DS_TAX_GRP_EXEM_CD
        FROM DUAL
    </statement>

    <statement id="getShipToInfo" parameterClass="Map" resultClass="Map">
        SELECT
             STC.SHIP_TO_CUST_CD
            ,STC.LOC_NM
            ,STC.ADDL_LOC_NM
            ,STC.FIRST_LINE_ADDR
            ,STC.SCD_LINE_ADDR
            ,STC.THIRD_LINE_ADDR
            ,STC.FRTH_LINE_ADDR
            ,STC.CTY_ADDR
            ,STC.ST_CD
            ,STC.PROV_NM
            ,STC.POST_CD
            ,STC.CTRY_CD
            ,CNTY.CNTY_NM
            ,STC.CNTY_PK
            ,STC.GEO_CD
            ,STC.DS_INSD_CTY_LIMIT_FLG
        FROM
             SHIP_TO_CUST       STC
            ,CNTY               CNTY
        WHERE
                STC.GLBL_CMPY_CD     = #glblCmpyCd#
            AND STC.SHIP_TO_CUST_CD  = #shipToCustCd#
            AND STC.RGTN_STS_CD      = #rgtnStsCd#
            AND STC.EZCANCELFLAG     = '0'

            AND STC.GLBL_CMPY_CD     = CNTY.GLBL_CMPY_CD (+)
            AND STC.CNTY_PK          = CNTY.CNTY_PK (+)
            AND CNTY.EZCANCELFLAG(+) = '0'

    </statement>

    <statement id="getTaxAreaId" parameterClass="Map" resultClass="Map">
        SELECT
            TA.TAX_AREA_ID
        FROM
            TAX_AREA TA
        WHERE 
            TA.GLBL_CMPY_CD = #glblCmpyCd#
        <isNotNull property="ctyAddr">
        AND TA.CTY_ADDR     = #ctyAddr#
        </isNotNull>
        <isNull property="ctyAddr">
        AND TA.CTY_ADDR    IS NULL
        </isNull>
        <isNotNull property="cntyPk">
        AND TA.CNTY_PK      = #cntyPk#
        </isNotNull>
        <isNull property="cntyPk">
        AND TA.CNTY_PK     IS NULL
        </isNull>
        AND TA.ST_CD        = #stCd#
        AND TA.EZCANCELFLAG = '0'
        AND ROWNUM          = 1
    </statement>

    <statement id="getSalesRepAdress" parameterClass="Map" resultClass="Map">
        SELECT
             PSN.FIRST_LINE_ADDR
            ,PSN.SCD_LINE_ADDR
            ,PSN.THIRD_LINE_ADDR
            ,PSN.FRTH_LINE_ADDR
            ,PSN.CTY_ADDR
            ,PSN.CNTY_PK
            ,CNT.CNTY_NM
            ,PSN.PROV_NM
            ,PSN.ST_CD
            ,PSN.POST_CD
            ,PSN.CTRY_CD
            ,PSN.GEO_CD
            ,PSN.DS_INSD_CTY_LIMIT_FLG
        FROM
             ORG_FUNC_ASG   OFA
            ,S21_PSN        PSN
            ,CNTY           CNT
        WHERE
                OFA.GLBL_CMPY_CD    = #glblCmpyCd#
            AND OFA.TOC_CD          = #tocCd#
            AND OFA.EFF_FROM_DT   &lt;= #invDt#
            AND NVL(OFA.EFF_THRU_DT,'99991231')   &gt;= #invDt#
            AND OFA.EZCANCELFLAG    = '0'
            AND OFA.GLBL_CMPY_CD    = PSN.GLBL_CMPY_CD
            AND OFA.PSN_CD          = PSN.PSN_CD
            AND PSN.EZCANCELFLAG    = '0'
            AND PSN.GLBL_CMPY_CD    = CNT.GLBL_CMPY_CD(+)
            AND PSN.CNTY_PK         = CNT.CNTY_PK(+)
            AND CNT.EZCANCELFLAG(+) = '0'
    </statement>

</sqlMap>