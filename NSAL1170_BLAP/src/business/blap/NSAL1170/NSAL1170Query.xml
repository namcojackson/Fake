<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NSAL1170Query">
    <typeAlias alias="NSAL1170_ASMsg"  type="business.blap.NSAL1170.NSAL1170_ASMsg"/>
    <typeAlias alias="NSAL1170_YSMsg"  type="business.blap.NSAL1170.NSAL1170_YSMsg"/>
    <statement id="getSearchData" parameterClass="Map" resultMap="result.getSearchData">
    SELECT
          ROWNUM AS XX_ROW_NUM_T
        , MAIN.XX_ROW_NUM
        , MAIN.XX_ROW_NUM_D
        , MAIN.MTR_REQ_MDL_FLG
        , MAIN.UPLFT_BASE_PRC_UP_RATIO
        , MAIN.EFF_FROM_DT
        , MAIN.EFF_THRU_DT
        , MAIN.DS_MDL_ESCL_RULE_PK
        , MAIN.DS_MDL_ESCL_BLLG_MTR_PK
        , MAIN.BLLG_MTR_LB_CD
        , MAIN.MTR_LB_DESC_TXT
        , MAIN.UPLFT_MTR_PRC_UP_RATIO
        , MAIN.EZUPTIME
        , MAIN.EZUPTIMEZONE
        , MAIN.EZUPTIME_D
        , MAIN.EZUPTIMEZONE_D
        <!-- START 2016/12/02 K.Kojima [QC#14204, ADD] -->
        , MAIN.XX_REC_HIST_CRAT_TS_A
        , MAIN.XX_REC_HIST_CRAT_BY_NM_A
        , MAIN.XX_REC_HIST_UPD_TS_A
        , MAIN.XX_REC_HIST_UPD_BY_NM_A
        , MAIN.XX_REC_HIST_TBL_NM_A
        <!-- END 2016/12/02 K.Kojima [QC#14204, ADD] -->
    FROM (
        SELECT
                  DMER.ROW_NUM                                          AS XX_ROW_NUM
                , NVL(DMEBM.ROW_NUM, 1)                                 AS XX_ROW_NUM_D
                , CASE WHEN DMEBM.ROW_NUM IS NULL THEN 'N' ELSE 'Y' END AS MTR_REQ_MDL_FLG 
                , DMER.UPLFT_BASE_PRC_UP_RATIO
                , DMER.EFF_FROM_DT
                , DMER.EFF_THRU_DT
                , DMER.DS_MDL_ESCL_RULE_PK
                , DMEBM.DS_MDL_ESCL_BLLG_MTR_PK
                , DMEBM.BLLG_MTR_LB_CD
                , ML.MTR_LB_DESC_TXT
                , DMEBM.UPLFT_MTR_PRC_UP_RATIO
                , DMER.EZUPTIME
                , DMER.EZUPTIMEZONE
                , DMEBM.EZUPTIME                                        AS EZUPTIME_D
                , DMEBM.EZUPTIMEZONE                                    AS EZUPTIMEZONE_D
                <!-- START 2016/12/02 K.Kojima [QC#14204, ADD] -->
                , DMER.XX_REC_HIST_CRAT_TS_A
                , DMER.XX_REC_HIST_CRAT_BY_NM_A
                , DMER.XX_REC_HIST_UPD_TS_A
                , DMER.XX_REC_HIST_UPD_BY_NM_A
                , DMER.XX_REC_HIST_TBL_NM_A
                <!-- END 2016/12/02 K.Kojima [QC#14204, ADD] -->
            FROM
                  (
                     SELECT 
                           DMER_SUB.UPLFT_BASE_PRC_UP_RATIO
                         , DMER_SUB.EFF_FROM_DT
                         , DMER_SUB.EFF_THRU_DT
                         , DMER_SUB.DS_MDL_ESCL_RULE_PK
                         , ROW_NUMBER() OVER (
                                                    PARTITION BY 
                                                        DMER_SUB.GLBL_CMPY_CD, 
                                                        DMER_SUB.EZCANCELFLAG, 
                                                        DMER_SUB.MDL_ID 
                                                    ORDER BY 
                                                        DMER_SUB.EFF_FROM_DT DESC
                                              ) AS ROW_NUM
                         , DMER_SUB.EZUPTIME
                         , DMER_SUB.EZUPTIMEZONE
                         <!-- START 2016/12/02 K.Kojima [QC#14204, ADD] -->
                         ,DMER_SUB.EZINTIME    AS XX_REC_HIST_CRAT_TS_A
                         ,DMER_SUB.EZINUSERID  AS XX_REC_HIST_CRAT_BY_NM_A
                         ,DMER_SUB.EZUPTIME    AS XX_REC_HIST_UPD_TS_A
                         ,DMER_SUB.EZUPUSERID  AS XX_REC_HIST_UPD_BY_NM_A
                         ,DMER_SUB.EZTABLEID   AS XX_REC_HIST_TBL_NM_A
                         <!-- END 2016/12/02 K.Kojima [QC#14204, ADD] -->
                     FROM
                           DS_MDL_ESCL_RULE     DMER_SUB
                         WHERE
                         DMER_SUB.GLBL_CMPY_CD         = #glblCmpyCd#
                         AND DMER_SUB.EZCANCELFLAG     = '0' 
                         AND DMER_SUB.MDL_ID           = #mdlId#
                  )                     DMER
                                        
                , (
                     SELECT 
                           DMEBM_SUB.DS_MDL_ESCL_RULE_PK
                         , DMEBM_SUB.DS_MDL_ESCL_BLLG_MTR_PK
                         , DMEBM_SUB.BLLG_MTR_LB_CD
                         , DMEBM_SUB.UPLFT_MTR_PRC_UP_RATIO
                         , ROW_NUMBER() OVER (
                                                    PARTITION BY 
                                                        DMEBM_SUB.GLBL_CMPY_CD, 
                                                        DMEBM_SUB.EZCANCELFLAG, 
                                                        DMEBM_SUB.DS_MDL_ESCL_RULE_PK 
                                                    ORDER BY 
                                                        ML.BLLG_MTR_LVL_NUM
                                                        , DMEBM_SUB.BLLG_MTR_LB_CD ASC
                                              ) AS ROW_NUM
                         , DMEBM_SUB.EZUPTIME
                         , DMEBM_SUB.EZUPTIMEZONE
                     FROM
                           DS_MDL_ESCL_BLLG_MTR     DMEBM_SUB
                           , MTR_LB                 ML
                         WHERE
                         DMEBM_SUB.GLBL_CMPY_CD         = #glblCmpyCd#
                         AND DMEBM_SUB.EZCANCELFLAG     = '0' 
                         AND DMEBM_SUB.GLBL_CMPY_CD     = ML.GLBL_CMPY_CD
                         AND DMEBM_SUB.BLLG_MTR_LB_CD   = ML.MTR_LB_CD
                         AND ML.EZCANCELFLAG            = '0' 
                  )                     DMEBM
                , MTR_LB                ML
            WHERE
                    DMER.DS_MDL_ESCL_RULE_PK        = DMEBM.DS_MDL_ESCL_RULE_PK(+)
                AND DMEBM.BLLG_MTR_LB_CD         = ML.MTR_LB_CD(+)
                AND ML.GLBL_CMPY_CD(+)              = #glblCmpyCd#
                AND ML.EZCANCELFLAG(+)              = '0'
            ORDER BY
                  DMER.EFF_FROM_DT    DESC
                , ML.BLLG_MTR_LVL_NUM ASC
                , DMEBM.BLLG_MTR_LB_CD   ASC
                , DMEBM.ROW_NUM ASC
        ) MAIN
    </statement>

    <resultMap id="result.getSearchData"            class="NSAL1170_ASMsg">
        <result property="xxRowNum_T"               column="XX_ROW_NUM_T"                   javaType="EZDSBigDecimalItem"/>
        <result property="xxRowNum"                 column="XX_ROW_NUM"                     javaType="EZDSBigDecimalItem"/>
        <result property="xxRowNum_D"               column="XX_ROW_NUM_D"                   javaType="EZDSBigDecimalItem"/>
        <result property="mtrReqMdlFlg"             column="MTR_REQ_MDL_FLG"                javaType="EZDSStringItem"/>
        <result property="uplftBasePrcUpRatio"      column="UPLFT_BASE_PRC_UP_RATIO"        javaType="EZDSBigDecimalItem"/>
        <result property="effFromDt"                column="EFF_FROM_DT"                    javaType="EZDSDateItem"/>
        <result property="effThruDt"                column="EFF_THRU_DT"                    javaType="EZDSDateItem"/>
        <result property="dsMdlEsclRulePk"          column="DS_MDL_ESCL_RULE_PK"            javaType="EZDSStringItem"/>
        <result property="dsMdlEsclBllgMtrPk"       column="DS_MDL_ESCL_BLLG_MTR_PK"        javaType="EZDSStringItem"/>
        <result property="bllgMtrLbCd"              column="BLLG_MTR_LB_CD"                 javaType="EZDSStringItem"/>
        <result property="mtrLbDescTxt"             column="MTR_LB_DESC_TXT"                javaType="EZDSStringItem"/>
        <result property="uplftMtrPrcUpRatio"       column="UPLFT_MTR_PRC_UP_RATIO"         javaType="EZDSStringItem"/>
        <result property="ezUpTime"                 column="EZUPTIME"                       javaType="EZDSStringItem"/>
        <result property="ezUpTimeZone"             column="EZUPTIMEZONE"                   javaType="EZDSStringItem"/>
        <result property="ezUpTime_D"               column="EZUPTIME_D"                     javaType="EZDSStringItem"/>
        <result property="ezUpTimeZone_D"           column="EZUPTIMEZONE_D"                 javaType="EZDSStringItem"/>
        <!-- START 2016/12/02 K.Kojima [QC#14204, ADD] -->
        <result property="xxRecHistCratTs_A"           column="XX_REC_HIST_CRAT_TS_A"           javaType="EZDSStringItem"/>
        <result property="xxRecHistCratByNm_A"         column="XX_REC_HIST_CRAT_BY_NM_A"        javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdTs_A"            column="XX_REC_HIST_UPD_TS_A"            javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdByNm_A"          column="XX_REC_HIST_UPD_BY_NM_A"         javaType="EZDSStringItem"/>
        <result property="xxRecHistTblNm_A"            column="XX_REC_HIST_TBL_NM_A"            javaType="EZDSStringItem"/>
        <!-- END 2016/12/02 K.Kojima [QC#14204, ADD] -->
    </resultMap>
    <statement id="getAddRowData" parameterClass="Map" resultMap="result.getAddRowData">
        SELECT
               DISTINCT
               BMM.BLLG_MTR_LB_CD                      AS BLLG_MTR_LB_CD
             , ML.MTR_LB_DESC_TXT                      AS MTR_LB_DESC_TXT
             , DMM.EFF_FROM_DT                         AS EFF_FROM_DT_DM
             , DMM.EFF_THRU_DT                         AS EFF_THRU_DT_DM
             , BMM.EFF_FROM_DT                         AS EFF_FROM_DT_BM
             , BMM.EFF_THRU_DT                         AS EFF_THRU_DT_BM
             , DM.MTR_REQ_MDL_FLG                      AS MTR_REQ_MDL_FLG
             , BMM.BLLG_MTR_MAP_LVL_NUM                AS BLLG_MTR_MAP_LVL_NUM
        FROM
               DS_MDL           DM
             , DS_MDL_MTR       DMM
             , BLLG_MTR_MAP     BMM
             , MTR_LB           ML
        WHERE
                DM.GLBL_CMPY_CD                                = #glblCmpyCd#
            AND DM.EZCANCELFLAG                                = '0'
            AND DM.MDL_ID                                      = #mdlId#
            AND DM.MTR_GRP_PK                                  = DMM.MTR_GRP_PK
            AND DMM.GLBL_CMPY_CD                               = #glblCmpyCd#
            AND DMM.ACTV_FLG                                   = 'Y'
            AND DMM.EZCANCELFLAG                               = '0'
            AND DMM.EFF_FROM_DT                            &lt;=  #slsDt#
            AND NVL(DMM.EFF_THRU_DT , #thruDtLimit#)       &gt;=  #slsDt#
            AND BMM.MDL_MTR_LB_CD                              = DMM.MDL_MTR_LB_CD
            AND BMM.MTR_GRP_PK                                 = DMM.MTR_GRP_PK
            AND BMM.GLBL_CMPY_CD                               = #glblCmpyCd#
            AND BMM.EZCANCELFLAG                               = '0'
            AND BMM.ACTV_FLG                                   = 'Y'
            AND BMM.EFF_FROM_DT                            &lt;=  #slsDt#
            AND NVL(BMM.EFF_THRU_DT, #thruDtLimit#)        &gt;=  #slsDt#
            AND ML.GLBL_CMPY_CD                                = #glblCmpyCd#
            AND ML.EZCANCELFLAG                                = '0'
            AND BMM.BLLG_MTR_LB_CD                             = ML.MTR_LB_CD
        ORDER BY
             BMM.BLLG_MTR_MAP_LVL_NUM ASC
             , BMM.BLLG_MTR_LB_CD ASC

    </statement>
    <resultMap id="result.getAddRowData"     class="NSAL1170_YSMsg">
        <result property="mtrReqMdlFlg_I"       column="MTR_REQ_MDL_FLG"        javaType="EZDSStringItem"/>
        <result	property="bllgMtrLbCd_I"        column="BLLG_MTR_LB_CD"         javaType="EZDCDateItem"/>
        <result	property="mtrLbDescTxt_I"       column="MTR_LB_DESC_TXT"        javaType="EZDSStringItem"/>
        <result property="effFromDt_DM"         column="EFF_FROM_DT_DM"         javaType="EZDSDateItem"/>
        <result property="effThruDt_DM"         column="EFF_THRU_DT_DM"         javaType="EZDSDateItem"/>
        <result property="effFromDt_BM"         column="EFF_FROM_DT_BM"         javaType="EZDSDateItem"/>
        <result property="effThruDt_BM"         column="EFF_THRU_DT_BM"         javaType="EZDSDateItem"/>
    </resultMap>
</sqlMap>
