<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NWAL2190Query">

    <statement id="getHeaderInfoTmplForImport" parameterClass="Map" resultClass="Map">
        SELECT
                 SCT.DS_IMPT_SCHD_TMPL_PK   SCHD_CRAT_TMPL_PK
                ,SCT.SPLY_BASE_AMT
                ,SCT.QTY_CONTR_CAP_QTY
                ,SCT.EZUPTIME
                ,SCT.EZUPTIMEZONE
        FROM
                 DS_IMPT_SCHD_TMPL          SCT
                ,DS_IMPT_SCHD_TMPL_LINE     SCL
        WHERE
                 SCT.GLBL_CMPY_CD               = #glblCmpyCd#
             AND SCT.EZCANCELFLAG               = '0'
             --
             AND SCT.GLBL_CMPY_CD               = SCL.GLBL_CMPY_CD
             AND SCT.DS_IMPT_SCHD_TMPL_PK       = SCL.DS_IMPT_SCHD_TMPL_PK
             AND SCL.DS_IMPT_SVC_CONFIG_REF_PK  = #cpoSvcConfigRefPk#
             AND SCL.EZCANCELFLAG               = '0'
             AND ROWNUM                         = 1
    </statement>

    <statement id="getHeaderInfoPlnForImport" parameterClass="Map" resultClass="Map">
        SELECT
                  SAP.SPLY_AGMT_PLN_PK
                , SAP.SPLY_AGMT_PLN_NM
                , ST.SPLY_AGMT_PLN_SHORT_NM
                , SAP.SPLY_AGMT_PLN_DESC_TXT
                , SAP.SPLY_AGMT_DOC_TP_CD
                , SADT.SPLY_AGMT_DOC_TP_DESC_TXT
                , SAP.SPLY_AGMT_PLN_TP_CD
                , SAPT.SPLY_AGMT_PLN_TP_DESC_TXT
                , SAP.ANN_TERM_CAP_NUM
            FROM
                DS_IMPT_SVC_CONFIG_REF  SCR
                , DS_IMPT_SCHD_TMPL     ST
                , DS_IMPT_SVC_DTL       SD
                , SPLY_AGMT_PLN         SAP
                , SPLY_AGMT_PLN_TP      SAPT
                , SPLY_AGMT_DOC_TP      SADT
                , PRC_LIST_SPLY_PGM     PLSP
                , PRC_LIST_BAND         PLB
            WHERE
                SCR.GLBL_CMPY_CD                    = #glblCmpyCd#
                AND SCR.DS_IMPT_SVC_CONFIG_REF_PK   = #svcConfigRefPk#
                AND SCR.EZCANCELFLAG                = '0'
                --
                AND SCR.GLBL_CMPY_CD                = ST.GLBL_CMPY_CD
                AND SCR.DS_IMPT_SVC_DTL_PK          = ST.DS_IMPT_SVC_DTL_PK
                AND ST.EZCANCELFLAG                 = '0'
                --
                AND ST.GLBL_CMPY_CD                 = SD.GLBL_CMPY_CD
                AND ST.DS_IMPT_SVC_DTL_PK           = SD.DS_IMPT_SVC_DTL_PK
                AND SD.DS_IMPT_SVC_LINE_NUM         = #svcLineNum#
                AND SD.EZCANCELFLAG                 = '0'
                --
                AND ST.GLBL_CMPY_CD                 = SAP.GLBL_CMPY_CD(+)
                AND ST.SPLY_AGMT_PLN_SHORT_NM       = SAP.SPLY_AGMT_PLN_SHORT_NM(+)
                AND SAP.EZCANCELFLAG(+)             = '0'
                --
                AND SAP.GLBL_CMPY_CD                = SAPT.GLBL_CMPY_CD(+)
                AND SAP.SPLY_AGMT_PLN_TP_CD         = SAPT.SPLY_AGMT_PLN_TP_CD(+)
                AND SAPT.EZCANCELFLAG(+)            = '0'
                --
                AND ST.GLBL_CMPY_CD                 = SADT.GLBL_CMPY_CD(+)
                AND ST.SPLY_AGMT_DOC_TP_CD          = SADT.SPLY_AGMT_DOC_TP_CD(+)
                AND SADT.EZCANCELFLAG(+)            = '0'
                --
                AND PLSP.GLBL_CMPY_CD               = SAP.GLBL_CMPY_CD
                AND PLSP.PRC_SVC_PLN_TP_CD          = #prcSvcPlnTpCd#
                AND PLSP.PRC_SVC_CONTR_TP_CD        = #prcSvcContrTpCd#
                AND PLSP.BLLG_MTR_LB_CD             = #bllgMtrLbCd#
                AND PLSP.SPLY_AGMT_PLN_PK           = SAP.SPLY_AGMT_PLN_PK
                AND PLSP.PRC_MTR_PKG_PK             = #prcMtrPkgPk#
                AND PLSP.MDL_ID                     = #mdlId#
                AND PLSP.PRC_CATG_CD                = #prcCatgCd#
                AND PLSP.EFF_FROM_DT               &lt;= #slsDt#
                AND ( 
                    PLSP.EFF_THRU_DT               IS NULL
                    OR PLSP.EFF_THRU_DT            &gt;= #slsDt#
                ) 
                AND PLSP.TERM_FROM_MTH_AOT         &lt;= #termMthNum#
                AND PLSP.TERM_THRU_MTH_AOT         &gt;= #termMthNum#
                AND PLSP.EZCANCELFLAG               = '0'
                --
                AND PLSP.GLBL_CMPY_CD               = PLB.GLBL_CMPY_CD
                AND PLSP.PRC_LIST_BAND_CD           = PLB.PRC_LIST_BAND_CD
                AND PLB.PRC_LIST_BAND_DESC_TXT      = #prcListBandDescTxt#
                AND PLB.EZCANCELFLAG                = '0'
    </statement>

    <statement id="getDetailInfoForImport" parameterClass="Map" resultClass="Map">
        SELECT
                 SCTL.DS_IMPT_SCHD_TMPL_PK  SCHD_CRAT_TMPL_PK
                ,SCTL.SCHD_TMPL_LINE_NUM    SCHD_CRAT_TMPL_LINE_NUM
                ,IST.IMG_SPLY_TP_NM
                ,SCTL.MDSE_CD
                ,M.MNF_ITEM_CD
                ,M.MDSE_DESC_SHORT_TXT
                ,SCTL.SHPG_INTVL_CD
                ,SCTL.SCHD_SHPG_QTY         OTM_SHIP_QTY
                ,SCTL.SCHD_ALLW_QTY         SCHD_ALLW_QTY
                ,SCTL.FIRST_SHIP_QTY        FIRST_SHIP_QTY
                -- Annual Entitlement = Qty * RoundDown(12Months / Frequency Months)
                ,CASE
                   WHEN SI.SHPG_INTVL_MTH_NUM IS NOT NULL AND SI.SHPG_INTVL_MTH_NUM != 0
                     THEN SCTL.SCHD_SHPG_QTY * (TRUNC(#numberOfMonths# / SI.SHPG_INTVL_MTH_NUM))
                   ELSE NULL
                 END                        ANN_ETTL_CNT
                <!-- 2018/08/07 S21_NA#27491 Mod Start -->
                <!--  Term Total Entitlement = (Term Total Entitlement) * RoundDown(Term Months Number / 12Months) -->
                <!-- ,CASE  -->
                <!--    WHEN SI.SHPG_INTVL_MTH_NUM IS NOT NULL AND SI.SHPG_INTVL_MTH_NUM != 0 -->
                <!--      THEN (SCTL.SCHD_SHPG_QTY * (TRUNC(#numberOfMonths# / SI.SHPG_INTVL_MTH_NUM))) * (TRUNC(#termMthNum# / #numberOfMonths#)) -->
                <!--    ELSE NULL -->
                <!--  END                        TERM_TOT_ETTL_CNT -->
                ,SCTL.SCHD_ALLW_QTY         TERM_TOT_ETTL_CNT
                <!-- 2018/08/07 S21_NA#27491 Mod End -->
                ,SCTL.EZUPTIME
                ,SCTL.EZUPTIMEZONE
        FROM
                  DS_IMPT_SCHD_TMPL_LINE    SCTL
                , DS_IMPT_SCHD_TMPL         SCT
                , SHPG_INTVL                SI
                , ALL_MDSE_V                M
                , IMG_SPLY_TP               IST
        WHERE
                 SCTL.GLBL_CMPY_CD              = #glblCmpyCd#
             AND SCTL.DS_IMPT_SVC_CONFIG_REF_PK = #cpoSvcConfigRefPk#
             AND SCTL.EZCANCELFLAG              = '0'
            --
             AND SCTL.GLBL_CMPY_CD              = SCT.GLBL_CMPY_CD
             AND SCTL.DS_IMPT_SCHD_TMPL_PK      = SCT.DS_IMPT_SCHD_TMPL_PK
             AND SCT.DS_IMPT_SCHD_TMPL_PK       = #schdCratTmplPk#
             AND SCT.EZCANCELFLAG               = '0'
            --
             AND SCTL.GLBL_CMPY_CD              = SI.GLBL_CMPY_CD(+)
             AND SCTL.SHPG_INTVL_CD             = SI.SHPG_INTVL_CD(+)
             AND SI.EZCANCELFLAG(+)             = '0'
            --
             AND SCTL.GLBL_CMPY_CD              = M.GLBL_CMPY_CD(+)
             AND SCTL.MDSE_CD                   = M.MDSE_CD(+)
             AND M.EZCANCELFLAG(+)              = '0'
            --
             AND M.GLBL_CMPY_CD                 = IST.GLBL_CMPY_CD(+)
             AND M.IMG_SPLY_TP_CD               = IST.IMG_SPLY_TP_CD(+)
             AND IST.EZCANCELFLAG(+)            = '0'
        ORDER BY
            SCTL.DS_IMPT_SCHD_TMPL_PK
           ,SCTL.SCHD_TMPL_LINE_NUM
    </statement>

</sqlMap>
