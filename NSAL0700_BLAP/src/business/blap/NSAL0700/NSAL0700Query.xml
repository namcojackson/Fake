<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSAL0700Query">
    <typeAlias alias="NSAL0700_ASMsg" type="business.blap.NSAL0700.NSAL0700_ASMsg"/>

    <statement id="getContrInfo" parameterClass="Map" resultMap="result.getContrInfo">
        WITH CONTR_REG AS (
            SELECT
                 DS_CONTR_PK
                ,DS_CONTR_DTL_PK
                ,DS_CONTR_BLLG_MTR_PK
                ,DS_CONTR_DTL_TP_CD
                ,DS_CONTR_CATG_CD
                ,XX_SCR_ITEM_34_TXT
                ,SER_NUM
                ,MTR_LB_DESC_TXT
                ,DS_CONTR_CTRL_STS_CD
                ,DS_CONTR_CTRL_STS_NM
                ,CONTR_VRSN_EFF_FROM_DT
                ,CONTR_VRSN_EFF_THRU_DT
                ,BASE_PRC_DEAL_AMT
                ,BLLG_CYCLE_UOM_NM
                ,NEXT_BLLG_DT
                ,BLLG_HLD_FLG_A1
                ,BLLG_HLD_FLG_A2
                ,BLLG_HLD_FLG_A3
                ,XX_REF_CSE_NUM
                ,MTR_LB_SORT_NUM
                ,EZUPTIME_DCH
                ,EZUPTIMEZONE_DCH
                ,EZUPTIME_DCD
                ,EZUPTIMEZONE_DCD
                ,EZUPTIME_CBM
                ,EZUPTIMEZONE_CBM
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                ,XX_REC_HIST_CRAT_TS
                ,XX_REC_HIST_CRAT_BY_NM
                ,XX_REC_HIST_UPD_TS
                ,XX_REC_HIST_UPD_BY_NM
                ,XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
            FROM
                (
                    SELECT
                         DCH.DS_CONTR_PK            AS DS_CONTR_PK
                        ,0                          AS DS_CONTR_DTL_PK
                        ,0                          AS DS_CONTR_BLLG_MTR_PK
                        ,NULL                       AS DS_CONTR_DTL_TP_CD
                        ,DCH.DS_CONTR_CATG_CD       AS DS_CONTR_CATG_CD
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        <!-- ,TRIM(DCH.DS_CONTR_CATG_CD || '-' || DCH.DS_CONTR_NUM) -->
                        ,TRIM(DCC.DS_CONTR_CATG_ABBR_NM || '-' || DCH.DS_CONTR_NUM)
                        <!-- END 2017/09/04 K.Kojima [QC#20816, MOD] -->
                                                    AS XX_SCR_ITEM_34_TXT
                        ,NULL                       AS SER_NUM
                        ,NULL                       AS MTR_LB_DESC_TXT
                        ,HSV.DS_CONTR_CTRL_STS_CD   AS DS_CONTR_CTRL_STS_CD
                        ,HSV.DS_CONTR_CTRL_STS_NM   AS DS_CONTR_CTRL_STS_NM
                        ,DCH.CONTR_VRSN_EFF_FROM_DT AS CONTR_VRSN_EFF_FROM_DT
                        ,DCH.CONTR_VRSN_EFF_THRU_DT AS CONTR_VRSN_EFF_THRU_DT
                        ,NULL                       AS BASE_PRC_DEAL_AMT
                        ,NULL                       AS BLLG_CYCLE_UOM_NM
                        ,NULL                       AS NEXT_BLLG_DT
                        ,DCH.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A1
                        ,'N'                        AS BLLG_HLD_FLG_A2
                        ,'N'                        AS BLLG_HLD_FLG_A3
                        ,#lvlNum10#                 AS XX_REF_CSE_NUM
                        ,NULL                       AS MTR_LB_SORT_NUM
                        ,DCH.EZUPTIME               AS EZUPTIME_DCH
                        ,DCH.EZUPTIMEZONE           AS EZUPTIMEZONE_DCH
                        ,null                       AS EZUPTIME_DCD
                        ,null                       AS EZUPTIMEZONE_DCD
                        ,null                       AS EZUPTIME_CBM
                        ,null                       AS EZUPTIMEZONE_CBM
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                        ,DCH.EZINTIME               AS XX_REC_HIST_CRAT_TS
                        ,DCH.EZINUSERID             AS XX_REC_HIST_CRAT_BY_NM
                        ,DCH.EZUPTIME               AS XX_REC_HIST_UPD_TS
                        ,DCH.EZUPUSERID             AS XX_REC_HIST_UPD_BY_NM
                        ,DCH.EZTABLEID              AS XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
                    FROM
                         DS_CONTR       DCH
                        ,DS_CONTR_STS_V HSV
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        ,DS_CONTR_CATG  DCC
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    WHERE
                            DCH.GLBL_CMPY_CD     = #glblCmpyCd#
                        <iterate property="dsContrPkList" var="dsContrPk[]" open="AND DCH.DS_CONTR_PK IN (" close=")" conjunction=",">
                            #dsContrPk[]#
                        </iterate>
                        AND DCH.DS_CONTR_CATG_CD = #dsContrCatgCdReg#
                        AND DCH.EZCANCELFLAG     = '0'
                        AND DCH.GLBL_CMPY_CD     = HSV.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_PK      = HSV.DS_CONTR_PK
                        AND HSV.EZCANCELFLAG     = '0'
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        AND DCH.GLBL_CMPY_CD     = DCC.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_CATG_CD = DCC.DS_CONTR_CATG_CD
                        AND DCC.EZCANCELFLAG     = '0'
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    UNION ALL
                    SELECT
                         DCH.DS_CONTR_PK            AS DS_CONTR_PK
                        ,DCD.DS_CONTR_DTL_PK        AS DS_CONTR_DTL_PK
                        ,0                          AS DS_CONTR_BLLG_MTR_PK
                        ,DCD.DS_CONTR_DTL_TP_CD     AS DS_CONTR_DTL_TP_CD
                        ,DCH.DS_CONTR_CATG_CD       AS DS_CONTR_CATG_CD
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        <!-- ,TRIM(DCH.DS_CONTR_CATG_CD || '-' || DCH.DS_CONTR_NUM) -->
                        ,TRIM(DCC.DS_CONTR_CATG_ABBR_NM || '-' || DCH.DS_CONTR_NUM)
                        <!-- END 2017/09/04 K.Kojima [QC#20816, MOD] -->
                                                    AS XX_SCR_ITEM_34_TXT
                        ,SMM.SER_NUM                AS SER_NUM
                        ,NULL                       AS MTR_LB_DESC_TXT
                        ,DSV.DS_CONTR_CTRL_STS_CD   AS DS_CONTR_CTRL_STS_CD
                        ,DSV.DS_CONTR_CTRL_STS_NM   AS DS_CONTR_CTRL_STS_NM
                        ,DCD.CONTR_EFF_FROM_DT      AS CONTR_VRSN_EFF_FROM_DT
                        ,DCD.CONTR_EFF_THRU_DT      AS CONTR_VRSN_EFF_THRU_DT
                        ,NULL                       AS BASE_PRC_DEAL_AMT
                        ,NULL                       AS BLLG_CYCLE_UOM_NM
                        ,NULL                       AS NEXT_BLLG_DT
                        ,DCH.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A1
                        ,DCD.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A2
                        ,'N'                        AS BLLG_HLD_FLG_A3
                        ,#lvlNum20#                 AS XX_REF_CSE_NUM
                        ,NULL                       AS MTR_LB_SORT_NUM
                        ,DCH.EZUPTIME               AS EZUPTIME_DCH
                        ,DCH.EZUPTIMEZONE           AS EZUPTIMEZONE_DCH
                        ,DCD.EZUPTIME               AS EZUPTIME_DCD
                        ,DCD.EZUPTIMEZONE           AS EZUPTIMEZONE_DCD
                        ,null                       AS EZUPTIME_CBM
                        ,null                       AS EZUPTIMEZONE_CBM
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                        ,DCD.EZINTIME               AS XX_REC_HIST_CRAT_TS
                        ,DCD.EZINUSERID             AS XX_REC_HIST_CRAT_BY_NM
                        ,DCD.EZUPTIME               AS XX_REC_HIST_UPD_TS
                        ,DCD.EZUPUSERID             AS XX_REC_HIST_UPD_BY_NM
                        ,DCD.EZTABLEID              AS XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
                    FROM
                         DS_CONTR           DCH
                        ,DS_CONTR_DTL       DCD
                        ,DS_CONTR_DTL_STS_V DSV
                        ,SVC_MACH_MSTR      SMM
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        ,DS_CONTR_CATG  DCC
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    WHERE
                            DCH.GLBL_CMPY_CD       = #glblCmpyCd#
                        <iterate property="dsContrPkList" var="dsContrPk[]" open="AND DCH.DS_CONTR_PK IN (" close=")" conjunction=",">
                            #dsContrPk[]#
                        </iterate>
                        AND DCH.DS_CONTR_CATG_CD   = #dsContrCatgCdReg#
                        AND DCH.EZCANCELFLAG       = '0'
                        AND DCH.GLBL_CMPY_CD       = DCD.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_PK        = DCD.DS_CONTR_PK
                        AND DCD.EZCANCELFLAG       = '0'
                        AND DCD.GLBL_CMPY_CD       = DSV.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_PK        = DSV.DS_CONTR_PK
                        AND DCD.DS_CONTR_DTL_PK    = DSV.DS_CONTR_DTL_PK
                        <iterate property="dsContrDtlPkList" var="dsContrDtlPk[]" open="AND DCD.DS_CONTR_DTL_PK IN (" close=")" conjunction=",">
                            #dsContrDtlPk[]#
                        </iterate>
                        AND DSV.EZCANCELFLAG       = '0'
                        AND DCD.GLBL_CMPY_CD       = SMM.GLBL_CMPY_CD
                        AND DCD.SVC_MACH_MSTR_PK   = SMM.SVC_MACH_MSTR_PK
                        AND SMM.EZCANCELFLAG       = '0'
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        AND DCH.GLBL_CMPY_CD       = DCC.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_CATG_CD   = DCC.DS_CONTR_CATG_CD
                        AND DCC.EZCANCELFLAG       = '0'
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    UNION ALL
                    SELECT
                         DCH.DS_CONTR_PK            AS DS_CONTR_PK
                        ,DCD.DS_CONTR_DTL_PK        AS DS_CONTR_DTL_PK
                        ,0                          AS DS_CONTR_BLLG_MTR_PK
                        ,DCD.DS_CONTR_DTL_TP_CD     AS DS_CONTR_DTL_TP_CD
                        ,DCH.DS_CONTR_CATG_CD       AS DS_CONTR_CATG_CD
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        <!-- ,TRIM(DCH.DS_CONTR_CATG_CD || '-' || DCH.DS_CONTR_NUM) -->
                        ,TRIM(DCC.DS_CONTR_CATG_ABBR_NM || '-' || DCH.DS_CONTR_NUM)
                        <!-- END 2017/09/04 K.Kojima [QC#20816, MOD] -->
                                                    AS XX_SCR_ITEM_34_TXT
                        ,SMM.SER_NUM                AS SER_NUM
                        ,#mtrLbNm#                  AS MTR_LB_DESC_TXT
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        <!-- ,DSV.DS_CONTR_CTRL_STS_CD   AS DS_CONTR_CTRL_STS_CD -->
                        <!-- ,DSV.DS_CONTR_CTRL_STS_NM   AS DS_CONTR_CTRL_STS_NM -->
                        ,(
                            SELECT
                                DS_CONTR_CTRL_STS_CD
                            FROM
                                (
                                    SELECT
                                         PEV.DS_CONTR_CTRL_STS_CD AS DS_CONTR_CTRL_STS_CD
                                        ,1                        AS SORT_KEY1
                                        ,0                        AS SORT_KEY2
                                    FROM
                                         DS_CONTR_PRC_EFF       PEF
                                        ,DS_CONTR_PRC_EFF_STS_V PEV
                                    WHERE
                                            PEF.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_DTL_PK           = DCD.DS_CONTR_DTL_PK
                                        AND PEF.CONTR_PRC_EFF_FROM_DT &lt;= #slsDt#
                                        AND PEF.CONTR_PRC_EFF_THRU_DT &gt;= #slsDt#
                                        AND PEF.BASE_CHRG_FLG             = 'Y'
                                        AND PEF.EZCANCELFLAG              = '0'
                                        AND PEF.GLBL_CMPY_CD              = PEV.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_PRC_EFF_PK       = PEV.DS_CONTR_PRC_EFF_PK
                                        AND PEV.EZCANCELFLAG              = '0'
                                    UNION
                                    SELECT
                                         PEV.DS_CONTR_CTRL_STS_CD AS DS_CONTR_CTRL_STS_CD
                                        ,2                        AS SORT_KEY1
                                        ,(TO_DATE(PEF.CONTR_PRC_EFF_FROM_DT, 'YYYYMMDD') - TO_DATE(#slsDt#, 'YYYYMMDD')) AS SORT_KEY2
                                    FROM
                                         DS_CONTR_PRC_EFF       PEF
                                        ,DS_CONTR_PRC_EFF_STS_V PEV
                                    WHERE
                                            PEF.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_DTL_PK           = DCD.DS_CONTR_DTL_PK
                                        AND PEF.CONTR_PRC_EFF_FROM_DT  &gt; #slsDt#
                                        AND PEF.BASE_CHRG_FLG             = 'Y'
                                        AND PEF.EZCANCELFLAG              = '0'
                                        AND PEF.GLBL_CMPY_CD              = PEV.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_PRC_EFF_PK       = PEV.DS_CONTR_PRC_EFF_PK
                                        AND PEV.EZCANCELFLAG              = '0'
                                    UNION
                                    SELECT
                                         PEV.DS_CONTR_CTRL_STS_CD AS DS_CONTR_CTRL_STS_CD
                                        ,3                        AS SORT_KEY1
                                        ,(TO_DATE(#slsDt#, 'YYYYMMDD') - TO_DATE(PEF.CONTR_PRC_EFF_THRU_DT, 'YYYYMMDD')) AS SORT_KEY2
                                    FROM
                                         DS_CONTR_PRC_EFF       PEF
                                        ,DS_CONTR_PRC_EFF_STS_V PEV
                                    WHERE
                                            PEF.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_DTL_PK           = DCD.DS_CONTR_DTL_PK
                                        AND PEF.CONTR_PRC_EFF_THRU_DT  &lt; #slsDt#
                                        AND PEF.BASE_CHRG_FLG             = 'Y'
                                        AND PEF.EZCANCELFLAG              = '0'
                                        AND PEF.GLBL_CMPY_CD              = PEV.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_PRC_EFF_PK       = PEV.DS_CONTR_PRC_EFF_PK
                                        AND PEV.EZCANCELFLAG              = '0'
                                    ORDER BY
                                         SORT_KEY1                    ASC
                                        ,SORT_KEY2                    ASC
                                        ,DS_CONTR_CTRL_STS_CD         ASC
                                )
                            WHERE
                                ROWNUM = 1
                         )                          AS DS_CONTR_CTRL_STS_CD
                        ,(
                            SELECT
                                DS_CONTR_CTRL_STS_NM
                            FROM
                                (
                                    SELECT
                                         PEV.DS_CONTR_CTRL_STS_CD AS DS_CONTR_CTRL_STS_CD
                                        ,PEV.DS_CONTR_CTRL_STS_NM AS DS_CONTR_CTRL_STS_NM
                                        ,1                        AS SORT_KEY1
                                        ,0                        AS SORT_KEY2
                                    FROM
                                         DS_CONTR_PRC_EFF       PEF
                                        ,DS_CONTR_PRC_EFF_STS_V PEV
                                    WHERE
                                            PEF.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_DTL_PK           = DCD.DS_CONTR_DTL_PK
                                        AND PEF.CONTR_PRC_EFF_FROM_DT &lt;= #slsDt#
                                        AND PEF.CONTR_PRC_EFF_THRU_DT &gt;= #slsDt#
                                        AND PEF.BASE_CHRG_FLG             = 'Y'
                                        AND PEF.EZCANCELFLAG              = '0'
                                        AND PEF.GLBL_CMPY_CD              = PEV.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_PRC_EFF_PK       = PEV.DS_CONTR_PRC_EFF_PK
                                        AND PEV.EZCANCELFLAG              = '0'
                                    UNION
                                    SELECT
                                         PEV.DS_CONTR_CTRL_STS_CD AS DS_CONTR_CTRL_STS_CD
                                        ,PEV.DS_CONTR_CTRL_STS_NM AS DS_CONTR_CTRL_STS_NM
                                        ,2                        AS SORT_KEY1
                                        ,(TO_DATE(PEF.CONTR_PRC_EFF_FROM_DT, 'YYYYMMDD') - TO_DATE(#slsDt#, 'YYYYMMDD')) AS SORT_KEY2
                                    FROM
                                         DS_CONTR_PRC_EFF       PEF
                                        ,DS_CONTR_PRC_EFF_STS_V PEV
                                    WHERE
                                            PEF.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_DTL_PK           = DCD.DS_CONTR_DTL_PK
                                        AND PEF.CONTR_PRC_EFF_FROM_DT  &gt; #slsDt#
                                        AND PEF.BASE_CHRG_FLG             = 'Y'
                                        AND PEF.EZCANCELFLAG              = '0'
                                        AND PEF.GLBL_CMPY_CD              = PEV.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_PRC_EFF_PK       = PEV.DS_CONTR_PRC_EFF_PK
                                        AND PEV.EZCANCELFLAG              = '0'
                                    UNION
                                    SELECT
                                         PEV.DS_CONTR_CTRL_STS_CD AS DS_CONTR_CTRL_STS_CD
                                        ,PEV.DS_CONTR_CTRL_STS_NM AS DS_CONTR_CTRL_STS_NM
                                        ,3                        AS SORT_KEY1
                                        ,(TO_DATE(#slsDt#, 'YYYYMMDD') - TO_DATE(PEF.CONTR_PRC_EFF_THRU_DT, 'YYYYMMDD')) AS SORT_KEY2
                                    FROM
                                         DS_CONTR_PRC_EFF       PEF
                                        ,DS_CONTR_PRC_EFF_STS_V PEV
                                    WHERE
                                            PEF.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_DTL_PK           = DCD.DS_CONTR_DTL_PK
                                        AND PEF.CONTR_PRC_EFF_THRU_DT  &lt; #slsDt#
                                        AND PEF.BASE_CHRG_FLG             = 'Y'
                                        AND PEF.EZCANCELFLAG              = '0'
                                        AND PEF.GLBL_CMPY_CD              = PEV.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_PRC_EFF_PK       = PEV.DS_CONTR_PRC_EFF_PK
                                        AND PEV.EZCANCELFLAG              = '0'
                                    ORDER BY
                                         SORT_KEY1                    ASC
                                        ,SORT_KEY2                    ASC
                                        ,DS_CONTR_CTRL_STS_CD         ASC
                                )
                            WHERE
                                ROWNUM = 1
                         )                          AS DS_CONTR_CTRL_STS_CD
                        <!-- END 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        ,NULL                       AS CONTR_VRSN_EFF_FROM_DT
                        ,NULL                       AS CONTR_VRSN_EFF_THRU_DT
                        ,DCD.BASE_PRC_DEAL_AMT      AS BASE_PRC_DEAL_AMT
                        ,BCU.BLLG_CYCLE_UOM_NM      AS BLLG_CYCLE_UOM_NM
                        ,(
                            SELECT
                                 MIN(CBS.NEXT_BLLG_DT)
                            FROM
                                 DS_CONTR_BLLG_SCHD CBS
                            WHERE
                                    CBS.GLBL_CMPY_CD    = DCD.GLBL_CMPY_CD
                                AND CBS.DS_CONTR_DTL_PK = DCD.DS_CONTR_DTL_PK
                                AND CBS.INV_DT          IS NULL
                                AND CBS.BASE_CHRG_FLG   = 'Y'
                                AND CBS.EZCANCELFLAG    = '0'
                         )                          AS NEXT_BLLG_DT
                        ,DCH.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A1
                        ,DCD.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A2
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        <!-- ,'N'                        AS BLLG_HLD_FLG_A3 -->
                        ,(
                            CASE
                                WHEN
                                    EXISTS
                                        (
                                            SELECT
                                                1
                                            FROM
                                                 DS_CONTR_PRC_EFF PEF
                                            WHERE
                                                PEF.GLBL_CMPY_CD          = DCD.GLBL_CMPY_CD
                                            AND PEF.DS_CONTR_DTL_PK       = DCD.DS_CONTR_DTL_PK
                                            AND PEF.BLLG_HLD_FLG          = 'Y'
                                            AND PEF.BASE_CHRG_FLG         = 'Y'
                                            AND PEF.EZCANCELFLAG          = '0'
                                        )
                                THEN
                                    'Y'
                                ELSE
                                    'N'
                                END
                         ) AS BLLG_HLD_FLG_A3
                        <!-- END 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        ,#lvlNum30#                 AS XX_REF_CSE_NUM
                        ,NULL                       AS MTR_LB_SORT_NUM
                        ,DCH.EZUPTIME               AS EZUPTIME_DCH
                        ,DCH.EZUPTIMEZONE           AS EZUPTIMEZONE_DCH
                        ,DCD.EZUPTIME               AS EZUPTIME_DCD
                        ,DCD.EZUPTIMEZONE           AS EZUPTIMEZONE_DCD
                        ,null                       AS EZUPTIME_CBM
                        ,null                       AS EZUPTIMEZONE_CBM
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                        ,DCD.EZINTIME               AS XX_REC_HIST_CRAT_TS
                        ,DCD.EZINUSERID             AS XX_REC_HIST_CRAT_BY_NM
                        ,DCD.EZUPTIME               AS XX_REC_HIST_UPD_TS
                        ,DCD.EZUPUSERID             AS XX_REC_HIST_UPD_BY_NM
                        ,DCD.EZTABLEID              AS XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
                    FROM
                         DS_CONTR                DCH
                        ,DS_CONTR_DTL            DCD
                        ,DS_CONTR_DTL_TP         DTP
                        ,DS_CONTR_DTL_STS_V      DSV
                        ,BLLG_CYCLE_UOM          BCU
                        ,SVC_MACH_MSTR           SMM
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        ,DS_CONTR_CATG  DCC
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    WHERE
                            DCH.GLBL_CMPY_CD       = #glblCmpyCd#
                        <iterate property="dsContrPkList" var="dsContrPk[]" open="AND DCH.DS_CONTR_PK IN (" close=")" conjunction=",">
                            #dsContrPk[]#
                        </iterate>
                        AND DCH.DS_CONTR_CATG_CD   = #dsContrCatgCdReg#
                        AND DCH.EZCANCELFLAG       = '0'
                        AND DCH.GLBL_CMPY_CD       = DCD.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_PK        = DCD.DS_CONTR_PK
                        <iterate property="dsContrDtlPkList" var="dsContrDtlPk[]" open="AND DCD.DS_CONTR_DTL_PK IN (" close=")" conjunction=",">
                            #dsContrDtlPk[]#
                        </iterate>
                        AND DCD.EZCANCELFLAG       = '0'
                        AND DCD.GLBL_CMPY_CD       = DTP.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_DTL_TP_CD = DTP.DS_CONTR_DTL_TP_CD
                        AND DTP.BASE_CHRG_FLG      = 'Y'
                        AND DTP.EZCANCELFLAG       = '0'
                        AND DCD.GLBL_CMPY_CD       = DSV.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_PK        = DSV.DS_CONTR_PK
                        AND DCD.DS_CONTR_DTL_PK    = DSV.DS_CONTR_DTL_PK
                        AND DSV.EZCANCELFLAG       = '0'
                        AND DCD.GLBL_CMPY_CD       = BCU.GLBL_CMPY_CD
                        AND DCD.BASE_BLLG_CYCLE_CD = BCU.BLLG_CYCLE_UOM_CD
                        AND BCU.EZCANCELFLAG       = '0'
                        AND DCD.GLBL_CMPY_CD       = SMM.GLBL_CMPY_CD
                        AND DCD.SVC_MACH_MSTR_PK   = SMM.SVC_MACH_MSTR_PK
                        AND SMM.EZCANCELFLAG       = '0'
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        AND DCH.GLBL_CMPY_CD       = DCC.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_CATG_CD   = DCC.DS_CONTR_CATG_CD
                        AND DCC.EZCANCELFLAG       = '0'
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    UNION ALL
                    SELECT
                         DCH.DS_CONTR_PK            AS DS_CONTR_PK
                        ,DCD.DS_CONTR_DTL_PK        AS DS_CONTR_DTL_PK
                        ,CBM.DS_CONTR_BLLG_MTR_PK   AS DS_CONTR_BLLG_MTR_PK
                        ,DCD.DS_CONTR_DTL_TP_CD     AS DS_CONTR_DTL_TP_CD
                        ,DCH.DS_CONTR_CATG_CD       AS DS_CONTR_CATG_CD
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        <!-- ,TRIM(DCH.DS_CONTR_CATG_CD || '-' || DCH.DS_CONTR_NUM) -->
                        ,TRIM(DCC.DS_CONTR_CATG_ABBR_NM || '-' || DCH.DS_CONTR_NUM)
                        <!-- END 2017/09/04 K.Kojima [QC#20816, MOD] -->
                                                    AS XX_SCR_ITEM_34_TXT
                        ,SMM.SER_NUM                AS SER_NUM
                        ,MLB.MTR_LB_DESC_TXT        AS MTR_LB_DESC_TXT
                        ,MSV.DS_CONTR_CTRL_STS_CD   AS DS_CONTR_CTRL_STS_CD
                        ,MSV.DS_CONTR_CTRL_STS_NM   AS DS_CONTR_CTRL_STS_NM
                        ,NULL                       AS CONTR_VRSN_EFF_FROM_DT
                        ,NULL                       AS CONTR_VRSN_EFF_THRU_DT
                        ,NULL                       AS BASE_PRC_DEAL_AMT
                        ,BCU.BLLG_CYCLE_UOM_NM      AS BLLG_CYCLE_UOM_NM
                        ,(
                            SELECT
                                 MIN(CBS.NEXT_BLLG_DT)
                            FROM
                                 DS_CONTR_BLLG_SCHD CBS
                            WHERE
                                    CBS.GLBL_CMPY_CD         = DCD.GLBL_CMPY_CD
                                AND CBS.DS_CONTR_DTL_PK      = DCD.DS_CONTR_DTL_PK
                                AND CBS.GLBL_CMPY_CD         = CBM.GLBL_CMPY_CD
                                AND CBS.DS_CONTR_BLLG_MTR_PK = CBM.DS_CONTR_BLLG_MTR_PK
                                AND CBS.INV_DT               IS NULL
                                AND CBS.USG_CHRG_FLG         = 'Y'
                                AND CBS.EZCANCELFLAG         = '0'
                         )                          AS NEXT_BLLG_DT
                        ,DCH.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A1
                        ,DCD.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A2
                        ,CBM.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A3
                        ,#lvlNum30#                 AS XX_REF_CSE_NUM
                        ,MLB.MTR_LB_SORT_NUM        AS MTR_LB_SORT_NU
                        ,DCH.EZUPTIME               AS EZUPTIME_DCH
                        ,DCH.EZUPTIMEZONE           AS EZUPTIMEZONE_DCH
                        ,DCD.EZUPTIME               AS EZUPTIME_DCD
                        ,DCD.EZUPTIMEZONE           AS EZUPTIMEZONE_DCD
                        ,CBM.EZUPTIME               AS EZUPTIME_CBM
                        ,CBM.EZUPTIMEZONE           AS EZUPTIMEZONE_CBM
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                        ,CBM.EZINTIME               AS XX_REC_HIST_CRAT_TS
                        ,CBM.EZINUSERID             AS XX_REC_HIST_CRAT_BY_NM
                        ,CBM.EZUPTIME               AS XX_REC_HIST_UPD_TS
                        ,CBM.EZUPUSERID             AS XX_REC_HIST_UPD_BY_NM
                        ,CBM.EZTABLEID              AS XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
                    FROM
                         DS_CONTR                DCH
                        ,DS_CONTR_DTL            DCD
                        ,DS_CONTR_DTL_TP         DTP
                        ,DS_CONTR_BLLG_MTR       CBM
                        ,MTR_LB                  MLB
                        ,DS_CONTR_BLLG_MTR_STS_V MSV
                        ,BLLG_CYCLE_UOM          BCU
                        ,SVC_MACH_MSTR           SMM
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        ,DS_CONTR_CATG  DCC
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    WHERE
                            DCH.GLBL_CMPY_CD         = #glblCmpyCd#
                        <iterate property="dsContrPkList" var="dsContrPk[]" open="AND DCH.DS_CONTR_PK IN (" close=")" conjunction=",">
                            #dsContrPk[]#
                        </iterate>
                        AND DCH.DS_CONTR_CATG_CD     = #dsContrCatgCdReg#
                        AND DCH.EZCANCELFLAG         = '0'
                        AND DCH.GLBL_CMPY_CD         = DCD.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_PK          = DCD.DS_CONTR_PK
                        <iterate property="dsContrDtlPkList" var="dsContrDtlPk[]" open="AND DCD.DS_CONTR_DTL_PK IN (" close=")" conjunction=",">
                            #dsContrDtlPk[]#
                        </iterate>
                        AND DCD.EZCANCELFLAG         = '0'
                        AND DCD.GLBL_CMPY_CD         = DTP.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_DTL_TP_CD   = DTP.DS_CONTR_DTL_TP_CD
                        AND DTP.USG_CHRG_FLG         = 'Y'
                        AND DTP.EZCANCELFLAG         = '0'
                        AND DCD.GLBL_CMPY_CD         = CBM.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_DTL_PK      = CBM.DS_CONTR_DTL_PK
                        AND CBM.EZCANCELFLAG         = '0'
                        AND CBM.GLBL_CMPY_CD         = MLB.GLBL_CMPY_CD
                        AND CBM.BLLG_MTR_LB_CD       = MLB.MTR_LB_CD
                        AND MLB.EZCANCELFLAG         = '0'
                        AND CBM.GLBL_CMPY_CD         = MSV.GLBL_CMPY_CD
                        AND CBM.DS_CONTR_DTL_PK      = MSV.DS_CONTR_DTL_PK
                        AND CBM.DS_CONTR_BLLG_MTR_PK = MSV.DS_CONTR_BLLG_MTR_PK
                        AND MSV.EZCANCELFLAG         = '0'
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        <!-- AND DCD.GLBL_CMPY_CD         = BCU.GLBL_CMPY_CD -->
                        <!-- AND DCD.MTR_BLLG_CYCLE_CD    = BCU.BLLG_CYCLE_UOM_CD -->
                        AND CBM.GLBL_CMPY_CD           = BCU.GLBL_CMPY_CD
                        AND CBM.BLLG_MTR_BLLG_CYCLE_CD = BCU.BLLG_CYCLE_UOM_CD
                        <!-- END 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        AND BCU.EZCANCELFLAG         = '0'
                        AND DCD.GLBL_CMPY_CD         = SMM.GLBL_CMPY_CD
                        AND DCD.SVC_MACH_MSTR_PK     = SMM.SVC_MACH_MSTR_PK
                        AND SMM.EZCANCELFLAG         = '0'
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        AND DCH.GLBL_CMPY_CD         = DCC.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_CATG_CD     = DCC.DS_CONTR_CATG_CD
                        AND DCC.EZCANCELFLAG         = '0'
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    ORDER BY
                         XX_SCR_ITEM_34_TXT
                        ,SER_NUM            NULLS FIRST
                        ,MTR_LB_SORT_NUM    NULLS FIRST
                        ,MTR_LB_DESC_TXT    NULLS FIRST
                )
        )
        ,CONTR_FLT AS (
            SELECT
                 DS_CONTR_PK
                ,DS_CONTR_DTL_PK
                ,DS_CONTR_BLLG_MTR_PK
                ,DS_CONTR_DTL_TP_CD
                ,DS_CONTR_CATG_CD
                ,XX_SCR_ITEM_34_TXT
                ,SER_NUM
                ,MTR_LB_DESC_TXT
                ,DS_CONTR_CTRL_STS_CD
                ,DS_CONTR_CTRL_STS_NM
                ,CONTR_VRSN_EFF_FROM_DT
                ,CONTR_VRSN_EFF_THRU_DT
                ,BASE_PRC_DEAL_AMT
                ,BLLG_CYCLE_UOM_NM
                ,NEXT_BLLG_DT
                ,BLLG_HLD_FLG_A1
                ,BLLG_HLD_FLG_A2
                ,BLLG_HLD_FLG_A3
                ,XX_REF_CSE_NUM
                ,MTR_LB_SORT_NUM
                ,EZUPTIME_DCH
                ,EZUPTIMEZONE_DCH
                ,EZUPTIME_DCD
                ,EZUPTIMEZONE_DCD
                ,EZUPTIME_CBM
                ,EZUPTIMEZONE_CBM
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                ,XX_REC_HIST_CRAT_TS
                ,XX_REC_HIST_CRAT_BY_NM
                ,XX_REC_HIST_UPD_TS
                ,XX_REC_HIST_UPD_BY_NM
                ,XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
            FROM
                (
                    SELECT
                         DCH.DS_CONTR_PK            AS DS_CONTR_PK
                        ,0                          AS DS_CONTR_DTL_PK
                        ,0                          AS DS_CONTR_BLLG_MTR_PK
                        ,NULL                       AS DS_CONTR_DTL_TP_CD
                        ,DCH.DS_CONTR_CATG_CD       AS DS_CONTR_CATG_CD
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        <!-- ,TRIM(DCH.DS_CONTR_CATG_CD || '-' || DCH.DS_CONTR_NUM) -->
                        ,TRIM(DCC.DS_CONTR_CATG_ABBR_NM || '-' || DCH.DS_CONTR_NUM)
                        <!-- END 2017/09/04 K.Kojima [QC#20816, MOD] -->
                                                    AS XX_SCR_ITEM_34_TXT
                        ,NULL                       AS SER_NUM
                        ,NULL                       AS MTR_LB_DESC_TXT
                        ,HSV.DS_CONTR_CTRL_STS_CD   AS DS_CONTR_CTRL_STS_CD
                        ,HSV.DS_CONTR_CTRL_STS_NM   AS DS_CONTR_CTRL_STS_NM
                        ,DCH.CONTR_VRSN_EFF_FROM_DT AS CONTR_VRSN_EFF_FROM_DT
                        ,DCH.CONTR_VRSN_EFF_THRU_DT AS CONTR_VRSN_EFF_THRU_DT
                        ,NULL                       AS BASE_PRC_DEAL_AMT
                        ,NULL                       AS BLLG_CYCLE_UOM_NM
                        ,NULL                       AS NEXT_BLLG_DT
                        ,DCH.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A1
                        ,'N'                        AS BLLG_HLD_FLG_A2
                        ,'N'                        AS BLLG_HLD_FLG_A3
                        ,#lvlNum10#                 AS XX_REF_CSE_NUM
                        ,NULL                       AS MTR_LB_SORT_NUM
                        ,DCH.EZUPTIME               AS EZUPTIME_DCH
                        ,DCH.EZUPTIMEZONE           AS EZUPTIMEZONE_DCH
                        ,null                       AS EZUPTIME_DCD
                        ,null                       AS EZUPTIMEZONE_DCD
                        ,null                       AS EZUPTIME_CBM
                        ,null                       AS EZUPTIMEZONE_CBM
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                        ,DCH.EZINTIME               AS XX_REC_HIST_CRAT_TS
                        ,DCH.EZINUSERID             AS XX_REC_HIST_CRAT_BY_NM
                        ,DCH.EZUPTIME               AS XX_REC_HIST_UPD_TS
                        ,DCH.EZUPUSERID             AS XX_REC_HIST_UPD_BY_NM
                        ,DCH.EZTABLEID              AS XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
                    FROM
                         DS_CONTR       DCH
                        ,DS_CONTR_STS_V HSV
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        ,DS_CONTR_CATG  DCC
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    WHERE
                            DCH.GLBL_CMPY_CD     = #glblCmpyCd#
                        <iterate property="dsContrPkList" var="dsContrPk[]" open="AND DCH.DS_CONTR_PK IN (" close=")" conjunction=",">
                            #dsContrPk[]#
                        </iterate>
                        AND DCH.DS_CONTR_CATG_CD = #dsContrCatgCdFlt#
                        AND DCH.EZCANCELFLAG     = '0'
                        AND DCH.GLBL_CMPY_CD     = HSV.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_PK      = HSV.DS_CONTR_PK
                        AND HSV.EZCANCELFLAG     = '0'
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        AND DCH.GLBL_CMPY_CD     = DCC.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_CATG_CD = DCC.DS_CONTR_CATG_CD
                        AND DCC.EZCANCELFLAG     = '0'
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    UNION ALL
                    SELECT
                         DCH.DS_CONTR_PK            AS DS_CONTR_PK
                        ,DCD.DS_CONTR_DTL_PK        AS DS_CONTR_DTL_PK
                        ,0                          AS DS_CONTR_BLLG_MTR_PK
                        ,DCD.DS_CONTR_DTL_TP_CD     AS DS_CONTR_DTL_TP_CD
                        ,DCH.DS_CONTR_CATG_CD       AS DS_CONTR_CATG_CD
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        <!-- ,TRIM(DCH.DS_CONTR_CATG_CD || '-' || DCH.DS_CONTR_NUM) -->
                        ,TRIM(DCC.DS_CONTR_CATG_ABBR_NM || '-' || DCH.DS_CONTR_NUM)
                        <!-- END 2017/09/04 K.Kojima [QC#20816, MOD] -->
                                                    AS XX_SCR_ITEM_34_TXT
                        ,SMM.SER_NUM                AS SER_NUM
                        ,NULL                       AS MTR_LB_DESC_TXT
                        ,DSV.DS_CONTR_CTRL_STS_CD   AS DS_CONTR_CTRL_STS_CD
                        ,DSV.DS_CONTR_CTRL_STS_NM   AS DS_CONTR_CTRL_STS_NM
                        ,DCD.CONTR_EFF_FROM_DT      AS CONTR_VRSN_EFF_FROM_DT
                        ,DCD.CONTR_EFF_THRU_DT      AS CONTR_VRSN_EFF_THRU_DT
                        ,NULL                       AS BASE_PRC_DEAL_AMT
                        ,NULL                       AS BLLG_CYCLE_UOM_NM
                        ,NULL                       AS NEXT_BLLG_DT
                        ,DCH.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A1
                        ,DCD.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A2
                        ,'N'                        AS BLLG_HLD_FLG_A3
                        ,#lvlNum20#                 AS XX_REF_CSE_NUM
                        ,NULL                       AS MTR_LB_SORT_NUM
                        ,DCH.EZUPTIME               AS EZUPTIME_DCH
                        ,DCH.EZUPTIMEZONE           AS EZUPTIMEZONE_DCH
                        ,DCD.EZUPTIME               AS EZUPTIME_DCD
                        ,DCD.EZUPTIMEZONE           AS EZUPTIMEZONE_DCD
                        ,null                       AS EZUPTIME_CBM
                        ,null                       AS EZUPTIMEZONE_CBM
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                        ,DCD.EZINTIME               AS XX_REC_HIST_CRAT_TS
                        ,DCD.EZINUSERID             AS XX_REC_HIST_CRAT_BY_NM
                        ,DCD.EZUPTIME               AS XX_REC_HIST_UPD_TS
                        ,DCD.EZUPUSERID             AS XX_REC_HIST_UPD_BY_NM
                        ,DCD.EZTABLEID              AS XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
                    FROM
                         DS_CONTR           DCH
                        ,DS_CONTR_DTL       DCD
                        ,DS_CONTR_DTL_STS_V DSV
                        ,SVC_MACH_MSTR      SMM
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        ,DS_CONTR_CATG  DCC
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    WHERE
                            DCH.GLBL_CMPY_CD              = #glblCmpyCd#
                        <iterate property="dsContrPkList" var="dsContrPk[]" open="AND DCH.DS_CONTR_PK IN (" close=")" conjunction=",">
                            #dsContrPk[]#
                        </iterate>
                        AND DCH.DS_CONTR_CATG_CD          = #dsContrCatgCdFlt#
                        AND DCH.EZCANCELFLAG              = '0'
                        AND DCH.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_PK               = DCD.DS_CONTR_PK
                        AND DCD.DS_CONTR_DTL_TP_CD &lt;&gt; #dsContrDtlTpCdFlt#
                        <iterate property="dsContrDtlPkList" var="dsContrDtlPk[]" open="AND DCD.DS_CONTR_DTL_PK IN (" close=")" conjunction=",">
                            #dsContrDtlPk[]#
                        </iterate>
                        AND DCD.EZCANCELFLAG              = '0'
                        AND DCD.GLBL_CMPY_CD              = DSV.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_PK               = DSV.DS_CONTR_PK
                        AND DCD.DS_CONTR_DTL_PK           = DSV.DS_CONTR_DTL_PK
                        AND DSV.EZCANCELFLAG              = '0'
                        AND DCD.GLBL_CMPY_CD              = SMM.GLBL_CMPY_CD
                        AND DCD.SVC_MACH_MSTR_PK          = SMM.SVC_MACH_MSTR_PK
                        AND SMM.EZCANCELFLAG              = '0'
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        AND DCH.GLBL_CMPY_CD              = DCC.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_CATG_CD          = DCC.DS_CONTR_CATG_CD
                        AND DCC.EZCANCELFLAG              = '0'
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    UNION ALL
                    SELECT
                         DCH.DS_CONTR_PK            AS DS_CONTR_PK
                        ,DCD.DS_CONTR_DTL_PK        AS DS_CONTR_DTL_PK
                        ,0                          AS DS_CONTR_BLLG_MTR_PK
                        ,DCD.DS_CONTR_DTL_TP_CD     AS DS_CONTR_DTL_TP_CD
                        ,DCH.DS_CONTR_CATG_CD       AS DS_CONTR_CATG_CD
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        <!-- ,TRIM(DCH.DS_CONTR_CATG_CD || '-' || DCH.DS_CONTR_NUM) -->
                        ,TRIM(DCC.DS_CONTR_CATG_ABBR_NM || '-' || DCH.DS_CONTR_NUM)
                        <!-- END 2017/09/04 K.Kojima [QC#20816, MOD] -->
                                                    AS XX_SCR_ITEM_34_TXT
                        ,NULL                       AS SER_NUM
                        ,#mtrLbNm#                  AS MTR_LB_DESC_TXT
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        <!-- ,DSV.DS_CONTR_CTRL_STS_CD   AS DS_CONTR_CTRL_STS_CD -->
                        <!-- ,DSV.DS_CONTR_CTRL_STS_NM   AS DS_CONTR_CTRL_STS_NM -->
                        ,(
                            SELECT
                                DS_CONTR_CTRL_STS_CD
                            FROM
                                (
                                    SELECT
                                         PEV.DS_CONTR_CTRL_STS_CD AS DS_CONTR_CTRL_STS_CD
                                        ,1                        AS SORT_KEY1
                                        ,0                        AS SORT_KEY2
                                    FROM
                                         DS_CONTR_PRC_EFF       PEF
                                        ,DS_CONTR_PRC_EFF_STS_V PEV
                                    WHERE
                                            PEF.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_DTL_PK           = DCD.DS_CONTR_DTL_PK
                                        AND PEF.CONTR_PRC_EFF_FROM_DT &lt;= #slsDt#
                                        AND PEF.CONTR_PRC_EFF_THRU_DT &gt;= #slsDt#
                                        AND PEF.BASE_CHRG_FLG             = 'Y'
                                        AND PEF.EZCANCELFLAG              = '0'
                                        AND PEF.GLBL_CMPY_CD              = PEV.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_PRC_EFF_PK       = PEV.DS_CONTR_PRC_EFF_PK
                                        AND PEV.EZCANCELFLAG              = '0'
                                    UNION
                                    SELECT
                                         PEV.DS_CONTR_CTRL_STS_CD AS DS_CONTR_CTRL_STS_CD
                                        ,2                        AS SORT_KEY1
                                        ,(TO_DATE(PEF.CONTR_PRC_EFF_FROM_DT, 'YYYYMMDD') - TO_DATE(#slsDt#, 'YYYYMMDD')) AS SORT_KEY2
                                    FROM
                                         DS_CONTR_PRC_EFF       PEF
                                        ,DS_CONTR_PRC_EFF_STS_V PEV
                                    WHERE
                                            PEF.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_DTL_PK           = DCD.DS_CONTR_DTL_PK
                                        AND PEF.CONTR_PRC_EFF_FROM_DT  &gt; #slsDt#
                                        AND PEF.BASE_CHRG_FLG             = 'Y'
                                        AND PEF.EZCANCELFLAG              = '0'
                                        AND PEF.GLBL_CMPY_CD              = PEV.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_PRC_EFF_PK       = PEV.DS_CONTR_PRC_EFF_PK
                                        AND PEV.EZCANCELFLAG              = '0'
                                    UNION
                                    SELECT
                                         PEV.DS_CONTR_CTRL_STS_CD AS DS_CONTR_CTRL_STS_CD
                                        ,3                        AS SORT_KEY1
                                        ,(TO_DATE(#slsDt#, 'YYYYMMDD') - TO_DATE(PEF.CONTR_PRC_EFF_THRU_DT, 'YYYYMMDD')) AS SORT_KEY2
                                    FROM
                                         DS_CONTR_PRC_EFF       PEF
                                        ,DS_CONTR_PRC_EFF_STS_V PEV
                                    WHERE
                                            PEF.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_DTL_PK           = DCD.DS_CONTR_DTL_PK
                                        AND PEF.CONTR_PRC_EFF_THRU_DT  &lt; #slsDt#
                                        AND PEF.BASE_CHRG_FLG             = 'Y'
                                        AND PEF.EZCANCELFLAG              = '0'
                                        AND PEF.GLBL_CMPY_CD              = PEV.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_PRC_EFF_PK       = PEV.DS_CONTR_PRC_EFF_PK
                                        AND PEV.EZCANCELFLAG              = '0'
                                    ORDER BY
                                         SORT_KEY1                    ASC
                                        ,SORT_KEY2                    ASC
                                        ,DS_CONTR_CTRL_STS_CD         ASC
                                )
                            WHERE
                                ROWNUM = 1
                         )                          AS DS_CONTR_CTRL_STS_CD
                        ,(
                            SELECT
                                DS_CONTR_CTRL_STS_NM
                            FROM
                                (
                                    SELECT
                                         PEV.DS_CONTR_CTRL_STS_CD AS DS_CONTR_CTRL_STS_CD
                                        ,PEV.DS_CONTR_CTRL_STS_NM AS DS_CONTR_CTRL_STS_NM
                                        ,1                        AS SORT_KEY1
                                        ,0                        AS SORT_KEY2
                                    FROM
                                         DS_CONTR_PRC_EFF       PEF
                                        ,DS_CONTR_PRC_EFF_STS_V PEV
                                    WHERE
                                            PEF.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_DTL_PK           = DCD.DS_CONTR_DTL_PK
                                        AND PEF.CONTR_PRC_EFF_FROM_DT &lt;= #slsDt#
                                        AND PEF.CONTR_PRC_EFF_THRU_DT &gt;= #slsDt#
                                        AND PEF.BASE_CHRG_FLG             = 'Y'
                                        AND PEF.EZCANCELFLAG              = '0'
                                        AND PEF.GLBL_CMPY_CD              = PEV.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_PRC_EFF_PK       = PEV.DS_CONTR_PRC_EFF_PK
                                        AND PEV.EZCANCELFLAG              = '0'
                                    UNION
                                    SELECT
                                         PEV.DS_CONTR_CTRL_STS_CD AS DS_CONTR_CTRL_STS_CD
                                        ,PEV.DS_CONTR_CTRL_STS_NM AS DS_CONTR_CTRL_STS_NM
                                        ,2                        AS SORT_KEY1
                                        ,(TO_DATE(PEF.CONTR_PRC_EFF_FROM_DT, 'YYYYMMDD') - TO_DATE(#slsDt#, 'YYYYMMDD')) AS SORT_KEY2
                                    FROM
                                         DS_CONTR_PRC_EFF       PEF
                                        ,DS_CONTR_PRC_EFF_STS_V PEV
                                    WHERE
                                            PEF.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_DTL_PK           = DCD.DS_CONTR_DTL_PK
                                        AND PEF.CONTR_PRC_EFF_FROM_DT  &gt; #slsDt#
                                        AND PEF.BASE_CHRG_FLG             = 'Y'
                                        AND PEF.EZCANCELFLAG              = '0'
                                        AND PEF.GLBL_CMPY_CD              = PEV.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_PRC_EFF_PK       = PEV.DS_CONTR_PRC_EFF_PK
                                        AND PEV.EZCANCELFLAG              = '0'
                                    UNION
                                    SELECT
                                         PEV.DS_CONTR_CTRL_STS_CD AS DS_CONTR_CTRL_STS_CD
                                        ,PEV.DS_CONTR_CTRL_STS_NM AS DS_CONTR_CTRL_STS_NM
                                        ,3                        AS SORT_KEY1
                                        ,(TO_DATE(#slsDt#, 'YYYYMMDD') - TO_DATE(PEF.CONTR_PRC_EFF_THRU_DT, 'YYYYMMDD')) AS SORT_KEY2
                                    FROM
                                         DS_CONTR_PRC_EFF       PEF
                                        ,DS_CONTR_PRC_EFF_STS_V PEV
                                    WHERE
                                            PEF.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_DTL_PK           = DCD.DS_CONTR_DTL_PK
                                        AND PEF.CONTR_PRC_EFF_THRU_DT  &lt; #slsDt#
                                        AND PEF.BASE_CHRG_FLG             = 'Y'
                                        AND PEF.EZCANCELFLAG              = '0'
                                        AND PEF.GLBL_CMPY_CD              = PEV.GLBL_CMPY_CD
                                        AND PEF.DS_CONTR_PRC_EFF_PK       = PEV.DS_CONTR_PRC_EFF_PK
                                        AND PEV.EZCANCELFLAG              = '0'
                                    ORDER BY
                                         SORT_KEY1                    ASC
                                        ,SORT_KEY2                    ASC
                                        ,DS_CONTR_CTRL_STS_CD         ASC
                                )
                            WHERE
                                ROWNUM = 1
                         )                          AS DS_CONTR_CTRL_STS_CD
                        <!-- END 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        ,NULL                       AS CONTR_VRSN_EFF_FROM_DT
                        ,NULL                       AS CONTR_VRSN_EFF_THRU_DT
                        ,DCD.BASE_PRC_DEAL_AMT      AS BASE_PRC_DEAL_AMT
                        ,BCU.BLLG_CYCLE_UOM_NM      AS BLLG_CYCLE_UOM_NM
                        ,(
                            SELECT
                                 MIN(CBS.NEXT_BLLG_DT)
                            FROM
                                 DS_CONTR_BLLG_SCHD CBS
                            WHERE
                                    CBS.GLBL_CMPY_CD    = DCD.GLBL_CMPY_CD
                                AND CBS.DS_CONTR_DTL_PK = DCD.DS_CONTR_DTL_PK
                                AND CBS.INV_DT          IS NULL
                                AND CBS.BASE_CHRG_FLG   = 'Y'
                                AND CBS.EZCANCELFLAG    = '0'
                         )                          AS NEXT_BLLG_DT
                        ,DCH.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A1
                        ,DCD.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A2
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        <!-- ,'N'                        AS BLLG_HLD_FLG_A3 -->
                        ,(
                            CASE
                                WHEN
                                    EXISTS
                                        (
                                            SELECT
                                                1
                                            FROM
                                                 DS_CONTR_PRC_EFF PEF
                                            WHERE
                                                PEF.GLBL_CMPY_CD          = DCD.GLBL_CMPY_CD
                                            AND PEF.DS_CONTR_DTL_PK       = DCD.DS_CONTR_DTL_PK
                                            AND PEF.BLLG_HLD_FLG          = 'Y'
                                            AND PEF.BASE_CHRG_FLG         = 'Y'
                                            AND PEF.EZCANCELFLAG          = '0'
                                        )
                                THEN
                                    'Y'
                                ELSE
                                    'N'
                                END
                         ) AS BLLG_HLD_FLG_A3
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        ,#lvlNum30#                 AS XX_REF_CSE_NUM
                        ,NULL                       AS MTR_LB_SORT_NUM
                        ,DCH.EZUPTIME               AS EZUPTIME_DCH
                        ,DCH.EZUPTIMEZONE           AS EZUPTIMEZONE_DCH
                        ,DCD.EZUPTIME               AS EZUPTIME_DCD
                        ,DCD.EZUPTIMEZONE           AS EZUPTIMEZONE_DCD
                        ,null                       AS EZUPTIME_CBM
                        ,null                       AS EZUPTIMEZONE_CBM
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                        ,DCD.EZINTIME               AS XX_REC_HIST_CRAT_TS
                        ,DCD.EZINUSERID             AS XX_REC_HIST_CRAT_BY_NM
                        ,DCD.EZUPTIME               AS XX_REC_HIST_UPD_TS
                        ,DCD.EZUPUSERID             AS XX_REC_HIST_UPD_BY_NM
                        ,DCD.EZTABLEID              AS XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
                    FROM
                         DS_CONTR                DCH
                        ,DS_CONTR_DTL            DCD
                        ,DS_CONTR_DTL_TP         DTP
                        ,DS_CONTR_DTL_STS_V      DSV
                        ,BLLG_CYCLE_UOM          BCU
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        ,DS_CONTR_CATG  DCC
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    WHERE
                            DCH.GLBL_CMPY_CD       = #glblCmpyCd#
                        <iterate property="dsContrPkList" var="dsContrPk[]" open="AND DCH.DS_CONTR_PK IN (" close=")" conjunction=",">
                            #dsContrPk[]#
                        </iterate>
                        AND DCH.DS_CONTR_CATG_CD   = #dsContrCatgCdFlt#
                        AND DCH.EZCANCELFLAG       = '0'
                        AND DCH.GLBL_CMPY_CD       = DCD.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_PK        = DCD.DS_CONTR_PK
                        AND DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCdFlt#
                        AND DCD.EZCANCELFLAG       = '0'
                        AND DCD.GLBL_CMPY_CD       = DTP.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_DTL_TP_CD = DTP.DS_CONTR_DTL_TP_CD
                        AND DTP.BASE_CHRG_FLG      = 'Y'
                        AND DTP.EZCANCELFLAG       = '0'
                        AND DCD.GLBL_CMPY_CD       = DSV.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_PK        = DSV.DS_CONTR_PK
                        AND DCD.DS_CONTR_DTL_PK    = DSV.DS_CONTR_DTL_PK
                        AND DSV.EZCANCELFLAG       = '0'
                        AND DCD.GLBL_CMPY_CD       = BCU.GLBL_CMPY_CD
                        AND DCD.BASE_BLLG_CYCLE_CD = BCU.BLLG_CYCLE_UOM_CD
                        AND BCU.EZCANCELFLAG       = '0'
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        AND DCH.GLBL_CMPY_CD       = DCC.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_CATG_CD   = DCC.DS_CONTR_CATG_CD
                        AND DCC.EZCANCELFLAG       = '0'
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    UNION ALL
                    SELECT
                         DCH.DS_CONTR_PK            AS DS_CONTR_PK
                        ,DCD.DS_CONTR_DTL_PK        AS DS_CONTR_DTL_PK
                        ,CBM.DS_CONTR_BLLG_MTR_PK   AS DS_CONTR_BLLG_MTR_PK
                        ,DCD.DS_CONTR_DTL_TP_CD     AS DS_CONTR_DTL_TP_CD
                        ,DCH.DS_CONTR_CATG_CD       AS DS_CONTR_CATG_CD
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        <!-- ,TRIM(DCH.DS_CONTR_CATG_CD || '-' || DCH.DS_CONTR_NUM) -->
                        ,TRIM(DCC.DS_CONTR_CATG_ABBR_NM || '-' || DCH.DS_CONTR_NUM)
                        <!-- END 2017/09/04 K.Kojima [QC#20816, MOD] -->
                                                    AS XX_SCR_ITEM_34_TXT
                        ,NULL                       AS SER_NUM
                        ,MLB.MTR_LB_DESC_TXT        AS MTR_LB_DESC_TXT
                        ,MSV.DS_CONTR_CTRL_STS_CD   AS DS_CONTR_CTRL_STS_CD
                        ,MSV.DS_CONTR_CTRL_STS_NM   AS DS_CONTR_CTRL_STS_NM
                        ,NULL                       AS CONTR_VRSN_EFF_FROM_DT
                        ,NULL                       AS CONTR_VRSN_EFF_THRU_DT
                        ,NULL                       AS BASE_PRC_DEAL_AMT
                        ,BCU.BLLG_CYCLE_UOM_NM      AS BLLG_CYCLE_UOM_NM
                        ,(
                            SELECT
                                 MIN(CBS.NEXT_BLLG_DT)
                            FROM
                                 DS_CONTR_BLLG_SCHD CBS
                            WHERE
                                    CBS.GLBL_CMPY_CD         = DCD.GLBL_CMPY_CD
                                AND CBS.DS_CONTR_DTL_PK      = DCD.DS_CONTR_DTL_PK
                                AND CBS.GLBL_CMPY_CD         = CBM.GLBL_CMPY_CD
                                AND CBS.DS_CONTR_BLLG_MTR_PK = CBM.DS_CONTR_BLLG_MTR_PK
                                AND CBS.INV_DT               IS NULL
                                AND CBS.USG_CHRG_FLG         = 'Y'
                                AND CBS.EZCANCELFLAG         = '0'
                         )                          AS NEXT_BLLG_DT
                        ,DCH.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A1
                        ,DCD.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A2
                        ,CBM.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A3
                        ,#lvlNum30#                 AS XX_REF_CSE_NUM
                        ,MLB.MTR_LB_SORT_NUM        AS MTR_LB_SORT_NUM
                        ,DCH.EZUPTIME               AS EZUPTIME_DCH
                        ,DCH.EZUPTIMEZONE           AS EZUPTIMEZONE_DCH
                        ,DCD.EZUPTIME               AS EZUPTIME_DCD
                        ,DCD.EZUPTIMEZONE           AS EZUPTIMEZONE_DCD
                        ,CBM.EZUPTIME               AS EZUPTIME_CBM
                        ,CBM.EZUPTIMEZONE           AS EZUPTIMEZONE_CBM
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                        ,CBM.EZINTIME               AS XX_REC_HIST_CRAT_TS
                        ,CBM.EZINUSERID             AS XX_REC_HIST_CRAT_BY_NM
                        ,CBM.EZUPTIME               AS XX_REC_HIST_UPD_TS
                        ,CBM.EZUPUSERID             AS XX_REC_HIST_UPD_BY_NM
                        ,CBM.EZTABLEID              AS XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
                    FROM
                         DS_CONTR                DCH
                        ,DS_CONTR_DTL            DCD
                        ,DS_CONTR_DTL_TP         DTP
                        ,DS_CONTR_BLLG_MTR       CBM
                        ,MTR_LB                  MLB
                        ,DS_CONTR_BLLG_MTR_STS_V MSV
                        ,BLLG_CYCLE_UOM          BCU
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        ,DS_CONTR_CATG  DCC
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    WHERE
                            DCH.GLBL_CMPY_CD         = #glblCmpyCd#
                        <iterate property="dsContrPkList" var="dsContrPk[]" open="AND DCH.DS_CONTR_PK IN (" close=")" conjunction=",">
                            #dsContrPk[]#
                        </iterate>
                        AND DCH.DS_CONTR_CATG_CD     = #dsContrCatgCdFlt#
                        AND DCH.EZCANCELFLAG         = '0'
                        AND DCH.GLBL_CMPY_CD         = DCD.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_PK          = DCD.DS_CONTR_PK
                        AND DCD.DS_CONTR_DTL_TP_CD   = #dsContrDtlTpCdFlt#
                        AND DCD.EZCANCELFLAG         = '0'
                        AND DCD.GLBL_CMPY_CD         = DTP.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_DTL_TP_CD   = DTP.DS_CONTR_DTL_TP_CD
                        AND DTP.USG_CHRG_FLG         = 'Y'
                        AND DTP.EZCANCELFLAG         = '0'
                        AND DCD.GLBL_CMPY_CD         = CBM.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_DTL_PK      = CBM.DS_CONTR_DTL_PK
                        AND CBM.EZCANCELFLAG         = '0'
                        AND CBM.GLBL_CMPY_CD         = MLB.GLBL_CMPY_CD
                        AND CBM.BLLG_MTR_LB_CD       = MLB.MTR_LB_CD
                        AND MLB.EZCANCELFLAG         = '0'
                        AND CBM.GLBL_CMPY_CD         = MSV.GLBL_CMPY_CD
                        AND CBM.DS_CONTR_DTL_PK      = MSV.DS_CONTR_DTL_PK
                        AND CBM.DS_CONTR_BLLG_MTR_PK = MSV.DS_CONTR_BLLG_MTR_PK
                        AND MSV.EZCANCELFLAG         = '0'
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        <!-- AND DCD.GLBL_CMPY_CD         = BCU.GLBL_CMPY_CD -->
                        <!-- AND DCD.MTR_BLLG_CYCLE_CD    = BCU.BLLG_CYCLE_UOM_CD -->
                        AND CBM.GLBL_CMPY_CD           = BCU.GLBL_CMPY_CD
                        AND CBM.BLLG_MTR_BLLG_CYCLE_CD = BCU.BLLG_CYCLE_UOM_CD
                        <!-- END 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        AND BCU.EZCANCELFLAG         = '0'
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        AND DCH.GLBL_CMPY_CD         = DCC.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_CATG_CD     = DCC.DS_CONTR_CATG_CD
                        AND DCC.EZCANCELFLAG         = '0'
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    ORDER BY
                         XX_SCR_ITEM_34_TXT
                        ,SER_NUM            NULLS FIRST
                        ,MTR_LB_SORT_NUM    NULLS FIRST
                        ,MTR_LB_DESC_TXT    NULLS FIRST
                )
        )
        ,CONTR_AGG AS (
            SELECT
                 DS_CONTR_PK
                ,DS_CONTR_DTL_PK
                ,DS_CONTR_BLLG_MTR_PK
                ,DS_CONTR_DTL_TP_CD
                ,DS_CONTR_CATG_CD
                ,XX_SCR_ITEM_34_TXT
                ,SER_NUM
                ,MTR_LB_DESC_TXT
                ,DS_CONTR_CTRL_STS_CD
                ,DS_CONTR_CTRL_STS_NM
                ,CONTR_VRSN_EFF_FROM_DT
                ,CONTR_VRSN_EFF_THRU_DT
                ,BASE_PRC_DEAL_AMT
                ,BLLG_CYCLE_UOM_NM
                ,NEXT_BLLG_DT
                ,BLLG_HLD_FLG_A1
                ,BLLG_HLD_FLG_A2
                ,BLLG_HLD_FLG_A3
                ,XX_REF_CSE_NUM
                ,MTR_LB_SORT_NUM
                ,EZUPTIME_DCH
                ,EZUPTIMEZONE_DCH
                ,EZUPTIME_DCD
                ,EZUPTIMEZONE_DCD
                ,EZUPTIME_CBM
                ,EZUPTIMEZONE_CBM
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                ,XX_REC_HIST_CRAT_TS
                ,XX_REC_HIST_CRAT_BY_NM
                ,XX_REC_HIST_UPD_TS
                ,XX_REC_HIST_UPD_BY_NM
                ,XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
            FROM
                (
                    SELECT
                         DCH.DS_CONTR_PK            AS DS_CONTR_PK
                        ,0                          AS DS_CONTR_DTL_PK
                        ,0                          AS DS_CONTR_BLLG_MTR_PK
                        ,NULL                       AS DS_CONTR_DTL_TP_CD
                        ,DCH.DS_CONTR_CATG_CD       AS DS_CONTR_CATG_CD
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        <!-- ,TRIM(DCH.DS_CONTR_CATG_CD || '-' || DCH.DS_CONTR_NUM) -->
                        ,TRIM(DCC.DS_CONTR_CATG_ABBR_NM || '-' || DCH.DS_CONTR_NUM)
                        <!-- END 2017/09/04 K.Kojima [QC#20816, MOD] -->
                                                    AS XX_SCR_ITEM_34_TXT
                        ,NULL                       AS SER_NUM
                        ,NULL                       AS MTR_LB_DESC_TXT
                        ,HSV.DS_CONTR_CTRL_STS_CD   AS DS_CONTR_CTRL_STS_CD
                        ,HSV.DS_CONTR_CTRL_STS_NM   AS DS_CONTR_CTRL_STS_NM
                        ,DCH.CONTR_VRSN_EFF_FROM_DT AS CONTR_VRSN_EFF_FROM_DT
                        ,DCH.CONTR_VRSN_EFF_THRU_DT AS CONTR_VRSN_EFF_THRU_DT
                        ,NULL                       AS BASE_PRC_DEAL_AMT
                        ,NULL                       AS BLLG_CYCLE_UOM_NM
                        ,NULL                       AS NEXT_BLLG_DT
                        ,DCH.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A1
                        ,'N'                        AS BLLG_HLD_FLG_A2
                        ,'N'                        AS BLLG_HLD_FLG_A3
                        ,#lvlNum10#                 AS XX_REF_CSE_NUM
                        ,NULL                       AS MTR_LB_SORT_NUM
                        ,DCH.EZUPTIME               AS EZUPTIME_DCH
                        ,DCH.EZUPTIMEZONE           AS EZUPTIMEZONE_DCH
                        ,null                       AS EZUPTIME_DCD
                        ,null                       AS EZUPTIMEZONE_DCD
                        ,null                       AS EZUPTIME_CBM
                        ,null                       AS EZUPTIMEZONE_CBM
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                        ,DCH.EZINTIME               AS XX_REC_HIST_CRAT_TS
                        ,DCH.EZINUSERID             AS XX_REC_HIST_CRAT_BY_NM
                        ,DCH.EZUPTIME               AS XX_REC_HIST_UPD_TS
                        ,DCH.EZUPUSERID             AS XX_REC_HIST_UPD_BY_NM
                        ,DCH.EZTABLEID              AS XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
                    FROM
                         DS_CONTR       DCH
                        ,DS_CONTR_STS_V HSV
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        ,DS_CONTR_CATG  DCC
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    WHERE
                            DCH.GLBL_CMPY_CD     = #glblCmpyCd#
                        <iterate property="dsContrPkList" var="dsContrPk[]" open="AND DCH.DS_CONTR_PK IN (" close=")" conjunction=",">
                            #dsContrPk[]#
                        </iterate>
                        AND DCH.DS_CONTR_CATG_CD = #dsContrCatgCdAgg#
                        AND DCH.EZCANCELFLAG     = '0'
                        AND DCH.GLBL_CMPY_CD     = HSV.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_PK      = HSV.DS_CONTR_PK
                        AND HSV.EZCANCELFLAG     = '0'
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        AND DCH.GLBL_CMPY_CD     = DCC.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_CATG_CD = DCC.DS_CONTR_CATG_CD
                        AND DCC.EZCANCELFLAG     = '0'
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    UNION ALL
                    SELECT
                         DCH.DS_CONTR_PK            AS DS_CONTR_PK
                        ,DCD.DS_CONTR_DTL_PK        AS DS_CONTR_DTL_PK
                        ,0                          AS DS_CONTR_BLLG_MTR_PK
                        ,DCD.DS_CONTR_DTL_TP_CD     AS DS_CONTR_DTL_TP_CD
                        ,DCH.DS_CONTR_CATG_CD       AS DS_CONTR_CATG_CD
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        <!-- ,TRIM(DCH.DS_CONTR_CATG_CD || '-' || DCH.DS_CONTR_NUM) -->
                        ,TRIM(DCC.DS_CONTR_CATG_ABBR_NM || '-' || DCH.DS_CONTR_NUM)
                        <!-- END 2017/09/04 K.Kojima [QC#20816, MOD] -->
                                                    AS XX_SCR_ITEM_34_TXT
                        ,SMM.SER_NUM                AS SER_NUM
                        ,NULL                       AS MTR_LB_DESC_TXT
                        ,DSV.DS_CONTR_CTRL_STS_CD   AS DS_CONTR_CTRL_STS_CD
                        ,DSV.DS_CONTR_CTRL_STS_NM   AS DS_CONTR_CTRL_STS_NM
                        ,DCD.CONTR_EFF_FROM_DT      AS CONTR_VRSN_EFF_FROM_DT
                        ,DCD.CONTR_EFF_THRU_DT      AS CONTR_VRSN_EFF_THRU_DT
                        ,NULL                       AS BASE_PRC_DEAL_AMT
                        ,NULL                       AS BLLG_CYCLE_UOM_NM
                        ,NULL                       AS NEXT_BLLG_DT
                        ,DCH.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A1
                        ,DCD.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A2
                        ,'N'                        AS BLLG_HLD_FLG_A3
                        ,#lvlNum20#                 AS XX_REF_CSE_NUM
                        ,NULL                       AS MTR_LB_SORT_NUM
                        ,DCH.EZUPTIME               AS EZUPTIME_DCH
                        ,DCH.EZUPTIMEZONE           AS EZUPTIMEZONE_DCH
                        ,DCD.EZUPTIME               AS EZUPTIME_DCD
                        ,DCD.EZUPTIMEZONE           AS EZUPTIMEZONE_DCD
                        ,null                       AS EZUPTIME_CBM
                        ,null                       AS EZUPTIMEZONE_CBM
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                        ,DCD.EZINTIME               AS XX_REC_HIST_CRAT_TS
                        ,DCD.EZINUSERID             AS XX_REC_HIST_CRAT_BY_NM
                        ,DCD.EZUPTIME               AS XX_REC_HIST_UPD_TS
                        ,DCD.EZUPUSERID             AS XX_REC_HIST_UPD_BY_NM
                        ,DCD.EZTABLEID              AS XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
                    FROM
                         DS_CONTR           DCH
                        ,DS_CONTR_DTL       DCD
                        ,DS_CONTR_DTL_STS_V DSV
                        ,SVC_MACH_MSTR      SMM
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        ,DS_CONTR_CATG  DCC
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    WHERE
                            DCH.GLBL_CMPY_CD              = #glblCmpyCd#
                        <iterate property="dsContrPkList" var="dsContrPk[]" open="AND DCH.DS_CONTR_PK IN (" close=")" conjunction=",">
                            #dsContrPk[]#
                        </iterate>
                        AND DCH.DS_CONTR_CATG_CD          = #dsContrCatgCdAgg#
                        AND DCH.EZCANCELFLAG              = '0'
                        AND DCH.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_PK               = DCD.DS_CONTR_PK
                        AND DCD.DS_CONTR_DTL_TP_CD &lt;&gt; #dsContrDtlTpCdAgg#
                        <iterate property="dsContrDtlPkList" var="dsContrDtlPk[]" open="AND DCD.DS_CONTR_DTL_PK IN (" close=")" conjunction=",">
                            #dsContrDtlPk[]#
                        </iterate>
                        AND DCD.EZCANCELFLAG              = '0'
                        AND DCD.GLBL_CMPY_CD              = DSV.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_PK               = DSV.DS_CONTR_PK
                        AND DCD.DS_CONTR_DTL_PK           = DSV.DS_CONTR_DTL_PK
                        AND DSV.EZCANCELFLAG              = '0'
                        AND DCD.GLBL_CMPY_CD              = SMM.GLBL_CMPY_CD
                        AND DCD.SVC_MACH_MSTR_PK          = SMM.SVC_MACH_MSTR_PK
                        AND SMM.EZCANCELFLAG              = '0'
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        AND DCH.GLBL_CMPY_CD              = DCC.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_CATG_CD          = DCC.DS_CONTR_CATG_CD
                        AND DCC.EZCANCELFLAG              = '0'
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    UNION ALL
                    SELECT
                         DCH.DS_CONTR_PK            AS DS_CONTR_PK
                        ,DCD.DS_CONTR_DTL_PK        AS DS_CONTR_DTL_PK
                        ,0                          AS DS_CONTR_BLLG_MTR_PK
                        ,DCD.DS_CONTR_DTL_TP_CD     AS DS_CONTR_DTL_TP_CD
                        ,DCH.DS_CONTR_CATG_CD       AS DS_CONTR_CATG_CD
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        <!-- ,TRIM(DCH.DS_CONTR_CATG_CD || '-' || DCH.DS_CONTR_NUM) -->
                        ,TRIM(DCC.DS_CONTR_CATG_ABBR_NM || '-' || DCH.DS_CONTR_NUM)
                        <!-- END 2017/09/04 K.Kojima [QC#20816, MOD] -->
                                                    AS XX_SCR_ITEM_34_TXT
                        ,SMM.SER_NUM                AS SER_NUM
                        ,#mtrLbNm#                  AS MTR_LB_DESC_TXT
                        ,DSV.DS_CONTR_CTRL_STS_CD   AS DS_CONTR_CTRL_STS_CD
                        ,DSV.DS_CONTR_CTRL_STS_NM   AS DS_CONTR_CTRL_STS_NM
                        ,NULL                       AS CONTR_VRSN_EFF_FROM_DT
                        ,NULL                       AS CONTR_VRSN_EFF_THRU_DT
                        ,DCD.BASE_PRC_DEAL_AMT      AS BASE_PRC_DEAL_AMT
                        ,BCU.BLLG_CYCLE_UOM_NM      AS BLLG_CYCLE_UOM_NM
                        ,(
                            SELECT
                                 MIN(CBS.NEXT_BLLG_DT)
                            FROM
                                 DS_CONTR_BLLG_SCHD CBS
                            WHERE
                                    CBS.GLBL_CMPY_CD    = DCD.GLBL_CMPY_CD
                                AND CBS.DS_CONTR_DTL_PK = DCD.DS_CONTR_DTL_PK
                                AND CBS.INV_DT          IS NULL
                                AND CBS.BASE_CHRG_FLG   = 'Y'
                                AND CBS.EZCANCELFLAG    = '0'
                         )                          AS NEXT_BLLG_DT
                        ,DCH.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A1
                        ,DCD.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A2
                        ,'N'                        AS BLLG_HLD_FLG_A3
                        ,#lvlNum30#                 AS XX_REF_CSE_NUM
                        ,NULL                       AS MTR_LB_SORT_NUM
                        ,DCH.EZUPTIME               AS EZUPTIME_DCH
                        ,DCH.EZUPTIMEZONE           AS EZUPTIMEZONE_DCH
                        ,DCD.EZUPTIME               AS EZUPTIME_DCD
                        ,DCD.EZUPTIMEZONE           AS EZUPTIMEZONE_DCD
                        ,null                       AS EZUPTIME_CBM
                        ,null                       AS EZUPTIMEZONE_CBM
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                        ,DCD.EZINTIME               AS XX_REC_HIST_CRAT_TS
                        ,DCD.EZINUSERID             AS XX_REC_HIST_CRAT_BY_NM
                        ,DCD.EZUPTIME               AS XX_REC_HIST_UPD_TS
                        ,DCD.EZUPUSERID             AS XX_REC_HIST_UPD_BY_NM
                        ,DCD.EZTABLEID              AS XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
                    FROM
                         DS_CONTR                DCH
                        ,DS_CONTR_DTL            DCD
                        ,DS_CONTR_DTL_TP         DTP
                        ,DS_CONTR_DTL_STS_V      DSV
                        ,BLLG_CYCLE_UOM          BCU
                        ,SVC_MACH_MSTR           SMM
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        ,DS_CONTR_CATG  DCC
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    WHERE
                            DCH.GLBL_CMPY_CD              = #glblCmpyCd#
                        <iterate property="dsContrPkList" var="dsContrPk[]" open="AND DCH.DS_CONTR_PK IN (" close=")" conjunction=",">
                            #dsContrPk[]#
                        </iterate>
                        AND DCH.DS_CONTR_CATG_CD          = #dsContrCatgCdAgg#
                        AND DCH.EZCANCELFLAG              = '0'
                        AND DCH.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_PK               = DCD.DS_CONTR_PK
                        AND DCD.DS_CONTR_DTL_TP_CD &lt;&gt; #dsContrDtlTpCdAgg#
                        <iterate property="dsContrDtlPkList" var="dsContrDtlPk[]" open="AND DCD.DS_CONTR_DTL_PK IN (" close=")" conjunction=",">
                            #dsContrDtlPk[]#
                        </iterate>
                        AND DCD.EZCANCELFLAG              = '0'
                        AND DCD.GLBL_CMPY_CD              = DTP.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_DTL_TP_CD        = DTP.DS_CONTR_DTL_TP_CD
                        AND DTP.BASE_CHRG_FLG             = 'Y'
                        AND DTP.EZCANCELFLAG              = '0'
                        AND DCD.GLBL_CMPY_CD              = DSV.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_PK               = DSV.DS_CONTR_PK
                        AND DCD.DS_CONTR_DTL_PK           = DSV.DS_CONTR_DTL_PK
                        AND DSV.EZCANCELFLAG              = '0'
                        AND DCD.GLBL_CMPY_CD              = BCU.GLBL_CMPY_CD
                        AND DCD.BASE_BLLG_CYCLE_CD        = BCU.BLLG_CYCLE_UOM_CD
                        AND BCU.EZCANCELFLAG              = '0'
                        AND DCD.GLBL_CMPY_CD              = SMM.GLBL_CMPY_CD
                        AND DCD.SVC_MACH_MSTR_PK          = SMM.SVC_MACH_MSTR_PK
                        AND SMM.EZCANCELFLAG              = '0'
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        AND DCH.GLBL_CMPY_CD              = DCC.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_CATG_CD          = DCC.DS_CONTR_CATG_CD
                        AND DCC.EZCANCELFLAG              = '0'
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    UNION ALL
                    SELECT
                         DCH.DS_CONTR_PK            AS DS_CONTR_PK
                        ,DCD.DS_CONTR_DTL_PK        AS DS_CONTR_DTL_PK
                        ,CBM.DS_CONTR_BLLG_MTR_PK   AS DS_CONTR_BLLG_MTR_PK
                        ,DCD.DS_CONTR_DTL_TP_CD     AS DS_CONTR_DTL_TP_CD
                        ,DCH.DS_CONTR_CATG_CD       AS DS_CONTR_CATG_CD
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        <!-- ,TRIM(DCH.DS_CONTR_CATG_CD || '-' || DCH.DS_CONTR_NUM) -->
                        ,TRIM(DCC.DS_CONTR_CATG_ABBR_NM || '-' || DCH.DS_CONTR_NUM)
                        <!-- END 2017/09/04 K.Kojima [QC#20816, MOD] -->
                                                    AS XX_SCR_ITEM_34_TXT
                        ,NULL                       AS SER_NUM
                        ,MLB.MTR_LB_DESC_TXT        AS MTR_LB_DESC_TXT
                        ,MSV.DS_CONTR_CTRL_STS_CD   AS DS_CONTR_CTRL_STS_CD
                        ,MSV.DS_CONTR_CTRL_STS_NM   AS DS_CONTR_CTRL_STS_NM
                        ,NULL                       AS CONTR_VRSN_EFF_FROM_DT
                        ,NULL                       AS CONTR_VRSN_EFF_THRU_DT
                        ,NULL                       AS BASE_PRC_DEAL_AMT
                        ,BCU.BLLG_CYCLE_UOM_NM      AS BLLG_CYCLE_UOM_NM
                        ,(
                            SELECT
                                 MIN(CBS.NEXT_BLLG_DT)
                            FROM
                                 DS_CONTR_BLLG_SCHD CBS
                            WHERE
                                    CBS.GLBL_CMPY_CD         = DCD.GLBL_CMPY_CD
                                AND CBS.DS_CONTR_DTL_PK      = DCD.DS_CONTR_DTL_PK
                                AND CBS.GLBL_CMPY_CD         = CBM.GLBL_CMPY_CD
                                AND CBS.DS_CONTR_BLLG_MTR_PK = CBM.DS_CONTR_BLLG_MTR_PK
                                AND CBS.INV_DT               IS NULL
                                AND CBS.USG_CHRG_FLG         = 'Y'
                                AND CBS.EZCANCELFLAG         = '0'
                         )                          AS NEXT_BLLG_DT
                        ,DCH.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A1
                        ,DCD.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A2
                        ,CBM.BLLG_HLD_FLG           AS BLLG_HLD_FLG_A3
                        ,#lvlNum30#                 AS XX_REF_CSE_NUM
                        ,MLB.MTR_LB_SORT_NUM        AS MTR_LB_SORT_NUM
                        ,DCH.EZUPTIME               AS EZUPTIME_DCH
                        ,DCH.EZUPTIMEZONE           AS EZUPTIMEZONE_DCH
                        ,DCD.EZUPTIME               AS EZUPTIME_DCD
                        ,DCD.EZUPTIMEZONE           AS EZUPTIMEZONE_DCD
                        ,CBM.EZUPTIME               AS EZUPTIME_CBM
                        ,CBM.EZUPTIMEZONE           AS EZUPTIMEZONE_CBM
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
                        ,CBM.EZINTIME               AS XX_REC_HIST_CRAT_TS
                        ,CBM.EZINUSERID             AS XX_REC_HIST_CRAT_BY_NM
                        ,CBM.EZUPTIME               AS XX_REC_HIST_UPD_TS
                        ,CBM.EZUPUSERID             AS XX_REC_HIST_UPD_BY_NM
                        ,CBM.EZTABLEID              AS XX_REC_HIST_TBL_NM
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
                    FROM
                         DS_CONTR                DCH
                        ,DS_CONTR_DTL            DCD
                        ,DS_CONTR_DTL_TP         DTP
                        ,DS_CONTR_BLLG_MTR       CBM
                        ,MTR_LB                  MLB
                        ,DS_CONTR_BLLG_MTR_STS_V MSV
                        ,BLLG_CYCLE_UOM          BCU
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        ,DS_CONTR_CATG  DCC
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    WHERE
                            DCH.GLBL_CMPY_CD         = #glblCmpyCd#
                        <iterate property="dsContrPkList" var="dsContrPk[]" open="AND DCH.DS_CONTR_PK IN (" close=")" conjunction=",">
                            #dsContrPk[]#
                        </iterate>
                        AND DCH.DS_CONTR_CATG_CD     = #dsContrCatgCdAgg#
                        AND DCH.EZCANCELFLAG         = '0'
                        AND DCH.GLBL_CMPY_CD         = DCD.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_PK          = DCD.DS_CONTR_PK
                        AND DCD.DS_CONTR_DTL_TP_CD   = #dsContrDtlTpCdAgg#
                        AND DCD.EZCANCELFLAG         = '0'
                        AND DCD.GLBL_CMPY_CD         = DTP.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_DTL_TP_CD   = DTP.DS_CONTR_DTL_TP_CD
                        AND DTP.USG_CHRG_FLG         = 'Y'
                        AND DTP.EZCANCELFLAG         = '0'
                        AND DCD.GLBL_CMPY_CD         = CBM.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_DTL_PK      = CBM.DS_CONTR_DTL_PK
                        AND CBM.EZCANCELFLAG         = '0'
                        AND CBM.GLBL_CMPY_CD         = MLB.GLBL_CMPY_CD
                        AND CBM.BLLG_MTR_LB_CD       = MLB.MTR_LB_CD
                        AND MLB.EZCANCELFLAG         = '0'
                        AND CBM.GLBL_CMPY_CD         = MSV.GLBL_CMPY_CD
                        AND CBM.DS_CONTR_DTL_PK      = MSV.DS_CONTR_DTL_PK
                        AND CBM.DS_CONTR_BLLG_MTR_PK = MSV.DS_CONTR_BLLG_MTR_PK
                        AND MSV.EZCANCELFLAG         = '0'
                        <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        <!-- AND DCD.GLBL_CMPY_CD         = BCU.GLBL_CMPY_CD -->
                        <!-- AND DCD.MTR_BLLG_CYCLE_CD    = BCU.BLLG_CYCLE_UOM_CD -->
                        AND CBM.GLBL_CMPY_CD           = BCU.GLBL_CMPY_CD
                        AND CBM.BLLG_MTR_BLLG_CYCLE_CD = BCU.BLLG_CYCLE_UOM_CD
                        <!-- END 2017/09/04 K.Kojima [QC#20816, MOD] -->
                        AND BCU.EZCANCELFLAG         = '0'
                        <!-- START 2017/09/04 K.Kojima [QC#20816, ADD] -->
                        AND DCH.GLBL_CMPY_CD         = DCC.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_CATG_CD     = DCC.DS_CONTR_CATG_CD
                        AND DCC.EZCANCELFLAG         = '0'
                        <!-- END 2017/09/04 K.Kojima [QC#20816, ADD] -->
                    ORDER BY
                         XX_SCR_ITEM_34_TXT
                        ,SER_NUM            NULLS FIRST
                        ,MTR_LB_SORT_NUM    NULLS FIRST
                        ,MTR_LB_DESC_TXT    NULLS FIRST
                )
        )
        SELECT * FROM CONTR_REG
        UNION ALL
        SELECT * FROM CONTR_FLT
        UNION ALL
        SELECT * FROM CONTR_AGG
    </statement>
    <resultMap id="result.getContrInfo" class="NSAL0700_ASMsg">
        <result property="dsContrPk_A1" column="DS_CONTR_PK"  javaType="EZDSBigDecimalItem" />
        <result property="dsContrDtlPk_A1" column="DS_CONTR_DTL_PK"  javaType="EZDSBigDecimalItem" />
        <result property="dsContrBllgMtrPk_A1" column="DS_CONTR_BLLG_MTR_PK"  javaType="EZDSBigDecimalItem" />
        <result property="dsContrDtlTpCd_A1" column="DS_CONTR_DTL_TP_CD"  javaType="EZDSStringItem" />
        <result property="dsContrCatgCd_A1" column="DS_CONTR_CATG_CD"  javaType="EZDSStringItem" />
        <result property="xxScrItem34Txt_A1" column="XX_SCR_ITEM_34_TXT"  javaType="EZDSStringItem" />
        <result property="serNum_A1" column="SER_NUM"  javaType="EZDSStringItem" />
        <result property="mtrLbDescTxt_A1" column="MTR_LB_DESC_TXT"  javaType="EZDSStringItem" />
        <result property="dsContrCtrlStsCd_A1" column="DS_CONTR_CTRL_STS_CD"  javaType="EZDSStringItem" />
        <result property="dsContrCtrlStsNm_A1" column="DS_CONTR_CTRL_STS_NM"  javaType="EZDSStringItem" />
        <result property="contrVrsnEffFromDt_A1" column="CONTR_VRSN_EFF_FROM_DT"  javaType="EZDSDateItem" />
        <result property="contrVrsnEffThruDt_A1" column="CONTR_VRSN_EFF_THRU_DT"  javaType="EZDSDateItem" />
        <result property="basePrcDealAmt_A1" column="BASE_PRC_DEAL_AMT"  javaType="EZDSBigDecimalItem" />
        <result property="bllgCycleUomNm_A1" column="BLLG_CYCLE_UOM_NM"  javaType="EZDSStringItem" />
        <result property="nextBllgDt_A1" column="NEXT_BLLG_DT"  javaType="EZDSDateItem" />
        <result property="bllgHldFlg_A1" column="BLLG_HLD_FLG_A1"  javaType="EZDSStringItem" />
        <result property="bllgHldFlg_A2" column="BLLG_HLD_FLG_A2"  javaType="EZDSStringItem" />
        <result property="bllgHldFlg_A3" column="BLLG_HLD_FLG_A3"  javaType="EZDSStringItem" />
        <result property="xxRefCseNum_A1" column="XX_REF_CSE_NUM"  javaType="EZDSBigDecimalItem" />
        <result property="ezUpTime_D1"       column="EZUPTIME_DCH"        javaType="EZDSStringItem" />
        <result property="ezUpTimeZone_D1"   column="EZUPTIMEZONE_DCH"   javaType="EZDSStringItem" />
        <result property="ezUpTime_D2"       column="EZUPTIME_DCD"        javaType="EZDSStringItem" />
        <result property="ezUpTimeZone_D2"   column="EZUPTIMEZONE_DCD"   javaType="EZDSStringItem" />
        <result property="ezUpTime_D3"       column="EZUPTIME_CBM"        javaType="EZDSStringItem" />
        <result property="ezUpTimeZone_D3"   column="EZUPTIMEZONE_CBM"   javaType="EZDSStringItem" />
<!-- START 2016/12/08 N.Arai [QC#14204, ADD] -->
        <result property="xxRecHistCratTs_A"   column="XX_REC_HIST_CRAT_TS"       javaType="EZDSStringItem"/>
        <result property="xxRecHistCratByNm_A" column="XX_REC_HIST_CRAT_BY_NM"    javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdTs_A"    column="XX_REC_HIST_UPD_TS"        javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdByNm_A"  column="XX_REC_HIST_UPD_BY_NM"     javaType="EZDSStringItem"/>
        <result property="xxRecHistTblNm_A"    column="XX_REC_HIST_TBL_NM"        javaType="EZDSStringItem"/>
<!-- END 2016/12/08 N.Arai [QC#14204, ADD] -->
    </resultMap>
    <statement id="getDsContrPrcEffPk" parameterClass="Map" resultClass="Map">
        SELECT
             PEF.DS_CONTR_PRC_EFF_PK
            ,PEF.EZUPTIME
            ,PEF.EZUPTIMEZONE
        FROM
            DS_CONTR_PRC_EFF       PEF
           ,DS_CONTR_PRC_EFF_STS_V PEV
        WHERE
            PEF.GLBL_CMPY_CD          = #glblCmpyCd#
        AND PEF.DS_CONTR_DTL_PK       = #dsContrDtlPk#
        <isNotNull  property="dsContrBllgMtrPk">
        AND PEF.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
        </isNotNull>
        AND PEF.BLLG_HLD_FLG          = #bllgHldFlg#
        <isNotNull  property="baseChrgFlg">
        AND PEF.BASE_CHRG_FLG         = #baseChrgFlg#
        </isNotNull>
        <isNotNull  property="usgChrgFlg">
        AND PEF.USG_CHRG_FLG          = #usgChrgFlg#
        </isNotNull>
        AND PEF.EZCANCELFLAG          = '0'
        AND PEF.GLBL_CMPY_CD          = PEV.GLBL_CMPY_CD
        AND PEF.DS_CONTR_PRC_EFF_PK   = PEV.DS_CONTR_PRC_EFF_PK
        <iterate property="dsContrCtrlStsCdList" var="dsContrCtrlStsCd[]" open="AND PEV.DS_CONTR_CTRL_STS_CD  NOT IN (" close=")" conjunction=",">
            #dsContrCtrlStsCd[]#
        </iterate>
        AND PEV.EZCANCELFLAG          = '0'
    </statement>
    <!-- START 2017/09/04 K.Kojima [QC#20816, MOD] -->
    <statement id="getDsContrDtlPkList" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             DCD.DS_CONTR_DTL_PK
        FROM
             DS_CONTR_DTL       DCD
            ,DS_CONTR_DTL_STS_V DCDSV
        WHERE
                DCD.GLBL_CMPY_CD    = #glblCmpyCd#
            AND DCD.DS_CONTR_PK     = #dsContrPk#
            AND DCD.BLLG_HLD_FLG    = #bllgHldFlg#
            AND DCD.EZCANCELFLAG    = '0'
            AND DCD.GLBL_CMPY_CD    = DCDSV.GLBL_CMPY_CD
            AND DCD.DS_CONTR_DTL_PK = DCDSV.DS_CONTR_DTL_PK
            <iterate property="dsContrCtrlStsCdList" var="dsContrCtrlStsCd[]" open="AND DCDSV.DS_CONTR_CTRL_STS_CD NOT IN (" close=")" conjunction=",">
            #dsContrCtrlStsCd[]#
            </iterate>
            AND DCDSV.EZCANCELFLAG    = '0'
    </statement>
    <statement id="getDsContrBllgMtrPkList" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            DCBM.DS_CONTR_BLLG_MTR_PK
        FROM
             DS_CONTR_BLLG_MTR       DCBM
            ,DS_CONTR_BLLG_MTR_STS_V DCBMSV
        WHERE
                DCBM.GLBL_CMPY_CD         = #glblCmpyCd#
            AND DCBM.DS_CONTR_DTL_PK      = #dsContrDtlPk#
            AND DCBM.BLLG_HLD_FLG         = #bllgHldFlg#
            AND DCBM.EZCANCELFLAG         = '0'
            AND DCBM.GLBL_CMPY_CD         = DCBMSV.GLBL_CMPY_CD
            AND DCBM.DS_CONTR_BLLG_MTR_PK = DCBMSV.DS_CONTR_BLLG_MTR_PK
            <iterate property="dsContrCtrlStsCdList" var="dsContrCtrlStsCd[]" open="AND DCBMSV.DS_CONTR_CTRL_STS_CD NOT IN (" close=")" conjunction=",">
            #dsContrCtrlStsCd[]#
            </iterate>
            AND DCBMSV.EZCANCELFLAG       = '0'
    </statement>
    <!-- END 2017/09/04 K.Kojima [QC#20816, MOD] -->
    <!-- START 2018/08/26 [QC#22987,ADD] -->
    <statement id="getUnapprovedUsgChrg" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            A.SVC_CONTR_BLLG_PK
        FROM
            SVC_CONTR_BLLG A
        WHERE
                A.EZCANCELFLAG       = '0'
            AND A.GLBL_CMPY_CD       = #glblCmpyCd#
            AND A.DS_CONTR_PK        = #dsContrPk#
            AND A.BLLG_CPLT_STS_CD   = #bllgCpltStsCd#
            AND A.BLLG_APVL_REQ_FLG  = 'Y'
            AND A.BLLG_APVL_CPLT_FLG = 'N'
            AND A.USG_CHRG_FLG       = 'Y'
    </statement>
    <statement id="getUnapprovedCrRebil" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            A.SVC_CR_REBIL_PK
        FROM
             SVC_CR_REBIL             A
            ,SVC_CR_REBIL_DTL         B
        WHERE
                A.GLBL_CMPY_CD       = #glblCmpyCd#
            <iterate property="svcCrRebilStsCdList" var="svcCrRebilStsCd[]" open="AND A.SVC_CR_REBIL_STS_CD NOT IN (" conjunction= ", " close=")">
            #svcCrRebilStsCd[]#
            </iterate>
            AND A.EZCANCELFLAG       = '0'
            AND A.GLBL_CMPY_CD       = B.GLBL_CMPY_CD
            AND A.SVC_CR_REBIL_PK    = B.SVC_CR_REBIL_PK
            AND B.DS_CONTR_PK        = #dsContrPk#
            AND B.EZCANCELFLAG       = '0'
        GROUP BY
            A.SVC_CR_REBIL_PK
    </statement>
    <!-- END 2018/08/26 [QC#22987,ADD] -->

    <!-- add start 2019/07/18 QC#51706 -->
    <statement id="getSvcMemoForManBllgHld" parameterClass="Map" resultClass="BigDecimal">
       SELECT
           A.SVC_MEMO_PK
       FROM
           SVC_MEMO A
       WHERE
               A.GLBL_CMPY_CD       = #glblCmpyCd#
           AND A.DS_CONTR_PK        = #dsContrPk#
           <isNotNull property="dsContrDtlPk">
           AND A.DS_CONTR_DTL_PK    = #dsContrDtlPk#
           </isNotNull>
           <isNull property="dsContrDtlPk">
           AND A.DS_CONTR_DTL_PK    IS NULL
           </isNull>
           <isNotNull property="dsContrBllgMtrPk">
           AND A.SVC_MEMO_TRX_NUM   = #dsContrBllgMtrPk#
           </isNotNull>
           <isNull property="dsContrBllgMtrPk">
           AND A.SVC_MEMO_TRX_NUM   IS NULL
           </isNull>
           AND A.SVC_MEMO_CATG_CD   = #svcMemoCatgCd#
           AND A.SVC_MEMO_TP_CD     = #svcMemoTpCd#
           AND A.SVC_MEMO_RSN_CD    = #svcMemoRsnCd#
           AND A.EZCANCELFLAG       = '0'
    </statement>
    <!-- add end 2019/07/18 QC#51706 -->
</sqlMap>
