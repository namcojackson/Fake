<?xml version="1.0" encoding="UTF-8" standalone="yes"?>

<sqlMap namespace="NSZC035001">

    <statement id="getContrBllgSchdInfo" parameterClass="Map" resultClass="Map">
        SELECT
             DCR.DS_CONTR_PK
            <!-- START 2019/09/04 T.Aoyagi [QC#53124,ADD] -->
            ,DCR.SVC_LINE_BIZ_CD
            <!-- END 2019/09/04 T.Aoyagi [QC#53124,ADD] -->
            ,DCL.DS_CONTR_DTL_PK
            ,DCL.PRNT_DS_CONTR_DTL_PK
            ,SMM.SVC_MACH_MSTR_PK
            ,SMM.SER_NUM
            ,CBS.DS_CONTR_BLLG_SCHD_PK
            ,CBS.DS_CONTR_BLLG_MTR_PK
            ,CBS.BLLG_SCHD_FROM_DT
            ,CBS.BLLG_SCHD_THRU_DT
            ,CBS.SVC_CR_REBIL_DTL_PK
            ,CBS.DS_BLLG_SCHD_STS_CD
            ,CBS.SVC_PHYS_MTR_READ_GRP_SQ
        FROM
             DS_CONTR           DCR
            ,DS_CONTR_DTL       DCL
            ,SVC_MACH_MSTR      SMM
            ,DS_CONTR_BLLG_SCHD CBS
        WHERE
                DCR.GLBL_CMPY_CD            = #glblCmpyCd#
            AND DCR.DS_CONTR_NUM            = #dsContrNum#
            AND DCR.DS_CONTR_CATG_CD        = #dsContrCatgCd#
            AND DCR.EZCANCELFLAG            = '0'
            AND DCR.GLBL_CMPY_CD            = DCL.GLBL_CMPY_CD
            AND DCR.DS_CONTR_PK             = DCL.DS_CONTR_PK
            AND DCL.EZCANCELFLAG            = '0'
            AND DCL.GLBL_CMPY_CD            = SMM.GLBL_CMPY_CD
            AND DCL.SVC_MACH_MSTR_PK        = SMM.SVC_MACH_MSTR_PK
            AND SMM.EZCANCELFLAG            = '0'
            AND DCL.GLBL_CMPY_CD            = CBS.GLBL_CMPY_CD
            AND DCL.DS_CONTR_DTL_PK         = CBS.DS_CONTR_DTL_PK
            AND CBS.USG_CHRG_FLG            = 'Y'
        <isNotNull property="dsBllgSchdTpCd">
            AND CBS.DS_BLLG_SCHD_TP_CD      = #dsBllgSchdTpCd#
        </isNotNull>
        <isNotNull property="svcCrRebilDtlPk">
            AND CBS.SVC_CR_REBIL_DTL_PK     = #svcCrRebilDtlPk#
        </isNotNull>
            AND CBS.INV_TP_CD               = #invTpCd#
            AND CBS.PRNT_DS_CONTR_BLLG_SCHD_PK = #prntDsContrBllgSchdPk#
            AND CBS.EZCANCELFLAG            = '0'
            AND EXISTS (
                SELECT
                    *
                FROM
                    DS_CONTR_BLLG_SCHD CBSP
                WHERE
                        CBSP.GLBL_CMPY_CD           = CBS.GLBL_CMPY_CD
                    AND CBSP.DS_CONTR_BLLG_SCHD_PK  = CBS.PRNT_DS_CONTR_BLLG_SCHD_PK
                    AND CBSP.USG_CHRG_FLG           = 'Y'
                    AND CBSP.DS_CONTR_DTL_TP_CD     = #dsContrDtlTpCd#
                    AND CBSP.BLLG_SCHD_FROM_DT  &lt;= #bllgDt#
                    AND CBSP.BLLG_SCHD_THRU_DT  &gt;= #bllgDt#
                    AND CBSP.EZCANCELFLAG           = '0'
            )
        ORDER BY
             DCL.DS_CONTR_DTL_PK
            ,CBS.DS_CONTR_BLLG_SCHD_PK
            ,CBS.DS_CONTR_BLLG_MTR_PK
    </statement>

    <statement id="getPhysMtrInfo" parameterClass="Map" resultClass="Map">
        SELECT
             BMR.BLLG_MTR_LB_CD
            ,BMR.CONTR_MTR_MULT_RATE
            ,SPM.SVC_PHYS_MTR_PK
            ,SPM.MDL_MTR_LB_CD
            ,MTL.MTR_LB_CD
            ,MTL.FLEET_MTR_LB_CD
        FROM
             CONTR_PHYS_BLLG_MTR_RELN  BMR
            ,SVC_PHYS_MTR              SPM
            ,MTR_LB                    MTL
        WHERE
                BMR.GLBL_CMPY_CD            = #glblCmpyCd#
            AND BMR.DS_CONTR_DTL_PK         = #dsContrDtlPk#
            AND BMR.DS_CONTR_BLLG_MTR_PK    = #dsContrBllgMtrPk#
            AND BMR.EZCANCELFLAG            = '0'
            AND BMR.GLBL_CMPY_CD            = SPM.GLBL_CMPY_CD
            AND BMR.SVC_PHYS_MTR_PK         = SPM.SVC_PHYS_MTR_PK
            AND SPM.EZCANCELFLAG            = '0'
            AND SPM.GLBL_CMPY_CD            = MTL.GLBL_CMPY_CD
            AND SPM.MDL_MTR_LB_CD           = MTL.MTR_LB_CD
            AND MTL.EZCANCELFLAG            = '0'
        ORDER BY
            SPM.SVC_PHYS_MTR_PK
    </statement>

    <statement id="getPrevContrBllgSchdInfo" parameterClass="Map" resultClass="Map">
        SELECT
            *
        FROM (
            SELECT
                 DCL.DS_CONTR_DTL_PK
                ,CBS.BLLG_SCHD_FROM_DT
                ,CBS.BLLG_SCHD_THRU_DT
                ,CBS.SVC_CR_REBIL_DTL_PK
                ,CBS.DS_BLLG_SCHD_STS_CD
                ,CBS.SVC_PHYS_MTR_READ_GRP_SQ
            FROM
                 DS_CONTR           DCR
                ,DS_CONTR_DTL       DCL
                ,SVC_MACH_MSTR      SMM
                ,DS_CONTR_BLLG_SCHD CBS
            WHERE
                    DCR.GLBL_CMPY_CD            = #glblCmpyCd#
                AND DCR.DS_CONTR_NUM            = #dsContrNum#
                AND DCR.EZCANCELFLAG            = '0'
                AND DCR.GLBL_CMPY_CD            = DCL.GLBL_CMPY_CD
                AND DCR.DS_CONTR_PK             = DCL.DS_CONTR_PK
                AND DCL.EZCANCELFLAG            = '0'
                AND DCL.GLBL_CMPY_CD            = SMM.GLBL_CMPY_CD
                AND DCL.SVC_MACH_MSTR_PK        = SMM.SVC_MACH_MSTR_PK
                AND SMM.EZCANCELFLAG            = '0'
                AND DCL.GLBL_CMPY_CD            = CBS.GLBL_CMPY_CD
                AND DCL.DS_CONTR_DTL_PK         = CBS.DS_CONTR_DTL_PK
                AND CBS.DS_CONTR_BLLG_MTR_PK    = #dsContrBllgMtrPk#
                <!-- START 2018/03/09 K.Kojima [QC#23600,MOD] -->
                <!-- AND CBS.BLLG_SCHD_FROM_DT   &lt;= #bllgDt# -->
                <!-- AND CBS.BLLG_SCHD_THRU_DT   &gt;= #bllgDt# -->
                AND CBS.BLLG_SCHD_THRU_DT   &lt;= #bllgDt#
                <!-- END 2018/03/09 K.Kojima [QC#23600,MOD] -->
                AND CBS.INV_TP_CD               = #invTpCd#
                <!-- START 2018/03/09 K.Kojima [QC#23600,ADD] -->
                AND CBS.BLLBL_FLG               = 'Y'
                <!-- END 2018/03/09 K.Kojima [QC#23600,ADD] -->
                AND CBS.EZCANCELFLAG            = '0'
            ORDER BY
                <!-- START 2018/03/09 K.Kojima [QC#23600,ADD] -->
                <!-- CBS.SVC_INV_NUM DESC NULLS FIRST -->
                 CBS.BLLG_SCHD_THRU_DT DESC
                ,CBS.SVC_INV_NUM DESC NULLS FIRST
                <!-- END 2018/03/09 K.Kojima [QC#23600,ADD] -->
        )
        WHERE
            ROWNUM = 1
    </statement>

    <statement id="getPrevFleetReadRollUpInfo" parameterClass="Map" resultClass="Map">
        SELECT
             FRU.FLEET_READ_ROLL_UP_PK
            ,FRU.FLEET_CALC_PROC_CD
        FROM
             FLEET_READ_ROLL_UP      FRU
            ,DS_CONTR_BLLG_SCHD      CBS
            ,DS_CONTR_BLLG_MTR       CBM
        WHERE
                FRU.GLBL_CMPY_CD               = #glblCmpyCd#
            AND FRU.DS_CONTR_DTL_PK            = #dsContrDtlPk#
            AND FRU.BLLG_FROM_DT           &lt;= #bllgDt#
            AND FRU.BLLG_THRU_DT           &gt;= #bllgDt#
        <isNotNull property="svcCrRebilDtlPk">
            AND FRU.SVC_CR_REBIL_DTL_PK        = #svcCrRebilDtlPk#
        </isNotNull>
            AND FRU.EZCANCELFLAG               = '0'
            AND FRU.GLBL_CMPY_CD               = CBS.GLBL_CMPY_CD
            AND FRU.PRNT_DS_CONTR_BLLG_SCHD_PK = CBS.DS_CONTR_BLLG_SCHD_PK
        <isNotNull property="dsBllgSchdTpCd">
            AND CBS.DS_BLLG_SCHD_TP_CD         = #dsBllgSchdTpCd#
        </isNotNull>
            AND CBS.EZCANCELFLAG               = '0'
            AND FRU.GLBL_CMPY_CD               = CBM.GLBL_CMPY_CD
            AND FRU.BLLG_MTR_LB_CD             = CBM.BLLG_MTR_LB_CD
            AND CBM.DS_CONTR_BLLG_MTR_PK       = #dsContrBllgMtrPk#
            AND CBM.EZCANCELFLAG               = '0'
    </statement>

    <statement id="getTestMtrCnt" parameterClass="Map" resultClass="Map">
        SELECT
             PMR.FSR_NUM
            ,PMR.FSR_VISIT_NUM
            ,PMR.DS_TEST_COPY_CLS_CD
            ,NVL(PMR.TEST_MTR_CNT, 0)   AS TEST_MTR_CNT
            ,PMR.SVC_TASK_NUM
            <!-- START 2017/10/25 K.Kojima [QC#21562,ADD] -->
            ,PMR.SVC_PHYS_MTR_PK
            ,PMR.MTR_READ_DT
            ,PMR.READ_MTR_CNT
            <!-- END 2017/10/25 K.Kojima [QC#21562,ADD] -->
        FROM
             CONTR_PHYS_BLLG_MTR_RELN   BMR
            ,SVC_PHYS_MTR_READ          PMR
        WHERE
                BMR.GLBL_CMPY_CD               = #glblCmpyCd#
            AND BMR.DS_CONTR_DTL_PK            = #dsContrDtlPk#
            AND BMR.DS_CONTR_BLLG_MTR_PK       = #dsContrBllgMtrPk#
            AND BMR.SVC_PHYS_MTR_PK            = #svcPhysMtrPk#
            AND BMR.EZCANCELFLAG               = '0'
            AND BMR.GLBL_CMPY_CD               = PMR.GLBL_CMPY_CD
            AND BMR.SVC_PHYS_MTR_PK            = PMR.SVC_PHYS_MTR_PK
            AND PMR.SVC_MACH_MSTR_PK           = #svcMachMstrPk#
            AND PMR.MTR_READ_DT            &gt;  #priMtrReadDt#
            AND PMR.MTR_READ_DT            &lt;= #curMtrReadDt#
            AND PMR.VLD_MTR_FLG                = 'Y'
            AND PMR.DS_TEST_COPY_CLS_CD        IN (#testCopyClsCd_In#, #testCopyClsCd_Out#)
            AND (PMR.FSR_NUM                   IS NOT NULL
            OR  PMR.FSR_VISIT_NUM              IS NOT NULL
            OR  PMR.SVC_TASK_NUM               IS NOT NULL)
            AND PMR.EZCANCELFLAG               = '0'
        ORDER BY
             PMR.MTR_READ_DT                   DESC
            ,PMR.SVC_PHYS_MTR_READ_GRP_SQ      DESC
    </statement>

    <statement id="getMtrReadInfo" parameterClass="Map" resultClass="Map">
        SELECT
             PMR.SVC_PHYS_MTR_READ_PK
            ,PMR.SVC_PHYS_MTR_PK
            ,PMR.MTR_READ_DT
            ,PMR.READ_MTR_CNT
        FROM
             DS_CONTR_BLLG_SCHD         CBS
            ,SVC_PHYS_MTR_READ          PMR
        WHERE
                CBS.GLBL_CMPY_CD               = #glblCmpyCd#
            AND CBS.DS_CONTR_BLLG_SCHD_PK      = #dsContrBllgSchdPk#
            AND CBS.EZCANCELFLAG               = '0'
            AND CBS.GLBL_CMPY_CD               = PMR.GLBL_CMPY_CD
            AND CBS.SVC_PHYS_MTR_READ_GRP_SQ   = PMR.SVC_PHYS_MTR_READ_GRP_SQ
            AND PMR.SVC_PHYS_MTR_PK            = #svcPhysMtrPk#
            AND PMR.EZCANCELFLAG               = '0'
    </statement>

    <statement id="getSvcPhysMtrPk" parameterClass="Map" resultClass="Map">
        SELECT
             BMR.SVC_PHYS_MTR_PK
        FROM
             CONTR_PHYS_BLLG_MTR_RELN   BMR
        WHERE
                BMR.GLBL_CMPY_CD               = #glblCmpyCd#
            AND BMR.DS_CONTR_DTL_PK            = #dsContrDtlPk#
            AND BMR.DS_CONTR_BLLG_MTR_PK       = #dsContrBllgMtrPk#
            AND BMR.BLLBL_FLG                  = 'Y'
            AND BMR.EZCANCELFLAG               = '0'
    </statement>

    <!-- START 2017/10/25 K.Kojima [QC#21562,ADD] -->
    <statement id="getStartCopyQty" parameterClass="Map" resultClass="Map">
        SELECT
             PMR.SVC_PHYS_MTR_PK
            ,PMR.READ_MTR_CNT
        FROM
             CONTR_PHYS_BLLG_MTR_RELN   BMR
            ,SVC_PHYS_MTR_READ          PMR
        WHERE
                BMR.GLBL_CMPY_CD               = #glblCmpyCd#
            AND BMR.DS_CONTR_DTL_PK            = #dsContrDtlPk#
            AND BMR.DS_CONTR_BLLG_MTR_PK       = #dsContrBllgMtrPk#
            AND BMR.BLLBL_FLG                  = 'Y'
            AND BMR.EZCANCELFLAG               = '0'
            AND BMR.GLBL_CMPY_CD               = PMR.GLBL_CMPY_CD
            AND BMR.SVC_PHYS_MTR_PK            = PMR.SVC_PHYS_MTR_PK
            AND BMR.DS_CONTR_DTL_PK            = PMR.DS_CONTR_DTL_PK
            AND PMR.MTR_READ_DT                = #mtrReadDt#
            AND PMR.VLD_MTR_FLG                = 'Y'
            AND PMR.EZCANCELFLAG               = '0'
        ORDER BY
            PMR.SVC_PHYS_MTR_PK
    </statement>
    <!-- END 2017/10/25 K.Kojima [QC#21562,ADD] -->
</sqlMap>
