<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NSBL0200Query">
    <typeAlias alias="NSBL0200_ASMsg" type="business.blap.NSBL0200.NSBL0200_ASMsg"/>

    <!--START 2015/11/25 CSA ADD -->
    <statement id="getMachineInfo" parameterClass="Map" resultClass="Map">
        SELECT
             SCB.SVC_CONTR_BR_CD         AS  SVC_CONTR_BR_CD
            ,SCB.SVC_CONTR_BR_DESC_TXT   AS  SVC_CONTR_BR_DESC_TXT
            ,LBT.LINE_BIZ_TP_CD          AS  LINE_BIZ_TP_CD
            ,LBT.LINE_BIZ_TP_DESC_TXT    AS  LINE_BIZ_TP_DESC_TXT
        FROM
             SVC_MACH_MSTR SMM
            ,SVC_CONTR_BR  SCB
            ,LINE_BIZ_TP   LBT
        WHERE
                SMM.GLBL_CMPY_CD          =  #glblCmpyCd#
            AND SMM.SVC_MACH_MSTR_PK      =  #svcMachMstrPk#
            AND SMM.GLBL_CMPY_CD          =  SCB.GLBL_CMPY_CD
            AND SMM.FLD_SVC_BR_CD         =  SCB.SVC_CONTR_BR_CD
            AND SCB.SVC_CONTR_BR_ACTV_FLG =  #flgY#
            AND SCB.EFF_FROM_DT           &lt;= #slsDt#
            AND NVL(SCB.EFF_THRU_DT, #thruDtLimit#)
                                          &gt;= #slsDt#
            AND SMM.GLBL_CMPY_CD          =  LBT.GLBL_CMPY_CD
            AND SMM.SVC_BY_LINE_BIZ_TP_CD =  LBT.LINE_BIZ_TP_CD
            AND SMM.EZCANCELFLAG          =  '0'
            AND SCB.EZCANCELFLAG          =  '0'
            AND LBT.EZCANCELFLAG          =  '0'
    </statement>

    <statement id="getSkillInfo" parameterClass="Map" resultClass="Map">
        SELECT
             SS.SVC_SKILL_NUM  AS SVC_SKILL_NUM
            ,SS.SVC_SKILL_NM   AS SVC_SKILL_NM
        FROM
             MDL_NM    MN
            ,DS_MDL    DM
            ,SVC_SKILL SS
        WHERE
                MN.T_GLBL_CMPY_CD = #glblCmpyCd#
            AND MN.T_MDL_NM       = #mdlNm#
            AND MN.T_GLBL_CMPY_CD = DM.GLBL_CMPY_CD
            AND MN.T_MDL_ID       = DM.MDL_ID
            AND DM.GLBL_CMPY_CD   = SS.GLBL_CMPY_CD
            AND DM.SVC_SKILL_NUM  = SS.SVC_SKILL_NUM
            AND MN.EZCANCELFLAG   = '0'
            AND DM.EZCANCELFLAG   = '0'
            AND SS.EZCANCELFLAG   = '0'
    </statement>

    <statement id="getTechList" parameterClass="Map" resultMap="result.getTechList">
        SELECT
            DISTINCT
             PSN.PSN_CD                 AS TECH_CD
            ,(
              PSN.PSN_FIRST_NM || 
              CASE
                 WHEN PSN.PSN_MID_NM IS NOT NULL THEN (' ' || PSN.PSN_MID_NM || ' ')
                 ELSE ' '
              END              ||
              PSN.PSN_LAST_NM
             )                          AS TECH_NM
            <isNotNull property="training">
            ,SSL.SVC_SKILL_LVL_DESC_TXT
            </isNotNull>
            <isNull property="training">
            ,null
            </isNull>                   AS SVC_SKILL_LVL_DESC_TXT
            ,SCB.SVC_CONTR_BR_CD        AS SVC_CONTR_BR_CD
            ,SCB.SVC_CONTR_BR_DESC_TXT  AS SVC_CONTR_BR_DESC_TXT
            ,LBT.LINE_BIZ_TP_DESC_TXT   AS LINE_BIZ_TP_DESC_TXT
        FROM
             S21_PSN          PSN
            ,SVC_BR_POST_XREF BPX
            ,SVC_CONTR_BR     SCB
            ,LINE_BIZ_TP      LBT
            <isNotNull property="training">
            ,TECH_TNG_HIST    TTH
            ,SVC_SKILL_LVL    SSL
            </isNotNull>
        WHERE
                PSN.GLBL_CMPY_CD           =    #glblCmpyCd#
            <isNotNull property="techCd">
            AND PSN.PSN_CD                 LIKE #techCd#
            </isNotNull>
            <isNotNull property="techNm">
            AND (
                 UPPER(PSN.PSN_FIRST_NM)   ||
                 CASE 
                     WHEN PSN.PSN_MID_NM IS NOT NULL THEN (' ' || UPPER(PSN.PSN_MID_NM) || ' ')
                     ELSE ' '
                 END                       ||
                 UPPER(PSN.PSN_LAST_NM)
                )                          LIKE #techNm#
            </isNotNull>
            AND PSN.GLBL_CMPY_CD           =    BPX.GLBL_CMPY_CD
            AND PSN.POST_CD                =    BPX.POST_CD
            <isNotNull property="svcBrCd">
            AND BPX.SVC_BR_CD              =    #svcBrCd#
            </isNotNull>
            <isNotNull property="svcLineBizCd">
            AND BPX.SVC_LINE_BIZ_CD        =    #svcLineBizCd#
            </isNotNull>
            AND BPX.GLBL_CMPY_CD           =    SCB.GLBL_CMPY_CD
            AND BPX.SVC_BR_CD              =    SCB.SVC_CONTR_BR_CD
            AND BPX.GLBL_CMPY_CD           =    LBT.GLBL_CMPY_CD
            AND BPX.SVC_LINE_BIZ_CD        =    LBT.LINE_BIZ_TP_CD
            AND PSN.EZCANCELFLAG           =    '0'
            AND BPX.EZCANCELFLAG           =    '0'
            AND SCB.EZCANCELFLAG           =    '0'
            AND LBT.EZCANCELFLAG           =    '0'
            <isNotNull property="training">
            AND PSN.GLBL_CMPY_CD           =    TTH.GLBL_CMPY_CD
            AND PSN.PSN_CD                 =    TTH.TECH_CD
            AND TTH.SVC_SKILL_NUM          =    #svcSkillNum#
            AND TTH.TECH_TNG_HIST_ACTV_FLG =    #flgY#
            AND TTH.EFF_FROM_DT            &lt;=   #slsDt#
            AND NVL(TTH.EFF_THRU_DT, #thruDtLimit#)
                                           &gt;=   #slsDt#
            AND TTH.GLBL_CMPY_CD           =    SSL.GLBL_CMPY_CD
            AND TTH.SVC_SKILL_LVL_PK       =    SSL.SVC_SKILL_LVL_PK
            AND TTH.EZCANCELFLAG           =    '0'
            AND SSL.EZCANCELFLAG           =    '0'
            </isNotNull>
<!-- START 2018/06/19 T.Ogura [QC#24735,ADD] -->
            AND EXISTS(
                SELECT
                    1
                FROM
                     ORG_FUNC_ASG     OFA
                    ,TOC              T
                    ,ORG_FUNC_ROLE_TP OFRT
                WHERE
                        OFA.GLBL_CMPY_CD                    = PSN.GLBL_CMPY_CD
                    AND OFA.PSN_CD                          = PSN.PSN_CD
                    AND OFA.EFF_FROM_DT                     &lt;= #slsDt#
                    AND NVL(OFA.EFF_THRU_DT, #thruDtLimit#) &gt;= #slsDt#
                    AND OFA.GLBL_CMPY_CD                    = T.GLBL_CMPY_CD
                    AND OFA.TOC_CD                          = T.TOC_CD
                    AND T.GLBL_CMPY_CD                      = OFRT.GLBL_CMPY_CD
                    AND T.ORG_FUNC_ROLE_TP_CD               = OFRT.ORG_FUNC_ROLE_TP_CD
                    AND OFRT.TECH_MSTR_REQ_FLG              = #flgY#
                    AND OFRT.ACTV_FLG                       = #flgY#
                    AND OFA.EZCANCELFLAG                    = '0'
                    AND T.EZCANCELFLAG                      = '0'
                    AND OFRT.EZCANCELFLAG                   = '0'
            )
<!-- END   2018/06/19 T.Ogura [QC#24735,ADD] -->
        ORDER BY
            TECH_CD
    </statement>

    <resultMap id="result.getTechList" class="NSBL0200_ASMsg">
        <result property="techCd_RS"               column="TECH_CD"                  javaType="EZDSStringItem"/>
        <result property="techNm_RS"               column="TECH_NM"                  javaType="EZDSStringItem"/>
        <result property="svcSkillLvlDescTxt_RS"   column="SVC_SKILL_LVL_DESC_TXT"   javaType="EZDSStringItem"/>
        <result property="svcContrBrCd_RS"         column="SVC_CONTR_BR_CD"          javaType="EZDSStringItem"/>
        <result property="svcContrBrDescTxt_RS"    column="SVC_CONTR_BR_DESC_TXT"    javaType="EZDSStringItem"/>
        <result property="lineBizTpDescTxt_RS"     column="LINE_BIZ_TP_DESC_TXT"     javaType="EZDSStringItem"/>
    </resultMap>
    <!--END 2015/11/25 CSA ADD -->
</sqlMap>
