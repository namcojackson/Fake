<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NWAL1820Query">

    <typeAlias alias="NWAL1820SMsg"    type="business.blap.NWAL1820.NWAL1820SMsg"/>
    <typeAlias alias="NWAL1820_ASMsg"  type="business.blap.NWAL1820.NWAL1820_ASMsg"/>

    <statement id="getDsOrdCatgList" parameterClass="Map" resultClass="Map">
          SELECT
                    DISTINCT
                    OC.DS_ORD_CATG_CD
                  , OC.DS_ORD_CATG_DESC_TXT
                  , OC.DS_ORD_CATG_SORT_NUM
          FROM 
                    DS_ORD_TP_PROC_DFN OTPD
                  , DS_ORD_TP OT
                  , DS_ORD_CATG OC
          WHERE 
                    OTPD.GLBL_CMPY_CD = #glblCmpyCd#
                AND OTPD.OUT_OF_WH_NODE_USG_FLG = #outOfWhNodeUsgFlg#
                AND OTPD.ACTV_FLG = #actvFlg#
                AND OTPD.EFF_FROM_DT   &lt;= #slsDt#
                AND ( OTPD.EFF_THRU_DT &gt;= #slsDt# OR OTPD.EFF_THRU_DT IS NULL )
                AND OTPD.EZCANCELFLAG = '0'

                AND OTPD.GLBL_CMPY_CD = OT.GLBL_CMPY_CD
                AND OTPD.DS_ORD_TP_CD = OT.DS_ORD_TP_CD 
                AND OT.EZCANCELFLAG = '0'

                AND OT.GLBL_CMPY_CD   = OC.GLBL_CMPY_CD
                AND OT.DS_ORD_CATG_CD = OC.DS_ORD_CATG_CD 
                AND OC.EZCANCELFLAG = '0'
          ORDER BY 
                    OC.DS_ORD_CATG_SORT_NUM
    </statement>

    <statement id="getDsOrdTpList" parameterClass="Map" resultClass="Map">
          SELECT
                    DISTINCT
                    OT.DS_ORD_TP_CD
                  , OT.DS_ORD_TP_DESC_TXT
                  , OT.DS_ORD_TP_SORT_NUM
          FROM 
                    DS_ORD_TP_PROC_DFN OTPD
                  , DS_ORD_TP OT
          WHERE 
                    OTPD.GLBL_CMPY_CD = #glblCmpyCd#
                AND OTPD.OUT_OF_WH_NODE_USG_FLG = #outOfWhNodeUsgFlg#
                AND OTPD.ACTV_FLG = #actvFlg#
                AND OTPD.EFF_FROM_DT   &lt;= #slsDt#
                AND ( OTPD.EFF_THRU_DT &gt;= #slsDt# OR OTPD.EFF_THRU_DT IS NULL )
                AND OTPD.EZCANCELFLAG = '0'

                AND OTPD.GLBL_CMPY_CD = OT.GLBL_CMPY_CD
                AND OTPD.DS_ORD_TP_CD = OT.DS_ORD_TP_CD
                <isNotNull property="dsOrdCatgCd">
                AND OT.DS_ORD_CATG_CD  = #dsOrdCatgCd#
                </isNotNull>
                AND OT.EZCANCELFLAG = '0'

          ORDER BY OT.DS_ORD_TP_SORT_NUM
    </statement>

    <statement id="getDsOrdTpSubReasonList" parameterClass="Map" resultClass="Map">
          SELECT
                    DISTINCT
                    RSN.DS_ORD_RSN_CD
                  , RSN.DS_ORD_RSN_DESC_TXT
                  , RSN.DS_ORD_RSN_SORT_NUM
          FROM 
                    DS_ORD_TP_PROC_DFN OTPD
                  , DS_ORD_TP OT
                  , DS_ORD_RSN RSN
          WHERE 
                    OTPD.GLBL_CMPY_CD = #glblCmpyCd#
                AND OTPD.OUT_OF_WH_NODE_USG_FLG = #outOfWhNodeUsgFlg#
                AND OTPD.ACTV_FLG = #actvFlg#
                AND OTPD.EFF_FROM_DT   &lt;= #slsDt#
                AND ( OTPD.EFF_THRU_DT &gt;= #slsDt# OR OTPD.EFF_THRU_DT IS NULL )
                AND OTPD.EZCANCELFLAG = '0'

                AND OTPD.GLBL_CMPY_CD = OT.GLBL_CMPY_CD
                AND OTPD.DS_ORD_TP_CD = OT.DS_ORD_TP_CD
                <isNotNull property="dsOrdCatgCd">
                AND OT.DS_ORD_CATG_CD  = #dsOrdCatgCd#
                </isNotNull>
                <isNotNull property="dsOrdTpCd">
                AND OT.DS_ORD_TP_CD = #dsOrdTpCd#
                </isNotNull>
                AND OT.EZCANCELFLAG = '0'

                AND OTPD.GLBL_CMPY_CD      = RSN.GLBL_CMPY_CD
                AND OTPD.DS_ORD_RSN_GRP_CD = RSN.DS_ORD_RSN_GRP_CD
                AND RSN.EZCANCELFLAG = '0'

          ORDER BY RSN.DS_ORD_RSN_SORT_NUM
    </statement>
    
    <statement id="getLoanOrd" parameterClass="Map" resultMap="result.getLoanOrd">
          SELECT *
          FROM
                 (
                    SELECT 
                               CPO.CPO_ORD_NUM
                             , CASE WHEN CPO.CPO_ORD_TS IS NOT NULL THEN TO_CHAR (TO_TIMESTAMP (CPO.CPO_ORD_TS, 'YYYYMMDDHH24MISSFF3'),'YYYYMMDD')
                                    ELSE ''
                               END  CPO_ORD_DT
                             , CATG.DS_ORD_CATG_DESC_TXT
                             , ORDTP.DS_ORD_TP_DESC_TXT
                             , RSN.DS_ORD_RSN_DESC_TXT
                             , STSV.ORD_HDR_STS_NM
                             , CPO.AQU_NUM
                             , CPO.SHIP_TO_CUST_ACCT_CD
                             , STC.DS_ACCT_NM AS SHIP_TO_CUST_ACCT_NM
                             , CPO.ADD_SHIP_TO_CUST_CD
                             , TOC.TOC_NM      AS SLS_REP_TOC_NM
                             , TOC.COA_BR_CD
                             , BR.COA_BR_DESC_TXT
                             , CPO.LOAN_PER_DAYS_AOT
                             , SHIP.ACTL_SHIP_DT
                             , CASE WHEN SHIP.ACTL_SHIP_DT IS NOT NULL THEN TO_CHAR( TO_DATE(SHIP.ACTL_SHIP_DT,'YYYYMMDD') + NVL(CPO.LOAN_PER_DAYS_AOT, 0), 'YYYYMMDD')
                                    ELSE NULL
                               END  LOAN_DUE_DT
                             , CNTV.LINE_CNT
                             , CASE WHEN LINK.CPO_ORD_NUM IS NOT NULL THEN 'Y'
                                    ELSE 'N' 
                               END LINK_FLG
                    FROM 
                               CPO          CPO
                             , SELL_TO_CUST STC
                             , TOC          TOC
                             , COA_BR       BR
                             , DS_ORD_CATG  CATG
                             , DS_ORD_TP    ORDTP
                             , DS_ORD_RSN   RSN
                             , (
                                  SELECT 
                                         STS.CPO_ORD_NUM
                                       , STS.ORD_HDR_STS_NM
                                  FROM 
                                         DS_ORD_STS_V STS
                                  WHERE 
                                         STS.GLBL_CMPY_CD = #msg.glblCmpyCd#
                                     AND STS.EZCANCELFLAG = '0'
                                  GROUP BY 
                                         CPO_ORD_NUM
                                       , ORD_HDR_STS_NM
                               ) STSV
                             ,(
                                  SELECT 
                                         CPOD.CPO_ORD_NUM
                                       , COUNT(CPOD.CPO_ORD_NUM) LINE_CNT 
                                  FROM 
                                         CPO_DTL CPOD
                                       ,(
                                           SELECT 
                                                  DISTINCT (CATG.DS_ORD_LINE_CATG_CD)
                                           FROM 
                                                  DS_ORD_LINE_PROC_DFN CATG
                                                , ORD_PROC_TP PROC
                                           WHERE 
                                                  CATG.GLBL_CMPY_CD      = #msg.glblCmpyCd#
                                              AND CATG.EZCANCELFLAG      = '0'
                                              AND CATG.GLBL_CMPY_CD      = PROC.GLBL_CMPY_CD
                                              AND CATG.ORD_PROC_TP_CD    = PROC.ORD_PROC_TP_CD
                                              AND PROC.ACTV_FLG          = #actvFlg#
                                              AND PROC.EFF_FROM_DT   &lt;= #msg.slsDt#
                                              AND ( PROC.EFF_THRU_DT &gt;= #msg.slsDt# OR PROC.EFF_THRU_DT IS NULL)
                                              AND PROC.OUT_OF_WH_INVTY_PROC_FLG = #outOfWhInvtyProcFlg#
                                              AND PROC.EZCANCELFLAG      = '0'
                                        ) LCATG
                                  WHERE 
                                         CPOD.GLBL_CMPY_CD        = #msg.glblCmpyCd#
                                     <isNotNull property="msg.cpoOrdNum">
                                     AND CPOD.CPO_ORD_NUM         = #msg.cpoOrdNum#
                                     </isNotNull> 
                                     AND CPOD.EZCANCELFLAG        = '0'
                                     AND CPOD.DS_ORD_LINE_CATG_CD = LCATG.DS_ORD_LINE_CATG_CD
                                  GROUP BY 
                                         CPOD.CPO_ORD_NUM
                              ) CNTV
                             , (
                                  SELECT 
                                         CPOD.CPO_ORD_NUM
                                       , MAX(SP.ACTL_SHIP_DT) ACTL_SHIP_DT
                                  FROM 
                                         CPO_DTL CPOD
                                       , SHPG_PLN SP
                                       , CPO   DCPO
                                  WHERE 
                                         CPOD.GLBL_CMPY_CD         = #msg.glblCmpyCd#
                                     <isNotNull property="msg.cpoOrdNum">
                                     AND CPOD.CPO_ORD_NUM          = #msg.cpoOrdNum#
                                     </isNotNull>
                                     AND CPOD.EZCANCELFLAG         = '0'
                                     AND CPOD.GLBL_CMPY_CD         = SP.GLBL_CMPY_CD 
                                     AND CPOD.CPO_ORD_NUM          = SP.TRX_HDR_NUM
                                     AND CPOD.CPO_DTL_LINE_NUM     = SP.TRX_LINE_NUM
                                     AND CPOD.CPO_DTL_LINE_SUB_NUM = SP.TRX_LINE_SUB_NUM
                                     <isNotNull property="msg.actlShipDt_FR">
                                     AND SP.ACTL_SHIP_DT       &gt;= #msg.actlShipDt_FR#
                                     </isNotNull>
                                     <isNotNull property="msg.actlShipDt_TO">
                                     AND SP.ACTL_SHIP_DT       &lt;= #msg.actlShipDt_TO#
                                     </isNotNull>
                                     AND SP.EZCANCELFLAG           = '0'
                                     AND CPOD.GLBL_CMPY_CD         = DCPO.GLBL_CMPY_CD
                                     AND CPOD.CPO_ORD_NUM          = DCPO.CPO_ORD_NUM
                                     <isNotNull property="msg.xxTrxDt_FR">
                                     AND (SP.ACTL_SHIP_DT           IS NOT NULL
                                     AND TO_DATE(SP.ACTL_SHIP_DT, 'YYYYMMDD') + NVL(DCPO.LOAN_PER_DAYS_AOT, 0)  &gt;= TO_DATE(#msg.xxTrxDt_FR#, 'YYYYMMDD'))
                                     </isNotNull>
                                     <isNotNull property="msg.xxTrxDt_TO">
                                     AND (SP.ACTL_SHIP_DT           IS NOT NULL
                                     AND TO_DATE(SP.ACTL_SHIP_DT, 'YYYYMMDD') + NVL(DCPO.LOAN_PER_DAYS_AOT, 0)  &lt;= TO_DATE(#msg.xxTrxDt_TO#, 'YYYYMMDD'))
                                     </isNotNull>
                                     AND DCPO.EZCANCELFLAG = '0'
                                  GROUP BY 
                                         CPOD.CPO_ORD_NUM
                               ) SHIP
                             , (
                                  SELECT 
                                         CPOD.CPO_ORD_NUM
                                  FROM 
                                         CPO_DTL CPOD
                                       , SHPG_PLN SP
                                  WHERE 
                                         CPOD.GLBL_CMPY_CD         = #msg.glblCmpyCd#
                                     AND CPOD.BASE_CMPT_FLG        = #baseCmptFlg#
                                     <isNotNull property="msg.cpoOrdNum">
                                     AND CPOD.CPO_ORD_NUM          = #msg.cpoOrdNum#
                                     </isNotNull>
                                     AND CPOD.EZCANCELFLAG         = '0'
                                     AND CPOD.GLBL_CMPY_CD         = SP.GLBL_CMPY_CD
                                     AND CPOD.CPO_ORD_NUM          = SP.TRX_HDR_NUM
                                     AND CPOD.CPO_DTL_LINE_NUM     = SP.TRX_LINE_NUM
                                     AND CPOD.CPO_DTL_LINE_SUB_NUM = SP.TRX_LINE_SUB_NUM
                                     AND SP.SHPG_STS_CD            = #shpgStsInstalled# -- INSTALLED
                                     AND SP.EZCANCELFLAG           = '0'
                                  GROUP BY 
                                         CPOD.CPO_ORD_NUM
                               ) LINK

                    WHERE
                             CPO.GLBL_CMPY_CD          = #msg.glblCmpyCd#
                         AND CPO.EZCANCELFLAG         = '0'
                         <isNotNull property="msg.cpoOrdNum">
                         AND CPO.CPO_ORD_NUM           = #msg.cpoOrdNum#
                         </isNotNull>
                         <isNotNull property="msg.addShipToCustCd">
                         AND CPO.ADD_SHIP_TO_CUST_CD   = #msg.addShipToCustCd#
                         </isNotNull>
                         
                         <isNotNull property="msg.dsOrdCatgCd">
                         AND CPO.DS_ORD_CATG_CD        = #msg.dsOrdCatgCd#
                         </isNotNull>
                         <isNotNull property="msg.dsOrdTpCd">
                         AND CPO.DS_ORD_TP_CD          = #msg.dsOrdTpCd#
                         </isNotNull>
                         <isNotNull property="msg.dsOrdRsnCd">
                         AND CPO.DS_ORD_RSN_CD         = #msg.dsOrdRsnCd#
                         </isNotNull>
                         <isNotNull property="msg.aquNum">
                         AND CPO.AQU_NUM               = #msg.aquNum#
                         </isNotNull>
                         <isNotNull property="msg.shipToCustAcctCd">
                         AND CPO.SHIP_TO_CUST_ACCT_CD  = #msg.shipToCustAcctCd#
                         </isNotNull>
 
                         AND CPO.GLBL_CMPY_CD          = STC.GLBL_CMPY_CD
                         AND CPO.SHIP_TO_CUST_ACCT_CD  = STC.SELL_TO_CUST_CD
                         AND STC.EZCANCELFLAG          = '0'
                         <isNotNull property="msg.shipToCustAcctNm">
                         AND STC.DS_ACCT_NM  LIKE #msg.shipToCustAcctNm#
                         </isNotNull>
                         
                         AND CPO.GLBL_CMPY_CD          = TOC.GLBL_CMPY_CD(+)
                         AND CPO.SLS_REP_TOC_CD        = TOC.TOC_CD(+)
                         AND TOC.EZCANCELFLAG(+)       = '0'

                         <isNotNull property="msg.psnNum">
                         AND EXISTS (
                                  SELECT 1 
                                  FROM   ORG_FUNC_ASG ORG
                                       , S21_PSN      PSN
                                  WHERE  ORG.GLBL_CMPY_CD         = CPO.GLBL_CMPY_CD
                                     AND ORG.TOC_CD               = CPO.SLS_REP_TOC_CD
                                     AND ORG.EZCANCELFLAG         = '0'
                                     AND ORG.GLBL_CMPY_CD         = PSN.GLBL_CMPY_CD
                                     AND ORG.PSN_CD               = PSN.PSN_CD
                                     AND PSN.PSN_NUM              = #msg.psnNum#
                                     AND PSN.EZCANCELFLAG         = '0'
                                    )
                         </isNotNull>
                         
                         AND TOC.GLBL_CMPY_CD          = BR.GLBL_CMPY_CD(+)
                         AND TOC.COA_BR_CD             = BR.COA_BR_CD(+)
                         AND BR.EZCANCELFLAG(+)        = '0'
                         <isNotNull property="msg.coaBrDescTxt">
                         AND BR.COA_BR_DESC_TXT        = #msg.coaBrDescTxt#
                         </isNotNull>

                         AND CPO.GLBL_CMPY_CD          = CATG.GLBL_CMPY_CD(+)
                         AND CPO.DS_ORD_CATG_CD        = CATG.DS_ORD_CATG_CD(+)
                         AND CATG.EZCANCELFLAG(+)      = '0'
                         AND CPO.GLBL_CMPY_CD          = ORDTP.GLBL_CMPY_CD(+)
                         AND CPO.DS_ORD_TP_CD          = ORDTP.DS_ORD_TP_CD(+)
                         AND ORDTP.EZCANCELFLAG(+)     = '0'
                         AND CPO.GLBL_CMPY_CD          = RSN.GLBL_CMPY_CD(+)
                         AND CPO.DS_ORD_RSN_CD         = RSN.DS_ORD_RSN_CD(+)
                         AND RSN.EZCANCELFLAG(+)       = '0'

                         AND CPO.CPO_ORD_NUM           = STSV.CPO_ORD_NUM
                         AND CPO.CPO_ORD_NUM           = CNTV.CPO_ORD_NUM(+)

                         <isNotNull property="msg.serNum">
                         AND EXISTS (
                                     SELECT 1
                                     FROM   SVC_MACH_MSTR MACH
                                     WHERE  CPO.GLBL_CMPY_CD         = MACH.GLBL_CMPY_CD
                                        AND CPO.CPO_ORD_NUM          = MACH.CPO_ORD_NUM
                                        AND MACH.SER_NUM             = #msg.serNum#
                                        AND MACH.EZCANCELFLAG        = '0'
                                    )
                         </isNotNull>
                         <isNotNull property="InnerJoinFlgShip">
                         AND CPO.CPO_ORD_NUM         = SHIP.CPO_ORD_NUM
                         </isNotNull>
                         <isNull property="InnerJoinFlgShip">
                         AND CPO.CPO_ORD_NUM         = SHIP.CPO_ORD_NUM(+)
                         </isNull>
                         AND CPO.CPO_ORD_NUM         = LINK.CPO_ORD_NUM(+)
                         AND EXISTS (
                                      SELECT 1
                                      FROM 
                                                DS_ORD_TP_PROC_DFN OTPD
                                              , DS_ORD_TP OT
                                              , DS_ORD_CATG OC
                                      WHERE 
                                                CPO.GLBL_CMPY_CD            = OTPD.GLBL_CMPY_CD
                                            AND CPO.DS_ORD_TP_CD            = OTPD.DS_ORD_TP_CD
                                            AND OTPD.OUT_OF_WH_NODE_USG_FLG = #outOfWhNodeUsgFlg#
                                            AND OTPD.ACTV_FLG = #actvFlg#
                                            AND OTPD.EFF_FROM_DT   &lt;= #msg.slsDt#
                                            AND ( OTPD.EFF_THRU_DT &gt;= #msg.slsDt# OR OTPD.EFF_THRU_DT IS NULL )
                                            AND OTPD.EZCANCELFLAG = '0'
                                    )
                    ORDER BY
                             CPO.CPO_ORD_NUM
                 )
          WHERE ROWNUM &lt;= #rowNum#
    </statement>
    <resultMap id="result.getLoanOrd"   class="NWAL1820_ASMsg">
        <result property="cpoOrdNum_A"           column="CPO_ORD_NUM"                 javaType="EZDSStringItem"/>
        <result property="xxCpoOrdDt_A"          column="CPO_ORD_DT"                  javaType="EZDSDateItem"/>
        <result property="dsOrdCatgDescTxt_A"    column="DS_ORD_CATG_DESC_TXT"        javaType="EZDSStringItem"/>
        <result property="dsOrdTpDescTxt_A"      column="DS_ORD_TP_DESC_TXT"          javaType="EZDSStringItem"/>
        <result property="dsOrdRsnDescTxt_A"     column="DS_ORD_RSN_DESC_TXT"         javaType="EZDSStringItem"/>
        <result property="ordHdrStsNm_A"         column="ORD_HDR_STS_NM"              javaType="EZDSStringItem"/>
        <result property="aquNum_A"              column="AQU_NUM"                     javaType="EZDSStringItem"/>
        <result property="shipToCustAcctCd_A"    column="SHIP_TO_CUST_ACCT_CD"        javaType="EZDSStringItem"/>
        <result property="shipToCustAcctNm_A"    column="SHIP_TO_CUST_ACCT_NM"        javaType="EZDSStringItem"/>
        <result property="addShipToCustCd_A"     column="ADD_SHIP_TO_CUST_CD"         javaType="EZDSStringItem"/>
        <result property="slsRepTocNm_A"         column="SLS_REP_TOC_NM"              javaType="EZDSStringItem"/>
        <result property="coaBrCd_A"             column="COA_BR_CD"                   javaType="EZDSStringItem"/>
        <result property="coaBrDescTxt_A"        column="COA_BR_DESC_TXT"             javaType="EZDSStringItem"/>
        <result property="loanPerDaysAot_A"      column="LOAN_PER_DAYS_AOT"           javaType="EZDSBigDecimalItem"/>
        <result property="actlShipDt_A"          column="ACTL_SHIP_DT"                javaType="EZDSDateItem"/>
        <result property="xxTrxDt_A"             column="LOAN_DUE_DT"                 javaType="EZDSDateItem"/>
        <result property="xxDtlCnt_A"            column="LINE_CNT"                    javaType="EZDSBigDecimalItem"/>
        <result property="xxExstFlg_A"           column="LINK_FLG"                    javaType="EZDSStringItem"/>
    </resultMap>

    <statement id="getSavedSearchOptionList" parameterClass="Map" resultClass="Map">
        SELECT
                  SSO.SRCH_OPT_PK
                , SSO.SRCH_OPT_NM
            FROM
                SAVE_SRCH_OPT SSO 
            WHERE
                SSO.GLBL_CMPY_CD        = #glblCmpyCd#
                AND SSO.SRCH_OPT_APL_ID = #srchOptAplId#
                AND SSO.SRCH_OPT_USR_ID = #srchOptUsrId#
                AND SSO.EZCANCELFLAG    = '0'
            ORDER BY
                  SSO.SRCH_OPT_NM
    </statement>
</sqlMap>
