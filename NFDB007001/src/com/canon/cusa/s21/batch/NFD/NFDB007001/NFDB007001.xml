<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NFDB007001">

    <statement id="getWorkItemTrx" parameterClass="Map" resultClass="Map">
        SELECT
             CST.CLT_STRGY_TRX_PK
            ,CST.CLT_ACCT_CD
            ,CSWIT.CLT_STRGY_WRK_ITEM_TRX_PK
            ,CSWIT.CLT_WRK_ITEM_NM
            ,CSWIT.CLT_WRK_ITEM_RWSD_DT
            ,CSWIT.CLT_WRK_ITEM_WSRD_DT
            ,CSWIT.CLT_WRK_ITEM_RWED_DT
            <!-- START 2021/07/01 G.Delgado [QC#58909,MOD] -->
            <!-- ,BTC.LOC_NUM -->
            ,BTC.BILL_TO_CUST_CD
            <!-- END 2021/07/01 G.Delgado [QC#58909,MOD] -->
            ,CP_BILL.CLT_PSN_CD                     AS CLT_PSN_CD_BILL
            ,CP_BILL.CLT_PSN_NM                     AS CLT_PSN_NM_BILL
            ,CP_ACCT.CLT_PSN_CD                     AS CLT_PSN_CD_ACCT
            ,CP_ACCT.CLT_PSN_NM                     AS CLT_PSN_NM_ACCT
         FROM
             CLT_STRGY_TRX CST
            ,CLT_STRGY_WRK_ITEM_TRX CSWIT
            ,CLT_WRK_ITEM CWI
            ,BILL_TO_CUST BTC
            ,CLT_PTFO CP_BILL
            ,SELL_TO_CUST      STC
            ,CLT_PTFO CP_ACCT
         WHERE
                  CST.GLBL_CMPY_CD                 = #glblCmpyCd#
           AND    CST.CLT_STRGY_STS_CD             = #cltStrgyStsCd#
           AND    CST.CLT_STRGY_CUR_FLG            = #flgY#
           <!-- START 04/29/2021 H.Dimay [QC#58696, MOD] -->
           <!-- AND    TO_DATE(CSWIT.CLT_WRK_ITEM_RWSD_DT, 'YYYYMMDD') + CWI.CLT_WRK_ESCL_WAIT_DAYS_AOT  &lt; TO_DATE(#batProcDt#, 'YYYYMMDD') -->
           AND    TO_DATE(CSWIT.CLT_WRK_ITEM_RWED_DT, 'YYYYMMDD') + CWI.CLT_WRK_ESCL_WAIT_DAYS_AOT  &lt; TO_DATE(#batProcDt#, 'YYYYMMDD')
           <!-- END 04/29/2021 H.Dimay [QC#58696, MOD] -->
           AND    CSWIT.CLT_WRK_TP_CD              = #cltWrkTpCd#
           AND    CSWIT.CLT_WRK_ITEM_STS_CD        IN (#cltWrkItemStsCd#, #wrkItmStsPending#)
           AND    CWI.CLT_WRK_ESCL_FLG             = #cltWrkEsclFlg#
           AND    CST.GLBL_CMPY_CD                 = CSWIT.GLBL_CMPY_CD
           AND    CST.CLT_STRGY_TRX_PK             = CSWIT.CLT_STRGY_TRX_PK
           AND    CSWIT.GLBL_CMPY_CD               = CWI.GLBL_CMPY_CD
           AND    CSWIT.CLT_WRK_ITEM_CD            = CWI.CLT_WRK_ITEM_CD
           AND    CST.GLBL_CMPY_CD                 = BTC.GLBL_CMPY_CD
           AND    CST.BILL_TO_CUST_CD              = BTC.BILL_TO_CUST_CD
           AND    BTC.GLBL_CMPY_CD                 = CP_BILL.GLBL_CMPY_CD(+)
           AND    BTC.CLT_PTFO_PK                  = CP_BILL.CLT_PTFO_PK(+)
           AND    CST.GLBL_CMPY_CD                 = STC.GLBL_CMPY_CD
           AND    CST.CLT_ACCT_CD                  = STC.SELL_TO_CUST_CD
           AND    STC.GLBL_CMPY_CD                 = CP_ACCT.GLBL_CMPY_CD
           AND    STC.CLT_PTFO_PK                  = CP_ACCT.CLT_PTFO_PK
           AND    CST.EZCANCELFLAG                 = '0'
           AND    CSWIT.EZCANCELFLAG               = '0'
           AND    CWI.EZCANCELFLAG                 = '0'
           AND    BTC.EZCANCELFLAG                 = '0'
           AND    CP_BILL.EZCANCELFLAG(+)          = '0'
           AND    STC.EZCANCELFLAG                 = '0'
           AND    CP_ACCT.EZCANCELFLAG             = '0'
           <!-- QC#18754 ADD start -->
           AND    NOT EXISTS (
                              SELECT
                                   CSWIT2.CLT_STRGY_WRK_ITEM_TRX_PK
                              FROM
                                   CLT_STRGY_WRK_ITEM_TRX CSWIT2
                              WHERE
                                   CSWIT2.GLBL_CMPY_CD          = CST.GLBL_CMPY_CD
                              AND  CSWIT2.EZCANCELFLAG          = '0'
                              AND  CSWIT2.CLT_STRGY_TRX_PK      = CST.CLT_STRGY_TRX_PK
                              AND  CSWIT2.CLT_WRK_ITEM_RWSD_DT  &lt; CSWIT.CLT_WRK_ITEM_RWSD_DT
                              AND  CSWIT2.CLT_WRK_ITEM_STS_CD   IN(#cltWrkItemStsCd#, #wrkItmStsPending#)
                              AND  CSWIT2.CLT_WRK_TP_CD         = #wrkTpCd#
                              )
           <!-- QC#18754 ADD end -->
         ORDER BY
                  CSWIT.CLT_STRGY_WRK_ITEM_TRX_PK
    </statement>

</sqlMap>
