<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NLCB006001">


    <statement id="getLastUpdateTs" parameterClass="Map" resultClass="Map">
        SELECT
             DBPL.DS_BIZ_PROC_LOG_PK
            ,DBPL.DS_BIZ_LAST_UPD_TS
        FROM
            DS_BIZ_PROC_LOG DBPL
        WHERE 1=1
        AND DBPL.GLBL_CMPY_CD = #glblCmpyCd#
        AND DBPL.EZCANCELFLAG = '0'
        AND DBPL.PROC_PGM_ID  = #procPgmId#
        ORDER BY
             DBPL.DS_BIZ_PROC_TRX_NUM
            ,DBPL.DS_BIZ_PROC_TRX_DTL_NUM
            ,DBPL.DS_BIZ_PROC_TRX_SUB_DTL_NUM
    </statement>

    <statement id="getPIResult" parameterClass="Map" resultClass="Map">
        SELECT
             PIC.RTL_WH_CD              AS PIC_RTL_WH_CD
            ,PIC.RTL_SWH_CD             AS PIC_RTL_SWH_CD
            ,PIC.TECH_TOC_CD            AS PIC_TECH_TOC_CD
            ,PIC.PHYS_INVTY_CTRL_NM     AS PIC_PHYS_INVTY_CTRL_NM
            ,PIH.INVTY_AVAL_QTY         AS PIH_INVTY_AVAL_QTY
            ,NVL(PIH.LTST_CNT_INP_QTY,PIH.FIRST_CNT_INP_QTY)       AS PIH_LTST_CNT_INP_QTY
<!-- START 2019/01/24 T.Ogura [QC#29984,MOD] -->
<!--        ,PIC.ADJ_NET_AMT            AS PIC_ADJ_NET_AMT -->
            ,(
                SELECT
                    SUM(PID2.ADJ_VAR_AMT)
                FROM
                    PHYS_INVTY_CTRL PIC2
                    ,PHYS_INVTY_CNT_HDR PIH2
                    ,PHYS_INVTY_CNT_DTL PID2
                WHERE
                    PIC2.GLBL_CMPY_CD          = PIC.GLBL_CMPY_CD
                AND PIC2.PHYS_INVTY_NUM        = PIC.PHYS_INVTY_NUM
                AND PIC2.WH_CD                 = PIC.WH_CD
                AND PIC2.GLBL_CMPY_CD          = PIH2.GLBL_CMPY_CD
                AND PIC2.PHYS_INVTY_CTRL_PK    = PIH2.PHYS_INVTY_CTRL_PK
                AND PIH2.GLBL_CMPY_CD          = PID2.GLBL_CMPY_CD
                AND PIH2.PHYS_INVTY_CTRL_PK    = PID2.PHYS_INVTY_CTRL_PK
                AND PIH2.PHYS_INVTY_CNT_HDR_PK = PID2.PHYS_INVTY_CNT_HDR_PK
                AND PIC2.EZCANCELFLAG          = '0'
                AND PIH2.EZCANCELFLAG          = '0'
                AND PID2.EZCANCELFLAG          = '0'
                GROUP BY 
                    PIC2.PHYS_INVTY_NUM
             ) AS PIC_ADJ_NET_AMT
<!-- END   2019/01/24 T.Ogura [QC#29984,MOD] -->
            ,PIH.ADJ_VAR_FLG            AS PIH_ADJ_VAR_FLG
            ,PIC.ADJ_SUBMT_TS           AS PIC_ADJ_SUBMT_TS
<!-- START 2019/01/24 T.Ogura [QC#29984,MOD] -->
<!--        ,PIC.ADJ_GRS_AMT            AS PIC_ADJ_GRS_AMT -->
            ,(
                SELECT
                    SUM(ABS(PID2.ADJ_VAR_AMT))
                FROM
                    PHYS_INVTY_CTRL PIC2
                    ,PHYS_INVTY_CNT_HDR PIH2
                    ,PHYS_INVTY_CNT_DTL PID2
                WHERE
                    PIC2.GLBL_CMPY_CD          = PIC.GLBL_CMPY_CD
                AND PIC2.PHYS_INVTY_NUM        = PIC.PHYS_INVTY_NUM
                AND PIC2.WH_CD                 = PIC.WH_CD
                AND PIC2.GLBL_CMPY_CD          = PIH2.GLBL_CMPY_CD
                AND PIC2.PHYS_INVTY_CTRL_PK    = PIH2.PHYS_INVTY_CTRL_PK
                AND PIH2.GLBL_CMPY_CD          = PID2.GLBL_CMPY_CD
                AND PIH2.PHYS_INVTY_CTRL_PK    = PID2.PHYS_INVTY_CTRL_PK
                AND PIH2.PHYS_INVTY_CNT_HDR_PK = PID2.PHYS_INVTY_CNT_HDR_PK
                AND PIC2.EZCANCELFLAG          = '0'
                AND PIH2.EZCANCELFLAG          = '0'
                AND PID2.EZCANCELFLAG          = '0'
                GROUP BY 
                    PIC2.PHYS_INVTY_NUM
             ) AS PIC_ADJ_GRS_AMT
<!-- END   2019/01/24 T.Ogura [QC#29984,MOD] -->
            ,PIH.MDSE_CD                AS PIH_MDSE_CD
            ,MDSE.MDSE_DESC_SHORT_TXT   AS DMI_MDSE_DESC_SHORT_TXT
            ,PIC.WH_CD                  AS PIC_WH_CD
            ,PIH.ADJ_VAR_QTY            AS PIH_ADJ_VAR_QTY
            ,PIH.ADJ_VAR_AMT            AS PIH_ADJ_VAR_AMT
        FROM 
             PHYS_INVTY_CTRL        PIC
            ,PHYS_INVTY_CNT_HDR     PIH
            ,MDSE                   MDSE
        WHERE
             PIC.GLBL_CMPY_CD           = #glblCmpyCd#
        AND  PIC.GLBL_CMPY_CD           = PIH.GLBL_CMPY_CD
        AND  PIC.PHYS_INVTY_CTRL_PK     = PIH.PHYS_INVTY_CTRL_PK
        AND  PIC.LOC_TP_CD              = #locTpCd#
        <!-- start mod 2018/10/17 QC#28770 -->
        AND  PIC.PHYS_INVTY_CNT_STS_CD  IN
        <iterate property="physInvtyCntStsCdList" var="physInvtyCntStsCd[]" open=" (" close=")" conjunction=",">
            #physInvtyCntStsCd[]#
        </iterate>
        <isNotNull property="adjSubmtTs">
        <!-- AND  (PIC.ADJ_SUBMT_TS          &gt; #adjSubmtTs# OR PIC.ADJ_SUBMT_TS IS NULL) -->
        AND  PIC.ADJ_SUBMT_TS          &gt; #adjSubmtTs#
        </isNotNull>
        <!-- end mod 2018/05/24 QC#28770 -->
        <!-- start mod 2018/05/24 QC#10572 -->
        AND  PIC.PHYS_INVTY_STS_CD      IN
        <iterate property="physInvtyStsCdList" var="physInvtyStsCd[]" open=" (" close=")" conjunction=",">
            #physInvtyStsCd[]#
        </iterate>
        <!-- end mod 2018/05/24 QC#10572 -->
        AND  PIH.GLBL_CMPY_CD           = MDSE.GLBL_CMPY_CD
        AND  PIH.MDSE_CD                = MDSE.MDSE_CD
        AND  PIC.EZCANCELFLAG           = '0'
        AND  PIH.EZCANCELFLAG           = '0'
        AND  MDSE.EZCANCELFLAG          = '0'
        UNION ALL
        SELECT
             PIC.RTL_WH_CD              AS PIC_RTL_WH_CD
            ,PIC.RTL_SWH_CD             AS PIC_RTL_SWH_CD
            ,PIC.TECH_TOC_CD            AS PIC_TECH_TOC_CD
            ,PIC.PHYS_INVTY_CTRL_NM     AS PIC_PHYS_INVTY_CTRL_NM
            ,NULL                       AS PIH_INVTY_AVAL_QTY
            ,NULL                       AS PIH_LTST_CNT_INP_QTY
<!-- START 2019/01/24 T.Ogura [QC#29984,MOD] -->
<!--        ,PIC.ADJ_NET_AMT            AS PIC_ADJ_NET_AMT -->
            ,(
                SELECT
                    SUM(PID2.ADJ_VAR_AMT)
                FROM
                    PHYS_INVTY_CTRL PIC2
                    ,PHYS_INVTY_CNT_HDR PIH2
                    ,PHYS_INVTY_CNT_DTL PID2
                WHERE
                    PIC2.GLBL_CMPY_CD          = PIC.GLBL_CMPY_CD
                AND PIC2.PHYS_INVTY_NUM        = PIC.PHYS_INVTY_NUM
                AND PIC2.WH_CD                 = PIC.WH_CD
                AND PIC2.GLBL_CMPY_CD          = PIH2.GLBL_CMPY_CD
                AND PIC2.PHYS_INVTY_CTRL_PK    = PIH2.PHYS_INVTY_CTRL_PK
                AND PIH2.GLBL_CMPY_CD          = PID2.GLBL_CMPY_CD
                AND PIH2.PHYS_INVTY_CTRL_PK    = PID2.PHYS_INVTY_CTRL_PK
                AND PIH2.PHYS_INVTY_CNT_HDR_PK = PID2.PHYS_INVTY_CNT_HDR_PK
                AND PIC2.EZCANCELFLAG          = '0'
                AND PIH2.EZCANCELFLAG          = '0'
                AND PID2.EZCANCELFLAG          = '0'
                GROUP BY 
                    PIC2.PHYS_INVTY_NUM
             ) AS PIC_ADJ_NET_AMT
<!-- END   2019/01/24 T.Ogura [QC#29984,MOD] -->
            ,NULL                       AS PIH_ADJ_VAR_FLG
            ,PIC.ADJ_SUBMT_TS           AS PIC_ADJ_SUBMT_TS
<!-- START 2019/01/24 T.Ogura [QC#29984,MOD] -->
<!--        ,PIC.ADJ_GRS_AMT            AS PIC_ADJ_GRS_AMT -->
            ,(
                SELECT
                    SUM(ABS(PID2.ADJ_VAR_AMT))
                FROM
                    PHYS_INVTY_CTRL PIC2
                    ,PHYS_INVTY_CNT_HDR PIH2
                    ,PHYS_INVTY_CNT_DTL PID2
                WHERE
                    PIC2.GLBL_CMPY_CD          = PIC.GLBL_CMPY_CD
                AND PIC2.PHYS_INVTY_NUM        = PIC.PHYS_INVTY_NUM
                AND PIC2.WH_CD                 = PIC.WH_CD
                AND PIC2.GLBL_CMPY_CD          = PIH2.GLBL_CMPY_CD
                AND PIC2.PHYS_INVTY_CTRL_PK    = PIH2.PHYS_INVTY_CTRL_PK
                AND PIH2.GLBL_CMPY_CD          = PID2.GLBL_CMPY_CD
                AND PIH2.PHYS_INVTY_CTRL_PK    = PID2.PHYS_INVTY_CTRL_PK
                AND PIH2.PHYS_INVTY_CNT_HDR_PK = PID2.PHYS_INVTY_CNT_HDR_PK
                AND PIC2.EZCANCELFLAG          = '0'
                AND PIH2.EZCANCELFLAG          = '0'
                AND PID2.EZCANCELFLAG          = '0'
                GROUP BY 
                    PIC2.PHYS_INVTY_NUM
             ) AS PIC_ADJ_GRS_AMT
<!-- END   2019/01/24 T.Ogura [QC#29984,MOD] -->
            ,NULL                       AS PIH_MDSE_CD
            ,#physInvtyNoAdjTxt#        AS DMI_MDSE_DESC_SHORT_TXT
            ,PIC.WH_CD                  AS PIC_WH_CD
            ,NULL                       AS PIH_ADJ_VAR_QTY
            ,NULL                       AS PIH_ADJ_VAR_AMT
        FROM 
             PHYS_INVTY_CTRL        PIC
        WHERE
             PIC.GLBL_CMPY_CD           = #glblCmpyCd#
        AND  PIC.LOC_TP_CD              = #locTpCd#
        <!-- start mod 2018/10/17 QC#28770 -->
        AND  PIC.PHYS_INVTY_CNT_STS_CD  IN
        <iterate property="physInvtyCntStsCdList" var="physInvtyCntStsCd[]" open=" (" close=")" conjunction=",">
            #physInvtyCntStsCd[]#
        </iterate>
        <isNotNull property="adjSubmtTs">
        <!-- AND  (PIC.ADJ_SUBMT_TS          &gt; #adjSubmtTs# OR PIC.ADJ_SUBMT_TS IS NULL) -->
        AND  PIC.ADJ_SUBMT_TS          &gt; #adjSubmtTs#
        </isNotNull>
        <!-- end mod 2018/05/24 QC#28770 -->
        AND  PIC.PHYS_INVTY_STS_CD      IN
        <iterate property="physInvtyNoAdjStsCdList" var="physInvtyNoAdjStsCd[]" open=" (" close=")" conjunction=",">
            #physInvtyNoAdjStsCd[]#
        </iterate>
        AND PIC.EZCANCELFLAG           = '0'
        AND NOT EXISTS(
            SELECT
                1
            FROM
                PHYS_INVTY_CNT_HDR     PIH
            WHERE
                PIC.GLBL_CMPY_CD       = PIH.GLBL_CMPY_CD
            AND PIC.PHYS_INVTY_CTRL_PK = PIH.PHYS_INVTY_CTRL_PK
            AND PIH.EZCANCELFLAG       = '0'
        )
        ORDER BY
             PIC_TECH_TOC_CD
            ,PIC_PHYS_INVTY_CTRL_NM
            ,PIC_WH_CD
            ,PIH_MDSE_CD
    </statement>

    <statement id="getRegionAndBranch" parameterClass="Map" resultClass="Map">
        SELECT DISTINCT
             OFA.PSN_CD     AS OFA_PSN_CD
            ,OFA.TOC_CD     AS OFA_TOC_CD
            ,ORG.TIER       AS ORG_TIER
            ,ORG.ORG_CD     AS ORG_ORG_CD
            ,ORG.ORG_NM     AS ORG_ORG_NM
            ,ORG.RG_FLG     AS ORG_RG_FLG
            ,ORG.BR_FLG     AS ORG_BR_FLG
        FROM
             S21_ORG        SOR
            ,ORG_FUNC_ASG   OFA
            ,TOC            TOC
            ,(
                SELECT DISTINCT 
                     TI.BIZ_AREA_ORG_CD
                    ,TI.TIER
                    ,SO.TOC_CD
                    ,CASE
                        WHEN TI.TIER = SO.FIRST_ORG_TIER_CD     THEN SO.FIRST_ORG_CD
                        WHEN TI.TIER = SO.SCD_ORG_TIER_CD       THEN SO.SCD_ORG_CD
                        WHEN TI.TIER = SO.THIRD_ORG_TIER_CD     THEN SO.THIRD_ORG_CD
                        WHEN TI.TIER = SO.FRTH_ORG_TIER_CD      THEN SO.FRTH_ORG_CD
                        WHEN TI.TIER = SO.FIFTH_ORG_TIER_CD     THEN SO.FIFTH_ORG_CD
                        WHEN TI.TIER = SO.SIXTH_ORG_TIER_CD     THEN SO.SIXTH_ORG_CD
                        WHEN TI.TIER = SO.SVNTH_ORG_TIER_CD     THEN SO.SVNTH_ORG_CD
                        WHEN TI.TIER = SO.EIGHTH_ORG_TIER_CD    THEN SO.EIGHTH_ORG_CD
                        WHEN TI.TIER = SO.NINTH_ORG_TIER_CD     THEN SO.NINTH_ORG_CD
                        WHEN TI.TIER = SO.TENTH_ORG_TIER_CD     THEN SO.TENTH_ORG_CD
                        WHEN TI.TIER = SO.ELVTH_ORG_TIER_CD     THEN SO.ELVTH_ORG_CD
                     END AS ORG_CD
                    ,CASE
                        WHEN TI.TIER = SO.FIRST_ORG_TIER_CD     THEN SO.FIRST_ORG_NM
                        WHEN TI.TIER = SO.SCD_ORG_TIER_CD       THEN SO.SCD_ORG_NM
                        WHEN TI.TIER = SO.THIRD_ORG_TIER_CD     THEN SO.THIRD_ORG_NM
                        WHEN TI.TIER = SO.FRTH_ORG_TIER_CD      THEN SO.FRTH_ORG_NM
                        WHEN TI.TIER = SO.FIFTH_ORG_TIER_CD     THEN SO.FIFTH_ORG_NM
                        WHEN TI.TIER = SO.SIXTH_ORG_TIER_CD     THEN SO.SIXTH_ORG_NM
                        WHEN TI.TIER = SO.SVNTH_ORG_TIER_CD     THEN SO.SVNTH_ORG_NM
                        WHEN TI.TIER = SO.EIGHTH_ORG_TIER_CD    THEN SO.EIGHTH_ORG_NM
                        WHEN TI.TIER = SO.NINTH_ORG_TIER_CD     THEN SO.NINTH_ORG_NM
                        WHEN TI.TIER = SO.TENTH_ORG_TIER_CD     THEN SO.TENTH_ORG_NM
                        WHEN TI.TIER = SO.ELVTH_ORG_TIER_CD     THEN SO.ELVTH_ORG_NM
                     END AS ORG_NM
                    ,TI.RG_FLG
                    ,TI.BR_FLG
                FROM
                     S21_ORG SO
                    ,(
                        SELECT
                             OHSD.BIZ_AREA_ORG_CD
                            ,OHSD.ORG_TIER_CD       AS TIER
                            ,SD.RG_FLG
                            ,SD.BR_FLG
                        FROM
                             ORG_HRCH_STRU_DFN OHSD
                            ,STRU_DFN SD    
                        WHERE 
                             OHSD.GLBL_CMPY_CD      = #glblCmpyCd#
                        AND  OHSD.ORG_STRU_TP_CD    = #orgStruTpCd#
                        AND  OHSD.BIZ_AREA_ORG_CD   = #bizAreaOrgCd#
                        AND  OHSD.STRU_DFN_CD       = SD.STRU_DFN_CD
                        AND  OHSD.GLBL_CMPY_CD      = SD.GLBL_CMPY_CD
                        AND (SD.BR_FLG              = #brFlg# OR SD.RG_FLG = #rgFlg#)
                        AND  OHSD.EZCANCELFLAG      = '0'
                        AND  SD.EZCANCELFLAG        = '0'
                     ) TI
                WHERE
                     SO.GLBL_CMPY_CD                = #glblCmpyCd#
                AND  SO.EZCANCELFLAG                = '0'
             )              ORG
        WHERE 
             SOR.GLBL_CMPY_CD     = #glblCmpyCd#
        AND  SOR.FIRST_ORG_CD     = ORG.BIZ_AREA_ORG_CD
        AND  SOR.GLBL_CMPY_CD     = OFA.GLBL_CMPY_CD
        AND  SOR.TOC_CD           = OFA.TOC_CD
        AND  SOR.GLBL_CMPY_CD     = TOC.GLBL_CMPY_CD
        AND  SOR.TOC_CD           = TOC.TOC_CD
        <isNotNull property="gnrnTpCdList">
        AND  OFA.GNRN_TP_CD      IN 
        <iterate property="gnrnTpCdList" var="gnrnTpCd[]" open="(" close=")" conjunction=",">
            #gnrnTpCd[]#
        </iterate>
        </isNotNull>
        AND  OFA.EFF_FROM_DT     &lt;= #procDt#
        AND (OFA.EFF_THRU_DT     &gt;= #procDt# OR OFA.EFF_THRU_DT IS NULL)
        AND  SOR.TOC_CD           = ORG.TOC_CD(+)
        AND  OFA.PSN_CD           = #psnCd#
        AND  SOR.EZCANCELFLAG     = '0'
        AND  OFA.EZCANCELFLAG     = '0'
        AND  TOC.EZCANCELFLAG     = '0'
        ORDER BY 
             PSN_CD
            ,OFA.TOC_CD
            ,TIER
            ,ORG_ORG_CD
    </statement>

    <statement id="getRemoveTechPiRsltRptWrkData" parameterClass="Map" resultClass="Map">
        SELECT 
            TRW.TECH_PI_RSLT_RPT_WRK_PK
        FROM
            TECH_PI_RSLT_RPT_WRK TRW
        WHERE 
            TRW.GLBL_CMPY_CD         = #glblCmpyCd#
        AND TRW.EZINTIME             &lt; #purgeTs#
        AND TRW.EZCANCELFLAG         = '0'
    </statement>

</sqlMap>
