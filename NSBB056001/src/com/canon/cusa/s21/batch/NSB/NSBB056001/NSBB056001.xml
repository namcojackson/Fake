<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSBB056001">
    <statement id="getSupplimentalInfo" parameterClass="Map" resultClass="Map">
<!-- START 2023/03/03 L.Mandanas [CSA#61067, DEL] -->
<!--
        SELECT
             STA.SER_NUM                   AS SER_NUM
            ,STA.SVC_TASK_NUM              AS SVC_TASK_NUM
            ,FVI.FSR_VISIT_ARV_DT          AS FSR_VISIT_ARV_DT
            ,FVI.FSR_VISIT_ARV_TM          AS FSR_VISIT_ARV_TM
            ,FVT.SVC_PBLM_LOC_TP_CD        AS SVC_PBLM_LOC_TP_CD
            ,SPL.SVC_PBLM_LOC_TP_NM        AS SVC_PBLM_LOC_TP_NM
            ,STA.MDSE_CD                   AS MDSE_CD
        FROM
             SVC_TASK         STA
            ,FSR_VISIT        FVI
            ,FSR_VISIT_TASK   FVT
            ,SVC_PBLM_LOC_TP  SPL
        WHERE
                STA.GLBL_CMPY_CD         = #glblCmpyCd#
            AND STA.GLBL_CMPY_CD         = FVI.GLBL_CMPY_CD
            AND STA.SVC_TASK_NUM         = FVI.SVC_TASK_NUM
            AND FVI.GLBL_CMPY_CD         = FVT.GLBL_CMPY_CD
            AND FVI.SVC_TASK_NUM         = FVT.SVC_TASK_NUM
            AND FVI.FSR_NUM              = FVT.FSR_NUM
            AND FVI.FSR_VISIT_NUM        = FVT.FSR_VISIT_NUM
            AND FVT.GLBL_CMPY_CD         = SPL.GLBL_CMPY_CD(+)
            AND FVT.SVC_PBLM_LOC_TP_CD   = SPL.SVC_PBLM_LOC_TP_CD(+)
            AND STA.EZCANCELFLAG         = '0'
            AND FVI.EZCANCELFLAG         = '0'
            AND FVT.EZCANCELFLAG         = '0'
            AND SPL.EZCANCELFLAG(+)      = '0'
            AND EXISTS (
                SELECT 
                    1
                FROM
                    FSR_EVENT    FEV
                WHERE
                        FEV.GLBL_CMPY_CD        = STA.GLBL_CMPY_CD
                    AND FEV.SVC_TASK_NUM        = STA.SVC_TASK_NUM
                    <iterate property="svcDisptEventCd" var="svcDisptEventCd[]" open=" AND FEV.SVC_DISPT_EVENT_CD IN  (" close=")" conjunction=",">
                    #svcDisptEventCd[]#
                    </iterate>
                    <isNotNull property="lastProcTs">
                    AND FEV.FSR_EVENT_EXE_TS &gt;  #lastProcTs#
                    </isNotNull>
                    AND FEV.FSR_EVENT_EXE_TS &lt;= #currentSystemTs#
                    AND FEV.EZCANCELFLAG        = '0'
                GROUP BY
                    FEV.SVC_TASK_NUM
            )
        ORDER BY
             STA.SER_NUM         ASC
            ,STA.SVC_TASK_NUM    ASC
 -->
<!-- END 2023/03/03 L.Mandanas [CSA#61067, DEL] -->
<!-- START 2023/03/03 L.Mandanas [CSA#61067, ADD] -->
        SELECT
<!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!--             B.SER_NUM                                                             AS SER_NUM-->
            CASE WHEN SMM.SLD_BY_LINE_BIZ_TP_CD = #crsSvcLobCd# AND SMM.SVC_BY_LINE_BIZ_TP_CD &lt;&gt; #crsSvcLobCd# AND B.SER_NUM &lt;&gt; SMM.CUST_MACH_CTRL_NUM THEN SMM.CUST_MACH_CTRL_NUM
                  ELSE    B.SER_NUM 
             END AS SER_NUM
<!-- END 2023/07/06 R.Jin [CSA#61067, MOD] -->
            ,A.FSR_NUM || #colon# || B.SVC_TASK_NUM || #hyphen# || C.FSR_VISIT_NUM AS ORIG_CALL_TASK_NUM
            ,C.FSR_VISIT_ARV_DT                                                    AS FSR_VISIT_ARV_DT
            ,C.FSR_VISIT_ARV_TM                                                    AS FSR_VISIT_ARV_TM
<!-- START 2023/05/19 L.Mandanas [CSA#61067, MOD] -->
<!--
            ,(
                SELECT
                    X.SVC_CMNT_TXT
                FROM (
                    SELECT
                        SVM.SVC_CMNT_TXT
                    FROM 
                        SVC_MEMO SVM
                    WHERE
                        SVM.GLBL_CMPY_CD            = #glblCmpyCd#
                        AND SVM.SVC_TASK_NUM        = B.SVC_TASK_NUM
                        AND SVM.SVC_MEMO_TP_CD      = #svcMemoTpCd#
                        AND SVM.EZCANCELFLAG        = '0'
                    ORDER BY
                        SVM.LAST_UPD_TS ASC
                   ) X
                WHERE
                    ROWNUM = 1
            )                                                                            AS ORIG_SVC_PBLM_DESC_TXT
            ,''                                                                          AS ORIG_SVC_PBLM_RSN_DESC_TXT
            ,''                                                                          AS ORIG_SVC_PBLM_CRCT_DESC_TXT
            ,''                                                                          AS ORIG_SVC_PBLM_LOC_DESC_TXT
-->
<!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!--            ,(-->
<!--                SELECT-->
<!--                    X.SVC_PBLM_TP_CD || #colon# || Y.SVC_PBLM_TP_DESC_TXT-->
<!--                FROM -->
<!--                    FSR_VISIT_TASK X-->
<!--                   ,SVC_PBLM_TP    Y-->
<!--                WHERE-->
<!--                    X.GLBL_CMPY_CD            = #glblCmpyCd#-->
<!--                    AND X.SVC_TASK_NUM        = B.SVC_TASK_NUM-->
<!--                    AND X.SVC_PBLM_TP_CD      = Y.SVC_PBLM_TP_CD-->
<!--                    AND X.EZCANCELFLAG        = '0'-->
<!--                    AND Y.EZCANCELFLAG        = '0' -->
<!--              )                                                                          AS ORIG_SVC_PBLM_DESC_TXT-->
<!--            ,(-->
<!--                SELECT-->
<!--                    X.SVC_PBLM_RSN_TP_CD || #colon# || SUBSTR(Y.SVC_PBLM_RSN_TP_DESC_TXT, #substrStart1#, #substrEnd#)-->
<!--                FROM -->
<!--                    FSR_VISIT_TASK  X-->
<!--                   ,SVC_PBLM_RSN_TP Y-->
<!--                WHERE-->
<!--                    X.GLBL_CMPY_CD            = #glblCmpyCd#-->
<!--                    AND X.SVC_TASK_NUM        = B.SVC_TASK_NUM-->
<!--                    AND X.SVC_PBLM_RSN_TP_CD  = Y.SVC_PBLM_RSN_TP_CD-->
<!--                    AND X.EZCANCELFLAG        = '0'-->
<!--                    AND Y.EZCANCELFLAG        = '0' -->
<!--              )                                                                          AS ORIG_SVC_PBLM_RSN_DESC_TXT-->
<!--            ,(-->
<!--                SELECT-->
<!--                    X.SVC_PBLM_CRCT_TP_CD || #colon# || SUBSTR(Y.SVC_PBLM_CRCT_TP_DESC_TXT, #substrStart1#, #substrEnd#)-->
<!--                FROM -->
<!--                    FSR_VISIT_TASK   X-->
<!--                   ,SVC_PBLM_CRCT_TP Y-->
<!--                WHERE-->
<!--                    X.GLBL_CMPY_CD            = #glblCmpyCd#-->
<!--                    AND X.SVC_TASK_NUM        = B.SVC_TASK_NUM-->
<!--                    AND X.SVC_PBLM_CRCT_TP_CD = Y.SVC_PBLM_CRCT_TP_CD-->
<!--                    AND X.EZCANCELFLAG        = '0'-->
<!--                    AND Y.EZCANCELFLAG        = '0' -->
<!--              )                                                                          AS ORIG_SVC_PBLM_CRCT_DESC_TXT-->
<!--            ,(-->
<!--                SELECT-->
<!--                    X.SVC_PBLM_LOC_TP_CD || #colon# || SUBSTR(Y.SVC_PBLM_LOC_TP_DESC_TXT, #substrStart2#, #substrEnd#)-->
<!--                FROM -->
<!--                    FSR_VISIT_TASK  X-->
<!--                   ,SVC_PBLM_LOC_TP Y-->
<!--                WHERE-->
<!--                    X.GLBL_CMPY_CD            = #glblCmpyCd#-->
<!--                    AND X.SVC_TASK_NUM        = B.SVC_TASK_NUM-->
<!--                    AND X.SVC_PBLM_LOC_TP_CD  = Y.SVC_PBLM_LOC_TP_CD-->
<!--                    AND X.EZCANCELFLAG        = '0'-->
<!--                    AND Y.EZCANCELFLAG        = '0' -->
<!--              )                                                                          AS ORIG_SVC_PBLM_LOC_DESC_TXT-->
<!-- END 2023/05/19 L.Mandanas [CSA#61067, MOD] -->
            ,(
                SELECT
                    <!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!--                    substr(X.SVC_CMNT_TXT,1,510) AS SVC_CMNT_TXT-->
                    substr(REPLACE(REPLACE(X.SVC_CMNT_TXT, CHR(13), ' '), CHR(10),' '),1,510)  AS SVC_CMNT_TXT
                    <!-- END 2023/07/06 R.Jin [CSA#61067, MOD] -->
                FROM (
                    SELECT
                        SVM.SVC_CMNT_TXT
                    FROM 
                        SVC_MEMO SVM
                    WHERE
                        SVM.GLBL_CMPY_CD            = #glblCmpyCd#
                        AND SVM.SVC_TASK_NUM        = B.SVC_TASK_NUM
                        <iterate property="cmpsPblmSvcMemoTpList" var="cmpsPblmSvcMemoTp[]" open=" AND SVM.SVC_MEMO_TP_CD IN (" close=")" conjunction=",">
                           #cmpsPblmSvcMemoTp[]#
                        </iterate>
                        AND SVM.EZCANCELFLAG        = '0'
                    ORDER BY
                        SVM.LAST_UPD_TS ASC
                   ) X
                WHERE
                    ROWNUM = 1
            )                                           AS ORIG_SVC_PBLM_DESC_TXT
            ,''                                         AS ORIG_SVC_PBLM_RSN_DESC_TXT
            ,(
                SELECT
                    <!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!--                    substr(X.SVC_CMNT_TXT,1,510) AS SVC_CMNT_TXT-->
                    substr(REPLACE(REPLACE(X.SVC_CMNT_TXT, CHR(13), ' '), CHR(10),' '),1,510)  AS SVC_CMNT_TXT
                    <!-- END 2023/07/06 R.Jin [CSA#61067, MOD] -->
                FROM (
                    SELECT
                        SVM.SVC_CMNT_TXT
                    FROM 
                        SVC_MEMO SVM
                    WHERE
                        SVM.GLBL_CMPY_CD            = #glblCmpyCd#
                        AND SVM.SVC_TASK_NUM        = B.SVC_TASK_NUM
                        <iterate property="cmpsCrctSvcMemoTpList" var="cmpsCrctSvcMemoTp[]" open=" AND SVM.SVC_MEMO_TP_CD IN (" close=")" conjunction=",">
                           #cmpsCrctSvcMemoTp[]#
                        </iterate>
                        AND SVM.EZCANCELFLAG        = '0'
                    ORDER BY
                        SVM.LAST_UPD_TS DESC
                   ) X
                WHERE
                    ROWNUM = 1
            )                                           AS ORIG_SVC_PBLM_CRCT_DESC_TXT
            ,''                                         AS ORIG_SVC_PBLM_LOC_DESC_TXT
<!--            ,#glblCmpyCd#                                                                AS GLBL_CMPY_CD_01-->
            ,#sndrCmpyCd#                               AS GLBL_CMPY_CD_01
<!-- END 2023/07/06 R.Jin [CSA#61067, MOD] -->
            ,TO_CHAR(SYSDATE, #dateFormat#)                                              AS CRAT_DT
            ,TO_CHAR(SYSDATE, #timeFormat#)                                              AS CRAT_TM
            ,#ifProcStsCd#                                                               AS IF_PROC_STS_CD
            ,CASE WHEN A.SHIP_TO_CUST_UPD_FLG = #flgY# THEN E.POST_CD ELSE D.POST_CD END AS POST_CD
            ,CASE WHEN A.SHIP_TO_CUST_UPD_FLG = #flgY# THEN E.CTRY_CD ELSE D.CTRY_CD END AS CTRY_CD
        FROM
             FSR             A
            ,SVC_TASK        B
            ,FSR_VISIT       C
            ,SHIP_TO_CUST    D
            ,SHIP_TO_CUST    E
            ,S21_PSN         PSN
<!-- START 2023/07/06 R.Jin [CSA#61067, ADD] -->
            ,SVC_MACH_MSTR SMM
<!-- END 2023/07/06 R.Jin [CSA#61067, ADD] -->
        WHERE
                A.GLBL_CMPY_CD             = #glblCmpyCd#
            AND A.EZCANCELFLAG             = '0'
            AND A.FSR_STS_CD               = #fsrStsCd#
<!-- START 2023/07/06 R.Jin [CSA#61067, ADD] -->
            AND A.FSR_NUM NOT LIKE '1%'
<!-- END 2023/07/06 R.Jin [CSA#61067, ADD] -->
            <isNull property="isMonthly">
<!-- START 2023/04/24 L.Mandanas [CSA#61067, MOD] -->
<!-- 
            AND A.FSR_CLO_DT||A.FSR_CLO_TM BETWEEN TO_CHAR(TO_DATE(#trgtDt#, #dateFormat#), #dateFormat#)||#fromTm# AND
                TO_CHAR(TO_DATE(#trgtDt#, #dateFormat#) + 1, #dateFormat#)||#toTm# 
-->
<!-- START 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!--            AND A.FSR_CLO_DT = TO_CHAR(TO_DATE(#trgtDt#, #dateFormat#), #dateFormat#)-->
            AND A.FSR_CLO_DT BETWEEN TO_CHAR(TO_DATE(#slsDt#, #dateFormat#) - #extrDys#, #dateFormat#) AND TO_CHAR(TO_DATE(#slsDt#,  #dateFormat#) -1,  #dateFormat#)
<!-- END 2023/07/06 R.Jin [CSA#61067, MOD] -->
<!-- END 2023/04/24 L.Mandanas [CSA#61067, MOD] -->
            </isNull>
            <isNotNull property="isMonthly">
<!-- START 2023/04/24 L.Mandanas [CSA#61067, MOD] -->
<!--            AND A.FSR_CLO_DT ||A.FSR_CLO_TM BETWEEN #fromDt#|| #fromTm# AND #toDt# || #toTm#  -->
            AND A.FSR_CLO_DT BETWEEN #fromDt# AND #toDt# - 1
<!-- END 2023/04/24 L.Mandanas [CSA#61067, MOD] -->
            </isNotNull>
            AND A.GLBL_CMPY_CD             = B.GLBL_CMPY_CD
            AND A.FSR_NUM                  = B.FSR_NUM
            AND B.EZCANCELFLAG             = '0'
            AND B.SVC_TASK_STS_CD          = #svcTaskStsCd#
            AND B.GLBL_CMPY_CD             = C.GLBL_CMPY_CD
            AND B.SVC_TASK_NUM             = C.SVC_TASK_NUM
            AND C.FSR_VISIT_STS_CD  &lt;&gt; #fsrVisitStsCd#
            AND C.EZCANCELFLAG             = '0'
            AND B.GLBL_CMPY_CD             = D.GLBL_CMPY_CD
            AND B.SHIP_TO_CUST_CD          = D.SHIP_TO_CUST_CD
            AND D.EZCANCELFLAG             = '0'
            AND A.GLBL_CMPY_CD             = E.GLBL_CMPY_CD(+)
            AND A.SHIP_TO_UPD_CUST_CD      = E.SHIP_TO_CUST_CD(+)
            AND E.EZCANCELFLAG(+)          = '0'
<!-- END 2023/03/03 L.Mandanas [CSA#61067, ADD] -->
            <!-- START 2023/07/06 R.Jin [CSA#61067, ADD] -->
            AND C.TECH_CD           &lt;&gt; #crsSvcTechCd#
            AND PSN.PSN_CD                  = C.TECH_CD 
            AND PSN.GLBL_CMPY_CD            = C.GLBL_CMPY_CD
            AND PSN.EZCANCELFLAG            = '0'
            AND PSN.PSN_TP_CD           &lt;&gt; #cmpsDelerTp#
            AND SMM.GLBL_CMPY_CD            = B.GLBL_CMPY_CD
            AND SMM.SVC_MACH_MSTR_PK        = B.SVC_MACH_MSTR_PK
            AND SMM.EZCANCELFLAG            = '0'
            <!-- END 2023/07/06 R.Jin [CSA#61067, ADD] -->
    </statement>
</sqlMap>
