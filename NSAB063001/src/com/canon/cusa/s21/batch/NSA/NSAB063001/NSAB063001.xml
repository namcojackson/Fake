<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSAB063001">
    <statement id="getSvcMachCtacUpldWrk" parameterClass="Map" resultClass="Map">
        SELECT
             A.UPLD_CSV_RQST_PK
            ,A.UPLD_CSV_RQST_ROW_NUM
            ,A.PROC_MODE_CD
            ,DECODE(A.SVC_MACH_MSTR_PK, 0, NULL, A.SVC_MACH_MSTR_PK) AS SVC_MACH_MSTR_PK
            ,A.SER_NUM
            ,DECODE(A.CTAC_PSN_PK, 0, NULL, A.CTAC_PSN_PK)           AS CTAC_PSN_PK
            ,A.CTAC_PSN_LAST_NM
            ,A.CTAC_PSN_FIRST_NM
            ,A.DS_CTAC_PNT_TP_CD
            ,A.DS_CTAC_PNT_VAL_TXT
            ,A.DS_CTAC_PSN_EXTN_NUM
            ,A.SVC_CTAC_TP_CD
            <!-- START 2017/09/15 M.Kidokoro [QC#21030,21032, DEL] -->
            <!-- ,A.DS_CTAC_PNT_ACTV_FLG -->
            <!-- END 2017/09/15 M.Kidokoro [QC#21030,21032, DEL] -->
            <!-- START 2018/09/25 K.Kitachi [QC#27788, ADD] -->
            ,A.DS_CTAC_PNT_ACTV_FLG
            <!-- END 2018/09/25 K.Kitachi [QC#27788, ADD] -->
            ,A.EFF_FROM_DT
            ,A.EFF_THRU_DT
        FROM
            SVC_MACH_CTAC_UPLD_WRK      A
        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            AND A.UPLD_CSV_RQST_PK      = #upldCsvRqstPk#
            AND A.EZCANCELFLAG          = '0'
        ORDER BY
            A.UPLD_CSV_RQST_ROW_NUM     ASC
    </statement>
    <statement id="getSvcMachMstr" parameterClass="Map" resultClass="Map">
        SELECT
             A.SVC_MACH_MSTR_PK
            ,A.SER_NUM
            ,A.CUR_LOC_ACCT_NUM
        FROM 
            SVC_MACH_MSTR               A
        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            <isNotNull property="svcMachMstrPk">
            AND A.SVC_MACH_MSTR_PK      = #svcMachMstrPk#
            </isNotNull>
            <isNotNull property="serNum">
            AND A.SER_NUM               = #serNum#
            </isNotNull>
            AND A.EZCANCELFLAG          = '0'
    </statement>
    <!-- START 2017/09/15 M.Kidokoro [QC#21030,21032, DEL] -->
    <!-- <statement id="getActvCtacPntCnt" parameterClass="Map" resultClass="BigDecimal"> -->
        <!-- SELECT --> -->
            <!-- COUNT(B.DS_CTAC_PNT_PK)     AS CNT -->
        <!-- FROM  -->
             <!-- SVC_MACH_CTAC_PSN          A -->
            <!-- ,DS_CTAC_PNT                B -->
        <!-- WHERE -->
                <!-- A.GLBL_CMPY_CD          = #glblCmpyCd# -->
            <!-- AND A.SVC_MACH_MSTR_PK      = #svcMachMstrPk# -->
            <!-- AND A.EZCANCELFLAG          = '0' -->
            <!-- AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD -->
            <!-- AND A.DS_CTAC_PNT_PK        = B.DS_CTAC_PNT_PK -->
            <!-- AND B.EZCANCELFLAG          = '0' -->
            <!-- AND B.DS_CTAC_PNT_TP_CD     = #dsCtacPntTpCd# -->
            <!-- AND B.DS_CTAC_PNT_ACTV_FLG  = 'Y' -->
    <!-- </statement> -->
    <!-- END 2017/09/15 M.Kidokoro [QC#21030,21032, DEL] -->
    <statement id="getSvcMachCtacPsnPk" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            A.SVC_MACH_CTAC_PSN_PK
        FROM
             SVC_MACH_CTAC_PSN          A
            ,DS_CTAC_PNT                B
        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            AND A.SVC_MACH_MSTR_PK      = #svcMachMstrPk#
            AND A.EZCANCELFLAG          = '0'
            AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
            AND A.DS_CTAC_PNT_PK        = B.DS_CTAC_PNT_PK
            AND B.DS_CTAC_PNT_TP_CD     = #dsCtacPntTpCd#
            AND B.CTAC_PSN_PK           = #ctacPsnPk#
            AND B.EZCANCELFLAG          = '0'
    </statement>
    <!-- START 2017/09/19 M.Kidokoro [QC#21031, ADD] -->
    <statement id="getCtacInfo" parameterClass="Map" resultClass="Map">
        SELECT
             SMC.SVC_MACH_CTAC_PSN_PK AS SVC_MACH_CTAC_PSN_PK
            ,CPN.CTAC_PSN_LAST_NM     AS CTAC_PSN_LAST_NM
            ,CPN.CTAC_PSN_FIRST_NM    AS CTAC_PSN_FIRST_NM
            ,DCP.DS_CTAC_PNT_TP_CD    AS DS_CTAC_PNT_TP_CD
            ,DCP.DS_CTAC_PNT_VAL_TXT  AS DS_CTAC_PNT_VAL_TXT
            ,DCP.DS_CTAC_PSN_EXTN_NUM AS DS_CTAC_PSN_EXTN_NUM
            ,SMC.SVC_CTAC_TP_CD       AS SVC_CTAC_TP_CD
            ,SMC.EFF_FROM_DT          AS EFF_FROM_DT
            ,SMC.EFF_THRU_DT          AS EFF_THRU_DT
        FROM
             SVC_MACH_CTAC_PSN SMC
            ,DS_CTAC_PNT       DCP
            ,CTAC_PSN          CPN
        WHERE
                SMC.GLBL_CMPY_CD         = #glblCmpyCd#
            AND SMC.SVC_MACH_MSTR_PK     = #svcMachMstrPk#
            AND SMC.EZCANCELFLAG         = '0'
            AND SMC.GLBL_CMPY_CD         = DCP.GLBL_CMPY_CD   (+)
            AND SMC.DS_CTAC_PNT_PK       = DCP.DS_CTAC_PNT_PK (+)
            AND DCP.EZCANCELFLAG     (+) = '0'
            AND DCP.GLBL_CMPY_CD         = CPN.GLBL_CMPY_CD   (+)
            AND DCP.CTAC_PSN_PK          = CPN.CTAC_PSN_PK    (+)
            AND CPN.EZCANCELFLAG     (+) = '0'
    </statement>
    <!-- END 2017/09/19 M.Kidokoro [QC#21031, ADD] -->
    <!-- START 2018/01/17 M.Naito [QC#22038, ADD] -->
    <statement id="getCtacPsnForDelyIstl" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             CP.CTAC_PSN_PK
        FROM
             CTAC_PSN         CP
            ,DS_CTAC_PSN_RELN DCPR
        WHERE
                CP.GLBL_CMPY_CD      = #glblCmpyCd#
            AND CP.CTAC_PSN_FIRST_NM = #ctacPsnFirstNm#
            AND CP.CTAC_PSN_LAST_NM  = #ctacPsnLastNm#
            AND CP.EZCANCELFLAG      = '0'
            AND CP.CTAC_PSN_PK       = DCPR.CTAC_PSN_PK
            AND DCPR.CTAC_TP_CD      = #ctacTpCd#
            AND DCPR.DS_ACCT_NUM     = #dsAcctNum#
            AND DCPR.EZCANCELFLAG    = '0'
    </statement>
    <statement id="getSvcMachCtacPsn" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             SMCP.SVC_MACH_CTAC_PSN_PK
        FROM
             SVC_MACH_CTAC_PSN SMCP
        WHERE
                SMCP.GLBL_CMPY_CD     = #glblCmpyCd#
            AND SMCP.SVC_MACH_MSTR_PK = #svcMachMstrPk#
            AND SMCP.DS_CTAC_PNT_PK   = #dsCtacPntPk#
            AND SMCP.SVC_CTAC_TP_CD   = #svcCtacTpCd#
            AND (
                    (    SMCP.EFF_FROM_DT       &gt;= #effFromDt# 
                     AND SMCP.EFF_FROM_DT &lt;= #effThruDt#
                    )
                OR  (     SMCP.EFF_FROM_DT     &lt;= #effFromDt# 
                     AND NVL(SMCP.EFF_THRU_DT, #maxDt#) &gt;= #effFromDt#
                    )
                )
            AND SMCP.EZCANCELFLAG     = '0'
    </statement>
    <!-- END 2018/01/17 M.Naito [QC#22038, ADD] -->
    <!-- START 2018/09/25 K.Kitachi [QC#27788, ADD] -->
    <statement id="getPrimErrUpldWrkInfoList" parameterClass="Map" resultClass="Map">
        SELECT
             A.UPLD_CSV_RQST_ROW_NUM
            ,A.PROC_MODE_CD
        FROM
            SVC_MACH_CTAC_UPLD_WRK A
        WHERE
                A.GLBL_CMPY_CD           = #glblCmpyCd#
            AND A.UPLD_CSV_RQST_PK       = #upldCsvRqstPk#
            AND A.DS_CTAC_PNT_ACTV_FLG   = 'Y'
            AND A.UPLD_CSV_RQST_CMNT_TXT IS NULL
            AND A.EZCANCELFLAG           = '0'
            AND EXISTS (
                SELECT
                     X.SVC_MACH_MSTR_PK
                    ,X.SVC_CTAC_TP_CD
                    ,Y.DS_CTAC_PNT_TP_CD
                FROM
                     SVC_MACH_CTAC_PSN X
                    ,DS_CTAC_PNT       Y
                WHERE
                        A.GLBL_CMPY_CD      = X.GLBL_CMPY_CD
                    AND A.SVC_MACH_MSTR_PK  = X.SVC_MACH_MSTR_PK
                    AND A.SVC_CTAC_TP_CD    = X.SVC_CTAC_TP_CD
                    AND X.DS_PRIM_LOC_FLG   = 'Y'
                    AND X.EZCANCELFLAG      = '0'
                    AND X.GLBL_CMPY_CD      = Y.GLBL_CMPY_CD
                    AND X.DS_CTAC_PNT_PK    = Y.DS_CTAC_PNT_PK
                    AND A.DS_CTAC_PNT_TP_CD = Y.DS_CTAC_PNT_TP_CD
                    AND Y.EZCANCELFLAG      = '0'
                GROUP BY
                     X.SVC_MACH_MSTR_PK
                    ,X.SVC_CTAC_TP_CD
                    ,Y.DS_CTAC_PNT_TP_CD
                HAVING
                    COUNT(*) > 1
            )
        ORDER BY
            A.UPLD_CSV_RQST_ROW_NUM
    </statement>
    <!-- END 2018/09/25 K.Kitachi [QC#27788, ADD] -->
</sqlMap>
