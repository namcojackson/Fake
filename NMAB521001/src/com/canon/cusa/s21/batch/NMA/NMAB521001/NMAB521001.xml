<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NMAB521001">

    <statement id="truncateTable" parameterClass="Map">
        TRUNCATE TABLE $tableId$
    </statement>

    <statement id="insertTrtyTrkTrtyList" parameterClass="Map">
        INSERT
            INTO TRTY_TRK_TRTY_LIST(
                SELECT
                          #tableId#             EZTABLEID   -- 'TRTY_TRK_TRTY_LIST'
                        , '0'                   EZCANCELFLAG
                        , #ezintime#            EZINTIME
                        , #ezintimezone#        EZINTIMEZONE
                        , #ezincompanycode#     EZINCOMPANYCODE
                        , #ezinuserid#          EZINUSERID
                        , #ezinaplid#           EZINAPLID
                        , #ezuptime#            EZUPTIME
                        , #ezuptimezone#        EZUPTIMEZONE
                        , #ezupcompanycode#     EZUPCOMPANYCODE
                        , #ezupuserid#          EZUPUSERID
                        , #ezupaplid#           EZUPAPLID
                        , #glblCmpyCd#          GLBL_CMPY_CD
                        , TRTY_TRK_TRTY_LIST_SQ.NEXTVAL
                        , I51.TRTY_ORG_ID
                        , DOU.ORG_CD
                        , I51.TRTY_ORG_NM
                        , I51.TRTY_BR_ID
                        , I51.TRTY_PRNT_ORG_CD
                        , SUBSTR(I51.TRTY_CRAT_BY_PSN_TXT, 1, #lenPsnCd#)
                        , SUBSTR(I51.TRTY_CRAT_TS, 1, #lenCratDt#)
                        , I51.TRTY_TRK_ORG_ID
                    FROM
                        NMAI5100_01     I51
                        , DS_ORG_UNIT   DOU
                        , ORG_STRU_TP   OST
                    WHERE
                        I51.INTERFACE_ID                        = #interfaceId#
                        AND I51.TRANSACTION_ID                  = #transactionId#
                        AND I51.EZCANCELFLAG                    = '0'
                        --
                        AND I51.TRTY_ORG_NM                     = DOU.ORG_NM(+)
                        AND DOU.GLBL_CMPY_CD(+)                 = #glblCmpyCd#
                        AND DOU.ORG_STRU_TP_CD(+)               = #orgStruTpCd#
                        AND DOU.EFF_FROM_DT(+)                  &lt;= #slsDt#
                        AND NVL(DOU.EFF_THRU_DT(+), #maxDt#)    &gt;= #slsDt#
                        AND DOU.EZCANCELFLAG(+)                 = '0'
                        --
                        AND DOU.ORG_STRU_TP_CD(+)               = OST.ORG_STRU_TP_CD
                        AND OST.GLBL_CMPY_CD                    = #glblCmpyCd#
                        AND OST.TRTY_STRU_FLG                   = 'Y'
                        AND OST.EZCANCELFLAG                    = '0'
            )
    </statement>

    <statement id="getUnholdTarget" parameterClass="Map" resultClass="BigDecimal">
        SELECT
                  RP.DS_ACCT_RVW_PROS_PK
            FROM
                DS_ACCT_RVW_PROS RP
            WHERE
                RP.GLBL_CMPY_CD         = #glblCmpyCd#
                AND RP.TRTY_TRK_HLD_FLG = 'Y'
                AND RP.EZCANCELFLAG     = '0'
                AND EXISTS (
                    SELECT
                              1 -- 'EXISTS'
                        FROM
                            TRTY_TRK_TRTY_LIST  TL
                        WHERE
                            TL.GLBL_CMPY_CD     = RP.GLBL_CMPY_CD
                            AND TL.TRTY_ORG_CD  = RP.AFT_TRTY_ORG_CD
                            AND TL.EZCANCELFLAG = '0'
                )
    </statement>

</sqlMap>
