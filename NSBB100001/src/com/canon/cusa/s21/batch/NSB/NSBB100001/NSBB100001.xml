<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSBB100001">

    <statement id="getSvcPhysMtrUpdInfoWrk" parameterClass="Map" resultClass="Map">
       SELECT
            A.EZINUSERID
           ,A.GLBL_CMPY_CD
           ,A.UPLD_CSV_RQST_PK
           ,A.UPLD_CSV_RQST_ROW_NUM
           ,A.PROC_MODE_CD
           ,A.SER_NUM
           ,A.SVC_MACH_MSTR_PK
           ,A.SVC_PHYS_MTR_READ_GRP_SQ
           ,A.MTR_LB_DESC_TXT
           ,A.DS_MTR_READ_TP_GRP_CD
           ,A.DS_MTR_READ_TP_DESC_TXT
           <!-- 2023/09/17 QC#60925 Mod Start -->
           <!-- ,A.VLD_MTR_FLG -->
           ,A.VLD_MTR_TXT
           <!-- 2023/09/17 QC#60925 Mod End -->
           ,A.MTR_READ_DT
           ,A.SVC_TASK_NUM
           ,A.DS_TEST_COPY_CLS_DESC_TXT
           ,A.READ_MTR_CNT
           ,A.MTR_ENTRY_CMNT_TXT
           ,A.UPLD_CSV_RQST_CMNT_TXT
        FROM
            SVC_PHYS_MTR_UPD_WRK A
        WHERE
            A.GLBL_CMPY_CD                 = #glblCmpyCd#
        AND A.EZCANCELFLAG                 = '0'
        AND A.UPLD_CSV_RQST_PK             = #upldCsvRqstPk#
        ORDER BY
        <!-- START 2023/10/20 N.Takatsu[QC#60925,ADD] -->
            A.SVC_MACH_MSTR_PK
        <!-- END   2023/10/20 N.Takatsu[QC#60925,ADD] -->
        <!-- START 2023/10/20 N.Takatsu[QC#60925,MOD] -->
        <!-- A.PROC_MODE_CD DESC -->
           ,A.PROC_MODE_CD DESC
        <!-- END   2023/10/20 N.Takatsu[QC#60925,MOD] -->
           <!-- 2023/09/17 QC#60925 Mod Start -->
           <!-- ,A.VLD_MTR_FLG NULLS FIRST -->
           ,A.VLD_MTR_TXT NULLS FIRST
           <!-- 2023/09/17 QC#60925 Mod End -->
        <!-- START 2023/10/20 N.Takatsu[QC#60925,DEL] -->
        <!--   ,A.SVC_MACH_MSTR_PK -->
        <!-- END   2023/10/20 N.Takatsu[QC#60925,DEL] -->
           ,A.MTR_READ_DT
           ,A.SVC_PHYS_MTR_READ_GRP_SQ
           ,A.SVC_TASK_NUM
           ,A.DS_TEST_COPY_CLS_DESC_TXT
           ,A.MTR_LB_DESC_TXT
    </statement>

    <statement id="getDsMtrReadTpGrp" parameterClass="Map" resultClass="String">
       SELECT
            A.DS_MTR_READ_TP_GRP_CD
        FROM
            DS_MTR_READ_TP_GRP A
        WHERE
            A.GLBL_CMPY_CD                 = #glblCmpyCd#
        AND A.EZCANCELFLAG                 = '0'
        AND A.DS_MTR_READ_TP_GRP_CD        = #dsMtrReadTpGrpCd#
        ORDER BY
            A.DS_MTR_READ_TP_GRP_CD
    </statement>

    <statement id="getDsMtrReadTpCd" parameterClass="Map" resultClass="String">
       SELECT
            A.DS_MTR_READ_TP_CD
        FROM
            DS_MTR_READ_TP A
        WHERE
            A.GLBL_CMPY_CD                 = #glblCmpyCd#
        AND A.EZCANCELFLAG                 = '0'
        AND A.DS_MTR_READ_TP_DESC_TXT      = #dsMtrReadTpDescTxt#
        ORDER BY
            A.DS_MTR_READ_TP_CD
    </statement>

    <statement id="getDsTestCopyCls" parameterClass="Map" resultClass="String">
       SELECT
            A.DS_TEST_COPY_CLS_CD
        FROM
            DS_TEST_COPY_CLS A
        WHERE
            A.GLBL_CMPY_CD                 = #glblCmpyCd#
        AND A.EZCANCELFLAG                 = '0'
        AND A.DS_TEST_COPY_CLS_DESC_TXT    = #dsTestCopyClsDescTxt#
        ORDER BY
            A.DS_TEST_COPY_CLS_CD
    </statement>

    <statement id="getInRead" parameterClass="Map" resultClass="Map">
       SELECT
            A.SVC_TASK_NUM
           ,A.DS_TEST_COPY_CLS_CD
           ,A.MTR_LB_CD
        FROM
            SVC_PHYS_MTR_READ A
        WHERE
            A.GLBL_CMPY_CD                 = #glblCmpyCd#
        AND A.EZCANCELFLAG                 = '0'
        AND A.SVC_MACH_MSTR_PK             = #svcMachMstrPk#
        AND A.SVC_TASK_NUM                 = #svcTaskNum#
        AND A.DS_TEST_COPY_CLS_CD          = #dsTestCopyClsCd#
        AND A.MTR_READ_DT                  &lt;= #mtrReadDt#
        AND A.VLD_MTR_FLG                  = #vldMtrFlg#
        ORDER BY
            A.SVC_TASK_NUM
           ,A.DS_TEST_COPY_CLS_CD
           ,A.MTR_LB_CD
    </statement>

    <statement id="getBeforeRead" parameterClass="Map" resultClass="Map">
       SELECT
            A.SVC_MACH_MSTR_PK
           ,A.DS_MTR_READ_TP_CD
           ,A.MTR_READ_DT
        <!-- START 2023/10/20 N.Takatsu[QC#60925,MOD] -->
        <!-- ,A.READ_MTR_CNT -->
           ,NVL(C.READ_MTR_CNT, A.READ_MTR_CNT) READ_MTR_CNT
        <!-- END   2023/10/20 N.Takatsu[QC#60925,MOD] -->
        <!-- 2023/07/07 QC#60925 Add Start -->
           ,A.CNTR_RESET_TP_CD
        <!-- 2023/07/07 QC#60925 Add End -->
           ,B.MTR_LB_DESC_TXT
        FROM
            SVC_PHYS_MTR_READ A
           ,MTR_LB            B
        <!-- START 2023/10/20 N.Takatsu[QC#60925,ADD] -->
           ,SVC_PHYS_MTR_UPD_WRK  C
        <!-- END   2023/10/20 N.Takatsu[QC#60925,ADD] -->
        WHERE
            A.GLBL_CMPY_CD                 = #glblCmpyCd#
        AND A.EZCANCELFLAG                 = '0'
        AND A.GLBL_CMPY_CD                 = B.GLBL_CMPY_CD
        AND B.EZCANCELFLAG                 = '0'
        AND A.MTR_LB_CD                    = B.MTR_LB_CD
        AND A.SVC_MACH_MSTR_PK             = #svcMachMstrPk#
        <!-- 2023/07/07 QC#60925 Del Start -->
        <!-- AND A.DS_MTR_READ_TP_CD            = #dsMtrReadTpCd# -->
        <!-- 2023/07/07 QC#60925 Del End -->
        AND A.MTR_LB_CD                    = #mtrLbCd#
        <!-- START 2023/10/20 N.Takatsu[QC#60925,DEL] -->
        <!-- AND A.VLD_MTR_FLG                  = #vldMtrFlg# -->
        <!-- END   2023/10/20 N.Takatsu[QC#60925,DEL] -->
        <!-- START 2023/10/20 N.Takatsu[QC#60925,ADD] -->
        AND A.DS_MTR_READ_TP_GRP_CD        IN (#dsMtrReadTpGrpCd_S#, #dsMtrReadTpGrpCd_SF#)
        AND A.GLBL_CMPY_CD                 = C.GLBL_CMPY_CD (+)
        AND A.SVC_PHYS_MTR_READ_GRP_SQ     = C.SVC_PHYS_MTR_READ_GRP_SQ (+)
        AND B.MTR_LB_DESC_TXT              = C.MTR_LB_DESC_TXT (+)
        AND C.UPLD_CSV_RQST_PK (+)         = #upldCsvRqstPk#
        AND C.PROC_MODE_CD (+)             = #procModeCd#
        AND C.EZCANCELFLAG (+)             = '0'
        AND (
                (
                            C.UPLD_CSV_RQST_PK  IS  NULL
                        AND A.VLD_MTR_FLG       = #vldMtrFlgY#
                )
                OR  (
                            C.UPLD_CSV_RQST_PK  IS  NOT	NULL
                        AND A.VLD_MTR_FLG       = #vldMtrFlgX#
                )
            )
        <!-- END   2023/10/20 N.Takatsu[QC#60925,ADD] -->
        <!-- 2023/07/07 QC#60925 Mod Start -->
        <!--  <isNotNull property="fromMtrReadDt"> -->
        <!--     AND A.MTR_READ_DT           &lt; #fromMtrReadDt# -->
        <!-- </isNotNull> -->
        <!-- <isNotNull property="thruMtrReadDt"> -->
        <!--     AND A.MTR_READ_DT           &gt; #thruMtrReadDt# -->
        <!--  </isNotNull> -->
        <isNotNull property="fromMtrReadDt">
            AND (
                  A.MTR_READ_DT           &lt; #fromMtrReadDt#
                  <isNotNull property="svcPhysMtrReadGrpSq">
                  OR (
                           A.MTR_READ_DT                 = #fromMtrReadDt#
                       AND A.SVC_PHYS_MTR_READ_GRP_SQ &lt; #svcPhysMtrReadGrpSq#
                     )
                 </isNotNull>
                 )
        </isNotNull>
        <isNotNull property="thruMtrReadDt">
            AND (
                  A.MTR_READ_DT           &gt; #thruMtrReadDt#
                  <isNotNull property="svcPhysMtrReadGrpSq">
                  OR (
                           A.MTR_READ_DT                 = #thruMtrReadDt#
                       AND A.SVC_PHYS_MTR_READ_GRP_SQ &gt; #svcPhysMtrReadGrpSq#
                     )
                </isNotNull>
                )
        </isNotNull>
        <!-- 2023/07/07 QC#60925 Mod End -->
        ORDER BY
            A.SVC_MACH_MSTR_PK
            <!-- 2023/07/07 QC#60925 Mod Start -->
            <!-- <isNotNull property="fromMtrReadDt"> -->
            <!--    ,A.MTR_READ_DT DESC -->
            <!-- </isNotNull> -->
            <!-- <isNotNull property="thruMtrReadDt"> -->
            <!--   ,A.MTR_READ_DT -->
            <!-- </isNotNull> -->
            <!-- ,A.MTR_LB_CD -->
           <isNotNull property="fromMtrReadDt">
               ,A.MTR_READ_DT DESC
               ,A.SVC_PHYS_MTR_READ_GRP_SQ DESC
            </isNotNull>
            <isNotNull property="thruMtrReadDt">
               ,A.MTR_READ_DT
               ,A.SVC_PHYS_MTR_READ_GRP_SQ 
            </isNotNull>
           <!-- 2023/07/07 QC#60925 Mod End -->
    </statement>

<!-- 2023/07/07 QC#60925 Del Start -->
    <!-- <statement id="getSvcPhysMtr" parameterClass="Map" resultClass="Map">  -->
       <!-- SELECT -->
            <!-- B.MTR_LB_DESC_TXT -->
        <!-- FROM -->
           <!--  SVC_PHYS_MTR      A -->
           <!-- ,MTR_LB            B -->
        <!-- WHERE -->
            <!-- A.GLBL_CMPY_CD              = #glblCmpyCd# -->
        <!-- AND A.EZCANCELFLAG              = '0' -->
        <!-- AND A.GLBL_CMPY_CD              = B.GLBL_CMPY_CD -->
        <!-- AND B.EZCANCELFLAG              = '0' -->
        <!-- AND A.MDL_MTR_LB_CD             = B.MTR_LB_CD -->
        <!-- AND A.SVC_MACH_MSTR_PK          = #svcMachMstrPk# -->
        <!-- AND B.MTR_LB_DESC_TXT           = #mtrLbDescTxt# -->
        <!-- ORDER BY -->
            <!-- A.SVC_MACH_MSTR_PK -->
           <!-- ,A.MDL_MTR_LB_CD -->
    <!--  </statement> -->
<!-- 2023/07/07 QC#60925 Del End -->

    <statement id="getInMeterCount" parameterClass="Map" resultClass="Map">
        SELECT
            READ_MTR_CNT
        FROM
            SVC_PHYS_MTR_READ       A
        WHERE
                A.GLBL_CMPY_CD              = #glblCmpyCd#
            AND A.EZCANCELFLAG              = '0'
            AND A.SVC_PHYS_MTR_PK           = #svcPhysMtrPk#
            AND A.DS_MTR_READ_TP_GRP_CD     IN (#dsMtrReadTpGrpCd_S#, #dsMtrReadTpGrpCd_SF#)
            AND A.SVC_TASK_NUM              = #svcTaskNum#
            AND A.VLD_MTR_FLG               = #vldMtrFlg#
            AND A.DS_TEST_COPY_CLS_CD       = #dsTestCopyClsCd#
            AND A.MTR_READ_DT               &lt;= #mtrReadDt#
        ORDER BY
             A.MTR_READ_DT              DESC
            ,A.SVC_PHYS_MTR_READ_GRP_SQ DESC
    </statement>

    <!-- 2023/07/07 QC#60925 Add Start -->
    <statement id="getSvcTask" parameterClass="Map" resultClass="Map">
        SELECT
            A.SVC_TASK_NUM
        FROM
            SVC_TASK       A
        WHERE
                A.GLBL_CMPY_CD              = #glblCmpyCd#
            AND A.EZCANCELFLAG              = '0'
            AND A.SVC_TASK_NUM              = #svcTaskNum#
            AND A.SVC_MACH_MSTR_PK          = #svcMachMstrPk#
    </statement>

    <statement id="getSvcPhysMtrReadGrpSqError" parameterClass="Map" resultClass="Map">
        SELECT
            A.SVC_TASK_NUM
        FROM
            SVC_PHYS_MTR_READ       A
        WHERE
                A.GLBL_CMPY_CD              = #glblCmpyCd#
            AND A.EZCANCELFLAG              = '0'
            AND A.SVC_PHYS_MTR_READ_GRP_SQ  = #svcPhysMtrReadGrpSq#
            AND A.DS_MTR_READ_TP_GRP_CD     IN (#dsMtrReadTpGrpCd_S#, #dsMtrReadTpGrpCd_SF#)
    </statement>

    <statement id="getCarryOverMtr" parameterClass="Map" resultClass="Map">
    SELECT
            SPM.MDL_MTR_LB_CD
           ,SPM.SVC_PHYS_MTR_PK
        FROM
            SVC_PHYS_MTR SPM
        WHERE
                SPM.GLBL_CMPY_CD    = #glblCmpyCd#
            AND SPM.SVC_MACH_MSTR_PK= #svcMachMstrPk#
            AND SPM.EZCANCELFLAG    = '0'
            AND (
                EXISTS (
                    SELECT
                        1
                    FROM
                        DS_MDL_MTR DMM
                    WHERE
                            SPM.GLBL_CMPY_CD      = DMM.GLBL_CMPY_CD
                        AND SPM.MTR_GRP_PK        = DMM.MTR_GRP_PK
                        AND SPM.MDL_MTR_LB_CD     = DMM.MDL_MTR_LB_CD
                        AND DMM.TECH_READ_MND_FLG = 'Y'
                        AND DMM.EZCANCELFLAG      = '0'
                    )
                OR
                EXISTS (
                    SELECT
                        1
                    FROM
                         CONTR_PHYS_BLLG_MTR_RELN A
                        ,DS_CONTR_BLLG_MTR        B
                        ,DS_CONTR_DTL             C
                        ,DS_CONTR_DTL_STS_V       D
                    WHERE
                            SPM.GLBL_CMPY_CD       = A.GLBL_CMPY_CD
                        AND SPM.SVC_MACH_MSTR_PK   = A.MACH_MSTR_PK
                        AND SPM.SVC_PHYS_MTR_PK    = A.SVC_PHYS_MTR_PK
                        AND A.BLLBL_FLG            = 'Y'
                        AND A.ACTV_FLG             = 'Y'
                        AND A.EZCANCELFLAG         = '0'
                        AND A.GLBL_CMPY_CD         = B.GLBL_CMPY_CD
                        AND A.DS_CONTR_BLLG_MTR_PK = B.DS_CONTR_BLLG_MTR_PK
                        AND B.EZCANCELFLAG         = '0'
                        AND B.GLBL_CMPY_CD         = C.GLBL_CMPY_CD
                        AND B.DS_CONTR_DTL_PK      = C.DS_CONTR_DTL_PK
                        AND C.EZCANCELFLAG         = '0' 
                        AND C.GLBL_CMPY_CD         = D.GLBL_CMPY_CD
                        AND C.DS_CONTR_DTL_PK      = D.DS_CONTR_DTL_PK
                        AND D.EZCANCELFLAG         = '0'
                    )
                )
    </statement>
    <!-- 2023/07/07 QC#60925 Add End -->
</sqlMap>

