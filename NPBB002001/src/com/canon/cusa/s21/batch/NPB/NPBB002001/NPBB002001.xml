<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NPBB002001">
    <statement id="search" parameterClass="Map" resultClass="Map">
        SELECT
            R.RTL_WH_CD
            ,R.RTL_SWH_CD
            ,R.RTRN_CTRL_TP_CD
            ,R.PRCH_REQ_APVL_STS_CD
            ,R.PRCH_REQ_TP_CD
            ,R.PRCH_GRP_CD
            ,R.INVTY_AVAL_QTY
            ,R.MDSE_CD
            ,R.RTRN_TO_PRNT_VND_CD
            ,R.RTRN_TO_VND_CD
            ,R.INVTY_LOC_CD
            ,R.STK_STS_CD
        FROM
        (
            SELECT
                AUPRR.RTL_WH_CD AS RTL_WH_CD
                ,AUPRR.RTL_SWH_CD AS RTL_SWH_CD
                ,AUPRR.RTRN_CTRL_TP_CD AS RTRN_CTRL_TP_CD
                ,AUPRR.PRCH_REQ_APVL_STS_CD AS PRCH_REQ_APVL_STS_CD
                ,AUPRR.PRCH_REQ_TP_CD AS PRCH_REQ_TP_CD
                ,AUPRR.PRCH_GRP_CD AS PRCH_GRP_CD
                ,RW.INVTY_ACCT_CD AS INVTY_ACCT_CD
                ,IO.CMPY_INVTY_FLG AS CMPY_INVTY_FLG
                ,IV.INVTY_AVAL_QTY AS INVTY_AVAL_QTY
                ,MDSE.MDSE_CD AS MDSE_CD
                ,MDSE.RTRN_TO_PRNT_VND_CD AS RTRN_TO_PRNT_VND_CD
                ,MDSE.RTRN_TO_VND_CD AS RTRN_TO_VND_CD
                ,CASE
                    WHEN SWH.MDSE_INVTY_COST_PCT IS NULL THEN 0
                    WHEN SWH.MDSE_INVTY_COST_PCT = 0 THEN 1
                    WHEN SWH.MDSE_COST_TP_CD = #mdseCostTpStandard# AND MDSE.THIS_MTH_TOT_STD_COST_AMT = 0 THEN 1
                    WHEN SWH.MDSE_COST_TP_CD = #mdseCostTpAssetRecovery# AND MDSE.ASSET_RECOV_COST_AMT = 0 THEN 1
                    ELSE 0
                 END AS FLG
                ,RS.INVTY_LOC_CD
                ,IV.STK_STS_CD
            FROM
                AUTO_USED_PRT_RTRN_RQST AUPRR
                ,RTL_SWH RS
                ,SWH SWH
                ,RTL_WH RW
                ,INVTY_OWNR IO
                ,INVTY IV
                ,MDSE MDSE
            WHERE
                    AUPRR.GLBL_CMPY_CD = #glblCmpyCd#
                        <iterate property="rtrnCtrlTpCdList" var="rtrnCtrlTpCd[]" open="AND AUPRR.RTRN_CTRL_TP_CD IN (" close=")" conjunction=",">
                            #rtrnCtrlTpCd[]#
                        </iterate>
                AND AUPRR.EZCANCELFLAG = '0'
                AND AUPRR.GLBL_CMPY_CD = RS.GLBL_CMPY_CD
                AND AUPRR.RTL_WH_CD = RS.RTL_WH_CD
                AND AUPRR.RTL_SWH_CD = RS.RTL_SWH_CD
                AND RS.EFF_FROM_DT &lt;= #effFromDt#
                AND NVL(RS.EFF_THRU_DT, '99991231') &gt;= #effThruDt#
                AND RS.EZCANCELFLAG = '0'
                AND AUPRR.GLBL_CMPY_CD = SWH.GLBL_CMPY_CD(+)
                AND AUPRR.RTL_SWH_CD = SWH.RTL_SWH_CD(+)
                AND SWH.EZCANCELFLAG(+) = '0'
                AND AUPRR.GLBL_CMPY_CD = RW.GLBL_CMPY_CD
                AND AUPRR.RTL_WH_CD = RW.RTL_WH_CD
                AND RW.EZCANCELFLAG = '0'
                AND RW.GLBL_CMPY_CD = IO.GLBL_CMPY_CD
                AND RW.INVTY_OWNR_CD = IO.INVTY_OWNR_CD
                AND IO.EZCANCELFLAG = '0'
                AND RS.GLBL_CMPY_CD = IV.GLBL_CMPY_CD
                AND RS.INVTY_LOC_CD = IV.INVTY_LOC_CD
                AND IV.LOC_STS_CD = #locStsCd#
                AND IV.INVTY_AVAL_QTY &gt; 0
                AND IV.EZCANCELFLAG = '0'
                AND IV.GLBL_CMPY_CD = MDSE.GLBL_CMPY_CD
                AND IV.MDSE_CD = MDSE.MDSE_CD
                AND AUPRR.PRCH_GRP_CD = MDSE.PRCH_GRP_CD
                AND AUPRR.RTRN_CTRL_TP_CD = MDSE.RTRN_CTRL_TP_CD
                AND MDSE.MDSE_ITEM_STS_CD &lt;&gt; #mdseItemStsCd#
                AND MDSE.EZCANCELFLAG = '0'
        ) R
        WHERE
                R.CMPY_INVTY_FLG = #cmpyInvtyFlg#
            OR  R.INVTY_ACCT_CD = #invtyAcctCd#
            OR  R.FLG = 1
        ORDER BY
         R.RTRN_CTRL_TP_CD
        ,R.RTL_WH_CD
        ,R.RTRN_TO_VND_CD
    </statement>
</sqlMap>
