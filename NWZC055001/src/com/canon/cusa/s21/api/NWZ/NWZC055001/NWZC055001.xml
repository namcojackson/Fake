<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NWZC055001">

<!-- #################### Type Alias #################### -->
    <typeAlias alias="AJE_INV_LINE_ALLOCTMsg" type="business.db.AJE_INV_LINE_ALLOCTMsg"/>
    <typeAlias alias="DS_CPO_SLS_CRTMsg" type="business.db.DS_CPO_SLS_CRTMsg"/>
    <typeAlias alias="CPO_DTLTMsg" type="business.db.CPO_DTLTMsg"/>
    <typeAlias alias="DfrdRevSetupData" type="com.canon.cusa.s21.api.NWZ.NWZC055001.DfrdRevSetupData"/>


    <statement id="queryAJE_INV_LINE_ALLOC" parameterClass="Map" resultMap="result.queryAJE_INV_LINE_ALLOC">
        SELECT
             AJE_INV_LINE_ALLOC_CD
            ,EQUIP_ALLOC_PCT
            ,SVC_ALLOC_PCT
            ,SPLY_ALLOC_PCT
            ,SVC_COA_CC_CD
            ,SPLY_COA_CC_CD
            <!-- QC#17116 del Start -->
            <!-- ,SPLY_LFS_COA_CC_CD -->
            <!-- ,SPLY_PPS_COA_CC_CD -->
            <!-- ,SPLY_ESS_COA_CC_CD -->
            <!-- QC#17116 del End -->
            ,EQUIP_COA_ACCT_CD
            <!-- QC#17116 del Start -->
            <!-- ,SVC_COA_ACCT_CD -->
            <!-- ,SPLY_COA_ACCT_CD -->
            <!-- QC#17116 del End -->
            ,EQUIP_ACCTG_RULE_CD
            ,SVC_ACCTG_RULE_CD
            ,SPLY_ACCTG_RULE_CD
            ,EQUIP_TRX_CD
            ,EQUIP_TRX_RSN_CD
            ,SVC_TRX_CD
            ,SVC_TRX_RSN_CD
            ,SPLY_TRX_CD
            ,SPLY_TRX_RSN_CD
        FROM
            AJE_INV_LINE_ALLOC
        WHERE
            GLBL_CMPY_CD    = #glblCmpyCd#
        AND EZCANCELFLAG    = '0'
        AND SVC_ALLOC_TP_CD = #svcAllocTpCd#
        AND SVC_INV_CHRG_TP_CD IS NULL
    </statement>

    <resultMap id="result.queryAJE_INV_LINE_ALLOC" class="AJE_INV_LINE_ALLOCTMsg">
        <result property="ajeInvLineAllocCd"    column="AJE_INV_LINE_ALLOC_CD"    javaType="EZDTStringItem"/>
        <result property="equipAllocPct"        column="EQUIP_ALLOC_PCT"        javaType="EZDTBigDecimalItem"/>
        <result property="svcAllocPct"            column="SVC_ALLOC_PCT"            javaType="EZDTBigDecimalItem"/>
        <result property="splyAllocPct"            column="SPLY_ALLOC_PCT"            javaType="EZDTBigDecimalItem"/>
        <result property="svcCoaCcCd"            column="SVC_COA_CC_CD"            javaType="EZDTStringItem"/>
        <result property="splyCoaCcCd"            column="SPLY_COA_CC_CD"            javaType="EZDTStringItem"/>
<!-- QC#17116 del Start -->
<!--         <result property="splyLfsCoaCcCd"        column="SPLY_LFS_COA_CC_CD"        javaType="EZDTStringItem"/> -->
<!--         <result property="splyPpsCoaCcCd"        column="SPLY_PPS_COA_CC_CD"        javaType="EZDTStringItem"/> -->
<!--         <result property="splyEssCoaCcCd"        column="SPLY_ESS_COA_CC_CD"        javaType="EZDTStringItem"/> -->
<!-- QC#17116 del End -->
        <result property="equipCoaAcctCd"        column="EQUIP_COA_ACCT_CD"        javaType="EZDTStringItem"/>
<!-- QC#17116 del Start -->
<!--         <result property="svcCoaAcctCd"            column="SVC_COA_ACCT_CD"        javaType="EZDTStringItem"/> -->
<!--         <result property="splyCoaAcctCd"        column="SPLY_COA_ACCT_CD"        javaType="EZDTStringItem"/> -->
<!-- QC#17116 del End -->
        <result property="equipAcctgRuleCd"        column="EQUIP_ACCTG_RULE_CD"    javaType="EZDTStringItem"/>
        <result property="svcAcctgRuleCd"        column="SVC_ACCTG_RULE_CD"        javaType="EZDTStringItem"/>
        <result property="splyAcctgRuleCd"        column="SPLY_ACCTG_RULE_CD"        javaType="EZDTStringItem"/>
        <result property="equipTrxCd"            column="EQUIP_TRX_CD"            javaType="EZDTStringItem"/>
        <result property="equipTrxRsnCd"        column="EQUIP_TRX_RSN_CD"        javaType="EZDTStringItem"/>
        <result property="svcTrxCd"                column="SVC_TRX_CD"                javaType="EZDTStringItem"/>
        <result property="svcTrxRsnCd"            column="SVC_TRX_RSN_CD"            javaType="EZDTStringItem"/>
        <result property="splyTrxCd"            column="SPLY_TRX_CD"            javaType="EZDTStringItem"/>
        <result property="splyTrxRsnCd"            column="SPLY_TRX_RSN_CD"        javaType="EZDTStringItem"/>
    </resultMap>

    <statement id="queryDS_CPO_SLS_CR" parameterClass="Map" resultMap="result.queryDS_CPO_SLS_CR">
        SELECT
             CR.SLS_REP_TOC_CD
            ,CR.SLS_REP_ROLE_TP_CD
            ,CR.SLS_REP_CR_PCT
        FROM
             DS_CPO_SLS_CR CR
             <!-- 2017/09/14 S21_NA#21097 Add Start -->
             <isNotNull property="dsOrdPosnNum">
             ,DS_CPO_CONFIG DCC
             </isNotNull>
             <!-- 2017/09/14 S21_NA#21097 End Start -->
        WHERE
            CR.GLBL_CMPY_CD           = #glblCmpyCd#
        AND CR.CPO_ORD_NUM            = #cpoOrdNum#
        AND CR.SLS_REP_CR_PCT         is not null
        AND CR.SLS_CR_QUOT_FLG        = #slsCrQuotFlg#
        <isNotNull property="dsOrdPosnNum">
        AND CR.DS_ORD_POSN_NUM        = #dsOrdPosnNum#
        <!-- 2017/09/14 S21_NA#21097 Add Start -->
        AND CR.GLBL_CMPY_CD           = DCC.GLBL_CMPY_CD
        AND CR.DS_CPO_CONFIG_PK       = DCC.DS_CPO_CONFIG_PK
        AND DCC.CONFIG_CATG_CD         = #dsOrdLineDrctnCd#
        AND DCC.EZCANCELFLAG          = '0'
        <!-- 2017/09/14 S21_NA#21097 Add End -->
        </isNotNull>
        <isNull property="dsOrdPosnNum">
        AND CR.DS_ORD_POSN_NUM        IS NULL
        </isNull>
        AND CR.EZCANCELFLAG           = '0'
    </statement>

    <resultMap id="result.queryDS_CPO_SLS_CR" class="DS_CPO_SLS_CRTMsg">
        <result property="slsRepTocCd"            column="SLS_REP_TOC_CD"            javaType="EZDTStringItem"/>
        <result property="slsRepRoleTpCd"        column="SLS_REP_ROLE_TP_CD"        javaType="EZDTStringItem"/>
        <result property="slsRepCrPct"            column="SLS_REP_CR_PCT"            javaType="EZDTBigDecimalItem"/>
    </resultMap>

    <statement id="getSVC_REV_TRNSF_AMT" parameterClass="Map" resultMap="result.getSVC_REV_TRNSF_AMT">
        SELECT
             C.FUNC_SVC_REV_TRNSF_AMT
            ,C.DEAL_SVC_REV_TRNSF_AMT
        FROM
             CPO_DTL C
        WHERE
            C.GLBL_CMPY_CD            = #glblCmpyCd#
        AND C.CPO_ORD_NUM             = #cpoOrdNum#
        AND C.CPO_DTL_LINE_NUM        = #cpoDtlLineNum#
        AND C.CPO_DTL_LINE_SUB_NUM    = #cpoDtlLineSubNum#
        AND C.EZCANCELFLAG            = '0'
        AND C.FUNC_SVC_REV_TRNSF_AMT  is not null
        AND C.FUNC_SVC_REV_TRNSF_AMT  != 0
        AND C.EZCANCELFLAG            = '0'
        AND NOT EXISTS (
            SELECT *
            FROM
                DS_INV_SLS_CR CR
            WHERE
                CR.GLBL_CMPY_CD       = #glblCmpyCd#
            AND CR.INV_NUM            = #invNum#
            AND CR.INV_BOL_LINE_NUM   = #invBolLineNum#
            AND CR.INV_LINE_NUM       = #invLineNum#
            AND CR.INV_LINE_SUB_NUM   = #invLineSubNum#
            AND CR.INV_LINE_SPL_TP_CD IN (#invLineSplTpDeviation#, #invLineSplTpAllocation#)
            AND CR.EZCANCELFLAG       = '0'
        )
    </statement>

    <resultMap id="result.getSVC_REV_TRNSF_AMT" class="CPO_DTLTMsg">
        <result property="funcSvcRevTrnsfAmt"   column="FUNC_SVC_REV_TRNSF_AMT"  javaType="EZDTBigDecimalItem"/>
        <result property="dealSvcRevTrnsfAmt"   column="DEAL_SVC_REV_TRNSF_AMT"  javaType="EZDTBigDecimalItem"/>
    </resultMap>
    
    <statement id="getDfrdSetupInfo" parameterClass="Map" resultMap="result.getDfrdRevSetupData">
      SELECT BC.BLLG_CYCLE_MTH_AOT
            <!-- QC#19186 mod Start
            ,DECODE(CD.CONTR_EFF_FROM_DT, NULL, NULL, TO_CHAR(TO_DATE(CD.CONTR_EFF_FROM_DT), 'YYYY/MM/DD')) AS CONTR_EFF_FROM_DT
            ,DECODE(CD.CONTR_EFF_THRU_DT, NULL, NULL, TO_CHAR(TO_DATE(CD.CONTR_EFF_THRU_DT), 'YYYY/MM/DD')) AS CONTR_EFF_THRU_DT
             -->
            ,DECODE(CD.CONTR_EFF_FROM_DT, NULL, NULL, TO_CHAR(TO_DATE(CD.CONTR_EFF_FROM_DT, 'YYYYMMDD'), 'YYYY/MM/DD')) AS CONTR_EFF_FROM_DT
            ,DECODE(CD.CONTR_EFF_THRU_DT, NULL, NULL, TO_CHAR(TO_DATE(CD.CONTR_EFF_THRU_DT, 'YYYYMMDD'), 'YYYY/MM/DD')) AS CONTR_EFF_THRU_DT
            <!-- QC#19186 mod ENd -->
            ,DAR.DFRD_REV_FLG
            ,DAR.FIX_DURN_FLG
            ,DAR.DFRD_ACCTG_RULE_DURN_AOT
        FROM INV_LINE        IL
            ,DS_CONTR_DTL    CD
            ,BLLG_CYCLE      BC
            ,DFRD_ACCTG_RULE DAR
       WHERE  IL.GLBL_CMPY_CD         = #glblCmpyCd#
          AND IL.EZCANCELFLAG         = '0'
          AND IL.GLBL_CMPY_CD         = CD.GLBL_CMPY_CD(+)
          AND IL.EZCANCELFLAG         = CD.EZCANCELFLAG(+)
          AND CD.GLBL_CMPY_CD         = BC.GLBL_CMPY_CD(+)
          AND CD.EZCANCELFLAG         = BC.EZCANCELFLAG(+)
          AND IL.INV_NUM              = #invNum#
          AND IL.INV_BOL_LINE_NUM     = #bolLineNum#
          AND IL.INV_LINE_NUM         = #invLineNum#
          AND IL.INV_LINE_SUB_NUM     = #invLineSubNum#
          AND IL.INV_LINE_SUB_TRX_NUM = #invLineSubTrxNum#
            AND IL.DS_CONTR_DTL_PK      = CD.DS_CONTR_DTL_PK(+)
            AND CD.BASE_BLLG_CYCLE_CD   = BC.BLLG_CYCLE_CD(+)
            AND IL.GLBL_CMPY_CD         = DAR.GLBL_CMPY_CD(+)
          AND IL.EZCANCELFLAG         = DAR.EZCANCELFLAG(+)
          AND #acctgRule#             = DAR.DFRD_ACCTG_RULE_CD(+)
    </statement>
    
    <resultMap id="result.getDfrdRevSetupData" class="DfrdRevSetupData">
        <result property="bllgCycleMthAot"   column="BLLG_CYCLE_MTH_AOT"  javaType="BigDecimal"/>
        <result property="contrEffFromDt"   column="CONTR_EFF_FROM_DT"  javaType="String"/>
        <result property="contrEffThruDt"   column="CONTR_EFF_THRU_DT"  javaType="String"/>
        <result property="dfrdRevFlg"   column="DFRD_REV_FLG"  javaType="String"/>
        <result property="fixDurnFlg"   column="FIX_DURN_FLG"  javaType="String"/>
        <result property="dfrdAcctgRuleDurnAot"   column="DFRD_ACCTG_RULE_DURN_AOT"  javaType="BigDecimal"/>
    </resultMap>

    <statement id="getDsInvSlsCrPk" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             CR.DS_INV_SLS_CR_PK
        FROM
             DS_INV_SLS_CR CR
        WHERE
            CR.GLBL_CMPY_CD        = #glblCmpyCd#
        AND CR.INV_NUM             = #invNum#
        AND CR.INV_BOL_LINE_NUM    = #invBolLineNum#
        AND CR.INV_LINE_NUM        = #invLineNum#
        AND CR.INV_LINE_SUB_NUM    = #invLineSubNum#
        <isNotNull property="invLineSplTpCd">
        AND CR.INV_LINE_SPL_TP_CD  = #invLineSplTpCd#
        </isNotNull>
        <isNull property="invLineSplTpCd">
        AND CR.INV_LINE_SPL_TP_CD  IS NULL
        </isNull>
        <isNotNull property="slsRepTocCd">
        AND CR.SLS_REP_TOC_CD      = #slsRepTocCd#
        </isNotNull>
        <isNull property="slsRepTocCd">
        AND CR.SLS_REP_TOC_CD      IS NULL
        </isNull>
        <!-- 2017/09/14 S21_NA#21097 Add Start -->
        <isNotNull property="slsRepRoleTpCd">
        AND CR.SLS_REP_ROLE_TP_CD  = #slsRepRoleTpCd#
        </isNotNull>
        <!-- 2017/09/14 S21_NA#21097 Add End -->
        AND CR.EZCANCELFLAG        = '0'
    </statement>
</sqlMap>
