<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSBB089001">

    <statement id="getTrgtYrMth" parameterClass="Map" resultClass="String">
        SELECT
            CAL.DWH_TRGT_YR_MTH
        FROM
            DMN_RPT_CAL              CAL
        WHERE 
            CAL.GLBL_CMPY_CD         = #glblCmpyCd#
        AND CAL.DWH_TRGT_DT          = #trgtDt#
        AND CAL.EZCANCELFLAG         = '0'
    </statement>

    <statement id="getTrgtYrMthRec" parameterClass="Map" resultClass="BigDecimal">
        SELECT COUNT(1)
        FROM
            FCT_MLY_FSR              FSR
        WHERE 
            FSR.GLBL_CMPY_CD         = #glblCmpyCd#
        AND FSR.DWH_TRGT_YR_MTH      = #trgtYrMth#
        AND FSR.EZCANCELFLAG         = '0'
    </statement>

    <statement id="getAhs" parameterClass="Map" resultClass="Map">
        SELECT
            AHS_CD
           ,AHS_SUN_FROM_TM               AS SUN_FROM
           ,AHS_SUN_TO_TM                 AS SUN_THRU
           ,AHS_MON_FROM_TM               AS MON_FROM
           ,AHS_MON_TO_TM                 AS MON_THRU
           ,AHS_TUE_FROM_TM               AS TUE_FROM
           ,AHS_TUE_TO_TM                 AS TUE_THRU
           ,AHS_WED_FROM_TM               AS WED_FROM
           ,AHS_WED_TO_TM                 AS WED_THRU
           ,AHS_THU_FROM_TM               AS THU_FROM
           ,AHS_THU_TO_TM                 AS THU_THRU
           ,AHS_FRI_FROM_TM               AS FRI_FROM
           ,AHS_FRI_TO_TM                 AS FRI_THRU
           ,AHS_SAT_FROM_TM               AS SAT_FROM
           ,AHS_SAT_TO_TM                 AS SAT_THRU
        FROM
            AHS                           AHS
        WHERE
            AHS.GLBL_CMPY_CD              = #glblCmpyCd#
        AND AHS.EZCANCELFLAG              = '0'
        ORDER BY AHS.AHS_CD
    </statement>

    <statement id="getPrcShift" parameterClass="Map" resultClass="Map">
        SELECT
            SVC_LINE_BIZ_CD
           ,SVC_PRC_MON_START_VAL_TXT     AS MON_FROM
           ,SVC_PRC_MON_END_VAL_TXT       AS MON_THRU
           ,SVC_PRC_TUE_START_VAL_TXT     AS TUE_FROM
           ,SVC_PRC_TUE_END_VAL_TXT       AS TUE_THRU
           ,SVC_PRC_WED_START_VAL_TXT     AS WED_FROM
           ,SVC_PRC_WED_END_VAL_TXT       AS WED_THRU
           ,SVC_PRC_THU_START_VAL_TXT     AS THU_FROM
           ,SVC_PRC_THU_END_VAL_TXT       AS THU_THRU
           ,SVC_PRC_FRI_START_VAL_TXT     AS FRI_FROM
           ,SVC_PRC_FRI_END_VAL_TXT       AS FRI_THRU
           ,SVC_PRC_SAT_START_VAL_TXT     AS SAT_FROM
           ,SVC_PRC_SAT_END_VAL_TXT       AS SAT_THRU
           ,SVC_PRC_SUN_START_VAL_TXT     AS SUN_FROM
           ,SVC_PRC_SUN_END_VAL_TXT       AS SUN_THRU
        FROM
            SVC_PRC_SHIFT                 PRC
        WHERE
            PRC.GLBL_CMPY_CD              = #glblCmpyCd#
        AND PRC.SVC_PRC_SHIFT_AHS_FLG     = 'N'
        AND PRC.EZCANCELFLAG              = '0'
    </statement>

    <statement id="getMainData" parameterClass="Map" resultClass="Map">
        SELECT
            FSR.FSR_NUM
           ,CASE WHEN FSR.FSR_STS_CD NOT IN (#saved#, #comleted#, #pendingCharge#, #closed#, #cancelled#, #debriefError#) THEN 'Y' ELSE 'N' END AS FSR_OPEN_FLG
           ,FSR.FSR_TP_CD
           ,FSR.SVC_CALL_SRC_TP_CD
           ,FSR.SVC_CALL_AVOID_CD
           ,FSR.SVC_CALL_RQST_OWNR_TOC_CD
           ,FSR.SVC_CALL_INCDT_DT
           ,FSR.SVC_CALL_INCDT_TM
           ,FSR.FSR_CRAT_DT
           ,FSR.FSR_CRAT_TM
           ,FSR.FSR_CPLT_DT
           ,FSR.FSR_CPLT_TM
           ,FSR.FSR_CLO_DT
           ,FSR.FSR_CLO_TM
           ,FSR.FSR_CPLT_DT || FSR_CPLT_TM                            AS FSR_CPLT_DTM
           ,FSR.SVC_MACH_MSTR_PK
           ,FSR.SER_NUM
           ,FSR.PBLM_SMRY_TXT
           ,TSK.DS_SVC_CALL_TP_CD
           ,TSK.MACH_DOWN_FLG
           ,SUBSTR(TSK.ERL_START_TS, 0, #ymdtsLen#)                   AS ERL_START_TS
           ,FVT.SVC_PBLM_TP_CD
           ,FVT.SVC_PBLM_LOC_TP_CD
           ,FVT.SVC_PBLM_RSN_TP_CD
           ,FVT.SVC_PBLM_CRCT_TP_CD
           ,NVL(FVT.CPLT_BY_TEL_FIX_FLG, 'N')                         AS CPLT_BY_PHO_FIX_FLG
           ,VIS.SVC_INV_NUM
           ,VIS.INV_DT
           ,VIS.TECH_CD
           ,VIS.FSR_VISIT_ARV_DT
           ,VIS.FSR_VISIT_ARV_TM
           ,MAC.SVC_CONFIG_MSTR_PK
           ,MAC.MDSE_CD
           ,MAC.CUR_LOC_ACCT_NUM
           ,MAC.CUR_LOC_NUM
           ,MAC.IND_CUR_LOC_NUM
           ,MAC.DS_KEY_ACCT_FLG
           ,MAC.ISTL_DT
           ,MAC.SVC_BY_LINE_BIZ_TP_CD
           ,NVL(T_FLG.TM_AND_MAT_FLG, 'Y')                            AS TM_AND_MAT_FLG
           ,ACC.DS_ACCT_NM                                            AS CUR_LOC_ACCT_NM
           ,AGA.DS_ACCT_GRP_CD                                        AS DS_ACCT_GRP_CD
           ,ACG.DS_ACCT_GRP_NM                                        AS DS_ACCT_GRP_NM
           ,SHP.FIRST_LINE_ADDR
           ,SHP.SCD_LINE_ADDR
           ,SHP.THIRD_LINE_ADDR
           ,SHP.FRTH_LINE_ADDR
           ,SHP.CTY_ADDR
           ,SHP.CNTY_PK
           ,SHP.PROV_NM
           ,SHP.ST_CD
           ,SHP.POST_CD
           ,SHP.CTRY_CD
           ,CHG.SVC_LBOR_DEAL_AMT
           ,CHG.SVC_LBOR_FUNC_AMT
           ,CHG.SVC_LBOR_DEAL_DISC_AMT
           ,CHG.SVC_LBOR_FUNC_DISC_AMT
           ,CHG.SVC_TRVL_DEAL_AMT
           ,CHG.SVC_TRVL_FUNC_AMT
           ,CHG.SVC_TRVL_DEAL_DISC_AMT
           ,CHG.SVC_TRVL_FUNC_DISC_AMT
           ,CHG.SVC_PRT_DEAL_AMT
           ,CHG.SVC_PRT_FUNC_AMT
           ,CHG.SVC_PRT_DEAL_DISC_AMT
           ,CHG.SVC_PRT_FUNC_DISC_AMT
           ,CHG.ORIG_INV_CCY_CD
           ,CHG.INV_CCY_CD
           ,V_CNT.FSR_TOT_VISIT_CNT
           ,CASE WHEN V_CNT.FSR_TOT_VISIT_CNT = #cntOne# AND FSR_CLO_DT IS NOT NULL          THEN 'Y' ELSE 'N' END AS FIRST_VISIT_CPLT_FLG
           ,CASE WHEN V_CNT.PRT_RSCHD_CNT > 0                                                THEN 'Y' ELSE 'N' END AS PRT_RSCHD_FLG
           ,CASE WHEN V_CNT.SVC_RCLL_CNT > 0                                                 THEN 'Y' ELSE 'N' END AS RCLL_FSR_FLG
           ,V_AOT.FSR_TOT_LBOR_AOT
           ,V_AOT.FSR_TOT_TRVL_AOT
           ,S_AOT.FSR_TOT_ITRPT_AOT
           ,U_AOT.FSR_TOT_PRT_COST_AMT
           ,M_CNT.BW_READ_MTR_CNT
           ,M_CNT.COLOR_READ_MTR_CNT
           ,M_CNT.TOT_READ_MTR_CNT
           ,M_CNT.MTR_READ_DT
           ,NVL(MDL_1.MDL_ID, MDL_2.MDL_ID)                                                  AS MDL_ID
           ,NVL(MDL_1.MDL_GRP_ID, MDL_2.MDL_GRP_ID)                                          AS MDL_GRP_ID
           ,NVL(RSP_1.TRGT_SVC_RSP_AOT, NVL(RSP_2.TRGT_SVC_RSP_AOT, NVL(MDL_1.RSP_TM_UP_MN_AOT, MDL_2.RSP_TM_UP_MN_AOT))) AS TRGT_SVC_RSP_AOT
           ,NVL(AHS_1.AHS_CD, AHS_2.AHS_CD)                                                  AS AHS_CD
           ,NVL(CST.RPT_COND_CONST_VAL_NUM_01, 0)                                            AS RPT_COND_CONST_VAL_NUM_01
           ,NVL(CST.RPT_COND_CONST_VAL_NUM_02, 0)                                            AS RPT_COND_CONST_VAL_NUM_02
        FROM
            FSR                     FSR
           ,SVC_TASK                TSK
           ,FSR_VISIT               VIS
           ,FSR_CHRG                CHG
           ,FSR_VISIT_TASK          FVT
           ,SVC_MACH_MSTR           MAC
           ,SHIP_TO_CUST            SHP
           ,SELL_TO_CUST            ACC
           ,DS_ACCT_GRP_ASG         AGA
           ,DS_ACCT_GRP             ACG
           ,RPT_COND_CONST          CST
           ,(
               SELECT
                   FSR.FSR_NUM
                  <!-- START 2018/09/26 W.Honda [QC#28381,MOD] -->
                  <!-- ,SUM(CASE WHEN TSK.DS_SVC_CALL_TP_CD NOT IN (#phone#, #mdsPhone#, #mdsPhone2#) THEN 1 ELSE 0 END) AS FSR_TOT_VISIT_CNT -->
                  ,SUM(CASE WHEN TSK.DS_SVC_CALL_TP_CD NOT IN (#phoneFixDispatch#, #phoneFixTech#, #ahsPhoneFixDispatch#, #ahsPhoneFixTech#) THEN 1 ELSE 0 END) AS FSR_TOT_VISIT_CNT
                  <!-- END 2018/09/26 W.Honda [QC#28381,MOD] -->
                  ,SUM(CASE WHEN TSK.DS_SVC_CALL_TP_CD IN (#partCall#, #highPart#) THEN 1 ELSE 0 END) AS PRT_RSCHD_CNT
                  ,SUM(CASE WHEN SCT.SVC_RCLL_FLG = 'Y' THEN 1 ELSE 0 END) AS SVC_RCLL_CNT
               FROM
                   FSR                      FSR
                  ,FSR_VISIT                VIS
                  ,FSR_VISIT_TASK           FVT
                  ,SVC_TASK                 TSK
                  ,DS_SVC_CALL_TP           SCT
               WHERE
                   FSR.GLBL_CMPY_CD         = 'ADB'
               AND FSR.FSR_NUM              = VIS.FSR_NUM
               AND VIS.GLBL_CMPY_CD         = FVT.GLBL_CMPY_CD
               AND VIS.FSR_NUM              = FVT.FSR_NUM
               AND VIS.FSR_VISIT_NUM        = FVT.FSR_VISIT_NUM
               AND FVT.GLBL_CMPY_CD         = TSK.GLBL_CMPY_CD
               AND FVT.FSR_NUM              = TSK.FSR_NUM
               AND FVT.SVC_TASK_NUM         = TSK.SVC_TASK_NUM
               AND TSK.GLBL_CMPY_CD         = SCT.GLBL_CMPY_CD
               AND TSK.DS_SVC_CALL_TP_CD    = SCT.DS_SVC_CALL_TP_CD
               AND FSR.EZCANCELFLAG         = '0'
               AND VIS.EZCANCELFLAG         = '0'
               AND FVT.EZCANCELFLAG         = '0'
               AND TSK.EZCANCELFLAG         = '0'
               AND SCT.EZCANCELFLAG         = '0'
               GROUP BY FSR.FSR_NUM
           ) V_CNT
           ,(
               SELECT
                   FSR_NUM
                  ,SUM(LA_AOT)           AS FSR_TOT_LBOR_AOT
                  ,SUM(TR_AOT)           AS FSR_TOT_TRVL_AOT
               FROM
                   (
                   SELECT
                       FSR.FSR_NUM
                      ,EVE.SVC_TM_EVENT_CD
                      ,CASE WHEN EVE.SVC_TM_EVENT_CD = #labor#  THEN SUM(ROUND((TO_DATE(SVC_TM_EVENT_TO_DT || SVC_TM_EVENT_TO_TM,'YYYYMMDDHH24MISS') - TO_DATE(SVC_TM_EVENT_FROM_DT || SVC_TM_EVENT_FROM_TM,'YYYYMMDDHH24MISS')) * 24 * 60 * 60)) END AS LA_AOT
                      ,CASE WHEN EVE.SVC_TM_EVENT_CD = #travel# THEN SUM(ROUND((TO_DATE(SVC_TM_EVENT_TO_DT || SVC_TM_EVENT_TO_TM,'YYYYMMDDHH24MISS') - TO_DATE(SVC_TM_EVENT_FROM_DT || SVC_TM_EVENT_FROM_TM,'YYYYMMDDHH24MISS')) * 24 * 60 * 60)) END AS TR_AOT
                   FROM
                       FSR                   FSR
                      ,FSR_VISIT             VIS
                      ,FSR_VISIT_TM_EVENT    EVE
                   WHERE
                       FSR.GLBL_CMPY_CD      = #glblCmpyCd#
                   AND FSR.FSR_NUM           = VIS.FSR_NUM
                   AND VIS.GLBL_CMPY_CD      = EVE.GLBL_CMPY_CD
                   AND VIS.FSR_NUM           = EVE.FSR_NUM
                   AND VIS.FSR_VISIT_NUM     = EVE.FSR_VISIT_NUM
                   AND EVE.SVC_TM_EVENT_CD   IN (#labor#, #travel#)
                   AND FSR.EZCANCELFLAG      = '0'
                   AND VIS.EZCANCELFLAG      = '0'
                   AND EVE.EZCANCELFLAG      = '0'
                   GROUP BY FSR.FSR_NUM, SVC_TM_EVENT_CD
                   )
               GROUP BY FSR_NUM
           ) V_AOT
           ,(
               SELECT
                   FSR.FSR_NUM
                  ,SUM(SUP.SVC_TRVL_TM_NUM + SUP.SVC_SUPPL_TM_NUM) AS FSR_TOT_ITRPT_AOT
               FROM
                   FSR                       FSR
                  ,FSR_VISIT_TASK            FVT
                  ,SVC_SUPPL_TASK            SUP
                  ,SVC_SUPPL_TASK_TP         STP
               WHERE
                   FSR.GLBL_CMPY_CD          = #glblCmpyCd#
               AND FSR.GLBL_CMPY_CD          = FVT.GLBL_CMPY_CD
               AND FSR.FSR_NUM               = FVT.FSR_NUM
               AND FVT.GLBL_CMPY_CD          = SUP.GLBL_CMPY_CD
               AND FVT.SVC_TASK_NUM          = SUP.SVC_TASK_NUM
               AND SUP.SVC_SUPPL_TASK_TP_CD  != #meal2#
               AND SUP.GLBL_CMPY_CD          = STP.GLBL_CMPY_CD
               AND SUP.SVC_SUPPL_TASK_TP_CD  = STP.SVC_SUPPL_TASK_TP_CD
               AND STP.SVC_ITRPT_FLG         = 'Y'
               AND FSR.EZCANCELFLAG          = '0'
               AND FVT.EZCANCELFLAG          = '0'
               AND SUP.EZCANCELFLAG          = '0'
               AND STP.EZCANCELFLAG          = '0'
               GROUP BY FSR.FSR_NUM
           ) S_AOT
           ,(
               SELECT
                   FSR_NUM
                  ,SUM(NVL(FSR_TOT_PRT_COST_AMT, 0)) AS FSR_TOT_PRT_COST_AMT
               FROM (
                      SELECT
                          USG.FSR_NUM
                         ,NVL(USG.SVC_PRT_QTY, 0) * NVL(MDS.THIS_MTH_TOT_STD_COST_AMT, 0) AS FSR_TOT_PRT_COST_AMT
                      FROM
                          FSR_USG               USG
                         ,MDSE                  MDS
                      WHERE
                          USG.GLBL_CMPY_CD      = #glblCmpyCd#
                      AND USG.GLBL_CMPY_CD      = MDS.GLBL_CMPY_CD
                      AND USG.MDSE_CD           = MDS.MDSE_CD
                      AND USG.EZCANCELFLAG      = '0'
                      AND MDS.EZCANCELFLAG      = '0'
               )
               GROUP BY FSR_NUM
           ) U_AOT
           ,(
               SELECT
                   FSR_NUM
                  ,MTR_READ_DT
                  ,SUM(BW_CNT)                                                                   AS BW_READ_MTR_CNT
                  ,SUM(CL_CNT)                                                                   AS COLOR_READ_MTR_CNT
                  ,CASE WHEN SUM(TL_CNT) = 0 THEN SUM(BW_CNT) + SUM(CL_CNT) ELSE SUM(TL_CNT) END AS TOT_READ_MTR_CNT
               FROM
                   (
                   SELECT DISTINCT
                       FSR.FSR_NUM
                      ,MTR.MTR_READ_DT
                      ,CASE WHEN LB.BW_MTR_FLG    = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS BW_CNT
                      ,CASE WHEN LB.COLOR_MTR_FLG = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS CL_CNT
                      ,CASE WHEN LB.TOT_MTR_FLG   = 'Y' THEN MTR.READ_MTR_CNT ELSE 0 END AS TL_CNT
                   FROM
                       FSR                       FSR
                      ,SVC_PHYS_MTR_READ         MTR
                      ,MTR_LB                    LB
                   WHERE
                       FSR.GLBL_CMPY_CD          = #glblCmpyCd#
                   AND FSR.GLBL_CMPY_CD          = MTR.GLBL_CMPY_CD
                   AND FSR.FSR_NUM               = MTR.FSR_NUM
                   AND FSR.SVC_MACH_MSTR_PK      = MTR.SVC_MACH_MSTR_PK
                   AND MTR.FSR_VISIT_NUM         = #firstNum#
                   AND MTR.TEST_MTR_CNT          = 0
                   AND MTR.GLBL_CMPY_CD          = LB.GLBL_CMPY_CD
                   AND MTR.MTR_LB_CD             = LB.MTR_LB_CD
                   <!-- START QC#28592 2018/10/11 [ADD]-->
                   AND MTR.VLD_MTR_FLG           = 'Y'
                   <!-- END   QC#28592 2018/10/11 [ADD]-->
                   AND FSR.EZCANCELFLAG          = '0'
                   AND MTR.EZCANCELFLAG          = '0'
                   AND LB.EZCANCELFLAG           = '0'
                   )
               GROUP BY FSR_NUM ,MTR_READ_DT
           ) M_CNT
           ,(
               SELECT
                   FSR_NUM
                  ,CASE WHEN SUM(FLG_CNT) > 0 THEN 'Y' ELSE 'N' END AS TM_AND_MAT_FLG
               FROM (
                   SELECT 
                       FSR.FSR_NUM
                      ,CTR.DS_CONTR_PK
                      ,CTR.CONTR_VRSN_EFF_FROM_DT
                      ,CTR.CONTR_VRSN_EFF_THRU_DT
                      ,CASE WHEN SUBSTR(TSK.ERL_START_TS, 0, #ymdLen#) &gt; CONTR_VRSN_EFF_FROM_DT OR CONTR_VRSN_EFF_THRU_DT &gt; SUBSTR(TSK.ERL_START_TS, 0, #ymdLen#) THEN 1 ELSE 0 END AS FLG_CNT
                   FROM
                        FSR                    FSR
                       ,FSR_VISIT_TASK         FVT
                       ,SVC_TASK               TSK
                       ,SVC_MACH_MSTR          MAC
                       ,DS_CONTR               CTR
                       ,DS_CONTR_DTL           CTD
                   WHERE
                       FSR.GLBL_CMPY_CD        = #glblCmpyCd#
                   AND FSR.GLBL_CMPY_CD        = FVT.GLBL_CMPY_CD
                   AND FSR.FSR_NUM             = FVT.FSR_NUM
                   AND FVT.FSR_VISIT_NUM       = #firstNum#
                   AND FVT.GLBL_CMPY_CD        = TSK.GLBL_CMPY_CD
                   AND FVT.FSR_NUM             = TSK.FSR_NUM
                   AND FVT.SVC_TASK_NUM        = TSK.SVC_TASK_NUM
                   AND FSR.GLBL_CMPY_CD        = MAC.GLBL_CMPY_CD
                   AND FSR.SVC_MACH_MSTR_PK    = MAC.SVC_MACH_MSTR_PK
                   AND MAC.GLBL_CMPY_CD        = CTD.GLBL_CMPY_CD
                   AND MAC.SVC_MACH_MSTR_PK    = CTD.SVC_MACH_MSTR_PK
                   AND CTD.GLBL_CMPY_CD        = CTR.GLBL_CMPY_CD
                   AND CTD.DS_CONTR_PK         = CTR.DS_CONTR_PK
                   AND FSR.EZCANCELFLAG        = '0'
                   AND FVT.EZCANCELFLAG        = '0'
                   AND TSK.EZCANCELFLAG        = '0'
                   AND MAC.EZCANCELFLAG        = '0'
                   AND CTR.EZCANCELFLAG        = '0'
                   AND CTD.EZCANCELFLAG        = '0'
               )
               GROUP BY FSR_NUM
           ) T_FLG
           ,(
               SELECT
                   FVT.FSR_NUM
                  ,FVT.CPLT_BY_TEL_FIX_FLG
               FROM
                   FSR                   FSR
                  ,FSR_VISIT_TASK        FVT
                  ,SVC_TASK              TSK
               WHERE
                   FSR.GLBL_CMPY_CD      = #glblCmpyCd#
               AND FSR.GLBL_CMPY_CD      = FVT.GLBL_CMPY_CD
               AND FSR.FSR_NUM           = FVT.FSR_NUM
               AND FVT.GLBL_CMPY_CD      = TSK.GLBL_CMPY_CD
               AND FVT.FSR_NUM           = TSK.FSR_NUM
               AND FVT.SVC_TASK_NUM      = TSK.SVC_TASK_NUM
               <!-- START 2018/09/26 W.Honda [QC#28381,MOD] -->
               <!-- AND TSK.DS_SVC_CALL_TP_CD = #phone# -->
               AND TSK.DS_SVC_CALL_TP_CD IN (#phoneFixDispatch#, #phoneFixTech#, #ahsPhoneFixDispatch#, #ahsPhoneFixTech#)
               <!-- START 2018/09/26 W.Honda [QC#28381,MOD] -->
               AND FSR.EZCANCELFLAG      = '0'
               AND FVT.EZCANCELFLAG      = '0'
               AND TSK.EZCANCELFLAG      = '0'
           ) C_FLG
           ,(
               <!-- START 2017/08/24 K.Kojima [QC#20720,ADD] -->
               SELECT
                   FSR_NUM
                  ,AHS_CD
               FROM
               (
               <!-- END 2017/08/24 K.Kojima [QC#20720,ADD] -->
               SELECT 
                   FSR.FSR_NUM
                  ,TER.SVC_TERM_ATTRB_MAP_VAL_CD AS AHS_CD
                   <!-- START 2017/08/24 K.Kojima [QC#20720,ADD] -->
                  ,ROW_NUMBER() OVER(PARTITION BY FSR.FSR_NUM ORDER BY TER.SVC_TERM_ATTRB_MAP_VAL_CD NULLS LAST) AS FSR_RANK
                   <!-- END 2017/08/24 K.Kojima [QC#20720,ADD] -->
               FROM
                   FSR                         FSR
                  ,SVC_MACH_MSTR               MAC
                  ,DS_CONTR_DTL                CTD
                  ,SVC_TERM_COND               TER
               WHERE
                   FSR.GLBL_CMPY_CD            = #glblCmpyCd#
               AND FSR.GLBL_CMPY_CD            = MAC.GLBL_CMPY_CD
               AND FSR.SVC_MACH_MSTR_PK        = MAC.SVC_MACH_MSTR_PK
               AND MAC.GLBL_CMPY_CD            = CTD.GLBL_CMPY_CD
               AND MAC.SVC_MACH_MSTR_PK        = CTD.SVC_MACH_MSTR_PK
               <!-- START 2017/08/24 K.Kojima [QC#20720,ADD] -->
               AND CTD.CONTR_EFF_FROM_DT                       &lt;= FSR.FSR_CRAT_DT
               AND NVL(CTD.CONTR_CLO_DT,CTD.CONTR_EFF_THRU_DT) &gt;= FSR.FSR_CRAT_DT
               <!-- END 2017/08/24 K.Kojima [QC#20720,ADD] -->
               AND CTD.GLBL_CMPY_CD            = TER.GLBL_CMPY_CD
               AND CTD.DS_CONTR_PK             = TER.DS_CONTR_PK
               AND CTD.DS_CONTR_DTL_PK         = TER.DS_CONTR_DTL_PK
               AND TER.SVC_TERM_COND_ATTRB_PK  = #ahsAttr#
               AND FSR.EZCANCELFLAG            = '0'
               AND MAC.EZCANCELFLAG            = '0'
               AND CTD.EZCANCELFLAG            = '0'
               AND TER.EZCANCELFLAG            = '0'
               <!-- START 2017/08/24 K.Kojima [QC#20720,ADD] -->
               )
               WHERE
                   FSR_RANK = 1
               <!-- END 2017/08/24 K.Kojima [QC#20720,ADD] -->
           ) AHS_1
           ,(
               <!-- START 2017/08/24 K.Kojima [QC#20720,ADD] -->
               SELECT
                   FSR_NUM
                  ,AHS_CD
               FROM
               (
               <!-- END 2017/08/24 K.Kojima [QC#20720,ADD] -->
               SELECT 
                   FSR.FSR_NUM
                  ,TER.SVC_TERM_ATTRB_MAP_VAL_CD AS AHS_CD
                   <!-- START 2017/08/24 K.Kojima [QC#20720,ADD] -->
                  ,ROW_NUMBER() OVER(PARTITION BY FSR.FSR_NUM ORDER BY TER.SVC_TERM_ATTRB_MAP_VAL_CD NULLS LAST) AS FSR_RANK
                   <!-- END 2017/08/24 K.Kojima [QC#20720,ADD] -->
               FROM
                   FSR                         FSR
                  ,SVC_MACH_MSTR               MAC
                  ,DS_CONTR_DTL                CTD
                  ,SVC_TERM_COND               TER
               WHERE
                   FSR.GLBL_CMPY_CD            = #glblCmpyCd#
               AND FSR.GLBL_CMPY_CD            = MAC.GLBL_CMPY_CD
               AND FSR.SVC_MACH_MSTR_PK        = MAC.SVC_MACH_MSTR_PK
               AND MAC.GLBL_CMPY_CD            = CTD.GLBL_CMPY_CD
               AND MAC.SVC_MACH_MSTR_PK        = CTD.SVC_MACH_MSTR_PK
               <!-- START 2017/08/24 K.Kojima [QC#20720,ADD] -->
               AND CTD.CONTR_EFF_FROM_DT                       &lt;= FSR.FSR_CRAT_DT
               AND NVL(CTD.CONTR_CLO_DT,CTD.CONTR_EFF_THRU_DT) &gt;= FSR.FSR_CRAT_DT
               <!-- END 2017/08/24 K.Kojima [QC#20720,ADD] -->
               AND CTD.GLBL_CMPY_CD            = TER.GLBL_CMPY_CD
               AND CTD.DS_CONTR_PK             = TER.DS_CONTR_PK
               AND TER.DS_CONTR_DTL_PK         IS NULL
               AND TER.SVC_TERM_COND_ATTRB_PK  = #ahsAttr#
               AND FSR.EZCANCELFLAG            = '0'
               AND MAC.EZCANCELFLAG            = '0'
               AND CTD.EZCANCELFLAG            = '0'
               AND TER.EZCANCELFLAG            = '0'
               <!-- START 2017/08/24 K.Kojima [QC#20720,ADD] -->
               )
               WHERE
                   FSR_RANK = 1
               <!-- END 2017/08/24 K.Kojima [QC#20720,ADD] -->
           ) AHS_2
           ,(
               <!-- START 2017/08/24 K.Kojima [QC#20720,ADD] -->
               SELECT
                   FSR_NUM
                  ,TRGT_SVC_RSP_AOT
               FROM
               (
               <!-- END 2017/08/24 K.Kojima [QC#20720,ADD] -->
               SELECT 
                   FSR.FSR_NUM
                  ,TER.SVC_TERM_ATTRB_MAP_VAL_CD * #timeAdj# AS TRGT_SVC_RSP_AOT
                   <!-- START 2017/08/24 K.Kojima [QC#20720,ADD] -->
                  ,ROW_NUMBER() OVER(PARTITION BY FSR.FSR_NUM ORDER BY TER.SVC_TERM_ATTRB_MAP_VAL_CD NULLS LAST) AS FSR_RANK
                   <!-- END 2017/08/24 K.Kojima [QC#20720,ADD] -->
               FROM
                   FSR                         FSR
                  ,SVC_MACH_MSTR               MAC
                  ,DS_CONTR_DTL                CTD
                  ,SVC_TERM_COND               TER
               WHERE
                   FSR.GLBL_CMPY_CD            = #glblCmpyCd#
               AND FSR.GLBL_CMPY_CD            = MAC.GLBL_CMPY_CD
               AND FSR.SVC_MACH_MSTR_PK        = MAC.SVC_MACH_MSTR_PK
               AND MAC.GLBL_CMPY_CD            = CTD.GLBL_CMPY_CD
               AND MAC.SVC_MACH_MSTR_PK        = CTD.SVC_MACH_MSTR_PK
               <!-- START 2017/08/24 K.Kojima [QC#20720,ADD] -->
               AND CTD.CONTR_EFF_FROM_DT                       &lt;= FSR.FSR_CRAT_DT
               AND NVL(CTD.CONTR_CLO_DT,CTD.CONTR_EFF_THRU_DT) &gt;= FSR.FSR_CRAT_DT
               <!-- END 2017/08/24 K.Kojima [QC#20720,ADD] -->
               AND CTD.GLBL_CMPY_CD            = TER.GLBL_CMPY_CD
               AND CTD.DS_CONTR_PK             = TER.DS_CONTR_PK
               AND CTD.DS_CONTR_DTL_PK         = TER.DS_CONTR_DTL_PK
               AND TER.SVC_TERM_COND_ATTRB_PK  = #rspTime#
               AND FSR.EZCANCELFLAG            = '0'
               AND MAC.EZCANCELFLAG            = '0'
               AND CTD.EZCANCELFLAG            = '0'
               AND TER.EZCANCELFLAG            = '0'
               <!-- START 2017/08/24 K.Kojima [QC#20720,ADD] -->
               )
               WHERE
                   FSR_RANK = 1
               <!-- END 2017/08/24 K.Kojima [QC#20720,ADD] -->
           ) RSP_1
           ,(
               <!-- START 2017/08/24 K.Kojima [QC#20720,ADD] -->
               SELECT
                   FSR_NUM
                  ,TRGT_SVC_RSP_AOT
               FROM
               (
               <!-- END 2017/08/24 K.Kojima [QC#20720,ADD] -->
               SELECT 
                   FSR.FSR_NUM
                  ,TER.SVC_TERM_ATTRB_MAP_VAL_CD * #timeAdj# AS TRGT_SVC_RSP_AOT
                   <!-- START 2017/08/24 K.Kojima [QC#20720,ADD] -->
                  ,ROW_NUMBER() OVER(PARTITION BY FSR.FSR_NUM ORDER BY TER.SVC_TERM_ATTRB_MAP_VAL_CD NULLS LAST) AS FSR_RANK
                   <!-- END 2017/08/24 K.Kojima [QC#20720,ADD] -->
               FROM
                   FSR                         FSR
                  ,SVC_MACH_MSTR               MAC
                  ,DS_CONTR_DTL                CTD
                  ,SVC_TERM_COND               TER
               WHERE
                   FSR.GLBL_CMPY_CD            = #glblCmpyCd#
               AND FSR.GLBL_CMPY_CD            = MAC.GLBL_CMPY_CD
               AND FSR.SVC_MACH_MSTR_PK        = MAC.SVC_MACH_MSTR_PK
               AND MAC.GLBL_CMPY_CD            = CTD.GLBL_CMPY_CD
               AND MAC.SVC_MACH_MSTR_PK        = CTD.SVC_MACH_MSTR_PK
               <!-- START 2017/08/24 K.Kojima [QC#20720,ADD] -->
               AND CTD.CONTR_EFF_FROM_DT                       &lt;= FSR.FSR_CRAT_DT
               AND NVL(CTD.CONTR_CLO_DT,CTD.CONTR_EFF_THRU_DT) &gt;= FSR.FSR_CRAT_DT
               <!-- END 2017/08/24 K.Kojima [QC#20720,ADD] -->
               AND CTD.GLBL_CMPY_CD            = TER.GLBL_CMPY_CD
               AND CTD.DS_CONTR_PK             = TER.DS_CONTR_PK
               AND TER.DS_CONTR_DTL_PK         IS NULL
               AND TER.SVC_TERM_COND_ATTRB_PK  = #rspTime#
               AND FSR.EZCANCELFLAG            = '0'
               AND MAC.EZCANCELFLAG            = '0'
               AND CTD.EZCANCELFLAG            = '0'
               AND TER.EZCANCELFLAG            = '0'
               <!-- START 2017/08/24 K.Kojima [QC#20720,ADD] -->
               )
               WHERE
                   FSR_RANK = 1
               <!-- END 2017/08/24 K.Kojima [QC#20720,ADD] -->
           ) RSP_2
           ,(
               SELECT 
                   FSR.FSR_NUM
                  ,MDL.MDL_ID
                  ,MDL.MDL_GRP_ID
                  ,MDL.RSP_TM_UP_MN_AOT
               FROM
                   FSR                         FSR
                  ,SVC_MACH_MSTR               MAC
                  ,SVC_CONFIG_MSTR             CON
                  ,DS_MDL                      MDL
               WHERE
                   FSR.GLBL_CMPY_CD            = #glblCmpyCd#
               AND FSR.GLBL_CMPY_CD            = MAC.GLBL_CMPY_CD
               AND FSR.SVC_MACH_MSTR_PK        = MAC.SVC_MACH_MSTR_PK
               AND MAC.GLBL_CMPY_CD            = CON.GLBL_CMPY_CD
               AND MAC.SVC_CONFIG_MSTR_PK      = CON.SVC_CONFIG_MSTR_PK
               AND CON.GLBL_CMPY_CD            = MDL.GLBL_CMPY_CD
               AND CON.MDL_ID                  = MDL.MDL_ID
               AND FSR.EZCANCELFLAG            = '0'
               AND MAC.EZCANCELFLAG            = '0'
               AND CON.EZCANCELFLAG            = '0'
               AND MDL.EZCANCELFLAG            = '0'
           ) MDL_1
           ,(
               SELECT 
                   FSR_NUM
                  ,MDL_ID
                  ,MDL_GRP_ID
                  ,RSP_TM_UP_MN_AOT
               FROM
                   (
                   SELECT
                       FSR.FSR_NUM
                      ,SVC_CONFIG_MSTR_DTL_PK
                      ,ROW_NUMBER() OVER(PARTITION BY FSR_NUM ORDER BY SVC_CONFIG_MSTR_DTL_PK DESC) ROW_NUM
                      ,MDL.MDL_ID
                      ,MDL.MDL_GRP_ID
                      ,MDL.RSP_TM_UP_MN_AOT
                   FROM
                       FSR                         FSR
                      ,SVC_CONFIG_MSTR_DTL         CON
                      ,DS_MDL                      MDL
                   WHERE
                       FSR.GLBL_CMPY_CD            = #glblCmpyCd#
                   AND FSR.GLBL_CMPY_CD            = CON.GLBL_CMPY_CD
                   AND FSR.SVC_MACH_MSTR_PK        = CON.SVC_MACH_MSTR_PK
                   AND CON.GLBL_CMPY_CD            = MDL.GLBL_CMPY_CD
                   AND CON.MDL_ID                  = MDL.MDL_ID
                   AND FSR.EZCANCELFLAG            = '0'
                   AND CON.EZCANCELFLAG            = '0'
                   AND MDL.EZCANCELFLAG            = '0'
                   )
               WHERE ROW_NUM = 1
           ) MDL_2
        WHERE
            FSR.GLBL_CMPY_CD                = #glblCmpyCd#
        AND (SUBSTR(FSR_CLO_DT, 0, #ymLen#) = #trgtYrMth# OR FSR.FSR_STS_CD NOT IN (#saved#, #comleted#, #pendingCharge#, #closed#, #cancelled#, #debriefError#))
        AND FSR.GLBL_CMPY_CD                = FVT.GLBL_CMPY_CD
        AND FSR.FSR_NUM                     = FVT.FSR_NUM
        AND FVT.FSR_VISIT_NUM               = #firstNum#
        AND FVT.GLBL_CMPY_CD                = TSK.GLBL_CMPY_CD
        AND FVT.FSR_NUM                     = TSK.FSR_NUM
        AND FVT.SVC_TASK_NUM                = TSK.SVC_TASK_NUM
        AND FVT.GLBL_CMPY_CD                = VIS.GLBL_CMPY_CD
        AND FVT.FSR_NUM                     = VIS.FSR_NUM
        AND FVT.FSR_VISIT_NUM               = VIS.FSR_VISIT_NUM
        AND FSR.GLBL_CMPY_CD                = CHG.GLBL_CMPY_CD(+)
        AND FSR.FSR_NUM                     = CHG.FSR_NUM(+)
        AND FSR.GLBL_CMPY_CD                = MAC.GLBL_CMPY_CD
        AND FSR.SVC_MACH_MSTR_PK            = MAC.SVC_MACH_MSTR_PK
        AND MAC.GLBL_CMPY_CD                = SHP.GLBL_CMPY_CD
        AND MAC.CUR_LOC_NUM                 = SHP.SHIP_TO_CUST_CD
        AND MAC.GLBL_CMPY_CD                = ACC.GLBL_CMPY_CD(+)
        AND MAC.CUR_LOC_ACCT_NUM            = ACC.SELL_TO_CUST_CD(+)
        AND ACC.GLBL_CMPY_CD                = AGA.GLBL_CMPY_CD(+)
        AND ACC.SELL_TO_CUST_CD             = AGA.DS_ACCT_NUM(+)
        AND AGA.GLBL_CMPY_CD                = ACG.GLBL_CMPY_CD(+)
        AND AGA.DS_ACCT_GRP_CD              = ACG.DS_ACCT_GRP_CD(+)
        AND MAC.GLBL_CMPY_CD                = CST.GLBL_CMPY_CD(+)
        AND MAC.SVC_BY_LINE_BIZ_TP_CD       = CST.RPT_COND_CONST_CD(+)
        AND CST.RPT_COND_CONST_GRP_ID(+)    = #laborRate#
        AND FSR.FSR_NUM                     = V_CNT.FSR_NUM(+)
        AND FSR.FSR_NUM                     = V_AOT.FSR_NUM(+)
        AND FSR.FSR_NUM                     = S_AOT.FSR_NUM(+)
        AND FSR.FSR_NUM                     = U_AOT.FSR_NUM(+)
        AND FSR.FSR_NUM                     = M_CNT.FSR_NUM(+)
        AND FSR.FSR_NUM                     = T_FLG.FSR_NUM(+)
        AND FSR.FSR_NUM                     = C_FLG.FSR_NUM(+)
        AND FSR.FSR_NUM                     = AHS_1.FSR_NUM(+)
        AND FSR.FSR_NUM                     = AHS_2.FSR_NUM(+)
        AND FSR.FSR_NUM                     = RSP_1.FSR_NUM(+)
        AND FSR.FSR_NUM                     = RSP_2.FSR_NUM(+)
        AND FSR.FSR_NUM                     = MDL_1.FSR_NUM(+)
        AND FSR.FSR_NUM                     = MDL_2.FSR_NUM(+)
        AND FSR.EZCANCELFLAG                = '0'
        AND TSK.EZCANCELFLAG                = '0'
        AND VIS.EZCANCELFLAG                = '0'
        AND CHG.EZCANCELFLAG(+)             = '0'
        AND FVT.EZCANCELFLAG                = '0'
        AND MAC.EZCANCELFLAG                = '0'
        AND SHP.EZCANCELFLAG                = '0'
        AND ACC.EZCANCELFLAG(+)             = '0'
        AND AGA.EZCANCELFLAG(+)             = '0'
        AND ACG.EZCANCELFLAG(+)             = '0'
        AND CST.EZCANCELFLAG(+)             = '0'
    </statement>

</sqlMap>
