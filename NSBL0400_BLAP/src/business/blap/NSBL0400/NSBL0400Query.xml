<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSBL0400Query">
    <typeAlias alias="NSBL0400_ASMsg"  type="business.blap.NSBL0400.NSBL0400_ASMsg"/>
    <statement id="getSearchData" parameterClass="Map" resultMap="result.getSearchData">
        <!-- START 2018/05/24 U.Kim [QC#22393, ADD] -->
        <isNotNull property="serNum">
        WITH TARGET_SERIAL AS (
            SELECT
                 SMMC.SVC_MACH_MSTR_PK
                ,SMMC.SER_NUM
                ,SMMC.MDSE_CD
            FROM
                 SVC_MACH_MSTR SMM
                ,SVC_MACH_MSTR SMMC
            WHERE
                    SMM.GLBL_CMPY_CD       = 'ADB'
                AND SMM.SER_NUM            = #serNum#
                AND SMM.SVC_MACH_TP_CD     = #svcMachTpCdMach#
                AND SMM.EZCANCELFLAG       = '0'
                AND SMM.GLBL_CMPY_CD       = SMMC.GLBL_CMPY_CD
                AND SMM.SVC_CONFIG_MSTR_PK = SMMC.SVC_CONFIG_MSTR_PK
                AND SMMC.EZCANCELFLAG      = '0'
            UNION ALL
            SELECT
                 SMM.SVC_MACH_MSTR_PK
                ,SMM.SER_NUM
                ,SMM.MDSE_CD
            FROM
                 SVC_MACH_MSTR SMM
            WHERE
                    SMM.GLBL_CMPY_CD       = 'ADB'
                AND SMM.SER_NUM            = #serNum#
                AND SMM.SVC_MACH_TP_CD     = #svcMachTpCdAcc#
                AND SMM.EZCANCELFLAG       = '0'
        )
        </isNotNull>
        <!-- END 2018/05/24 U.Kim [QC#22393, ADD] -->
        <!-- START 2018/05/24 U.Kim [QC#22393, ADD] -->
        SELECT
             SVC_MOD_PK
            ,XX_DPLY_BY_CD_NM_CNCT_TXT
            ,SVC_MOD_PLN_ID
            ,SVC_MOD_NM
            ,SVC_MOD_CMNT_TXT
            ,XX_REC_HIST_CRAT_TS_A
            ,XX_REC_HIST_CRAT_BY_NM_A
            ,XX_REC_HIST_UPD_TS_A
            ,XX_REC_HIST_UPD_BY_NM_A
            ,XX_REC_HIST_TBL_NM_A
        FROM
            (
        <!-- END 2018/05/24 U.Kim [QC#22393, ADD] -->
        SELECT
             SM.SVC_MOD_PK
            ,TRIM(SM.SVC_MNF_CD || ':' || MNF.SVC_MNF_DESC_TXT) AS XX_DPLY_BY_CD_NM_CNCT_TXT
            ,SM.SVC_MOD_PLN_ID
            ,SM.SVC_MOD_NM
            ,SM.SVC_MOD_CMNT_TXT
            <!-- START 2016/12/05 K.Kojima [QC#14204, ADD] -->
            ,SM.EZINTIME    AS XX_REC_HIST_CRAT_TS_A
            ,SM.EZINUSERID  AS XX_REC_HIST_CRAT_BY_NM_A
            ,SM.EZUPTIME    AS XX_REC_HIST_UPD_TS_A
            ,SM.EZUPUSERID  AS XX_REC_HIST_UPD_BY_NM_A
            ,SM.EZTABLEID   AS XX_REC_HIST_TBL_NM_A
            <!-- END 2016/12/05 K.Kojima [QC#14204, ADD] -->
        FROM 
             SVC_MOD SM
            ,SVC_MNF MNF
        WHERE
                SM.GLBL_CMPY_CD     = #glblCmpyCd#
            AND SM.EZCANCELFLAG = '0'
            <isNotNull property="svcModYr">
            AND SM.SVC_MOD_YR = #svcModYr#
            </isNotNull>
            <isNotNull property="svcModMth">
            AND SM.SVC_MOD_MTH = #svcModMth#
            </isNotNull>
            <isNotNull property="svcModDay">
            AND SM.SVC_MOD_DAY = #svcModDay#
            </isNotNull>
            <isNotNull property="svcMnfCd">
            AND SM.SVC_MNF_CD = #svcMnfCd#
            </isNotNull>
            AND MNF.GLBL_CMPY_CD = SM.GLBL_CMPY_CD
            AND MNF.EZCANCELFLAG = '0'
            AND MNF.SVC_MNF_CD = SM.SVC_MNF_CD
            <isNotNull property="svcModSqNum">
            AND SM.SVC_MOD_SQ_NUM = #svcModSqNum#
            </isNotNull>
            <isNotNull property="svcModNm">
            AND SM.SVC_MOD_NM LIKE #svcModNm#
            </isNotNull>
            <isNotNull property="mdseCd">
            AND EXISTS
                (SELECT
                     SVC_MOD_PK
                 FROM
                     SVC_MOD_DTL SMD
                 WHERE
                         SMD.GLBL_CMPY_CD = #glblCmpyCd#
                     AND SMD.EZCANCELFLAG = '0'
                     AND MDSE_CD LIKE #mdseCd#
                     AND SMD.SVC_MOD_PK = SM.SVC_MOD_PK
                 )
            </isNotNull>
            <isNotNull property="svcMnfModNum">
            AND EXISTS
                (SELECT
                     SVC_MOD_PK
                 FROM
                     SVC_MOD_DTL SMD
                 WHERE
                         SMD.GLBL_CMPY_CD = #glblCmpyCd#
                     AND SMD.EZCANCELFLAG = 0
                     AND SVC_MNF_MOD_NUM LIKE #svcMnfModNum#
                     AND SMD.SVC_MOD_PK = SM.SVC_MOD_PK
                 )
            </isNotNull>
            <!-- START 2018/05/24 U.Kim [QC#22393, ADD] -->
            <isNotNull property="serNum">
            AND
                (
                    EXISTS(
                        SELECT
                            1
                        FROM
                             SVC_MOD_STS   SMS
                            ,TARGET_SERIAL TS
                        WHERE
                                SM.GLBL_CMPY_CD            = SMS.GLBL_CMPY_CD
                            AND SM.SVC_MOD_PK              = SMS.SVC_MOD_PK
                            AND SMS.EZCANCELFLAG           = '0'
                            AND SMS.SVC_MACH_MSTR_PK       = TS.SVC_MACH_MSTR_PK
                    ) OR
                    EXISTS(
                        SELECT
                            1
                        FROM
                             SVC_MOD_SER_RNG SMSR
                            ,TARGET_SERIAL   TS
                        WHERE
                                SM.GLBL_CMPY_CD               = SMSR.GLBL_CMPY_CD
                            AND SM.SVC_MOD_PK                 = SMSR.SVC_MOD_PK
                            AND SMSR.EZCANCELFLAG             = '0'
                            AND SMSR.MDSE_CD                  = TS.MDSE_CD
                            AND SMSR.LG_SER_NUM               = LENGTH(TS.SER_NUM)
                            AND SMSR.SVC_MOD_FROM_SER_NUM &lt;= TS.SER_NUM
                            AND SMSR.SVC_MOD_TO_SER_NUM   &gt;= TS.SER_NUM
                    )
                )
            </isNotNull>
            <!-- END 2018/05/24 U.Kim [QC#22393, ADD] -->
            <!-- START 2018/05/24 U.Kim [QC#22393, DEL] -->
            <!-- AND ROWNUM               &lt;= #limitCnt# -->
            <!-- END 2018/05/24 U.Kim [QC#22393, DEL] -->
            ORDER BY
            SM.SVC_MOD_PLN_ID DESC
            <!-- START 2018/05/24 U.Kim [QC#22393, DEL] -->
            )
        WHERE
            ROWNUM               &lt;= #limitCnt#
            <!-- END 2018/05/24 U.Kim [QC#22393, DEL] -->
    </statement>
    <resultMap id="result.getSearchData"      class="NSBL0400_ASMsg">
        <result property="svcModPk_A"        column="SVC_MOD_PK"           javaType="EZDSBigDecimalItem"/>
        <result property="xxDplyByCdNmCnctTxt_A"    column="XX_DPLY_BY_CD_NM_CNCT_TXT"    javaType="EZDCStringItem"/>
        <result property="svcModPlnId_A"     column="SVC_MOD_PLN_ID"       javaType="EZDCStringItem"/>
        <result property="svcModNm_A"        column="SVC_MOD_NM"           javaType="EZDCStringItem"/>
        <result property="svcModCmntTxt_A"   column="SVC_MOD_CMNT_TXT"     javaType="EZDCStringItem"/>
        <!-- START 2016/12/05 K.Kojima [QC#14204, ADD] -->
        <result property="xxRecHistCratTs_A"   column="XX_REC_HIST_CRAT_TS_A"    javaType="EZDSStringItem"/>
        <result property="xxRecHistCratByNm_A" column="XX_REC_HIST_CRAT_BY_NM_A" javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdTs_A"    column="XX_REC_HIST_UPD_TS_A"     javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdByNm_A"  column="XX_REC_HIST_UPD_BY_NM_A"  javaType="EZDSStringItem"/>
        <result property="xxRecHistTblNm_A"    column="XX_REC_HIST_TBL_NM_A"     javaType="EZDSStringItem"/>
        <!-- END 2016/12/05 K.Kojima [QC#14204, ADD] -->
    </resultMap>
</sqlMap>
