<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NWZC156001Query">

    <statement id="getLatestPrftInfo" parameterClass="Map" resultClass="Map">
        SELECT
             OP.TRX_HDR_NUM
           , OP.ORD_PRFT_VRSN_NUM
           , OP.FUNC_NEGO_DEAL_AMT
           , OP.TOT_FUNC_REP_REV_AMT
           , OP.TOT_FUNC_REP_REV_ADJ_AMT
           , OP.TOT_FUNC_FINAL_FL_AMT
           , OP.FUNC_GRS_PRFT_AMT
           , OP.GRS_PRFT_PCT
           , OP.TOT_FUNC_MSRP_AMT
           , OP.TOT_FUNC_STD_FL_AMT
           , OP.TOT_FUNC_FL_ADJ_AMT
           , OP.CSMP_ORD_FLG
           , OP.TOT_FUNC_CSMP_CR_AMT
           , OP.TOT_FUNC_CSMP_FL_AMT
           , OP.CSMP_CONTR_NUM      AS CSMP_CONTR_NUM_HDR
           , OP.DLR_REF_NUM         AS DLR_REF_NUM_HDR
           , OP.CSMP_CONTR_START_DT
           , OP.CSMP_CONTR_END_DT
           , OP.LAST_PRFT_CALC_USR_ID
           , OP.LAST_PRFT_CALC_TS
           , OP.TOT_FUNC_BYOT_AMT
           , OP.TOT_FUNC_SVC_REV_TRNSF_AMT
           , OP.TOT_FUNC_SVC_COST_TRNSF_AMT
           , OP.TOT_FUNC_PRO_SVC_AMT
           , OP.TOT_FUNC_OM_MAINT_BLLBL_AMT
           , OP.FUNC_ALT_GRS_PRFT_AMT
           , OP.ALT_GRS_PRFT_PCT
           , OP.TOT_FUNC_DLR_CR_AMT
           , OP.TOT_FUNC_DLR_INV_AMT
           , OP.TOT_FUNC_RED_COMP_AMT
           , OP.TOT_FUNC_FNDR_FEE_AMT
           , OP.TOT_FUNC_ISTL_CR_AMT
           , OP.TOT_FUNC_SPLY_AMT
           --
           , OPD.ORD_PRFT_TRX_CATG_CD
           , OPD.TRX_LINE_NUM
           , OPD.TRX_LINE_SUB_NUM
           , OPD.DS_ORD_POSN_NUM
           , OPD.DS_CPO_LINE_NUM
           , OPD.DS_CPO_LINE_SUB_NUM
           , OPD.MDSE_CD
           , OPD.MDSE_NM
           , M.MDSE_DESC_SHORT_TXT                   -- 2016/03/10 S21_NA2939
           , OPD.RTL_WH_CD
           , OPD.RTL_SWH_CD
           , OPD.MDSE_INVTY_COST_PCT
           , OPD.DS_ORD_LINE_CATG_CD
           , OPD.ORD_QTY
           , OPD.ORD_CUST_UOM_QTY                    -- 2016/03/25 S21_NA5491
           , OPD.CUST_UOM_CD
           , OPD.FL_PRC_LIST_CD
           , FPC.PRC_CATG_NM AS FL_PRC_LIST_NM       -- 2016/03/10 S21_NA2939
           , OPD.CSMP_PRC_LIST_CD
           , CPC.PRC_CATG_NM AS CSMP_PRC_LIST_NM     -- 2016/03/10 S21_NA2939
           , OPD.PRC_CATG_CD                         -- QC7707
           , OPD.FUNC_DLR_CR_AMT
           , OPD.FUNC_RED_COMP_AMT
           , OPD.FUNC_UNIT_FL_PRC_AMT
           , OPD.FUNC_INIT_FL_PRC_AMT
           , OPD.LINE_WT_AMT_RATE
           , OPD.FUNC_GENL_FL_ADJ_AMT
           , OPD.FUNC_SPEC_FL_ADJ_AMT
           , OPD.FUNC_MAN_FL_ADJ_AMT
           , OPD.FUNC_FL_ADJ_AMT
           , OPD.FUNC_CSMP_UNIT_CR_AMT
           , OPD.FUNC_CSMP_CR_AMT
           , OPD.FUNC_CSMP_FL_PRC_AMT
           , OPD.FUNC_SVC_COST_TRNSF_AMT
           , OPD.FUNC_WT_SVC_COST_TRNSF_AMT
           , OPD.FUNC_FINAL_FL_PRC_AMT
           , OPD.FUNC_UNIT_LIST_PRC_AMT
           , OPD.FUNC_NET_UNIT_PRC_AMT
           , OPD.FUNC_NET_SELL_PRC_AMT
           , OPD.FUNC_INIT_REP_REV_AMT
           , OPD.FUNC_GENL_REP_REV_ADJ_AMT
           , OPD.FUNC_SPEC_REP_REV_ADJ_AMT
           , OPD.FUNC_MAN_REP_REV_ADJ_AMT
           , OPD.FUNC_REP_REV_ADJ_AMT
           , OPD.FUNC_SVC_REV_TRNSF_AMT
           , OPD.FUNC_WT_SVC_REV_TRNSF_AMT
           , OPD.FUNC_FINAL_REP_REV_AMT
           , OPD.FUNC_UNIT_MSRP_AMT
           , OPD.FUNC_UNIT_STD_COST_AMT
           , OPD.FUNC_FINAL_STD_COST_AMT
           , OPD.FUNC_WT_MAN_FL_ADJ_AMT                -- QC7707
           , OPD.FUNC_WT_MAN_REV_ADJ_AMT               -- QC7707
           , OPD.FUNC_FINAL_UNIT_FL_PRC_AMT            -- QC7707
           , OPD.FUNC_FINAL_UNIT_REV_AMT               -- QC7707
           , OPD.CSMP_CONTR_NUM
           , OPD.DLR_REF_NUM
           , OPD.CSMP_CONTR_START_DT
           , OPD.CSMP_CONTR_END_DT
           , OPD.CHNG_ORD_FLG
           , OPD.COA_MDSE_TP_CD
           , OPD.COA_PROD_CD
           , OPD.MDSE_ITEM_TP_CD
           , OPD.LAST_PRFT_CALC_USR_ID
           , OPD.LAST_PRFT_CALC_TS
           , OPD.ORD_PRFT_RULE_TP_CD
           , OPD.FL_PRC_CALC_INCL_FLG
           , OPD.REP_REV_CALC_INCL_FLG
           , OPD.DISC_MDSE_TP_FLG
           , OPD.RED_FL_PRC_FLG
           , OPD.RED_REP_REV_FLG
           , OPD.DISC_ALLOC_METH_CD
           , OPD.DLR_CR_PRFT_INCL_FLG
           , OPD.RED_COMP_AMT_FLG
        FROM
             ORD_PRFT     OP
           , ORD_PRFT_DTL OPD
<!-- QC#16155 Mod Start -->
<!--       , ALL_MDSE_V   M  -->
           ,(
             SELECT
                 M1.GLBL_CMPY_CD
               , M1.EZCANCELFLAG
               , M1.MDSE_CD
               , M1.MDSE_DESC_SHORT_TXT
             FROM
                 MDSE M1
             WHERE
                 M1.GLBL_CMPY_CD     = #glblCmpyCd#
                 AND M1.EZCANCELFLAG = '0'
             UNION ALL
             SELECT
                 OTM.GLBL_CMPY_CD
               , OTM.EZCANCELFLAG
               , OTM.ORD_TAKE_MDSE_CD AS MDSE_CD
               , M2.MDSE_DESC_SHORT_TXT
             FROM
                 ORD_TAKE_MDSE OTM
               , MDSE M2
             WHERE
               OTM.GLBL_CMPY_CD      = #glblCmpyCd#
               AND OTM.EZCANCELFLAG  = '0'
               AND OTM.GLBL_CMPY_CD  = M2.GLBL_CMPY_CD
               AND OTM.MDSE_CD       = M2.MDSE_CD
               AND M2.EZCANCELFLAG = '0'
            ) M
<!-- QC#16155 Mod End -->
           , PRC_CATG     FPC                         -- 2016/03/10 S21_NA2939
           , PRC_CATG     CPC                         -- 2016/03/10 S21_NA2939
        WHERE
                 OP.GLBL_CMPY_CD = #glblCmpyCd#
             AND OP.TRX_HDR_NUM = (
                                    SELECT
                                          C.ORD_SRC_REF_NUM
                                    FROM
                                          CPO C
                                    WHERE
                                             C.GLBL_CMPY_CD  = #glblCmpyCd#
                                         <!-- START 2017/10/17 H.Sugawara [QC#21773,MOD] -->
                                         <!-- AND C.CPO_SRC_TP_CD = #creditAndRebillEntry# -->
                                         AND (
                                             C.CPO_SRC_TP_CD = #cpoSrcTpCdCredit#
                                             OR
                                             C.CPO_SRC_TP_CD = #cpoSrcTpCdRebill#
                                             )
                                         <!-- END 2017/10/17 H.Sugawara [QC#21773,MOD] -->
                                         AND C.CPO_ORD_NUM   = #cpoOrdNum#
                                         AND C.EZCANCELFLAG  = '0'
             )
             AND OP.ORD_PRFT_VRSN_NUM = (
                                   SELECT
                                         MAX(OPW.ORD_PRFT_VRSN_NUM)
                                   FROM
                                         ORD_PRFT OPW
                                   WHERE
                                            OPW.GLBL_CMPY_CD = OP.GLBL_CMPY_CD
                                        AND OPW.TRX_HDR_NUM  = OP.TRX_HDR_NUM
                                        AND OPW.EZCANCELFLAG = '0'
             )
             AND OP.EZCANCELFLAG = '0'
             AND OP.GLBL_CMPY_CD      = OPD.GLBL_CMPY_CD
             AND OP.TRX_HDR_NUM       = OPD.TRX_HDR_NUM
             AND OP.ORD_PRFT_VRSN_NUM = OPD.ORD_PRFT_VRSN_NUM
             AND OPD.EZCANCELFLAG     = '0'
             AND OPD.GLBL_CMPY_CD     = M.GLBL_CMPY_CD        -- 2016/03/10 S21_NA2939
             AND OPD.MDSE_CD          = M.MDSE_CD             -- 2016/03/10 S21_NA2939
             AND M.EZCANCELFLAG       = '0'                   -- 2016/03/10 S21_NA2939
             AND OPD.GLBL_CMPY_CD     = CPC.GLBL_CMPY_CD(+)   -- 2016/03/10 S21_NA2939
             AND OPD.CSMP_PRC_LIST_CD = CPC.PRC_CATG_CD(+)    -- 2016/03/10 S21_NA2939
             AND CPC.EZCANCELFLAG(+)  = '0'                   -- 2016/03/10 S21_NA2939
             AND OPD.GLBL_CMPY_CD     = FPC.GLBL_CMPY_CD(+)   -- 2016/03/10 S21_NA2939
             AND OPD.FL_PRC_LIST_CD   = FPC.PRC_CATG_CD(+)    -- 2016/03/10 S21_NA2939
             AND FPC.EZCANCELFLAG(+)  = '0'                   -- 2016/03/10 S21_NA2939
             ORDER BY
                    OPD.TRX_LINE_NUM
                  , OPD.TRX_LINE_SUB_NUM
    </statement>

    <statement id="getPrftRuleTp" parameterClass="Map" resultClass="Map">
        SELECT
             NP.ORD_PRFT_RULE_TP_CD
           , NP.ORD_PROC_NODE_PRFL_CD
        FROM
             DS_ORD_TP_PROC_DFN PD
           , ORD_PRFT_NODE_PRFL NP
        WHERE
                 PD.GLBL_CMPY_CD = #glblCmpyCd#
             AND PD.DS_ORD_TP_CD = #dsOrdTpCd#
             AND PD.ACTV_FLG     = 'Y'
             AND PD.EZCANCELFLAG = '0'
             AND PD.GLBL_CMPY_CD = NP.GLBL_CMPY_CD
             AND PD.PRFT_APVL_NODE_PRFL_CD = NP.ORD_PROC_NODE_PRFL_CD
             AND PD.EFF_FROM_DT  &lt;= #slsDt#                           -- 2016/03/10 S21_NA2939
             AND (PD.EFF_THRU_DT &gt;= #slsDt# OR PD.EFF_THRU_DT IS NULL ) -- 2016/03/10 S21_NA2939
             AND NP.EZCANCELFLAG = '0'
    </statement>

    <statement id="getNewVrsnNum" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             NVL(MAX(OP.ORD_PRFT_VRSN_NUM), 0) + 1
        FROM
             ORD_PRFT OP
        WHERE
                OP.GLBL_CMPY_CD = #glblCmpyCd#
            AND OP.TRX_HDR_NUM  = #trxHdrNum#
            AND OP.EZCANCELFLAG = '0'
    </statement>

    <statement id="getDsOrdLineCatgCd" parameterClass="Map" resultClass="String">
        SELECT
             VS.DS_ORD_LINE_CATG_CD
        FROM
             ORD_LINE_VAL_SET VS
        WHERE
                VS.GLBL_CMPY_CD       = #glblCmpyCd#
            AND VS.ORD_LINE_CTX_TP_CD = #prtSvcLine#
            AND VS.EZCANCELFLAG       = '0'
    </statement>

    <statement id="getMSRPAmt" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             NVL (PLE.PRC_LIST_EQUIP_PRC_AMT, 0) AS PRC_LIST_EQUIP_PRC_AMT     -- 2016/03/10 S21_NA2939
           <!--, M.THIS_MTH_TOT_STD_COST_AMP-->                 -- 2016/03/10 S21_NA2939
        FROM
           <!--  ALL_MDSE_V     M  -->                          -- 2016/03/10 S21_NA2939
           <!--, DS_MDSE_PRC    DMP-->                          -- 2016/03/10 S21_NA2939
             PRC_CATG    DPC
           , PRC_LIST_EQUIP PLE
           <!-- 2018/05/21 S21_NA#26150 Add Start -->
           , ORD_TAKE_MDSE  OTM
           <!-- 2018/05/21 S21_NA#26150 Add End -->
        WHERE
            <!--    M.GLBL_CMPY_CD         = #glblCmpyCd#-->    -- 2016/03/10 S21_NA2939
            <!--AND M.MDSE_CD              = #mdseCd#    -->    -- 2016/03/10 S21_NA2939
            <!--AND M.RGTN_STS_CD          = #rgtnStsCd# -->    -- 2016/03/10 S21_NA2939
            <!--AND M.EZCANCELFLAG         = '0'         -->    -- 2016/03/10 S21_NA2939
            <!--AND M.GLBL_CMPY_CD         = DMP.GLBL_CMPY_CD(+)-->    -- 2016/03/10 S21_NA2939
            <!--AND M.MDSE_CD              = DMP.MDSE_CD(+)     -->    -- 2016/03/10 S21_NA2939
            <!--AND DMP.EZCANCELFLAG(+)    = '0'                -->    -- 2016/03/10 S21_NA2939
            <!--AND DMP.GLBL_CMPY_CD       = DPC.GLBL_CMPY_CD(+)-->    -- 2016/03/10 S21_NA2939
            <!--AND DMP.PRC_CATG_CD        = DPC.PRC_CATG_CD(+) -->    -- 2016/03/10 S21_NA2939
                DPC.GLBL_CMPY_CD        = #glblCmpyCd#                 -- 2016/03/10 S21_NA2939
            AND DPC.PRC_LIST_TP_CD      = #prcListTpCd# --MSRP
            AND DPC.ACTV_FLG            = 'Y'
            AND DPC.DEL_FLG             = 'N'
            AND DPC.EFF_FROM_DT     &lt;= #slsDt#
            AND (DPC.EFF_THRU_DT    &gt;= #slsDt# OR DPC.EFF_THRU_DT IS NULL ) -- 2016/03/10 S21_NA2939
            AND DPC.EZCANCELFLAG        = '0'

            AND DPC.GLBL_CMPY_CD        = PLE.GLBL_CMPY_CD(+)
            AND DPC.PRC_CATG_CD         = PLE.PRC_CATG_CD(+)
            <!-- 2018/05/21 S21_NA#26150 Del Start -->
            <!-- AND PLE.PRC_QLFY_VAL_TXT    = #mdseCd# -->                   -- 2016/03/10 S21_NA2939
            <!-- 2018/05/21 S21_NA#26150 Del End -->
            AND PLE.PRC_QLFY_TP_CD(+)   = #prcQlfyTpCd#        --'ITEMCODE'
            AND PLE.EFF_FROM_DT(+)  &lt;= #slsDt#
            AND (PLE.EFF_THRU_DT    &gt;= #slsDt# OR PLE.EFF_THRU_DT IS NULL ) -- 2016/03/10 S21_NA2939
            AND PLE.DEL_FLG(+)          = 'N'
            AND PLE.EZCANCELFLAG(+)     = '0'

            <!-- 2018/05/21 S21_NA#26150 Add Start -->
            <!-- QC#27125 2018/07/25 mod Start -->
            <!-- AND PLE.GLBL_CMPY_CD        = OTM.GLBL_CMPY_CD(+) -->
            AND DPC.GLBL_CMPY_CD        = OTM.GLBL_CMPY_CD(+)
            <!-- QC#27125 2018/07/25 mod End -->
            AND OTM.MDSE_CD(+)          = #mdseCd#
            AND OTM.EZCANCELFLAG(+)     = '0'
            AND PLE.PRC_QLFY_VAL_TXT    = NVL(OTM.ORD_TAKE_MDSE_CD, #mdseCd#)
            <!-- 2018/05/21 S21_NA#26150 Add End -->

    </statement>

    <statement id="getFinderFeeCnt" parameterClass="Map" resultClass="Integer">
        SELECT
             COUNT(BC.GLBL_CMPY_CD)
        FROM
             ORD_CATG_BIZ_CTX BC
           , DS_RTL_INTG_ITEM_MAP IIM
        WHERE
                BC.GLBL_CMPY_CD            = #glblCmpyCd#
            AND BC.ORD_CATG_CTX_TP_CD      = #ordCatgCtxTp# --'RETAIL_ORDER_TYPE'
            <!--AND BC.DS_ORD_CATG_CD          = #dsOrdCatgCd#--> -- 2016/03/10 S21_NA2939
            <!--AND BC.DS_ORD_RSN_CD           = #dsOrdRsnCd#-->  -- 2016/03/10 S21_NA2939
            <!-- 2016/03/10 Start S21_NA#2939 -->
            AND
            (
               (    BC.DS_ORD_CATG_CD      = #dsOrdCatgCd#
                AND BC.DS_ORD_TP_CD        = #dsOrdTpCd#
                AND BC.DS_ORD_RSN_CD       = #dsOrdRsnCd#)
              OR
               (    BC.DS_ORD_CATG_CD      = #dsOrdCatgCd#
                AND BC.DS_ORD_TP_CD        = #dsOrdTpCd#
                AND BC.DS_ORD_RSN_CD       IS NULL)
              OR
               (    BC.DS_ORD_CATG_CD      = #dsOrdCatgCd#
                AND BC.DS_ORD_TP_CD        IS NULL
                AND BC.DS_ORD_RSN_CD       IS NULL)
              OR
               (    BC.DS_ORD_CATG_CD      IS NULL
                AND BC.DS_ORD_TP_CD        IS NULL
                AND BC.DS_ORD_RSN_CD       IS NULL)
            )
            <!-- 2016/03/10 End S21_NA#2939 -->
            AND BC.EZCANCELFLAG            = '0'
            AND BC.GLBL_CMPY_CD            = IIM.GLBL_CMPY_CD
            AND BC.FIRST_BIZ_CTX_ATTRB_TXT = IIM.RTL_DIV_CD
            AND IIM.FNDG_MDSE_CD           = #fndgMdseCd#
            AND IIM.DS_ORD_LINE_CATG_CD    = #dsOrdLineCatgCd#
            AND IIM.EFF_FROM_DT        &lt;= #slsDt#
            AND (IIM.EFF_THRU_DT       &gt;= #slsDt# OR IIM.EFF_THRU_DT IS NULL ) -- 2016/03/10 S21_NA2939
            AND IIM.EZCANCELFLAG           = '0'
    </statement>

    <statement id="getIstlCrCnt" parameterClass="Map" resultClass="Integer">
        SELECT
             COUNT(BC.GLBL_CMPY_CD)
        FROM
             ORD_CATG_BIZ_CTX BC
           , DS_RTL_INTG_ITEM_MAP IIM
        WHERE
                BC.GLBL_CMPY_CD            = #glblCmpyCd#
            AND BC.ORD_CATG_CTX_TP_CD      = #ordCatgCtxTp# --'RETAIL_ORDER_TYPE'
            <!--AND BC.DS_ORD_CATG_CD          = #dsOrdCatgCd#--> -- 2016/03/10 S21_NA2939
            <!--AND BC.DS_ORD_RSN_CD           = #dsOrdRsnCd#-->  -- 2016/03/10 S21_NA2939
            <!-- 2016/03/10 Start S21_NA#2939 -->
            AND
            (
               (    BC.DS_ORD_CATG_CD      = #dsOrdCatgCd#
                AND BC.DS_ORD_TP_CD        = #dsOrdTpCd#
                AND BC.DS_ORD_RSN_CD       = #dsOrdRsnCd#)
              OR
               (    BC.DS_ORD_CATG_CD      = #dsOrdCatgCd#
                AND BC.DS_ORD_TP_CD        = #dsOrdTpCd#
                AND BC.DS_ORD_RSN_CD       IS NULL)
              OR
               (    BC.DS_ORD_CATG_CD      = #dsOrdCatgCd#
                AND BC.DS_ORD_TP_CD        IS NULL
                AND BC.DS_ORD_RSN_CD       IS NULL)
              OR
               (    BC.DS_ORD_CATG_CD      IS NULL
                AND BC.DS_ORD_TP_CD        IS NULL
                AND BC.DS_ORD_RSN_CD       IS NULL)
            )
            <!-- 2016/03/10 End S21_NA#2939 -->
            AND BC.EZCANCELFLAG            = '0'
            AND BC.GLBL_CMPY_CD            = IIM.GLBL_CMPY_CD
            AND BC.FIRST_BIZ_CTX_ATTRB_TXT = IIM.RTL_DIV_CD
            AND IIM.ISTL_MDSE_CD           = #istlMdseCd#
            AND IIM.DS_ORD_LINE_CATG_CD    = #dsOrdLineCatgCd#
            AND IIM.EFF_FROM_DT        &lt;= #slsDt#
            AND (IIM.EFF_THRU_DT       &gt;= #slsDt# OR IIM.EFF_THRU_DT IS NULL ) -- 2016/03/10 S21_NA2939
            AND IIM.EZCANCELFLAG           = '0'
    </statement>

    <statement id="getSplyCnt" parameterClass="Map" resultClass="Integer">
        SELECT
             COUNT(VS.GLBL_CMPY_CD)
        FROM
             MDSE_TP_VAL_SET VS
           , ALL_MDSE_V M
        WHERE
                VS.GLBL_CMPY_CD      = #glblCmpyCd#
            AND VS.MDSE_TP_CTX_TP_CD = #mdseTpCtxTpCd# --'PRFT_SPLY_AMT_ITEMS'
            AND VS.EZCANCELFLAG      = '0' 
            AND VS.GLBL_CMPY_CD      = M.GLBL_CMPY_CD
            AND VS.COA_MDSE_TP_CD    = M.COA_MDSE_TP_CD
            AND M.MDSE_CD            = #mdseCd#
            <!--AND M.RGTN_STS_CD        = #rgtnStsCd#-->     --'P20'       -- 2016/03/10 S21_NA2939
            AND M.EZCANCELFLAG       = '0'
    </statement>

    <statement id="getSvcCnt" parameterClass="Map" resultClass="Integer">
        SELECT
             COUNT(VS.GLBL_CMPY_CD)
        FROM
             MDSE_TP_VAL_SET VS
           , ALL_MDSE_V M
        WHERE
                VS.GLBL_CMPY_CD      = #glblCmpyCd#
            AND VS.MDSE_TP_CTX_TP_CD = #mdseTpCtxTpCd# --'PRFT_SVC_AMT_ITEMS'
            AND VS.EZCANCELFLAG      = '0' 
            AND VS.GLBL_CMPY_CD      = M.GLBL_CMPY_CD
            AND VS.COA_MDSE_TP_CD    = M.COA_MDSE_TP_CD
            AND M.MDSE_CD            = #mdseCd#
            <!--AND M.RGTN_STS_CD        = #rgtnStsCd#-->     --'P20'       -- 2016/03/10 S21_NA2939
            AND M.EZCANCELFLAG       = '0'
    </statement>

    <statement id="getSvcOrdInfo" parameterClass="Map" resultClass="Map">
        SELECT
            SHELL.SHELL_LINE_NUM
            , SHELL.SVC_PGM_MDSE_CD
            ,'' MAINT_PRC_CATG_CD
            ,'' MAINT_FL_PRC_CATG_CD
            , SHELL.TOT_BASE_PRC_FUNC_AMT
        FROM
            (
                SELECT
                    DCD.CPO_ORD_NUM
                    ,DCD.DS_CONTR_PK
                    ,DCD.SHELL_LINE_NUM
                    ,DC.SVC_PGM_MDSE_CD
                    ,DCD.TOT_BASE_PRC_FUNC_AMT
                    ,ROW_NUMBER() OVER(PARTITION BY DCD.CPO_ORD_NUM, DCD.DS_CONTR_PK ORDER BY DCD.CPO_ORD_NUM, DCD.DS_CONTR_PK) ROW_NUM
                FROM
                    DS_CONTR_DTL DCD
                    , DS_CONTR DC
                WHERE
                        DCD.GLBL_CMPY_CD       = #glblCmpyCd#
                    AND (DCD.CPO_ORD_NUM       = #trxHdrNum#
                        OR (
                             DCD.CPO_ORD_NUM = (
                               SELECT
                                         WC.ORD_SRC_REF_NUM
                                   FROM
                                       CPO WC
                                   WHERE
                                       WC.GLBL_CMPY_CD      = #glblCmpyCd#
                                       AND WC.CPO_ORD_NUM   = #trxHdrNum#
                                       AND WC.CPO_SRC_TP_CD = #cpoSrcTpCd#    --'CHANGEORDER'
                                       AND WC.EZCANCELFLAG  = '0'
                             )
                            )
                        )
                    AND DCD.BILL_WITH_EQUIP_FLG   = 'Y'
                    AND DCD.EZCANCELFLAG          = '0'

                    AND DCD.GLBL_CMPY_CD = DC.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_PK = DC.DS_CONTR_PK
                    AND DCD.SHELL_LINE_NUM IS NOT NULL
                    AND DC.EZCANCELFLAG = '0'
            ) SHELL
        WHERE
            ROW_NUM = 1
        ORDER BY SHELL.SHELL_LINE_NUM
    </statement>

    <statement id="getChngOrdInfo" parameterClass="Map" resultClass="Map">
        SELECT
            CO.*
        FROM
<!-- QC#10321-18 Del Start
            CHNG_ORD CO
     QC#10321-18 Del End -->
<!-- QC#10321-18 Add Start -->
            (SELECT
                       C.CPO_ORD_NUM
                     , CD.CPO_DTL_LINE_NUM           TRX_LINE_NUM
                     , CD.CPO_DTL_LINE_SUB_NUM       TRX_LINE_SUB_NUM
                     , CD.DS_ORD_POSN_NUM
                     , CD.DS_CPO_LINE_NUM
                     , CD.DS_CPO_LINE_SUB_NUM
                     , CD.MDSE_CD
                     , CD.RTL_WH_CD
                     , CD.RTL_SWH_CD
                     , CD.DS_ORD_LINE_CATG_CD
                     , CD.ORD_QTY
                     , CD.CUST_UOM_CD
                     , CD.FL_PRC_LIST_CD
                     , CD.FUNC_PRC_LIST_PRC_AMT
                     , CD.ENT_FUNC_NET_UNIT_PRC_AMT  FUNC_NET_UNIT_PRC_AMT
                     , CD.CPO_DTL_FUNC_NET_AMT       FUNC_NET_AMT
                     , CD.FUNC_MAN_FL_ADJ_AMT
                     , CD.FUNC_SVC_COST_TRNSF_AMT
                     , CD.FUNC_MAN_REP_REV_ADJ_AMT
                     , CD.FUNC_SVC_REV_TRNSF_AMT
                     , DCC.CONFIG_CATG_CD
                     , CD.CSMP_PRC_LIST_CD
                     , CD.CPO_DTL_FUNC_SLS_AMT
                     , CD.ORD_CUST_UOM_QTY
                     , CD.CSMP_CONTR_NUM            DTL_CSMP_CONTR_NUM
                     , CD.DLR_REF_NUM               DTL_DLR_REF_NUM
                     , CD.PRC_CATG_CD
                     , CD.ORD_LINE_STS_CD            LINE_STS_CD
                     , C.BILL_TO_CUST_CD
                     , CD.SHIP_TO_CUST_CD
                     , M.THIS_MTH_TOT_STD_COST_AMT
                     , CD.FUNC_UNIT_FL_PRC_AMT
                 FROM
                     CPO                 C
                     , DS_CPO_CONFIG     DCC
                     , CPO_DTL           CD
<!-- QC#16155 Mod Start -->
                     , ( 
                        SELECT
                            M1.GLBL_CMPY_CD
                          , M1.EZCANCELFLAG
                          , M1.MDSE_CD
                          , M1.THIS_MTH_TOT_STD_COST_AMT 
                        FROM
                            MDSE M1
                        WHERE
                            M1.GLBL_CMPY_CD     = #glblCmpyCd#
                            AND M1.EZCANCELFLAG = '0'
                        UNION ALL
                        SELECT
                            M2.GLBL_CMPY_CD
                          , M2.EZCANCELFLAG
                          , OTM.ORD_TAKE_MDSE_CD AS MDSE_CD
                          , M2.THIS_MTH_TOT_STD_COST_AMT
                        FROM
                            MDSE M2
                          , ORD_TAKE_MDSE OTM
                        WHERE
                            M2.GLBL_CMPY_CD      = #glblCmpyCd#
                            AND M2.EZCANCELFLAG  = '0'
                            AND M2.GLBL_CMPY_CD  = OTM.GLBL_CMPY_CD
                            AND M2.MDSE_CD       = OTM.MDSE_CD
                            AND OTM.EZCANCELFLAG = '0'
                       ) M
<!-- QC#16155 Mod End -->
                 WHERE
                     C.GLBL_CMPY_CD              = #glblCmpyCd#
                     AND (
                          C.CPO_ORD_NUM = (
                            SELECT
                                      WC.ORD_SRC_REF_NUM
                                FROM
                                    CPO WC
                                WHERE
                                    WC.GLBL_CMPY_CD      = #glblCmpyCd#
                                    AND WC.CPO_ORD_NUM   = #trxHdrNum#
                                    AND WC.CPO_SRC_TP_CD = #cpoSrcTpCd#
                                    AND WC.EZCANCELFLAG  = '0'
                          )
                          OR (
                               C.ORD_SRC_REF_NUM = (
                                  SELECT
                                            WC.ORD_SRC_REF_NUM
                                      FROM
                                          CPO WC
                                      WHERE
                                          WC.GLBL_CMPY_CD      = #glblCmpyCd#
                                          AND WC.CPO_ORD_NUM   = #trxHdrNum#
                                          AND WC.CPO_SRC_TP_CD = #cpoSrcTpCd#
                                          AND WC.EZCANCELFLAG  = '0'
                              )
                              AND C.CPO_SRC_TP_CD = #cpoSrcTpCd#
                            )
                         )
                     AND C.CPO_ORD_NUM          != #trxHdrNum#
                     AND C.EZCANCELFLAG          = '0'
                     AND C.GLBL_CMPY_CD          = CD.GLBL_CMPY_CD
                     AND C.CPO_ORD_NUM           = CD.CPO_ORD_NUM
                     AND CD.CPO_DTL_CANC_FLG     = 'N'
                     AND CD.SET_MDSE_CD         IS NULL
                     AND CD.EZCANCELFLAG         = '0'
                     AND CD.GLBL_CMPY_CD        = DCC.GLBL_CMPY_CD
                     AND CD.CPO_ORD_NUM         = DCC.CPO_ORD_NUM
                     AND CD.DS_ORD_POSN_NUM     = DCC.DS_ORD_POSN_NUM
                     AND DCC.CONFIG_CATG_CD      = #outBound#
                     AND DCC.EZCANCELFLAG        = '0'
                     AND CD.GLBL_CMPY_CD         = M.GLBL_CMPY_CD
                     AND CD.MDSE_CD              = M.MDSE_CD
                     AND M.EZCANCELFLAG          = '0'
             UNION ALL 
             SELECT
                       C.CPO_ORD_NUM
                     , DCRD.DS_CPO_RTRN_LINE_NUM       TRX_LINE_NUM
                     , DCRD.DS_CPO_RTRN_LINE_SUB_NUM   TRX_LINE_SUB_NUM
                     , DCRD.DS_ORD_POSN_NUM
                     , DCRD.DS_CPO_LINE_NUM
                     , DCRD.DS_CPO_LINE_SUB_NUM
                     , DCRD.MDSE_CD
                     , DCRD.RTL_WH_CD
                     , DCRD.RTL_SWH_CD
                     , DCRD.DS_ORD_LINE_CATG_CD
                     , DCRD.ORD_QTY
                     , DCRD.CUST_UOM_CD
                     , DCRD.FL_PRC_LIST_CD
                     , DCRD.FUNC_PRC_LIST_PRC_AMT
                     , DCRD.ENT_FUNC_NET_UNIT_PRC_AMT  FUNC_NET_UNIT_PRC_AMT
                     , DCRD.CPO_DTL_FUNC_NET_AMT       FUNC_NET_AMT
                     , DCRD.FUNC_MAN_FL_ADJ_AMT
                     , DCRD.FUNC_SVC_COST_TRNSF_AMT
                     , DCRD.FUNC_MAN_REP_REV_ADJ_AMT
                     , DCRD.FUNC_SVC_REV_TRNSF_AMT
                     , DCC.CONFIG_CATG_CD
                     , DCRD.CSMP_PRC_LIST_CD
                     , DCRD.CPO_DTL_FUNC_SLS_AMT
                     , DCRD.ORD_CUST_UOM_QTY
                     , DCRD.CSMP_CONTR_NUM            DTL_CSMP_CONTR_NUM
                     , DCRD.DLR_REF_NUM               DTL_DLR_REF_NUM
                     , DCRD.PRC_CATG_CD
                     , DCRD.RTRN_LINE_STS_CD          LINE_STS_CD
                     , C.BILL_TO_CUST_CD
                     , DCRD.SHIP_TO_CUST_CD
                     , M.THIS_MTH_TOT_STD_COST_AMT
                     , DCRD.FUNC_UNIT_FL_PRC_AMT
                 FROM
                     CPO                 C
                     , DS_CPO_CONFIG     DCC
                     , DS_CPO_RTRN_DTL   DCRD
<!-- QC#16155 Mod Start -->
<!--                 , ALL_MDSE_V        M -->
                     , MDSE              M 
<!-- QC#16155 Mod End -->
                 WHERE
                     C.GLBL_CMPY_CD              = #glblCmpyCd#
                     AND (
                          C.CPO_ORD_NUM = (
                            SELECT
                                      WC.ORD_SRC_REF_NUM
                                FROM
                                    CPO WC
                                WHERE
                                    WC.GLBL_CMPY_CD      = #glblCmpyCd#
                                    AND WC.CPO_ORD_NUM   = #trxHdrNum#
                                    AND WC.CPO_SRC_TP_CD = #cpoSrcTpCd#
                                    AND WC.EZCANCELFLAG  = '0'
                          )
                          OR (
                               C.ORD_SRC_REF_NUM = (
                            SELECT
                                      WC.ORD_SRC_REF_NUM
                                FROM
                                    CPO WC
                                WHERE
                                    WC.GLBL_CMPY_CD      = #glblCmpyCd#
                                    AND WC.CPO_ORD_NUM   = #trxHdrNum#
                                    AND WC.CPO_SRC_TP_CD = #cpoSrcTpCd#
                                    AND WC.EZCANCELFLAG  = '0'
                          )
                          AND C.CPO_SRC_TP_CD = #cpoSrcTpCd#)
                         )
                     AND C.CPO_ORD_NUM          != #trxHdrNum#
                     AND C.EZCANCELFLAG          = '0'
                     AND C.GLBL_CMPY_CD          = DCRD.GLBL_CMPY_CD
                     AND C.CPO_ORD_NUM           = DCRD.CPO_ORD_NUM
                     AND DCRD.CPO_DTL_CANC_FLG   = 'N'
                     AND DCRD.SET_MDSE_CD         IS NULL
                     AND DCRD.EZCANCELFLAG       = '0'
                     AND DCRD.GLBL_CMPY_CD       = DCC.GLBL_CMPY_CD
                     AND DCRD.CPO_ORD_NUM        = DCC.CPO_ORD_NUM
                     AND DCRD.DS_ORD_POSN_NUM    = DCC.DS_ORD_POSN_NUM
                     AND DCC.CONFIG_CATG_CD      = #inBound#
                     AND DCC.EZCANCELFLAG        = '0'
                     AND DCRD.GLBL_CMPY_CD       = M.GLBL_CMPY_CD
                     AND DCRD.MDSE_CD            = M.MDSE_CD
                     AND M.EZCANCELFLAG          = '0'
            ) CO
<!-- QC#10321-18 Add End -->
        ORDER BY
            CO.CPO_ORD_NUM
          , CO.TRX_LINE_NUM
          , CO.TRX_LINE_SUB_NUM
    </statement>

    <statement id="getTotByotAmt" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             SUM(CD.CPO_DTL_FUNC_NET_AMT)
        FROM
             CPO_DTL CD
        WHERE
                CD.GLBL_CMPY_CD         = #glblCmpyCd#
            AND CD.CPO_ORD_NUM          = #trxHdrNum#
            AND CD.EZCANCELFLAG         = '0'
            AND CD.DS_ORD_LINE_CATG_CD IN (
                               SELECT
                                    VS.DS_ORD_LINE_CATG_CD
                               FROM
                                    ORD_LINE_VAL_SET VS
                               WHERE
                                       VS.GLBL_CMPY_CD       = #glblCmpyCd#
                                   AND VS.ORD_LINE_CTX_TP_CD = #ordLineCtxTpCd#    --'LEASE_BUYOUT'
                                   AND VS.EZCANCELFLAG       = '0'
            )
    </statement>

    <statement id="getCoaMdseTpList" parameterClass="Map" resultClass="String">
        SELECT
             VS.COA_MDSE_TP_CD 
        FROM
             MDSE_TP_VAL_SET VS 
        WHERE
                VS.GLBL_CMPY_CD      = #glblCmpyCd#
            AND VS.MDSE_TP_CTX_TP_CD = #profServices#
            AND VS.EZCANCELFLAG      = '0'
    </statement>

    <!-- QC7707 -->
    <statement id="getDiscAllocMethList" parameterClass="Map" resultClass="Map">
        SELECT
             VS.MDSE_TP_CTX_TP_CD
            ,OPMTR.DISC_ALLOC_METH_CD 
        FROM
             MDSE_TP_VAL_SET VS
            ,ORD_PRFT_MDSE_TP_RULE OPMTR
        WHERE
                VS.GLBL_CMPY_CD           = #glblCmpyCd#
            AND VS.MDSE_TP_CTX_TP_CD     IN
            <iterate property="mdseTpCtxTpList" var="mdseTpCtxTpCd[]" open="(" close=")" conjunction=",">
               #mdseTpCtxTpCd[]#
            </iterate>
            AND VS.EZCANCELFLAG           = '0'
            AND VS.GLBL_CMPY_CD           = OPMTR.GLBL_CMPY_CD
            AND VS.COA_MDSE_TP_CD         = OPMTR.COA_MDSE_TP_CD
            AND OPMTR.ORD_PRFT_RULE_TP_CD = #ordPrftRuleTpCd#
            AND OPMTR.EZCANCELFLAG        = '0'
    </statement>

    <!-- 2016/03/10 End S21_NA#2939 -->
    <statement id="isRetailOrder" parameterClass="Map" resultClass="Integer">
        SELECT
             COUNT(BC.GLBL_CMPY_CD)
        FROM
             ORD_CATG_BIZ_CTX BC
        WHERE
                BC.GLBL_CMPY_CD            = #glblCmpyCd#
            AND BC.ORD_CATG_CTX_TP_CD      = #ordCatgCtxTp# --'RETAIL_ORDER_TYPE'
            AND
            (
               (    BC.DS_ORD_CATG_CD      = #dsOrdCatgCd#
                AND BC.DS_ORD_TP_CD        = #dsOrdTpCd#
                AND BC.DS_ORD_RSN_CD       = #dsOrdRsnCd#)
              OR
               (    BC.DS_ORD_CATG_CD      = #dsOrdCatgCd#
                AND BC.DS_ORD_TP_CD        = #dsOrdTpCd#
                AND BC.DS_ORD_RSN_CD       IS NULL)
              OR
               (    BC.DS_ORD_CATG_CD      = #dsOrdCatgCd#
                AND BC.DS_ORD_TP_CD        IS NULL
                AND BC.DS_ORD_RSN_CD       IS NULL)
              OR
               (    BC.DS_ORD_CATG_CD      IS NULL
                AND BC.DS_ORD_TP_CD        IS NULL
                AND BC.DS_ORD_RSN_CD       IS NULL)
            )
            AND BC.EZCANCELFLAG            = '0'
    </statement>

    <statement id="getLatestPrftDtl" parameterClass="Map" resultClass="Map">
        SELECT  /*+ LEADING(C CD OPD) INDEX(OPD ORD_PRFT_DTL_I1) */
             OPD.TRX_HDR_NUM
           , OPD.TRX_LINE_NUM
           , OPD.TRX_LINE_SUB_NUM
           , OPD.MDSE_INVTY_COST_PCT
        FROM
             ORD_PRFT_DTL OPD
        WHERE
                 OPD.GLBL_CMPY_CD     = #glblCmpyCd#
             AND EXISTS (
                          SELECT 1 
                          FROM   CPO C
                               , CPO_DTL CD
                          WHERE  C.GLBL_CMPY_CD               = OPD.GLBL_CMPY_CD
                             AND C.ORD_SRC_REF_NUM            = OPD.TRX_HDR_NUM
                             AND C.CPO_ORD_NUM                = #cpoOrdNum#
                             AND C.EZCANCELFLAG               = '0'
                             AND CD.CPO_DTL_LINE_NUM          = #cpoDtlLineNum#
                             AND CD.CPO_DTL_LINE_SUB_NUM      = #cpoDtlLineSubNum#
                             AND CD.ORD_SRC_REF_LINE_NUM      = OPD.TRX_LINE_NUM
                             AND CD.ORD_SRC_REF_LINE_SUB_NUM  = OPD.TRX_LINE_SUB_NUM
                         )
             AND OPD.ORD_PRFT_VRSN_NUM = (
                                   SELECT
                                         MAX(OPW.ORD_PRFT_VRSN_NUM)
                                   FROM
                                         ORD_PRFT OPW
                                   WHERE
                                            OPW.GLBL_CMPY_CD = OPD.GLBL_CMPY_CD
                                        AND OPW.TRX_HDR_NUM  = OPD.TRX_HDR_NUM
                                        AND OPW.EZCANCELFLAG = '0'
             )
             AND OPD.ORD_PRFT_TRX_CATG_CD = #ordPrftTrxCatgCd#
             AND OPD.EZCANCELFLAG         = '0'
             AND ROWNUM = '1'
    </statement>

    <statement id="getOrigMdseCd" parameterClass="Map" resultClass="String">
        SELECT
                  DECODE(D.SBST_MDSE_CD, NULL, D.MDSE_CD, D.ORIG_MDSE_CD) ORIG_MDSE_CD
            FROM
                CPO_DTL     D
            WHERE
                D.GLBL_CMPY_CD              = #glblCmpyCd#
                AND D.CPO_ORD_NUM           = #cpoOrdNum#
                AND D.CPO_DTL_LINE_NUM      = #cpoDtlLineNum#
                AND D.CPO_DTL_LINE_SUB_NUM  = #cpoDtlLineSubNum#
                AND D.EZCANCELFLAG          = '0'
    </statement>

    <!-- Add Start 2017/10/10 QC#21664 -->
    <statement id="getOrdLineSrcCatgCd" parameterClass="Map" resultClass="String">
        SELECT
              OLS.ORD_LINE_SRC_CATG_CD 
        FROM
              CPO_DTL CD
            , ORD_LINE_SRC OLS 
        WHERE
                CD.GLBL_CMPY_CD         = #glblCmpyCd#
            AND CD.EZCANCELFLAG         = '0' 
            AND CD.CPO_ORD_NUM          = #cpoOrdNum# 
            AND CD.CPO_DTL_LINE_NUM     = #cpoDtlLineNum# 
            AND CD.CPO_DTL_LINE_SUB_NUM = #cpoDtlLineSubNum# 
            AND CD.GLBL_CMPY_CD         = OLS.GLBL_CMPY_CD 
            AND CD.EZCANCELFLAG         = OLS.EZCANCELFLAG 
            AND CD.ORD_LINE_SRC_CD      = OLS.ORD_LINE_SRC_CD
    </statement>
    <!-- Add End 2017/10/10 QC#21664 -->

</sqlMap>
