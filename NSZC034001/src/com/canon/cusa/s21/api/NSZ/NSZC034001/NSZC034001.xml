<?xml version="1.0" encoding="UTF-8" standalone="yes"?>

<sqlMap namespace="NSZC034001">

    <statement id="getContrBllgInfo" parameterClass="Map" resultClass="Map">
        SELECT
             DCR.DS_CONTR_PK
            ,DCR.PRC_ALLOC_BY_MACH_QTY_FLG
            ,SCB.SVC_CONTR_BLLG_GRP_SQ
            ,SCB.SVC_CONTR_BLLG_FROM_DT
            ,SCB.SVC_CONTR_BLLG_THRU_DT
        FROM
             DS_CONTR          DCR
            ,SVC_CONTR_BLLG    SCB
        WHERE
                DCR.GLBL_CMPY_CD            = #glblCmpyCd#
            AND DCR.DS_CONTR_NUM            = #dsContrNum#
            AND DCR.DS_CONTR_CATG_CD        = #dsContrCatgCd#
            AND DCR.EZCANCELFLAG            = '0'
            AND DCR.GLBL_CMPY_CD            = SCB.GLBL_CMPY_CD
            AND DCR.DS_CONTR_PK             = SCB.DS_CONTR_PK
            AND SCB.USG_CHRG_FLG            = 'Y'
            AND SCB.AGGR_CALC_FLG           = 'Y'
            AND SCB.INV_TP_CD               = #invTpCd#
            AND SCB.SVC_CONTR_BLLG_FROM_DT &lt;= #bllgDt#
            AND SCB.SVC_CONTR_BLLG_THRU_DT &gt;= #bllgDt#
            AND SCB.EZCANCELFLAG            = '0'
        ORDER BY
            SCB.SVC_CONTR_BLLG_GRP_SQ
    </statement>

    <statement id="getRecalcInfo" parameterClass="Map" resultClass="Map">
        SELECT
             SCB.DS_CONTR_BLLG_SCHD_PK
            ,SMM.SVC_MACH_MSTR_PK
            ,SMM.SER_NUM
            ,SCM.SVC_CONTR_MTR_BLLG_PK
            ,SCM.MTR_BLLG_FROM_DT
            ,SCM.MTR_BLLG_THRU_DT
            ,NVL(SCM.PREV_TOT_COPY_QTY, 0)     AS PREV_TOT_COPY_QTY
            ,NVL(SCM.TOT_COPY_QTY, 0)          AS TOT_COPY_QTY
            ,NVL(SCM.COPY_INCL_QTY, 0)         AS COPY_INCL_QTY
            ,NVL(SCM.MTR_COPY_QTY, 0)          AS MTR_COPY_QTY
            ,NVL(SCM.BLLG_COPY_QTY, 0)         AS BLLG_COPY_QTY
            ,NVL(SCM.TEST_COPY_QTY, 0)         AS TEST_COPY_QTY
    <!-- START 2018/0/ K.Kishimoto [QC#23541, ADD] -->
            ,DCM.DS_CONTR_BLLG_MTR_PK
            ,DCM.BLLG_MTR_LB_CD
            ,DCM.BLLG_MIN_CNT
            ,DCM.BLLG_MIN_AMT_RATE
            ,DCM.BLLG_ROLL_OVER_RATIO
            ,DCM.DS_CONTR_BLLG_MTR_PK
            ,DCM.BLLG_MTR_LB_CD
            ,DCM.BLLG_MIN_CNT
            ,DCM.BLLG_MIN_AMT_RATE
            ,DCM.XS_CHRG_TP_CD
            ,DTL.PRNT_DS_CONTR_DTL_PK
            ,CYC.BLLG_CYCLE_MTH_AOT  AS MTR_BLLG_CYCLE_MTH_AOT
            ,CYC.PRRT_DIV_RATE
            ,TOP.PER_BLLG_CYCLE_CD
            ,TOP.PER_SCHD_NUM
            ,TOP.DS_CONTR_BLLG_SCHD_SMRY_PK
    <!-- END   2018/0/ K.Kishimoto [QC#23541, ADD] -->
        FROM
             SVC_CONTR_BLLG          SCB
            ,SVC_MACH_MSTR           SMM
            ,SVC_CONTR_MTR_BLLG      SCM
            ,DS_CONTR_BLLG_MTR       DCM
    <!-- START 2018/0/ K.Kishimoto [QC#23541, ADD] -->
            ,DS_CONTR_DTL            DTL
            ,DS_CONTR_BLLG_SCHD      SCH
            ,DS_CONTR_BLLG_SCHD_SMRY TOP
            ,BLLG_CYCLE              CYC
    <!-- END   2018/0/ K.Kishimoto [QC#23541, ADD] -->
        WHERE
                SCB.GLBL_CMPY_CD            = #glblCmpyCd#
            AND SCB.SVC_CONTR_BLLG_GRP_SQ   = #svcContrBllgGrpSq#
            AND SCB.USG_CHRG_FLG            = 'Y'
            AND SCB.AGGR_CALC_FLG           = 'N'
            AND SCB.EZCANCELFLAG            = '0'
            AND SCB.GLBL_CMPY_CD            = SMM.GLBL_CMPY_CD
            AND SCB.SVC_MACH_MSTR_PK        = SMM.SVC_MACH_MSTR_PK
            AND SMM.EZCANCELFLAG            = '0'
            AND SCB.GLBL_CMPY_CD            = SCM.GLBL_CMPY_CD
            AND SCB.SVC_CONTR_BLLG_PK       = SCM.SVC_CONTR_BLLG_PK
            AND SCM.EZCANCELFLAG            = '0'
            AND SCM.GLBL_CMPY_CD            = DCM.GLBL_CMPY_CD
            AND SCM.DS_CONTR_DTL_PK         = DCM.DS_CONTR_DTL_PK
            AND SCM.DS_CONTR_BLLG_MTR_PK    = DCM.DS_CONTR_BLLG_MTR_PK
            AND DCM.EZCANCELFLAG            = '0'
    <!-- START 2018/0/ K.Kishimoto [QC#23541, ADD] -->
            AND DCM.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
            AND DCM.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
            AND DTL.EZCANCELFLAG            = '0'
            AND SCB.GLBL_CMPY_CD            = SCH.GLBL_CMPY_CD
            AND SCB.DS_CONTR_BLLG_SCHD_PK   = SCH.DS_CONTR_BLLG_SCHD_PK
            AND SCH.EZCANCELFLAG            = '0'
            AND SCH.GLBL_CMPY_CD            = TOP.GLBL_CMPY_CD
            AND SCH.DS_CONTR_BLLG_SCHD_SMRY_PK = TOP.DS_CONTR_BLLG_SCHD_SMRY_PK
            AND TOP.EZCANCELFLAG            = '0'
            AND SCH.GLBL_CMPY_CD          = CYC.GLBL_CMPY_CD
            AND SCH.BLLG_CYCLE_CD         = CYC.BLLG_CYCLE_CD
            AND CYC.EZCANCELFLAG          = '0'
    <!-- END   2018/0/ K.Kishimoto [QC#23541, ADD] -->
        ORDER BY
             DCM.BLLG_MTR_LB_CD
            ,DCM.DS_CONTR_DTL_PK
    </statement>

    <statement id="getExcessInfo" parameterClass="Map" resultClass="Map">
        SELECT
             BSS.CCY_CD
            ,BSM.CONTR_XS_COPY_PK
            ,BSM.XS_MTR_COPY_QTY
            ,BSM.XS_MTR_AMT_RATE
            ,DBM.XS_CHRG_TP_CD
        FROM
             DS_CONTR_BLLG_SCHD        CBS
            ,DS_CONTR_BLLG_SCHD_SMRY   BSS
            ,DS_CONTR_BLLG_SCHD_MTR    BSM
            ,DS_CONTR_BLLG_MTR         DBM
        WHERE
                CBS.GLBL_CMPY_CD               = #glblCmpyCd#
            AND CBS.DS_CONTR_BLLG_SCHD_PK      = #dsContrBllgSchdPk#
            AND CBS.EZCANCELFLAG               = '0'
            AND CBS.GLBL_CMPY_CD               = BSS.GLBL_CMPY_CD
            AND CBS.DS_CONTR_BLLG_SCHD_SMRY_PK = BSS.DS_CONTR_BLLG_SCHD_SMRY_PK
            AND BSS.EZCANCELFLAG               = '0'
            AND BSS.GLBL_CMPY_CD               = BSM.GLBL_CMPY_CD
            AND BSS.DS_CONTR_BLLG_SCHD_SMRY_PK = BSM.DS_CONTR_BLLG_SCHD_SMRY_PK
            AND BSS.DS_CONTR_BLLG_MTR_PK       = BSM.DS_CONTR_BLLG_MTR_PK
            AND BSM.EZCANCELFLAG               = '0'
            AND BSM.GLBL_CMPY_CD               = DBM.GLBL_CMPY_CD
            AND BSM.DS_CONTR_BLLG_MTR_PK       = DBM.DS_CONTR_BLLG_MTR_PK
            AND DBM.EZCANCELFLAG               = '0'
        ORDER BY
             BSM.XS_MTR_COPY_QTY DESC
    </statement>

    <statement id="getSvcContrBllgInfo" parameterClass="Map" resultClass="Map">
        SELECT
             ARD.MTR_CHRG_DEAL_AMT
            ,ARD.MTR_CHRG_FUNC_AMT
            ,ARD.ALLOC_BLLBL_COPY_QTY
            ,ARD.RND_BLLBL_COPY_QTY
            ,ARD.AGGR_ADJ_COPY_QTY
            ,ARD.AGGR_USG_RECAL_DTL_PK
            ,SCB.DS_CONTR_PK
            ,SCB.DS_ACCT_NUM
            ,SCB.BILL_TO_CUST_CD
            ,SCB.INV_TP_CD
            ,SCB.SVC_MACH_MSTR_PK
            ,SCM.SVC_CONTR_MTR_BLLG_PK
            ,SCM.SVC_CONTR_BLLG_PK
            ,SCM.DS_CONTR_DTL_PK
            ,SCM.DS_CONTR_BLLG_MTR_PK
            ,SCM.CCY_CD
            ,DCB.DS_CONTR_BLLG_SCHD_PK
            ,DCB.NEXT_BLLG_DT
            ,DCD.DS_CONTR_DTL_TP_CD
            ,DCD.SVC_PGM_MDSE_CD
            ,CBM.INTG_MDSE_CD
        FROM
             AGGR_USG_RECAL_DTL  ARD
            ,SVC_CONTR_BLLG      SCB
            ,SVC_CONTR_MTR_BLLG  SCM
            ,DS_CONTR_BLLG_SCHD  DCB
            ,DS_CONTR_DTL        DCD
            ,DS_CONTR_BLLG_MTR   CBM
        WHERE
                ARD.GLBL_CMPY_CD            = #glblCmpyCd#
            AND ARD.AGGR_USG_RECAL_PK       = #aggrUsgRecalPk#
            AND ARD.EZCANCELFLAG            = '0'
    <!-- START 2018/04/05 K.Kitachi [QC#23066, DEL] -->
    <!--    AND ARD.AGGR_ADJ_COPY_QTY      != 0     -->
    <!-- END   2018/04/05 K.Kitachi [QC#23066, DEL] -->
            AND ARD.EZCANCELFLAG            = '0'
            AND ARD.GLBL_CMPY_CD            = SCB.GLBL_CMPY_CD
            AND ARD.DS_CONTR_BLLG_SCHD_PK   = SCB.DS_CONTR_BLLG_SCHD_PK
            AND SCB.USG_CHRG_FLG            = 'Y'
            AND SCB.AGGR_CALC_FLG           = 'N'
            AND SCB.EZCANCELFLAG            = '0'
            AND SCB.GLBL_CMPY_CD            = SCM.GLBL_CMPY_CD
            AND SCB.SVC_CONTR_BLLG_PK       = SCM.SVC_CONTR_BLLG_PK
            AND SCM.EZCANCELFLAG            = '0'
            AND SCB.GLBL_CMPY_CD            = DCB.GLBL_CMPY_CD
            AND SCB.DS_CONTR_BLLG_SCHD_PK   = DCB.DS_CONTR_BLLG_SCHD_PK
            AND DCB.EZCANCELFLAG            = '0'
            AND SCB.GLBL_CMPY_CD            = DCD.GLBL_CMPY_CD
            AND SCB.DS_CONTR_DTL_PK         = DCD.DS_CONTR_DTL_PK
            AND DCD.EZCANCELFLAG            = '0'
            AND SCM.GLBL_CMPY_CD            = CBM.GLBL_CMPY_CD(+)
            AND SCM.DS_CONTR_BLLG_MTR_PK    = CBM.DS_CONTR_BLLG_MTR_PK(+)
            AND CBM.EZCANCELFLAG(+)         = '0'
        ORDER BY
             ARD.AGGR_USG_RECAL_DTL_PK
            ,SCM.DS_CONTR_DTL_PK
            ,SCM.DS_CONTR_BLLG_MTR_PK
    </statement>

    <statement id="getAddlChrgInfo" parameterClass="Map" resultClass="Map">
        SELECT
             ACB.SVC_CONTR_ADDL_CHRG_BLLG_PK
            ,ACB.ADDL_CHRG_APLC_PCT
            <!-- START 2017/12/25 K.Kojima [QC#18562,ADD] -->
            ,ACB.ADDL_CHRG_FROM_DT
            ,ACB.ADDL_CHRG_THRU_DT
            ,SCA.SVC_CONTR_BLLG_FROM_DT
            ,SCA.SVC_CONTR_BLLG_THRU_DT
            <!-- END 2017/12/25 K.Kojima [QC#18562,ADD] -->
        FROM
             SVC_CONTR_BLLG            SCB
            ,SVC_CONTR_BLLG            SCA
            ,SVC_CONTR_ADDL_CHRG_BLLG  ACB
        WHERE
                SCB.GLBL_CMPY_CD            = #glblCmpyCd#
            AND SCB.SVC_CONTR_BLLG_PK       = #svcContrBllgPk#
            AND SCB.EZCANCELFLAG            = '0'
            AND SCB.GLBL_CMPY_CD            = SCA.GLBL_CMPY_CD
            AND SCB.DS_CONTR_DTL_PK         = SCA.DS_CONTR_DTL_PK
            AND SCB.SVC_CONTR_BLLG_GRP_SQ   = SCA.SVC_CONTR_BLLG_GRP_SQ
            AND SCA.ADDL_CHRG_FLG           = 'Y'
            AND SCA.EZCANCELFLAG            = '0'
            AND SCA.GLBL_CMPY_CD            = ACB.GLBL_CMPY_CD
            AND SCA.SVC_CONTR_BLLG_PK       = ACB.SVC_CONTR_BLLG_PK
            AND ACB.ADDL_CHRG_APLC_PCT     != 0
            AND ACB.EZCANCELFLAG            = '0'
        ORDER BY
            ACB.SVC_CONTR_ADDL_CHRG_BLLG_PK
    </statement>

    <!-- START 2018/04/05 K.Kitachi [QC#23066, ADD] -->
    <statement id="getChildSummryInfo" parameterClass="Map" resultClass="Map">
        SELECT
             D.DS_CONTR_BLLG_SCHD_PK
            ,SUM(E.MTR_CHRG_DEAL_AMT) MTR_CHRG_DEAL_AMT
            ,SUM(E.MTR_CHRG_FUNC_AMT) MTR_CHRG_FUNC_AMT
            ,SUM(E.SLS_TAX_RATE)      SLS_TAX_RATE
            ,SUM(E.DEAL_TAX_AMT)      DEAL_TAX_AMT
            ,SUM(E.FUNC_TAX_AMT)      FUNC_TAX_AMT
        FROM
             DS_CONTR           A
            ,DS_CONTR_DTL       B
            ,DS_CONTR_BLLG_MTR  C
            ,DS_CONTR_BLLG_SCHD D
            ,DS_CONTR_BLLG_SCHD E
        WHERE
                A.GLBL_CMPY_CD              = #glblCmpyCd#
            AND A.DS_CONTR_NUM              = #dsContrNum#
            AND A.DS_CONTR_CATG_CD          = #dsContrCatgCd#
            AND A.EZCANCELFLAG              = '0'
            AND A.GLBL_CMPY_CD              = B.GLBL_CMPY_CD
            AND A.DS_CONTR_PK               = B.DS_CONTR_PK
            AND B.DS_CONTR_DTL_TP_CD        = #dsContrDtlTpCd#
            AND B.EZCANCELFLAG              = '0'
            AND B.GLBL_CMPY_CD              = C.GLBL_CMPY_CD
            AND B.DS_CONTR_DTL_PK           = C.DS_CONTR_DTL_PK
            AND C.EZCANCELFLAG              = '0'
            AND C.GLBL_CMPY_CD              = D.GLBL_CMPY_CD
            AND C.DS_CONTR_BLLG_MTR_PK      = D.DS_CONTR_BLLG_MTR_PK
            AND D.USG_CHRG_FLG              = 'Y'
            AND D.INV_TP_CD                 = #invTpCd#
            AND D.BLLG_SCHD_FROM_DT     &lt;= #bllgDt#
            AND D.BLLG_SCHD_THRU_DT     &gt;= #bllgDt#
            AND D.EZCANCELFLAG              = '0'
            AND D.GLBL_CMPY_CD              = E.GLBL_CMPY_CD
            AND D.DS_CONTR_BLLG_SCHD_PK     = E.PRNT_DS_CONTR_BLLG_SCHD_PK
            AND E.USG_CHRG_FLG              = 'Y'
            AND E.INV_TP_CD                 = #invTpCd#
            AND E.BLLG_SCHD_FROM_DT     &lt;= #bllgDt#
            AND E.BLLG_SCHD_THRU_DT     &gt;= #bllgDt#
            AND E.EZCANCELFLAG              = '0'
        GROUP BY
            D.DS_CONTR_BLLG_SCHD_PK
    </statement>
     <!-- END 2018/04/05 K.Kitachi [QC#23066, ADD] -->
    <!-- START 2018/0/ K.Kishimoto [QC#23541, ADD] -->
    <statement id="getExcessInfoAsc" parameterClass="Map" resultClass="Map">
        SELECT
             BSS.CCY_CD
            ,BSM.CONTR_XS_COPY_PK
            ,BSM.XS_MTR_COPY_QTY
            ,BSM.XS_MTR_AMT_RATE
            ,DBM.XS_CHRG_TP_CD
        FROM
             DS_CONTR_BLLG_SCHD        CBS
            ,DS_CONTR_BLLG_SCHD_SMRY   BSS
            ,DS_CONTR_BLLG_SCHD_MTR    BSM
            ,DS_CONTR_BLLG_MTR         DBM
        WHERE
                CBS.GLBL_CMPY_CD               = #glblCmpyCd#
            AND CBS.DS_CONTR_BLLG_SCHD_PK      = #dsContrBllgSchdPk#
            AND CBS.EZCANCELFLAG               = '0'
            AND CBS.GLBL_CMPY_CD               = BSS.GLBL_CMPY_CD
            AND CBS.DS_CONTR_BLLG_SCHD_SMRY_PK = BSS.DS_CONTR_BLLG_SCHD_SMRY_PK
            AND BSS.EZCANCELFLAG               = '0'
            AND BSS.GLBL_CMPY_CD               = BSM.GLBL_CMPY_CD
            AND BSS.DS_CONTR_BLLG_SCHD_SMRY_PK = BSM.DS_CONTR_BLLG_SCHD_SMRY_PK
            AND BSS.DS_CONTR_BLLG_MTR_PK       = BSM.DS_CONTR_BLLG_MTR_PK
            AND BSM.EZCANCELFLAG               = '0'
            AND BSM.GLBL_CMPY_CD               = DBM.GLBL_CMPY_CD
            AND BSM.DS_CONTR_BLLG_MTR_PK       = DBM.DS_CONTR_BLLG_MTR_PK
            AND DBM.EZCANCELFLAG               = '0'
        ORDER BY
             BSM.XS_MTR_COPY_QTY
    </statement>

    <statement id="getTopSchdMtrList" parameterClass="Map" resultClass="Map">
        SELECT
             A.XS_MTR_COPY_QTY
            ,A.XS_MTR_AMT_RATE
        FROM
             DS_CONTR_BLLG_SCHD_MTR A
        WHERE
                A.GLBL_CMPY_CD               = #glblCmpyCd#
            AND A.DS_CONTR_BLLG_SCHD_SMRY_PK = #dsContrBllgSchdSmryPk#
            AND A.EZCANCELFLAG              = '0'
        ORDER BY
             A.XS_MTR_COPY_QTY DESC
    </statement>
    <statement id="getFreeCopyFromAggrRecal" parameterClass="Map" resultClass="Map">
        SELECT
             A.ROLL_OVER_CNT
            ,A.BLLG_FREE_COPY_CNT
        FROM
             AGGR_USG_RECAL  A
        WHERE
                A.GLBL_CMPY_CD              = #glblCmpyCd#
            AND A.DS_CONTR_PK               = #dsContrPk#
            AND A.BLLG_MTR_LB_CD            = #bllgMtrLbCd#
            AND A.BLLG_THRU_DT              &lt; #curFromDt#
            AND A.EZCANCELFLAG              = '0'
            AND EXISTS (
                SELECT
                    *
                FROM
                    SVC_CONTR_BLLG      X
                WHERE
                        X.GLBL_CMPY_CD      = A.GLBL_CMPY_CD
                    AND X.EZCANCELFLAG      = '0'
                    AND X.USG_CHRG_FLG      = 'Y'
                    AND X.DS_CONTR_PK       = A.DS_CONTR_PK
                    AND X.SVC_CONTR_BLLG_FROM_DT &lt;= A.BLLG_FROM_DT
                    AND X.SVC_CONTR_BLLG_THRU_DT &gt;= A.BLLG_FROM_DT
                    <!-- START 2018/06/07 K.Kojima [QC#21974,ADD] -->
                    AND X.SVC_CONTR_BLLG_GRP_SQ      = A.SVC_CONTR_BLLG_GRP_SQ
                    <!-- END 2018/06/07 K.Kojima [QC#21974,ADD] -->
            )
        ORDER BY
             A.BLLG_THRU_DT      DESC
            ,A.AGGR_USG_RECAL_PK DESC
    </statement>
    <!-- START 2018/06/07 K.Kojima [QC#21974,ADD] -->
    <statement id="countCreditRebill" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            COUNT(*)
        FROM
            SVC_CONTR_BLLG SCB
        WHERE
                SCB.GLBL_CMPY_CD          = #glblCmpyCd#
            AND SCB.SVC_CONTR_BLLG_GRP_SQ = #svcContrBllgGrpSq#
            AND SCB.SVC_CR_REBIL_PK IS NOT NULL
            AND SCB.EZCANCELFLAG          = '0'
    </statement>
    <statement id="getFreeCopyRollOverRatioFromAggrRecalUsed" parameterClass="Map" resultClass="Map">
        SELECT
             NVL(DCBMU.FREE_COPY_CNT, 0) + NVL(DCBMU.USG_FREE_COPY_CNT, 0) AS BLLG_FREE_COPY_CNT
            ,DCBMU.ROLL_OVER_RATIO                                         AS ROLL_OVER_RATIO
        FROM
             SVC_CONTR_BLLG         SCB
            ,DS_CONTR_BLLG_SCHD     DCBS
            ,DS_CONTR_BLLG_MTR      DCBM
            ,DS_CONTR_BLLG_SCHD     DCBSO
            ,DS_CONTR_BLLG_MTR_USED DCBMU
        WHERE
                SCB.GLBL_CMPY_CD                   = #glblCmpyCd#
            AND SCB.DS_CONTR_DTL_PK                = #aggLineDtlPk#
            AND SCB.USG_CHRG_FLG                   = 'Y'
            AND SCB.SVC_CONTR_BLLG_FROM_DT     &lt;= #curFromDt#
            AND SCB.SVC_CONTR_BLLG_THRU_DT     &gt;= #curFromDt#
            AND SCB.SVC_CONTR_BLLG_GRP_SQ          = #svcContrBllgGrpSq#
            AND SCB.EZCANCELFLAG                   = '0'
            AND SCB.GLBL_CMPY_CD                   = DCBS.GLBL_CMPY_CD
            AND SCB.DS_CONTR_BLLG_SCHD_PK          = DCBS.DS_CONTR_BLLG_SCHD_PK
            AND DCBS.EZCANCELFLAG                  = '0'
            AND DCBS.GLBL_CMPY_CD                  = DCBM.GLBL_CMPY_CD
            AND DCBS.DS_CONTR_BLLG_MTR_PK          = DCBM.DS_CONTR_BLLG_MTR_PK
            AND DCBM.BLLG_MTR_LB_CD                = #bllgMtrLbCd#
            AND DCBM.EZCANCELFLAG                  = '0'
            AND DCBS.GLBL_CMPY_CD                  = DCBSO.GLBL_CMPY_CD
            AND DCBS.ORIG_DS_CONTR_BLLG_SCHD_PK    = DCBSO.DS_CONTR_BLLG_SCHD_PK
            AND DCBSO.EZCANCELFLAG                 = '0'
            AND DCBSO.GLBL_CMPY_CD                 = DCBMU.GLBL_CMPY_CD
            AND DCBSO.DS_CONTR_BLLG_SCHD_PK        = DCBMU.DS_CONTR_BLLG_SCHD_PK
            AND DCBMU.EZCANCELFLAG                 = '0'
    </statement>
    <statement id="getRollOverCntFromAggrRecalUsed" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             DCBMU.ROLL_OVER_CNT
        FROM
             SVC_CONTR_BLLG         SCB
            ,DS_CONTR_BLLG_SCHD     DCBS
            ,DS_CONTR_BLLG_MTR      DCBM
            ,DS_CONTR_BLLG_SCHD     DCBSO
            ,DS_CONTR_BLLG_SCHD     DCBSB
            ,DS_CONTR_BLLG_MTR_USED DCBMU
        WHERE
                SCB.GLBL_CMPY_CD                   = 'ADB'
            AND SCB.DS_CONTR_DTL_PK                = #aggLineDtlPk#
            AND SCB.USG_CHRG_FLG                   = 'Y'
            AND SCB.SVC_CONTR_BLLG_FROM_DT     &lt;= #curFromDt#
            AND SCB.SVC_CONTR_BLLG_THRU_DT     &gt;= #curFromDt#
            AND SCB.SVC_CONTR_BLLG_GRP_SQ          = #svcContrBllgGrpSq#
            AND SCB.EZCANCELFLAG                   = '0'
            AND SCB.GLBL_CMPY_CD                   = DCBS.GLBL_CMPY_CD
            AND SCB.DS_CONTR_BLLG_SCHD_PK          = DCBS.DS_CONTR_BLLG_SCHD_PK
            AND DCBS.EZCANCELFLAG                  = '0'
            AND DCBS.GLBL_CMPY_CD                  = DCBM.GLBL_CMPY_CD
            AND DCBS.DS_CONTR_BLLG_MTR_PK          = DCBM.DS_CONTR_BLLG_MTR_PK
            AND DCBM.BLLG_MTR_LB_CD                = #bllgMtrLbCd#
            AND DCBM.EZCANCELFLAG                  = '0'
            AND DCBS.GLBL_CMPY_CD                  = DCBSO.GLBL_CMPY_CD
            AND DCBS.ORIG_DS_CONTR_BLLG_SCHD_PK    = DCBSO.DS_CONTR_BLLG_SCHD_PK
            AND DCBSO.EZCANCELFLAG                 = '0'
            AND DCBSO.GLBL_CMPY_CD                 = DCBSB.GLBL_CMPY_CD
            AND DCBSO.DS_CONTR_BLLG_MTR_PK         = DCBSB.DS_CONTR_BLLG_MTR_PK
            AND DCBSO.BLLG_SCHD_FROM_DT         &gt; DCBSB.BLLG_SCHD_FROM_DT
            AND DCBSB.INV_TP_CD                    = #invTpInvoice#
            AND DCBSB.INV_FLG                      = 'Y'
            AND DCBSB.DS_CONTR_PRC_EFF_PK          IS NOT NULL
            AND DCBSB.EZCANCELFLAG                 = '0'
            AND DCBSB.GLBL_CMPY_CD                 = DCBMU.GLBL_CMPY_CD(+)
            AND DCBSB.DS_CONTR_BLLG_SCHD_PK        = DCBMU.DS_CONTR_BLLG_SCHD_PK(+)
            AND DCBMU.EZCANCELFLAG(+)              = '0'
        ORDER BY
            DCBSB.BLLG_SCHD_FROM_DT DESC
    </statement>
    <!-- END 2018/06/07 K.Kojima [QC#21974,ADD] -->
    <statement id="getFreeCopyFromAggrBllgMtr" parameterClass="Map" resultClass="Map">
        SELECT
             A.ROLL_OVER_CNT
            ,A.BLLG_FREE_COPY_CNT
    <!-- START 2019/01/21 M.Naito [QC#29083,ADD] -->
            ,A.CUM_COPY_CNT
            ,A.CUM_COPY_FREQ_MTH_AOT
            ,A.CUM_COPY_START_DT
            ,A.CUM_COPY_END_DT
    <!-- END 2019/01/21 M.Naito [QC#29083,ADD] -->
        FROM
             DS_CONTR_BLLG_MTR  A
        WHERE
                A.GLBL_CMPY_CD              = #glblCmpyCd#
            AND A.BLLG_MTR_LB_CD            = #bllgMtrLbCd#
            AND A.DS_CONTR_DTL_PK           = #aggLineDtlPk#
            AND A.EZCANCELFLAG              = '0'
    </statement>
    <!-- END   2018/0/ K.Kishimoto [QC#23541, ADD] -->
    <!-- START 2019/01/21 M.Naito [QC#29083,ADD] -->
    <statement id="countBllgSchdPrrt" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             COUNT(*)
        FROM
             DS_CONTR_BLLG_SCHD B
            ,DS_CONTR_BLLG_SCHD C
        WHERE
                B.GLBL_CMPY_CD               = #glblCmpyCd#
            AND B.EZCANCELFLAG               = '0'
            AND B.USG_CHRG_FLG               = 'Y'
            AND EXISTS (
                SELECT
                    *
                FROM
                    AGGR_USG_RECAL_DTL A
                WHERE
                       A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
                   AND A.EZCANCELFLAG          = '0'
                   AND A.AGGR_USG_RECAL_PK     = #aggrUsgRecalPk#
                   AND A.BLLG_MTR_LB_CD        = #bllgMtrLbCd#
                   AND A.DS_CONTR_BLLG_SCHD_PK = B.DS_CONTR_BLLG_SCHD_PK
            )
            AND B.GLBL_CMPY_CD               = C.GLBL_CMPY_CD
            AND B.PRNT_DS_CONTR_BLLG_SCHD_PK = C.DS_CONTR_BLLG_SCHD_PK
            AND C.BLLG_SCHD_PRRT_FLG         = 'Y'
            AND C.EZCANCELFLAG               = '0'
    </statement>
    <!-- END 2019/01/21 M.Naito [QC#29083,ADD] -->
</sqlMap>
