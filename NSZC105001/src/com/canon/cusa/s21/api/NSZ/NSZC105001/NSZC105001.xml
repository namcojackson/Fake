<?xml version="1.0" encoding="UTF-8" standalone="yes"?>

<sqlMap namespace="NSZC105001">
    <statement id="getNotificatonMailData" parameterClass="Map" resultClass="Map">
        SELECT
             #sysTs#                                AS SYS_TS
            ,Z.DS_ACCT_NM                           AS DS_ACCT_NM
            ,Z.FSR_NUM                              AS FSR_NUM
            ,Z.CALL_AMT                             AS CALL_AMT
            ,Z.SVC_BR_CD                            AS SVC_BR_CD
            ,Z.SELL_TO_CUST_CD                      AS DS_ACCT_NUM
            ,Z.DS_CLT_ACCT_STS_DESC_TXT             AS DS_CLT_ACCT_STS_DESC_TXT
            <!-- START 2018/10/30 K.Kitachi [QC#27463, MOD] -->
            <!-- ,Z.CR_CHK_REQ_TP_DEF_FLG                AS CR_CHK_REQ_TP_DEF_FLG -->
            ,Z.CUST_HARD_HLD_FLG                    AS CUST_HARD_HLD_FLG
            <!-- END 2018/10/30 K.Kitachi [QC#27463, MOD] -->
            ,Z.CR_LIMIT_AMT                         AS CR_LIMIT_AMT
            ,Z.OPEN_AR                              AS OPEN_AR
            <!-- START 2018/10/30 K.Kitachi [QC#27463, MOD] -->
            <!-- ,Z.DEAL_RMNG_BAL_GRS_AMT                AS DEAL_RMNG_BAL_GRS_AMT -->
            ,Z.IN_PROC_AMT                          AS IN_PROC_AMT
            <!-- END 2018/10/30 K.Kitachi [QC#27463, MOD] -->
            ,Z.CALL_AMT                             AS CALL_AMT
            ,Z.CALL_AMT + Z.CALL_TAX_AMT            AS CALL_TOT_AMT
            ,Z.CALL_TAX_AMT                         AS CALL_TAX_AMT
            ,Z.GRACE_PER_DAYS_AOT                   AS GRACE_PER_DAYS_AOT
            ,TO_DATE(#slsDt#, 'YYYYMMDD')
                - TO_DATE(Z.INV_DUE_DT, 'YYYYMMDD') AS PAST_DUE_BY
            ,Z.PAST_DUE_AMT                         AS PAST_DUE_AMT
            ,Z.DS_PO_REQ_FLG                        AS DS_PO_REQ_FLG
            ,Z.CUST_PO_NUM                          AS CUST_PO_NUM
            ,Z.PMT_TERM_CASH_DISC_DESC_TXT          AS PMT_TERM_CASH_DISC_DESC_TXT
            ,''                                     AS CMNT
            ,Z.SVC_TASK_HLD_RSN_DESC_TXT            AS SVC_TASK_HLD_RSN_DESC_TXT
            <!-- START 2022/12/27 S.Fujita [QC#60744, ADD] -->
            ,Z.CONTR_GRACE_PER_DAYS_AOT             AS CONTR_GRACE_PER_DAYS_AOT
            <!-- END 2022/12/27 S.Fujita [QC#60744, ADD] -->
        FROM
            (
                SELECT
                     F.FSR_NUM
                    ,A.DS_ACCT_NM
                    ,NVL(F.SVC_LBOR_DEAL_AMT,0)
                        + NVL(F.SVC_TRVL_DEAL_AMT,0)
                        + NVL(F.SVC_PRT_DEAL_AMT,0)
                        + NVL(F.SVC_EXP_DEAL_AMT,0)
                     AS CALL_AMT
                    ,ST.SVC_BR_CD
                    ,A.SELL_TO_CUST_CD
                    ,CAS.DS_CLT_ACCT_STS_DESC_TXT
                    <!-- START 2018/10/30 K.Kitachi [QC#27463, MOD] -->
                    <!-- ,CCR.CR_CHK_REQ_TP_DEF_FLG -->
                    ,ACP.CUST_HARD_HLD_FLG
                    <!-- END 2018/10/30 K.Kitachi [QC#27463, MOD] -->
                    ,ACP.CR_LIMIT_AMT
                    <!-- START 2018/10/30 K.Kitachi [QC#27463, MOD] -->
                    <!-- ,( -->
                    <!--     SELECT -->
                    <!--         SUM(ATB.DEAL_RMNG_BAL_GRS_AMT) -->
                    <!--     FROM -->
                    <!--         AR_TRX_BAL ATB -->
                    <!--     WHERE -->
                    <!--         ATB.GLBL_CMPY_CD         =  A.GLBL_CMPY_CD -->
                    <!--     <iterate property="arCashApplyStsCd" var="arCashApplyStsCd[]"  open=" AND ATB.AR_CASH_APPLY_STS_CD IN   (" close=" )" conjunction=","> -->
                    <!--         #arCashApplyStsCd[]# -->
                    <!--     </iterate> -->
                    <!--     AND ATB.BILL_TO_CUST_ACCT_CD =  A.SELL_TO_CUST_CD -->
                    <!--     AND ATB.EZCANCELFLAG         =  '0' -->
                    <!--  ) AS OPEN_AR -->
                    ,ACP.AR_BAL_AMT AS OPEN_AR
                    <!-- ,( -->
                    <!--     SELECT -->
                    <!--         SUM(ATB.DEAL_RMNG_BAL_GRS_AMT) -->
                    <!--     FROM -->
                    <!--         AR_TRX_BAL ATB -->
                    <!--     WHERE -->
                    <!--         ATB.GLBL_CMPY_CD         =  A.GLBL_CMPY_CD -->
                    <!--     <iterate property="arCashApplyStsCd" var="arCashApplyStsCd[]"  open=" AND ATB.AR_CASH_APPLY_STS_CD IN   (" close=" )" conjunction=","> -->
                    <!--         #arCashApplyStsCd[]# -->
                    <!--     </iterate> -->
                    <!--     AND ATB.BILL_TO_CUST_ACCT_CD =  A.SELL_TO_CUST_CD -->
                    <!--     AND ATB.EZCANCELFLAG         =  '0' -->
                    <!--  ) AS DEAL_RMNG_BAL_GRS_AMT -->
                    ,ACP.IN_PROC_AMT
                    <!-- END 2018/10/30 K.Kitachi [QC#27463, MOD] -->
                    ,NVL(F.SVC_LBOR_DEAL_TAX_AMT,0)
                        + NVL(F.SVC_TRVL_DEAL_TAX_AMT,0)
                        + NVL(F.SVC_PRT_DEAL_TAX_AMT,0)
                        + NVL(F.SVC_EXP_DEAL_TAX_AMT,0)
                     AS CALL_TAX_AMT
                    ,CRC.GRACE_PER_DAYS_AOT
                    ,(
                        SELECT
                            MIN(ATB.INV_DUE_DT)
                        FROM
                            AR_TRX_BAL ATB
                        WHERE
                            ATB.GLBL_CMPY_CD         =  A.GLBL_CMPY_CD
                        <iterate property="arCashApplyStsCd" var="arCashApplyStsCd[]"  open=" AND ATB.AR_CASH_APPLY_STS_CD IN   (" close=" )" conjunction=",">
                            #arCashApplyStsCd[]#
                        </iterate>
                        AND ATB.BILL_TO_CUST_ACCT_CD =  A.SELL_TO_CUST_CD
                        AND ATB.EZCANCELFLAG         =  '0'
                     ) AS INV_DUE_DT
                    ,(
                        SELECT
                            <!-- START 2018/10/30 K.Kitachi [QC#27463, MOD] -->
                            <!-- SUM(ATB.DEAL_RMNG_BAL_GRS_AMT) -->
                            SUM(CASE WHEN ATB.AR_TRX_TP_CD &lt;&gt; #arTrxTpCd# THEN ATB.DEAL_RMNG_BAL_GRS_AMT ELSE ATB.DEAL_RMNG_BAL_GRS_AMT * -1 END)
                            <!-- END 2018/10/30 K.Kitachi [QC#27463, MOD] -->
                        FROM
                            AR_TRX_BAL ATB
                        WHERE
                            ATB.GLBL_CMPY_CD         =    A.GLBL_CMPY_CD
                        <iterate property="arCashApplyStsCd" var="arCashApplyStsCd[]"  open=" AND ATB.AR_CASH_APPLY_STS_CD IN   (" close=" )" conjunction=",">
                            #arCashApplyStsCd[]#
                        </iterate>
                        AND ATB.BILL_TO_CUST_ACCT_CD =    A.SELL_TO_CUST_CD
                        <!-- START 2018/10/30 K.Kitachi [QC#27463, MOD] -->
                        <!-- AND ATB.INV_DUE_DT           &lt; #slsDt# -->
                        AND NVL(ATB.INV_DUE_DT, ATB.AR_TRX_DT) &lt; #slsDt#
                        <!-- END 2018/10/30 K.Kitachi [QC#27463, MOD] -->
                        AND ATB.EZCANCELFLAG         =    '0'
                     ) AS PAST_DUE_AMT
                    ,CTR.DS_PO_REQ_FLG
                    ,ST.CUST_PO_NUM
                    ,PTCD.PMT_TERM_CASH_DISC_DESC_TXT
                    ,STHR.SVC_TASK_HLD_RSN_DESC_TXT
                    <!-- START 2022/12/27 S.Fujita [QC#60744, ADD] -->
                    ,CCRC.CONTR_GRACE_PER_DAYS_AOT
                    <!-- END 2022/12/27 S.Fujita [QC#60744, ADD] -->
                FROM 
                     FSR                F
                    ,FSR_TP             FT
                    ,SELL_TO_CUST       A
                    ,DS_CLT_ACCT_STS    CAS
                    ,DS_ACCT_CR_PRFL    ACP
                    <!-- START 2018/10/30 K.Kitachi [QC#27463, DEL] -->
                    <!-- ,CR_CHK_REQ_TP      CCR -->
                    <!-- END 2018/10/30 K.Kitachi [QC#27463, DEL] -->
                    ,CR_RISK_CLS        CRC
                    ,DS_CUST_TRX_RULE   CTR
                    ,SVC_TASK           ST
                    ,PMT_TERM_CASH_DISC PTCD
                    ,SVC_TASK_HLD       STH
                    ,SVC_TASK_HLD_RSN   STHR
                    <!-- START 2022/12/27 S.Fujita [QC#60744, ADD] -->
                    ,CONTR_CR_RISK_CLS  CCRC
                    <!-- END 2022/12/27 S.Fujita [QC#60744, ADD] -->
                WHERE
                    F.GLBL_CMPY_CD             = #glblCmpyCd#
                AND F.FSR_NUM                  = #fsrNum#
                AND F.EZCANCELFLAG             = '0'
                AND FT.GLBL_CMPY_CD            = F.GLBL_CMPY_CD
                AND FT.FSR_TP_CD               = F.FSR_TP_CD
                AND FT.EZCANCELFLAG            = '0'
                AND A.GLBL_CMPY_CD             = F.GLBL_CMPY_CD
                AND A.SELL_TO_CUST_CD          = F.BILL_TO_CUST_ACCT_CD
                AND A.EZCANCELFLAG             = '0'
                AND CAS.GLBL_CMPY_CD       (+) = A.GLBL_CMPY_CD
                AND CAS.DS_CLT_ACCT_STS_CD (+) = A.DS_CLT_ACCT_STS_CD
                AND CAS.EZCANCELFLAG       (+) = '0'
                AND ACP.GLBL_CMPY_CD           = A.GLBL_CMPY_CD
                AND ACP.DS_ACCT_NUM            = A.SELL_TO_CUST_CD
                AND ACP.EZCANCELFLAG           = '0'
                <!-- START 2018/10/30 K.Kitachi [QC#27463, DEL] -->
                <!-- AND CCR.GLBL_CMPY_CD           = ACP.GLBL_CMPY_CD -->
                <!-- AND CCR.CR_CHK_REQ_TP_CD       = ACP.CR_CHK_REQ_TP_CD -->
                <!-- AND CCR.EZCANCELFLAG           = '0' -->
                <!-- END 2018/10/30 K.Kitachi [QC#28879, DEL] -->
                AND CRC.GLBL_CMPY_CD           = ACP.GLBL_CMPY_CD
                AND CRC.CR_RISK_CLS_CD         = ACP.CR_RISK_CLS_CD
                AND CRC.EZCANCELFLAG           = '0'
                AND CTR.GLBL_CMPY_CD       (+) = A.GLBL_CMPY_CD
                AND CTR.DS_ACCT_NUM        (+) = A.SELL_TO_CUST_CD
                AND CTR.EZCANCELFLAG       (+) = '0'
                AND ST.GLBL_CMPY_CD            = F.GLBL_CMPY_CD
                AND ST.FSR_NUM                 = F.FSR_NUM
                AND ST.EZCANCELFLAG            = '0'
                AND PTCD.GLBL_CMPY_CD          = ACP.GLBL_CMPY_CD
                AND PTCD.PMT_TERM_CASH_DISC_CD = ACP.PMT_TERM_CASH_DISC_CD
                AND PTCD.EZCANCELFLAG          = '0'
                AND STH.GLBL_CMPY_CD           = ST.GLBL_CMPY_CD
                AND STH.SVC_TASK_NUM           = ST.SVC_TASK_NUM
                AND STH.EZCANCELFLAG           = '0'
                AND STHR.GLBL_CMPY_CD          = STH.GLBL_CMPY_CD
                AND STHR.SVC_TASK_HLD_RSN_CD   = STH.SVC_TASK_HLD_RSN_CD
                AND STHR.EZCANCELFLAG          = '0'
                <!-- START 2022/12/27 S.Fujita [QC#60744, ADD] -->
                AND CCRC.GLBL_CMPY_CD         (+)  = ACP.GLBL_CMPY_CD
                AND CCRC.CONTR_CR_RISK_CLS_CD (+)  = ACP.CONTR_CR_RISK_CLS_CD
                AND CCRC.EZCANCELFLAG         (+)  = '0'
                <!-- END 2022/12/27 S.Fujita [QC#60744, ADD] -->
            ) Z
        WHERE
            ROWNUM = 1
    </statement>

    <!-- START 2018/10/30 K.Kitachi [QC#28879, ADD] -->
    <statement id="countBllblTask" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            COUNT(*)
        FROM
             SVC_TASK    A
            ,SVC_BILL_TP B
        WHERE
                A.GLBL_CMPY_CD   = #glblCmpyCd#
            AND A.FSR_NUM        = #fsrNum#
            AND A.EZCANCELFLAG   = '0'
            AND A.GLBL_CMPY_CD   = B.GLBL_CMPY_CD
            AND A.SVC_BILL_TP_CD = B.SVC_BILL_TP_CD
            AND B.EZCANCELFLAG   = '0'
            AND (   B.LBOR_CHRG_FLG = 'Y'
                 OR B.PRT_CHRG_FLG  = 'Y'
                 OR B.DRUM_CHRG_FLG = 'Y'
                 OR B.EXP_CHRG_FLG  = 'Y'
                )
    </statement>

    <statement id="getNotificatonMailDataForBllbl" parameterClass="Map" resultClass="Map">
        SELECT
             #sysTs#                                AS SYS_TS
            ,Z.DS_ACCT_NM                           AS DS_ACCT_NM
            ,Z.FSR_NUM                              AS FSR_NUM
            ,Z.CALL_AMT                             AS CALL_AMT
            ,Z.SVC_BR_CD                            AS SVC_BR_CD
            ,Z.SELL_TO_CUST_CD                      AS DS_ACCT_NUM
            ,Z.DS_CLT_ACCT_STS_DESC_TXT             AS DS_CLT_ACCT_STS_DESC_TXT
            ,Z.CUST_HARD_HLD_FLG                    AS CUST_HARD_HLD_FLG
            ,Z.CR_LIMIT_AMT                         AS CR_LIMIT_AMT
            ,Z.OPEN_AR                              AS OPEN_AR
            ,Z.IN_PROC_AMT                          AS IN_PROC_AMT
            ,Z.CALL_AMT                             AS CALL_AMT
            ,Z.CALL_AMT + Z.CALL_TAX_AMT            AS CALL_TOT_AMT
            ,Z.CALL_TAX_AMT                         AS CALL_TAX_AMT
            ,Z.CONTR_GRACE_PER_DAYS_AOT             AS GRACE_PER_DAYS_AOT
            ,NULL                                   AS PAST_DUE_BY
            ,NULL                                   AS PAST_DUE_AMT
            ,Z.DS_PO_REQ_FLG                        AS DS_PO_REQ_FLG
            ,Z.CUST_PO_NUM                          AS CUST_PO_NUM
            ,Z.PMT_TERM_CASH_DISC_DESC_TXT          AS PMT_TERM_CASH_DISC_DESC_TXT
            ,''                                     AS CMNT
            ,Z.SVC_TASK_HLD_RSN_DESC_TXT            AS SVC_TASK_HLD_RSN_DESC_TXT
        FROM
            (
                SELECT
                     F.FSR_NUM
                    ,A.DS_ACCT_NM
                    ,NVL(F.SVC_LBOR_DEAL_AMT,0)
                        + NVL(F.SVC_TRVL_DEAL_AMT,0)
                        + NVL(F.SVC_PRT_DEAL_AMT,0)
                        + NVL(F.SVC_EXP_DEAL_AMT,0)
                     AS CALL_AMT
                    ,ST.SVC_BR_CD
                    ,A.SELL_TO_CUST_CD
                    ,CAS.DS_CLT_ACCT_STS_DESC_TXT
                    ,ACP.CUST_HARD_HLD_FLG
                    ,ACP.CR_LIMIT_AMT
                    ,ACP.AR_BAL_AMT AS OPEN_AR
                    ,ACP.IN_PROC_AMT
                    ,NVL(F.SVC_LBOR_DEAL_TAX_AMT,0)
                        + NVL(F.SVC_TRVL_DEAL_TAX_AMT,0)
                        + NVL(F.SVC_PRT_DEAL_TAX_AMT,0)
                        + NVL(F.SVC_EXP_DEAL_TAX_AMT,0)
                     AS CALL_TAX_AMT
                    ,CRC.CONTR_GRACE_PER_DAYS_AOT
                    ,CTR.DS_PO_REQ_FLG
                    ,ST.CUST_PO_NUM
                    ,PTCD.PMT_TERM_CASH_DISC_DESC_TXT
                    ,STHR.SVC_TASK_HLD_RSN_DESC_TXT
                FROM 
                     FSR                F
                    ,FSR_TP             FT
                    ,SELL_TO_CUST       A
                    ,DS_CLT_ACCT_STS    CAS
                    ,DS_ACCT_CR_PRFL    ACP
                    ,CONTR_CR_RISK_CLS  CRC
                    ,DS_CUST_TRX_RULE   CTR
                    ,SVC_TASK           ST
                    ,PMT_TERM_CASH_DISC PTCD
                    ,SVC_TASK_HLD       STH
                    ,SVC_TASK_HLD_RSN   STHR
                WHERE
                    F.GLBL_CMPY_CD             = #glblCmpyCd#
                AND F.FSR_NUM                  = #fsrNum#
                AND F.EZCANCELFLAG             = '0'
                AND FT.GLBL_CMPY_CD            = F.GLBL_CMPY_CD
                AND FT.FSR_TP_CD               = F.FSR_TP_CD
                AND FT.EZCANCELFLAG            = '0'
                AND A.GLBL_CMPY_CD             = F.GLBL_CMPY_CD
                AND A.SELL_TO_CUST_CD          = F.BILL_TO_CUST_ACCT_CD
                AND A.EZCANCELFLAG             = '0'
                AND CAS.GLBL_CMPY_CD       (+) = A.GLBL_CMPY_CD
                AND CAS.DS_CLT_ACCT_STS_CD (+) = A.DS_CLT_ACCT_STS_CD
                AND CAS.EZCANCELFLAG       (+) = '0'
                AND ACP.GLBL_CMPY_CD           = A.GLBL_CMPY_CD
                AND ACP.DS_ACCT_NUM            = A.SELL_TO_CUST_CD
                AND ACP.EZCANCELFLAG           = '0'
                AND CRC.GLBL_CMPY_CD           = ACP.GLBL_CMPY_CD
                AND CRC.CONTR_CR_RISK_CLS_CD   = ACP.CONTR_CR_RISK_CLS_CD
                AND CRC.EZCANCELFLAG           = '0'
                AND CTR.GLBL_CMPY_CD       (+) = A.GLBL_CMPY_CD
                AND CTR.DS_ACCT_NUM        (+) = A.SELL_TO_CUST_CD
                AND CTR.EZCANCELFLAG       (+) = '0'
                AND ST.GLBL_CMPY_CD            = F.GLBL_CMPY_CD
                AND ST.FSR_NUM                 = F.FSR_NUM
                AND ST.EZCANCELFLAG            = '0'
                AND PTCD.GLBL_CMPY_CD          = ACP.GLBL_CMPY_CD
                AND PTCD.PMT_TERM_CASH_DISC_CD = ACP.PMT_TERM_CASH_DISC_CD
                AND PTCD.EZCANCELFLAG          = '0'
                AND STH.GLBL_CMPY_CD           = ST.GLBL_CMPY_CD
                AND STH.SVC_TASK_NUM           = ST.SVC_TASK_NUM
                AND STH.EZCANCELFLAG           = '0'
                AND STHR.GLBL_CMPY_CD          = STH.GLBL_CMPY_CD
                AND STHR.SVC_TASK_HLD_RSN_CD   = STH.SVC_TASK_HLD_RSN_CD
                AND STHR.EZCANCELFLAG          = '0'
            ) Z
        WHERE
            ROWNUM = 1
    </statement>

    <statement id="getPastDueInfo" parameterClass="Map" resultClass="Map">
    <!--START 2022/12/27 S.Fujita [QC#60744, MOD]  -->
        <!--  SELECT-->
        <!--     TO_DATE(#slsDt#, 'YYYYMMDD')-->
        <!--        - TO_DATE(MIN(ATB.INV_DUE_DT), 'YYYYMMDD') AS PAST_DUE_BY-->
        <!--    ,SUM(ATB.DEAL_RMNG_BAL_GRS_AMT)                AS PAST_DUE_AMT-->
    WITH CONTR_AR_TRX_INFO AS (
        SELECT
             F.FSR_NUM
            ,ATB.INV_DUE_DT
            ,ATB.DEAL_RMNG_BAL_GRS_AMT
            ,CRC.CONTR_GRACE_PER_DAYS_AOT
        <!--END 2022/12/27 S.Fujita [QC#60744, MOD]  -->
        FROM
             FSR               F
            ,INV               I
            <!-- Start 2023/2/6 R.Onozuka [QC#60744,DEL] -->
            <!-- ,INV_LINE          IL -->
            <!-- End 2023/2/6 R.Onozuka [QC#60744,DEL] -->
            ,DS_ACCT_CR_PRFL   DACP
            ,CONTR_CR_RISK_CLS CRC
            ,AR_TRX_BAL        ATB
        WHERE
                F.GLBL_CMPY_CD            = #glblCmpyCd#
            AND F.FSR_NUM                 = #fsrNum#
            AND F.EZCANCELFLAG            = '0'
            AND F.GLBL_CMPY_CD            = I.GLBL_CMPY_CD
            AND F.BILL_TO_CUST_ACCT_CD    = I.BILL_TO_CUST_ACCT_CD
            AND I.EZCANCELFLAG            = '0'
            <!-- Start 2023/2/6 R.Onozuka [QC#60744,DEL] -->
            <!-- 
            AND I.GLBL_CMPY_CD            = IL.GLBL_CMPY_CD
            AND I.INV_NUM                 = IL.INV_NUM
            AND IL.EZCANCELFLAG           = '0'
            <iterate property="dsContrNumList" var="dsContrNumList[]" open="AND IL.DS_CONTR_NUM IN (" close=")" conjunction=",">
                #dsContrNumList[]#
            </iterate>
            -->
            <!-- End 2023/2/6 R.Onozuka [QC#60744,DEL] -->
            AND I.GLBL_CMPY_CD            = DACP.GLBL_CMPY_CD
            AND I.BILL_TO_CUST_ACCT_CD    = DACP.DS_ACCT_NUM
            AND DACP.EZCANCELFLAG         = '0'
            AND DACP.GLBL_CMPY_CD         = CRC.GLBL_CMPY_CD
            AND DACP.CONTR_CR_RISK_CLS_CD = CRC.CONTR_CR_RISK_CLS_CD
            AND CRC.EZCANCELFLAG          = '0'
            AND I.GLBL_CMPY_CD            = ATB.GLBL_CMPY_CD
            AND I.BILL_TO_CUST_ACCT_CD    = ATB.BILL_TO_CUST_ACCT_CD
            AND ATB.EZCANCELFLAG          = '0'
            <!-- Start 2023/2/6 R.Onozuka [QC#60744,DEL] -->
            <!-- AND ATB.AR_TRX_NUM         LIKE IL.INV_NUM || '%' -->
            <!-- End 2023/2/6 R.Onozuka [QC#60744,DEL] -->
            AND ATB.AR_TRX_TP_CD          = #arTrxTpInvoice#
            AND ATB.AR_CASH_APPLY_STS_CD IN (#arCashApplyStsUnapplied#, #arCashApplyStsPartial#)
            <!-- Start 2023/2/6 R.Onozuka [QC#60744,ADD] -->
            AND EXISTS(
                SELECT 
                    1 
                FROM 
                    INV_LINE IL 
                WHERE
                        I.GLBL_CMPY_CD            = IL.GLBL_CMPY_CD
                    AND I.INV_NUM                 = IL.INV_NUM
                    AND IL.EZCANCELFLAG           = '0'
                    <iterate property="dsContrNumList" var="dsContrNumList[]" open="AND IL.DS_CONTR_NUM IN (" close=")" conjunction=",">
                        #dsContrNumList[]#
                    </iterate>
                    AND ATB.AR_TRX_NUM         LIKE IL.INV_NUM || '%'
            )
            <!-- End 2023/2/6 R.Onozuka [QC#60744,ADD] -->
    <!--START 2022/12/27 S.Fujita [QC#60744, MOD]  -->
        <!-- AND TO_DATE(ATB.INV_DUE_DT, 'YYYYMMDD') + CRC.CONTR_GRACE_PER_DAYS_AOT &lt; TO_DATE(#slsDt#, 'YYYYMMDD') -->
    )
      ,OPEN_INFO AS (
        SELECT
             A.FSR_NUM
            ,SUM(A.DEAL_RMNG_BAL_GRS_AMT)  AS CONTR_OPEN_AR
        FROM
            CONTR_AR_TRX_INFO A
        GROUP BY
            A.FSR_NUM
    )
     ,PAST_DUE_INFO AS (
        SELECT
            A.FSR_NUM
            ,TO_DATE(#slsDt#, 'YYYYMMDD')
                - TO_DATE(MIN(A.INV_DUE_DT), 'YYYYMMDD') AS CONTR_PAST_DUE_BY
            ,SUM(A.DEAL_RMNG_BAL_GRS_AMT)                AS CONTR_PAST_DUE_AMT
        FROM
            CONTR_AR_TRX_INFO A
        WHERE
            CASE WHEN A.CONTR_GRACE_PER_DAYS_AOT = 999 THEN TO_DATE(A.INV_DUE_DT, 'YYYYMMDD')
                 ELSE TO_DATE(A.INV_DUE_DT, 'YYYYMMDD') + A.CONTR_GRACE_PER_DAYS_AOT
                 END &lt; TO_DATE(#slsDt#, 'YYYYMMDD')
        GROUP BY
            A.FSR_NUM
    )
    SELECT
         A.CONTR_OPEN_AR
        ,B.CONTR_PAST_DUE_BY
        ,B.CONTR_PAST_DUE_AMT
    FROM
         OPEN_INFO A
        ,PAST_DUE_INFO B
    WHERE
        A.FSR_NUM = B.FSR_NUM
    <!--END 2022/12/27 S.Fujita [QC#60744, MOD]  -->
    </statement>

    <statement id="getContrNum" parameterClass="Map" resultClass="String">
        SELECT DISTINCT
            DC.DS_CONTR_NUM
        FROM
             SVC_TASK     ST
            ,DS_CONTR_DTL DCD
            ,DS_CONTR     DC
        WHERE
                ST.GLBL_CMPY_CD        = #glblCmpyCd#
            AND ST.FSR_NUM             = #fsrNum#
            AND ST.EZCANCELFLAG        = '0'
            AND ST.GLBL_CMPY_CD        = DCD.GLBL_CMPY_CD
            AND ST.SVC_MACH_MSTR_PK    = DCD.SVC_MACH_MSTR_PK
            AND DCD.EZCANCELFLAG       = '0'
            AND DCD.CONTR_EFF_FROM_DT  &lt;= #slsDt#
            AND NVL(DCD.CONTR_CLO_DT, DCD.CONTR_EFF_THRU_DT)  &gt;= #slsDt#
            AND DCD.GLBL_CMPY_CD       = DC.GLBL_CMPY_CD
            AND DCD.DS_CONTR_PK        = DC.DS_CONTR_PK
            AND DC.EZCANCELFLAG        = '0'
            AND DC.DS_CONTR_CATG_CD    &lt;&gt; #dsContrCatgWty#
    </statement>
    <!-- END 2018/10/30 K.Kitachi [QC#28879, ADD] -->
</sqlMap>
