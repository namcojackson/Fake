<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NWAB270001">

    <statement  id="getTargetData" parameterClass="Map" resultClass="Map">

        SELECT
             SP.EZUPTIME            AS EZUPTIME
            ,SP.EZUPTIMEZONE        AS EZUPTIMEZONE
            ,SP.SHPG_PLN_NUM        AS SHPG_PLN_NUM
            ,SP.TRX_HDR_NUM         AS TRX_HDR_NUM
            ,SP.TRX_LINE_NUM        AS TRX_LINE_NUM
            ,SP.TRX_LINE_SUB_NUM    AS TRX_LINE_SUB_NUM
            ,SP.MDSE_CD             AS MDSE_CD
            ,SP.STK_STS_CD          AS STK_STS_CD
            ,SP.SHIP_TO_CUST_CD     AS SHIP_TO_CUST_CD
            ,SP.SHIP_TO_LOC_NM      AS SHIP_TO_LOC_NM
            ,CD.DS_CPO_CONFIG_PK    AS DS_CPO_CONFIG_PK
            ,SP.ORD_QTY             AS ORD_QTY
            ,CASE 
                WHEN CD.BASE_CMPT_FLG = #flgOnY# THEN #svcMachTpM#
                WHEN CD.BASE_CMPT_FLG = #flgOffN# THEN #svcMachTpA#
             END                    AS SVC_MACH_TP_CD
            ,SP.SHIP_TO_FIRST_LINE_ADDR     AS SHIP_TO_FIRST_LINE_ADDR
            ,SP.SHIP_TO_SCD_LINE_ADDR       AS SHIP_TO_SCD_LINE_ADDR
            ,SP.SHIP_TO_THIRD_LINE_ADDR     AS SHIP_TO_THIRD_LINE_ADDR
            ,SP.SHIP_TO_FRTH_LINE_ADDR      AS SHIP_TO_FRTH_LINE_ADDR
            ,SP.SHIP_TO_CTY_ADDR            AS SHIP_TO_CTY_ADDR
            ,SP.SHIP_TO_ST_CD               AS SHIP_TO_ST_CD
            ,SP.SHIP_TO_PROV_ADDR           AS SHIP_TO_PROV_ADDR
            ,SP.SHIP_TO_CNTY_NM             AS SHIP_TO_CNTY_NM
            ,SP.SHIP_TO_POST_CD             AS SHIP_TO_POST_CD
            ,SP.SHIP_TO_CTRY_CD             AS SHIP_TO_CTRY_CD
            ,SP.ACTL_SHIP_DT                AS ACTL_SHIP_DT
            ,C.CUST_ISS_PO_NUM              AS CUST_ISS_PO_NUM
            ,C.DS_ORD_TP_CD                 AS DS_ORD_TP_CD
            ,C.DS_ORD_RSN_CD                AS DS_ORD_RSN_CD
            ,C.PRC_CONTR_NUM                AS PRC_CONTR_NUM
            ,C.BILL_TO_CUST_ACCT_CD         AS BILL_TO_CUST_ACCT_CD
            ,DCC.BILL_TO_CUST_LOC_CD        AS BILL_TO_CUST_LOC_CD
            ,C.SELL_TO_CUST_CD              AS SELL_TO_CUST_CD
            ,C.SOLD_TO_CUST_LOC_CD          AS SOLD_TO_CUST_LOC_CD
            ,STC.SELL_TO_CUST_CD            AS SHIP_TO_CUST_ACCT_CD
            ,CD.SHIP_TO_CUST_CD             AS SHIP_TO_CUST_LOC_CD
            ,CD.FIRST_BLLG_ATTRB_VAL_TXT    AS FIRST_BLLG_ATTRB_VAL_TXT
            ,CD.SCD_BLLG_ATTRB_VAL_TXT      AS SCD_BLLG_ATTRB_VAL_TXT
            ,CD.THIRD_BLLG_ATTRB_VAL_TXT    AS THIRD_BLLG_ATTRB_VAL_TXT
            ,CD.FRTH_BLLG_ATTRB_VAL_TXT     AS FRTH_BLLG_ATTRB_VAL_TXT
            ,CD.FIFTH_BLLG_ATTRB_VAL_TXT    AS FIFTH_BLLG_ATTRB_VAL_TXT
            ,CD.SIXTH_BLLG_ATTRB_VAL_TXT    AS SIXTH_BLLG_ATTRB_VAL_TXT
            ,CD.HARD_DRIVE_RMV_INCL_FLG     AS HARD_DRIVE_RMV_INCL_FLG
            ,CD.HARD_DRIVE_ERASE_INCL_FLG   AS HARD_DRIVE_ERASE_INCL_FLG
            ,PEQ.LEASE_RTRN_FEE_INCL_FLG    AS LEASE_RTRN_FEE_INCL_FLG
            
            ,DCC.PICK_SVC_CONFIG_MSTR_PK    AS PICK_SVC_CONFIG_MSTR_PK
            ,DCC.SVC_CONFIG_MSTR_PK         AS SVC_CONFIG_MSTR_PK
            ,SMM.SVC_MACH_MSTR_PK           AS SVC_MACH_MSTR_PK
            ,SMM.SVC_MACH_MSTR_LOC_STS_CD   AS SVC_MACH_MSTR_LOC_STS_CD
            ,SMM_M.SVC_MACH_MSTR_PK         AS SVC_MACH_MSTR_PK_M
            ,SMM_M.SVC_MACH_MSTR_STS_CD     AS SVC_MACH_MSTR_STS_CD_M
            ,SP.INVTY_LOC_CD                AS INVTY_LOC_CD
            ,CD.RTL_WH_CD                   AS RTL_WH_CD
        FROM
             SHPG_PLN      SP
            ,CPO_DTL       CD
            ,CPO           C
            ,DS_CPO_CONFIG DCC
            ,SVC_MACH_MSTR SMM
            ,SVC_MACH_MSTR SMM_M
            ,MDSE          M
            ,PRC_EQUIP_CONTR_ATTRB  PEQ
            ,SHIP_TO_CUST    STC
        WHERE
                SP.GLBL_CMPY_CD  = #glblCmpyCd#
            <!-- 2019/05/31 QC#50551 Mod Start -->
            <!-- AND SP.SHPG_STS_CD   = #shpgStsCdArrived# -->
            AND SP.SHPG_STS_CD  IN (#shpgStsCdArrived#,#shpgStsCdInstalled#)
            <!-- 2019/05/31 QC#50551 Mod End -->
            AND SP.REV_RECOG_FLG = #flgOffN#
            AND SP.TRX_SRC_TP_CD = #trxSrcTpCd#
            AND SP.EZCANCELFLAG  = '0'

            AND SP.GLBL_CMPY_CD     = CD.GLBL_CMPY_CD
            AND SP.TRX_HDR_NUM      = CD.CPO_ORD_NUM
            AND SP.TRX_LINE_NUM     = CD.CPO_DTL_LINE_NUM
            AND SP.TRX_LINE_SUB_NUM = CD.CPO_DTL_LINE_SUB_NUM
            AND CD.EZCANCELFLAG     = '0'
            AND CD.RTL_WH_CD IS NULL 

            AND SP.GLBL_CMPY_CD = C.GLBL_CMPY_CD
            AND SP.TRX_HDR_NUM  = C.CPO_ORD_NUM
            AND C.ORD_BOOK_FLG  = #flgOnY#
            AND C.EZCANCELFLAG  = '0'

            AND CD.GLBL_CMPY_CD     = DCC.GLBL_CMPY_CD
            AND CD.CPO_ORD_NUM      = DCC.CPO_ORD_NUM
            AND CD.DS_CPO_CONFIG_PK = DCC.DS_CPO_CONFIG_PK
            AND DCC.EZCANCELFLAG    = '0'

            AND CD.GLBL_CMPY_CD          = SMM.GLBL_CMPY_CD(+)
            AND CD.CPO_ORD_NUM           = SMM.CPO_ORD_NUM(+)
            AND CD.CPO_DTL_LINE_NUM      = SMM.CPO_DTL_LINE_NUM(+)
            AND CD.CPO_DTL_LINE_SUB_NUM  = SMM.CPO_DTL_LINE_SUB_NUM(+)
            AND SMM.EZCANCELFLAG(+)      = '0'

            AND DCC.GLBL_CMPY_CD        = SMM_M.GLBL_CMPY_CD(+)
            AND DCC.SVC_CONFIG_MSTR_PK  = SMM_M.SVC_CONFIG_MSTR_PK(+)
            AND SMM_M.SVC_MACH_TP_CD(+) = #svcMachTpM#
            AND SMM_M.EZCANCELFLAG(+)   = '0'

            AND SP.GLBL_CMPY_CD         = M.GLBL_CMPY_CD
            AND SP.MDSE_CD              = M.MDSE_CD
            AND M.INVTY_CTRL_FLG        = #flgOffN#
            AND M.INSTL_BASE_CTRL_FLG   = #flgOnY#
            AND M.EZCANCELFLAG          = '0'

            AND CD.GLBL_CMPY_CD         = PEQ.GLBL_CMPY_CD      (+)
            AND CD.PRC_CATG_CD          = PEQ.PRC_CATG_CD       (+)
            AND PEQ.EZCANCELFLAG    (+) = '0'
            
            AND CD.GLBL_CMPY_CD         = STC.GLBL_CMPY_CD   
            AND CD.SHIP_TO_CUST_CD      = STC.SHIP_TO_CUST_CD
            AND STC.EZCANCELFLAG        = '0'
            
            AND
              ( NOT EXISTS(
                SELECT  '1'
                FROM    CPO_DTL     CD_E
                       ,ALL_MDSE_V  MV
                WHERE 
                        CD_E.DS_CPO_CONFIG_PK   = DCC.DS_CPO_CONFIG_PK
                  AND   CD_E.MDSE_CD            = MV.MDSE_CD
                  AND   MV.INVTY_CTRL_FLG       = #flgOnY#
                  AND   MV.INSTL_BASE_CTRL_FLG  = #flgOnY#
                  <!-- 2019/05/31 QC#50551 Add Start -->
                  AND   CD_E.ORD_LINE_STS_CD    NOT IN (#lineStsClose#,#lineStsCancelled#)
                  AND   CD_E.ORD_LINE_DPLY_STS_CD &lt;&gt; #dplyStsOnLoan#
                  <!-- 2019/05/31 QC#50551 Add End -->

                  <!-- 2019/05/27 QC#50462 Add Start  -->
                  <isNotNull property="rtlWhCdList">
                  AND   CD_E.RTL_WH_CD          NOT IN 
                    <iterate property="rtlWhCdList" var="rtlWhCd[]" open="(" close=")" conjunction=",">
                              #rtlWhCd[]#
                    </iterate>
                  </isNotNull>
                  AND   CD_E.EZCANCELFLAG       = '0'
                  AND   MV.EZCANCELFLAG         = '0'
                  <!-- 2019/05/27 QC#50462 Add End -->
               )
              OR DCC.SVC_CONFIG_MSTR_PK IS NULL -- Dealer Sales
              )

            AND NOT EXISTS(
                SELECT   'X'
                  FROM   HLD H
                        ,HLD_PROC_DFN HPD
                 WHERE
                         SP.GLBL_CMPY_CD         = H.GLBL_CMPY_CD
                   AND   SP.TRX_HDR_NUM          = H.CPO_ORD_NUM
                   AND   H.CPO_DTL_LINE_NUM IS NULL
                   AND   H.REL_FLG               = #flgOffN#
                   AND   H.GLBL_CMPY_CD          = HPD.GLBL_CMPY_CD
                   AND   H.HLD_RSN_CD            = HPD.HLD_RSN_CD
                   AND   HPD.REL_PNT_SO_CRAT_FLG = #flgOnY#
                   AND   H.EZCANCELFLAG          = '0'
                   AND   HPD.EZCANCELFLAG        = '0'
            ) 
            AND NOT EXISTS(
                SELECT   'X'
                  FROM   HLD H
                        ,HLD_PROC_DFN HPD
                 WHERE
                         SP.GLBL_CMPY_CD         = H.GLBL_CMPY_CD
                   AND   SP.TRX_HDR_NUM          = H.CPO_ORD_NUM
                   AND   SP.TRX_LINE_NUM         = H.CPO_DTL_LINE_NUM
                   AND   SP.TRX_LINE_SUB_NUM     = H.CPO_DTL_LINE_SUB_NUM
                   AND   H.SHPG_PLN_NUM IS NULL
                   AND   H.REL_FLG               = #flgOffN#
                   AND   H.GLBL_CMPY_CD          = HPD.GLBL_CMPY_CD
                   AND   H.HLD_RSN_CD            = HPD.HLD_RSN_CD
                   AND   HPD.REL_PNT_SO_CRAT_FLG = #flgOnY#
                   AND   H.EZCANCELFLAG          = '0'
                   AND   HPD.EZCANCELFLAG        = '0'
            ) 
            AND NOT EXISTS(
                SELECT   'X'
                  FROM   HLD H
                        ,HLD_PROC_DFN HPD
                 WHERE
                         SP.GLBL_CMPY_CD         = H.GLBL_CMPY_CD
                   AND   SP.SHPG_PLN_NUM         = H.SHPG_PLN_NUM
                   AND   H.REL_FLG               = #flgOffN#
                   AND   H.GLBL_CMPY_CD          = HPD.GLBL_CMPY_CD
                   AND   H.HLD_RSN_CD            = HPD.HLD_RSN_CD
                   AND   HPD.REL_PNT_SO_CRAT_FLG = #flgOnY#
                   AND   H.EZCANCELFLAG          = '0'
                   AND   HPD.EZCANCELFLAG        = '0'
            )
            <!-- 2019/01/15 QC#22718 Del Start -->
<!--            AND EXISTS(-->
<!--                SELECT   'X'-->
<!--                  FROM   HLD H-->
<!--                 WHERE-->
<!--                         SP.GLBL_CMPY_CD         = H.GLBL_CMPY_CD-->
<!--                   AND   SP.SHPG_PLN_NUM         = H.SHPG_PLN_NUM-->
<!--                   AND   H.REL_FLG               = #flgOffN#-->
<!--                   AND   H.HLD_RSN_CD            = #hldRsnArrivedWait4Instl#-->
<!--                   AND   H.EZCANCELFLAG          = '0'-->
<!--            )-->
            <!-- 2019/01/15 QC#29879 Del End -->
        ORDER BY
             TRX_HDR_NUM
            ,TRX_LINE_NUM
            ,TRX_LINE_SUB_NUM
            ,SHPG_PLN_NUM
    </statement>


    <statement id="getMdseCdForConfig" parameterClass="Map" resultClass="Map">
        SELECT
             C.MDSE_CD       AS MDSE_CD
            ,CASE
                WHEN B.BASE_CMPT_FLG = 'Y'
                    THEN #svcMachTpCdMach#
                    ELSE #svcMachTpCdAcc#
             END             AS SVC_MACH_TP_CD
        FROM
             DS_CPO_CONFIG A
            ,CPO_DTL       B
            ,SHPG_PLN      C
            ,MDSE          D
        WHERE
                A.GLBL_CMPY_CD         = #glblCmpyCd#
            AND A.CPO_ORD_NUM          = #cpoOrdNum#
            AND A.DS_CPO_CONFIG_PK     = #dsCpoConfigPk#
            AND A.EZCANCELFLAG         = '0'
            AND A.GLBL_CMPY_CD         = B.GLBL_CMPY_CD
            AND A.CPO_ORD_NUM          = B.CPO_ORD_NUM
            AND A.DS_CPO_CONFIG_PK     = B.DS_CPO_CONFIG_PK
            AND B.EZCANCELFLAG         = '0'
            AND B.GLBL_CMPY_CD         = C.GLBL_CMPY_CD
            AND B.CPO_ORD_NUM          = C.TRX_HDR_NUM
            AND B.CPO_DTL_LINE_NUM     = C.TRX_LINE_NUM
            AND B.CPO_DTL_LINE_SUB_NUM = C.TRX_LINE_SUB_NUM
            AND C.EZCANCELFLAG         = '0'
            AND C.GLBL_CMPY_CD         = D.GLBL_CMPY_CD
            AND C.MDSE_CD              = D.MDSE_CD
            AND D.EZCANCELFLAG         = '0'
            AND D.INSTL_BASE_CTRL_FLG  = 'Y'
            AND NOT EXISTS(
                SELECT
                    *
                FROM
                    SVC_MACH_MSTR Z
                WHERE
                        Z.GLBL_CMPY_CD         = C.GLBL_CMPY_CD
                    AND Z.CPO_ORD_NUM          = C.TRX_HDR_NUM
                    AND Z.CPO_DTL_LINE_NUM     = C.TRX_LINE_NUM
                    AND Z.CPO_DTL_LINE_SUB_NUM = C.TRX_LINE_SUB_NUM
                    AND Z.SVC_CONFIG_MSTR_PK   = A.SVC_CONFIG_MSTR_PK
                    AND Z.EZCANCELFLAG = '0'
                )
        UNION ALL
        SELECT
             B.MDSE_CD         AS MDSE_CD
            ,B.SVC_MACH_TP_CD  AS SVC_MACH_TP_CD
        FROM
             DS_CPO_CONFIG A
            ,SVC_MACH_MSTR B
        WHERE
                A.GLBL_CMPY_CD         = #glblCmpyCd#
            AND A.CPO_ORD_NUM          = #cpoOrdNum#
            AND A.DS_CPO_CONFIG_PK     = #dsCpoConfigPk#
            AND A.EZCANCELFLAG         = '0'
            AND A.GLBL_CMPY_CD         = B.GLBL_CMPY_CD
            AND A.SVC_CONFIG_MSTR_PK   = B.SVC_CONFIG_MSTR_PK
            AND B.EZCANCELFLAG         = '0'
        ORDER BY
             SVC_MACH_TP_CD
            ,MDSE_CD
    </statement>


    <statement id="getConfigMstrDtl" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            A.SVC_CONFIG_MSTR_DTL_PK AS SVC_CONFIG_MSTR_DTL_PK
        FROM
            SVC_CONFIG_MSTR_DTL A
        WHERE
                A.GLBL_CMPY_CD       = #glblCmpyCd#
            AND A.SVC_CONFIG_MSTR_PK = #svcConfigMstrPk#
            AND A.SVC_MACH_MSTR_PK   = #svcMachMstrPk#

    </statement>

    <statement id="getOrdCatgBizCtxForDsOrdTp" parameterClass="Map" resultClass="Map">
        SELECT
             B.FIRST_BIZ_CTX_ATTRB_TXT AS FIRST_BIZ_CTX_ATTRB_TXT
        FROM
             DS_ORD_TP        A
            ,ORD_CATG_BIZ_CTX B
        WHERE
                A.GLBL_CMPY_CD       = #glblCmpyCd#
            AND A.EZCANCELFLAG       = '0'
            AND A.DS_ORD_TP_CD       = #dsaOrdTpCd#
            AND A.GLBL_CMPY_CD       = B.GLBL_CMPY_CD
            AND A.DS_ORD_CATG_CD     = B.DS_ORD_CATG_CD
            <!-- 2019/09/18 QC#53580 Add Start -->
            AND (A.DS_ORD_TP_CD      = B.DS_ORD_TP_CD
                OR  B.DS_ORD_TP_CD   IS NULL)
            <!-- 2019/09/18 QC#53580 Add End -->
            AND B.EZCANCELFLAG       = '0'
            AND B.ORD_CATG_CTX_TP_CD = #ordCatgCtxTpCd#
    </statement>
        <statement id="getIbOwnerCd" parameterClass="Map" resultClass="Map">
        SELECT
            *
        FROM
            (
            SELECT
                 B.FIRST_BIZ_CTX_ATTRB_TXT AS FIRST_BIZ_CTX_ATTRB_TXT
            FROM
                 CPO                A
                ,ORD_CATG_BIZ_CTX   B
            WHERE
                    A.GLBL_CMPY_CD       = #glblCmpyCd#
                AND A.EZCANCELFLAG       = '0'
                AND A.CPO_ORD_NUM        = #cpoOrdNum#
                AND A.GLBL_CMPY_CD       = B.GLBL_CMPY_CD
                AND A.DS_ORD_CATG_CD     = B.DS_ORD_CATG_CD
                AND (
                        B.DS_ORD_TP_CD IS NULL
                        OR (
                                B.DS_ORD_TP_CD IS NOT NULL
                            AND B.DS_ORD_TP_CD = A.DS_ORD_TP_CD
                        )
                    )
                AND (
                        B.DS_ORD_RSN_CD IS NULL
                        OR (
                                B.DS_ORD_RSN_CD IS NOT NULL
                            AND B.DS_ORD_RSN_CD = A.DS_ORD_RSN_CD
                        )
                    )
                AND B.EZCANCELFLAG       = '0'
                AND B.ORD_CATG_CTX_TP_CD = #ordCatgCtxTpCd#
             ORDER BY B.DS_ORD_CATG_CD,B.DS_ORD_TP_CD,B.DS_ORD_RSN_CD
             )
         WHERE
            ROWNUM = 1
    </statement>
    
    <statement id="getSellToCustCd" parameterClass="Map" resultClass="String">
        SELECT
            A.SELL_TO_CUST_CD AS SELL_TO_CUST_CD
        FROM
             BILL_TO_CUST    A
        WHERE
            A.GLBL_CMPY_CD    = #glblCmpyCd#
        AND A.EZCANCELFLAG    = '0'
        AND A.BILL_TO_CUST_CD = #billToCustCd#

    </statement>
        <statement id="getCpoCtacInfo" parameterClass="Map" resultClass="Map">
        SELECT
             DCP.DS_CTAC_PNT_PK
            ,SMC.SVC_CTAC_TP_CD
        FROM
             DS_CPO_CTAC_PSN         DCC
            ,DS_CTAC_PNT             DCP
            ,SVC_MACH_CTAC_CRAT_RELN SMC
        WHERE
                DCC.GLBL_CMPY_CD     = #glblCmpyCd#
            AND DCC.CPO_ORD_NUM      = #cpoOrdNum#
            AND DCC.DS_CPO_CONFIG_PK = #dsCpoConfigPk#
            AND DCC.EZCANCELFLAG     = '0'
            AND DCC.GLBL_CMPY_CD     = DCP.GLBL_CMPY_CD
            AND DCC.CTAC_PSN_PK      = DCP.CTAC_PSN_PK
            AND DCP.EZCANCELFLAG     = '0'
            AND DCC.GLBL_CMPY_CD     = SMC.GLBL_CMPY_CD
            AND DCC.CTAC_PSN_TP_CD   = SMC.CTAC_TP_CD
            AND SMC.AUTO_CRAT_FLG    = 'Y'
            AND SMC.EZCANCELFLAG     = '0'
    </statement>
    <statement id="countSvcMachCtacPsn" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             COUNT(*)
        FROM
             SVC_MACH_CTAC_PSN       SMC
        WHERE
                SMC.GLBL_CMPY_CD     = #glblCmpyCd#
            AND SMC.SVC_MACH_MSTR_PK = #svcMachMstrPk#
            AND SMC.DS_CTAC_PNT_PK   = #dsCtacPntPk#
            AND SMC.SVC_CTAC_TP_CD   = #svcCtacTpCd#
            AND SMC.EFF_FROM_DT      &lt;= #slsDt#
            AND NVL(SMC.EFF_THRU_DT, #defEffThruDt#)  &gt;= #slsDt#
            AND SMC.EZCANCELFLAG     = '0'
    </statement>
    <statement id="searchHoldReleaseTarget" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             HLD.HLD_PK
        FROM
             HLD            HLD
            ,SHPG_PLN       SP
            ,CPO_DTL        CD
        WHERE
                HLD.GLBL_CMPY_CD        = #glblCmpyCd#
            AND HLD.CPO_ORD_NUM         = #cpoOrdNum#
            AND HLD.CPO_DTL_LINE_NUM    = #cpoOrdLineNum#
            AND HLD.CPO_DTL_LINE_SUB_NUM= #cpoOrdLineSubNum#
            AND HLD.SHPG_PLN_NUM        = #shpgPlnNum#
            AND HLD.HLD_RSN_CD          = #hldRsnS03#
            AND HLD.REL_FLG             = #relflgN#
            AND HLD.EZCANCELFLAG        = '0'

            AND HLD.GLBL_CMPY_CD        = SP.GLBL_CMPY_CD
            AND HLD.SHPG_PLN_NUM        = SP.SHPG_PLN_NUM
            AND SP.EZCANCELFLAG         = '0'

            AND SP.GLBL_CMPY_CD         = CD.GLBL_CMPY_CD
            AND SP.TRX_HDR_NUM          = CD.CPO_ORD_NUM
            AND SP.TRX_LINE_NUM         = CD.CPO_DTL_LINE_NUM
            AND SP.TRX_LINE_SUB_NUM     = CD.CPO_DTL_LINE_SUB_NUM
            AND CD.DS_CPO_CONFIG_PK     = #dsCpoConfigPk#
            AND CD.EZCANCELFLAG         = '0'
    </statement>
    <!-- START 2024/02/15 R.Tamura [QC#63393, ADD] -->
    <statement id="getExistConfigMachForSvcExchng" parameterClass="Map" resultClass="Map">
        SELECT
             A.SVC_MACH_MSTR_PK         AS SVC_MACH_MSTR_PK
            ,A.MDSE_CD                  AS MDSE_CD
            ,A.SVC_MACH_TP_CD           AS SVC_MACH_TP_CD
        FROM
             SVC_MACH_MSTR A
        WHERE
            A.GLBL_CMPY_CD       = #glblCmpyCd#
        AND A.EZCANCELFLAG       = '0'
        AND A.SVC_CONFIG_MSTR_PK = #svcConfigMstrPk#
        AND NOT EXISTS (
            SELECT
                *
            FROM
                DS_CPO_RTRN_DTL Z
            WHERE
                Z.GLBL_CMPY_CD       = A.GLBL_CMPY_CD
            AND Z.SVC_CONFIG_MSTR_PK = A.SVC_CONFIG_MSTR_PK
            AND Z.SVC_MACH_MSTR_PK   = A.SVC_MACH_MSTR_PK
            AND Z.CPO_ORD_NUM        = #cpoOrdNum#
            AND Z.EZCANCELFLAG       = '0'
            )
    </statement>
    <statement id="getNewConfigMachForSvcExchng" parameterClass="Map" resultClass="Map">
        SELECT
             V.SVC_MACH_MSTR_PK      AS SVC_MACH_MSTR_PK
            ,V.MDSE_CD               AS MDSE_CD
            ,CASE
                WHEN V.SVC_MACH_TP_CD = #svcMachTpCdMach# AND V.ROWCNT = 1
                    THEN #svcMachTpCdMach#
                    ELSE #svcMachTpCdAcc#
             END         AS SVC_MACH_TP_CD
        FROM
            (
            SELECT
                 W.SVC_MACH_MSTR_PK  AS SVC_MACH_MSTR_PK
                ,W.MDSE_CD           AS MDSE_CD
                ,W.SVC_MACH_TP_CD    AS SVC_MACH_TP_CD
                ,ROW_NUMBER() OVER (PARTITION BY W.SVC_MACH_TP_CD ORDER BY W.CPO_ORD_NUM, W.CPO_DTL_LINE_NUM, W.CPO_DTL_LINE_SUB_NUM) AS ROWCNT
            FROM
                (
                SELECT
                     C.CPO_ORD_NUM
                    ,C.CPO_DTL_LINE_NUM
                    ,C.CPO_DTL_LINE_SUB_NUM
                    ,F.SVC_MACH_MSTR_PK                                                AS SVC_MACH_MSTR_PK
                    ,D.MDSE_CD                                                         AS MDSE_CD
                    ,DECODE(E.PRNT_MDSE_CD, NULL, #svcMachTpCdAcc#, #svcMachTpCdMach#) AS SVC_MACH_TP_CD
                FROM
                     DS_CPO_CONFIG B
                    ,(
                        SELECT
                             U.GLBL_CMPY_CD
                            ,U.EZCANCELFLAG
                            ,U.DS_CPO_CONFIG_PK
                            ,U.CPO_ORD_NUM
                            ,U.CPO_DTL_LINE_NUM
                            ,U.CPO_DTL_LINE_SUB_NUM
                            ,DECODE(V.ORD_TAKE_MDSE_CD, NULL, U.MDSE_CD, V.ORD_TAKE_MDSE_CD) AS MDSE_CD
                        FROM
                             CPO_DTL       U
                            ,ORD_TAKE_MDSE V
                        WHERE
                            U.GLBL_CMPY_CD          = #glblCmpyCd#
                        AND U.EZCANCELFLAG          = '0'
                        AND U.DS_CPO_CONFIG_PK      = #dsCpoConfigPk#
                        AND U.GLBL_CMPY_CD          = V.GLBL_CMPY_CD     (+)
                        AND SUBSTR(U.MDSE_CD, 1, 8) = V.ORD_TAKE_MDSE_CD (+)
                        AND V.EZCANCELFLAG      (+) = '0'
                     ) C
                    ,SHPG_PLN      D
                    ,(
                        SELECT
                            Y.PRNT_MDSE_CD         AS PRNT_MDSE_CD
                        FROM
                             DS_CPO_CONFIG X
                            ,DS_MDL_CONFIG Y
                        WHERE
                            X.GLBL_CMPY_CD         = #glblCmpyCd#
                        AND X.CPO_ORD_NUM          = #cpoOrdNum#
                        AND X.DS_CPO_CONFIG_PK     = #dsCpoConfigPk#
                        AND X.CONFIG_CATG_CD       = #configCatgOut#
                        AND X.EZCANCELFLAG         = '0'
                        AND X.GLBL_CMPY_CD         = Y.GLBL_CMPY_CD
                        AND X.MDL_ID               = Y.MDL_ID
                        AND Y.DS_MDL_CONFIG_PK     = Y.PRNT_CONFIG_PK
                        AND Y.EZCANCELFLAG         = '0'
                        GROUP BY
                            Y.PRNT_MDSE_CD
                      ) E
                    ,SVC_MACH_MSTR F
                WHERE
                    B.GLBL_CMPY_CD         = #glblCmpyCd#
                AND B.CPO_ORD_NUM          = #cpoOrdNum#
                AND B.DS_CPO_CONFIG_PK     = #dsCpoConfigPk#
                AND B.CONFIG_CATG_CD       = #configCatgOut#
                AND B.EZCANCELFLAG         = '0'
                AND B.GLBL_CMPY_CD         = C.GLBL_CMPY_CD
                AND B.CPO_ORD_NUM          = C.CPO_ORD_NUM
                AND B.DS_CPO_CONFIG_PK     = C.DS_CPO_CONFIG_PK
                AND C.EZCANCELFLAG         = '0'
                AND C.GLBL_CMPY_CD         = D.GLBL_CMPY_CD
                AND C.CPO_ORD_NUM          = D.TRX_HDR_NUM
                AND C.CPO_DTL_LINE_NUM     = D.TRX_LINE_NUM
                AND C.CPO_DTL_LINE_SUB_NUM = D.TRX_LINE_SUB_NUM
                AND D.EZCANCELFLAG         = '0'
                AND C.MDSE_CD              = E.PRNT_MDSE_CD         (+)
                AND C.GLBL_CMPY_CD         = F.GLBL_CMPY_CD         (+)
                AND C.CPO_ORD_NUM          = F.CPO_ORD_NUM          (+)
                AND C.CPO_DTL_LINE_NUM     = F.CPO_DTL_LINE_NUM     (+)
                AND C.CPO_DTL_LINE_SUB_NUM = F.CPO_DTL_LINE_SUB_NUM (+)
                AND F.EZCANCELFLAG     (+) = '0'
                ORDER BY
                     C.CPO_ORD_NUM
                    ,C.CPO_DTL_LINE_NUM
                    ,C.CPO_DTL_LINE_SUB_NUM
                ) W
            ) V
    </statement>
    <statement id="getSvcConfigMstrPkOfAcc" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            D.SVC_CONFIG_MSTR_PK
        FROM
             DS_CPO_CONFIG A
            ,CPO_DTL       B
            ,SHPG_PLN      C
            ,SVC_MACH_MSTR D
        WHERE
                A.GLBL_CMPY_CD         = #glblCmpyCd#
            AND A.EZCANCELFLAG         = '0'
            AND A.DS_CPO_CONFIG_PK     = #dsCpoConfigPk#
            AND A.GLBL_CMPY_CD         = B.GLBL_CMPY_CD
            AND A.CPO_ORD_NUM          = B.CPO_ORD_NUM
            AND A.DS_CPO_CONFIG_PK     = B.DS_CPO_CONFIG_PK
            AND B.EZCANCELFLAG         = '0'
            AND B.BASE_CMPT_FLG        = 'Y'
            AND B.GLBL_CMPY_CD         = C.GLBL_CMPY_CD
            AND B.CPO_ORD_NUM          = C.TRX_HDR_NUM
            AND B.CPO_DTL_LINE_NUM     = C.TRX_LINE_NUM
            AND B.CPO_DTL_LINE_SUB_NUM = C.TRX_LINE_SUB_NUM
            AND C.EZCANCELFLAG         = '0'
            AND C.GLBL_CMPY_CD         = D.GLBL_CMPY_CD
            AND C.SHPG_PLN_NUM         = D.SHPG_PLN_NUM
            AND C.TRX_HDR_NUM          = D.CPO_ORD_NUM
            AND C.TRX_LINE_NUM         = D.CPO_DTL_LINE_NUM
            AND C.TRX_LINE_SUB_NUM     = D.CPO_DTL_LINE_SUB_NUM
            AND D.EZCANCELFLAG         = '0'

    </statement>
    <!-- END 2024/02/15 R.Tamura [QC#63393, ADD] -->
</sqlMap>
