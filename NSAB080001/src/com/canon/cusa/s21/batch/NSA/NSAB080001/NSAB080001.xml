<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSAB080001">
    <statement id="getTargetSvcInv" parameterClass="Map" resultClass="Map">
        SELECT
             SVC_INV_PK
            ,SVC_INV_NUM
            ,AUTO_SEQ_CD
        FROM
            (
                SELECT
                     SI.SVC_INV_PK
                    ,SI.SVC_INV_NUM
                    ,SI.DS_CONTR_PK
                    ,DIT.AUTO_SEQ_CD
                    ,SI.BILL_TO_CUST_CD
                    ,CASE WHEN SI.INV_TP_CD = #invTpCreditMemo# THEN 1 ELSE 2 END AS INV_TP_SORT
                    ,(
                        SELECT
                            MIN(DCBS.NEXT_BLLG_DT)
                        FROM
                            DS_CONTR_BLLG_SCHD DCBS
                        WHERE
                                SI.GLBL_CMPY_CD   = DCBS.GLBL_CMPY_CD
                            AND SI.SVC_INV_NUM    = DCBS.SVC_INV_NUM
                            AND DCBS.EZCANCELFLAG = '0'
                     ) AS NEXT_BLLG_DT
                    ,(SELECT MIN(SIL.BLLG_PER_FROM_DT) FROM SVC_INV_LINE SIL WHERE SIL.GLBL_CMPY_CD = SI.GLBL_CMPY_CD AND SIL.SVC_INV_NUM = SI.SVC_INV_NUM AND SIL.EZCANCELFLAG = '0') AS BLLG_PER_FROM_DT
                FROM
                     SVC_INV      SI
                    ,DS_INV_TP    DIT
                WHERE
                        SI.GLBL_CMPY_CD         = #glblCmpyCd#
                    AND SI.SVC_INV_OM_LINK_FLG  = 'N'
                    AND SI.TEMP_SVC_INV_NUM_FLG = 'Y'
                    AND SI.EZCANCELFLAG         = '0'
                    AND SI.GLBL_CMPY_CD         = DIT.GLBL_CMPY_CD
                    AND SI.DS_INV_TP_CD         = DIT.DS_INV_TP_CD
                    AND DIT.EZCANCELFLAG        = '0'
            )
        ORDER BY
             DS_CONTR_PK      ASC
            ,NEXT_BLLG_DT     ASC
            ,BLLG_PER_FROM_DT ASC
            ,INV_TP_SORT      ASC
            ,BILL_TO_CUST_CD  ASC
            ,SVC_INV_PK       ASC
    </statement>
</sqlMap>
