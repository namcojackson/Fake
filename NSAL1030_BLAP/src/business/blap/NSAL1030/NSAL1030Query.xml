<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSAL1030Query">
    <typeAlias alias="NSAL1030CMsg"  type="business.blap.NSAL1030.NSAL1030CMsg"/>
    <typeAlias alias="NSAL1030_ASMsg"  type="business.blap.NSAL1030.NSAL1030_ASMsg"/>

    <statement id="getHeaderInfo" parameterClass="Map" resultMap="result.getHeaderInfo">
        SELECT
             A.CUST_INCDT_ID                AS  CUST_INCDT_ID
            ,B.SVC_CR_REBIL_STS_DESC_TXT    AS  SVC_CR_REBIL_STS_DESC_TXT
            ,A.SVC_CR_REBIL_DESC_TXT        AS  SVC_CR_REBIL_DESC_TXT
            ,A.SVC_CR_REBIL_PK              AS  SVC_CR_REBIL_PK
            ,A.SVC_CR_REBIL_STS_CD          AS  SVC_CR_REBIL_STS_CD
        FROM
             SVC_CR_REBIL         A
            ,SVC_CR_REBIL_STS     B
        WHERE
                A.GLBL_CMPY_CD              = #glblCmpyCd#
            AND A.SVC_CR_REBIL_PK           = #svcCrRebilPk#
            AND A.EZCANCELFLAG              = '0'
            AND A.GLBL_CMPY_CD              = B.GLBL_CMPY_CD
            AND A.SVC_CR_REBIL_STS_CD       = B.SVC_CR_REBIL_STS_CD
            AND B.EZCANCELFLAG              = '0'
    </statement>
    <statement id="getDetailInfo" parameterClass="Map" resultMap="result.getDetailInfo">
        SELECT
             ROWNUM AS XX_ROW_NUM
            ,BLLG_PER_FROM_DT
            ,BLLG_PER_THRU_DT
            ,SVC_INV_NUM
            ,DS_CONTR_NUM
            ,CONSL_BILL_PK
            ,SVC_INV_CHRG_TP_DESC_TXT
            ,INV_LINE_DEAL_SLS_AMT
            ,INV_LINE_DEAL_TAX_AMT
            ,INV_LINE_DEAL_NET_AMT
            ,SER_NUM
            ,MDSE_CD
            ,SVC_CR_REBIL_STS_DESC_TXT
            ,SVC_INV_LINE_PK
            ,SVC_CR_REBIL_DTL_PK
            ,SVC_INV_CHRG_TP_CD
            ,SVC_CR_REBIL_STS_CD
<!-- START 2016/12/06 N.Arai [QC#14204, ADD] -->
            ,XX_REC_HIST_CRAT_TS
            ,XX_REC_HIST_CRAT_BY_NM
            ,XX_REC_HIST_UPD_TS
            ,XX_REC_HIST_UPD_BY_NM
            ,XX_REC_HIST_TBL_NM
<!-- END 2016/12/06 N.Arai [QC#14204, ADD] -->
        FROM (
            SELECT
                 A.BLLG_PER_FROM_DT           AS  BLLG_PER_FROM_DT
                ,A.BLLG_PER_THRU_DT           AS  BLLG_PER_THRU_DT
                ,A.SVC_INV_NUM                AS  SVC_INV_NUM
                ,B.DS_CONTR_NUM               AS  DS_CONTR_NUM
                ,G.CONSL_BILL_PK              AS  CONSL_BILL_PK
                ,CASE
                     WHEN A.SVC_INV_CHRG_TP_CD = #svcInvChrgTpBaseCharge#  THEN #invTypeBase#
                     WHEN A.SVC_INV_CHRG_TP_CD = #svcInvChrgTpMeterCharge# THEN #invTypeUsage#
                 END                          AS  SVC_INV_CHRG_TP_DESC_TXT
                ,A.INV_LINE_DEAL_SLS_AMT      AS  INV_LINE_DEAL_SLS_AMT
                ,A.INV_LINE_DEAL_TAX_AMT      AS  INV_LINE_DEAL_TAX_AMT
                ,A.INV_LINE_DEAL_NET_AMT      AS  INV_LINE_DEAL_NET_AMT
                ,A.SER_NUM                    AS  SER_NUM
                ,A.MDSE_CD                    AS  MDSE_CD
<!-- START 2017/06/28 Y.Osawa [QC#18748, MOD] -->
<!--                ,F.SVC_CR_REBIL_STS_DESC_TXT  AS  SVC_CR_REBIL_STS_DESC_TXT -->
<!--                ,A.SVC_INV_LINE_PK            AS  SVC_INV_LINE_PK           -->
<!--                ,D.SVC_CR_REBIL_DTL_PK        AS  SVC_CR_REBIL_DTL_PK       -->
<!--                ,A.SVC_INV_CHRG_TP_CD         AS  SVC_INV_CHRG_TP_CD        -->
<!--                ,E.SVC_CR_REBIL_STS_CD        AS  SVC_CR_REBIL_STS_CD       -->
                ,CR.SVC_CR_REBIL_STS_DESC_TXT AS  SVC_CR_REBIL_STS_DESC_TXT
                ,A.SVC_INV_LINE_PK            AS  SVC_INV_LINE_PK
                ,CR.SVC_CR_REBIL_DTL_PK       AS  SVC_CR_REBIL_DTL_PK
                ,A.SVC_INV_CHRG_TP_CD         AS  SVC_INV_CHRG_TP_CD
                ,CR.SVC_CR_REBIL_STS_CD       AS  SVC_CR_REBIL_STS_CD
<!-- END   2017/06/28 Y.Osawa [QC#18748, MOD] -->
<!-- START 2016/12/06 N.Arai [QC#14204, ADD] -->
                ,A.EZINTIME                   AS  XX_REC_HIST_CRAT_TS
                ,A.EZINUSERID                 AS  XX_REC_HIST_CRAT_BY_NM
                ,A.EZUPTIME                   AS  XX_REC_HIST_UPD_TS
                ,A.EZUPUSERID                 AS  XX_REC_HIST_UPD_BY_NM
                ,A.EZTABLEID                  AS  XX_REC_HIST_TBL_NM
<!-- END 2016/12/06 N.Arai [QC#14204, ADD] -->
            FROM
                 SVC_INV_LINE                 A
                ,SVC_INV                      B
<!-- START 2017/06/28 Y.Osawa [QC#18748, MOD] -->
<!--                 ,SVC_CR_REBIL_DTL             D -->
<!--                 ,SVC_CR_REBIL                 E -->
<!--                 ,SVC_CR_REBIL_STS             F -->
                ,CONSL_BILL_LINE              G
                ,DS_CONTR_DTL                 H
                ,DS_CONTR                     I
                ,(SELECT
                  D.GLBL_CMPY_CD
                 ,D.ORIG_SVC_INV_NUM
                 ,D.EZCANCELFLAG
                 ,F.SVC_CR_REBIL_STS_DESC_TXT
                 ,D.SVC_CR_REBIL_DTL_PK
                 ,E.SVC_CR_REBIL_STS_CD
                  FROM
                  SVC_CR_REBIL_DTL             D
                 ,SVC_CR_REBIL                 E
                 ,SVC_CR_REBIL_STS             F
                  WHERE 1=1
                    AND D.EZCANCELFLAG         = '0'
                    AND D.GLBL_CMPY_CD         = E.GLBL_CMPY_CD
                    AND D.SVC_CR_REBIL_PK      = E.SVC_CR_REBIL_PK
                    AND E.EZCANCELFLAG         = '0'
                    AND E.GLBL_CMPY_CD         = F.GLBL_CMPY_CD
                    AND E.SVC_CR_REBIL_STS_CD  = F.SVC_CR_REBIL_STS_CD
                    AND E.SVC_CR_REBIL_STS_CD   &lt;&gt; #svcCrRebilStsCd#
                    AND F.EZCANCELFLAG         = '0'
                 ) CR
<!-- END   2017/06/28 Y.Osawa [QC#18748, MOD] -->
            WHERE
                    A.GLBL_CMPY_CD            = #cMsg.glblCmpyCd#
                <isNotNull property="cMsg.svcInvNum_P">
                AND A.SVC_INV_NUM             = #cMsg.svcInvNum_P#
                </isNotNull>
                <isNotNull property="cMsg.serNum_P">
                AND A.SER_NUM                 = #cMsg.serNum_P#
                </isNotNull>
                <isNotNull property="cMsg.bllgPerFromDt_P">
                AND A.BLLG_PER_FROM_DT        = #cMsg.bllgPerFromDt_P#
                </isNotNull>
                <isNotNull property="cMsg.bllgPerToDt_P">
                AND A.BLLG_PER_THRU_DT        = #cMsg.bllgPerToDt_P#
                </isNotNull>
                <iterate property="svcInvChrgTpCdList" var="svcInvChrgTpCd[]" open="AND A.SVC_INV_CHRG_TP_CD IN (" close=")" conjunction=",">
                    #svcInvChrgTpCd[]#
                </iterate>
                AND A.EZCANCELFLAG            = '0'
                AND A.GLBL_CMPY_CD            = B.GLBL_CMPY_CD
                AND A.SVC_INV_NUM             = B.SVC_INV_NUM
                AND B.EZCANCELFLAG            = '0'
                <isNotNull property="cMsg.dsContrNum_P">
                AND B.DS_CONTR_NUM            = #cMsg.dsContrNum_P#
                </isNotNull>
<!-- START 2017/06/28 Y.Osawa [QC#18748, DEL] -->
<!--                AND A.GLBL_CMPY_CD            = D.GLBL_CMPY_CD(+)           -->
<!--                AND A.SVC_INV_NUM             = D.ORIG_SVC_INV_NUM(+)       -->
<!--                AND D.EZCANCELFLAG(+)         = '0'                         -->
<!--                AND D.GLBL_CMPY_CD            = E.GLBL_CMPY_CD(+)           -->
<!--                AND D.SVC_CR_REBIL_PK         = E.SVC_CR_REBIL_PK(+)        -->
<!--                AND E.EZCANCELFLAG(+)         = '0'                         -->
<!--                AND E.GLBL_CMPY_CD            = F.GLBL_CMPY_CD(+)           -->
<!--                AND E.SVC_CR_REBIL_STS_CD     = F.SVC_CR_REBIL_STS_CD(+)    -->
<!--                AND E.SVC_CR_REBIL_STS_CD(+)  &lt;&gt; #svcCrRebilStsCd#    -->
<!--                AND F.EZCANCELFLAG(+)         = '0'                         -->
<!-- END   2017/06/28 Y.Osawa [QC#18748, DEL] -->
                AND A.GLBL_CMPY_CD            = G.GLBL_CMPY_CD(+)
                AND A.SVC_INV_NUM             = G.CONSL_BILL_TRX_ID(+)
                AND G.EZCANCELFLAG(+)         = '0'
                <isNotNull property="cMsg.conslBillPk_P">
                AND G.CONSL_BILL_PK           = #cMsg.conslBillPk_P#
                </isNotNull>
                AND A.DS_CONTR_DTL_PK         = H.DS_CONTR_DTL_PK
                AND A.GLBL_CMPY_CD            = H.GLBL_CMPY_CD
                AND H.EZCANCELFLAG            = '0'
                AND H.DS_CONTR_PK             = I.DS_CONTR_PK
                AND H.GLBL_CMPY_CD            = I.GLBL_CMPY_CD
                AND I.EZCANCELFLAG            = '0'
                AND (
                        I.DS_CONTR_CATG_CD = #dsContrCatg_reg#
                        OR  H.DS_CONTR_DTL_TP_CD = #dsContrDtlTp_flt#
                        OR (I.DS_CONTR_CATG_CD = #dsContrCatg_agg# AND H.DS_CONTR_DTL_TP_CD &lt;&gt; #dsContrDtlTp_agg#)
                    )
<!-- START 2017/06/28 Y.Osawa [QC#18748, ADD] -->
                AND A.GLBL_CMPY_CD     = CR.GLBL_CMPY_CD(+)
                AND A.SVC_INV_NUM      = CR.ORIG_SVC_INV_NUM(+)
                AND CR.EZCANCELFLAG(+) = '0'
<!-- END   2017/06/28 Y.Osawa [QC#18748, ADD] -->
            ORDER BY
                 A.BLLG_PER_FROM_DT   DESC
                ,A.SVC_INV_NUM        DESC
                ,A.SVC_INV_CHRG_TP_CD ASC
        )
        WHERE
            ROWNUM        &lt;= #rowNum#
    </statement>

    <resultMap id="result.getHeaderInfo"          class="NSAL1030CMsg">
        <result property="custIncdtId_H"          column="CUST_INCDT_ID"             javaType="EZDSStringItem" />
        <result property="svcCrRebilStsDescTxt_H" column="SVC_CR_REBIL_STS_DESC_TXT" javaType="EZDSStringItem" />
        <result property="svcCrRebilDescTxt_H"    column="SVC_CR_REBIL_DESC_TXT"     javaType="EZDSStringItem" />
        <result property="svcCrRebilPk_H"         column="SVC_CR_REBIL_PK"           javaType="EZDSBigDecimalItem" />
        <result property="svcCrRebilStsCd_H"      column="SVC_CR_REBIL_STS_CD"       javaType="EZDSStringItem" />
    </resultMap>
    <resultMap id="result.getDetailInfo"          class="NSAL1030_ASMsg">
        <result property="xxRowNum_A"             column="XX_ROW_NUM"                javaType="EZDBBigDecimalItem" />
        <result property="bllgPerFromDt_A"        column="BLLG_PER_FROM_DT"          javaType="EZDSDateItem" />
        <result property="bllgPerThruDt_A"        column="BLLG_PER_THRU_DT"          javaType="EZDSDateItem" />
        <result property="svcInvNum_A"            column="SVC_INV_NUM"               javaType="EZDSStringItem" />
        <result property="dsContrNum_A"           column="DS_CONTR_NUM"              javaType="EZDSStringItem" />
        <result property="conslBillPk_A"          column="CONSL_BILL_PK"             javaType="EZDSBigDecimalItem" />
        <result property="svcInvChrgTpDescTxt_A"  column="SVC_INV_CHRG_TP_DESC_TXT"  javaType="EZDSStringItem" />
        <result property="invLineDealSlsAmt_A"    column="INV_LINE_DEAL_SLS_AMT"     javaType="EZDSBigDecimalItem" />
        <result property="invLineDealTaxAmt_A"    column="INV_LINE_DEAL_TAX_AMT"     javaType="EZDSBigDecimalItem" />
        <result property="invLineDealNetAmt_A"    column="INV_LINE_DEAL_NET_AMT"     javaType="EZDSBigDecimalItem" />
        <result property="serNum_A"               column="SER_NUM"                   javaType="EZDSStringItem" />
        <result property="mdseCd_A"               column="MDSE_CD"                   javaType="EZDSStringItem" />
        <result property="svcCrRebilStsDescTxt_A" column="SVC_CR_REBIL_STS_DESC_TXT" javaType="EZDSStringItem" />
        <result property="svcCrRebilDtlPk_A"      column="SVC_CR_REBIL_DTL_PK"       javaType="EZDSBigDecimalItem" />
        <result property="svcInvLinePk_A"         column="SVC_INV_LINE_PK"           javaType="EZDSBigDecimalItem" />
        <result property="svcInvChrgTpCd_A"       column="SVC_INV_CHRG_TP_CD"        javaType="EZDSStringItem" />
        <result property="svcCrRebilStsCd_A"      column="SVC_CR_REBIL_STS_CD"       javaType="EZDSStringItem" />
<!-- START 2016/12/06 N.Arai [QC#14204, ADD] -->
        <result property="xxRecHistCratTs_A"      column="XX_REC_HIST_CRAT_TS"       javaType="EZDSStringItem"/>
        <result property="xxRecHistCratByNm_A"    column="XX_REC_HIST_CRAT_BY_NM"    javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdTs_A"       column="XX_REC_HIST_UPD_TS"        javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdByNm_A"     column="XX_REC_HIST_UPD_BY_NM"     javaType="EZDSStringItem"/>
        <result property="xxRecHistTblNm_A"       column="XX_REC_HIST_TBL_NM"        javaType="EZDSStringItem"/>
<!-- END 2016/12/06 N.Arai [QC#14204, ADD] -->
    </resultMap>
</sqlMap>
