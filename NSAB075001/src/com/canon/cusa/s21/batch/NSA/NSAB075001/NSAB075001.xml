<?xml version="1.0" encoding="UTF-8"?>

<sqlMap namespace="NSAB075001">
    <statement id="getTargetDataList" parameterClass="Map" resultClass="Map">
SELECT
     DCD.GLBL_CMPY_CD 
    ,IHT.ITT_NUMBER
    ,IHT.ITT_STATUS                  AS ITT_HEADER_ITT_STATUS
    ,SMM.SER_NUM
    ,DCD.DS_CONTR_DTL_PK
    ,DCD.CONTR_EFF_FROM_DT
    ,DC.DS_CONTR_NUM
    ,VND.VND_CD
    ,TM.TECH_TOC_CD
    ,SPT_BW.METER_TYPE               AS BW_METER_TYPE
    ,SPT_COLOR.METER_TYPE            AS COLOR_METER_TYPE
    ,SPT_BW.BASE_PRICE               AS BW_BASE_PRC_DEAL_AMT
    ,SPT_COLOR.BASE_PRICE            AS COLOR_BASE_PRC_DEAL_AMT
    ,SPT_BW.OVERAGE_RATE             AS BW_MTR_PRC_AMT_RATE
    ,SPT_COLOR.OVERAGE_RATE          AS COLOR_MTR_PRC_AMT_RATE
    ,SPT_BW.TERM                     AS BW_TERM
    ,SPT_COLOR.TERM                  AS COLOR_TERM
    ,SPT_BW.BASE_BILL_CYCLE          AS BW_BASE_BLLG_CYCLE
    ,SPT_COLOR.BASE_BILL_CYCLE       AS COLOR_BASE_BLLG_CYCLE
    ,SPT_BW.OVERAGE_BILL_CYCLE       AS BW_OVERAGE_BLLG_CYCLE
    ,SPT_COLOR.OVERAGE_BILL_CYCLE    AS COLOR_OVERAGE_BLLG_CYCLE
    ,SPT_BW.COPY_INCLUSION           AS BW_MTR_ALWNC_CNT
    ,SPT_COLOR.COPY_INCLUSION        AS COLOR_MTR_ALWNC_CNT
<!-- START 2017/10/20 U.Kim [QC#21840, ADD] -->
    ,SPT_BW.CONTRACT_TYPE            AS CONTRACT_TYPE
<!-- END 2017/10/20 U.Kim [QC#21840, ADD] -->

FROM
     DS_CPO_CONFIG                   DCC
    ,SVC_CONFIG_MSTR                 SCM
    ,SVC_MACH_MSTR                   SMM
    ,DS_CONTR_DTL                    DCD
    ,DS_CONTR                        DC
    ,CANON_E580_ITT_HEADERS_TBL      IHT
    ,CANON_E580_SERVICE_PRICING_TBL  SPT_BW
    ,CANON_E580_SERVICE_PRICING_TBL  SPT_COLOR
    ,CANON_E580_ITT_LINES_TBL        ILT
    ,VND                             VND
    ,PRNT_VND                        PV
    ,DS_CTAC_PSN_RELN                DCPR
    ,CTAC_PSN                        CP
    ,S21_PSN                         SP
    ,(
        SELECT
             TM.GLBL_CMPY_CD
            ,TM.EZCANCELFLAG
            ,TM.TECH_TOC_CD
        FROM
            TECH_MSTR TM
        WHERE
                TM.GLBL_CMPY_CD                              = #glblCmpyCd#
            AND TM.EZCANCELFLAG                              = '0'
            AND EXISTS (
                    SELECT 1
                    FROM
                         ORG_FUNC_ASG     OFA1
                        ,TOC
                        ,ORG_FUNC_ROLE_TP OFRT
                    WHERE
                        OFA1.EFF_FROM_DT                 &lt;= #salesDate#
                    AND NVL(OFA1.EFF_THRU_DT, #maxDate#) &gt;= #salesDate#
                    AND OFA1.GLBL_CMPY_CD                    = TOC.GLBL_CMPY_CD
                    AND OFA1.TOC_CD                          = TOC.TOC_CD
                    AND TOC.GLBL_CMPY_CD                     = OFRT.GLBL_CMPY_CD
                    AND TOC.ORG_FUNC_ROLE_TP_CD              = OFRT.ORG_FUNC_ROLE_TP_CD
                    AND OFRT.TECH_MSTR_REQ_FLG               = #flgY#
                    AND OFRT.ACTV_FLG                        = #flgY#
                    AND OFA1.EZCANCELFLAG                    = '0'
                    AND TOC.EZCANCELFLAG                     = '0'
                    AND OFRT.EZCANCELFLAG                    = '0' )
     )                               TM
    ,DS_CONTR_DTL_STS_V              DCDS
WHERE
         SMM.GLBL_CMPY_CD = #glblCmpyCd#
     AND SMM.GLBL_CMPY_CD = SCM.GLBL_CMPY_CD
     AND SCM.GLBL_CMPY_CD = DCD.GLBL_CMPY_CD
     AND DCD.GLBL_CMPY_CD = DC.GLBL_CMPY_CD
     AND SMM.GLBL_CMPY_CD = DCC.GLBL_CMPY_CD
     AND DCD.GLBL_CMPY_CD = DCDS.GLBL_CMPY_CD(+)
     AND SMM.GLBL_CMPY_CD = VND.GLBL_CMPY_CD(+)
     AND VND.GLBL_CMPY_CD = PV.GLBL_CMPY_CD(+)
     AND VND.GLBL_CMPY_CD = CP.GLBL_CMPY_CD(+)
     AND CP.GLBL_CMPY_CD = SP.GLBL_CMPY_CD(+)
     AND SP.GLBL_CMPY_CD = TM.GLBL_CMPY_CD(+)
     AND SMM.EZCANCELFLAG = '0'
     AND SCM.EZCANCELFLAG = '0'
     AND DCC.EZCANCELFLAG = '0'
     AND DCD.EZCANCELFLAG = '0'
     AND DC.EZCANCELFLAG = '0'
     AND DCDS.EZCANCELFLAG(+)  = '0'
     AND IHT.CANCELLED_FLAG = 'N'
     AND ILT.CANCELLED_FLAG = 'N'
     AND VND.EZCANCELFLAG(+)  = '0'
     AND PV.EZCANCELFLAG(+)  = '0'
     AND DCPR.EZCANCELFLAG(+)  = '0'
     AND CP.EZCANCELFLAG(+)  = '0'
     AND SP.EZCANCELFLAG(+)  = '0'
     AND TM.EZCANCELFLAG(+)  = '0'
     AND NVL(DCD.SUB_CONTR_CRAT_PROC_CD, 0) = #subContrCrtPrcCdDflt#
     AND DCD.DS_CONTR_DTL_PK = DCDS.DS_CONTR_DTL_PK
     AND DCDS.DS_CONTR_CTRL_STS_CD NOT IN (#stsCanc#,#stsExpd#,#stsTrmd#)
     AND DC.DS_CONTR_PK = DCD.DS_CONTR_PK
     AND DCD.SVC_MACH_MSTR_PK = SCM.SVC_MACH_MSTR_PK
     AND SCM.SVC_MACH_MSTR_PK = SMM.SVC_MACH_MSTR_PK
     AND SCM.SVC_CONFIG_MSTR_PK = DCC.SVC_CONFIG_MSTR_PK
     AND SMM.CPO_ORD_NUM = ILT.ORDER_NUMBER
     AND SMM.CPO_DTL_LINE_NUM = SUBSTR(ILT.LINE_NUMBER, 1, 3)
     AND SMM.CPO_DTL_LINE_SUB_NUM = SUBSTR(ILT.LINE_NUMBER, 5, 3)
     AND ILT.ITT_NUMBER   = IHT.ITT_NUMBER
     AND ILT.ORDER_NUMBER = IHT.ORDER_NUMBER
     AND ILT.ITT_NUMBER = SPT_BW.ITT_NUMBER(+)
     AND ILT.EQUIP_MODEL = SPT_BW.EQUIP_MODEL(+)
     AND SPT_BW.METER_TYPE(+) = #bwMtrType#
     AND ILT.ITT_NUMBER = SPT_COLOR.ITT_NUMBER(+)
     AND ILT.EQUIP_MODEL = SPT_COLOR.EQUIP_MODEL(+)
     AND SPT_COLOR.METER_TYPE(+) = #colorMtrType#
     AND IHT.DEALER_WHSE_CODE = VND.VND_CD(+)
     AND VND.RGTN_STS_CD(+) = #rgtnStsCd#
     AND VND.EFF_THRU_DT(+) &gt;= #salesDate#
     AND VND.PRNT_VND_PK = PV.PRNT_VND_PK(+)
     AND (PV.INAC_DT(+) IS NULL OR PV.INAC_DT(+) &gt; #salesDate#)
     AND VND.GLBL_CMPY_CD = DCPR.GLBL_CMPY_CD(+)
     AND VND.LOC_NUM = DCPR.LOC_NUM(+)
     AND DCPR.GLBL_CMPY_CD = CP.GLBL_CMPY_CD(+)
     AND DCPR.CTAC_PSN_PK = CP.CTAC_PSN_PK(+)
     AND DCPR.EFF_FROM_DT(+) &lt;= #salesDate#
     AND NVL(DCPR.EFF_THRU_DT(+), #maxDate#) &gt;= #salesDate#
     AND CP.CTAC_PSN_PK = SP.CTAC_PSN_PK(+)
     AND SP.PSN_CD = TM.TECH_TOC_CD(+)
ORDER BY
     IHT.ITT_NUMBER  ASC ,SMM.SER_NUM  ASC
    </statement>

    <statement id="getbllgCycleCd" parameterClass="Map" resultClass="String">
SELECT 
    BC.BLLG_CYCLE_CD
FROM
    BLLG_CYCLE   BC
        
WHERE
        BC.EZCANCELFLAG = '0'
    AND BC.GLBL_CMPY_CD = #glblCmpyCd#
    AND BC.ITT_BLLG_CYCLE_VAL_TXT = #bllgCycle#
    </statement>
</sqlMap>
