<?xml version="1.0" encoding="UTF-8"?>

<sqlMap namespace="NSAB021001">
    <statement id="getUpdateKeyList" parameterClass="Map" resultClass="Map">
        WITH
            <!-- START 2022/09/20 [QC#60045,ADD] -->
            <!-- START 2023/05/09 K.Kitachi [QC#61469, DEL] -->
<!--            DEF_WIN_DAYS AS ( -->
<!--                SELECT -->
<!--                     A.MTR_READ_WIN_MLY_DAYS_AOT -->
<!--                    ,A.MTR_READ_WIN_OTH_DAYS_AOT -->
<!--                FROM -->
<!--                    DS_WIN_DAYS A -->
<!--                WHERE -->
<!--                        A.GLBL_CMPY_CD             = #glblCmpyCd# -->
<!--                    AND A.EZCANCELFLAG             = '0' -->
<!--                    AND A.DS_WIN_DAYS_TRGT_PER_TXT = '*' -->
<!--                    AND A.SVC_LINE_BIZ_CD          = '*' -->
<!--                ), -->
            <!-- END 2023/05/09 K.Kitachi [QC#61469, DEL] -->
            <!-- END   2022/09/20 [QC#60045,ADD] -->
            IV_DS_CONTR_BLLG_SCHD AS (
               SELECT
                    DISTINCT
                     X.GLBL_CMPY_CD         AS GLBL_CMPY_CD
                    ,X.DS_CONTR_PK          AS DS_CONTR_PK
                    ,X.DS_CONTR_DTL_PK      AS DS_CONTR_DTL_PK
                    ,X.DS_CONTR_BLLG_MTR_PK AS DS_CONTR_BLLG_MTR_PK
                    ,X.DS_CONTR_PRC_EFF_PK  AS DS_CONTR_PRC_EFF_PK
               FROM
                   (
                    SELECT
                         DISTINCT
                          D.GLBL_CMPY_CD         AS GLBL_CMPY_CD
                         ,D.DS_CONTR_PK          AS DS_CONTR_PK
                         ,S.DS_CONTR_DTL_PK      AS DS_CONTR_DTL_PK
                         ,S.DS_CONTR_BLLG_MTR_PK AS DS_CONTR_BLLG_MTR_PK
                         ,S.DS_CONTR_PRC_EFF_PK  AS DS_CONTR_PRC_EFF_PK
                         ,S.BLLG_SCHD_THRU_DT    AS BLLG_SCHD_THRU_DT
                         <!-- START 2022/09/20 [QC#60045,MOD] -->
                         <!-- ,NVL(DECODE(NVL(Y.BLLG_CYCLE_UOM_CD, PY.BLLG_CYCLE_UOM_CD), #months#, R.MTR_READ_WIN_MLY_DAYS_AOT, R.MTR_READ_WIN_OTH_DAYS_AOT), #defBefDays#) AS BEF_DAYS -->
                         <!-- START 2023/02/09 S.Naya [QC#60045, MOD] -->
                         <!--,DECODE(NVL(Y.BLLG_CYCLE_UOM_CD, PY.BLLG_CYCLE_UOM_CD), #months#, COALESCE(DWD.MTR_READ_WIN_MLY_DAYS_AOT, (SELECT MTR_READ_WIN_MLY_DAYS_AOT FROM DEF_WIN_DAYS), #defBefDays#), COALESCE(DWD.MTR_READ_WIN_OTH_DAYS_AOT, (SELECT MTR_READ_WIN_OTH_DAYS_AOT FROM DEF_WIN_DAYS), #defBefDays#)) AS BEF_DAYS -->
                         <!-- START 2023/05/09 K.Kitachi [QC#61469, MOD] -->
                         <!-- ,DECODE(NVL(Y.BLLG_CYCLE_UOM_CD, PY.BLLG_CYCLE_UOM_CD), #months#, COALESCE(DWD.MTR_READ_WIN_MLY_DAYS_AOT, DWD2.MTR_READ_WIN_MLY_DAYS_AOT, (SELECT MTR_READ_WIN_MLY_DAYS_AOT FROM DEF_WIN_DAYS), #defBefDays#), COALESCE(DWD.MTR_READ_WIN_OTH_DAYS_AOT, DWD2.MTR_READ_WIN_OTH_DAYS_AOT, (SELECT MTR_READ_WIN_OTH_DAYS_AOT FROM DEF_WIN_DAYS), #defBefDays#)) AS BEF_DAYS -->
                         ,DECODE(NVL(Y.BLLG_CYCLE_UOM_CD, PY.BLLG_CYCLE_UOM_CD), #months#, COALESCE(DWD.MTR_READ_WIN_MLY_DAYS_AOT, DWD2.MTR_READ_WIN_MLY_DAYS_AOT, #mtrReadWinMlyDaysAot#, #defBefDays#), COALESCE(DWD.MTR_READ_WIN_OTH_DAYS_AOT, DWD2.MTR_READ_WIN_OTH_DAYS_AOT, #mtrReadWinOthDaysAot#, #defBefDays#)) AS BEF_DAYS
                         <!-- END 2023/05/09 K.Kitachi [QC#61469, MOD] -->
                         <!-- END   2023/02/09 S.Naya [QC#60045, MOD] -->
                         <!-- END   2022/09/20 [QC#60045,MOD] -->
                     FROM
                          DS_CONTR_BLLG_SCHD       S
                         ,DS_CONTR_DTL             D
                         ,DS_CONTR                 C
                         <!-- START 2022/09/20 [QC#60045,DEL] -->
                         <!-- ,DS_CONTR_INTFC_DEF_RULE  R -->
                         <!-- END   2022/09/20 [QC#60045,DEL] -->
                         ,DS_CONTR_BLLG_MTR        B
                         ,BLLG_CYCLE               Y
                         ,DS_CONTR_BLLG_SCHD       PS
                         ,DS_CONTR_BLLG_MTR        PB
                         ,BLLG_CYCLE               PY
                         <!-- START 2022/09/20 [QC#60045,ADD] -->
                         ,DS_WIN_DAYS           DWD
                         <!-- END   2022/09/20 [QC#60045,ADD] -->
                         <!-- START 2023/02/09 S.Naya [QC#60045, ADD] -->
                         ,DS_WIN_DAYS              DWD2
                         <!-- END   2023/02/09 S.Naya [QC#60045, ADD] -->
                     WHERE
                             S.GLBL_CMPY_CD         =     #glblCmpyCd#
                         AND S.SKIP_RECOV_TP_CD     &lt;&gt; #skipRecovTpCd#
                         AND S.USG_CHRG_FLG         =     #usgChrgFlg#
                         AND S.MTR_ENTRY_CPLT_FLG   =     #mtrEntryCpltFlg#
                         AND S.GLBL_CMPY_CD         =     D.GLBL_CMPY_CD
                         AND S.DS_CONTR_DTL_PK      =     D.DS_CONTR_DTL_PK
                         <iterate property="dsContrDtlTpCdArray" var="dsContrDtlTpCd[]" open="AND D.DS_CONTR_DTL_TP_CD NOT IN (" close=")" conjunction=",">
                             #dsContrDtlTpCd[]#
                         </iterate>
                         AND D.GLBL_CMPY_CD         =     C.GLBL_CMPY_CD
                         AND D.DS_CONTR_PK          =     C.DS_CONTR_PK
                         <iterate property="dsContrCtrlStsCdArray" var="dsContrCtrlStsCd[]" open="AND D.DS_CONTR_DTL_STS_CD IN (" close=")" conjunction=",">
                             #dsContrCtrlStsCd[]#
                         </iterate>
                         AND D.MTR_HLD_FLG          =     #mtrHldFlg#
<!-- START 2017/09/19 K.Kim [QC#21066, ADD] -->
                         AND D.QLTY_ASRN_HLD_FLG    =     'N'
<!-- END 2017/09/19 K.Kim [QC#21066, ADD] -->
                         <iterate property="dsContrStsCdArray" var="dsContrStsCd[]" open="AND C.DS_CONTR_STS_CD IN (" close=")" conjunction=",">
                             #dsContrStsCd[]#
                         </iterate>
                         AND S.EZCANCELFLAG         =     '0'
                         AND D.EZCANCELFLAG         =     '0'
                         AND C.EZCANCELFLAG         =     '0'
                         <!-- START 2022/09/20 [QC#60045,DEL] -->
                         <!-- AND C.GLBL_CMPY_CD             =     R.GLBL_CMPY_CD          (+) -->
                         <!-- AND C.DS_CONTR_SRC_TP_CD       =     R.CONTR_INTFC_SRC_TP_CD (+) -->
                         <!-- AND C.DS_CONTR_CLS_CD          =     R.DS_CONTR_CLS_CD       (+) -->
                         <!-- AND C.SVC_LINE_BIZ_CD          =     R.SVC_LINE_BIZ_CD       (+) -->
                         <!-- AND R.EFF_FROM_DT  (+)         &lt;= #salesDate# -->
                         <!-- AND R.ENBL_FLG     (+)         =     'Y' -->
                         <!-- AND R.EZCANCELFLAG (+)         =     '0' -->
                         <!-- END   2022/09/20 [QC#60045,DEL] -->
                         AND S.GLBL_CMPY_CD             =     B.GLBL_CMPY_CD
                         AND S.DS_CONTR_BLLG_MTR_PK     =     B.DS_CONTR_BLLG_MTR_PK
                         AND B.EZCANCELFLAG             =     '0'
<!-- START 2017/09/19 K.Kim [QC#21066, ADD] -->
                         AND B.QLTY_ASRN_HLD_FLG        =     'N'
<!-- END 2017/09/19 K.Kim [QC#21066, ADD] -->
                         AND B.GLBL_CMPY_CD             =     Y.GLBL_CMPY_CD          (+)
                         AND B.BLLG_MTR_BLLG_CYCLE_CD   =     Y.BLLG_CYCLE_CD         (+)
                         AND Y.EZCANCELFLAG (+)         =     '0'
                         AND S.GLBL_CMPY_CD             =     PS.GLBL_CMPY_CD         (+)
                         AND S.PRNT_DS_CONTR_BLLG_SCHD_PK
                                                        =     PS.DS_CONTR_BLLG_SCHD_PK(+)
                         AND PS.EZCANCELFLAG (+)        =     '0'
                         AND PS.GLBL_CMPY_CD            =     PB.GLBL_CMPY_CD         (+)
                         AND PS.DS_CONTR_BLLG_MTR_PK    =     PB.DS_CONTR_BLLG_MTR_PK (+)
                         AND PB.EZCANCELFLAG (+)        =     '0'
                         AND PB.GLBL_CMPY_CD            =     PY.GLBL_CMPY_CD         (+)
                         AND PB.BLLG_MTR_BLLG_CYCLE_CD  =     PY.BLLG_CYCLE_CD        (+)
                         AND PY.EZCANCELFLAG (+)        =     '0'
                         <!-- START 2022/09/20 [QC#60045,ADD] -->
                         AND S.GLBL_CMPY_CD                     = DWD.GLBL_CMPY_CD(+)
                         AND DWD.EZCANCELFLAG(+)                = '0'
                         AND SUBSTR(S.BLLG_SCHD_THRU_DT, 0, 6)  = DWD.DS_WIN_DAYS_TRGT_PER_TXT(+)
                         AND C.SVC_LINE_BIZ_CD                  = DWD.SVC_LINE_BIZ_CD(+)
                         <!-- END   2022/09/20 [QC#60045,ADD] -->
                         <!-- START 2023/02/09 S.Naya [QC#60045, ADD] -->
                         AND S.GLBL_CMPY_CD                     = DWD2.GLBL_CMPY_CD(+)
                         AND DWD2.EZCANCELFLAG(+)               = '0'
                         AND SUBSTR(S.BLLG_SCHD_THRU_DT, 0, 6)  = DWD2.DS_WIN_DAYS_TRGT_PER_TXT(+)
                         AND DWD2.SVC_LINE_BIZ_CD(+)            = '*'
                         <!-- END   2023/02/09 S.Naya [QC#60045, ADD] -->
                   ) X
               WHERE
                   X.BLLG_SCHD_THRU_DT   &lt;= TO_CHAR((TO_DATE(#salesDate#, #dateFormat#) + TO_NUMBER(X.BEF_DAYS)), #dateFormat#) 
               ORDER BY
                    DS_CONTR_PK
                   ,DS_CONTR_DTL_PK
                   ,DS_CONTR_BLLG_MTR_PK
                   ,DS_CONTR_PRC_EFF_PK
        )
        SELECT
             UPDATE_TP
            ,UPTADE_TABLE
            ,GLBL_CMPY_CD
            ,DS_CONTR_PK
            ,DS_CONTR_DTL_PK
            ,DS_CONTR_BLLG_MTR_PK
            ,DS_CONTR_PRC_EFF_PK
        FROM
            (
                (
                SELECT
                    DISTINCT
                     '1'                   AS UPDATE_TP
                    ,'DS_CONTR'            AS UPTADE_TABLE
                    ,IV1.GLBL_CMPY_CD      AS GLBL_CMPY_CD
                    ,IV1.DS_CONTR_PK       AS DS_CONTR_PK
                    ,NULL                  AS DS_CONTR_DTL_PK
                    ,NULL                  AS DS_CONTR_BLLG_MTR_PK
                    ,NULL                  AS DS_CONTR_PRC_EFF_PK
                FROM
                     DS_CONTR              C
                    ,IV_DS_CONTR_BLLG_SCHD IV1
                WHERE
                        IV1.GLBL_CMPY_CD = C.GLBL_CMPY_CD
                    AND IV1.DS_CONTR_PK  = C.DS_CONTR_PK
                    AND C.MTR_HLD_FLG    = #mtrHldFlg#
                    AND C.EZCANCELFLAG   = '0'
                )
                UNION ALL
                (
                SELECT
                    DISTINCT
                     '2'                   AS UPDATE_TP
                    ,'DS_CONTR_DTL'        AS UPTADE_TABLE
                    ,IV2.GLBL_CMPY_CD      AS GLBL_CMPY_CD
                    ,IV2.DS_CONTR_PK       AS DS_CONTR_PK
                    ,IV2.DS_CONTR_DTL_PK   AS DS_CONTR_DTL_PK
                    ,NULL                  AS DS_CONTR_BLLG_MTR_PK
                    ,NULL                  AS DS_CONTR_PRC_EFF_PK
                FROM
                     DS_CONTR_DTL          D
                    ,IV_DS_CONTR_BLLG_SCHD IV2        
                WHERE
                        IV2.GLBL_CMPY_CD      =  D.GLBL_CMPY_CD
                    AND IV2.DS_CONTR_DTL_PK   =  D.DS_CONTR_DTL_PK
                    <iterate property="dsContrCtrlStsCdArray" var="dsContrCtrlStsCd[]" open="AND D.DS_CONTR_DTL_STS_CD IN (" close=")" conjunction=",">
                        #dsContrCtrlStsCd[]#
                    </iterate>
                    AND D.MTR_HLD_FLG         =  #mtrHldFlg#
                    AND D.EZCANCELFLAG        =  '0'
                )
                UNION ALL
                (
                SELECT
                    DISTINCT
                     '3'                        AS UPDATE_TP
                    ,'DS_CONTR_BLLG_MTR'        AS UPTADE_TABLE
                    ,IV3.GLBL_CMPY_CD           AS GLBL_CMPY_CD
                    ,IV3.DS_CONTR_PK            AS DS_CONTR_PK
                    ,IV3.DS_CONTR_DTL_PK        AS DS_CONTR_DTL_PK
                    ,IV3.DS_CONTR_BLLG_MTR_PK   AS DS_CONTR_BLLG_MTR_PK
                    ,NULL                       AS DS_CONTR_PRC_EFF_PK
                FROM
                     DS_CONTR_BLLG_MTR     B
                    ,IV_DS_CONTR_BLLG_SCHD IV3      
                WHERE
                        IV3.GLBL_CMPY_CD           =  B.GLBL_CMPY_CD
                    AND IV3.DS_CONTR_BLLG_MTR_PK   =  B.DS_CONTR_BLLG_MTR_PK
                    <iterate property="dsContrCtrlStsCdArray" var="dsContrCtrlStsCd[]" open="AND B.DS_CONTR_BLLG_MTR_STS_CD IN (" close=")" conjunction=",">
                        #dsContrCtrlStsCd[]#
                    </iterate>
                    AND B.MTR_HLD_FLG              =  #mtrHldFlg#
                    AND B.EZCANCELFLAG             =  '0'            
                )
                UNION ALL
                (
                SELECT
                    DISTINCT
                     '4'                        AS UPDATE_TP
                    ,'DS_CONTR_PRC_EFF'         AS UPTADE_TABLE
                    ,IV4.GLBL_CMPY_CD           AS GLBL_CMPY_CD
                    ,IV4.DS_CONTR_PK            AS DS_CONTR_PK
                    ,IV4.DS_CONTR_DTL_PK        AS DS_CONTR_DTL_PK
                    ,IV4.DS_CONTR_BLLG_MTR_PK   AS DS_CONTR_BLLG_MTR_PK
                    ,IV4.DS_CONTR_PRC_EFF_PK    AS DS_CONTR_PRC_EFF_PK
                FROM
                     DS_CONTR_PRC_EFF      P
                    ,IV_DS_CONTR_BLLG_SCHD IV4      
                WHERE
                        IV4.GLBL_CMPY_CD           =  P.GLBL_CMPY_CD
                    AND IV4.DS_CONTR_PRC_EFF_PK    =  P.DS_CONTR_PRC_EFF_PK
                    <iterate property="dsContrCtrlStsCdArray" var="dsContrCtrlStsCd[]" open="AND P.DS_CONTR_PRC_EFF_STS_CD IN (" close=")" conjunction=",">
                        #dsContrCtrlStsCd[]#
                    </iterate>
                    AND P.MTR_HLD_FLG              =  #mtrHldFlg#
                    AND P.USG_CHRG_FLG             =  #usgChrgFlg#
                    AND P.EZCANCELFLAG             =  '0'            
                )
            ) UPDATE_KEY_DATA
        ORDER BY
             GLBL_CMPY_CD
            ,DS_CONTR_PK
            ,UPDATE_TP
            ,DS_CONTR_DTL_PK
            ,DS_CONTR_BLLG_MTR_PK
            ,DS_CONTR_PRC_EFF_PK
    </statement>
</sqlMap>
