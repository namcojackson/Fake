<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NSAL1070Query">

    <typeAlias alias="NSAL1070_ASMsg" type="business.blap.NSAL1070.NSAL1070_ASMsg"/>
    <typeAlias alias="NSAL1070_BSMsg" type="business.blap.NSAL1070.NSAL1070_BSMsg"/>

    <statement id="getXsMtrList" parameterClass="Map" resultMap="result.searchXsMtrList">
        <!-- START 2018/05/22 K.Kitachi [QC#26070, ADD] -->
        SELECT
            DS_CONTR_PRC_EFF_PK               -- DS Contract Price Effective PK
            ,XS_MTR_COPY_QTY                  -- Excess Meter Copy Quantity
            ,XS_MTR_AMT_RATE                  -- Excess Meter Amount Rate
            ,DS_CONTR_BLLG_MTR_PK             -- DS Contract Billing Meter PK
            ,BLLG_MTR_LB_CD                   -- Billing Meter Label Code
            ,MTR_LB_DESC_TXT                  -- Physical Meter Label Name
        FROM
            (
        <!-- END 2018/05/22 K.Kitachi [QC#26070, ADD] -->
                SELECT
                    DCPE.DS_CONTR_PRC_EFF_PK                -- DS Contract Price Effective PK
                    ,DCPEM.XS_MTR_COPY_QTY                  -- Excess Meter Copy Quantity
                    ,DCPEM.XS_MTR_AMT_RATE                  -- Excess Meter Amount Rate
                    ,DCPEM.DS_CONTR_BLLG_MTR_PK             -- DS Contract Billing Meter PK
                    ,DCBM.BLLG_MTR_LB_CD                    -- Billing Meter Label Code
                    ,ML.MTR_LB_DESC_TXT                     -- Physical Meter Label Name
                    <!-- START 2018/05/22 K.Kitachi [QC#26070, ADD] -->
                    ,ML.MTR_LB_SORT_NUM
                    ,ROW_NUMBER() OVER(PARTITION BY DCPEM.CONTR_XS_COPY_PK ORDER BY DCPE.CONTR_PRC_EFF_THRU_DT DESC) RNUM
                    <!-- END 2018/05/22 K.Kitachi [QC#26070, ADD] -->
                FROM
                    DS_CONTR_PRC_EFF        DCPE
                    ,DS_CONTR_PRC_EFF_MTR   DCPEM
                    ,DS_CONTR_BLLG_MTR      DCBM
                    ,MTR_LB                 ML
                WHERE
                    DCPE.GLBL_CMPY_CD               = #glblCmpyCd#
                    AND DCPE.EZCANCELFLAG           = '0'
                    AND DCPEM.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCPEM.EZCANCELFLAG          = '0'
                    AND DCBM.GLBL_CMPY_CD           = #glblCmpyCd#
                    AND DCBM.EZCANCELFLAG           = '0'
                    AND ML.GLBL_CMPY_CD             = #glblCmpyCd#
                    AND ML.EZCANCELFLAG             = '0'
                    AND DCPE.DS_CONTR_DTL_PK        = #dsContrDtlPk#
                    AND DCPEM.DS_CONTR_PRC_EFF_PK   = DCPE.DS_CONTR_PRC_EFF_PK
                    AND DCBM.DS_CONTR_BLLG_MTR_PK   = DCPEM.DS_CONTR_BLLG_MTR_PK
                    AND ML.MTR_LB_CD                = DCBM.BLLG_MTR_LB_CD
                <!-- START 2018/05/22 K.Kitachi [QC#26070, DEL] -->
                <!-- ORDER BY -->
                <!--     ML.MTR_LB_SORT_NUM -->
                <!--     ,DCPEM.XS_MTR_COPY_QTY -->
                <!-- END 2018/05/22 K.Kitachi [QC#26070, DEL] -->
        <!-- START 2018/05/22 K.Kitachi [QC#26070, ADD] -->
            )
        WHERE
            RNUM = 1
        ORDER BY
            MTR_LB_SORT_NUM
            ,XS_MTR_COPY_QTY
        <!-- END 2018/05/22 K.Kitachi [QC#26070, ADD] -->
    </statement>

    <resultMap id="result.searchXsMtrList" class="NSAL1070_ASMsg">
        <result property="dsContrPrcEffPk_A1"   column="DS_CONTR_PRC_EFF_PK"    javaType="EZDSBigDecimalItem" />
        <result property="xsMtrCopyQty_A1"      column="XS_MTR_COPY_QTY"        javaType="EZDSBigDecimalItem" />
        <result property="xsMtrAmtRate_A1"      column="XS_MTR_AMT_RATE"        javaType="EZDSBigDecimalItem" />
        <result property="dsContrBllgMtrPk_A1"  column="DS_CONTR_BLLG_MTR_PK"   javaType="EZDSBigDecimalItem" />
        <result property="bllgMtrLbCd_A1"       column="BLLG_MTR_LB_CD"         javaType="EZDSStringItem" />
        <result property="mtrLbDescTxt_A1"      column="MTR_LB_DESC_TXT"        javaType="EZDSStringItem" />
    </resultMap>

    <statement id="getXsMtrListForArrg" parameterClass="Map" resultMap="result.searchXsMtrListForArrg">
        <!-- START 2018/05/22 K.Kitachi [QC#26070, ADD] -->
        SELECT
            DS_CONTR_PK              -- DS Contract PK
            ,DS_CONTR_DTL_PK         -- DS Contract Detail PK
            ,DS_CONTR_PRC_EFF_PK     -- DS Contract Price Effective PK
            ,XS_MTR_COPY_QTY         -- Excess Meter Copy Quantity
            ,XS_MTR_AMT_RATE         -- Excess Meter Amount Rate
            ,DS_CONTR_BLLG_MTR_PK    -- DS Contract Billing Meter PK
            ,DS_CONTR_BLLG_MTR_ID
            ,MTR_LB_DESC_TXT         -- Physical Meter Label Name
        FROM
            (
        <!-- END 2018/05/22 K.Kitachi [QC#26070, ADD] -->
                SELECT
                    DCD1.DS_CONTR_PK              -- DS Contract PK
                    ,DCD2.DS_CONTR_DTL_PK         -- DS Contract Detail PK
                    ,DCPE.DS_CONTR_PRC_EFF_PK     -- DS Contract Price Effective PK
                    ,DCPEM.XS_MTR_COPY_QTY        -- Excess Meter Copy Quantity
                    ,DCPEM.XS_MTR_AMT_RATE        -- Excess Meter Amount Rate
                    ,DCPEM.DS_CONTR_BLLG_MTR_PK   -- DS Contract Billing Meter PK
                    <!-- START 2016/02/23 T.Tsuchida [QC#2382, MOD] -->
                    <!-- ,DCBM.DS_CONTR_BLLG_MTR_ID -->
                    ,DCBM.BLLG_MTR_LB_CD        AS DS_CONTR_BLLG_MTR_ID
                    <!-- END 2016/02/23 T.Tsuchida [QC#2382, MOD] -->
                    ,ML.MTR_LB_DESC_TXT           -- Physical Meter Label Name
                    <!-- START 2018/05/22 K.Kitachi [QC#26070, ADD] -->
                    ,ML.MTR_LB_SORT_NUM
                    ,DCPEM.DS_CONTR_PRC_EFF_MTR_PK
                    ,ROW_NUMBER() OVER(PARTITION BY DCPEM.CONTR_XS_COPY_PK ORDER BY DCPE.CONTR_PRC_EFF_THRU_DT DESC) RNUM
                    <!-- END 2018/05/22 K.Kitachi [QC#26070, ADD] -->
                FROM
                    DS_CONTR_DTL            DCD1
                    ,DS_CONTR_DTL           DCD2
                    ,DS_CONTR_PRC_EFF       DCPE
                    ,DS_CONTR_PRC_EFF_MTR   DCPEM
                    ,DS_CONTR_BLLG_MTR      DCBM
                    ,MTR_LB                 ML
                WHERE
                    DCD1.GLBL_CMPY_CD               = #glblCmpyCd#
                    AND DCD1.EZCANCELFLAG           = '0'
                    AND DCD2.GLBL_CMPY_CD           = #glblCmpyCd#
                    AND DCD2.EZCANCELFLAG           = '0'
                    AND DCPE.GLBL_CMPY_CD           = #glblCmpyCd#
                    AND DCPE.EZCANCELFLAG           = '0'
                    AND DCPEM.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCPEM.EZCANCELFLAG          = '0'
                    AND DCBM.GLBL_CMPY_CD           = #glblCmpyCd#
                    AND DCBM.EZCANCELFLAG           = '0'
                    AND ML.GLBL_CMPY_CD             = #glblCmpyCd#
                    AND ML.EZCANCELFLAG             = '0'
                    AND DCD1.DS_CONTR_DTL_PK        = #dsContrDtlPk#
                    <!-- START 2016/02/23 T.Tsuchida [QC#2382, MOD] -->
                    <!-- AND DCD2.DS_CONTR_DTL_PK        = #dsContrDtlPk# -->
                    AND DCD2.DS_CONTR_DTL_TP_CD     &lt;&gt; #dsContrDtlTpCdIsAgg#
                    <!-- END 2016/02/23 T.Tsuchida [QC#2382, MOD] -->
                    AND DCD2.DS_CONTR_PK            = DCD1.DS_CONTR_PK
                    AND DCPE.DS_CONTR_DTL_PK        = DCD2.DS_CONTR_DTL_PK
                    AND DCPEM.DS_CONTR_PRC_EFF_PK   = DCPE.DS_CONTR_PRC_EFF_PK
                    AND DCBM.DS_CONTR_BLLG_MTR_PK   = DCPEM.DS_CONTR_BLLG_MTR_PK
                    AND ML.MTR_LB_CD                = DCBM.BLLG_MTR_LB_CD
                <!-- START 2018/05/22 K.Kitachi [QC#26070, DEL] -->
                <!-- ORDER BY -->
                <!--     ML.MTR_LB_SORT_NUM -->
                <!--     ,DCPEM.DS_CONTR_PRC_EFF_MTR_PK -->
                <!-- END 2018/05/22 K.Kitachi [QC#26070, DEL] -->
        <!-- START 2018/05/22 K.Kitachi [QC#26070, ADD] -->
            )
        WHERE
            RNUM = 1
        ORDER BY
            MTR_LB_SORT_NUM
            ,DS_CONTR_PRC_EFF_MTR_PK
        <!-- END 2018/05/22 K.Kitachi [QC#26070, ADD] -->
    </statement>

    <resultMap id="result.searchXsMtrListForArrg" class="NSAL1070_BSMsg">
        <result property="dsContrPk_B1"         column="DS_CONTR_PK"            javaType="EZDSBigDecimalItem" />
        <result property="dsContrDtlPk_B1"      column="DS_CONTR_DTL_PK"        javaType="EZDSBigDecimalItem" />
        <result property="dsContrPrcEffPk_B1"   column="DS_CONTR_PRC_EFF_PK"    javaType="EZDSBigDecimalItem" />
        <result property="xsMtrCopyQty_B1"      column="XS_MTR_COPY_QTY"        javaType="EZDSBigDecimalItem" />
        <result property="xsMtrAmtRate_B1"      column="XS_MTR_AMT_RATE"        javaType="EZDSBigDecimalItem" />
        <result property="dsContrBllgMtrPk_B1"  column="DS_CONTR_BLLG_MTR_PK"   javaType="EZDSBigDecimalItem" />
        <result property="dsContrBllgMtrId_B1"  column="DS_CONTR_BLLG_MTR_ID"   javaType="EZDSStringItem" />
        <result property="mtrLbDescTxt_B1"      column="MTR_LB_DESC_TXT"        javaType="EZDSStringItem" />
    </resultMap>

    <!-- START 2017/09/28 K.Kojima [QC#18376,ADD] -->
    <statement id="getUplftMtrPrcUpRatio" parameterClass="Map" resultMap="BigDecimal">
        SELECT
            DMEBM.UPLFT_MTR_PRC_UP_RATIO
        FROM
             DS_CONTR_DTL         DCD
            ,SVC_CONFIG_MSTR      SCM
            ,DS_MDL_ESCL_RULE     DMER
            ,DS_MDL_ESCL_BLLG_MTR DMEBM
        WHERE
                DCD.GLBL_CMPY_CD                = #glblCmpyCd#
            AND DCD.DS_CONTR_DTL_PK             = #dsContrDtlPk#
            AND DCD.EZCANCELFLAG                = '0'
            AND DCD.GLBL_CMPY_CD                = SCM.GLBL_CMPY_CD
            AND DCD.SVC_CONFIG_MSTR_PK          = SCM.SVC_CONFIG_MSTR_PK
            AND SCM.EZCANCELFLAG                = '0'
            AND SCM.GLBL_CMPY_CD                = DMER.GLBL_CMPY_CD
            AND SCM.MDL_ID                      = DMER.MDL_ID
            AND DMER.EFF_FROM_DT               &lt;= #slsDt#
            AND NVL(DMER.EFF_THRU_DT, #slsDt#) &gt;= #slsDt#
            AND SCM.EZCANCELFLAG                = '0'
            AND DMER.GLBL_CMPY_CD               = DMEBM.GLBL_CMPY_CD
            AND DMER.DS_MDL_ESCL_RULE_PK        = DMEBM.DS_MDL_ESCL_RULE_PK
            AND DMEBM.BLLG_MTR_LB_CD            = #bllgMtrLbCd#
            AND DMEBM.EZCANCELFLAG              = '0'
    </statement>

    <statement id="getUplftMtrPrcUpRatioForLine" parameterClass="Map" resultMap="BigDecimal">
        SELECT
            DMEBM.UPLFT_MTR_PRC_UP_RATIO
        FROM
             DS_CONTR_DTL         DCD
            ,DS_CONTR_DTL         DCDM
            ,SVC_CONFIG_MSTR      SCM
            ,DS_MDL_ESCL_RULE     DMER
            ,DS_MDL_ESCL_BLLG_MTR DMEBM
        WHERE
                DCD.GLBL_CMPY_CD                = #glblCmpyCd#
            AND DCD.DS_CONTR_DTL_PK             = #dsContrDtlPk#
            AND DCD.EZCANCELFLAG                = '0'
            AND DCD.GLBL_CMPY_CD                = DCDM.GLBL_CMPY_CD
            AND DCD.DS_CONTR_PK                 = DCDM.DS_CONTR_PK
            AND DCDM.SVC_MACH_MSTR_PK           IS NOT NULL
            AND DCDM.EZCANCELFLAG               = '0'
            AND DCDM.GLBL_CMPY_CD               = SCM.GLBL_CMPY_CD
            AND DCDM.SVC_CONFIG_MSTR_PK         = SCM.SVC_CONFIG_MSTR_PK
            AND SCM.EZCANCELFLAG                = '0'
            AND SCM.GLBL_CMPY_CD                = DMER.GLBL_CMPY_CD
            AND SCM.MDL_ID                      = DMER.MDL_ID
            AND DMER.EFF_FROM_DT               &lt;= #slsDt#
            AND NVL(DMER.EFF_THRU_DT, #slsDt#) &gt;= #slsDt#
            AND SCM.EZCANCELFLAG                = '0'
            AND DMER.GLBL_CMPY_CD               = DMEBM.GLBL_CMPY_CD
            AND DMER.DS_MDL_ESCL_RULE_PK        = DMEBM.DS_MDL_ESCL_RULE_PK
            AND DMEBM.BLLG_MTR_LB_CD            = #bllgMtrLbCd#
            AND DMEBM.EZCANCELFLAG              = '0'
        ORDER BY
            DCDM.DS_CONTR_DTL_PK ASC
    </statement>
    <!-- END 2017/09/28 K.Kojima [QC#18376,ADD] -->
</sqlMap>
