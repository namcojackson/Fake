<?xml version="1.0" encoding="UTF-8"?>

<sqlMap namespace="NLCL0640Query">

    <statement id="getCountStatus" parameterClass="Map"
        resultClass="Map">
        SELECT
            PIC.PHYS_INVTY_CNT_STS_CD
        FROM
            PHYS_INVTY_CTRL PIC
        WHERE
                PIC.GLBL_CMPY_CD                        =    #glblCmpyCd#
            AND PIC.PHYS_INVTY_NUM                      =    #physInvtyNum#
            AND PIC.EZCANCELFLAG                        =    '0'
            AND ROWNUM                                  =    #rownum#
    </statement>
    <statement id="getPIControlsFromPINumer" parameterClass="Map"
        resultClass="Map">
        SELECT
            PIC.PHYS_INVTY_CTRL_PK
        FROM
            PHYS_INVTY_CTRL PIC
        WHERE
                PIC.GLBL_CMPY_CD                        =    #glblCmpyCd#
            AND PIC.PHYS_INVTY_NUM                      =    #physInvtyNum#
            AND PIC.EZCANCELFLAG                        =    '0'
    </statement>
    <statement id="getTechLocInfoFromTechLocation" parameterClass="Map"
        resultClass="Map">
        SELECT
            RS.RTL_WH_CD
            ,RS.RTL_SWH_CD
            ,TL.TECH_LOC_CD
            ,TL.LOC_NM
        FROM
            TECH_LOC TL
            ,RTL_SWH RS
        WHERE
                TL.GLBL_CMPY_CD                         =    #glblCmpyCd#
<!-- START 2018/12/11 T.Ogura [QC#28755,DEL] -->
<!--        AND TL.TECH_TOC_CD                          =    #techTocCd# -->
<!-- END   2018/12/11 T.Ogura [QC#28755,DEL] -->
            AND TL.EFF_FROM_DT                      &lt;=    #salesDate#
            AND NVL(TL.EFF_THRU_DT, '99991231')     &gt;=    #salesDate#
            AND TL.TECH_LOC_CD                          =    RS.INVTY_LOC_CD
            AND TL.GLBL_CMPY_CD                         =    RS.GLBL_CMPY_CD
<!-- START 2018/12/11 T.Ogura [QC#28755,ADD] -->
            AND RS.RTL_WH_CD                            =    #rtlWhCd#
<!-- END   2018/12/11 T.Ogura [QC#28755,ADD] -->
            AND TL.EZCANCELFLAG                         =    '0'
            AND RS.EZCANCELFLAG                         =    '0'
        GROUP BY
            RS.RTL_WH_CD
            ,RS.RTL_SWH_CD
            ,TL.TECH_LOC_CD
            ,TL.LOC_NM
        ORDER BY
            TL.LOC_NM ASC
    </statement>
    <statement id="getTechLocInfoFromPICountHeader" parameterClass="Map"
        resultClass="Map">
        SELECT
            PICH.RTL_WH_CD
            ,PICH.RTL_SWH_CD
            ,TL.TECH_LOC_CD
            ,TL.LOC_NM
        FROM
            PHYS_INVTY_CNT_HDR PICH
            ,TECH_LOC TL
        WHERE
                PICH.GLBL_CMPY_CD                         =    #glblCmpyCd#
<!-- START 2018/12/11 T.Ogura [QC#28755,MOD] -->
<!--        AND PICH.TECH_TOC_CD                          =    #techTocCd# -->
            AND PICH.RTL_WH_CD                            =    #rtlWhCd#
<!-- END   2018/12/11 T.Ogura [QC#28755,MOD] -->
            AND PICH.PHYS_INVTY_CTRL_NM                   =    #physInvtyCtrlNm#
            AND PICH.PHYS_INVTY_DT                        =    #physInvtyDt#
            AND PICH.WH_CD                                =    TL.TECH_LOC_CD
            AND PICH.GLBL_CMPY_CD                         =    TL.GLBL_CMPY_CD
            AND PICH.EZCANCELFLAG                         =    '0'
            AND TL.EZCANCELFLAG                           =    '0'
        GROUP BY
            PICH.RTL_WH_CD
            ,PICH.RTL_SWH_CD
            ,TL.TECH_LOC_CD
            ,TL.LOC_NM
        ORDER BY
            TL.LOC_NM ASC
    </statement>
    <statement id="countSerial" parameterClass="Map" resultClass="Map">
        SELECT
            COUNT(*) AS CNT_SERIAL
        FROM
            PHYS_INVTY_CTRL      PIC
            ,PHYS_INVTY_CNT_HDR  PICH
            ,PHYS_INVTY_CNT_DTL  PICD
        WHERE
                PIC.GLBL_CMPY_CD                        =    #glblCmpyCd#
            AND PIC.PHYS_INVTY_NUM                      =    #physInvtyNum#
            AND PIC.PHYS_INVTY_CTRL_PK                  =    PICH.PHYS_INVTY_CTRL_PK
            AND PIC.GLBL_CMPY_CD                        =    PICH.GLBL_CMPY_CD
            AND PICH.PHYS_INVTY_CNT_HDR_PK              =    PICD.PHYS_INVTY_CNT_HDR_PK
            AND PICH.GLBL_CMPY_CD                       =    PICD.GLBL_CMPY_CD
            AND PICD.MDSE_CD                            =    #mdseCd#
            AND PICD.SER_NUM                            =    #serNum#
            AND PIC.EZCANCELFLAG                        =    '0'
            AND PICH.EZCANCELFLAG                       =    '0'
            AND PICD.EZCANCELFLAG                       =    '0'
    </statement>
    <statement id="countItem" parameterClass="Map"
        resultClass="Map">
        SELECT
            COUNT(*) AS CNT_ITEM
        FROM
            PHYS_INVTY_CTRL      PIC
            ,PHYS_INVTY_CNT_HDR  PICH
        WHERE
                PIC.GLBL_CMPY_CD                        =    #glblCmpyCd#
            AND PIC.PHYS_INVTY_NUM                      =    #physInvtyNum#
            AND PIC.WH_CD                               =    #techLocCd#
            AND PIC.PHYS_INVTY_CTRL_PK                  =    PICH.PHYS_INVTY_CTRL_PK
            AND PIC.GLBL_CMPY_CD                        =    PICH.GLBL_CMPY_CD
            AND PICH.MDSE_CD                            =    #mdseCd#
            AND PIC.EZCANCELFLAG                        =    '0'
            AND PICH.EZCANCELFLAG                       =    '0'
    </statement>
    <statement id="getSerialNumRange" parameterClass="Map"
        resultClass="Map">
        SELECT
            MSNR.LG_SER_NUM
            ,MSNR.FROM_SER_NUM
            ,MSNR.THRU_SER_NUM
        FROM
            MDSE_SER_NUM_RNG      MSNR
        WHERE
                MSNR.GLBL_CMPY_CD                       =    #glblCmpyCd#
            AND MSNR.MDSE_CD                            =    #mdseCd#
            AND MSNR.EZCANCELFLAG                       =    '0'
    </statement>
    <statement id="getMerchandiseName" parameterClass="Map"
        resultClass="Map">
        SELECT
            M.MDSE_CD
            ,M.MDSE_DESC_SHORT_TXT
            ,M.RCV_SER_TAKE_FLG
        FROM
<!-- START 06/16/2020 T.Ogura [QC#56312,MOD] -->
<!--        ALL_MDSE_V      M -->
            MDSE      M
<!-- END   06/16/2020 T.Ogura [QC#56312,MOD] -->
        WHERE
                M.GLBL_CMPY_CD                        =    #glblCmpyCd#
            AND M.MDSE_CD                             =    #mdseCd#
            AND M.EZCANCELFLAG                        =    '0'
    </statement>
    <statement id="getPIControl" parameterClass="Map" resultClass="Map">
        SELECT
            PIC.PHYS_INVTY_CTRL_PK
        FROM
            PHYS_INVTY_CTRL      PIC
        WHERE
                PIC.GLBL_CMPY_CD                        =    #glblCmpyCd#
            AND PIC.PHYS_INVTY_NUM                      =    #physInvtyNum#
            AND PIC.WH_CD                               =    #techLocCd#
            AND PIC.EZCANCELFLAG                        =    '0'
    </statement>
    <statement id="getPICountHeader" parameterClass="Map" resultClass="Map">
        SELECT
            PICH.PHYS_INVTY_CNT_HDR_PK
        FROM
            PHYS_INVTY_CNT_HDR  PICH
        WHERE
                PICH.GLBL_CMPY_CD                       =    #glblCmpyCd#
            AND PICH.PHYS_INVTY_CTRL_PK                 =    #physInvtyCtrlPk#
            AND PICH.MDSE_CD                            =    #mdseCd#
            AND PICH.EZCANCELFLAG                       =    '0'
    </statement>
    <statement id="getPICountDetail" parameterClass="Map" resultClass="Map">
        SELECT
            PICD.PHYS_INVTY_CNT_DTL_PK
        FROM
            PHYS_INVTY_CNT_HDR   PICH
            ,PHYS_INVTY_CNT_DTL  PICD
        WHERE
                PICH.GLBL_CMPY_CD                       =    #glblCmpyCd#
            AND PICH.PHYS_INVTY_CTRL_PK                 =    #physInvtyCtrlPk#
            AND PICH.MDSE_CD                            =    #mdseCd#
            AND PICH.PHYS_INVTY_CNT_HDR_PK              =    PICD.PHYS_INVTY_CNT_HDR_PK
            AND PICH.GLBL_CMPY_CD                       =    PICD.GLBL_CMPY_CD
        <isNotNull property="serNum">
            AND PICD.SER_NUM                            =    #serNum#
        </isNotNull>
            AND PICH.EZCANCELFLAG                       =    '0'
            AND PICD.EZCANCELFLAG                       =    '0'
    </statement>
    <statement id="getInventoryQty" parameterClass="Map" resultClass="Map">
        SELECT
            PICD.PHYS_INVTY_CNT_DTL_PK
            ,PICH.WH_CD
            ,PICH.MDSE_CD
            ,SUM(NVL(I.INVTY_QTY, 0)) AS SUM_INVTY_QTY
        FROM
            PHYS_INVTY_CTRL       PIC
            ,PHYS_INVTY_CNT_HDR   PICH
            ,PHYS_INVTY_CNT_DTL   PICD
            ,INVTY                I
            ,MDSE                 M
        WHERE
                PIC.GLBL_CMPY_CD                        =    #glblCmpyCd#
            AND PIC.PHYS_INVTY_NUM                      =    #physInvtyNum#
            AND PIC.PHYS_INVTY_CTRL_PK                  =    PICH.PHYS_INVTY_CTRL_PK
            AND PIC.GLBL_CMPY_CD                        =    PICH.GLBL_CMPY_CD
            AND PICH.PHYS_INVTY_CNT_HDR_PK              =    PICD.PHYS_INVTY_CNT_HDR_PK
            AND PICH.GLBL_CMPY_CD                       =    PICD.GLBL_CMPY_CD
<!-- START 2018/12/21 T.Ogura [QC#29730,DEL] -->
<!--        AND PICD.ADJ_VAR_FLG                        =    #adjVarFlg# -->
<!-- END   2018/12/21 T.Ogura [QC#29730,DEL] -->
            AND PICH.WH_CD                              =    I.INVTY_LOC_CD(+)
            AND PICH.MDSE_CD                            =    I.MDSE_CD(+)
            AND PICH.GLBL_CMPY_CD                       =    I.GLBL_CMPY_CD(+)
            AND I.LOC_STS_CD(+)                         =    #locStsCd#
            AND I.STK_STS_CD(+)                         =    #stkStsCd#
            AND I.LOC_TP_CD(+)                          =    #locTpCd#
            AND PICH.MDSE_CD                            =    M.MDSE_CD
            AND PICH.GLBL_CMPY_CD                       =    M.GLBL_CMPY_CD
            AND M.RCV_SER_TAKE_FLG                      =    #rcvSerTakeFlg#
            AND PIC.EZCANCELFLAG                        =    '0'
            AND PICH.EZCANCELFLAG                       =    '0'
            AND PICD.EZCANCELFLAG                       =    '0'
            AND I.EZCANCELFLAG(+)                       =    '0'
            AND M.EZCANCELFLAG                          =    '0'
        GROUP BY
            PICD.PHYS_INVTY_CNT_DTL_PK
            ,PICH.WH_CD
            ,PICH.MDSE_CD
    </statement>
    <statement id="getMachineMasterQty" parameterClass="Map"
        resultClass="Map">
        SELECT
            PICD.PHYS_INVTY_CNT_DTL_PK
            ,PICH.WH_CD
            ,PICH.MDSE_CD
            ,CASE
                WHEN SMM.SER_NUM IS NULL THEN 0
                ELSE 1 END AS QTY
        FROM
            PHYS_INVTY_CTRL       PIC
            ,PHYS_INVTY_CNT_HDR   PICH
            ,PHYS_INVTY_CNT_DTL   PICD
            ,SVC_MACH_MSTR        SMM
            ,MDSE                 M
        WHERE
                PIC.GLBL_CMPY_CD                        =    #glblCmpyCd#
            AND PIC.PHYS_INVTY_NUM                      =    #physInvtyNum#
            AND PIC.PHYS_INVTY_CTRL_PK                  =    PICH.PHYS_INVTY_CTRL_PK
            AND PIC.GLBL_CMPY_CD                        =    PICH.GLBL_CMPY_CD
            AND PICH.PHYS_INVTY_CNT_HDR_PK              =    PICD.PHYS_INVTY_CNT_HDR_PK
            AND PICH.GLBL_CMPY_CD                       =    PICD.GLBL_CMPY_CD
<!-- START 2018/12/21 T.Ogura [QC#29730,DEL] -->
<!--        AND PICD.ADJ_VAR_FLG                        =    #adjVarFlg# -->
<!-- END   2018/12/21 T.Ogura [QC#29730,DEL] -->
            AND PICH.WH_CD                              =    SMM.CUR_LOC_NUM(+)
            AND PICH.MDSE_CD                            =    SMM.MDSE_CD(+)
            AND PICD.SER_NUM                            =    SMM.SER_NUM(+)
            AND PICH.GLBL_CMPY_CD                       =    SMM.GLBL_CMPY_CD(+)
            AND SMM.SVC_MACH_MSTR_LOC_STS_CD(+)         =    #locStsCd#
            AND SMM.STK_STS_CD(+)                       =    #stkStsCd#
            <iterate property="svcMachMstrStsCd" var="svcMachMstrStsCd[]" open="AND SMM.SVC_MACH_MSTR_STS_CD(+) IN (" close=")" conjunction=",">
                #svcMachMstrStsCd[]#
            </iterate>
            AND PICH.MDSE_CD                            =    M.MDSE_CD
            AND PICH.GLBL_CMPY_CD                       =    M.GLBL_CMPY_CD
            AND M.RCV_SER_TAKE_FLG                      =    #rcvSerTakeFlg#
            AND PIC.EZCANCELFLAG                        =    '0'
            AND PICH.EZCANCELFLAG                       =    '0'
            AND PICD.EZCANCELFLAG                       =    '0'
            AND SMM.EZCANCELFLAG(+)                     =    '0'
            AND M.EZCANCELFLAG                          =    '0'
    </statement>
    <statement id="getInventoryItem" parameterClass="Map"
        resultClass="Map">
        SELECT
            I.MDSE_CD
            ,I.INVTY_LOC_CD
            ,I.INVTY_QTY
            ,I.STK_STS_CD
            ,PIC.PHYS_INVTY_CTRL_PK
            ,PIC.RTL_WH_CD
            ,PIC.RTL_SWH_CD
        FROM
            PHYS_INVTY_CTRL       PIC
            ,INVTY                I
            ,MDSE                 M
        WHERE
                PIC.GLBL_CMPY_CD                        =    #glblCmpyCd#
            AND PIC.PHYS_INVTY_NUM                      =    #physInvtyNum#
            AND PIC.WH_CD                               =    I.INVTY_LOC_CD
            AND PIC.GLBL_CMPY_CD                        =    I.GLBL_CMPY_CD
            AND I.LOC_STS_CD                            =    #locStsCd#
            AND I.STK_STS_CD                            =    #stkStsCd#
            AND I.LOC_TP_CD                             =    #locTpCd#
            AND I.INVTY_QTY                      &lt;&gt;    #invtyQty#
            AND I.MDSE_CD                               =    M.MDSE_CD
            AND I.GLBL_CMPY_CD                          =    M.GLBL_CMPY_CD
            AND M.RCV_SER_TAKE_FLG                      =    #rcvSerTakeFlg#
            AND PIC.EZCANCELFLAG                        =    '0'
            AND I.EZCANCELFLAG                          =    '0'
            AND M.EZCANCELFLAG                          =    '0'
            AND NOT EXISTS (SELECT
                                1
                            FROM
                                PHYS_INVTY_CNT_HDR    PICH
                            WHERE
                                    PICH.PHYS_INVTY_CTRL_PK   =  PIC.PHYS_INVTY_CTRL_PK
                                AND PICH.GLBL_CMPY_CD         =  PIC.GLBL_CMPY_CD
                                AND PICH.WH_CD                =  I.INVTY_LOC_CD
                                AND PICH.MDSE_CD              =  I.MDSE_CD
                                AND PICH.EZCANCELFLAG         =  '0'
                            )
    </statement>
    <statement id="getMachineMasterItem" parameterClass="Map"
        resultClass="Map">
        SELECT
            SMM.MDSE_CD
            ,SMM.SER_NUM
            ,SMM.CUR_LOC_NUM
            ,1 AS QTY
            ,SMM.STK_STS_CD
            ,PIC.PHYS_INVTY_CTRL_PK
            ,PIC.RTL_WH_CD
            ,PIC.RTL_SWH_CD
        FROM
            PHYS_INVTY_CTRL       PIC
            ,SVC_MACH_MSTR        SMM
            ,MDSE                 M
        WHERE
                PIC.GLBL_CMPY_CD                        =    #glblCmpyCd#
            AND PIC.PHYS_INVTY_NUM                      =    #physInvtyNum#
            AND PIC.WH_CD                               =    SMM.CUR_LOC_NUM
            AND PIC.GLBL_CMPY_CD                        =    SMM.GLBL_CMPY_CD
            AND SMM.SVC_MACH_MSTR_LOC_STS_CD            =    #locStsCd#
            AND SMM.STK_STS_CD                          =    #stkStsCd#
            <iterate property="svcMachMstrStsCd" var="svcMachMstrStsCd[]" open="AND SMM.SVC_MACH_MSTR_STS_CD IN (" close=")" conjunction=",">
                #svcMachMstrStsCd[]#
            </iterate>
            AND SMM.MDSE_CD                             =    M.MDSE_CD
            AND SMM.GLBL_CMPY_CD                        =    M.GLBL_CMPY_CD
            AND M.RCV_SER_TAKE_FLG                      =    #rcvSerTakeFlg#
            AND PIC.EZCANCELFLAG                        =    '0'
            AND SMM.EZCANCELFLAG                        =    '0'
            AND M.EZCANCELFLAG                          =    '0'
            AND NOT EXISTS (SELECT
                                1
                            FROM
                                PHYS_INVTY_CNT_HDR     PICH
                                ,PHYS_INVTY_CNT_DTL    PICD
                            WHERE
                                    PICH.PHYS_INVTY_CTRL_PK      =  PIC.PHYS_INVTY_CTRL_PK
                                AND PICH.GLBL_CMPY_CD            =  PIC.GLBL_CMPY_CD
                                AND PICH.WH_CD                   =  SMM.CUR_LOC_NUM
                                AND PICH.MDSE_CD                 =  SMM.MDSE_CD
                                AND PICD.PHYS_INVTY_CNT_HDR_PK   =  PICH.PHYS_INVTY_CNT_HDR_PK
                                AND PICD.GLBL_CMPY_CD            =  PICH.GLBL_CMPY_CD
                                AND PICD.SER_NUM                 =  SMM.SER_NUM
                                AND PICH.EZCANCELFLAG            =  '0'
                                AND PICD.EZCANCELFLAG            =  '0'
                            )
    </statement>
    <statement id="countVarianceItem" parameterClass="Map"
        resultClass="Map">
        SELECT
            COUNT(*) AS CNT_ADJ_VAR
        FROM
            PHYS_INVTY_CTRL       PIC
            ,PHYS_INVTY_CNT_HDR   PICH
            ,PHYS_INVTY_CNT_DTL   PICD
        WHERE
                PIC.GLBL_CMPY_CD                        =    #glblCmpyCd#
            AND PIC.PHYS_INVTY_NUM                      =    #physInvtyNum#
            AND PIC.PHYS_INVTY_CTRL_PK                  =    PICH.PHYS_INVTY_CTRL_PK
            AND PIC.GLBL_CMPY_CD                        =    PICH.GLBL_CMPY_CD
            AND PICH.PHYS_INVTY_CNT_HDR_PK              =    PICD.PHYS_INVTY_CNT_HDR_PK
            AND PICH.GLBL_CMPY_CD                       =    PICD.GLBL_CMPY_CD
            AND PICD.ADJ_VAR_FLG                        =    #adjVarFlg#
            AND PIC.EZCANCELFLAG                        =    '0'
            AND PICH.EZCANCELFLAG                       =    '0'
            AND PICD.EZCANCELFLAG                       =    '0'
    </statement>
    <statement id="getReCountItem" parameterClass="Map" resultClass="Map">
        SELECT
            PICH.WH_CD
            ,PICH.RTL_WH_CD
            ,PICH.RTL_SWH_CD
            ,PICH.MDSE_CD
            ,M.MDSE_DESC_SHORT_TXT
            ,M.RCV_SER_TAKE_FLG
            ,PICD.LTST_CNT_INP_QTY
            ,PICD.SER_NUM
        FROM
            PHYS_INVTY_CTRL       PIC
            ,PHYS_INVTY_CNT_HDR   PICH
            ,PHYS_INVTY_CNT_DTL   PICD
<!-- START 06/16/2020 T.Ogura [QC#56312,MOD] -->
<!--        ,ALL_MDSE_V           M -->
            ,MDSE                 M
<!-- END   06/16/2020 T.Ogura [QC#56312,MOD] -->
        WHERE
            PIC.GLBL_CMPY_CD                        =    #glblCmpyCd#
        AND PIC.PHYS_INVTY_NUM                      =    #physInvtyNum#
        AND PIC.PHYS_INVTY_CTRL_PK                  =    PICH.PHYS_INVTY_CTRL_PK
        AND PIC.GLBL_CMPY_CD                        =    PICH.GLBL_CMPY_CD
        AND PICH.PHYS_INVTY_CNT_HDR_PK              =    PICD.PHYS_INVTY_CNT_HDR_PK
        AND PICH.GLBL_CMPY_CD                       =    PICD.GLBL_CMPY_CD
        AND PICD.ADJ_VAR_FLG                        =    #adjVarFlg#
        AND PICD.SCD_CNT_INP_TS                     IS   NULL
        AND PICH.MDSE_CD                            =    M.MDSE_CD
        AND PICH.GLBL_CMPY_CD                       =    M.GLBL_CMPY_CD
        AND PIC.EZCANCELFLAG                        =    '0'
        AND PICH.EZCANCELFLAG                       =    '0'
        AND PICD.EZCANCELFLAG                       =    '0'
        AND M.EZCANCELFLAG                          =    '0'
        ORDER BY
            PICH.WH_CD    ASC
            ,PICH.MDSE_CD ASC
    </statement>
    <statement id="getAdditionalItem" parameterClass="Map"
        resultClass="Map">
        WITH
            INVTY_H1 AS (
                SELECT
                    I.MDSE_CD
                FROM
                    RTL_WH RW
                    ,INVTY I
                    ,MDSE  M
                WHERE
                        RW.GLBL_CMPY_CD                         =    #glblCmpyCd#
                    AND RW.TECH_TOC_CD                          =    #techTocCd#
                    AND RW.EFF_FROM_DT                      &lt;=    #salesDate#
                    AND NVL(RW.EFF_THRU_DT, '99991231')     &gt;=    #salesDate#
                    AND RW.DEF_SRC_LOC_CD                       =    I.INVTY_LOC_CD
                    AND RW.GLBL_CMPY_CD                         =    I.GLBL_CMPY_CD
                    AND I.LOC_STS_CD                            =    #locStsCd#
                    AND I.STK_STS_CD                            =    #stkStsCd#
                    AND I.LOC_TP_CD                             =    #locTpCd#
                    AND I.MDSE_CD                               =    M.MDSE_CD
                    AND I.GLBL_CMPY_CD                          =    M.GLBL_CMPY_CD
                    AND M.RCV_SER_TAKE_FLG                      =    #rcvSerTakeFlg#
                    AND RW.EZCANCELFLAG                         =    '0'
                    AND I.EZCANCELFLAG                          =    '0'
                    AND M.EZCANCELFLAG                          =    '0'
                    AND NOT EXISTS (SELECT
                                        1
                                    FROM
                                        PHYS_INVTY_CNT_HDR    PICH
                                        ,PHYS_INVTY_CTRL      PIC
                                    WHERE
                                            PICH.MDSE_CD              =  I.MDSE_CD
                                        AND PICH.GLBL_CMPY_CD         =  I.GLBL_CMPY_CD
                                        AND PICH.PHYS_INVTY_CTRL_PK   =  PIC.PHYS_INVTY_CTRL_PK
                                        AND PICH.GLBL_CMPY_CD         =  PIC.GLBL_CMPY_CD
                                        AND PIC.PHYS_INVTY_NUM        =  #physInvtyNum#
                                        AND PICH.EZCANCELFLAG         =  '0'
                                        AND PIC.EZCANCELFLAG          =  '0'
                                    )
                GROUP BY
                    I.MDSE_CD
        ),
            INVTY_H2 AS (
                SELECT
                    H1.MDSE_CD
                    ,ROUND(DBMS_RANDOM.VALUE(0,99999),0) AS RND
                FROM
                    INVTY_H1 H1
        ),
            INVTY_H3 AS (
                SELECT
                    H2.MDSE_CD
                    ,H2.RND
                    ,ROW_NUMBER() OVER (ORDER BY H2.RND, H2.MDSE_CD DESC) RNUM
                FROM
                    INVTY_H2 H2
        )
        SELECT
            H3.MDSE_CD
        FROM
            INVTY_H3 H3
        WHERE
            H3.RNUM     &lt;=  2
    </statement>
    <statement id="getReCountWH" parameterClass="Map"
        resultClass="Map">
        SELECT
            PIC.PHYS_INVTY_CTRL_PK
            ,PIC.WH_CD
            ,PIC.RTL_WH_CD
            ,PIC.RTL_SWH_CD
        FROM
            PHYS_INVTY_CTRL       PIC
            ,PHYS_INVTY_CNT_HDR   PICH
        WHERE
                PIC.GLBL_CMPY_CD                        =    #glblCmpyCd#
            AND PIC.PHYS_INVTY_NUM                      =    #physInvtyNum#
            AND PIC.PHYS_INVTY_CTRL_PK                  =    PICH.PHYS_INVTY_CTRL_PK
            AND PIC.GLBL_CMPY_CD                        =    PICH.GLBL_CMPY_CD
            AND PICH.ADJ_VAR_FLG                        =    #adjVarFlg#
            AND PIC.EZCANCELFLAG                        =    '0'
            AND PICH.EZCANCELFLAG                       =    '0'
            AND ROWNUM                                  =    1
    </statement>
<!-- START 2018/12/03 T.Ogura [QC#27978,DEL] -->
<!--    <statement id="getPhysicalInventoryStatusName" parameterClass="Map" -->
<!--        resultClass="Map"> -->
<!--        SELECT -->
<!--            PIS.PHYS_INVTY_STS_DESC_TXT -->
<!--        FROM -->
<!--            PHYS_INVTY_STS PIS -->
<!--        WHERE -->
<!--                PIS.GLBL_CMPY_CD               =  #glblCmpyCd# -->
<!--            AND PIS.PHYS_INVTY_STS_CD          =  #physInvtyStsCd# -->
<!--            AND PIS.EZCANCELFLAG               =  '0' -->
<!--    </statement> -->
<!-- END   2018/12/03 T.Ogura [QC#27978,DEL] -->
    <statement id="getCountingQty" parameterClass="Map"
        resultClass="Map">
        SELECT
            PICD.PHYS_INVTY_CNT_HDR_PK
            ,SUM(PICD.FIRST_CNT_INP_QTY) AS SUM_FIRST_CNT_INP_QTY
            ,MAX(PICD.FIRST_CNT_INP_TS) AS MAX_FIRST_CNT_INP_TS
            ,SUM(PICD.SCD_CNT_INP_QTY) AS SUM_SCD_CNT_INP_QTY
            ,MAX(PICD.SCD_CNT_INP_TS) AS MAX_SCD_CNT_INP_TS
            ,SUM(PICD.INVTY_AVAL_QTY) AS SUM_INVTY_AVAL_QTY
            ,MAX(PICD.INVTY_REGD_TS) AS MAX_INVTY_REGD_TS
            ,SUM(PICD.ADJ_VAR_QTY) AS SUM_ADJ_VAR_QTY
            ,SUM(CASE WHEN PICD.ADJ_VAR_FLG = #adjVarFlg# THEN 1 ELSE 0 END) AS CNT_ADJ_VAR_FLG_Y
            ,SUM(PICD.ADJ_VAR_AMT) AS SUM_ADJ_VAR_AMT
        FROM
            PHYS_INVTY_CTRL       PIC
            ,PHYS_INVTY_CNT_HDR   PICH
            ,PHYS_INVTY_CNT_DTL   PICD
        WHERE
                PIC.GLBL_CMPY_CD                        =    #glblCmpyCd#
            AND PIC.PHYS_INVTY_NUM                      =    #physInvtyNum#
            AND PIC.PHYS_INVTY_CTRL_PK                  =    PICH.PHYS_INVTY_CTRL_PK
            AND PIC.GLBL_CMPY_CD                        =    PICH.GLBL_CMPY_CD
            AND PICH.PHYS_INVTY_CNT_HDR_PK              =    PICD.PHYS_INVTY_CNT_HDR_PK
            AND PICH.GLBL_CMPY_CD                       =    PICD.GLBL_CMPY_CD
            AND PIC.EZCANCELFLAG                        =    '0'
            AND PICH.EZCANCELFLAG                       =    '0'
            AND PICD.EZCANCELFLAG                       =    '0'
        GROUP BY
            PICD.PHYS_INVTY_CNT_HDR_PK
    </statement>
<!-- START 2018/12/11 T.Ogura [QC#28755,ADD] -->
    <statement id="getReCountNotInputCntDtl" parameterClass="Map"
        resultClass="Map">
        SELECT
            PICD.PHYS_INVTY_CNT_DTL_PK
        FROM
            PHYS_INVTY_CTRL       PIC
            ,PHYS_INVTY_CNT_HDR   PICH
            ,PHYS_INVTY_CNT_DTL   PICD
        WHERE
                PIC.GLBL_CMPY_CD                        =    #glblCmpyCd#
            AND PIC.PHYS_INVTY_NUM                      =    #physInvtyNum#
            AND PIC.PHYS_INVTY_CTRL_PK                  =    PICH.PHYS_INVTY_CTRL_PK
            AND PIC.GLBL_CMPY_CD                        =    PICH.GLBL_CMPY_CD
            AND PICH.PHYS_INVTY_CNT_HDR_PK              =    PICD.PHYS_INVTY_CNT_HDR_PK
            AND PICH.GLBL_CMPY_CD                       =    PICD.GLBL_CMPY_CD
            AND PICD.ADJ_VAR_FLG                        =    #adjVarFlg#
            AND PICD.INVTY_AVAL_QTY                     =    0
            AND PICD.SCD_CNT_INP_QTY                    IS NULL
            AND PIC.EZCANCELFLAG                        =    '0'
            AND PICH.EZCANCELFLAG                       =    '0'
            AND PICD.EZCANCELFLAG                       =    '0'
    </statement>
<!-- END   2018/12/11 T.Ogura [QC#28755,ADD] -->

    <!-- QC#50029 -->
    <statement id="adjustmentPiCount" parameterClass="Map" resultClass="Map">
         SELECT
              PICH.PHYS_INVTY_CTRL_PK
             ,PICH.PHYS_INVTY_ADJ_NM
             ,PICH.MDSE_CD
             ,PICH.RTL_WH_CD
             ,PICH.WH_CD
             ,PICH.PHYS_INVTY_CNT_HDR_PK
             ,PICH.STK_STS_CD
             ,PIC.PHYS_INVTY_STS_CD
             ,PIC.PHYS_INVTY_STS_NM
             ,PICD.PHYS_INVTY_CNT_DTL_PK
             ,PICD.SER_NUM
             ,PICD.ADJ_VAR_QTY
             ,PICD.ADJ_VAR_AMT
             ,PICD.SVC_CONFIG_MSTR_PK
             ,M.MDSE_CD AS MSTR_MDSE_CD
             ,M.RCV_SER_TAKE_FLG
         FROM
             PHYS_INVTY_CTRL      PIC
             ,PHYS_INVTY_CNT_HDR  PICH
             ,PHYS_INVTY_CNT_DTL  PICD
             ,INVTY               I
             ,MDSE                M
         WHERE
         -- JOIN TO PHYS_INVTY_CTRL
             PIC.GLBL_CMPY_CD             = #GLBL_CMPY_CD#
         AND PIC.PHYS_INVTY_NUM           = #PHYS_INVTY_NUM#
         -- JOIN TO PHYS_INVTY_CNT_HDR
         AND PIC.GLBL_CMPY_CD             = PICH.GLBL_CMPY_CD
         AND PIC.PHYS_INVTY_CTRL_PK       = PICH.PHYS_INVTY_CTRL_PK
         -- JOIN TO PHYS_INVTY_CNT_DTL
         AND PICH.GLBL_CMPY_CD            = PICD.GLBL_CMPY_CD
         AND PICH.PHYS_INVTY_CNT_HDR_PK   = PICD.PHYS_INVTY_CNT_HDR_PK
         AND PICD.ADJ_VAR_FLG             = #FLG_ON_Y#
         -- JOIN TO INVTY
         AND PIC.GLBL_CMPY_CD             = I.GLBL_CMPY_CD(+)
         AND PIC.WH_CD                    = I.INVTY_LOC_CD(+)
         AND PICH.MDSE_CD                 = I.MDSE_CD(+)
         AND PICH.STK_STS_CD              = I.STK_STS_CD(+)
         AND I.LOC_STS_CD(+)              = #DC_STOCK#
         -- JOIN TO MDSE
         AND PICH.GLBL_CMPY_CD            = M.GLBL_CMPY_CD(+)
         AND PICH.MDSE_CD                 = M.MDSE_CD(+)
         AND PIC.EZCANCELFLAG             = '0'
         AND PICH.EZCANCELFLAG            = '0'
         AND PICD.EZCANCELFLAG            = '0'
         AND I.EZCANCELFLAG(+)            = '0'
         AND M.EZCANCELFLAG(+)            = '0'
         ORDER BY
             PICD.ADJ_VAR_QTY ASC
             ,PICD.SER_NUM ASC
             ,PICH.WH_CD ASC
             ,PICH.MDSE_CD ASC
             ,PICH.STK_STS_CD ASC
    </statement>

    <!-- QC#50029 -->
    <statement id="summaryPICountHeader" parameterClass="Map" resultClass="Map">
         SELECT
             PICH.PHYS_INVTY_CNT_HDR_PK
             ,NVL(PICD.SUB_TOT_ADJ_VAR_QTY, 0) AS SUB_TOT_ADJ_VAR_QTY
             ,NVL(PICD.SUB_TOT_ADJ_VAR_AMT, 0) AS SUB_TOT_ADJ_VAR_AMT
         FROM
             PHYS_INVTY_CTRL      PIC
             ,PHYS_INVTY_CNT_HDR  PICH
             ,(
                 SELECT
                     D.PHYS_INVTY_CNT_HDR_PK
                     ,SUM(NVL(D.ADJ_VAR_QTY,0)) AS SUB_TOT_ADJ_VAR_QTY
                     ,SUM(NVL(D.ADJ_VAR_AMT,0)) AS SUB_TOT_ADJ_VAR_AMT
                 FROM
                     PHYS_INVTY_CNT_DTL  D
                 WHERE
                         D.GLBL_CMPY_CD                   = #GLBL_CMPY_CD#
                     AND D.PHYS_INVTY_ADJ_STS_CD   &lt;&gt; #PHYS_INVTY_ADJ_STS_CD#
                     AND D.EZCANCELFLAG                   = '0'
                 GROUP BY
                     D.PHYS_INVTY_CNT_HDR_PK
               ) PICD
         WHERE
         -- JOIN TO PHYS_INVTY_CTRL
             PIC.GLBL_CMPY_CD                    = #GLBL_CMPY_CD#
         AND PIC.PHYS_INVTY_NUM                  = #PHYS_INVTY_NUM#
         -- JOIN TO PHYS_INVTY_CNT_HDR
         AND PIC.GLBL_CMPY_CD                    = PICH.GLBL_CMPY_CD
         AND PIC.PHYS_INVTY_CTRL_PK              = PICH.PHYS_INVTY_CTRL_PK
         -- JOIN TO PHYS_INVTY_CNT_DTL
         AND PICH.PHYS_INVTY_CNT_HDR_PK          = PICD.PHYS_INVTY_CNT_HDR_PK(+)
         AND PIC.EZCANCELFLAG                    = '0'
         AND PICH.EZCANCELFLAG                   = '0'
    </statement>

    <!-- QC#50029 -->
    <statement id="summaryPIControl" parameterClass="Map" resultClass="Map">
         SELECT
             PIC.PHYS_INVTY_CTRL_PK
             ,SUM(NVL(ABS(PICD.ADJ_VAR_AMT),0)) AS TOT_ADJ_VAR_GRS_AMT
             ,SUM(NVL(PICD.ADJ_VAR_AMT,0)) AS TOT_ADJ_VAR_NET_AMT
         FROM
             PHYS_INVTY_CTRL PIC
             ,PHYS_INVTY_CNT_DTL PICD
         WHERE
         -- JOIN TO PHYS_INVTY_CTRL
             PIC.GLBL_CMPY_CD       = #GLBL_CMPY_CD#
         AND PIC.PHYS_INVTY_NUM     = #PHYS_INVTY_NUM#
         -- JOIN TO PHYS_INVTY_CNT_HDR
         AND PIC.GLBL_CMPY_CD       = PICD.GLBL_CMPY_CD(+)
         AND PIC.PHYS_INVTY_CTRL_PK = PICD.PHYS_INVTY_CTRL_PK(+)
         AND PICD.PHYS_INVTY_ADJ_STS_CD   &lt;&gt; #PHYS_INVTY_ADJ_STS_CD#
         AND PIC.EZCANCELFLAG       = '0'
         AND PICD.EZCANCELFLAG(+)   = '0'
         GROUP BY
            PIC.PHYS_INVTY_CTRL_PK
    </statement>
</sqlMap>