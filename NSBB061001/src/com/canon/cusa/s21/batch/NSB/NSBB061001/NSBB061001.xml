<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSBB061001">
    <statement id="getInputData" parameterClass="Map" resultClass="Map">
        WITH
            TIER_RG AS(
                SELECT
                    OHSD.ORG_TIER_CD
                FROM
                     STRU_DFN          SDF
                    ,ORG_HRCH_STRU_DFN OHSD
                WHERE
                        SDF.GLBL_CMPY_CD     = #glblCmpyCd#
                    AND SDF.RG_FLG           = 'Y'
                    AND SDF.GLBL_CMPY_CD     = OHSD.GLBL_CMPY_CD
                    AND SDF.STRU_DFN_CD      = OHSD.STRU_DFN_CD
                    AND OHSD.BIZ_AREA_ORG_CD = #bizAreaOrgCd_service#
                    AND SDF.EZCANCELFLAG     = '0'
                    AND OHSD.EZCANCELFLAG    = '0'
                    AND OHSD.EFF_FROM_DT               &lt;= #slsDt#
                    AND NVL(OHSD.EFF_THRU_DT, #slsDt#) &gt;= #slsDt#
                    AND ROWNUM               = 1
            )
            ,TIER_BR AS(
                SELECT
                    OHSD.ORG_TIER_CD
                FROM
                     STRU_DFN          SDF
                    ,ORG_HRCH_STRU_DFN OHSD
                WHERE
                        SDF.GLBL_CMPY_CD     = #glblCmpyCd#
                    AND SDF.BR_FLG           = 'Y'
                    AND SDF.GLBL_CMPY_CD     = OHSD.GLBL_CMPY_CD
                    AND SDF.STRU_DFN_CD      = OHSD.STRU_DFN_CD
                    AND OHSD.BIZ_AREA_ORG_CD = #bizAreaOrgCd_service#
                    AND SDF.EZCANCELFLAG     = '0'
                    AND OHSD.EZCANCELFLAG    = '0'
                    AND OHSD.EFF_FROM_DT               &lt;= #slsDt#
                    AND NVL(OHSD.EFF_THRU_DT, #slsDt#) &gt;= #slsDt#
                    AND ROWNUM               = 1
            )
            ,TIER_REP AS(
                SELECT
                    OHSD.ORG_TIER_CD
                FROM
                     STRU_DFN          SDF
                    ,ORG_HRCH_STRU_DFN OHSD
                WHERE
                        SDF.GLBL_CMPY_CD     = #glblCmpyCd#
                    AND SDF.REP_FLG           = 'Y'
                    AND SDF.GLBL_CMPY_CD     = OHSD.GLBL_CMPY_CD
                    AND SDF.STRU_DFN_CD      = OHSD.STRU_DFN_CD
                    AND OHSD.BIZ_AREA_ORG_CD = #bizAreaOrgCd_service#
                    AND SDF.EZCANCELFLAG     = '0'
                    AND OHSD.EZCANCELFLAG    = '0'
                    AND OHSD.EFF_FROM_DT               &lt;= #slsDt#
                    AND NVL(OHSD.EFF_THRU_DT, #slsDt#) &gt;= #slsDt#
                    AND ROWNUM               = 1
            )
            ,VISIT AS (
                SELECT
                     VISIT.GLBL_CMPY_CD
                    ,VISIT.FSR_NUM
                    ,VISIT.FSR_VISIT_NUM
                    ,VISIT.SVC_TASK_NUM
                    ,VISIT.TECH_CD
                    ,VISIT.FSR_VISIT_ARV_DT
                    ,VISIT.FSR_VISIT_ARV_TM
                    ,VISIT.SVC_TRVL_TM_NUM
                    ,FSR.SER_NUM
                    ,FSR.FSR_CLO_DT
                FROM
                     FSR         FSR
                    ,FSR_VISIT   VISIT
                WHERE
                        FSR.GLBL_CMPY_CD    = #glblCmpyCd#
                    AND FSR.FSR_STS_CD      = #fsrStsCd_closed#
                    AND FSR.EZUPTIME        &gt; TO_CHAR(TO_TIMESTAMP(ADD_MONTHS(LAST_DAY(TO_DATE(#slsDt#, 'YYYYMMDD')), #addMonth#)), 'YYYYMMDDHH24MISSFF3')
                    AND FSR.EZUPTIME        &lt; TO_CHAR(TO_TIMESTAMP(TO_DATE(#slsDt#, 'YYYYMMDD') + 1), 'YYYYMMDDHH24MISSFF3')
                    AND VISIT.GLBL_CMPY_CD  = FSR.GLBL_CMPY_CD
                    AND VISIT.FSR_NUM       = FSR.FSR_NUM
                    AND FSR.EZCANCELFLAG    = '0'
                    AND VISIT.EZCANCELFLAG  = '0'
            )
        SELECT
             VISIT.FSR_NUM                                                 AS FSR_NUM
            ,VISIT.TECH_CD                                                 AS TECH_CD
            ,CASE WHEN TIER_RG.ORG_TIER_CD = #orgTierCd_0#  THEN ORG.FIRST_ORG_CD
                  WHEN TIER_RG.ORG_TIER_CD = #orgTierCd_1#  THEN ORG.SCD_ORG_CD
                  WHEN TIER_RG.ORG_TIER_CD = #orgTierCd_2#  THEN ORG.THIRD_ORG_CD
                  WHEN TIER_RG.ORG_TIER_CD = #orgTierCd_3#  THEN ORG.FRTH_ORG_CD
                  WHEN TIER_RG.ORG_TIER_CD = #orgTierCd_4#  THEN ORG.FIFTH_ORG_CD
                  WHEN TIER_RG.ORG_TIER_CD = #orgTierCd_5#  THEN ORG.SIXTH_ORG_CD
                  WHEN TIER_RG.ORG_TIER_CD = #orgTierCd_6#  THEN ORG.SVNTH_ORG_CD
                  WHEN TIER_RG.ORG_TIER_CD = #orgTierCd_7#  THEN ORG.EIGHTH_ORG_CD
                  WHEN TIER_RG.ORG_TIER_CD = #orgTierCd_8#  THEN ORG.NINTH_ORG_CD
                  WHEN TIER_RG.ORG_TIER_CD = #orgTierCd_9#  THEN ORG.TENTH_ORG_CD
                  WHEN TIER_RG.ORG_TIER_CD = #orgTierCd_10# THEN ORG.ELVTH_ORG_CD
             END                                                           AS FRTH_ORG_CD
            ,CASE WHEN TIER_BR.ORG_TIER_CD = #orgTierCd_0#  THEN ORG.FIRST_ORG_CD
                  WHEN TIER_BR.ORG_TIER_CD = #orgTierCd_1#  THEN ORG.SCD_ORG_CD
                  WHEN TIER_BR.ORG_TIER_CD = #orgTierCd_2#  THEN ORG.THIRD_ORG_CD
                  WHEN TIER_BR.ORG_TIER_CD = #orgTierCd_3#  THEN ORG.FRTH_ORG_CD
                  WHEN TIER_BR.ORG_TIER_CD = #orgTierCd_4#  THEN ORG.FIFTH_ORG_CD
                  WHEN TIER_BR.ORG_TIER_CD = #orgTierCd_5#  THEN ORG.SIXTH_ORG_CD
                  WHEN TIER_BR.ORG_TIER_CD = #orgTierCd_6#  THEN ORG.SVNTH_ORG_CD
                  WHEN TIER_BR.ORG_TIER_CD = #orgTierCd_7#  THEN ORG.EIGHTH_ORG_CD
                  WHEN TIER_BR.ORG_TIER_CD = #orgTierCd_8#  THEN ORG.NINTH_ORG_CD
                  WHEN TIER_BR.ORG_TIER_CD = #orgTierCd_9#  THEN ORG.TENTH_ORG_CD
                  WHEN TIER_BR.ORG_TIER_CD = #orgTierCd_10# THEN ORG.ELVTH_ORG_CD
             END                                                           AS SIXTH_ORG_CD
            ,'1'                                                           AS FILL_1_TXT_01
            ,'1'                                                           AS FILL_1_TXT_02
            ,CASE WHEN TIER_REP.ORG_TIER_CD = #orgTierCd_0#  THEN ORG.FIRST_ORG_CD
                  WHEN TIER_REP.ORG_TIER_CD = #orgTierCd_1#  THEN ORG.SCD_ORG_CD
                  WHEN TIER_REP.ORG_TIER_CD = #orgTierCd_2#  THEN ORG.THIRD_ORG_CD
                  WHEN TIER_REP.ORG_TIER_CD = #orgTierCd_3#  THEN ORG.FRTH_ORG_CD
                  WHEN TIER_REP.ORG_TIER_CD = #orgTierCd_4#  THEN ORG.FIFTH_ORG_CD
                  WHEN TIER_REP.ORG_TIER_CD = #orgTierCd_5#  THEN ORG.SIXTH_ORG_CD
                  WHEN TIER_REP.ORG_TIER_CD = #orgTierCd_6#  THEN ORG.SVNTH_ORG_CD
                  WHEN TIER_REP.ORG_TIER_CD = #orgTierCd_7#  THEN ORG.EIGHTH_ORG_CD
                  WHEN TIER_REP.ORG_TIER_CD = #orgTierCd_8#  THEN ORG.NINTH_ORG_CD
                  WHEN TIER_REP.ORG_TIER_CD = #orgTierCd_9#  THEN ORG.TENTH_ORG_CD
                  WHEN TIER_REP.ORG_TIER_CD = #orgTierCd_10# THEN ORG.ELVTH_ORG_CD
             END                                                           AS SVNTH_ORG_CD
            ,VISIT.FSR_VISIT_ARV_DT                                        AS FSR_VISIT_ARV_DT
            ,''                                                            AS FILL_2_TXT_01
            ,''                                                            AS FILL_2_TXT_02
            ,TO_CHAR(CASE WHEN TRUNC(VISIT.SVC_TRVL_TM_NUM / #minPerHour_60#) &gt; #maxHour_99# THEN #maxHour_99#
                          ELSE TRUNC(VISIT.SVC_TRVL_TM_NUM / #minPerHour_60#)
                     END)                                                  AS INTFC_TRVL_HRS
            ,TO_CHAR(MOD(VISIT.SVC_TRVL_TM_NUM, #minPerHour_60#))          AS INTFC_TRVL_MN
            ,''                                                            AS INTFC_TRVL_DST_NUM
            ,TASK.MDL_GRP_NM                                               AS MDL_GRP_NM
            ,VISIT.SER_NUM                                                 AS SER_NUM
            ,MACH.SVC_CONFIG_MSTR_PK                                       AS SVC_CONFIG_MSTR_PK
            ,(
                SELECT
                     DISTINCT FIRST_VALUE(CONTDTL.CONTR_EFF_FROM_DT)
                         OVER(ORDER BY CONTDTL.CONTR_EFF_THRU_DT DESC
                        ,CONTDTL.CONTR_EFF_FROM_DT) F_DATE_VAL
                FROM
                     VISIT
                    ,DS_CONTR_DTL       CONTDTL
                    ,DS_CONTR_DTL_STS_V DTLSTS
                    ,DS_CONTR           CONTR
                WHERE
                        CONTDTL.GLBL_CMPY_CD             = VISIT.GLBL_CMPY_CD
                    AND CONTDTL.CONTR_EFF_FROM_DT        &lt;= VISIT.FSR_CLO_DT
                    AND (
                            (CONTDTL.CONTR_CLO_DT        &gt;= VISIT.FSR_CLO_DT)
                         OR (CONTDTL.CONTR_CLO_DT IS NULL AND NVL(CONTDTL.CONTR_EFF_THRU_DT, #slsDt#) &gt;= VISIT.FSR_CLO_DT)
                        )
                    AND CONTDTL.SVC_MACH_MSTR_PK         = MACH.SVC_MACH_MSTR_PK
                    AND DTLSTS.GLBL_CMPY_CD              = CONTDTL.GLBL_CMPY_CD
                    AND DTLSTS.DS_CONTR_DTL_PK           = CONTDTL.DS_CONTR_DTL_PK
                    <iterate property="dsContrCtrlStsCdList" var="dsContrCtrlSts[]" open="AND DTLSTS.DS_CONTR_CTRL_STS_CD NOT IN (" close=")" conjunction=",">
                        #dsContrCtrlSts[]#
                    </iterate>
                    AND CONTR.GLBL_CMPY_CD               = CONTDTL.GLBL_CMPY_CD
                    AND CONTR.DS_CONTR_PK                = CONTDTL.DS_CONTR_PK
                    AND CONTR.DS_CONTR_CATG_CD           &lt;&gt; #dsCntrCatgCd_warranty#
                    AND CONTDTL.EZCANCELFLAG             = '0'
                    AND DTLSTS.EZCANCELFLAG              = '0'
                    AND CONTR.EZCANCELFLAG               = '0'
                )                                                          AS CONTR_EFF_FROM_DT
            ,#omalDataType_A#                                              AS FILL_1_TXT_03
            ,''                                                            AS SVC_TEAM_MGR_PSN_CD
            ,TASK.SVC_TRTY_MGR_PSN_CD                                      AS SVC_TRTY_MGR_PSN_CD
            ,TASK.SVC_BR_MGR_PSN_CD                                        AS SVC_BR_MGR_PSN_CD
            ,''                                                            AS MGR_PSN_CD
            ,SUBSTR(VISIT.FSR_VISIT_ARV_TM, 1          , #strLen_2#)       AS INTFC_ARV_HRS
            ,SUBSTR(VISIT.FSR_VISIT_ARV_TM, #strFrom_3#, #strLen_2#)       AS INTFC_ARV_MN
            ,MAX_ARV_DT.FSR_VISIT_ARV_DT                                   AS LAST_VISIT_FSR_VISIT_ARV_DT
        FROM
             VISIT
            ,TIER_RG
            ,TIER_BR
            ,TIER_REP
            ,SVC_MACH_MSTR      MACH
            ,SVC_CONFIG_MSTR    CONFIG
            ,SVC_TASK           TASK
            ,ORG_FUNC_ASG       ORGASG
            ,S21_ORG            ORG
            ,(
                SELECT
                     GLBL_CMPY_CD
                    ,FSR_NUM
                    ,MAX(FSR_VISIT_ARV_DT) AS FSR_VISIT_ARV_DT
                FROM
                    VISIT
                GROUP BY
                     GLBL_CMPY_CD
                    ,FSR_NUM
            ) MAX_ARV_DT
        WHERE
                TASK.GLBL_CMPY_CD           = VISIT.GLBL_CMPY_CD
            AND TASK.FSR_NUM                = VISIT.FSR_NUM
            AND TASK.SVC_TASK_NUM           = VISIT.SVC_TASK_NUM
            AND MACH.GLBL_CMPY_CD           = TASK.GLBL_CMPY_CD
            AND MACH.SVC_MACH_MSTR_PK       = TASK.SVC_MACH_MSTR_PK
            AND CONFIG.GLBL_CMPY_CD         = MACH.GLBL_CMPY_CD
            AND CONFIG.SVC_MACH_MSTR_PK     = MACH.SVC_MACH_MSTR_PK
            AND ORGASG.GLBL_CMPY_CD(+)      = VISIT.GLBL_CMPY_CD
            AND ORGASG.PSN_CD(+)            = VISIT.TECH_CD
            AND ORG.GLBL_CMPY_CD(+)         = ORGASG.GLBL_CMPY_CD
            AND ORG.TOC_CD(+)               = ORGASG.TOC_CD
            AND MAX_ARV_DT.GLBL_CMPY_CD     = VISIT.GLBL_CMPY_CD
            AND MAX_ARV_DT.FSR_NUM          = VISIT.FSR_NUM
            AND TASK.EZCANCELFLAG           = '0'
            AND MACH.EZCANCELFLAG           = '0'
            AND CONFIG.EZCANCELFLAG         = '0'
            AND ORGASG.EZCANCELFLAG(+)      = '0'
            AND ORG.EZCANCELFLAG(+)         = '0'
        ORDER BY
             VISIT.FSR_NUM          ASC
            ,VISIT.TECH_CD          ASC
            ,VISIT.FSR_VISIT_ARV_DT ASC
            ,VISIT.FSR_VISIT_ARV_TM ASC
    </statement>
</sqlMap>
