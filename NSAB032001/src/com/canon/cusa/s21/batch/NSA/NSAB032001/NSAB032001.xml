<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSAB032001">
    <statement id="getBaseChrgRegFlt" parameterClass="Map" resultClass="Map">
        SELECT
             A.DS_CONTR_DTL_PK
            ,A.BLLG_SCHD_FROM_DT
            ,A.BLLG_SCHD_THRU_DT
            ,A.NEXT_BLLG_DT
            ,A.RVS_SCHD_DT
            ,B.DS_CONTR_SCHD_EST_FLG
            ,D.DS_CONTR_CATG_CD
            ,D.DS_CONTR_NUM
        FROM
             DS_CONTR_BLLG_SCHD         A
            ,DS_BLLG_SCHD_TP            B
            ,DS_CONTR_DTL               C
            ,DS_CONTR                   D
        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            AND A.EZCANCELFLAG          = '0'
            AND A.BLLBL_FLG             = 'Y'
            AND A.BASE_CHRG_FLG         = 'Y'
            AND A.BLLG_CALC_FLG         = 'N'
            AND A.BLLG_STAGE_FLG        = 'Y'
            AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
            AND A.DS_BLLG_SCHD_TP_CD    = B.DS_BLLG_SCHD_TP_CD
            AND B.EZCANCELFLAG          = '0'
            AND A.GLBL_CMPY_CD          = C.GLBL_CMPY_CD
            AND A.DS_CONTR_DTL_PK       = C.DS_CONTR_DTL_PK
            AND C.EZCANCELFLAG          = '0'
            AND C.GLBL_CMPY_CD          = D.GLBL_CMPY_CD
            AND C.DS_CONTR_PK           = D.DS_CONTR_PK
            AND D.EZCANCELFLAG          = '0'
            AND D.DS_CONTR_CATG_CD      IN
            <iterate property="dsContrCatgCd" var="dsContrCatgCd[]"  open="(" close=" )" conjunction=",">
             #dsContrCatgCd[]#
            </iterate>
            AND EXISTS(
                <!-- START 2018/07/24 T.Wada [QC#27263, MOD] -->
                <!--
                    SELECT
                        *
                    FROM
                        DUAL
                    WHERE
                        MOD(
                            NVL(
                                (SELECT
                                     E.SELL_TO_CUST_PK
                                 FROM
                                     SELL_TO_CUST E
                                 WHERE
                                     E.EZCANCELFLAG    = '0'
                                 AND E.GLBL_CMPY_CD    = D.GLBL_CMPY_CD
                                 AND E.SELL_TO_CUST_CD = D.DS_ACCT_NUM)
                            ,0)
                        ,#multiCnt#) = $usrVar1$
                 -->
                    SELECT
                        1
                    FROM
                        SELL_TO_CUST E
                    WHERE
                        E.EZCANCELFLAG    = '0'
                    AND E.GLBL_CMPY_CD    = D.GLBL_CMPY_CD
                    AND E.SELL_TO_CUST_CD = D.DS_ACCT_NUM
                    AND MOD(NVL(E.SELL_TO_CUST_PK,0),#multiCnt#) = #usrVar1#
                <!-- END 2018/07/24 T.Wada [QC#27263, MOD] -->
                )
        ORDER BY
             D.DS_CONTR_NUM
            ,A.DS_CONTR_DTL_PK
            ,NVL(A.RVS_SCHD_DT, A.NEXT_BLLG_DT) 
    </statement>
    <statement id="getBaseChrgAgg" parameterClass="Map" resultClass="Map">
        SELECT
             A.DS_CONTR_DTL_PK
            ,A.BLLG_SCHD_FROM_DT
            ,A.BLLG_SCHD_THRU_DT
            ,A.NEXT_BLLG_DT
            ,A.RVS_SCHD_DT
            ,B.DS_CONTR_SCHD_EST_FLG
            ,D.DS_CONTR_CATG_CD
            ,D.DS_CONTR_NUM
        FROM
             DS_CONTR_BLLG_SCHD         A
            ,DS_BLLG_SCHD_TP            B
            ,DS_CONTR_DTL               C
            ,DS_CONTR                   D
        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            AND A.EZCANCELFLAG          = '0'
            AND EXISTS (
                    SELECT
                        *
                    FROM
                        DS_CONTR_BLLG_SCHD   X
                    WHERE
                            X.GLBL_CMPY_CD          = A.GLBL_CMPY_CD
                        AND X.EZCANCELFLAG          = '0'
                        AND X.DS_CONTR_DTL_PK       = A.DS_CONTR_DTL_PK
                        AND X.BLLBL_FLG             = 'Y'
                        AND X.BASE_CHRG_FLG         = 'Y'
                        AND X.BLLG_CALC_FLG         = 'N'
                        AND X.BLLG_STAGE_FLG        = 'Y'
                )
            AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
            AND A.DS_BLLG_SCHD_TP_CD    = B.DS_BLLG_SCHD_TP_CD
            AND B.EZCANCELFLAG          = '0'
            AND A.GLBL_CMPY_CD          = C.GLBL_CMPY_CD
            AND A.DS_CONTR_DTL_PK       = C.DS_CONTR_DTL_PK
            AND C.EZCANCELFLAG          = '0'
            AND C.GLBL_CMPY_CD          = D.GLBL_CMPY_CD
            AND C.DS_CONTR_PK           = D.DS_CONTR_PK
            AND D.EZCANCELFLAG          = '0'
            AND D.DS_CONTR_CATG_CD      = #dsContrCatgCd#
            AND EXISTS(
                <!-- START 2018/07/24 T.Wada [QC#27263, MOD] -->
                <!--
                    SELECT
                        *
                    FROM
                        DUAL
                    WHERE
                        MOD(
                            NVL(
                                (SELECT
                                     E.SELL_TO_CUST_PK
                                 FROM
                                     SELL_TO_CUST E
                                 WHERE
                                     E.EZCANCELFLAG    = '0'
                                 AND E.GLBL_CMPY_CD    = D.GLBL_CMPY_CD
                                 AND E.SELL_TO_CUST_CD = D.DS_ACCT_NUM)
                            ,0)
                        ,#multiCnt#) = $usrVar1$
                 -->
                    SELECT
                        1
                    FROM
                        SELL_TO_CUST E
                    WHERE
                        E.EZCANCELFLAG    = '0'
                    AND E.GLBL_CMPY_CD    = D.GLBL_CMPY_CD
                    AND E.SELL_TO_CUST_CD = D.DS_ACCT_NUM
                    AND MOD(NVL(E.SELL_TO_CUST_PK,0),#multiCnt#) = #usrVar1#
                <!-- END 2018/07/24 T.Wada [QC#27263, MOD] -->
                )
        ORDER BY
             D.DS_CONTR_NUM
            ,A.DS_CONTR_DTL_PK
            ,NVL(A.RVS_SCHD_DT, A.NEXT_BLLG_DT) 
    </statement>

    <statement id="getUsageChrgReg" parameterClass="Map" resultClass="Map">
        SELECT
             DISTINCT
             A.DS_CONTR_DTL_PK
            ,A.PRNT_DS_CONTR_DTL_PK
            ,A.BLLG_SCHD_FROM_DT
            ,A.BLLG_SCHD_THRU_DT
            ,A.NEXT_BLLG_DT
            ,A.RVS_SCHD_DT
            ,A.SVC_PHYS_MTR_READ_GRP_SQ
            ,B.DS_CONTR_SCHD_EST_FLG
            ,C.SVC_MACH_MSTR_PK
            ,D.DS_CONTR_CATG_CD
            ,D.DS_CONTR_NUM
            ,D.DS_CONTR_PK
        FROM
             DS_CONTR_BLLG_SCHD         A
            ,DS_BLLG_SCHD_TP            B
            ,DS_CONTR_DTL               C
            ,DS_CONTR                   D
        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            AND A.EZCANCELFLAG          = '0'
            AND A.BLLBL_FLG             = 'Y'
            AND A.USG_CHRG_FLG          = 'Y'
            AND A.BLLG_CALC_FLG         = 'N'
            AND A.BLLG_STAGE_FLG        = 'Y'
            <!-- START 2019/05/20 K.Kitachi [QC#50357, ADD] -->
            AND A.SVC_PHYS_MTR_READ_GRP_SQ IS NOT NULL
            <!-- END 2019/05/20 K.Kitachi [QC#50357, ADD] -->
            AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
            AND A.DS_BLLG_SCHD_TP_CD    = B.DS_BLLG_SCHD_TP_CD
            AND B.EZCANCELFLAG          = '0'
            AND A.GLBL_CMPY_CD          = C.GLBL_CMPY_CD
            AND A.DS_CONTR_DTL_PK       = C.DS_CONTR_DTL_PK
            AND C.EZCANCELFLAG          = '0'
            AND C.GLBL_CMPY_CD          = D.GLBL_CMPY_CD
            AND C.DS_CONTR_PK           = D.DS_CONTR_PK
            AND D.EZCANCELFLAG          = '0'
            AND D.DS_CONTR_CATG_CD      = #dsContrCatgCd#
            AND EXISTS(
                <!-- START 2018/07/24 T.Wada [QC#27263, MOD] -->
                <!--
                    SELECT
                        *
                    FROM
                        DUAL
                    WHERE
                        MOD(
                            NVL(
                                (SELECT
                                     E.SELL_TO_CUST_PK
                                 FROM
                                     SELL_TO_CUST E
                                 WHERE
                                     E.EZCANCELFLAG    = '0'
                                 AND E.GLBL_CMPY_CD    = D.GLBL_CMPY_CD
                                 AND E.SELL_TO_CUST_CD = D.DS_ACCT_NUM)
                            ,0)
                        ,#multiCnt#) = $usrVar1$
                 -->
                    SELECT
                        1
                    FROM
                        SELL_TO_CUST E
                    WHERE
                        E.EZCANCELFLAG    = '0'
                    AND E.GLBL_CMPY_CD    = D.GLBL_CMPY_CD
                    AND E.SELL_TO_CUST_CD = D.DS_ACCT_NUM
                    AND MOD(NVL(E.SELL_TO_CUST_PK,0),#multiCnt#) = #usrVar1#
                <!-- END 2018/07/24 T.Wada [QC#27263, MOD] -->
                )
        ORDER BY
             D.DS_CONTR_NUM
            ,A.DS_CONTR_DTL_PK
            ,NVL(A.RVS_SCHD_DT, A.NEXT_BLLG_DT) 
    </statement>
    <statement id="getUsageChrgFltAgg" parameterClass="Map" resultClass="Map">
        SELECT
             A.DS_CONTR_DTL_PK
            ,A.DS_CONTR_BLLG_SCHD_PK
            ,A.BLLG_SCHD_THRU_DT
            <!-- add start 2019/11/14 QC#54401 -->
            ,A.NEXT_BLLG_DT
            <!-- add end 2019/11/14 QC#54401 -->
            ,C.DS_CONTR_PK
            ,C.DS_CONTR_NUM
        FROM
             DS_CONTR_BLLG_SCHD         A
            ,DS_CONTR_DTL               B
            ,DS_CONTR                   C
        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            AND A.EZCANCELFLAG          = '0'
            AND A.BLLBL_FLG             = 'Y'
            AND A.USG_CHRG_FLG          = 'Y'
            AND A.BLLG_CALC_FLG         = 'N'
            AND A.BLLG_STAGE_FLG        = 'Y'
            AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
            AND A.DS_CONTR_DTL_PK       = B.DS_CONTR_DTL_PK
            AND B.DS_CONTR_DTL_TP_CD    = #dsContrDtlTpCd#
            AND B.EZCANCELFLAG          = '0'
            AND B.GLBL_CMPY_CD          = C.GLBL_CMPY_CD
            AND B.DS_CONTR_PK           = C.DS_CONTR_PK
            AND C.EZCANCELFLAG          = '0'
            AND C.DS_CONTR_CATG_CD      = #dsContrCatgCd#
            AND EXISTS(
                <!-- START 2018/07/24 T.Wada [QC#27263, MOD] -->
                <!--
                    SELECT
                        *
                    FROM
                        DUAL
                    WHERE
                        MOD(
                            NVL(
                                (SELECT
                                     E.SELL_TO_CUST_PK
                                 FROM
                                     SELL_TO_CUST E
                                 WHERE
                                     E.EZCANCELFLAG    = '0'
                                 AND E.GLBL_CMPY_CD    = C.GLBL_CMPY_CD
                                 AND E.SELL_TO_CUST_CD = C.DS_ACCT_NUM)
                            ,0)
                        ,#multiCnt#) = $usrVar1$
                 -->
                    SELECT
                        1
                    FROM
                        SELL_TO_CUST E
                    WHERE
                        E.EZCANCELFLAG    = '0'
                    AND E.GLBL_CMPY_CD    = C.GLBL_CMPY_CD
                    AND E.SELL_TO_CUST_CD = C.DS_ACCT_NUM
                    AND MOD(NVL(E.SELL_TO_CUST_PK,0),#multiCnt#) = #usrVar1#
                <!-- END 2018/07/24 T.Wada [QC#27263, MOD] -->
                )
        GROUP BY
             C.DS_CONTR_PK
            ,C.DS_CONTR_NUM
            ,A.DS_CONTR_BLLG_SCHD_PK
            ,A.DS_CONTR_DTL_PK
            ,A.BLLG_SCHD_THRU_DT 
            <!-- add start 2019/11/14 QC#54401 -->
            ,A.NEXT_BLLG_DT
            <!-- add end 2019/11/14 QC#54401 -->
        ORDER BY
             C.DS_CONTR_PK
            ,A.DS_CONTR_DTL_PK
            ,A.BLLG_SCHD_THRU_DT
    </statement>
    <statement id="getNotEntryCntReg" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            COUNT(*)   AS  NOT_ENTRY_CNT
        FROM (
            SELECT
                NVL(A.RVS_SCHD_DT, A.NEXT_BLLG_DT)  AS  NEXT_BLLG_DT
            FROM
                DS_CONTR_BLLG_SCHD      A
            WHERE
                    A.GLBL_CMPY_CD          = #glblCmpyCd#
                AND A.EZCANCELFLAG          = '0'
                AND A.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                AND A.USG_CHRG_FLG          = 'Y'
                AND A.MTR_ENTRY_CPLT_FLG    = 'N'
            ) AA
        WHERE
            AA.NEXT_BLLG_DT     = #nextBllgDt#
    </statement>
    <statement id="getNotEntryCntFltAgg" parameterClass="Map" resultClass="BigDecimal">
    <!-- mod start 2019/11/14 QC#54401 -->
        SELECT
            COUNT(*)   AS  NOT_ENTRY_CNT
        FROM 
            DS_CONTR_BLLG_SCHD      A
        WHERE
                A.GLBL_CMPY_CD               = #glblCmpyCd#
            AND A.EZCANCELFLAG               = '0'
            AND A.DS_CONTR_DTL_PK            IN (
                SELECT
                    X.DS_CONTR_DTL_PK
                FROM
                    DS_CONTR_DTL                        X
                WHERE
                        X.GLBL_CMPY_CD      = A.GLBL_CMPY_CD
                    AND X.EZCANCELFLAG      = '0'
                    AND X.DS_CONTR_PK       = #dsContrPk#
                    AND X.DS_CONTR_DTL_TP_CD NOT IN (#agg#, #fleet#)
            )
            AND A.USG_CHRG_FLG               = 'Y'
            AND A.MTR_ENTRY_CPLT_FLG         = 'N'
            AND A.NEXT_BLLG_DT               = #nextBllgDt#
    <!-- mod end 2019/11/14 QC#54401 -->
    </statement>
</sqlMap>
