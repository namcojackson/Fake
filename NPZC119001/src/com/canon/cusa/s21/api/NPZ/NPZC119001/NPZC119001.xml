<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NPZC119001">
    <statement id="getRtlWh" parameterClass="Map" resultClass="Map">
        SELECT
             RWH.TECH_TOC_CD              AS TECH_TOC_CD
            ,RWH.DEF_SRC_RTL_WH_CD       AS DEF_SRC_RTL_WH_CD
            ,RWH.DEF_SRC_RTL_SWH_CD      AS DEF_SRC_RTL_SWH_CD
            ,RWH.DEF_RTRN_TO_RTL_WH_CD   AS DEF_RTRN_TO_RTL_WH_CD
            ,RWH.DEF_RTRN_TO_RTL_SWH_CD  AS DEF_RTRN_TO_RTL_SWH_CD
        FROM
             RTL_WH   RWH
        WHERE
                RWH.GLBL_CMPY_CD   =  #glblCmpyCd#
            AND RWH.RTL_WH_CD      =  #rtlWhCd#
            AND RWH.EZCANCELFLAG   =  '0'
    </statement>

    <statement id="getSO" parameterClass="Map" resultClass="Map">
            SELECT
                PRD.PRCH_REQ_NUM            AS PRCH_REQ_NUM
                ,PRD.PRCH_REQ_LINE_NUM      AS PRCH_REQ_LINE_NUM
                ,PRD.PRCH_REQ_LINE_SUB_NUM  AS PRCH_REQ_LINE_SUB_NUM
                ,SOD.SO_NUM                 AS SO_NUM
                ,SOD.SO_SLP_NUM             AS SO_SLP_NUM
                ,SOD.MDSE_CD                AS MDSE_CD
                ,SOD.FROM_STK_STS_CD        AS FROM_STK_STS_CD
                ,SOD.RQST_ORD_QTY           AS RQST_ORD_QTY
                ,SOD.INVTY_LOC_CD           AS INVTY_LOC_CD
            FROM
                PRCH_REQ_DTL      PRD
                ,SHPG_ORD_DTL     SOD
            WHERE
                    PRD.GLBL_CMPY_CD           = #glblCmpyCd#
                AND PRD.PRCH_REQ_NUM           = #prchReqNum#
                AND PRD.PRCH_REQ_LINE_NUM      = #prchReqLineNum#
                AND PRD.PRCH_REQ_LINE_SUB_NUM  = #prchReqLineSubNum#
                AND PRD.GLBL_CMPY_CD           = SOD.GLBL_CMPY_CD
                AND PRD.SO_NUM                 = SOD.SO_NUM
<!-- add start 2016/11/18 CSA Defect#16029 --> 
                AND PRD.PRCH_REQ_NUM           = SOD.PRCH_REQ_NUM
                AND PRD.PRCH_REQ_LINE_NUM      = SOD.PRCH_REQ_LINE_NUM
                AND PRD.PRCH_REQ_LINE_SUB_NUM  = SOD.PRCH_REQ_LINE_SUB_NUM
<!-- add end 2016/11/18 CSA Defect#16029 --> 
                AND PRD.EZCANCELFLAG           =  '0'
                AND SOD.EZCANCELFLAG           =  '0'
            ORDER BY
<!-- mod start 2016/11/18 CSA Defect#16029 --> 
                 SO_NUM
                ,SO_SLP_NUM
                ,PRCH_REQ_NUM
                ,PRCH_REQ_LINE_NUM
                ,PRCH_REQ_LINE_SUB_NUM
<!-- mod end 2016/11/18 CSA Defect#16029 --> 
    </statement>
    <statement id="getPRNum" parameterClass="Map" resultClass="Map">
        SELECT
            DISTINCT PRD.PRCH_REQ_NUM AS PRCH_REQ_NUM
        FROM
            PRCH_REQ_DTL PRD
        WHERE
                PRD.GLBL_CMPY_CD = #glblCmpyCd#
            AND PRD.SO_NUM       = #soNum#
            AND PRD.EZCANCELFLAG = '0'
        ORDER BY
            PRCH_REQ_NUM
    </statement>
    <statement id="getPrchReqLineNum" parameterClass="Map" resultClass="Map">
        SELECT
            PRCH_REQ_LINE_NUM
            ,PRCH_REQ_LINE_SUB_NUM
        FROM
            (SELECT
                PRD.PRCH_REQ_LINE_NUM
                ,PRD.PRCH_REQ_LINE_SUB_NUM
            FROM
                PRCH_REQ_DTL PRD
            WHERE
                    PRD.GLBL_CMPY_CD      = #glblCmpyCd#
                AND PRD.PRCH_REQ_NUM      = #prchReqNum#
                AND PRD.MDSE_CD           = #mdseCd#
                AND PRD.PRCH_REQ_QTY - NVL(PRD.RWS_PUT_AWAY_QTY, 0)   &gt; 0
                AND PRD.PRCH_REQ_LINE_STS_CD  &lt;&gt; #stsCancelled#
                AND PRD.EZCANCELFLAG      = '0'
            ORDER BY
                PRD.PRCH_REQ_LINE_NUM
                ,PRD.PRCH_REQ_LINE_SUB_NUM
            )
        WHERE ROWNUM = 1
    </statement>
    <statement id="getClickPrtRtrnRqstList" parameterClass="Map" resultClass="Map">
        SELECT
             CPRR.RQST_TECH_TOC_CD
            ,CPRR.SRC_RTL_WH_CD
            ,CPRR.SRC_RTL_SWH_CD
            ,CPRR.INVTY_LOC_CD
            ,CPRR.PRCH_REQ_INVTY_TP_TXT
            ,CPRR.MDSE_CD
            ,CPRR.PRCH_REQ_QTY
            ,CPRR.PRCH_REQ_SHORT_QTY
            ,CPRR.PRCH_REQ_LINE_CMNT_TXT
            ,CPRR.CLICK_KEY_DTL_TXT
            ,CPRR.PRCH_REQ_LINE_NUM
            ,CPRR.PRCH_REQ_LINE_SUB_NUM
        FROM
            CLICK_PRT_RTRN_RQST CPRR
        WHERE
                CPRR.GLBL_CMPY_CD         = #glblCmpyCd#
            AND CPRR.PRCH_REQ_NUM         = #prchReqNum#
            AND CPRR.PRCH_REQ_LINE_NUM    = #prchReqLineNum#
            AND CPRR.PRCH_REQ_LINE_SUB_NUM = #prchReqLineSubNum#
            AND CPRR.PRCH_REQ_STS_TXT     = #prchReqStsTxt#
            AND CPRR.EZCANCELFLAG         = '0'
        ORDER BY
            CPRR.CLICK_PRT_RTRN_RQST_PK
    </statement>
<!-- QC#58518 Add Start -->
    <statement id="getClickPrtRtrnRqstListForAwatingShipment" parameterClass="Map" resultClass="Map">
        SELECT
            CPRR.RQST_TECH_TOC_CD
            ,CPRR.SRC_RTL_WH_CD
            ,CPRR.SRC_RTL_SWH_CD
            ,CPRR.INVTY_LOC_CD
            ,CPRR.PRCH_REQ_INVTY_TP_TXT
            ,CPRR.MDSE_CD
            ,CPRR.PRCH_REQ_QTY
            ,CPRR.PRCH_REQ_SHORT_QTY
            ,CPRR.PRCH_REQ_LINE_CMNT_TXT
            ,CPRR.CLICK_KEY_DTL_TXT
            ,CPRR.PRCH_REQ_LINE_NUM
            ,CPRR.PRCH_REQ_LINE_SUB_NUM
        FROM
            (
            SELECT
                *
            FROM
                CLICK_PRT_RTRN_RQST
            WHERE
                    GLBL_CMPY_CD         = #glblCmpyCd#
                AND PRCH_REQ_NUM         = #prchReqNum#
                AND PRCH_REQ_LINE_NUM    = #prchReqLineNum#
                AND PRCH_REQ_LINE_SUB_NUM = #prchReqLineSubNum#
                AND PRCH_REQ_STS_TXT     = #prchReqStsTxt#
                AND EZCANCELFLAG         = '0'
            ORDER BY
                PRT_RTRN_RQST_SQ DESC
            ) CPRR
        WHERE ROWNUM = 1
    </statement>
<!-- QC#58518 Add End -->
    <statement id="getParentPrchReqDtl" parameterClass="Map" resultClass="Map">
        SELECT
             A.PRCH_REQ_NUM            AS PRCH_REQ_NUM
            ,A.PRCH_REQ_LINE_NUM       AS PRCH_REQ_LINE_NUM
            ,A.PRCH_REQ_LINE_SUB_NUM   AS PRCH_REQ_LINE_SUB_NUM
            ,B.PRCH_REQ_LINE_STS_CD    AS PRCH_REQ_LINE_STS_CD
            ,B.SHIP_QTY                AS SHIP_QTY
            ,B.PRCH_REQ_LINE_TP_CD     AS PRCH_REQ_LINE_TP_CD
            ,B.SRC_INVTY_LOC_CD        AS SRC_INVTY_LOC_CD
            ,B.MDSE_CD                 AS MDSE_CD
            ,CASE WHEN B.BACK_TO_TECH_QTY = 0
                THEN B.PRCH_REQ_QTY - B.PRCH_REQ_CANC_QTY - B.RWS_PUT_AWAY_QTY
                ELSE B.BACK_TO_TECH_QTY
             END                       AS BACK_TO_TECH_QTY
            ,B.PRCH_REQ_LINE_CMNT_TXT  AS PRCH_REQ_LINE_CMNT_TXT
        FROM
             (
                SELECT
                     A1.GLBL_CMPY_CD
                    ,A1.PRCH_REQ_NUM
                    ,A1.PRCH_REQ_LINE_NUM
                    ,MIN(A1.PRCH_REQ_LINE_SUB_NUM) AS PRCH_REQ_LINE_SUB_NUM
                FROM
                    PRCH_REQ_DTL A1
                WHERE
                    A1.GLBL_CMPY_CD = #glblCmpyCd#
                AND A1.PRCH_REQ_NUM = #prchReqNum#
                AND A1.EZCANCELFLAG = '0'
                GROUP BY
                     A1.GLBL_CMPY_CD
                    ,A1.PRCH_REQ_NUM
                    ,A1.PRCH_REQ_LINE_NUM
             ) A
            ,PRCH_REQ_DTL B
        WHERE
            A.GLBL_CMPY_CD          =  B.GLBL_CMPY_CD
        AND A.PRCH_REQ_NUM          =  B.PRCH_REQ_NUM
        AND A.PRCH_REQ_LINE_NUM     =  B.PRCH_REQ_LINE_NUM
        AND A.PRCH_REQ_LINE_SUB_NUM =  B.PRCH_REQ_LINE_SUB_NUM
        AND B.EZCANCELFLAG          =  '0'
        AND B.PRCH_REQ_LINE_TP_CD   &lt;&gt; #prchReqLineTpCd#
        ORDER BY
             A.PRCH_REQ_NUM
            ,A.PRCH_REQ_LINE_NUM
            ,A.PRCH_REQ_LINE_SUB_NUM
    </statement>
    <statement id="getChildPrchReqDtl" parameterClass="Map" resultClass="Map">
        SELECT
             A.PRCH_REQ_NUM            AS PRCH_REQ_NUM
            ,A.PRCH_REQ_LINE_NUM       AS PRCH_REQ_LINE_NUM
            ,A.PRCH_REQ_LINE_SUB_NUM   AS PRCH_REQ_LINE_SUB_NUM
            ,B.PRCH_REQ_LINE_STS_CD    AS PRCH_REQ_LINE_STS_CD
            ,B.SHIP_QTY                AS SHIP_QTY
            ,B.PRCH_REQ_LINE_TP_CD     AS PRCH_REQ_LINE_TP_CD
            ,B.SRC_INVTY_LOC_CD        AS SRC_INVTY_LOC_CD
            ,B.MDSE_CD                 AS MDSE_CD
            ,CASE WHEN B.BACK_TO_TECH_QTY = 0
                THEN B.PRCH_REQ_QTY - B.PRCH_REQ_CANC_QTY - B.RWS_PUT_AWAY_QTY
                ELSE B.BACK_TO_TECH_QTY
             END                       AS BACK_TO_TECH_QTY
            ,B.PRCH_REQ_LINE_CMNT_TXT  AS PRCH_REQ_LINE_CMNT_TXT
        FROM
             (
                SELECT
                     A1.GLBL_CMPY_CD
                    ,A1.PRCH_REQ_NUM
                    ,A1.PRCH_REQ_LINE_NUM
                    ,MAX(A1.PRCH_REQ_LINE_SUB_NUM) AS PRCH_REQ_LINE_SUB_NUM
                FROM
                    PRCH_REQ_DTL A1
                WHERE
                    A1.GLBL_CMPY_CD      = #glblCmpyCd#
                AND A1.PRCH_REQ_NUM      = #prchReqNum#
                AND A1.PRCH_REQ_LINE_NUM = #prchReqLineNum#
                AND A1.EZCANCELFLAG = '0'
                GROUP BY
                     A1.GLBL_CMPY_CD
                    ,A1.PRCH_REQ_NUM
                    ,A1.PRCH_REQ_LINE_NUM
             ) A
            ,PRCH_REQ_DTL B
        WHERE
            A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
        AND A.PRCH_REQ_NUM          = B.PRCH_REQ_NUM
        AND A.PRCH_REQ_LINE_NUM     = B.PRCH_REQ_LINE_NUM
        AND A.PRCH_REQ_LINE_SUB_NUM = B.PRCH_REQ_LINE_SUB_NUM
        AND B.EZCANCELFLAG          = '0'
        AND B.PRCH_REQ_LINE_TP_CD   = #prchReqLineTpCd#
        ORDER BY
             A.PRCH_REQ_NUM
            ,A.PRCH_REQ_LINE_NUM
            ,A.PRCH_REQ_LINE_SUB_NUM
    </statement>

    <!-- QC#21913 Modify RTRN_PRO_NUM_LIST => SHPG_ORD_PRO_NUM_LIST -->
    <statement id="getStrProNum" parameterClass="Map" resultClass="String">
        SELECT
            SOPNL.PRO_NUM
        FROM
            SHPG_ORD_PRO_NUM_LIST SOPNL
            ,PRCH_REQ_DTL PRD
        WHERE
            PRD.GLBL_CMPY_CD = #glblCmpyCd#
        AND PRD.PRCH_REQ_NUM = #prchReqNum#
        AND PRD.EZCANCELFLAG = '0'
        AND SOPNL.GLBL_CMPY_CD = PRD.GLBL_CMPY_CD
        AND SOPNL.TRX_HDR_NUM  = PRD.SO_NUM
        AND SOPNL.EZCANCELFLAG = '0'
        <!-- mod start 2022/03/14 QC#59780 -->
        <!-- <iterate property="strProNumList" var="strProNum[]" open="AND SOPNL.PRO_NUM IN (" close=")" conjunction=","> -->
        <!--     #strProNum[]# -->
        <!-- </iterate> -->
        AND SOPNL.PRO_NUM      = #strProNum#
        <!-- mod end 2022/03/14 QC#59780 -->
        ORDER BY
             SOPNL.PRO_CRAT_DT_TM_TS
    </statement>
    
        <statement id="getSoList" parameterClass="Map" resultClass="String">
            SELECT DISTINCT
                SO.SO_NUM                 AS SO_NUM
            FROM
                 PRCH_REQ_DTL                PRD
                ,SHPG_ORD                    SO
            WHERE
                    PRD.GLBL_CMPY_CD      = #glblCmpyCd#
                AND PRD.PRCH_REQ_NUM      = #prchReqNum#
                <iterate property="prchReqLineTpList" var="prchReqLineTp[]" open="AND PRD.PRCH_REQ_LINE_TP_CD IN (" close=")" conjunction=",">
                    #prchReqLineTp[]#
                </iterate>
                AND PRD.GLBL_CMPY_CD      = SO.GLBL_CMPY_CD
                AND PRD.SO_NUM            = SO.SO_NUM
                AND PRD.EZCANCELFLAG      =  '0'
                AND SO.EZCANCELFLAG       =  '0'
            ORDER BY
                 SO_NUM
    </statement>
</sqlMap>
