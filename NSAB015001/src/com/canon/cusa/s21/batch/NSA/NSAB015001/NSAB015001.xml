<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSAB015001">
<statement id="divEstCalcTrgt" parameterClass="Map" resultClass="Map">
<!-- START 2018/02/23 M.Kidokoro [QC#23317,DEL] -->
<!-- SELECT -->
<!--     SMM.SVC_MACH_MSTR_PK -->
<!-- ,   SMM.SER_NUM -->
<!-- ,   DCR.DS_CONTR_PK -->
<!-- ,   DCR.DS_CONTR_NUM -->
<!-- ,   DCD.DS_CONTR_DTL_PK -->
<!-- ,   MOD(SMM.SVC_MACH_MSTR_PK, #parProcTotTaskCnt#)  AS  PAR_PROC_TASK_NUM -->
<!-- FROM -->
<!--     SVC_MACH_MSTR       SMM -->
<!-- ,   DS_CONTR_DTL        DCD -->
<!-- ,   DS_CONTR_DTL_TP     DDT -->
<!-- ,   DS_CONTR            DCR -->
<!-- ,   DS_CONTR_STS_V      DCS -->
<!-- ,   SVC_CONTR_BR        SCB -->
<!-- WHERE -->
<!--     SMM.GLBL_CMPY_CD                =   #glblCmpyCd# -->
<!-- AND SMM.EZCANCELFLAG                =   '0' -->
<!-- AND DCD.SVC_MACH_MSTR_PK            =   SMM.SVC_MACH_MSTR_PK -->
<!-- AND DCD.GLBL_CMPY_CD                =   SMM.GLBL_CMPY_CD -->
<!-- AND DCD.EZCANCELFLAG                =   SMM.EZCANCELFLAG -->
<!-- AND DDT.DS_CONTR_DTL_TP_CD          =   DCD.DS_CONTR_DTL_TP_CD -->
<!-- AND DDT.GLBL_CMPY_CD                =   DCD.GLBL_CMPY_CD -->
<!-- AND DDT.MAIN_UNIT_LINE_FLG          =   'Y' -->
<!-- AND DDT.EZCANCELFLAG                =   DCD.EZCANCELFLAG -->
<!-- AND DCR.DS_CONTR_PK                 =   DCD.DS_CONTR_PK -->
<!-- AND DCR.GLBL_CMPY_CD                =   DCD.GLBL_CMPY_CD -->
<!-- AND DCR.EZCANCELFLAG                =   DCD.EZCANCELFLAG -->
<!-- START 2017/06/02 N.Arai [QC#18297, MOD] -->
<!-- AND DCR.MTR_EST_TP_CD               =   #mtrEstTpCd# -->
<!-- END 2017/06/02 N.Arai [QC#18297, MOD] -->
<!-- AND DCR.GLBL_CMPY_CD                =   DCS.GLBL_CMPY_CD -->
<!-- AND DCR.DS_CONTR_PK                 =   DCS.DS_CONTR_PK -->
<!-- AND DCS.EZCANCELFLAG                =   '0' -->
<!-- AND DCS.MTR_EST_AVAL_FLG            =   'Y' -->
<!-- AND SCB.SVC_CONTR_BR_CD             =   DCR.SVC_CONTR_BR_CD -->
<!-- AND SCB.GLBL_CMPY_CD                =   DCR.GLBL_CMPY_CD -->
<!-- AND SCB.SVC_CONTR_BR_AUTO_EST_FLG   =   'Y' -->
<!-- AND SCB.EZCANCELFLAG                =   DCR.EZCANCELFLAG -->
<!-- AND EXISTS ( -->
<!--     SELECT -->
<!--         * -->
<!--     FROM -->
<!--         DS_CONTR_BLLG_SCHD  CBS -->
<!--     WHERE -->
<!--         CBS.DS_CONTR_DTL_PK         =   DCD.DS_CONTR_DTL_PK -->
<!--     AND CBS.GLBL_CMPY_CD            =   DCD.GLBL_CMPY_CD -->
<!--     AND CBS.USG_CHRG_FLG            =   'Y' -->
<!--     AND CBS.MTR_ENTRY_CPLT_FLG      =   'N' -->
<!--     AND CBS.NEXT_BLLG_DT            &lt;    #slsDt# -->
<!--     AND CBS.EZCANCELFLAG            =   DCD.EZCANCELFLAG -->
<!-- ) -->
<!-- END 2018/02/23 M.Kidokoro [QC#23317,DEL] -->
<!-- START 2018/02/23 M.Kidokoro [QC#23317,ADD] -->
WITH MAIN AS(
        SELECT
            SMM.SVC_MACH_MSTR_PK
        ,   SMM.SER_NUM
        ,   DCR.DS_CONTR_PK
        ,   DCR.DS_CONTR_NUM
        ,   DCD.DS_CONTR_DTL_PK
        FROM
            SVC_MACH_MSTR       SMM
        ,   DS_CONTR_DTL        DCD
        ,   DS_CONTR_DTL_STS_V  DCDS
        ,   DS_CONTR_DTL_TP     DDT
        ,   DS_CONTR            DCR
        ,   DS_CONTR_STS_V      DCS
        ,   SVC_CONTR_BR        SCB
        WHERE
            SMM.GLBL_CMPY_CD                =   #glblCmpyCd#
        AND SMM.EZCANCELFLAG                =   '0'
        AND DCD.SVC_MACH_MSTR_PK            =   SMM.SVC_MACH_MSTR_PK
        AND DCD.GLBL_CMPY_CD                =   SMM.GLBL_CMPY_CD
        AND DCD.EZCANCELFLAG                =   SMM.EZCANCELFLAG
        AND DCDS.DS_CONTR_DTL_PK            =   DCD.DS_CONTR_DTL_PK
        AND DCDS.GLBL_CMPY_CD               =   DCD.GLBL_CMPY_CD
        AND DCDS.MTR_EST_AVAL_FLG           =   'Y'
        AND DCDS.EZCANCELFLAG               =   DCD.EZCANCELFLAG
        AND DDT.DS_CONTR_DTL_TP_CD          =   DCD.DS_CONTR_DTL_TP_CD
        AND DDT.GLBL_CMPY_CD                =   DCD.GLBL_CMPY_CD
        AND DDT.MAIN_UNIT_LINE_FLG          =   'Y'
        AND DDT.EZCANCELFLAG                =   DCD.EZCANCELFLAG
        AND DCR.DS_CONTR_PK                 =   DCD.DS_CONTR_PK
        AND DCR.GLBL_CMPY_CD                =   DCD.GLBL_CMPY_CD
        AND DCR.EZCANCELFLAG                =   DCD.EZCANCELFLAG
        <!-- START 2022/08/12 N.Takatsu [QC#60186, MOD] -->
        <!--AND DCR.MTR_EST_TP_CD                                       =   #mtrEstTpCd#-->
        <isNotNull property="endOfCurrentMonth">
        AND NVL(DCR.MTR_EST_TP_CD, #endOfCurrentMonth#)                 =   #mtrEstTpCd#
        </isNotNull>
        <isNull property="endOfCurrentMonth">
        AND DCR.MTR_EST_TP_CD                                           =   #mtrEstTpCd#
        </isNull>
        <!-- END 2022/08/12 N.Takatsu [QC#60186, MOD] -->
        AND DCR.GLBL_CMPY_CD                =   DCS.GLBL_CMPY_CD
        AND DCR.DS_CONTR_PK                 =   DCS.DS_CONTR_PK
        AND DCS.EZCANCELFLAG                =   '0'
        AND DCS.MTR_EST_AVAL_FLG            =   'Y'
        AND SCB.SVC_CONTR_BR_CD             =   DCR.SVC_CONTR_BR_CD
        AND SCB.GLBL_CMPY_CD                =   DCR.GLBL_CMPY_CD
        AND SCB.SVC_CONTR_BR_AUTO_EST_FLG   =   'Y'
        AND SCB.EZCANCELFLAG                =   DCR.EZCANCELFLAG
        AND EXISTS (
            SELECT
                *
            FROM
                DS_CONTR_BLLG_SCHD  CBS
            WHERE
                CBS.DS_CONTR_DTL_PK         =   DCD.DS_CONTR_DTL_PK
            AND CBS.GLBL_CMPY_CD            =   DCD.GLBL_CMPY_CD
            AND CBS.USG_CHRG_FLG            =   'Y'
            AND CBS.MTR_ENTRY_CPLT_FLG      =   'N'
            <!-- mod start 2018/08/27 QC#27553 -->
            <!-- AND CBS.NEXT_BLLG_DT        &lt;=   #slsDt# -->
            AND CBS.BLLG_SCHD_THRU_DT   &lt;=   #slsDt#
            <!-- mod end 2018/08/27 QC#27553 -->
            <!-- START 2023/02/03 E.Sanchez [QC#61138, ADD] -->
            AND CBS.SKIP_RECOV_TP_CD &lt;&gt;   #skipRecovTpCd#
            <!-- END 2023/02/03 E.Sanchez [QC#61138, ADD] -->
            AND CBS.EZCANCELFLAG            =   DCD.EZCANCELFLAG
        )
)
, CONTR AS(
    SELECT
        DS_CONTR_PK
    ,   ROWNUM       AS ROW_NUM
    FROM (
        SELECT
            DS_CONTR_PK
        ,   COUNT(*) AS CNT
        FROM
            MAIN
        GROUP BY
            DS_CONTR_PK
        ORDER BY
           CNT
        ,  DS_CONTR_PK
    ) 
)
SELECT 
    MAIN.SVC_MACH_MSTR_PK
,   MAIN.SER_NUM
,   MAIN.DS_CONTR_PK
,   MAIN.DS_CONTR_NUM
,   MAIN.DS_CONTR_DTL_PK
,   MOD(CONTR.ROW_NUM, #parProcTotTaskCnt#) AS PAR_PROC_TASK_NUM
FROM
    MAIN
,   CONTR
WHERE
    MAIN.DS_CONTR_PK = CONTR.DS_CONTR_PK
<!-- END 2018/02/23 M.Kidokoro [QC#23317,ADD] -->
</statement>
<!-- START 2018/05/28 T.Wada [QC#23317,ADD] -->
<statement id="countMtrEstSelRec" parameterClass="Map" resultClass="BigDecimal">
SELECT
    COUNT(*) CNT 
FROM
    MTR_EST_SEL
WHERE
    GLBL_CMPY_CD                =   #glblCmpyCd#
AND EZCANCELFLAG                =   '0'
AND SVC_MACH_MSTR_PK            =   #svcMachMstrPk#
AND MTR_EST_PROC_DT             =   #slsDt#
</statement>
<!-- END 2018/05/28 T.Wada [QC#23317,ADD] -->
</sqlMap>