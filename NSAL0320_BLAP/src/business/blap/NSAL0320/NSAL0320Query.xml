<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NSAL0320Query">
    <statement id="getDsContr" parameterClass="Map" resultClass="Map">
        SELECT
            DCR.DS_CONTR_PK
           ,DCR.DS_CONTR_NUM
           ,DCR.DS_CONTR_SQ_NUM
           ,DCR.DS_CONTR_STS_CD
           ,DCD.DS_CONTR_DTL_PK
           ,DCD.DS_CONTR_DTL_STS_CD
           ,SMM.SVC_MACH_MSTR_PK
           ,SMM.SER_NUM
           ,MDS.MDSE_CD
           ,MDS.MDSE_DESC_SHORT_TXT
           ,MDN.T_MDL_ID            AS MDL_ID
           ,MDN.T_MDL_NM            AS MDL_NM
<!-- START 2015/10/13 T.Tomita [N/A, ADD] -->
           ,DCD.PRC_MTR_PKG_PK
           ,DCD.CONTR_EFF_FROM_DT
           ,DCD.CONTR_EFF_THRU_DT
           ,DCR.DS_CONTR_CATG_CD
           ,DCD.EZUPTIME
           ,DCD.EZUPTIMEZONE
<!-- END 2015/10/13 T.Tomita [N/A, ADD] -->
        FROM
            DS_CONTR_DTL    DCD
           ,DS_CONTR        DCR
           ,SVC_MACH_MSTR   SMM
           ,MDSE            MDS
<!-- START 2015/10/13 T.Tomita [N/A, MOD] -->
           ,SVC_CONFIG_MSTR SCM
           ,DS_MDL          DM
<!--       ,MDL_ITEM        MDI -->
<!-- END 2015/10/13 T.Tomita [N/A, MOD] -->
           ,MDL_NM          MDN
        WHERE
                DCD.DS_CONTR_DTL_PK     =    #dsContrDtlPk#
            AND DCD.GLBL_CMPY_CD        =    #glblCmpyCd#
            AND DCD.EZCANCELFLAG        =    '0'
            AND DCR.DS_CONTR_PK         =    DCD.DS_CONTR_PK
            AND DCR.GLBL_CMPY_CD        =    DCD.GLBL_CMPY_CD
            AND DCR.EZCANCELFLAG        =    DCD.EZCANCELFLAG
<!-- START 2015/10/13 T.Tomita [N/A, MOD] -->
            AND DCD.SVC_MACH_MSTR_PK    =    SMM.SVC_MACH_MSTR_PK   (+)
            AND DCD.GLBL_CMPY_CD        =    SMM.GLBL_CMPY_CD       (+)
            AND DCD.EZCANCELFLAG        =    SMM.EZCANCELFLAG       (+)
<!-- END 2015/10/13 T.Tomita [N/A, MOD] -->
            AND SMM.MDSE_CD             =    MDS.MDSE_CD            (+)
            AND SMM.GLBL_CMPY_CD        =    MDS.GLBL_CMPY_CD       (+)
            AND SMM.EZCANCELFLAG        =    MDS.EZCANCELFLAG       (+)
<!-- START 2015/10/13 T.Tomita [N/A, MOD] -->
            AND SMM.SVC_CONFIG_MSTR_PK  =    SCM.SVC_CONFIG_MSTR_PK (+)
            AND SMM.GLBL_CMPY_CD        =    SCM.GLBL_CMPY_CD       (+)
            AND SMM.EZCANCELFLAG        =    SCM.EZCANCELFLAG       (+)
            AND SCM.MDL_ID              =    DM.MDL_ID              (+)
            AND SCM.GLBL_CMPY_CD        =    DM.GLBL_CMPY_CD        (+)
            AND SCM.EZCANCELFLAG        =    DM.EZCANCELFLAG        (+)
            AND DM.MDL_ID               =    MDN.T_MDL_ID           (+)
            AND DM.GLBL_CMPY_CD         =    MDN.T_GLBL_CMPY_CD     (+)
            AND DM.EZCANCELFLAG         =    MDN.EZCANCELFLAG       (+)
<!--        AND MDS.MDSE_CD             =    MDI.T_ITEM_CD          (+) -->
<!--        AND MDS.GLBL_CMPY_CD        =    MDI.T_GLBL_CMPY_CD     (+) -->
<!--        AND MDS.EZCANCELFLAG        =    MDI.EZCANCELFLAG       (+) -->
<!--        AND MDI.T_MDL_ID            =    MDN.T_MDL_ID           (+) -->
<!--        AND MDI.T_GLBL_CMPY_CD      =    MDN.T_GLBL_CMPY_CD     (+) -->
<!--        AND MDI.EZCANCELFLAG        =    MDN.EZCANCELFLAG       (+) -->
<!-- END 2015/10/13 T.Tomita [N/A, MOD] -->
    </statement>
<statement id="getBllgMtr" parameterClass="Map" resultClass="Map">
SELECT
	RLN.EZUPTIME									AS	EZUPTIME_AR
,	RLN.EZUPTIMEZONE								AS	EZUPTIMEZONE_AR
,	RLN.CONTR_PHYS_BLLG_MTR_RELN_PK
,	CBM.EZUPTIME									AS	EZUPTIME_AB
,	CBM.EZUPTIMEZONE								AS	EZUPTIMEZONE_AB
,	CBM.DS_CONTR_BLLG_MTR_PK
,	SPM.SVC_PHYS_MTR_PK
,	SPM.MTR_ENTRY_MND_FLG
,	SPM.MDL_MTR_LB_CD
,	PML.MTR_LB_DESC_TXT								AS	MTR_LB_DESC_TXT_AP
,	CASE
<!-- START 2020/06/18 K.Kitachi [QC#57199, ADD] -->
        WHEN RLN.CONTR_PHYS_BLLG_MTR_RELN_PK IS NULL
         AND EXISTS (
                SELECT
                    1
                FROM
                    DS_CONTR_DTL X
                WHERE
                        X.GLBL_CMPY_CD    = #glblCmpyCd#
                    AND X.DS_CONTR_DTL_PK = #dsContrDtlPk#
                    AND X.PRC_MTR_PKG_PK  IS NOT NULL
                    AND X.EZCANCELFLAG    = '0'
             )
        THEN 'N'
<!-- END 2020/06/18 K.Kitachi [QC#57199, ADD] -->
		WHEN RLN.CONTR_PHYS_BLLG_MTR_RELN_PK IS NULL
		THEN SPM.MTR_ENTRY_MND_FLG
		ELSE RLN.BLLBL_FLG
	END												AS	BLLBL_FLG
,	CASE
		WHEN RLN.CONTR_PHYS_BLLG_MTR_RELN_PK IS NULL
		THEN SPM.MTR_MULT_RATE
		ELSE RLN.CONTR_MTR_MULT_RATE
	END												AS	CONTR_MTR_MULT_RATE
,	RLN.BLLG_MTR_LB_CD								AS	BLLG_MTR_LB_CD
<!-- START 2016/09/20 T.Tomita [QC#6316, ADD] -->
,	SPM.MTR_GRP_PK
<!-- END 2016/09/20 T.Tomita [QC#6316, ADD] -->
<!-- START 2016/11/28 K.Ochiai [QC#14204, ADD] -->
,   CBM.EZINTIME                                    AS  XX_REC_HIST_CRAT_TS
,   CBM.EZINUSERID                                  AS  XX_REC_HIST_CRAT_BY_NM
,   CBM.EZUPTIME                                    AS  XX_REC_HIST_UPD_TS
,   CBM.EZUPUSERID                                  AS  XX_REC_HIST_UPD_BY_NM
,   CBM.EZTABLEID                                   AS  XX_REC_HIST_TBL_NM
<!-- END 2016/11/28 K.Ochiai [QC#14204, ADD] -->
FROM
	SVC_PHYS_MTR				SPM
,	CONTR_PHYS_BLLG_MTR_RELN	RLN
,	DS_CONTR_BLLG_MTR			CBM
,	MTR_LB						PML<!-- Regular(Physical) Meter Label -->
,	MTR_LB						BML<!-- Default Billing Meter Label -->
,	MTR_LB						RML<!-- Billing Meter Label -->
WHERE
	SPM.SVC_MACH_MSTR_PK		=	#svcMachMstrPk#
AND	SPM.GLBL_CMPY_CD			=	#glblCmpyCd#
AND	SPM.EZCANCELFLAG			=	'0'
AND	PML.MTR_LB_CD				=	SPM.MDL_MTR_LB_CD
AND	PML.GLBL_CMPY_CD			=	SPM.GLBL_CMPY_CD
AND	PML.EZCANCELFLAG			=	SPM.EZCANCELFLAG
AND	SPM.BLLG_MTR_LB_CD			=	BML.MTR_LB_CD(+)
AND	SPM.GLBL_CMPY_CD			=	BML.GLBL_CMPY_CD(+)	
AND	SPM.EZCANCELFLAG			=	BML.EZCANCELFLAG(+)
AND	SPM.SVC_PHYS_MTR_PK			=	RLN.SVC_PHYS_MTR_PK(+)
AND	SPM.GLBL_CMPY_CD			=	RLN.GLBL_CMPY_CD(+)
AND	SPM.EZCANCELFLAG			=	RLN.EZCANCELFLAG(+)
AND	RLN.DS_CONTR_DTL_PK		(+)	=	#dsContrDtlPk#
AND	RLN.BLLG_MTR_LB_CD			=	RML.MTR_LB_CD(+)
AND	RLN.GLBL_CMPY_CD			=	RML.GLBL_CMPY_CD(+)
AND	RLN.EZCANCELFLAG			=	RML.EZCANCELFLAG(+)
AND	RLN.DS_CONTR_BLLG_MTR_PK	=	CBM.DS_CONTR_BLLG_MTR_PK(+)
AND	RLN.GLBL_CMPY_CD			=	CBM.GLBL_CMPY_CD(+)
AND	RLN.EZCANCELFLAG			=	CBM.EZCANCELFLAG(+)
ORDER BY
	PML.MTR_LB_SORT_NUM
</statement>
    <statement id="getBllgMtrMap" parameterClass="Map" resultClass="Map">
        WITH TMP_MTR_GRP AS (
            SELECT DISTINCT
                B.MTR_GRP_PK
            FROM
                 DS_CONTR_DTL A
                ,SVC_PHYS_MTR B
            WHERE
                    A.GLBL_CMPY_CD     = #glblCmpyCd#
                AND A.DS_CONTR_DTL_PK  = #dsContrDtlPk#
                AND A.EZCANCELFLAG     = '0'
                AND A.GLBL_CMPY_CD     = B.GLBL_CMPY_CD
                AND A.SVC_MACH_MSTR_PK = B.SVC_MACH_MSTR_PK
                AND B.MTR_GRP_PK       IS NOT NULL
                AND B.EZCANCELFLAG     = '0'
        )
        SELECT
             BMM.BLLG_MTR_LB_CD
            ,BMM.BLLG_MTR_MAP_LVL_NUM
            ,MLB.MTR_LB_DESC_TXT
        FROM
             BLLG_MTR_MAP    BMM
            ,MTR_LB          MLB
            ,TMP_MTR_GRP     GRP
        WHERE
                BMM.MDL_MTR_LB_CD             =    #mdlMtrLbCd#
            <isNotNull property="bllgMtrMapLvlNum">
            AND BMM.BLLG_MTR_MAP_LVL_NUM      =    #bllgMtrMapLvlNum#
            </isNotNull>
            <isNotNull property="bllgMtrLbCd">
            AND BMM.BLLG_MTR_LB_CD            =    #bllgMtrLbCd#
            </isNotNull>
            AND BMM.GLBL_CMPY_CD              =    #glblCmpyCd#
            AND BMM.EZCANCELFLAG              =    '0'
            AND MLB.MTR_LB_CD                 =    BMM.BLLG_MTR_LB_CD
            AND MLB.GLBL_CMPY_CD              =    BMM.GLBL_CMPY_CD
            AND MLB.EZCANCELFLAG              =    BMM.EZCANCELFLAG
            AND BMM.MTR_GRP_PK                =    GRP.MTR_GRP_PK
            AND BMM.ACTV_FLG                  =    'Y'
            AND BMM.EFF_FROM_DT               &lt;= #slsDt#
            AND NVL(BMM.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
            AND MLB.ACTV_FLG                  =    'Y'
            AND MLB.EFF_FROM_DT               &lt;= #slsDt#
            AND NVL(MLB.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
            <isNotNull property="prcMtrPkgPk">
            AND EXISTS (
                SELECT
                    *
                FROM
                    PRC_MTR_PKG_BLLG_MTR    X
                WHERE
                    X.GLBL_CMPY_CD      = #glblCmpyCd#
                AND X.EZCANCELFLAG      = '0'
                AND X.MTR_LB_CD         = BMM.BLLG_MTR_LB_CD
                AND X.PRC_MTR_PKG_PK    = #prcMtrPkgPk#
                )
            </isNotNull>
        UNION
        SELECT
             BMM.BLLG_MTR_LB_CD
            ,BMM.BLLG_MTR_MAP_LVL_NUM
            ,MLB.MTR_LB_DESC_TXT
        FROM
             BLLG_MTR_MAP    BMM
            ,MTR_LB          MLB
            ,TMP_MTR_GRP     GRP
        WHERE
                BMM.MDL_MTR_LB_CD             =    #mdlMtrLbCd#
            <isNotNull property="bllgMtrMapLvlNum">
            AND BMM.BLLG_MTR_MAP_LVL_NUM      =    #bllgMtrMapLvlNum#
            </isNotNull>
            <isNotNull property="bllgMtrLbCd">
            AND BMM.BLLG_MTR_LB_CD            =    #bllgMtrLbCd#
            </isNotNull>
            AND BMM.GLBL_CMPY_CD              =    #glblCmpyCd#
            AND BMM.EZCANCELFLAG              =    '0'
            AND MLB.MTR_LB_CD                 =    BMM.BLLG_MTR_LB_CD
            AND MLB.GLBL_CMPY_CD              =    BMM.GLBL_CMPY_CD
            AND MLB.EZCANCELFLAG              =    BMM.EZCANCELFLAG
            AND BMM.MTR_GRP_PK                =    GRP.MTR_GRP_PK
            AND EXISTS (
                    SELECT
                        1
                    FROM
                        DS_CONTR_BLLG_MTR  CBM
                    WHERE
                            CBM.GLBL_CMPY_CD      = BMM.GLBL_CMPY_CD
                        AND CBM.DS_CONTR_DTL_PK   = #dsContrDtlPk#
                        AND CBM.BLLG_MTR_LB_CD    = BMM.BLLG_MTR_LB_CD
                        AND CBM.EZCANCELFLAG      = '0')
            AND NOT EXISTS ( 
                    SELECT
                        1
                    FROM
                         BLLG_MTR_MAP  A
                        ,MTR_LB        B
                    WHERE
                            A.GLBL_CMPY_CD              = BMM.GLBL_CMPY_CD
                        AND A.MDL_MTR_LB_CD             = BMM.MDL_MTR_LB_CD 
                        AND A.BLLG_MTR_LB_CD            = BMM.BLLG_MTR_LB_CD 
                        AND A.MTR_GRP_PK                = BMM.MTR_GRP_PK
                        AND A.ACTV_FLG                  = 'Y'
                        AND A.EFF_FROM_DT               &lt;= #slsDt#
                        AND NVL(A.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
                        AND A.EZCANCELFLAG              = '0'
                        AND A.GLBL_CMPY_CD              = B.GLBL_CMPY_CD
                        AND A.BLLG_MTR_LB_CD            = B.MTR_LB_CD
                        AND B.ACTV_FLG                  = 'Y'
                        AND B.EFF_FROM_DT               &lt;= #slsDt#
                        AND NVL(B.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
                        AND B.EZCANCELFLAG              = '0')
        ORDER BY
             BLLG_MTR_MAP_LVL_NUM    ASC
            ,BLLG_MTR_LB_CD          ASC
    </statement>
<!-- START 2015/10/13 T.Tomita [N/A, ADD] -->
    <statement id="getSvcPkgMap" parameterClass="Map" resultClass="Map">
        SELECT
             C.PRC_MTR_PKG_PK
            ,C.PRC_MTR_PKG_NM
        FROM
            (
                SELECT
                     B.PRC_MTR_PKG_PK
                    ,B.PRC_MTR_PKG_NM
                    ,A.EFF_FROM_DT          AS PKG_MDL_EFF_FROM_DT
                    ,CASE
                        WHEN A.EFF_THRU_DT IS NOT NULL
                            THEN A.EFF_THRU_DT
                            ELSE #endDt#
                     END                    AS PKG_MDL_EFF_THRU_DT
                    ,B.EFF_FROM_DT          AS PKG_EFF_FROM_DT
                    ,CASE
                        WHEN B.EFF_THRU_DT IS NOT NULL
                            THEN B.EFF_THRU_DT
                            ELSE #endDt#
                     END                    AS PKG_EFF_THRU_DT
                FROM
                     PRC_MTR_PKG_MDL A
                    ,PRC_MTR_PKG     B
                WHERE 
                        A.GLBL_CMPY_CD   =  #glblCmpyCd#
                    AND A.MDL_ID         =  #mdlId#
                    AND A.EZCANCELFLAG   = '0'
                    AND A.GLBL_CMPY_CD   =  B.GLBL_CMPY_CD
                    AND A.PRC_MTR_PKG_PK =  B.PRC_MTR_PKG_PK
                    AND B.EZCANCELFLAG   = '0'
            ) C
        WHERE
                C.PKG_MDL_EFF_FROM_DT   &lt;= #slsDt#
            AND C.PKG_MDL_EFF_THRU_DT   &gt;= #slsDt#
            AND C.PKG_EFF_FROM_DT       &lt;= #slsDt#
            AND C.PKG_EFF_THRU_DT       &gt;= #slsDt#
        ORDER BY
            C.PRC_MTR_PKG_PK

    </statement>
    <statement id="getBllgMtrLvlForNonFleet" parameterClass="Map" resultClass="Map">
        SELECT
            C.BLLG_MTR_MAP_LVL_NUM
        FROM
             DS_CONTR_DTL      A
            ,SVC_PHYS_MTR      B
            ,BLLG_MTR_MAP      C
        WHERE
                A.GLBL_CMPY_CD       = #glblCmpyCd#
            AND A.DS_CONTR_DTL_PK    = #dsContrDtlPk#
            AND A.EZCANCELFLAG       = '0'
            AND A.GLBL_CMPY_CD       = B.GLBL_CMPY_CD
            AND A.SVC_MACH_MSTR_PK   = B.SVC_MACH_MSTR_PK
            AND B.EZCANCELFLAG       = '0'
            AND B.GLBL_CMPY_CD       = C.GLBL_CMPY_CD
            AND B.MDL_MTR_LB_CD      = C.MDL_MTR_LB_CD
            AND B.MTR_GRP_PK         = C.MTR_GRP_PK
            AND C.EZCANCELFLAG       = '0'
            AND C.ACTV_FLG           = 'Y'
            AND C.EFF_FROM_DT               &lt;= #slsDt#
            AND NVL(C.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
        UNION
        SELECT
            C.BLLG_MTR_MAP_LVL_NUM
        FROM
             DS_CONTR_DTL      A
            ,SVC_PHYS_MTR      B
            ,BLLG_MTR_MAP      C
        WHERE
                A.GLBL_CMPY_CD       = #glblCmpyCd#
            AND A.DS_CONTR_DTL_PK    = #dsContrDtlPk#
            AND A.EZCANCELFLAG       = '0'
            AND A.GLBL_CMPY_CD       = B.GLBL_CMPY_CD
            AND A.SVC_MACH_MSTR_PK   = B.SVC_MACH_MSTR_PK
            AND B.EZCANCELFLAG       = '0'
            AND B.GLBL_CMPY_CD       = C.GLBL_CMPY_CD
            AND B.MDL_MTR_LB_CD      = C.MDL_MTR_LB_CD
            AND B.MTR_GRP_PK         = C.MTR_GRP_PK
            AND C.EZCANCELFLAG       = '0'
            AND EXISTS (
                    SELECT
                        1
                    FROM
                        DS_CONTR_BLLG_MTR CBM
                    WHERE
                            CBM.GLBL_CMPY_CD    = A.GLBL_CMPY_CD
                        AND CBM.DS_CONTR_DTL_PK = A.DS_CONTR_DTL_PK
                        AND CBM.BLLG_MTR_LB_CD  = C.BLLG_MTR_LB_CD
                        AND CBM.EZCANCELFLAG    = '0')
            AND NOT EXISTS ( 
                    SELECT
                        1
                    FROM
                        BLLG_MTR_MAP  BMM
                    WHERE
                            BMM.GLBL_CMPY_CD              = C.GLBL_CMPY_CD
                        AND BMM.MDL_MTR_LB_CD             = C.MDL_MTR_LB_CD 
                        AND BMM.BLLG_MTR_LB_CD            = C.BLLG_MTR_LB_CD 
                        AND BMM.MTR_GRP_PK                = C.MTR_GRP_PK 
                        AND BMM.ACTV_FLG                  = 'Y'
                        AND BMM.EFF_FROM_DT               &lt;= #slsDt#
                        AND NVL(BMM.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
                        AND BMM.EZCANCELFLAG              = '0')
        ORDER BY
            BLLG_MTR_MAP_LVL_NUM
    </statement>
    <statement id="getBllgMtrLvlForFltAgg" parameterClass="Map" resultClass="Map">
        SELECT
            C.BLLG_MTR_MAP_LVL_NUM
        FROM
             DS_CONTR_DTL      A
            ,SVC_PHYS_MTR      B
            ,BLLG_MTR_MAP      C
            ,DS_CONTR_DTL_TP   D
        WHERE
                A.GLBL_CMPY_CD       = #glblCmpyCd#
            AND A.DS_CONTR_PK        = #dsContrPk#
            AND A.EZCANCELFLAG       = '0'
            AND A.GLBL_CMPY_CD       = B.GLBL_CMPY_CD
            AND A.SVC_MACH_MSTR_PK   = B.SVC_MACH_MSTR_PK
            AND B.EZCANCELFLAG       = '0'
            AND B.GLBL_CMPY_CD       = C.GLBL_CMPY_CD
            AND B.MDL_MTR_LB_CD      = C.MDL_MTR_LB_CD
            AND B.MTR_GRP_PK         = C.MTR_GRP_PK
            AND C.EZCANCELFLAG       = '0'
            AND C.ACTV_FLG           = 'Y'
            AND C.EFF_FROM_DT               &lt;= #slsDt#
            AND NVL(C.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
            AND A.GLBL_CMPY_CD       = D.GLBL_CMPY_CD
            AND A.DS_CONTR_DTL_TP_CD = D.DS_CONTR_DTL_TP_CD
            AND D.EZCANCELFLAG       = '0'
            AND D.MAIN_UNIT_LINE_FLG = 'Y'
            AND D.USG_CHRG_FLG       = 'Y'
        UNION
        SELECT
            C.BLLG_MTR_MAP_LVL_NUM
        FROM
             DS_CONTR_DTL      A
            ,SVC_PHYS_MTR      B
            ,BLLG_MTR_MAP      C
            ,DS_CONTR_DTL_TP   D
        WHERE
                A.GLBL_CMPY_CD       = #glblCmpyCd#
            AND A.DS_CONTR_PK        = #dsContrPk#
            AND A.EZCANCELFLAG       = '0'
            AND A.GLBL_CMPY_CD       = B.GLBL_CMPY_CD
            AND A.SVC_MACH_MSTR_PK   = B.SVC_MACH_MSTR_PK
            AND B.EZCANCELFLAG       = '0'
            AND B.GLBL_CMPY_CD       = C.GLBL_CMPY_CD
            AND B.MDL_MTR_LB_CD      = C.MDL_MTR_LB_CD
            AND B.MTR_GRP_PK         = C.MTR_GRP_PK
            AND C.EZCANCELFLAG       = '0'
            AND EXISTS (
                    SELECT
                         1
                    FROM
                        DS_CONTR_BLLG_MTR CBM
                    WHERE
                            CBM.GLBL_CMPY_CD    = A.GLBL_CMPY_CD
                        AND CBM.DS_CONTR_DTL_PK = A.DS_CONTR_DTL_PK
                        AND CBM.BLLG_MTR_LB_CD  = C.BLLG_MTR_LB_CD
                        AND CBM.EZCANCELFLAG    = '0')
            AND NOT EXISTS ( 
                    SELECT
                        1
                    FROM
                        BLLG_MTR_MAP  BMM
                    WHERE
                            BMM.GLBL_CMPY_CD              = C.GLBL_CMPY_CD
                        AND BMM.MDL_MTR_LB_CD             = C.MDL_MTR_LB_CD 
                        AND BMM.BLLG_MTR_LB_CD            = C.BLLG_MTR_LB_CD 
                        AND BMM.MTR_GRP_PK                = C.MTR_GRP_PK 
                        AND BMM.ACTV_FLG                  = 'Y'
                        AND BMM.EFF_FROM_DT               &lt;= #slsDt#
                        AND NVL(BMM.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
                        AND BMM.EZCANCELFLAG              = '0')
            AND A.GLBL_CMPY_CD       = D.GLBL_CMPY_CD
            AND A.DS_CONTR_DTL_TP_CD = D.DS_CONTR_DTL_TP_CD
            AND D.EZCANCELFLAG       = '0'
            AND D.MAIN_UNIT_LINE_FLG = 'Y'
            AND D.USG_CHRG_FLG       = 'Y'
        ORDER BY
            BLLG_MTR_MAP_LVL_NUM
    </statement>
<!-- START 2016/09/20 T.Tomita [QC#6316, MOD] -->
    <statement id="getPhysMtrForFltAgg" parameterClass="Map" resultClass="Map">
        SELECT
             Z.MDL_MTR_LB_CD   AS MDL_MTR_LB_CD
            ,Y.MTR_LB_DESC_TXT AS MTR_LB_DESC_TXT
            ,Z.MTR_MULT_RATE
            ,Z.MTR_ENTRY_MND_FLG
            ,Z.MTR_GRP_PK
        FROM
             (
<!-- START 2017/09/13 K.Kitachi [QC#21048, MOD] -->
                SELECT
                     A.GLBL_CMPY_CD        AS GLBL_CMPY_CD
                    ,A.DS_CONTR_CATG_CD    AS DS_CONTR_CATG_CD
                    ,D.MDL_MTR_LB_CD       AS MDL_MTR_LB_CD
                    ,E.CONTR_MTR_MULT_RATE AS MTR_MULT_RATE
                    ,D.MTR_ENTRY_MND_FLG   AS MTR_ENTRY_MND_FLG
                    ,D.MTR_GRP_PK          AS MTR_GRP_PK
                    ,RANK() OVER(
                        PARTITION BY
                             A.GLBL_CMPY_CD
                            ,A.DS_CONTR_CATG_CD
                            ,D.MDL_MTR_LB_CD
                        ORDER BY
                             D.MDL_MTR_LB_CD
                            ,D.MTR_ENTRY_MND_FLG DESC
                            ,D.MTR_GRP_PK
                            ,E.CONTR_MTR_MULT_RATE
                            ,COUNT(*)            DESC
                     ) AS RANK
                FROM
                     DS_CONTR                 A
                    ,DS_CONTR_DTL             B
                    ,DS_CONTR_DTL_TP          C
                    ,SVC_PHYS_MTR             D
                    ,CONTR_PHYS_BLLG_MTR_RELN E
                WHERE
                        A.GLBL_CMPY_CD           = #glblCmpyCd#
                    AND A.DS_CONTR_PK            = #dsContrPk#
                    AND A.EZCANCELFLAG           = '0'
                    AND A.GLBL_CMPY_CD           = B.GLBL_CMPY_CD
                    AND A.DS_CONTR_PK            = B.DS_CONTR_PK
                    AND B.EZCANCELFLAG           = '0'
                    AND B.GLBL_CMPY_CD           = C.GLBL_CMPY_CD
                    AND B.DS_CONTR_DTL_TP_CD     = C.DS_CONTR_DTL_TP_CD
                    AND C.MAIN_UNIT_LINE_FLG     = 'Y'
                    AND C.USG_CHRG_FLG           = 'Y'
                    AND C.EZCANCELFLAG           = '0'
                    AND B.GLBL_CMPY_CD           = D.GLBL_CMPY_CD
                    AND B.SVC_MACH_MSTR_PK       = D.SVC_MACH_MSTR_PK
                    AND D.EZCANCELFLAG           = '0'
                    AND B.GLBL_CMPY_CD           = E.GLBL_CMPY_CD       (+)
                    AND B.DS_CONTR_DTL_PK        = E.DS_CONTR_DTL_PK    (+)
                    AND D.SVC_PHYS_MTR_PK        = E.SVC_PHYS_MTR_PK    (+)
                    AND E.EZCANCELFLAG       (+) = '0'
                GROUP BY
                     A.GLBL_CMPY_CD
                    ,A.DS_CONTR_CATG_CD
                    ,D.MDL_MTR_LB_CD
                    ,E.CONTR_MTR_MULT_RATE
                    ,D.MTR_ENTRY_MND_FLG
                    ,D.MTR_GRP_PK
<!-- END 2017/09/13 K.Kitachi [QC#21048, MOD] -->
             ) Z
            ,MTR_LB Y
        WHERE
                Z.RANK          = 1
            AND Z.GLBL_CMPY_CD  = Y.GLBL_CMPY_CD
            AND Z.MDL_MTR_LB_CD = Y.MTR_LB_CD
            AND Y.EZCANCELFLAG  = '0'
        ORDER BY
            MDL_MTR_LB_CD
    </statement>
<!-- END 2016/09/20 T.Tomita [QC#6316, MOD] -->
    <statement id="getDefPhysMtrForFltAgg" parameterClass="Map" resultClass="Map">
        SELECT
             C.MTR_MULT_RATE
            ,C.MTR_ENTRY_MND_FLG
            ,C.BLLG_MTR_LB_CD
        FROM
             DS_CONTR_DTL    A
            ,DS_CONTR_DTL_TP B
            ,SVC_PHYS_MTR    C
        WHERE
                A.GLBL_CMPY_CD       = #glblCmpyCd#
            AND A.DS_CONTR_PK        = #dsContrPk#
            AND A.EZCANCELFLAG       = '0'
            AND A.GLBL_CMPY_CD       = B.GLBL_CMPY_CD
            AND A.DS_CONTR_DTL_TP_CD = B.DS_CONTR_DTL_TP_CD
            AND B.MAIN_UNIT_LINE_FLG = 'Y'
            AND B.USG_CHRG_FLG       = 'Y'
            AND B.EZCANCELFLAG       = '0'
            AND A.GLBL_CMPY_CD       = C.GLBL_CMPY_CD
            AND A.SVC_MACH_MSTR_PK   = C.SVC_MACH_MSTR_PK
            AND C.MDL_MTR_LB_CD      = #mdlMtrLbCd#
            AND C.EZCANCELFLAG       = '0'

    </statement>
    <statement id="getBllgMtrForFltAgg" parameterClass="Map" resultClass="Map">
        WITH PHYS_BLLG AS (
            SELECT DISTINCT
                 A.BLLG_MTR_LB_CD
                ,C.MDL_MTR_LB_CD
            FROM
                 CONTR_PHYS_BLLG_MTR_RELN A
                ,SVC_PHYS_MTR             C
            WHERE
                A.GLBL_CMPY_CD = #glblCmpyCd#
            AND A.EZCANCELFLAG = '0'
            AND EXISTS (
                SELECT
                    *
                FROM
                    DS_CONTR_DTL B
                WHERE
                    B.GLBL_CMPY_CD    = #glblCmpyCd#
                AND B.DS_CONTR_PK     = #dsContrPk#
                AND B.EZCANCELFLAG    = '0'
                AND B.DS_CONTR_DTL_PK = A.DS_CONTR_DTL_PK
                )
            AND A.GLBL_CMPY_CD        = C.GLBL_CMPY_CD
            AND A.SVC_PHYS_MTR_PK     = C.SVC_PHYS_MTR_PK
            AND C.EZCANCELFLAG        = '0'
            AND C.MDL_MTR_LB_CD       = #mdlMtrLbCd#
        )
        SELECT
             E.BLLBL_FLG
            ,E.CONTR_MTR_MULT_RATE
            ,E.BLLG_MTR_LB_CD
            ,E.BLLG_MTR_LVL_NUM
            ,E.CONTR_PHYS_BLLG_MTR_RELN_PK
            ,E.DS_CONTR_BLLG_MTR_PK
            ,F.EZUPTIME                   AS EZUPTIME_AB
            ,F.EZUPTIMEZONE               AS EZUPTIMEZONE_AB
            ,E.EZUPTIME                   AS EZUPTIME_AR
            ,E.EZUPTIMEZONE               AS EZUPTIMEZONE_AR
<!-- START 2016/11/28 K.Ochiai [QC#14204, ADD] -->
            ,F.EZINTIME                   AS XX_REC_HIST_CRAT_TS
            ,F.EZINUSERID                 AS XX_REC_HIST_CRAT_BY_NM
            ,F.EZUPTIME                   AS XX_REC_HIST_UPD_TS
            ,F.EZUPUSERID                 AS XX_REC_HIST_UPD_BY_NM
            ,F.EZTABLEID                  AS XX_REC_HIST_TBL_NM
<!-- END 2016/11/28 K.Ochiai [QC#14204, ADD] -->
        FROM
             CONTR_PHYS_BLLG_MTR_RELN E
            ,DS_CONTR_BLLG_MTR        F
            ,PHYS_BLLG                G
        WHERE
            E.GLBL_CMPY_CD         = #glblCmpyCd#
        AND E.DS_CONTR_DTL_PK      = #dsContrDtlPk#
        AND E.EZCANCELFLAG         = '0'
        AND E.GLBL_CMPY_CD         = F.GLBL_CMPY_CD
        AND E.DS_CONTR_BLLG_MTR_PK = F.DS_CONTR_BLLG_MTR_PK
        AND F.EZCANCELFLAG         = '0'
        AND E.BLLG_MTR_LB_CD       = G.BLLG_MTR_LB_CD

    </statement>
    <statement id="getBllgCntrInfo" parameterClass="Map" resultClass="Map">
      <isEqual property="regFlg" compareValue="Y">
        WITH TMP_MTR_GRP AS (
            SELECT DISTINCT
                B.MTR_GRP_PK
            FROM
                 DS_CONTR_DTL A
                ,SVC_PHYS_MTR B
            WHERE
                    A.GLBL_CMPY_CD     = #glblCmpyCd#
                AND A.DS_CONTR_DTL_PK  = #dsContrDtlPk#
                AND A.EZCANCELFLAG     = '0'
                AND A.GLBL_CMPY_CD     = B.GLBL_CMPY_CD
                AND A.SVC_MACH_MSTR_PK = B.SVC_MACH_MSTR_PK
                AND B.MTR_GRP_PK       IS NOT NULL
                AND B.EZCANCELFLAG     = '0'
        )
      </isEqual>
      <isEqual property="regFlg" compareValue="N">
        WITH TMP_MTR_GRP AS (
            SELECT DISTINCT
                C.MTR_GRP_PK
            FROM
                 DS_CONTR_DTL    A
                ,DS_CONTR_DTL    B
                ,SVC_PHYS_MTR    C
                ,DS_CONTR_DTL_TP D
            WHERE
                    A.GLBL_CMPY_CD       = #glblCmpyCd#
                AND A.DS_CONTR_DTL_PK    = #dsContrDtlPk#
                AND A.EZCANCELFLAG       = '0'
                AND A.GLBL_CMPY_CD       = B.GLBL_CMPY_CD
                AND A.DS_CONTR_PK        = B.DS_CONTR_PK
                AND B.EZCANCELFLAG       = '0'
                AND B.GLBL_CMPY_CD       = C.GLBL_CMPY_CD
                AND B.SVC_MACH_MSTR_PK   = C.SVC_MACH_MSTR_PK
                AND C.MTR_GRP_PK         IS NOT NULL
                AND C.EZCANCELFLAG       = '0'
                AND B.GLBL_CMPY_CD       = D.GLBL_CMPY_CD
                AND B.DS_CONTR_DTL_TP_CD = D.DS_CONTR_DTL_TP_CD
                AND D.EZCANCELFLAG       = '0'
                AND D.MAIN_UNIT_LINE_FLG = 'Y'
                AND D.USG_CHRG_FLG       = 'Y'
        )
      </isEqual>
        SELECT
             C.MTR_LB_CD
            ,C.MTR_LB_DESC_TXT
            ,B.BLLG_MTR_MAP_LVL_NUM
        FROM
             BLLG_MTR_MAP   B
            ,MTR_LB         C
            ,TMP_MTR_GRP    D
        WHERE
                B.GLBL_CMPY_CD                  =  #glblCmpyCd#
            AND B.MDL_MTR_LB_CD                 =  #mdlMtrLbCd#
            AND B.EZCANCELFLAG                  =  '0'
            AND B.GLBL_CMPY_CD                  =  C.GLBL_CMPY_CD
            AND B.BLLG_MTR_LB_CD                =  C.MTR_LB_CD
            AND C.EZCANCELFLAG                  =  '0'
            AND B.MTR_GRP_PK                    =  D.MTR_GRP_PK
            AND B.ACTV_FLG                      = 'Y'
            AND B.EFF_FROM_DT               &lt;= #slsDt#
            AND NVL(B.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
            AND C.ACTV_FLG                      = 'Y'
            AND C.EFF_FROM_DT               &lt;= #slsDt#
            AND NVL(C.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
            <isNotNull property="prcMtrPkgPk">
            AND EXISTS (
                SELECT
                    *
                FROM
                    PRC_MTR_PKG_BLLG_MTR    X
                WHERE
                    X.GLBL_CMPY_CD      = #glblCmpyCd#
                AND X.EZCANCELFLAG      = '0'
                AND X.MTR_LB_CD         = B.BLLG_MTR_LB_CD
                AND X.PRC_MTR_PKG_PK    = #prcMtrPkgPk#
                )
            </isNotNull>
        UNION
            SELECT
                 A.BLLG_MTR_LB_CD AS MTR_LB_CD
                ,X.MTR_LB_DESC_TXT
                ,A.BLLG_MTR_LVL_NUM AS BLLG_MTR_MAP_LVL_NUM
            FROM
                 CONTR_PHYS_BLLG_MTR_RELN A
                ,SVC_PHYS_MTR             C
                ,MTR_LB                   X
            WHERE
                A.GLBL_CMPY_CD = #glblCmpyCd#
            AND A.EZCANCELFLAG = '0'
            AND EXISTS (
                SELECT
                    *
                FROM
                    DS_CONTR_DTL B
                WHERE
                    B.GLBL_CMPY_CD    = #glblCmpyCd#
                AND B.DS_CONTR_PK     IN (
                    SELECT
                        Z.DS_CONTR_PK
                    FROM
                        DS_CONTR_DTL Z
                    WHERE
                        Z.GLBL_CMPY_CD    = #glblCmpyCd#
                    AND Z.EZCANCELFLAG    = '0'
                    AND Z.DS_CONTR_DTL_PK = #dsContrDtlPk#
                    )
                AND B.EZCANCELFLAG    = '0'
                AND B.DS_CONTR_DTL_PK = A.DS_CONTR_DTL_PK
                )
            AND A.GLBL_CMPY_CD        = C.GLBL_CMPY_CD
            AND A.SVC_PHYS_MTR_PK     = C.SVC_PHYS_MTR_PK
            AND C.EZCANCELFLAG        = '0'
            AND C.MDL_MTR_LB_CD       = #mdlMtrLbCd#
            AND A.GLBL_CMPY_CD        = X.GLBL_CMPY_CD
            AND A.BLLG_MTR_LB_CD      = X.MTR_LB_CD
            AND X.EZCANCELFLAG        = '0'

    </statement>
    <statement id="getBllgMtrLb" parameterClass="Map" resultClass="Map">
<!-- mod start 2016/08/22 CSA Defect#12910 -->
<!-- mod start 2016/07/26 CSA Defect#12106 -->
      <isEqual property="regFlg" compareValue="Y">
        WITH TMP_MTR_GRP AS (
            SELECT DISTINCT
                B.MTR_GRP_PK
            FROM
                 DS_CONTR_DTL A
                ,SVC_PHYS_MTR B
            WHERE
                    A.GLBL_CMPY_CD     = #glblCmpyCd#
                AND A.DS_CONTR_DTL_PK  = #dsContrDtlPk#
                AND A.EZCANCELFLAG     = '0'
                AND A.GLBL_CMPY_CD     = B.GLBL_CMPY_CD
                AND A.SVC_MACH_MSTR_PK = B.SVC_MACH_MSTR_PK
                AND B.MTR_GRP_PK       IS NOT NULL
                AND B.EZCANCELFLAG     = '0'
        )
      </isEqual>
      <isEqual property="regFlg" compareValue="N">
        WITH TMP_MTR_GRP AS (
            SELECT DISTINCT
                C.MTR_GRP_PK
            FROM
                 DS_CONTR_DTL    A
                ,DS_CONTR_DTL    B
                ,SVC_PHYS_MTR    C
                ,DS_CONTR_DTL_TP D
            WHERE
                    A.GLBL_CMPY_CD       = #glblCmpyCd#
                AND A.DS_CONTR_DTL_PK    = #dsContrDtlPk#
                AND A.EZCANCELFLAG       = '0'
                AND A.GLBL_CMPY_CD       = B.GLBL_CMPY_CD
                AND A.DS_CONTR_PK        = B.DS_CONTR_PK
                AND B.EZCANCELFLAG       = '0'
                AND B.GLBL_CMPY_CD       = C.GLBL_CMPY_CD
                AND B.SVC_MACH_MSTR_PK   = C.SVC_MACH_MSTR_PK
                AND C.MTR_GRP_PK         IS NOT NULL
                AND C.EZCANCELFLAG       = '0'
                AND B.GLBL_CMPY_CD       = D.GLBL_CMPY_CD
                AND B.DS_CONTR_DTL_TP_CD = D.DS_CONTR_DTL_TP_CD
                AND D.EZCANCELFLAG       = '0'
                AND D.MAIN_UNIT_LINE_FLG = 'Y'
                AND D.USG_CHRG_FLG       = 'Y'
        )
      </isEqual>
        SELECT
             BMM.BLLG_MTR_LB_CD
            ,BMM.BLLG_MTR_MAP_LVL_NUM
        FROM
             BLLG_MTR_MAP           BMM
            ,TMP_MTR_GRP            GRP
            ,(
                SELECT
                     ML1.GLBL_CMPY_CD
                    ,ML1.MTR_LB_CD     AS MDL_MTR_LB_CD
                    ,ML1.ACTV_FLG
                    ,ML1.EFF_FROM_DT
                    ,ML1.EFF_THRU_DT
                FROM
                    MTR_LB ML1
                WHERE
                    ML1.GLBL_CMPY_CD = #glblCmpyCd#
                AND ML1.EZCANCELFLAG = '0'
                AND ML1.MTR_LB_CD    = #mdlMtrLbCd#
             ) ML
        WHERE
                BMM.GLBL_CMPY_CD            = #glblCmpyCd#
            <iterate property="bllgMtrLbCdArray" var="bllgMtrLb[]" open="AND BMM.BLLG_MTR_LB_CD IN (" close=")" conjunction=",">
                #bllgMtrLb[]#
            </iterate>
            AND BMM.BLLG_MTR_MAP_LVL_NUM      = #bllgMtrMapLvlNum#
            AND BMM.EZCANCELFLAG              = '0'
            AND BMM.MTR_GRP_PK                = GRP.MTR_GRP_PK
            AND BMM.GLBL_CMPY_CD              = ML.GLBL_CMPY_CD
            AND BMM.MDL_MTR_LB_CD             = ML.MDL_MTR_LB_CD
            AND BMM.ACTV_FLG                  = 'Y'
            AND BMM.EFF_FROM_DT               &lt;= #slsDt#
            AND NVL(BMM.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
            AND ML.ACTV_FLG                   = 'Y'
            AND ML.EFF_FROM_DT                &lt;= #slsDt#
            AND NVL(ML.EFF_THRU_DT, #maxDt#)  &gt;= #slsDt#
        UNION
        SELECT
             BMM.BLLG_MTR_LB_CD
            ,BMM.BLLG_MTR_MAP_LVL_NUM
        FROM
             BLLG_MTR_MAP           BMM
            ,TMP_MTR_GRP            GRP
            ,(
                SELECT
                     ML1.GLBL_CMPY_CD
                    ,ML1.MTR_LB_CD     AS MDL_MTR_LB_CD
                    ,ML1.ACTV_FLG
                    ,ML1.EFF_FROM_DT
                    ,ML1.EFF_THRU_DT
                FROM
                    MTR_LB ML1
                WHERE
                    ML1.GLBL_CMPY_CD = #glblCmpyCd#
                AND ML1.EZCANCELFLAG = '0'
                AND ML1.MTR_LB_CD    = #mdlMtrLbCd#
             ) ML
        WHERE
                BMM.GLBL_CMPY_CD            = #glblCmpyCd#
            <iterate property="bllgMtrLbCdArray" var="bllgMtrLb[]" open="AND BMM.BLLG_MTR_LB_CD IN (" close=")" conjunction=",">
                #bllgMtrLb[]#
            </iterate>
            AND BMM.BLLG_MTR_MAP_LVL_NUM    = #bllgMtrMapLvlNum#
            AND BMM.EZCANCELFLAG            = '0'
            AND BMM.MTR_GRP_PK              = GRP.MTR_GRP_PK
            AND BMM.GLBL_CMPY_CD            = ML.GLBL_CMPY_CD
            AND BMM.MDL_MTR_LB_CD           = ML.MDL_MTR_LB_CD
            AND EXISTS (
                    SELECT
                        1
                    FROM
                        DS_CONTR_BLLG_MTR  CBM
                    WHERE
                            CBM.GLBL_CMPY_CD      = BMM.GLBL_CMPY_CD
                        AND CBM.DS_CONTR_DTL_PK   = #dsContrDtlPk#
                        AND CBM.BLLG_MTR_LB_CD    = BMM.BLLG_MTR_LB_CD
                        AND CBM.EZCANCELFLAG      = '0')
            AND NOT EXISTS ( 
                    SELECT
                        1
                    FROM
                         BLLG_MTR_MAP  A
                        ,MTR_LB        B
                    WHERE
                            A.GLBL_CMPY_CD              = BMM.GLBL_CMPY_CD
                        AND A.MDL_MTR_LB_CD             = BMM.MDL_MTR_LB_CD 
                        AND A.BLLG_MTR_LB_CD            = BMM.BLLG_MTR_LB_CD 
                        AND A.MTR_GRP_PK                = BMM.MTR_GRP_PK 
                        AND A.ACTV_FLG                  = 'Y'
                        AND A.EFF_FROM_DT               &lt;= #slsDt#
                        AND NVL(A.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
                        AND A.EZCANCELFLAG              = '0'
                        AND A.GLBL_CMPY_CD              = B.GLBL_CMPY_CD
                        AND A.BLLG_MTR_LB_CD            = B.MTR_LB_CD
                        AND B.ACTV_FLG                  = 'Y'
                        AND B.EFF_FROM_DT               &lt;= #slsDt#
                        AND NVL(B.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
                        AND B.EZCANCELFLAG              = '0')
        ORDER BY
             BLLG_MTR_MAP_LVL_NUM
            ,BLLG_MTR_LB_CD
<!-- mod end 2016/07/26 CSA Defect#12106 -->
<!-- mod end 2016/08/22 CSA Defect#12910 -->
    </statement>
    <statement id="getMtrMultRate" parameterClass="Map" resultClass="Map">
        SELECT
             PPM.MTR_MULT_RATE
        FROM
             PRC_MTR_PKG_BLLG_MTR   PBM
            ,PRC_MTR_PKG_PHYS_MTR   PPM
        WHERE
                PBM.GLBL_CMPY_CD            = #glblCmpyCd#
            AND PBM.PRC_MTR_PKG_PK          = #prcMtrPkgPk#
            AND PBM.MTR_LB_CD               = #bllgMtrLbCd#
            AND PBM.EZCANCELFLAG            = '0'
            AND PBM.GLBL_CMPY_CD            = PPM.GLBL_CMPY_CD
            AND PBM.PRC_MTR_PKG_BLLG_MTR_PK = PPM.PRC_MTR_PKG_BLLG_MTR_PK
            AND PPM.MTR_LB_CD               = #physMtrLbCd#
            AND PPM.ACTV_FLG                = 'Y'
            AND PPM.EZCANCELFLAG            = '0'

    </statement>
    <statement id="getBllgMtrSchd" parameterClass="Map" resultClass="Map">
<!-- mod start 2016/12/15 CSA Defect#16399 -->
        SELECT
            *
        FROM
             DS_CONTR_BLLG_SCHD DCBS
        WHERE
                DCBS.GLBL_CMPY_CD           = #glblCmpyCd#
            AND DCBS.DS_CONTR_DTL_PK        = #dsContrDtlPk#
            AND DCBS.INV_FLG                = 'Y'
            AND DCBS.USG_CHRG_FLG           = 'Y'
            AND DCBS.EZCANCELFLAG           = '0'
        UNION
        SELECT
            *
        FROM
             DS_CONTR_BLLG_SCHD DCBS
        WHERE
                DCBS.GLBL_CMPY_CD           = #glblCmpyCd#
            AND DCBS.PRNT_DS_CONTR_DTL_PK   = #dsContrDtlPk#
            AND DCBS.INV_FLG                = 'Y'
            AND DCBS.USG_CHRG_FLG           = 'Y'
            AND DCBS.EZCANCELFLAG           = '0'
<!-- mod end 2016/12/15 CSA Defect#16399 -->
    </statement>
    <statement id="getPrntBllgMtr" parameterClass="Map" resultClass="String">
      <isEqual property="regFlg" compareValue="Y">
        WITH TMP_MTR_GRP AS (
            SELECT DISTINCT
                B.MTR_GRP_PK
            FROM
                 DS_CONTR_DTL A
                ,SVC_PHYS_MTR B
            WHERE
                    A.GLBL_CMPY_CD     = #glblCmpyCd#
                AND A.DS_CONTR_DTL_PK  = #dsContrDtlPk#
                AND A.EZCANCELFLAG     = '0'
                AND A.GLBL_CMPY_CD     = B.GLBL_CMPY_CD
                AND A.SVC_MACH_MSTR_PK = B.SVC_MACH_MSTR_PK
                AND B.MTR_GRP_PK       IS NOT NULL
                AND B.EZCANCELFLAG     = '0'
        )
      </isEqual>
      <isEqual property="regFlg" compareValue="N">
        WITH TMP_MTR_GRP AS (
            SELECT DISTINCT
                C.MTR_GRP_PK
            FROM
                 DS_CONTR_DTL    A
                ,DS_CONTR_DTL    B
                ,SVC_PHYS_MTR    C
                ,DS_CONTR_DTL_TP D
            WHERE
                    A.GLBL_CMPY_CD       = #glblCmpyCd#
                AND A.DS_CONTR_DTL_PK    = #dsContrDtlPk#
                AND A.EZCANCELFLAG       = '0'
                AND A.GLBL_CMPY_CD       = B.GLBL_CMPY_CD
                AND A.DS_CONTR_PK        = B.DS_CONTR_PK
                AND B.EZCANCELFLAG       = '0'
                AND B.GLBL_CMPY_CD       = C.GLBL_CMPY_CD
                AND B.SVC_MACH_MSTR_PK   = C.SVC_MACH_MSTR_PK
                AND C.MTR_GRP_PK         IS NOT NULL
                AND C.EZCANCELFLAG       = '0'
                AND B.GLBL_CMPY_CD       = D.GLBL_CMPY_CD
                AND B.DS_CONTR_DTL_TP_CD = D.DS_CONTR_DTL_TP_CD
                AND D.EZCANCELFLAG       = '0'
                AND D.MAIN_UNIT_LINE_FLG = 'Y'
                AND D.USG_CHRG_FLG       = 'Y'
        )
      </isEqual>
        SELECT
            A.BLLG_MTR_LB_CD
        FROM
            (
                SELECT
                     X.GLBL_CMPY_CD
                    ,X.MDL_MTR_LB_CD
                    ,X.BLLG_MTR_LB_CD
                    ,X.BLLG_MTR_MAP_LVL_NUM
                    ,X.EFF_FROM_DT
                    ,CASE
                        WHEN X.EFF_THRU_DT IS NOT NULL
                            THEN X.EFF_THRU_DT
                            ELSE #endDt#
                     END AS EFF_THRU_DT
                FROM
                     BLLG_MTR_MAP X
                    ,TMP_MTR_GRP G
                WHERE
                        X.GLBL_CMPY_CD         =  #glblCmpyCd#
                    AND X.MDL_MTR_LB_CD        =  #mdlMtrLbCd#
                    AND X.EZCANCELFLAG         =  '0'
                    AND X.MTR_GRP_PK           =  G.MTR_GRP_PK
            ) A
        WHERE
                A.EFF_FROM_DT    &lt;= #slsDt#
            AND A.EFF_THRU_DT    &gt;= #slsDt#
            AND EXISTS (
                SELECT
                    *
                FROM
                    (
                        SELECT
                             Z.GLBL_CMPY_CD
                            ,Z.MDL_MTR_LB_CD
                            ,Z.BLLG_MTR_LB_CD
                            ,Z.BLLG_MTR_MAP_LVL_NUM
                            ,Z.EFF_FROM_DT
                            ,CASE
                                WHEN Z.EFF_THRU_DT IS NOT NULL
                                    THEN Z.EFF_THRU_DT
                                    ELSE #endDt#
                             END AS EFF_THRU_DT
                        FROM
                             BLLG_MTR_MAP Z
                            ,TMP_MTR_GRP G
                        WHERE
                                Z.GLBL_CMPY_CD         =  #glblCmpyCd#
                            AND Z.MDL_MTR_LB_CD        =  #mdlMtrLbCd#
                            AND Z.BLLG_MTR_LB_CD       =  #bllgMtrLbCd#
                            AND Z.EZCANCELFLAG         =  '0'
                            AND Z.MTR_GRP_PK           =  G.MTR_GRP_PK
                    ) Y
                WHERE
                        Y.GLBL_CMPY_CD         =  A.GLBL_CMPY_CD
                    AND Y.MDL_MTR_LB_CD        =  A.MDL_MTR_LB_CD
                    AND Y.BLLG_MTR_MAP_LVL_NUM &gt;  A.BLLG_MTR_MAP_LVL_NUM
                    AND Y.EFF_FROM_DT          &lt;= #slsDt#
                    AND Y.EFF_THRU_DT          &gt;= #slsDt#
            )

    </statement>
    <statement id="getDsContrDtlForFltAggMach" parameterClass="Map" resultClass="Map">
        SELECT
             A.DS_CONTR_DTL_PK
            ,A.SVC_MACH_MSTR_PK
            ,C.SVC_PHYS_MTR_PK
        FROM
             DS_CONTR_DTL      A
            ,DS_CONTR_DTL_TP   B
            ,SVC_PHYS_MTR      C
        WHERE
                A.GLBL_CMPY_CD       = #glblCmpyCd#
            AND A.EZCANCELFLAG       = '0'
            AND A.DS_CONTR_PK        = #dsContrPk#
            AND A.GLBL_CMPY_CD       = B.GLBL_CMPY_CD
            AND A.DS_CONTR_DTL_TP_CD = B.DS_CONTR_DTL_TP_CD
            AND B.EZCANCELFLAG       = '0'
            AND B.MAIN_UNIT_LINE_FLG = 'Y'
            AND B.USG_CHRG_FLG       = 'Y'
            AND A.GLBL_CMPY_CD       = C.GLBL_CMPY_CD
            AND A.SVC_MACH_MSTR_PK   = C.SVC_MACH_MSTR_PK
            AND C.EZCANCELFLAG       = '0'
            AND C.MDL_MTR_LB_CD      = #mdlMtrLbCd#
        ORDER BY
            A.DS_CONTR_DTL_PK

    </statement>
    <statement id="getPrcListSvcTier" parameterClass="Map" resultClass="Map">
        SELECT
             C.PRC_SVC_TIER_TP_CD
            ,C.MIN_COPY_VOL_CNT
            ,C.CPC_AMT_RATE
        FROM
            (
                SELECT
                     A.PRC_SVC_TIER_TP_CD
                    ,A.MIN_COPY_VOL_CNT
                    ,A.CPC_AMT_RATE
                    ,A.EFF_FROM_DT
                    ,B.PRC_SVC_TIER_TP_SORT_NUM
                    ,CASE
                        WHEN A.EFF_THRU_DT IS NOT NULL
                            THEN A.EFF_THRU_DT
                            ELSE #endDt#
                     END AS EFF_THRU_DT
                FROM
                     PRC_LIST_SVC_TIER A
                    ,PRC_SVC_TIER_TP   B
                WHERE
                        A.GLBL_CMPY_CD        =  #glblCmpyCd#
                    AND A.MDL_ID              =  #mdlId#
                    AND A.PRC_MTR_PKG_PK      =  #prcMtrPkgPk#
                    AND A.PRC_SVC_PLN_TP_CD   =  #prcSvcPlnTpCd#
                    AND A.PRC_SVC_CONTR_TP_CD =  #prcSvcContrTpCd#
                    AND A.BLLG_MTR_LB_CD      =  #bllgMtrLbCd#
                    AND A.EZCANCELFLAG        =  '0'
                    AND A.GLBL_CMPY_CD        =  B.GLBL_CMPY_CD
                    AND A.PRC_SVC_TIER_TP_CD  =  B.PRC_SVC_TIER_TP_CD
                    AND B.PRC_SVC_TIER_TP_CD  &lt;&gt; #prcSvcTierTpCd#
                    AND B.EZCANCELFLAG        =  '0'
            ) C
        WHERE
                C.EFF_FROM_DT &lt;= #slsDt#
            AND C.EFF_THRU_DT &gt;= #slsDt#
        ORDER BY
            C.PRC_SVC_TIER_TP_SORT_NUM

    </statement>
    <statement id="getDsContrBllgMtrPk" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            A.DS_CONTR_BLLG_MTR_PK
        FROM
            DS_CONTR_BLLG_MTR A
        WHERE
                A.GLBL_CMPY_CD    = #glblCmpyCd#
            AND A.EZCANCELFLAG    = '0'
            AND A.DS_CONTR_DTL_PK = #dsContrDtlPk#
            AND A.BLLG_MTR_LB_CD  = #bllgMtrLbCd#
    </statement>
    <statement id="getScheduleApiParams" parameterClass="Map" resultClass="Map">
        SELECT
             A.DS_CONTR_DTL_PK
            ,A.CONTR_CLO_DAY
            ,A.BASE_BLLG_TMG_CD
            ,A.CONTR_BLLG_DAY
            ,A.MTR_CLO_DAY
            ,A.MTR_BLLG_TMG_CD
            ,A.MTR_BLLG_DAY
            ,A.CONTR_EFF_FROM_DT
            <!-- START 2020/09/24 K.Kitachi [QC#57667, MOD] -->
            <!-- ,A.CONTR_EFF_THRU_DT -->
            ,NVL(A.CONTR_CLO_DT, A.CONTR_EFF_THRU_DT) AS CONTR_EFF_THRU_DT
            <!-- END 2020/09/24 K.Kitachi [QC#57667, MOD] -->
            <!-- START 2017/02/09 K.Kojima [QC#17522,MOD] -->
            <!-- ,A.MTR_BLLG_CYCLE_CD -->
            ,B.BLLG_MTR_BLLG_CYCLE_CD AS MTR_BLLG_CYCLE_CD
            <!-- END 2017/02/09 K.Kojima [QC#17522,MOD] -->
            ,B.DS_CONTR_BLLG_MTR_PK
            ,C.CONTR_XS_COPY_PK
            ,C.XS_MTR_COPY_QTY
            ,C.XS_MTR_AMT_RATE
            ,C.XS_MTR_FIRST_FLG
        FROM
             DS_CONTR_DTL      A
            ,DS_CONTR_BLLG_MTR B
            ,CONTR_XS_COPY     C
        WHERE
                A.GLBL_CMPY_CD             = #glblCmpyCd#
            AND A.EZCANCELFLAG             = '0'
            AND A.DS_CONTR_DTL_PK          = #dsContrDtlPk#
            AND A.GLBL_CMPY_CD             = B.GLBL_CMPY_CD
            AND A.DS_CONTR_DTL_PK          = B.DS_CONTR_DTL_PK
            AND B.DS_CONTR_BLLG_MTR_PK     = #dsContrBllgMtrPk#
            AND B.EZCANCELFLAG             = '0'
            AND B.GLBL_CMPY_CD             = C.GLBL_CMPY_CD         (+)
            AND B.DS_CONTR_BLLG_MTR_PK     = C.DS_CONTR_BLLG_MTR_PK (+)
            AND C.EZCANCELFLAG         (+) = '0'
        ORDER BY
             A.DS_CONTR_DTL_PK
            ,B.DS_CONTR_BLLG_MTR_PK
            ,C.CONTR_XS_COPY_PK
    </statement>
<!-- END 2015/10/13 T.Tomita [N/A, ADD] -->
    <statement id="getUnBllbRelnForFltAgg" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             RLN.CONTR_PHYS_BLLG_MTR_RELN_PK
        FROM
             DS_CONTR                  DCR
            ,DS_CONTR_DTL              DCD
            ,CONTR_PHYS_BLLG_MTR_RELN  RLN
            ,DS_CONTR_DTL_TP           DCDT
        WHERE
                DCR.GLBL_CMPY_CD       = #glblCmpyCd#
            AND DCR.DS_CONTR_PK        = #dsContrPk#
            AND DCR.EZCANCELFLAG       = '0'
            AND DCR.GLBL_CMPY_CD       = DCD.GLBL_CMPY_CD
            AND DCR.DS_CONTR_PK        = DCD.DS_CONTR_PK
            AND DCD.EZCANCELFLAG       = '0'
            AND DCD.GLBL_CMPY_CD       = RLN.GLBL_CMPY_CD
            AND DCD.DS_CONTR_DTL_PK    = RLN.DS_CONTR_DTL_PK
            AND RLN.BLLBL_FLG          = 'N'
            AND RLN.BLLG_MTR_LB_CD     IS NULL
            AND RLN.EZCANCELFLAG       = '0'
            AND DCD.GLBL_CMPY_CD        = DCDT.GLBL_CMPY_CD
            AND DCD.DS_CONTR_DTL_TP_CD  = DCDT.DS_CONTR_DTL_TP_CD
            AND DCDT.EZCANCELFLAG       = '0'
            AND DCDT.MAIN_UNIT_LINE_FLG = 'Y'
            AND DCDT.USG_CHRG_FLG       = 'Y'
    </statement>

    <statement id="getContrXsCopyForAgg" parameterClass="Map" resultClass="Map">
        SELECT
             CXC.XS_MTR_AMT_RATE
            ,CXC.XS_MTR_FIRST_FLG
        FROM
             DS_CONTR_BLLG_MTR           DCM
            ,CONTR_XS_COPY               CXC
        WHERE
                DCM.GLBL_CMPY_CD         = #glblCmpyCd#
            AND DCM.DS_CONTR_DTL_PK      = #dsContrDtlPk#
            AND DCM.BLLG_MTR_LB_CD       = #bllgMtrLbCd#
            AND DCM.EZCANCELFLAG         = '0'
            AND DCM.GLBL_CMPY_CD         = CXC.GLBL_CMPY_CD
            AND DCM.DS_CONTR_BLLG_MTR_PK = CXC.DS_CONTR_BLLG_MTR_PK
            AND CXC.EZCANCELFLAG         = '0'
        ORDER BY
            CXC.XS_MTR_COPY_QTY
    </statement>

<!-- START 2016/09/20 T.Tomita [QC#6316, MOD] -->
    <statement id="getDefaultBllgMtrLbForNonFleet" parameterClass="Map" resultClass="Map">
        SELECT
             A.BLLG_MTR_LB_CD
            ,A.MTR_MULT_RATE
        FROM
            DS_MDL_MTR A
        WHERE
                A.GLBL_CMPY_CD                  = #glblCmpyCd#
            AND A.EZCANCELFLAG                  = '0'
            AND A.MTR_GRP_PK                    = #mtrGrpPk#
            AND A.MDL_MTR_LB_CD                 = #mdlMtrLbCd#
            AND A.ACTV_FLG                      = 'Y'
            AND A.EFF_FROM_DT               &lt;= #slsDt#
            AND NVL(A.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
    </statement>
<!-- END 2016/09/20 T.Tomita [QC#6316, MOD] -->

    <statement id="getBllgMtrLbForFltAgg" parameterClass="Map" resultClass="Map">
        WITH TMP_MTR_GRP AS (
            SELECT DISTINCT
                C.MTR_GRP_PK
            FROM
                 DS_CONTR_DTL    A
                ,DS_CONTR_DTL    B
                ,SVC_PHYS_MTR    C
                ,DS_CONTR_DTL_TP D
            WHERE
                    A.GLBL_CMPY_CD       = #glblCmpyCd#
                AND A.DS_CONTR_DTL_PK    = #dsContrDtlPk#
                AND A.EZCANCELFLAG       = '0'
                AND A.GLBL_CMPY_CD       = B.GLBL_CMPY_CD
                AND A.DS_CONTR_PK        = B.DS_CONTR_PK
                AND B.EZCANCELFLAG       = '0'
                AND B.GLBL_CMPY_CD       = C.GLBL_CMPY_CD
                AND B.SVC_MACH_MSTR_PK   = C.SVC_MACH_MSTR_PK
                AND C.MTR_GRP_PK         IS NOT NULL
                AND C.EZCANCELFLAG       = '0'
                AND B.GLBL_CMPY_CD       = D.GLBL_CMPY_CD
                AND B.DS_CONTR_DTL_TP_CD = D.DS_CONTR_DTL_TP_CD
                AND D.EZCANCELFLAG       = '0'
                AND D.MAIN_UNIT_LINE_FLG = 'Y'
                AND D.USG_CHRG_FLG       = 'Y'
        )
        SELECT
             H.BLLG_MTR_LB_CD
            ,H.MTR_LB_DESC_TXT
            ,H.BLLG_MTR_MAP_LVL_NUM
        FROM (
            SELECT
                 G.BLLG_MTR_LB_CD
                ,G.MTR_LB_DESC_TXT
                ,G.BLLG_MTR_MAP_LVL_NUM
                ,RANK() OVER(
                    PARTITION BY
                        G.BLLG_MTR_LB_CD
                    ORDER BY
                        G.BLLG_MTR_MAP_LVL_NUM
                ) AS RNK
            FROM (
                SELECT
                     C.MTR_LB_CD            AS BLLG_MTR_LB_CD
                    ,C.MTR_LB_DESC_TXT
                    ,B.BLLG_MTR_MAP_LVL_NUM
                FROM
                     BLLG_MTR_MAP   B
                    ,MTR_LB         C
                    ,TMP_MTR_GRP    D
                WHERE
                        B.GLBL_CMPY_CD                  =  #glblCmpyCd#
                    AND B.MDL_MTR_LB_CD                 =  #mdlMtrLbCd#
                    AND B.EZCANCELFLAG                  =  '0'
                    AND B.GLBL_CMPY_CD                  =  C.GLBL_CMPY_CD
                    AND B.BLLG_MTR_LB_CD                =  C.MTR_LB_CD
                    AND C.EZCANCELFLAG                  =  '0'
                    AND B.MTR_GRP_PK                    =  D.MTR_GRP_PK
                    AND B.ACTV_FLG                      = 'Y'
                    AND B.EFF_FROM_DT               &lt;= #slsDt#
                    AND NVL(B.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
                    AND C.ACTV_FLG                      = 'Y'
                    AND C.EFF_FROM_DT               &lt;= #slsDt#
                    AND NVL(C.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
                    <isNotNull property="bllgMtrLbCd">
                    AND C.MTR_LB_CD                     =  #bllgMtrLbCd#
                    </isNotNull>
                    <isNotNull property="prcMtrPkgPk">
                    AND EXISTS (
                        SELECT
                            *
                        FROM
                            PRC_MTR_PKG_BLLG_MTR    X
                        WHERE
                            X.GLBL_CMPY_CD      = #glblCmpyCd#
                        AND X.EZCANCELFLAG      = '0'
                        AND X.MTR_LB_CD         = B.BLLG_MTR_LB_CD
                        AND X.PRC_MTR_PKG_PK    = #prcMtrPkgPk#
                        )
                    </isNotNull>
                UNION
                    SELECT
                         A.BLLG_MTR_LB_CD AS BLLG_MTR_LB_CD
                        ,X.MTR_LB_DESC_TXT
                        ,A.BLLG_MTR_LVL_NUM AS BLLG_MTR_MAP_LVL_NUM
                    FROM
                         CONTR_PHYS_BLLG_MTR_RELN A
                        ,SVC_PHYS_MTR             C
                        ,MTR_LB                   X
                    WHERE
                        A.GLBL_CMPY_CD = #glblCmpyCd#
                    AND A.EZCANCELFLAG = '0'
                    AND EXISTS (
                        SELECT
                            *
                        FROM
                            DS_CONTR_DTL B
                        WHERE
                            B.GLBL_CMPY_CD    = #glblCmpyCd#
                        AND B.DS_CONTR_PK     IN (
                            SELECT
                                Z.DS_CONTR_PK
                            FROM
                                DS_CONTR_DTL Z
                            WHERE
                                Z.GLBL_CMPY_CD    = #glblCmpyCd#
                            AND Z.EZCANCELFLAG    = '0'
                            AND Z.DS_CONTR_DTL_PK = #dsContrDtlPk#
                            )
                        AND B.EZCANCELFLAG    = '0'
                        AND B.DS_CONTR_DTL_PK = A.DS_CONTR_DTL_PK
                        )
                    AND A.GLBL_CMPY_CD        = C.GLBL_CMPY_CD
                    AND A.SVC_PHYS_MTR_PK     = C.SVC_PHYS_MTR_PK
                    AND C.EZCANCELFLAG        = '0'
                    AND C.MDL_MTR_LB_CD       = #mdlMtrLbCd#
                    AND A.GLBL_CMPY_CD        = X.GLBL_CMPY_CD
                    AND A.BLLG_MTR_LB_CD      = X.MTR_LB_CD
                    AND X.EZCANCELFLAG        = '0'
            ) G
        ) H
        WHERE
            H.RNK = 1
        ORDER BY
             H.BLLG_MTR_MAP_LVL_NUM
            ,H.BLLG_MTR_LB_CD
    </statement>

    <statement id="getDefSvcPkgForNonFleet" parameterClass="Map" resultClass="Map">
        SELECT
             A.BLLG_MTR_LVL_NUM
            ,B.BLLBL_FLG
            ,B.MTR_MULT_RATE
            ,A.MTR_LB_CD
        FROM
             PRC_MTR_PKG_BLLG_MTR A
            ,PRC_MTR_PKG_PHYS_MTR B
        WHERE
                A.GLBL_CMPY_CD            = #glblCmpyCd#
            AND A.PRC_MTR_PKG_PK          = #prcMtrPkgPk#
            AND A.EZCANCELFLAG            = '0'
            AND A.GLBL_CMPY_CD            = B.GLBL_CMPY_CD
            AND A.PRC_MTR_PKG_BLLG_MTR_PK = B.PRC_MTR_PKG_BLLG_MTR_PK
            AND B.MTR_LB_CD               = #mtrLbCd#
            AND B.ACTV_FLG                = 'Y'
            AND B.EZCANCELFLAG            = '0'
    </statement>

    <statement id="getBllgMtrLbCdForMach" parameterClass="Map" resultClass="String">
        SELECT
            E.BLLG_MTR_LB_CD
        FROM
             DS_CONTR_DTL  A
            ,DS_CONTR_DTL  B
            ,SVC_MACH_MSTR C
            ,SVC_PHYS_MTR  D
            ,CONTR_PHYS_BLLG_MTR_RELN E
            ,DS_CONTR_DTL_TP F
        WHERE
                A.GLBL_CMPY_CD     = #glblCmpyCd#
            AND A.DS_CONTR_DTL_PK  = #dsContrDtlPk#
            AND A.EZCANCELFLAG     = '0'
            AND A.GLBL_CMPY_CD     = B.GLBL_CMPY_CD
            AND A.DS_CONTR_PK      = B.DS_CONTR_PK
            AND B.EZCANCELFLAG     = '0'
            AND B.GLBL_CMPY_CD     = C.GLBL_CMPY_CD
            AND B.SVC_MACH_MSTR_PK = C.SVC_MACH_MSTR_PK
            AND C.EZCANCELFLAG     = '0'
            AND C.GLBL_CMPY_CD     = D.GLBL_CMPY_CD
            AND C.SVC_MACH_MSTR_PK = D.SVC_MACH_MSTR_PK
            AND D.EZCANCELFLAG     = '0'
            AND D.MDL_MTR_LB_CD    = #mdlMtrLbCd#
            AND D.GLBL_CMPY_CD     = E.GLBL_CMPY_CD
            AND D.SVC_PHYS_MTR_PK  = E.SVC_PHYS_MTR_PK
            AND B.DS_CONTR_DTL_PK  = E.DS_CONTR_DTL_PK
            AND E.EZCANCELFLAG     = '0'
            AND B.GLBL_CMPY_CD       = F.GLBL_CMPY_CD
            AND B.DS_CONTR_DTL_TP_CD = F.DS_CONTR_DTL_TP_CD
            AND F.EZCANCELFLAG       = '0'
            AND F.MAIN_UNIT_LINE_FLG = 'Y'
            AND F.USG_CHRG_FLG       = 'Y'
        GROUP BY
            E.BLLG_MTR_LB_CD
    </statement>
    <statement id="getPrcVldFlg" parameterClass="Map" resultClass="String">
        SELECT
             B.PRC_VLD_FLG
        FROM
             DS_MDL        A
            ,MTR_GRP       B
        WHERE
                A.GLBL_CMPY_CD     = #glblCmpyCd#
            AND A.MDL_ID           = #mdlId#
            AND A.EZCANCELFLAG     = '0'
            AND A.GLBL_CMPY_CD     = B.GLBL_CMPY_CD
            AND A.MTR_GRP_PK       = B.MTR_GRP_PK
            AND B.EZCANCELFLAG     = '0'
    </statement>
<!-- mod start 2016/12/15 CSA Defect#16399 -->
    <statement id="getDsContrBllgSchdPk" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             A.DS_CONTR_BLLG_SCHD_PK
        FROM
             DS_CONTR_BLLG_SCHD A
        WHERE
                A.GLBL_CMPY_CD      = #glblCmpyCd#
            AND A.EZCANCELFLAG      = '0'
            AND A.DS_CONTR_DTL_PK   = #dsContrDtlPk#
            AND A.USG_CHRG_FLG      = 'Y'
            AND A.BLLG_STAGE_FLG    = 'Y'
            AND A.INV_FLG           = 'N'
    </statement>
<!-- mod end 2016/12/15 CSA Defect#16399 -->
<!-- START 2018/04/06 K.Kitachi [QC#23628, ADD] -->
    <statement id="getSvcPkgMapForFltAgg" parameterClass="Map" resultClass="Map">
        SELECT
             C.PRC_MTR_PKG_PK
            ,C.PRC_MTR_PKG_NM
        FROM
            (
                SELECT
                     B.PRC_MTR_PKG_PK
                    ,B.PRC_MTR_PKG_NM
                    ,A.EFF_FROM_DT          AS PKG_MDL_EFF_FROM_DT
                    ,CASE
                        WHEN A.EFF_THRU_DT IS NOT NULL
                            THEN A.EFF_THRU_DT
                            ELSE #endDt#
                     END                    AS PKG_MDL_EFF_THRU_DT
                    ,B.EFF_FROM_DT          AS PKG_EFF_FROM_DT
                    ,CASE
                        WHEN B.EFF_THRU_DT IS NOT NULL
                            THEN B.EFF_THRU_DT
                            ELSE #endDt#
                     END                    AS PKG_EFF_THRU_DT
                FROM
                     DS_CONTR_DTL    X
                    ,SVC_MACH_MSTR   Y
                    ,SVC_CONFIG_MSTR Z
                    ,PRC_MTR_PKG_MDL A
                    ,PRC_MTR_PKG     B
                WHERE
                        X.GLBL_CMPY_CD       =  #glblCmpyCd#
                    AND X.DS_CONTR_PK        =  #dsContrPk#
                    AND X.EZCANCELFLAG       = '0'
                    AND X.GLBL_CMPY_CD       =  Y.GLBL_CMPY_CD
                    AND X.SVC_MACH_MSTR_PK   =  Y.SVC_MACH_MSTR_PK
                    AND Y.EZCANCELFLAG       = '0'
                    AND Y.GLBL_CMPY_CD       =  Z.GLBL_CMPY_CD
                    AND Y.SVC_CONFIG_MSTR_PK =  Z.SVC_CONFIG_MSTR_PK
                    AND Z.EZCANCELFLAG       = '0'
                    AND Z.GLBL_CMPY_CD       =  A.GLBL_CMPY_CD
                    AND Z.MDL_ID             =  A.MDL_ID
                    AND A.EZCANCELFLAG       = '0'
                    AND A.GLBL_CMPY_CD       =  B.GLBL_CMPY_CD
                    AND A.PRC_MTR_PKG_PK     =  B.PRC_MTR_PKG_PK
                    AND B.EZCANCELFLAG       = '0'
            ) C
        WHERE
                C.PKG_MDL_EFF_FROM_DT   &lt;= #slsDt#
            AND C.PKG_MDL_EFF_THRU_DT   &gt;= #slsDt#
            AND C.PKG_EFF_FROM_DT       &lt;= #slsDt#
            AND C.PKG_EFF_THRU_DT       &gt;= #slsDt#
        GROUP BY
             C.PRC_MTR_PKG_PK
            ,C.PRC_MTR_PKG_NM
        ORDER BY
            C.PRC_MTR_PKG_PK
    </statement>
<!-- END 2018/04/06 K.Kitachi [QC#23628, ADD] -->
<!-- START 2018/07/09 K.Kitachi [QC#26834, ADD] -->
    <statement id="getLineMtrNotExstMachMtrInfo" parameterClass="Map" resultClass="Map">
        SELECT
             A.DS_CONTR_PK
            ,A.DS_CONTR_DTL_PK
            ,B.DS_CONTR_BLLG_MTR_PK
            ,B.CONTR_PHYS_BLLG_MTR_RELN_PK
        FROM
             DS_CONTR_DTL             A
            ,CONTR_PHYS_BLLG_MTR_RELN B
        WHERE
                A.GLBL_CMPY_CD       = #glblCmpyCd#
            AND A.DS_CONTR_PK        = #dsContrPk#
            AND A.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCd#
            AND A.EZCANCELFLAG       = '0'
            AND A.GLBL_CMPY_CD       = B.GLBL_CMPY_CD
            AND A.DS_CONTR_DTL_PK    = B.DS_CONTR_DTL_PK
            AND B.EZCANCELFLAG       = '0'
            AND NOT EXISTS (
                SELECT
                    1
                FROM
                     DS_CONTR_DTL             X
                    ,CONTR_PHYS_BLLG_MTR_RELN Y
                WHERE
                        A.GLBL_CMPY_CD    = X.GLBL_CMPY_CD
                    AND A.DS_CONTR_DTL_PK = X.PRNT_DS_CONTR_DTL_PK
                    AND X.EZCANCELFLAG    = '0'
                    AND X.GLBL_CMPY_CD    = Y.GLBL_CMPY_CD
                    AND X.DS_CONTR_DTL_PK = Y.DS_CONTR_DTL_PK
                    AND B.BLLG_MTR_LB_CD  = Y.BLLG_MTR_LB_CD
                    AND Y.EZCANCELFLAG    = '0'
            )
    </statement>
    <statement id="getLineMtrNotExstMachMtrBllgPk" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            A.SVC_CONTR_BLLG_PK
        FROM
            SVC_CONTR_BLLG A
        WHERE
                A.GLBL_CMPY_CD         = #glblCmpyCd#
            AND A.DS_CONTR_BLLG_MTR_PK = #dsContrBllgMtrPk#
            AND A.EZCANCELFLAG         = '0'
        UNION
        SELECT
            B.SVC_CONTR_BLLG_PK
        FROM
             SVC_CONTR_BLLG A
            ,SVC_CONTR_BLLG B
        WHERE
                A.GLBL_CMPY_CD         = #glblCmpyCd#
            AND A.DS_CONTR_BLLG_MTR_PK = #dsContrBllgMtrPk#
            AND A.EZCANCELFLAG         = '0'
            AND A.GLBL_CMPY_CD         = B.GLBL_CMPY_CD
            AND A.SVC_CONTR_BLLG_PK    = B.PRNT_SVC_CONTR_BLLG_PK
            AND B.EZCANCELFLAG         = '0'
    </statement>
<!-- END 2018/07/09 K.Kitachi [QC#26834, ADD] -->
<!-- START 2020/09/24 K.Kitachi [QC#57667, DEL] -->
<!-- QC#55922 Add Start -->
<!--<statement id="getContrPhysBllgMtrRelnByContrDtlPk" parameterClass="Map" resultClass="Map"> -->
<!--    SELECT -->
<!--        A.CONTR_PHYS_BLLG_MTR_RELN_PK -->
<!--        ,A.DS_CONTR_DTL_PK -->
<!--        ,A.MACH_MSTR_PK -->
<!--        ,A.DS_MDL_MTR_PK -->
<!--        ,A.PHYS_MTR_ID -->
<!--        ,A.DS_CONTR_BLLG_MTR_ID -->
<!--        ,A.CONTR_MTR_MULT_RATE -->
<!--        ,A.BLLG_MTR_LB_CD -->
<!--        ,A.DS_CONTR_BLLG_MTR_PK -->
<!--        ,A.SVC_PHYS_MTR_PK -->
<!--        ,A.BLLBL_FLG -->
<!--        ,A.BLLG_MTR_LVL_NUM -->
<!--        ,A.REG_MTR_LB_CD -->
<!--        ,A.ACTV_FLG -->
<!--    FROM -->
<!--        CONTR_PHYS_BLLG_MTR_RELN A -->
<!--    WHERE -->
<!--            A.GLBL_CMPY_CD         = #glblCmpyCd# -->
<!--        AND A.DS_CONTR_DTL_PK      = #dsContrDtlPk# -->
<!--        AND A.EZCANCELFLAG         = '0' -->
<!--    ORDER BY -->
<!--        A.CONTR_PHYS_BLLG_MTR_RELN_PK -->
<!--</statement> -->
<!-- QC#55922 Add End -->
<!-- END 2020/09/24 K.Kitachi [QC#57667, DEL] -->
    <!-- START 2022/06/22 E.Sanchez [QC#59804, ADD] -->
    <statement id="getBllgMtrSchdBySvcPhysMrReadGrpSq" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            A.DS_CONTR_BLLG_SCHD_PK
        FROM
            DS_CONTR_BLLG_SCHD A
        WHERE
                A.GLBL_CMPY_CD             = #glblCmpyCd#
            AND A.SVC_PHYS_MTR_READ_GRP_SQ = #svcPhysMtrReadGrpSq#
            AND A.EZCANCELFLAG             = '0'
    </statement>
    <!-- END 2022/06/22 E.Sanchez [QC#59804, ADD] -->
    <!-- START 2022/10/25 E.Sanchez [QC#60661, ADD] -->
    <statement id="getDsContrBllgMtrPkByContrDtlPk" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            A.DS_CONTR_BLLG_MTR_PK
        FROM
            DS_CONTR_PRC_EFF A
        WHERE
                A.GLBL_CMPY_CD             = #glblCmpyCd#
            AND A.DS_CONTR_DTL_PK          = #dsContrDtlPk#
            AND A.DS_CONTR_BLLG_MTR_PK     IS NOT NULL
            AND A.EZCANCELFLAG             = '0'
    </statement>
    <!-- END 2022/10/25 E.Sanchez [QC#60661, ADD] -->
</sqlMap>
