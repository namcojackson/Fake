<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSAL0360Query">

    <statement id="getDsContrDtlInfo" parameterClass="Map" resultClass="Map">
        SELECT
                DCD.EZUPTIME
               ,DCD.EZUPTIMEZONE
               ,DCD.GLBL_CMPY_CD
               ,DCD.DS_CONTR_PK
               ,DCD.DS_CONTR_DTL_PK
               ,DCD.CONTR_EFF_FROM_DT
               ,DCD.CONTR_EFF_THRU_DT
               ,DCD.MTR_BLLG_LAST_BLLG_DT
               ,DCD.MTR_BLLG_TMG_CD
               ,DCD.MTR_CLO_DAY
               ,DCD.MTR_BLLG_DAY
               ,DCD.MTR_BLLG_CYCLE_CD
               ,DCD.MTR_DPLY_PER_END_DAY
               ,DC.DS_CONTR_NUM
               ,DC.CCY_CD
               ,SMM.SER_NUM
               ,DC.INV_SEPT_BASE_USG_FLG
        FROM
                DS_CONTR_DTL DCD
               ,DS_CONTR DC
               ,SVC_MACH_MSTR SMM
        WHERE
                DCD.GLBL_CMPY_CD         = #glblCmpyCd#
        AND     DCD.DS_CONTR_DTL_PK      = #dsContrDtlPk#
        AND     DCD.GLBL_CMPY_CD         = DC.GLBL_CMPY_CD
        AND     DCD.DS_CONTR_PK          = DC.DS_CONTR_PK
        AND     DCD.GLBL_CMPY_CD         = SMM.GLBL_CMPY_CD(+)
        AND     DCD.SVC_MACH_MSTR_PK     = SMM.SVC_MACH_MSTR_PK(+)
        AND     DCD.EZCANCELFLAG         = '0'
        AND     DC.EZCANCELFLAG          = '0'
        AND     SMM.EZCANCELFLAG(+)      = '0'

    </statement>
    <statement id="getSvcMemo" parameterClass="Map" resultClass="Map">
        SELECT
                SM.EZUPTIME
               ,SM.EZUPTIMEZONE
               ,SM.SVC_MEMO_PK
               ,SM.SVC_MEMO_TP_CD
               ,SM.SVC_CMNT_TXT
               ,SM.SVC_MEMO_RSN_CD
        FROM
                SVC_MEMO SM
        WHERE
                SM.GLBL_CMPY_CD          = #glblCmpyCd#
        AND     SM.DS_CONTR_DTL_PK       = #dsContrDtlPk#
        AND     SM.SVC_MEMO_TP_CD        = #svcMemoTpCd#
        AND     SM.EZCANCELFLAG          = '0'
    </statement>
    
    <statement id="getScheduleInfoList" parameterClass="Map" resultClass="Map">
        SELECT
                DCBSS.EZUPTIME
               ,DCBSS.EZUPTIMEZONE
               ,DCBSS.DS_CONTR_BLLG_SCHD_SMRY_PK
               ,DCBSS.DS_CONTR_BLLG_SCHD_SQ_NUM
               ,DCBSS.DS_CONTR_PRC_EFF_PK
               ,DCBSS.DS_CONTR_PRC_EFF_SQ_NUM
               ,DCBSS.PER_SCHD_NUM
               ,DCBSS.PER_BLLG_CYCLE_CD
               ,DCBSS.BLLG_SCHD_FROM_DT
               ,DCBSS.BLLG_SCHD_THRU_DT
               ,DCBSS.BLLG_CYCLE_CD
               ,BCD.BLLG_CYCLE_DESC_TXT
               ,BCD.BLLG_CYCLE_START_MTH
               ,DCBSS.CCY_CD
               ,DCBSM.EZUPTIME_MTR
               ,DCBSM.EZUPTIMEZONE_MTR
               ,DCBSM.DS_CONTR_BLLG_SCHD_MTR_PK
               ,DCPFM.XS_MTR_COPY_QTY
               ,DCBSM.XS_MTR_COPY_QTY_SMRY
               ,DCBSM.XS_MTR_AMT_RATE
               ,DCBM.GLBL_CMPY_CD
               ,DCBM.DS_CONTR_BLLG_MTR_PK
               ,DCBM.BLLG_MTR_LB_CD
               ,DCBM.BLLG_MTR_BLLG_CYCLE_CD
               ,DCBM.XS_CHRG_TP_CD
               ,ML.MTR_LB_NM
               ,DCBSM.CONTR_XS_COPY_PK
               ,DCBSM.XS_MTR_FIRST_FLG
               ,CASE WHEN
                    (
                        SELECT
                            COUNT(*) INV_CNT
                        FROM
                            DS_CONTR_BLLG_SCHD B
                        WHERE
                                B.GLBL_CMPY_CD               =  DCBSS.GLBL_CMPY_CD
                            AND B.DS_CONTR_DTL_PK            =  DCBSS.DS_CONTR_DTL_PK
                            AND B.DS_CONTR_BLLG_SCHD_SMRY_PK =  DCBSS.DS_CONTR_BLLG_SCHD_SMRY_PK
                            AND B.DS_CONTR_BLLG_MTR_PK       =  DCBSS.DS_CONTR_BLLG_MTR_PK
                            AND B.EZCANCELFLAG               =  '0'
                            AND B.INV_FLG                    =  'Y'
                    ) > 0
                    THEN 'Y'
                    ELSE 'N'
                END INV_FLG
               ,( 
                   SELECT
                           COUNT(*) 
                   FROM
                           DS_CONTR_BLLG_SCHD_MTR A 
                   WHERE
                           A.GLBL_CMPY_CD               = DCBM.GLBL_CMPY_CD 
                   AND     A.DS_CONTR_BLLG_SCHD_SMRY_PK = DCBSS.DS_CONTR_BLLG_SCHD_SMRY_PK
                   AND     A.DS_CONTR_BLLG_MTR_PK       = DCBM.DS_CONTR_BLLG_MTR_PK
                   AND     A.EZCANCELFLAG               = '0'
                 ) AS XX_DTL_CNT
               ,BC.BLLG_CYCLE_UOM_CD
<!-- START 2016/12/01 [QC#14204, ADD] -->
               ,DCBSS.EZINTIME          AS XX_REC_HIST_CRAT_TS
               ,DCBSS.EZINUSERID        AS XX_REC_HIST_CRAT_BY_NM
               ,DCBSS.EZUPTIME          AS XX_REC_HIST_UPD_TS
               ,DCBSS.EZUPUSERID        AS XX_REC_HIST_UPD_BY_NM
               ,DCBSS.EZTABLEID         AS XX_REC_HIST_TBL_NM
<!-- END 2016/12/01 [QC#14204, ADD] -->
        FROM
                DS_CONTR_PRC_EFF        DCPF
               ,(
                    SELECT
                         ROWNUM             AS PRC_EFF_MTR_SQ
                        ,XS_MTR_COPY_QTY
                        ,DS_CONTR_PRC_EFF_MTR_PK
                    FROM
                        DS_CONTR_PRC_EFF_MTR A        
                    WHERE
                            A.GLBL_CMPY_CD          = #glblCmpyCd#
                        AND A.EZCANCELFLAG          = '0'
                        AND A.DS_CONTR_PRC_EFF_PK   = #dsContrPrcEffPk#
                    ORDER BY
                         A.XS_MTR_COPY_QTY
                ) DCPFM
               ,DS_CONTR_BLLG_SCHD_SMRY DCBSS
               ,(
                    SELECT
                        RANK()OVER(PARTITION BY B.DS_CONTR_BLLG_SCHD_SMRY_PK ORDER BY B.XS_MTR_COPY_QTY) AS SCHD_MTR_SQ
                       ,B.EZUPTIME                          AS EZUPTIME_MTR
                       ,B.EZUPTIMEZONE                      AS EZUPTIMEZONE_MTR
                       ,B.DS_CONTR_BLLG_SCHD_SMRY_PK
                       ,B.DS_CONTR_BLLG_SCHD_MTR_PK
                       ,B.XS_MTR_COPY_QTY                   AS XS_MTR_COPY_QTY_SMRY
                       ,B.XS_MTR_AMT_RATE
<!-- START 2020/03/18 K.Kitachi [QC#55693, MOD] -->
<!--                   ,B.CONTR_XS_COPY_PK -->
                       ,C.CONTR_XS_COPY_PK
<!-- END 2020/03/18 K.Kitachi [QC#55693, MOD] -->
                       ,B.XS_MTR_FIRST_FLG
                    FROM
                        DS_CONTR_BLLG_SCHD_MTR B        
<!-- START 2020/03/18 K.Kitachi [QC#55693, ADD] -->
                        ,DS_CONTR_PRC_EFF_MTR  C
<!-- END 2020/03/18 K.Kitachi [QC#55693, ADD] -->
                    WHERE
                            B.GLBL_CMPY_CD          = #glblCmpyCd#
                        AND B.EZCANCELFLAG          = '0'
                        AND B.DS_CONTR_BLLG_SCHD_SMRY_PK IN (
                                SELECT
                                        C.DS_CONTR_BLLG_SCHD_SMRY_PK
                                    FROM
                                        DS_CONTR_BLLG_SCHD_SMRY    C
                                    WHERE
                                            C.GLBL_CMPY_CD          = #glblCmpyCd#
                                        AND C.EZCANCELFLAG          = '0'
                                        AND C.DS_CONTR_PRC_EFF_PK   = #dsContrPrcEffPk#
                                )
<!-- START 2020/03/18 K.Kitachi [QC#55693, ADD] -->
                        AND B.GLBL_CMPY_CD          = C.GLBL_CMPY_CD
                        AND B.CONTR_XS_COPY_PK      = C.DS_CONTR_PRC_EFF_MTR_PK
                        AND C.EZCANCELFLAG          = '0'
<!-- END 2020/03/18 K.Kitachi [QC#55693, ADD] -->
                    ORDER BY
                         DS_CONTR_BLLG_SCHD_SMRY_PK
                        ,SCHD_MTR_SQ
                ) DCBSM
               ,DS_CONTR_BLLG_MTR       DCBM
               ,MTR_LB                  ML
               ,BLLG_CYCLE              BC
               ,BLLG_CYCLE              BCD
        WHERE
                DCPF.GLBL_CMPY_CD                  = #glblCmpyCd#
        AND     DCPF.DS_CONTR_PRC_EFF_PK           = #dsContrPrcEffPk#
        AND     DCPF.EZCANCELFLAG                  = '0'
        AND     DCPF.GLBL_CMPY_CD                  = DCBSS.GLBL_CMPY_CD
        AND     DCPF.DS_CONTR_DTL_PK               = DCBSS.DS_CONTR_DTL_PK
        AND     DCPF.DS_CONTR_PRC_EFF_PK           = DCBSS.DS_CONTR_PRC_EFF_PK
        AND     DCBSS.USG_CHRG_FLG                 = 'Y'
        AND     DCBSS.EZCANCELFLAG                 = '0'
        AND     DCBSS.DS_CONTR_BLLG_SCHD_SMRY_PK   = DCBSM.DS_CONTR_BLLG_SCHD_SMRY_PK  (+)
        AND     DCBSM.SCHD_MTR_SQ                  = DCPFM.PRC_EFF_MTR_SQ
        AND     DCBSS.GLBL_CMPY_CD                 = DCBM.GLBL_CMPY_CD
        AND     DCBSS.DS_CONTR_BLLG_MTR_PK         = DCBM.DS_CONTR_BLLG_MTR_PK
        AND     DCBM.EZCANCELFLAG                  = '0'
        AND     DCBM.GLBL_CMPY_CD                  = ML.GLBL_CMPY_CD
        AND     DCBM.BLLG_MTR_LB_CD                = ML.MTR_LB_CD
        AND     ML.EZCANCELFLAG                    = '0'
        AND     DCBSS.GLBL_CMPY_CD                 = BC.GLBL_CMPY_CD
        AND     DCBSS.PER_BLLG_CYCLE_CD            = BC.BLLG_CYCLE_CD
        AND     BC.EZCANCELFLAG                    = '0'
        AND     DCBSS.GLBL_CMPY_CD                 = BCD.GLBL_CMPY_CD
        AND     DCBSS.BLLG_CYCLE_CD                = BCD.BLLG_CYCLE_CD
        AND     BCD.EZCANCELFLAG                   = '0'
        ORDER BY
                DCBM.DS_CONTR_BLLG_MTR_PK
               ,DCBSS.BLLG_SCHD_FROM_DT
               ,DCBSM.XS_MTR_COPY_QTY_SMRY
    </statement>
    
    <statement id="getMtrInfoList" parameterClass="Map" resultClass="Map">
        SELECT
                DCBM.DS_CONTR_BLLG_MTR_PK
               ,DCBM.DS_CONTR_BLLG_MTR_ID
               ,DCBM.BLLG_MTR_LB_CD
               ,DCBM.BLLG_MTR_BILL_TO_CUST_CD
               ,DCBM.BLLG_MTR_BLLG_CYCLE_CD
               ,DCBM.XS_CHRG_TP_CD
               ,ML.MTR_LB_NM
        FROM
                DS_CONTR_BLLG_MTR DCBM
               ,MTR_LB ML
        WHERE
                DCBM.GLBL_CMPY_CD                = #glblCmpyCd#
        AND     DCBM.DS_CONTR_DTL_PK             = #dsContrDtlPk#
        AND     DCBM.GLBL_CMPY_CD                = ML.GLBL_CMPY_CD(+)
        AND     DCBM.BLLG_MTR_LB_CD              = ML.MTR_LB_CD(+)
        AND     DCBM.EZCANCELFLAG                = '0'
        AND     ML.EZCANCELFLAG(+)               = '0'
        ORDER BY
                LPAD(DCBM.DS_CONTR_BLLG_MTR_ID, 2, '0')
    </statement>
    
    
    <statement id="getContrXsCopyList" parameterClass="Map" resultClass="Map">
        SELECT
             A.DS_CONTR_BLLG_MTR_PK
            ,E.MTR_LB_NM
            ,A.DS_CONTR_PRC_EFF_PK
            ,A.DS_CONTR_PRC_EFF_SQ_NUM
            ,A.BLLG_CYCLE_CD
            ,C.BLLG_CYCLE_DESC_TXT
            ,C.BLLG_CYCLE_START_MTH
            ,B.XS_MTR_COPY_QTY
            ,B.XS_MTR_AMT_RATE
            ,A.CCY_CD
            ,B.CONTR_XS_COPY_PK
            ,B.XS_MTR_FIRST_FLG
        FROM
             DS_CONTR_PRC_EFF     A
            ,DS_CONTR_PRC_EFF_MTR B
            ,BLLG_CYCLE           C
            ,DS_CONTR_BLLG_MTR    D
            ,MTR_LB               E
            ,(
                SELECT
                     X.DS_CONTR_DTL_PK
                    ,X.CONTR_PRC_EFF_FROM_DT
                    ,X.CONTR_PRC_EFF_THRU_DT
                FROM
                    DS_CONTR_PRC_EFF           X
                WHERE
                        X.GLBL_CMPY_CD         = #glblCmpyCd#
                    AND X.DS_CONTR_PRC_EFF_PK  = #dsContrPrcEffPk#
                    AND X.EZCANCELFLAG         = '0'
             ) F
        WHERE
                A.GLBL_CMPY_CD         = #glblCmpyCd#
            AND A.DS_CONTR_BLLG_MTR_PK = #dsContrBllgMtrPk#
            AND A.EZCANCELFLAG         = '0'
            AND A.GLBL_CMPY_CD         = B.GLBL_CMPY_CD
            AND A.DS_CONTR_PRC_EFF_PK  = B.DS_CONTR_PRC_EFF_PK
            AND B.EZCANCELFLAG         = '0'
            AND A.GLBL_CMPY_CD         = C.GLBL_CMPY_CD
            AND A.BLLG_CYCLE_CD        = C.BLLG_CYCLE_CD
            AND C.EZCANCELFLAG         = '0'
            AND A.GLBL_CMPY_CD         = D.GLBL_CMPY_CD
            AND A.DS_CONTR_BLLG_MTR_PK = D.DS_CONTR_BLLG_MTR_PK
            AND D.EZCANCELFLAG         = '0'
            AND D.GLBL_CMPY_CD         = E.GLBL_CMPY_CD
            AND D.BLLG_MTR_LB_CD       = E.MTR_LB_CD
            AND E.EZCANCELFLAG         = '0'
            AND A.DS_CONTR_DTL_PK      = F.DS_CONTR_DTL_PK
            AND A.CONTR_PRC_EFF_FROM_DT &gt;= F.CONTR_PRC_EFF_FROM_DT
            AND A.CONTR_PRC_EFF_THRU_DT &lt;= F.CONTR_PRC_EFF_THRU_DT
        ORDER BY
            B.DS_CONTR_PRC_EFF_MTR_PK
    </statement>
    <!-- START 2017/12/12 U.Kim [QC#18879, ADD]-->
    <statement id="getBllgDays" parameterClass="Map" resultClass="BigDecimal">
         SELECT
             BDT.BLLG_DAYS_AOT
        FROM
             BLLG_DAY_TP   BDT
            ,DS_CONTR_DTL  DCD
            
        WHERE
                BDT.GLBL_CMPY_CD     = #glblCmpyCd#
            AND BDT.USG_CHRG_FLG     = #flgOn#
            AND BDT.EZCANCELFLAG     = '0'
            AND BDT.GLBL_CMPY_CD     = DCD.GLBL_CMPY_CD
            AND BDT.BLLG_TMG_TP_CD   = DCD.MTR_BLLG_TMG_CD
            AND DCD.DS_CONTR_DTL_PK  = #dsContrDtlPk#
            AND DCD.EZCANCELFLAG     = '0'
        ORDER BY
            BDT.BLLG_DAY_TP_SORT_NUM  ASC
    </statement>
<!-- END 2017/12/12 U.Kim [QC#18879, ADD]-->
    
</sqlMap>
