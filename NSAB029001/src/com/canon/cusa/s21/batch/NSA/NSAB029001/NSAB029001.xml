<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSAB029001">
    <statement id="getInputData" parameterClass="Map" resultClass="Map">
        SELECT
             A.CFS_INV_INTFC_PK
            ,A.PROC_DT
            ,A.INV_NUM
            ,A.CFS_LEASE_PBL_NUM
            ,A.INV_LINE_NUM
            ,A.CSA_INV_NUM
            ,A.CSA_CONTR_NUM
            ,A.CSA_CONTR_MOD_TXT
            ,A.CFS_SER_NUM
            ,A.INV_TOT_DEAL_NET_AMT
            ,A.BLLG_PER_FROM_DT
            ,A.BLLG_PER_THRU_DT
            ,A.CFS_BLLG_TP_TXT
            ,A.CFS_LEASE_NUM
            ,A.END_CUST_NM
            ,A.DS_ACCT_DLR_CD
            ,A.INV_DT
            ,A.ORG_CD
            ,A.BLLG_MTR_LB_NM
            ,A.FTR_FLG_ORIG_TXT
            ,A.CM_FLG_ORIG_TXT
            ,A.CFS_INV_PROC_STS_CD
            ,A.INTFC_ERR_MSG_TXT
            ,A.DS_CONTR_NUM
            ,A.CSA_DS_CONTR_MOD_TXT
            ,A.DS_CONTR_PK
            ,A.USG_ITEM_CD
            ,A.SVC_ITEM_CD
            ,A.FTR_ITEM_CD
            ,A.DFRD_ACCTG_RULE_CD
            ,A.DFRD_INV_RULE_CD
            ,A.BILL_TO_CUST_ACCT_CD
            ,A.BILL_TO_LOC_NUM
            ,A.SHIP_TO_CUST_ACCT_CD
            ,A.SHIP_TO_LOC_NUM
            ,A.SVC_LINE_CONTR_DTL_PK
            ,A.USG_LINE_CONTR_DTL_PK
            ,A.UOM_CD
            ,A.BILL_TO_CUST_CD
            ,A.DS_INV_TP_CD
            ,A.CONTR_VRSN_EFF_FROM_DT
            ,A.CFS_FLEET_FLG
            ,A.CFS_INV_BAT_NUM
            ,B.DS_CONTR_SQ_NUM
            ,B.DS_CONTR_CATG_CD
            ,B.TOC_CD
            ,B.DS_ACCT_NUM
            ,B.SVC_LINE_BIZ_CD
            ,C.DS_CONTR_DTL_PK
            ,C.SVC_CONFIG_MSTR_PK
            ,C.SVC_MACH_MSTR_PK
            <!-- START 2018/02/13 [QC#21872, ADD] -->
            ,CASE A.CFS_BLLG_TP_TXT
                 WHEN #base# THEN
                     NVL(D2.CUST_PO_NUM, NVL(D1.CUST_PO_NUM, D.CUST_PO_NUM))
                 WHEN #usage# THEN
                     NVL(D3.CUST_PO_NUM, NVL(D1.CUST_PO_NUM, D.CUST_PO_NUM))
                 ELSE
                     NVL(D1.CUST_PO_NUM, D.CUST_PO_NUM)
             END CUST_PO_NUM
            ,CASE A.CFS_BLLG_TP_TXT
                 WHEN #base# THEN
                     NVL(D2.PO_DT, NVL(D1.PO_DT, D.PO_DT))
                 WHEN #usage# THEN
                     NVL(D3.PO_DT, NVL(D1.PO_DT, D.PO_DT))
                 ELSE
                     NVL(D1.CUST_PO_NUM, D.PO_DT)
             END PO_DT
            ,D3.DS_CONTR_BLLG_MTR_PK
            <!-- END   2018/02/13 [QC#21872, ADD] -->
            ,E.SVC_INV_PK
            ,E.CONTR_RNW_TOT_CNT
            ,E.BILL_TO_CUST_CD BILL_TO_CUST_CD_INV
            ,E.BILL_TO_CUST_ACCT_CD BILL_TO_CUST_ACCT_CD_INV
            ,F.ESPAC_LINE_SHIP_QTY
            ,F.SVC_INV_LINE_PK
            ,F.MDSE_CD
            ,F.MDL_ID
            <!-- 2017/11/15 QC#21956-2 add start -->
            ,G.LOC_NM
            ,G.ADDL_LOC_NM
            ,G.FIRST_LINE_ADDR
            ,G.SCD_LINE_ADDR
            ,G.THIRD_LINE_ADDR
            ,G.FRTH_LINE_ADDR
            ,G.CTY_ADDR
            ,G.PROV_NM
            ,G.ST_CD
            ,G.POST_CD
            ,G.CTRY_CD
            ,G.FIRST_REF_CMNT_TXT
            ,G.SCD_REF_CMNT_TXT
            ,H.CNTY_NM
            <!-- 2017/11/15 QC#21956-2 add end -->
        FROM
             CFS_INV_INTFC          A
            ,DS_CONTR               B
            ,DS_CONTR_DTL           C
            ,DS_CONTR_CR_CARD_PO    D
            <!-- START 2018/02/13 [QC#21872, ADD] -->
            ,DS_CONTR_CR_CARD_PO    D1
            ,DS_CONTR_CR_CARD_PO    D2
            ,DS_CONTR_CR_CARD_PO    D3
            <!-- END   2018/02/13 [QC#21872, ADD] -->
            ,INV                    E
            ,INV_LINE               F
            <!-- 2017/11/15 QC#21956-2 add start -->
            ,SHIP_TO_CUST           G
            ,CNTY                   H
            <!-- 2017/11/15 QC#21956-2 add end -->
        WHERE
                A.GLBL_CMPY_CD       = #glblCmpyCd#
            <iterate property="cfsInvProcStsCdList" var="cfsInvProcStsCdList[]" open=" AND A.CFS_INV_PROC_STS_CD IN (" close=")" conjunction=",">
                  #cfsInvProcStsCdList[]#
            </iterate>
            AND A.EZCANCELFLAG       = '0'
            AND A.GLBL_CMPY_CD       = B.GLBL_CMPY_CD
            AND A.DS_CONTR_PK        = B.DS_CONTR_PK
            AND B.EZCANCELFLAG       = '0'
            AND B.GLBL_CMPY_CD       = C.GLBL_CMPY_CD
            AND B.DS_CONTR_PK        = C.DS_CONTR_PK
            AND C.EZCANCELFLAG       = '0'

            <!-- START 2018/02/13 [QC#21872, MOD] -->
            AND C.GLBL_CMPY_CD              = D.GLBL_CMPY_CD(+)
            AND C.DS_CONTR_PK               = D.DS_CONTR_PK(+)
            AND D.PO_DT(+)              &gt;= A.BLLG_PER_FROM_DT
            AND D.DS_CONTR_MACH_LVL_NUM(+)  = #dsContrMachlvlNum1#
            AND D.EZCANCELFLAG(+)           = '0'

            AND C.GLBL_CMPY_CD              = D1.GLBL_CMPY_CD(+)
            AND C.DS_CONTR_PK               = D1.DS_CONTR_PK(+)
            AND C.DS_CONTR_DTL_PK           = D1.DS_CONTR_DTL_PK(+)
            AND D1.PO_DT(+)             &gt;= A.BLLG_PER_FROM_DT
            AND D1.DS_CONTR_MACH_LVL_NUM(+) = #dsContrMachlvlNum2#
            AND D1.EZCANCELFLAG(+)          = '0'

            AND C.GLBL_CMPY_CD              = D2.GLBL_CMPY_CD(+)
            AND C.DS_CONTR_PK               = D2.DS_CONTR_PK(+)
            AND C.DS_CONTR_DTL_PK           = D2.DS_CONTR_DTL_PK(+)
            AND D2.DS_CONTR_BLLG_MTR_PK(+)  IS NULL
            AND D2.PO_DT(+)             &gt;= A.BLLG_PER_FROM_DT
            AND D2.DS_CONTR_MACH_LVL_NUM(+) = #dsContrMachlvlNum3#
            AND D2.EZCANCELFLAG(+)          = '0'

            AND C.GLBL_CMPY_CD              = D3.GLBL_CMPY_CD(+)
            AND C.DS_CONTR_PK               = D3.DS_CONTR_PK(+)
            AND C.DS_CONTR_DTL_PK           = D3.DS_CONTR_DTL_PK(+)
            AND D3.DS_CONTR_BLLG_MTR_PK(+)  = A.USG_LINE_CONTR_DTL_PK
            AND D3.PO_DT(+)             &gt;= A.BLLG_PER_FROM_DT
            AND D3.DS_CONTR_MACH_LVL_NUM(+) = #dsContrMachlvlNum3#
            AND D3.EZCANCELFLAG(+)          = '0'
            <!-- END   2018/02/13 [QC#21872, MOD] -->

            AND A.GLBL_CMPY_CD         = E.GLBL_CMPY_CD
            AND A.CSA_INV_NUM          = E.INV_NUM
            AND E.EZCANCELFLAG         = '0'
            AND E.GLBL_CMPY_CD         = F.GLBL_CMPY_CD
            AND E.INV_NUM              = F.INV_NUM
            AND C.DS_CONTR_DTL_PK      = F.DS_CONTR_DTL_PK
            AND F.INV_BOL_LINE_NUM     = #invBolLineNum#
            AND F.INV_LINE_NUM         = #invLineNum#
            AND F.INV_LINE_SUB_NUM     = #invLineSubNum#
            AND F.INV_LINE_SUB_TRX_NUM = #invTrxLineSubNum#
            AND F.EZCANCELFLAG         = '0'
            <!-- 2017/11/15 QC#21956-2 add start -->
            AND A.GLBL_CMPY_CD         = G.GLBL_CMPY_CD (+)
            AND A.SHIP_TO_LOC_NUM      = G.SHIP_TO_CUST_CD (+)
            AND G.EZCANCELFLAG (+)     = '0'
            AND G.GLBL_CMPY_CD         = H.GLBL_CMPY_CD (+)
            AND G.CNTY_PK              = H.CNTY_PK (+)
            AND H.EZCANCELFLAG (+)     = '0'
            <!-- 2017/11/15 QC#21956-2 add end -->
        ORDER BY
            A.EZUPTIME
    </statement>

    <statement id="getUsageData" parameterClass="Map" resultClass="Map">
        SELECT
             A.DS_CONTR_BLLG_MTR_PK
        FROM
             DS_CONTR_BLLG_MTR      A
        WHERE
                A.GLBL_CMPY_CD         = #glblCmpyCd#
            AND A.DS_CONTR_DTL_PK      = #dsContrDtlPk#
            AND A.INTG_MDSE_CD         = #intgMdseCd#
            AND G.EZCANCELFLAG(+)      = '0'
    </statement>

    <statement id="getBillToCustCd" parameterClass="Map" resultClass="String">
        SELECT 
             BTC.BILL_TO_CUST_CD
        FROM 
             SELL_TO_CUST       STC
            ,BILL_TO_CUST       BTC
        WHERE
                STC.GLBL_CMPY_CD    = #glblCmpyCd#
            AND STC.SELL_TO_CUST_CD = #dsAcctNum#
            AND STC.EZCANCELFLAG    = '0'
            AND STC.GLBL_CMPY_CD    = BTC.GLBL_CMPY_CD
            AND STC.LOC_NUM         = BTC.LOC_NUM
            AND BTC.EZCANCELFLAG    = '0'
    </statement>
<!-- START 2017/09/04 K.Kim [QC#20895, ADD] -->
    <statement id="getPmtTermCd" parameterClass="Map" resultClass="String">
        SELECT
             A.PMT_TERM_CD
        FROM
             PMT_TERM_CASH_DISC     A
        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            AND A.PMT_TERM_CASH_DISC_CD = #pmtTermCashDiscCd#
            AND A.EZCANCELFLAG          = '0'
    </statement>
<!-- END 2017/09/04 K.Kim [QC#20895, ADD] -->

<!-- START 2018/04/18 M.Naito [QC#23378, MOD] -->
    <statement id="getContrAlloc" parameterClass="Map" resultClass="Map">
        SELECT
             A.COA_CMPY_CD
            ,A.COA_AFFL_CD
            ,A.COA_BR_CD
            ,A.COA_CH_CD
            ,A.COA_CC_CD
            ,A.COA_ACCT_CD
            ,A.COA_PROD_CD
            ,A.COA_PROJ_CD
            ,A.COA_EXTN_CD
            ,A.PRC_ALLOC_RATE
            ,A.PRC_ALLOC_AMT
        FROM
             DS_CONTR_PRC_ALLOC        A
        WHERE
                A.GLBL_CMPY_CD                  =  #glblCmpyCd#
            AND A.EZCANCELFLAG                  =  '0'
            AND A.DS_CONTR_PK                   =  #dsContrPk#
            <isNotNull property="dsContrDtlPk">
            AND A.DS_CONTR_DTL_PK               =  #dsContrDtlPk#
            </isNotNull>
            <isNotNull property="svcInvChrgTpCd">
            AND A.SVC_INV_CHRG_TP_CD            =  #svcInvChrgTpCd#
            </isNotNull>
            <isNull property="svcInvChrgTpCd">
            AND A.SVC_INV_CHRG_TP_CD            IS NULL
            </isNull>
    </statement>
<!-- END 2018/04/18 M.Naito [QC#23378, MOD] -->
</sqlMap>
