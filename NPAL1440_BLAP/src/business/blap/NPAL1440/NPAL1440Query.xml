<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NPAL1440Query">
    <statement id="search" parameterClass="Map"
        resultClass="Map">
        SELECT
            PR.PRCH_REQ_NUM
            ,PRT.PRCH_REQ_TP_DESC_TXT
            ,PR.PRCH_REQ_CRAT_DT
            ,PRS.PRCH_REQ_STS_DESC_TXT
            ,NVL(SPV1.FULL_PSN_NM, PR.PRCH_REQ_CRAT_BY_PSN_CD) AS FULL_PSN_NM_H
            ,PRBPL.PRCH_REQ_LINE_NUM
            ,PRBPL.PRCH_REQ_LINE_SUB_NUM
            ,PRBPL.EZINTIME
            ,NVL(SPV2.FULL_PSN_NM, PRBPL.EZINUSERID) AS FULL_PSN_NM_D
            ,PRBPL.EZINAPLID
            ,PRBPL.PRCH_REQ_LOG_MODE_TXT
            ,PRBPL.PRCH_REQ_LOG_EVENT_TXT
            ,PRAS.PRCH_REQ_APVL_STS_DESC_TXT
            ,PRLS.PRCH_REQ_LINE_STS_DESC_TXT
            ,PRBPL.MDSE_CD
            ,DMI.MDSE_DESC_SHORT_TXT
            ,PRBPL.PRCH_REQ_QTY
            ,PT.PROCR_TP_DESC_TXT
            ,DECODE(PRBPL.PROCR_TP_CD, #procrTpCd#, RW.RTL_WH_NM, PV.PRNT_VND_NM) AS PRNT_VND_NM
            ,DECODE(PRBPL.PROCR_TP_CD, #procrTpCd#, PRBPL.SRC_RTL_SWH_CD, VND.LOC_NM) AS LOC_NM
            ,PRBPL.PRCH_REQ_FRZ_FLG
            ,PRBPL.SHIP_QTY
            ,PRBPL.RWS_PUT_AWAY_QTY
            <!-- Add Start QC#63476 -->
            ,CASE WHEN PRBPL.RWS_PUT_AWAY_QTY > 0 THEN (
                SELECT
                    CONCAT (SP.PSN_FIRST_NM, CONCAT (' ', SP.PSN_LAST_NM))
                    FROM
                        RWS_HDR RH
                       ,CLICK_TECH_RCV_PRT CTRP
                       ,S21_PSN SP
                    WHERE 
                        PRBPL.GLBL_CMPY_CD = RH.GLBL_CMPY_CD
                    AND PRBPL.RWS_NUM = RH.RWS_NUM
                    AND (
                        RH.IMPT_INV_BOL_NUM = CTRP.CLICK_TRK_NUM
                        OR
                        RH.SHIP_FROM_SO_NUM = CTRP.CLICK_TRK_NUM
                        OR
                        RH.RWS_REF_NUM      = CTRP.CLICK_TRK_NUM
                    )
                    AND CTRP.RWS_DT_TM_CLO_TXT IS NOT NULL
                    AND CTRP.EZCANCELFLAG = '0'
                    AND PRBPL.GLBL_CMPY_CD = SP.GLBL_CMPY_CD
                    AND CTRP.TECH_CD = SP.PSN_CD
                    AND SP.EZCANCELFLAG = '0' AND ROWNUM = 1
             ) ELSE NULL
             END AS TECH_CD
            <!-- Add End QC#63476 -->
        FROM
            PRCH_REQ_BIZ_PROC_LOG PRBPL
            ,PRCH_REQ PR
            ,PRCH_REQ_TP PRT
            ,PRCH_REQ_STS PRS
            ,S21_PSN_V SPV1
            ,S21_PSN_V SPV2
            ,PRCH_REQ_APVL_STS PRAS
            ,PRCH_REQ_LINE_STS PRLS
            ,MDSE DMI
            ,PROCR_TP PT
            ,RTL_WH RW
            ,PRNT_VND PV
            ,VND VND
        WHERE
                PRBPL.GLBL_CMPY_CD = #glblCmpyCd#
            AND PRBPL.PRCH_REQ_NUM = #prchReqNum#
            AND PRBPL.PRCH_REQ_LINE_NUM = #prchReqLineNum#
             <!-- Add Start QC#63476 -->
                <!-- <isNotNull property="prchReqLineSubNum">
                    AND PRBPL.PRCH_REQ_LINE_SUB_NUM = #prchReqLineSubNum#
                </isNotNull>
                -->
             <!-- Add End QC#63476 -->
            AND PRBPL.EZCANCELFLAG = '0'
            AND PRBPL.GLBL_CMPY_CD = PR.GLBL_CMPY_CD
            AND PRBPL.PRCH_REQ_NUM = PR.PRCH_REQ_NUM
            AND PR.EZCANCELFLAG = '0'
            AND PR.GLBL_CMPY_CD = PRT.GLBL_CMPY_CD
            AND PR.PRCH_REQ_TP_CD = PRT.PRCH_REQ_TP_CD
            AND PRT.EZCANCELFLAG = '0'
            AND PR.GLBL_CMPY_CD = PRS.GLBL_CMPY_CD
            AND PR.PRCH_REQ_STS_CD = PRS.PRCH_REQ_STS_CD
            AND PRS.EZCANCELFLAG = '0'
            AND PR.GLBL_CMPY_CD = SPV1.GLBL_CMPY_CD(+)
            AND PR.PRCH_REQ_CRAT_BY_PSN_CD = SPV1.PSN_CD(+)
            AND SPV1.EZCANCELFLAG(+) = '0'
            AND PRBPL.GLBL_CMPY_CD = SPV2.GLBL_CMPY_CD(+)
            AND PRBPL.EZINUSERID = SPV2.PSN_CD(+)
            AND SPV2.EZCANCELFLAG(+) = '0'
            AND PRBPL.GLBL_CMPY_CD = PRAS.GLBL_CMPY_CD
            AND PRBPL.PRCH_REQ_APVL_STS_CD = PRAS.PRCH_REQ_APVL_STS_CD
            AND PRAS.EZCANCELFLAG = '0'
            AND PRBPL.GLBL_CMPY_CD = PRLS.GLBL_CMPY_CD
            AND PRBPL.PRCH_REQ_LINE_STS_CD = PRLS.PRCH_REQ_LINE_STS_CD
            AND PRLS.EZCANCELFLAG = '0'
            AND PRBPL.GLBL_CMPY_CD = DMI.GLBL_CMPY_CD
            AND PRBPL.MDSE_CD = DMI.MDSE_CD
            AND DMI.EZCANCELFLAG = '0'
            AND PRBPL.GLBL_CMPY_CD = PT.GLBL_CMPY_CD
            AND PRBPL.PROCR_TP_CD = PT.PROCR_TP_CD
            AND PT.EZCANCELFLAG = '0'
            AND PRBPL.GLBL_CMPY_CD = RW.GLBL_CMPY_CD (+)
            AND PRBPL.SRC_RTL_WH_CD = RW.RTL_WH_CD (+)
            AND RW.EZCANCELFLAG (+) = '0'
            AND PRBPL.PRNT_VND_CD = PV.PRNT_VND_CD (+)
            AND PRBPL.GLBL_CMPY_CD = PV.GLBL_CMPY_CD (+)
            AND PV.EZCANCELFLAG (+) = '0'
            AND PRBPL.VND_CD = VND.VND_CD (+)
            AND PRBPL.GLBL_CMPY_CD = VND.GLBL_CMPY_CD (+)
            AND VND.EZCANCELFLAG (+) = '0'
            
            
        ORDER BY
            PRBPL.EZINTIME
            <!-- Add Start QC#63476 -->
            ,PRBPL.PRCH_REQ_LINE_NUM
            ,PRBPL.PRCH_REQ_LINE_SUB_NUM
            <!-- ,PRBPL.PRCH_REQ_BIZ_PROC_LOG_PK -->
            <!-- Add End QC#63476 -->
    </statement>
</sqlMap>