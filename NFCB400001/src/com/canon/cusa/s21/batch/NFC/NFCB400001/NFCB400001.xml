<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NFCB400001">
    <statement id="getCompInfo" parameterClass="Map" resultClass="Map">
    WITH COMP_INFO AS (
        SELECT
             D.CPO_ORD_NUM              AS CPO_ORD_NUM
            ,F.DS_ORD_POSN_NUM          AS DS_ORD_POSN_NUM
            ,F.CPO_DTL_LINE_NUM         AS CPO_DTL_LINE_NUM
            ,F.CPO_DTL_LINE_SUB_NUM     AS CPO_DTL_LINE_SUB_NUM
            ,CASE
                 WHEN ACCT_COUNT.COUNT &gt; 0 THEN 'N'
                 ELSE 'Y'
             END                        AS NEW_CUST_FLG
            ,H.BILL_TO_CUST_ACCT_CD     AS BILL_TO_CUST_ACCT_CD
            ,M.DS_ACCT_NM               AS BILL_TO_CUST_ACCT_NM
            ,H.SHIP_TO_CUST_ACCT_CD     AS SHIP_TO_CUST_ACCT_CD
            ,N.DS_ACCT_NM               AS SHIP_TO_CUST_ACCT_NM
            ,H.BILL_TO_CUST_ACCT_CD     AS CR_CUST_CD
            ,CASE
                 WHEN LEASE_COUNT.COUNT &gt; 0 THEN 'Y'
                 ELSE 'N'
             END                        AS LEASE_FLG
            ,H.SVC_CONFIG_MSTR_PK       AS SVC_CONFIG_MSTR_PK
            ,CASE
                 WHEN #month01# &lt;= SUBSTR(A.INV_DT, 5, 2) AND SUBSTR(A.INV_DT, 5, 2) &lt;= #month03# THEN #qtr01#
                 WHEN #month04# &lt;= SUBSTR(A.INV_DT, 5, 2) AND SUBSTR(A.INV_DT, 5, 2) &lt;= #month06# THEN #qtr02#
                 WHEN #month07# &lt;= SUBSTR(A.INV_DT, 5, 2) AND SUBSTR(A.INV_DT, 5, 2) &lt;= #month09# THEN #qtr03#
                 WHEN #month10# &lt;= SUBSTR(A.INV_DT, 5, 2) AND SUBSTR(A.INV_DT, 5, 2) &lt;= #month12# THEN #qtr04#
             END                        AS COMP_QTR_CD
            ,SUBSTR(D.CPO_ORD_TS, 1, 8) AS ORD_DT
            ,SUBSTR(D.ORD_BOOK_TS, 1, 8) 
                                        AS ORD_BOOK_DT
            ,SUBSTR(RTRN.CPO_ORD_TS, 1, 8) 
                                        AS ORD_RTRN_DT
            ,A.INV_DT                   AS INV_DT
            ,A.INV_NUM                  AS INV_NUM
            ,B.INV_LINE_NUM             AS INV_LINE_NUM
            ,B.INV_LINE_SUB_NUM         AS INV_LINE_SUB_NUM
            ,SLS_REP.PSN_CD             AS SLS_REP_PSN_CD
            ,NVL(INST_REP.PSN_CD, SLS_REP.PSN_CD)
                                        AS ISTL_REP_PSN_CD
            ,B.MDSE_CD                  AS MDSE_CD
            ,I.MDSE_DESC_SHORT_TXT      AS MDSE_DESC_SHORT_TXT
            ,J.T_MDL_NM                 AS T_MDL_NM
            ,L.SER_NUM                  AS SER_NUM
            ,CASE
                 WHEN RMNF_COUNT.COUNT &gt; 0 THEN 0
                 ELSE B.SHIP_QTY
             END                        AS BOX_NEW_QTY
            ,CASE
                 WHEN RMNF_COUNT.COUNT &gt; 0 THEN B.SHIP_QTY
                 ELSE 0
             END                        AS BOX_USED_QTY
            ,D.DS_ORD_CATG_CD           AS DS_ORD_CATG_CD
            ,D.DS_ORD_TP_CD             AS DS_ORD_TP_CD
            ,CASE
                 WHEN PRTR_COUNT.COUNT &gt; 0 THEN 'Y'
                 ELSE 'N'
             END                        AS COMP_PRTR_FLG
            <!-- START 2018/07/11 W.Honda [QC#27085,MOD]
            ,NULL                       AS CR_REBIL_RSN_CD -->
            ,(SELECT X.CR_REBIL_RSN_CD
                FROM (SELECT RSN.CR_REBIL_RSN_CD
                        FROM DS_CPO_CR_REBIL_RSN RSN
                       WHERE RSN.GLBL_CMPY_CD = D.GLBL_CMPY_CD
                         AND RSN.CPO_ORD_NUM  = D.CPO_ORD_NUM
                         AND RSN.EZCANCELFLAG = '0'
                       ORDER BY
                             RSN.CR_REBIL_RSN_CD
                     ) X
               WHERE ROWNUM = 1
            )                           AS CR_REBIL_RSN_CD
            <!-- END 2018/07/11 W.Honda [QC#27085,MOD] -->
            ,A.GLBL_CMPY_CD             AS GLBL_CMPY_CD
            ,B.INV_BOL_LINE_NUM         AS INV_BOL_LINE_NUM
            ,B.INV_LINE_SUB_TRX_NUM     AS INV_LINE_SUB_TRX_NUM
            ,B.SHIP_QTY                 AS SHIP_QTY
            ,B.INV_LINE_DEAL_NET_AMT    AS INV_LINE_DEAL_NET_AMT
            ,B.DEAL_NET_UNIT_PRC_AMT    AS DEAL_NET_UNIT_PRC_AMT
            ,K.SO_NUM                   AS SO_NUM
            ,K.SO_SLP_NUM               AS SO_SLP_NUM
            ,D.LEASE_TERM_MTH_AOT       AS LEASE_TERM_MTH_AOT <!-- 2018/06/05 W.Honda [QC#26447,ADD] -->
            ,D.DS_ORD_RSN_CD            AS DS_ORD_RSN_CD <!-- 2018/07/11 W.Honda [QC#27085,ADD] -->
            ,F.CR_REBIL_CD              AS CR_REBIL_CD <!-- 2018/09/11 QC#28118,28123 Add -->
            ,A.ACCT_DT                  AS ACCT_DT <!-- 2018/09/11 QC#28118,28123 Add -->
            ,F.DS_CPO_LINE_NUM          AS DS_CPO_LINE_NUM <!-- 2018/09/21 QC#28232 Add -->
            ,F.DS_CPO_LINE_SUB_NUM      AS DS_CPO_LINE_SUB_NUM <!-- 2018/09/21 QC#28232 Add -->
            ,A.INV_TP_CD                AS INV_TP_CD  <!-- 2018/11/09 QC#29131 Add -->
            ,D.AQU_NUM                  AS AQU_NUM  <!-- 2022/03/01 QC#59744 Add -->
            ,D.ADD_SHIP_TO_CTY_ADDR     AS ADD_SHIP_TO_CTY_ADDR  <!-- 2022/03/01 QC#59744 Add -->
            ,D.ADD_SHIP_TO_ST_CD        AS ADD_SHIP_TO_ST_CD  <!-- 2022/03/01 QC#59744 Add -->
            ,F.DEAL_PRC_LIST_PRC_AMT    AS DEAL_PRC_LIST_PRC_AMT  <!-- 2022/03/01 QC#59744 Add -->
        FROM
             INV             A
            ,INV_LINE        B
            ,CPO             D
            ,CPO_DTL         F
            ,DS_CPO_CONFIG   H
            ,MDSE            I
            ,MDL_NM          J
            ,SHPG_PLN        K
            ,SHIP_SER_NUM    L
            ,SELL_TO_CUST    M
            ,SELL_TO_CUST    N
            ,(
              SELECT
                   X1.BILL_TO_CUST_ACCT_CD
                  ,COUNT(X1.INV_NUM) AS COUNT
              FROM
                   INV        X1
              WHERE
                      X1.GLBL_CMPY_CD   = #glblCmpyCd#
                  AND X1.EZCANCELFLAG   = '0'
                  AND X1.INV_DT         &gt; TO_CHAR(ADD_MONTHS(TO_DATE(#slsDt#, #dateFormat#), -12), #dateFormat#)
                  AND X1.INV_DT         &lt; TO_CHAR(ADD_MONTHS(TO_DATE(#slsDt#, #dateFormat#), -3), #dateFormat#)
                  <!-- START 2019/09/13 Hd.Sugawara [QC#52943,ADD] -->
                  AND X1.FNLZ_INV_FLG   = #flgOnY#
                  <!-- END 2019/09/13 Hd.Sugawara [QC#52943,ADD] -->
              GROUP BY
                  X1.BILL_TO_CUST_ACCT_CD
             )               ACCT_COUNT
            ,(
              SELECT
                   X1.DS_ORD_CATG_CD
                  ,COUNT(X1.ORD_CATG_BIZ_CTX_PK) AS COUNT
              FROM
                   ORD_CATG_BIZ_CTX     X1
              WHERE
                      X1.GLBL_CMPY_CD       = #glblCmpyCd#
                  AND X1.EZCANCELFLAG       = '0'
                  AND X1.ORD_CATG_CTX_TP_CD = #ordCatgCtxTpLease#
              GROUP BY
                  X1.DS_ORD_CATG_CD
             )               LEASE_COUNT
            ,(
              SELECT
                   X2.RMNF_TO_CMPT_SER_NUM
                  ,COUNT(X2.RMNF_ORD_NUM) AS COUNT
              FROM
                   RMNF_ORD     X1
                  ,RMNF_ORD_DTL X2
              WHERE
                      X1.GLBL_CMPY_CD     = #glblCmpyCd#
                  AND X1.RMNF_ORD_STS_CD  = #rmnfOrdStsCompleted#
                  AND X1.EZCANCELFLAG     = '0'
                  AND X1.GLBL_CMPY_CD     = X2.GLBL_CMPY_CD
                  AND X1.RMNF_ORD_NUM     = X2.RMNF_ORD_NUM
                  AND X2.EZCANCELFLAG     = '0'
              GROUP BY
                  X2.RMNF_TO_CMPT_SER_NUM
             )               RMNF_COUNT
            ,(
              SELECT
                   X1.ORIG_CPO_ORD_NUM
                  ,X1.ORIG_CPO_DTL_LINE_NUM
                  ,X1.ORIG_CPO_DTL_LINE_SUB_NUM
                  ,X2.CPO_ORD_TS
                  ,X3.SER_NUM
              FROM
                   DS_CPO_RTRN_DTL  X1
                  ,CPO              X2
                  ,SVC_MACH_MSTR    X3
              WHERE
                      X1.GLBL_CMPY_CD          = #glblCmpyCd#
                  AND X1.EZCANCELFLAG          = '0'
                  AND X1.ORIG_CPO_ORD_NUM      IS NOT NULL
                  AND X1.ORIG_CPO_DTL_LINE_NUM IS NOT NULL
                  AND X1.ORIG_CPO_DTL_LINE_SUB_NUM
                                               IS NOT NULL
                  AND X1.GLBL_CMPY_CD          = X2.GLBL_CMPY_CD
                  AND X1.CPO_ORD_NUM           = X2.CPO_ORD_NUM
                  AND X2.EZCANCELFLAG          = '0'
                  AND X1.GLBL_CMPY_CD          = X3.GLBL_CMPY_CD (+)
                  AND X1.SVC_MACH_MSTR_PK      = X3.SVC_MACH_MSTR_PK (+)
                  AND X3.EZCANCELFLAG (+)      = '0'
             )               RTRN
            ,(
              SELECT
                   X.CPO_ORD_NUM
                  ,X.DS_CPO_CONFIG_PK
                  ,X.PSN_CD
              FROM
                  (SELECT /*+ NO_PUSH_PRED */
                        X1.CPO_ORD_NUM
                       ,X1.DS_CPO_CONFIG_PK
                       ,X3.PSN_CD
                       ,ROW_NUMBER() OVER (PARTITION BY X1.CPO_ORD_NUM, X1.DS_CPO_CONFIG_PK ORDER BY X1.SLS_REP_CR_PCT DESC, X1.SLS_REP_TOC_CD ASC) AS ROW_NUM
                   FROM
                        DS_CPO_SLS_CR    X1
                       ,LINE_BIZ_ROLE_TP X2
                       ,ORG_FUNC_ASG     X3
                   WHERE
                           X1.GLBL_CMPY_CD        = #glblCmpyCd#
                       AND X1.EZCANCELFLAG        = '0'
                       AND X1.GLBL_CMPY_CD        = X2.GLBL_CMPY_CD
                       AND X1.SLS_REP_ROLE_TP_CD  = X2.LINE_BIZ_ROLE_TP_CD
                       AND X2.EZCANCELFLAG        = '0'
                       AND X2.PRIM_REP_ROLE_FLG   = 'Y'
                       AND X2.SLS_CR_QUOT_FLG     = 'Y'
                       AND X1.GLBL_CMPY_CD        = X3.GLBL_CMPY_CD
                       AND X1.SLS_REP_TOC_CD      = X3.TOC_CD
                       AND X3.EZCANCELFLAG        = '0'
                       AND X3.EFF_FROM_DT         &lt;= #slsDt#
<!--2019/05/14 #50093 Del Start-->
<!--                       AND NVL(X3.EFF_THRU_DT, #slsDt#) -->
<!--                                                  &gt;= #slsDt#-->
<!--2019/05/14 #50093 Del End-->
                  ) X
              WHERE
                  X.ROW_NUM = 1
             )               SLS_REP
            ,(
              SELECT
                   X.CPO_ORD_NUM
                  ,X.DS_CPO_CONFIG_PK
                  ,X.PSN_CD
              FROM
                  (SELECT /*+ NO_PUSH_PRED */
                        X1.CPO_ORD_NUM
                       ,X1.DS_CPO_CONFIG_PK
                       ,X3.PSN_CD
                       ,ROW_NUMBER() OVER (PARTITION BY X1.CPO_ORD_NUM, X1.DS_CPO_CONFIG_PK ORDER BY X1.SLS_REP_CR_PCT DESC, X1.SLS_REP_TOC_CD ASC) AS ROW_NUM
                   FROM
                        DS_CPO_SLS_CR    X1
                       ,LINE_BIZ_ROLE_TP X2
                       ,ORG_FUNC_ASG     X3
                   WHERE
                           X1.GLBL_CMPY_CD        = #glblCmpyCd#
                       AND X1.EZCANCELFLAG        = '0'
                       AND X1.GLBL_CMPY_CD        = X2.GLBL_CMPY_CD
                       AND X1.SLS_REP_ROLE_TP_CD  = X2.LINE_BIZ_ROLE_TP_CD
                       AND X2.EZCANCELFLAG        = '0'
                       AND X2.PRIM_REP_ROLE_FLG   = 'N'
                       AND X2.SLS_CR_QUOT_FLG     = 'Y'
                       AND X1.GLBL_CMPY_CD        = X3.GLBL_CMPY_CD
                       AND X1.SLS_REP_TOC_CD      = X3.TOC_CD
                       AND X3.EZCANCELFLAG        = '0'
                       AND X3.EFF_FROM_DT         &lt;= #slsDt#
<!--2019/05/14 #50093 Del Start-->
<!--                       AND NVL(X3.EFF_THRU_DT, #slsDt#) -->
<!--                                                  &gt;= #slsDt#-->
<!--2019/05/14 #50093 Del End-->
                  ) X
              WHERE
                  X.ROW_NUM = 1
             )               INST_REP
            ,(
              SELECT
                   X1.CPO_ORD_NUM
                  ,X1.CPO_DTL_LINE_NUM
                  ,X1.CPO_DTL_LINE_SUB_NUM
                  ,COUNT(X3.MDSE_CD) COUNT
              FROM
                   CPO_DTL        X1
                  ,DS_CPO_CONFIG  X2
                  ,ALL_MDSE_V     X3
                  ,DS_MDL         X4
              WHERE
                      X1.GLBL_CMPY_CD         = #glblCmpyCd#
                  AND X1.BASE_CMPT_FLG        = 'Y'
                  AND X1.EZCANCELFLAG         = '0'
                  AND X1.GLBL_CMPY_CD         = X2.GLBL_CMPY_CD
                  AND X1.CPO_ORD_NUM          = X2.CPO_ORD_NUM
                  AND X1.DS_ORD_POSN_NUM      = X2.DS_ORD_POSN_NUM
                  AND X2.EZCANCELFLAG         = '0'
                  AND X1.GLBL_CMPY_CD         = X3.GLBL_CMPY_CD
                  AND X1.MDSE_CD              = X3.MDSE_CD
                  AND X3.EZCANCELFLAG         = '0'
                  AND X3.COA_MDSE_TP_CD       = #coaMdseTpMachine#
                  AND X2.GLBL_CMPY_CD         = X4.GLBL_CMPY_CD
                  AND X2.MDL_ID               = X4.MDL_ID
                  AND X4.EZCANCELFLAG         = '0'
                  AND X4.MTR_GRP_PK           IS NOT NULL
              GROUP BY
                   X1.CPO_ORD_NUM
                  ,X1.CPO_DTL_LINE_NUM
                  ,X1.CPO_DTL_LINE_SUB_NUM
             )               PRTR_COUNT

        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            AND A.TRX_SRC_TP_CD         = #invTrxSrcTpWS#  <!-- 2018/10/30 QC#29033 Add -->
            <!-- START 2019/09/13 Hd.Sugawara [QC#52943,ADD] -->
            AND A.FNLZ_INV_FLG          = #flgOnY#
            <!-- END 2019/09/13 Hd.Sugawara [QC#52943,ADD] -->
            AND A.EZCANCELFLAG          = '0'
            AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
            AND A.INV_NUM               = B.INV_NUM
            AND B.EZCANCELFLAG          = '0'
            <iterate property="compProcStsCdList" var="compProcStsCd[]" open="AND B.COMP_PROC_STS_CD IN (" close=")" conjunction=",">
                #compProcStsCd[]#
            </iterate>
            <!-- START 2018/05/25 Hd.Sugawara [QC#21841(Sol#495),ADD] -->
            <!-- 2018/09/25 QC#28231 Del Start -->
            <!--
            AND (
                B.INV_LINE_CATG_CD      IS NULL 
                OR
                B.INV_LINE_CATG_CD      = #invLineCatgCd#
                )
            -->
            <!-- 2018/09/25 QC#28231 Del End -->
            <!-- END 2018/05/25 Hd.Sugawara [QC#21841(Sol#495),ADD] -->
            AND A.GLBL_CMPY_CD          = D.GLBL_CMPY_CD
            AND A.CPO_ORD_NUM           = D.CPO_ORD_NUM
            AND D.EZCANCELFLAG          = '0'
            AND A.GLBL_CMPY_CD          = F.GLBL_CMPY_CD
            AND A.CPO_ORD_NUM           = F.CPO_ORD_NUM
            AND B.CPO_DTL_LINE_NUM      = F.CPO_DTL_LINE_NUM
            AND B.CPO_DTL_LINE_SUB_NUM  = F.CPO_DTL_LINE_SUB_NUM
            AND F.EZCANCELFLAG          = '0'
            AND F.GLBL_CMPY_CD          = H.GLBL_CMPY_CD
            AND F.CPO_ORD_NUM           = H.CPO_ORD_NUM
            AND F.DS_CPO_CONFIG_PK      = H.DS_CPO_CONFIG_PK
            AND H.EZCANCELFLAG          = '0'
            AND B.GLBL_CMPY_CD          = I.GLBL_CMPY_CD
            AND B.MDSE_CD               = I.MDSE_CD
            AND I.EZCANCELFLAG          = '0'
            AND H.GLBL_CMPY_CD          = J.T_GLBL_CMPY_CD (+)
            AND H.MDL_ID                = J.T_MDL_ID (+)
            AND J.EZCANCELFLAG (+)      = '0'
            AND B.GLBL_CMPY_CD          = K.GLBL_CMPY_CD (+)
            AND B.SHPG_PLN_NUM          = K.SHPG_PLN_NUM (+)
            AND K.EZCANCELFLAG (+)      = '0'
            AND K.GLBL_CMPY_CD          = L.GLBL_CMPY_CD (+)
            AND K.SO_NUM                = L.SO_NUM (+)
            AND K.SO_SLP_NUM            = L.SO_SLP_NUM (+)
            AND L.EZCANCELFLAG (+)      = '0'
            AND H.GLBL_CMPY_CD          = M.GLBL_CMPY_CD
            AND H.BILL_TO_CUST_ACCT_CD  = M.SELL_TO_CUST_CD
            AND M.EZCANCELFLAG          = '0'
            AND H.GLBL_CMPY_CD          = N.GLBL_CMPY_CD
            AND H.SHIP_TO_CUST_ACCT_CD  = N.SELL_TO_CUST_CD
            AND N.EZCANCELFLAG          = '0'
            AND H.BILL_TO_CUST_ACCT_CD  = ACCT_COUNT.BILL_TO_CUST_ACCT_CD (+)
            AND D.DS_ORD_CATG_CD        = LEASE_COUNT.DS_ORD_CATG_CD (+)
            AND L.SER_NUM               = RMNF_COUNT.RMNF_TO_CMPT_SER_NUM (+)
            AND F.CPO_ORD_NUM           = RTRN.ORIG_CPO_ORD_NUM (+)
            AND F.CPO_DTL_LINE_NUM      = RTRN.ORIG_CPO_DTL_LINE_NUM (+)
            AND F.CPO_DTL_LINE_SUB_NUM  = RTRN.ORIG_CPO_DTL_LINE_SUB_NUM (+)
            AND NVL(L.SER_NUM, #defSerNum#)
                                        = NVL(RTRN.SER_NUM (+), #defSerNum#)
            AND H.CPO_ORD_NUM           = SLS_REP.CPO_ORD_NUM (+)
            AND H.DS_CPO_CONFIG_PK      = SLS_REP.DS_CPO_CONFIG_PK (+)
            AND H.CPO_ORD_NUM           = INST_REP.CPO_ORD_NUM (+)
            AND H.DS_CPO_CONFIG_PK      = INST_REP.DS_CPO_CONFIG_PK (+)
            AND F.CPO_ORD_NUM           = PRTR_COUNT.CPO_ORD_NUM (+)
            AND F.CPO_DTL_LINE_NUM      = PRTR_COUNT.CPO_DTL_LINE_NUM (+)
            AND F.CPO_DTL_LINE_SUB_NUM  = PRTR_COUNT.CPO_DTL_LINE_SUB_NUM (+)
            AND EXISTS (
                    SELECT
                        1
                    FROM
                         DS_CPO_SLS_CR     X1
                        ,LINE_BIZ_ROLE_TP  X2
                        ,CPO_V             X3
                    WHERE
                            X1.GLBL_CMPY_CD        = H.GLBL_CMPY_CD
                        AND X1.CPO_ORD_NUM         = H.CPO_ORD_NUM
                        AND X1.DS_CPO_CONFIG_PK    = H.DS_CPO_CONFIG_PK
                        AND X1.EZCANCELFLAG        = '0'
                        AND X1.GLBL_CMPY_CD        = X2.GLBL_CMPY_CD
                        AND X1.SLS_REP_ROLE_TP_CD  = X2.LINE_BIZ_ROLE_TP_CD
                        AND X2.EZCANCELFLAG        = '0'
                        AND X2.SLS_CR_QUOT_FLG     = 'Y'
                        AND X1.GLBL_CMPY_CD        = X3.GLBL_CMPY_CD
                        AND X1.CPO_ORD_NUM         = X3.CPO_ORD_NUM
                        AND X3.EZCANCELFLAG        = '0'
                        AND X3.LINE_BIZ_TP_CD      = #lineBizTpCd#
                )
    )
    ,INV_COUNT AS (
        SELECT
             COMP_INFO.INV_NUM
            ,COMP_INFO.INV_BOL_LINE_NUM
            ,COMP_INFO.INV_LINE_NUM
            ,COMP_INFO.INV_LINE_SUB_NUM
            ,COMP_INFO.INV_LINE_SUB_TRX_NUM
            ,COUNT(COMP_INFO.INV_NUM) AS COUNT
        FROM
            COMP_INFO
        GROUP BY
             COMP_INFO.INV_NUM
            ,COMP_INFO.INV_BOL_LINE_NUM
            ,COMP_INFO.INV_LINE_NUM
            ,COMP_INFO.INV_LINE_SUB_NUM
            ,COMP_INFO.INV_LINE_SUB_TRX_NUM
    )
    ,CONTR_DURN AS (
        SELECT
             X1.INV_NUM
            ,X1.INV_BOL_LINE_NUM
            ,X1.INV_LINE_NUM
            ,X1.INV_LINE_SUB_NUM
            ,X1.INV_LINE_SUB_TRX_NUM
            ,X1.SER_NUM
            ,X2.CONTR_DURN_AOT * NVL(X3.BLLG_CYCLE_MTH_AOT, X3.BLLG_CYCLE_DAYS_AOT)  AS CONTR_DURN_AOT
        FROM
             (
              SELECT /*+ NO_PUSH_PRED */
                   COMP_INFO.GLBL_CMPY_CD
                  ,COMP_INFO.INV_NUM
                  ,COMP_INFO.INV_BOL_LINE_NUM
                  ,COMP_INFO.INV_LINE_NUM
                  ,COMP_INFO.INV_LINE_SUB_NUM
                  ,COMP_INFO.INV_LINE_SUB_TRX_NUM
                  ,COMP_INFO.SER_NUM
                  ,Y2.DS_CONTR_PK
                  ,ROW_NUMBER() OVER (PARTITION BY Y2.SVC_MACH_MSTR_PK ORDER BY Y2.CONTR_EFF_THRU_DT DESC, Y2.DS_CONTR_DTL_PK DESC) AS ROW_NUM
              FROM
                   COMP_INFO
                  ,SVC_MACH_MSTR  Y1
                  ,DS_CONTR_DTL   Y2
              WHERE
                      COMP_INFO.GLBL_CMPY_CD    = Y1.GLBL_CMPY_CD
                  AND COMP_INFO.SO_NUM          = Y1.SO_NUM
                  AND COMP_INFO.SO_SLP_NUM      = Y1.SO_SLP_NUM
                  AND NVL(COMP_INFO.SER_NUM, #defSerNum#)
                                                = NVL(Y1.SER_NUM, #defSerNum#)
                  AND Y1.EZCANCELFLAG           = '0'
                  AND Y1.GLBL_CMPY_CD           = Y2.GLBL_CMPY_CD
                  AND Y1.SVC_MACH_MSTR_PK       = Y2.SVC_MACH_MSTR_PK
                  AND Y2.EZCANCELFLAG           = '0'
                  <iterate property="dsContrDtlStsCdList" var="dsContrDtlStsCd[]" open="AND Y2.DS_CONTR_DTL_STS_CD NOT IN (" close=")" conjunction=",">
                      #dsContrDtlStsCd[]#
                  </iterate>
                  AND Y2.CONTR_EFF_FROM_DT      &lt;= COMP_INFO.ORD_BOOK_DT
                  AND NVL(Y2.CONTR_CLO_DT, Y2.CONTR_EFF_THRU_DT )
                                                &gt;= COMP_INFO.ORD_BOOK_DT
             )                X1
            ,DS_CONTR         X2
            ,BLLG_CYCLE_UOM   X3
        WHERE
                X1.ROW_NUM            = 1
            AND X1.GLBL_CMPY_CD       = X2.GLBL_CMPY_CD
            AND X1.DS_CONTR_PK        = X2.DS_CONTR_PK
            AND X2.EZCANCELFLAG       = '0'
            AND X2.CONTR_DURN_AOT     IS NOT NULL
            AND X2.GLBL_CMPY_CD       = X3.GLBL_CMPY_CD
            AND X2.BLLG_CYCLE_UOM_CD  = X3.BLLG_CYCLE_UOM_CD
            AND X3.EZCANCELFLAG       = '0'
    )
    <!-- START 2018/06/05 W.Honda [QC#26447,ADD] -->
    ,LEASE_TERM AS (
        SELECT
             COMP_INFO.GLBL_CMPY_CD
            ,COMP_INFO.INV_NUM
            ,COMP_INFO.INV_BOL_LINE_NUM
            ,COMP_INFO.INV_LINE_NUM
            ,COMP_INFO.INV_LINE_SUB_NUM
            ,COMP_INFO.INV_LINE_SUB_TRX_NUM
            ,COMP_INFO.SER_NUM
            ,COMP_INFO.LEASE_TERM_MTH_AOT
            ,CASE
             WHEN COMP_INFO.LEASE_TERM_MTH_AOT IS NULL
             THEN (SELECT TRUNC(SUM(MONTHS_BETWEEN(TO_DATE(C1.HDR_END_DT, #dateFormat#), TO_DATE(C1.HDR_START_DT, #dateFormat#)))) LEASE_TERM
                 FROM   CFS_LEASE_CONTR C1
                 WHERE  Z2.GLBL_CMPY_CD  = C1.GLBL_CMPY_CD
                 AND    Z2.SER_NUM       = C1.SER_NUM
                 AND    C1.EZCANCELFLAG  = '0')
            ELSE NULL
            END AS LEASE_TERM_SER
          ,CASE
           WHEN COMP_INFO.LEASE_TERM_MTH_AOT IS NULL
           THEN (SELECT TRUNC(SUM(MONTHS_BETWEEN(TO_DATE(C4.HDR_END_DT, #dateFormat#), TO_DATE(C4.HDR_START_DT, #dateFormat#)))) LEASE_TERM
                 FROM   DS_CONTR_DTL    C2
                       ,DS_CONTR        C3
                       ,CFS_LEASE_CONTR C4
                 WHERE  Z2.GLBL_CMPY_CD     = C2.GLBL_CMPY_CD
                 AND    Z2.SVC_CONFIG_MSTR_PK = C2.SVC_CONFIG_MSTR_PK
                 AND    C2.EZCANCELFLAG = '0'

                 AND    C2.GLBL_CMPY_CD     = C3.GLBL_CMPY_CD
                 AND    C2.DS_CONTR_PK      = C3.DS_CONTR_PK
                 AND    C3.EZCANCELFLAG     = '0'

                 AND    C3.GLBL_CMPY_CD     = C4.GLBL_CMPY_CD
                 AND    C3.DS_CONTR_NUM     = C4.CSA_CONTR_NUM
                 AND    C4.EZCANCELFLAG     = '0'
                 
                 )
            ELSE NULL
            END AS LEASE_TERM_CONTR
      FROM
           COMP_INFO
          ,SVC_CONFIG_MSTR  Z1
          ,SVC_MACH_MSTR    Z2
      WHERE
              COMP_INFO.GLBL_CMPY_CD       = Z1.GLBL_CMPY_CD
          AND COMP_INFO.SVC_CONFIG_MSTR_PK = Z1.SVC_CONFIG_MSTR_PK
          AND Z1.EZCANCELFLAG              = '0'

          AND Z1.GLBL_CMPY_CD              = Z2.GLBL_CMPY_CD
          AND Z1.SVC_MACH_MSTR_PK          = Z2.SVC_MACH_MSTR_PK
          AND Z2.EZCANCELFLAG              = '0'
    )
    <!-- END 2018/06/05 W.Honda [QC#26447,ADD] -->
    <!-- START 2018/07/11 W.Honda [QC#27086,ADD] -->
    ,RENTAL_TERM AS (
        SELECT
             X1.INV_NUM
            ,X1.INV_BOL_LINE_NUM
            ,X1.INV_LINE_NUM
            ,X1.INV_LINE_SUB_NUM
            ,X1.INV_LINE_SUB_TRX_NUM
            ,X1.SER_NUM
            ,TRUNC(MONTHS_BETWEEN(TO_DATE(X2.CONTR_VRSN_EFF_THRU_DT, #dateFormat#), TO_DATE(X2.CONTR_VRSN_EFF_FROM_DT, #dateFormat#))) RENTAL_TERM
        FROM
             (
              SELECT /*+ NO_PUSH_PRED */
                   COMP_INFO.GLBL_CMPY_CD
                  ,COMP_INFO.INV_NUM
                  ,COMP_INFO.INV_BOL_LINE_NUM
                  ,COMP_INFO.INV_LINE_NUM
                  ,COMP_INFO.INV_LINE_SUB_NUM
                  ,COMP_INFO.INV_LINE_SUB_TRX_NUM
                  ,COMP_INFO.SER_NUM
                  ,Y2.DS_CONTR_PK
                  ,ROW_NUMBER() OVER (PARTITION BY Y2.SVC_MACH_MSTR_PK ORDER BY Y2.CONTR_EFF_THRU_DT DESC, Y2.DS_CONTR_DTL_PK DESC) AS ROW_NUM
              FROM
                   COMP_INFO
                  ,SVC_MACH_MSTR    Y1
                  ,DS_CONTR_DTL     Y2
                  ,ORD_CATG_BIZ_CTX Y3
              WHERE
                      Y3.GLBL_CMPY_CD        = COMP_INFO.GLBL_CMPY_CD
                  AND Y3.ORD_CATG_CTX_TP_CD  = #ordCatgCtxTRetal#
                  AND Y3.DS_ORD_CATG_CD      = COMP_INFO.DS_ORD_CATG_CD
                  AND (Y3.DS_ORD_TP_CD       = COMP_INFO.DS_ORD_TP_CD
                      OR  Y3.DS_ORD_TP_CD    IS NULL)
                  AND Y3.EZCANCELFLAG        = '0'
                  AND COMP_INFO.GLBL_CMPY_CD = Y1.GLBL_CMPY_CD
                  AND COMP_INFO.SO_NUM       = Y1.SO_NUM
                  <!-- 2018/09/20 QC#28238 Mod Start -->
                  <!--
                  AND COMP_INFO.SO_SLP_NUM   = Y1.SO_SLP_NUM
                  -->
                  AND COMP_INFO.CPO_ORD_NUM  = Y1.CPO_ORD_NUM
                  AND COMP_INFO.CPO_DTL_LINE_NUM = Y1.CPO_DTL_LINE_NUM
                  AND COMP_INFO.CPO_DTL_LINE_SUB_NUM = Y1.CPO_DTL_LINE_SUB_NUM
                  <!-- 2018/09/20 QC#28238 Mod End -->
                  AND NVL(COMP_INFO.SER_NUM, #defSerNum#)
                                             = NVL(Y1.SER_NUM, #defSerNum#)
                  AND Y1.EZCANCELFLAG        = '0'
                  AND Y1.GLBL_CMPY_CD        = Y2.GLBL_CMPY_CD
                  AND Y1.SVC_MACH_MSTR_PK    = Y2.SVC_MACH_MSTR_PK
                  AND Y2.EZCANCELFLAG        = '0'
                  <iterate property="dsContrDtlStsCdForRentalList" var="dsContrDtlStsCdForRental[]" open="AND Y2.DS_CONTR_DTL_STS_CD NOT IN (" close=")" conjunction=",">
                      #dsContrDtlStsCdForRental[]#
                  </iterate>
             )                X1
            ,DS_CONTR         X2
        WHERE
                X1.ROW_NUM            = 1
            AND X1.GLBL_CMPY_CD       = X2.GLBL_CMPY_CD
            AND X1.DS_CONTR_PK        = X2.DS_CONTR_PK
            AND X2.EZCANCELFLAG       = '0'
            AND X2.CONTR_DURN_AOT     IS NOT NULL
    )
    <!-- END 2018/07/11 W.Honda [QC#27086,ADD] -->

        SELECT
             COMP_INFO.CPO_ORD_NUM
            ,COMP_INFO.DS_ORD_POSN_NUM
            <!-- 2018/09/21 QC#28232 Mod Start -->
            <!--
            ,COMP_INFO.CPO_DTL_LINE_NUM
            ,COMP_INFO.CPO_DTL_LINE_SUB_NUM
             -->
            ,TO_CHAR(COMP_INFO.DS_CPO_LINE_NUM) AS CPO_DTL_LINE_NUM
            <!-- START 2018/10/24 Hd.Sugawara [QC#28844,MOD] -->
            <!-- ,TO_CHAR(COMP_INFO.DS_CPO_LINE_SUB_NUM) AS CPO_DTL_LINE_SUB_NUM -->
            ,COMP_INFO.CPO_DTL_LINE_SUB_NUM
            <!-- END 2018/10/24 Hd.Sugawara [QC#28844,MOD] -->
            <!-- 2018/09/21 QC#28232 Mod End -->
            ,COMP_INFO.NEW_CUST_FLG
            ,COMP_INFO.BILL_TO_CUST_ACCT_CD
            ,COMP_INFO.BILL_TO_CUST_ACCT_NM
            ,COMP_INFO.SHIP_TO_CUST_ACCT_CD
            ,COMP_INFO.SHIP_TO_CUST_ACCT_NM
            ,COMP_INFO.CR_CUST_CD
            ,COMP_INFO.LEASE_FLG
            ,COMP_INFO.SVC_CONFIG_MSTR_PK
            <!-- START 2018/06/05 W.Honda [QC#26447,MOD]
            ,CONTR_DURN.CONTR_DURN_AOT   AS CONTR_DURN_AOT -->
            ,CASE
             WHEN CONTR_DURN.CONTR_DURN_AOT    IS NOT NULL THEN CONTR_DURN.CONTR_DURN_AOT
             WHEN RENTAL_TERM.RENTAL_TERM      IS NOT NULL THEN RENTAL_TERM.RENTAL_TERM<!-- 2018/07/11 W.Honda [QC#27086,ADD] -->
             WHEN COMP_INFO.LEASE_TERM_MTH_AOT IS NOT NULL THEN COMP_INFO.LEASE_TERM_MTH_AOT
             WHEN LEASE_TERM.LEASE_TERM_SER    IS NOT NULL THEN LEASE_TERM.LEASE_TERM_SER
             WHEN LEASE_TERM.LEASE_TERM_CONTR  IS NOT NULL THEN LEASE_TERM.LEASE_TERM_CONTR
             ELSE NULL
             END AS CONTR_DURN_AOT
            <!-- END 2018/06/05 W.Honda [QC#26447,MOD] -->
            ,COMP_INFO.COMP_QTR_CD
            ,COMP_INFO.ORD_DT
            ,COMP_INFO.ORD_BOOK_DT
            ,COMP_INFO.ORD_RTRN_DT
            <!-- 2018/09/11 QC#28118,28123 Mod Start -->
            <!--
            ,COMP_INFO.INV_DT
            -->
            ,CASE 
             WHEN COMP_INFO.CR_REBIL_CD IN (#crCdCredit#, #crCdRebill#) THEN COMP_INFO.ACCT_DT
             ELSE COMP_INFO.INV_DT
             END AS INV_DT
            <!-- 2018/09/11 QC#28118,28123 Mod End -->
            ,COMP_INFO.INV_NUM
            ,COMP_INFO.INV_LINE_NUM
            ,COMP_INFO.INV_LINE_SUB_NUM
            ,COMP_INFO.SLS_REP_PSN_CD
            ,COMP_INFO.ISTL_REP_PSN_CD
            ,CASE
                 WHEN INV_COUNT.COUNT &gt; 1 THEN 1
                 ELSE COMP_INFO.SHIP_QTY
             END                         AS COMP_BLLG_QTY
            ,COMP_INFO.MDSE_CD
            ,COMP_INFO.MDSE_DESC_SHORT_TXT
            ,COMP_INFO.T_MDL_NM
            ,COMP_INFO.SER_NUM
            ,CASE
                 WHEN COMP_INFO.BOX_NEW_QTY = 0 THEN 0
                 WHEN INV_COUNT.COUNT &gt; 1 THEN 1
                 ELSE COMP_INFO.BOX_NEW_QTY
             END                         AS BOX_NEW_QTY
            ,CASE
                 WHEN COMP_INFO.BOX_USED_QTY = 0 THEN 0
                 WHEN INV_COUNT.COUNT &gt; 1 THEN 1
                 ELSE COMP_INFO.BOX_USED_QTY
             END                         AS BOX_USED_QTY
            ,CASE
                 
                 <!-- 2018/09/11 QC#28118,28123 Mod Start -->
                 <!--
                 WHEN INV_COUNT.COUNT &gt; 1 THEN COMP_INFO.DEAL_NET_UNIT_PRC_AMT
                 ELSE COMP_INFO.INV_LINE_DEAL_NET_AMT
                 -->
                 <!-- 2018/11/09 QC#29131 Del Start -->
                 <!--
                 WHEN INV_COUNT.COUNT &gt; 1 THEN 
                 CASE
                     WHEN COMP_INFO.CR_REBIL_CD = #crCdCredit# THEN COMP_INFO.DEAL_NET_UNIT_PRC_AMT * (-1)
                     ELSE COMP_INFO.DEAL_NET_UNIT_PRC_AMT
                 END
                 ELSE
                 CASE
                     WHEN COMP_INFO.CR_REBIL_CD = #crCdCredit# THEN COMP_INFO.INV_LINE_DEAL_NET_AMT * (-1)
                     ELSE COMP_INFO.INV_LINE_DEAL_NET_AMT
                 END
                 -->
                 <!-- 2018/11/09 QC#29131 Del End -->
                 <!-- 2018/09/11 QC#28118,28123 Mod End -->
                 <!-- 2018/11/09 QC#29131 Add Start -->
                 WHEN INV_COUNT.COUNT &gt; 1 THEN 
                 CASE
                     WHEN COMP_INFO.INV_TP_CD = #creditMemo# THEN COMP_INFO.DEAL_NET_UNIT_PRC_AMT * (-1)
                     ELSE COMP_INFO.DEAL_NET_UNIT_PRC_AMT
                 END
                 ELSE
                 CASE
                     WHEN COMP_INFO.INV_TP_CD = #creditMemo# THEN COMP_INFO.INV_LINE_DEAL_NET_AMT * (-1)
                     ELSE COMP_INFO.INV_LINE_DEAL_NET_AMT
                 END
                 <!-- 2018/11/09 QC#29131 Add End -->
             END                         AS COMP_VAL_AMT
            ,COMP_INFO.DS_ORD_CATG_CD
            ,COMP_INFO.DS_ORD_TP_CD
            ,COMP_INFO.COMP_PRTR_FLG
            ,COMP_INFO.CR_REBIL_RSN_CD
            ,COMP_INFO.INV_BOL_LINE_NUM
            ,COMP_INFO.INV_LINE_SUB_TRX_NUM
            ,COMP_INFO.DS_ORD_RSN_CD <!-- 2018/07/11 W.Honda [QC#27085,ADD] -->
            ,COMP_INFO.AQU_NUM                  AS AQU_NUM  <!-- 2022/03/01 QC#59744 Add -->
            ,COMP_INFO.ADD_SHIP_TO_CTY_ADDR     AS ADD_SHIP_TO_CTY_ADDR  <!-- 2022/03/01 QC#59744 Add -->
            ,COMP_INFO.ADD_SHIP_TO_ST_CD        AS ADD_SHIP_TO_ST_CD  <!-- 2022/03/01 QC#59744 Add -->
            ,COMP_INFO.DEAL_PRC_LIST_PRC_AMT    AS DEAL_PRC_LIST_PRC_AMT  <!-- 2022/03/01 QC#59744 Add -->
        FROM
             COMP_INFO
            ,INV_COUNT
            ,CONTR_DURN
            <!-- START 2018/06/05 W.Honda [QC#26447,ADD] -->
            ,LEASE_TERM
            <!-- END 2018/06/05 W.Honda [QC#26447,ADD] -->
            <!-- START 2018/07/11 W.Honda [QC#27086,ADD] -->
            ,RENTAL_TERM
            <!-- END 2018/07/11 W.Honda [QC#27086,ADD] -->
        WHERE
                COMP_INFO.INV_NUM               = INV_COUNT.INV_NUM
            AND COMP_INFO.INV_BOL_LINE_NUM      = INV_COUNT.INV_BOL_LINE_NUM
            AND COMP_INFO.INV_LINE_NUM          = INV_COUNT.INV_LINE_NUM
            AND COMP_INFO.INV_LINE_SUB_NUM      = INV_COUNT.INV_LINE_SUB_NUM
            AND COMP_INFO.INV_LINE_SUB_TRX_NUM  = INV_COUNT.INV_LINE_SUB_TRX_NUM
            AND COMP_INFO.INV_NUM               = CONTR_DURN.INV_NUM (+)
            AND COMP_INFO.INV_BOL_LINE_NUM      = CONTR_DURN.INV_BOL_LINE_NUM (+)
            AND COMP_INFO.INV_LINE_NUM          = CONTR_DURN.INV_LINE_NUM (+)
            AND COMP_INFO.INV_LINE_SUB_NUM      = CONTR_DURN.INV_LINE_SUB_NUM (+)
            AND COMP_INFO.INV_LINE_SUB_TRX_NUM  = CONTR_DURN.INV_LINE_SUB_TRX_NUM (+)
            AND NVL(COMP_INFO.SER_NUM, #defSerNum#)
                                                = NVL(CONTR_DURN.SER_NUM (+), #defSerNum#)
            <!-- START 2018/06/05 W.Honda [QC#26447,ADD] -->
            AND COMP_INFO.INV_NUM               = LEASE_TERM.INV_NUM (+)
            AND COMP_INFO.INV_BOL_LINE_NUM      = LEASE_TERM.INV_BOL_LINE_NUM (+)
            AND COMP_INFO.INV_LINE_NUM          = LEASE_TERM.INV_LINE_NUM (+)
            AND COMP_INFO.INV_LINE_SUB_NUM      = LEASE_TERM.INV_LINE_SUB_NUM (+)
            AND COMP_INFO.INV_LINE_SUB_TRX_NUM  = LEASE_TERM.INV_LINE_SUB_TRX_NUM (+)
            <!-- END 2018/06/05 W.Honda [QC#26447,ADD] -->
            <!-- START 2018/07/11 W.Honda [QC#27086,ADD] -->
            AND COMP_INFO.INV_NUM               = RENTAL_TERM.INV_NUM (+)
            AND COMP_INFO.INV_BOL_LINE_NUM      = RENTAL_TERM.INV_BOL_LINE_NUM (+)
            AND COMP_INFO.INV_LINE_NUM          = RENTAL_TERM.INV_LINE_NUM (+)
            AND COMP_INFO.INV_LINE_SUB_NUM      = RENTAL_TERM.INV_LINE_SUB_NUM (+)
            AND COMP_INFO.INV_LINE_SUB_TRX_NUM  = RENTAL_TERM.INV_LINE_SUB_TRX_NUM (+)
            <!-- END 2018/07/11 W.Honda [QC#27086,ADD] -->
        ORDER BY
             COMP_INFO.INV_NUM               ASC
            ,COMP_INFO.INV_BOL_LINE_NUM      ASC
            ,COMP_INFO.INV_LINE_NUM          ASC
            ,COMP_INFO.INV_LINE_SUB_NUM      ASC
            ,COMP_INFO.INV_LINE_SUB_TRX_NUM  ASC
            ,COMP_INFO.SER_NUM               ASC NULLS LAST
    </statement>

    <!-- 2018/09/25 QC#28231 Add Start -->
    <statement id="getCompInfoRMA" parameterClass="Map" resultClass="Map">
    WITH COMP_INFO AS (
        SELECT
             D.CPO_ORD_NUM              AS CPO_ORD_NUM
            ,F.DS_ORD_POSN_NUM          AS DS_ORD_POSN_NUM
            ,F.DS_CPO_RTRN_LINE_NUM     AS CPO_DTL_LINE_NUM
            ,F.DS_CPO_RTRN_LINE_SUB_NUM AS CPO_DTL_LINE_SUB_NUM
            ,CASE
                 WHEN ACCT_COUNT.COUNT &gt; 0 THEN 'N'
                 ELSE 'Y'
             END                        AS NEW_CUST_FLG
            ,H.BILL_TO_CUST_ACCT_CD     AS BILL_TO_CUST_ACCT_CD
            ,M.DS_ACCT_NM               AS BILL_TO_CUST_ACCT_NM
            ,H.SHIP_TO_CUST_ACCT_CD     AS SHIP_TO_CUST_ACCT_CD
            ,N.DS_ACCT_NM               AS SHIP_TO_CUST_ACCT_NM
            ,H.BILL_TO_CUST_ACCT_CD     AS CR_CUST_CD
            ,CASE
                 WHEN LEASE_COUNT.COUNT &gt; 0 THEN 'Y'
                 ELSE 'N'
             END                        AS LEASE_FLG
            ,H.SVC_CONFIG_MSTR_PK       AS SVC_CONFIG_MSTR_PK
            ,CASE
                 WHEN #month01# &lt;= SUBSTR(A.INV_DT, 5, 2) AND SUBSTR(A.INV_DT, 5, 2) &lt;= #month03# THEN #qtr01#
                 WHEN #month04# &lt;= SUBSTR(A.INV_DT, 5, 2) AND SUBSTR(A.INV_DT, 5, 2) &lt;= #month06# THEN #qtr02#
                 WHEN #month07# &lt;= SUBSTR(A.INV_DT, 5, 2) AND SUBSTR(A.INV_DT, 5, 2) &lt;= #month09# THEN #qtr03#
                 WHEN #month10# &lt;= SUBSTR(A.INV_DT, 5, 2) AND SUBSTR(A.INV_DT, 5, 2) &lt;= #month12# THEN #qtr04#
             END                        AS COMP_QTR_CD
            ,SUBSTR(D.CPO_ORD_TS, 1, 8) AS ORD_DT
            ,SUBSTR(D.ORD_BOOK_TS, 1, 8) 
                                        AS ORD_BOOK_DT
            ,F.CPO_ORD_TS               AS ORD_RTRN_DT
            ,A.INV_DT                   AS INV_DT
            ,A.INV_NUM                  AS INV_NUM
            ,B.INV_LINE_NUM             AS INV_LINE_NUM
            ,B.INV_LINE_SUB_NUM         AS INV_LINE_SUB_NUM
            ,SLS_REP.PSN_CD             AS SLS_REP_PSN_CD
            ,NVL(INST_REP.PSN_CD, SLS_REP.PSN_CD)
                                        AS ISTL_REP_PSN_CD
            ,B.MDSE_CD                  AS MDSE_CD
            ,I.MDSE_DESC_SHORT_TXT      AS MDSE_DESC_SHORT_TXT
            ,J.T_MDL_NM                 AS T_MDL_NM
            ,Q.SER_NUM                  AS SER_NUM
            ,CASE
                 WHEN RMNF_COUNT.COUNT &gt; 0 THEN 0
                 ELSE B.SHIP_QTY
             END                        AS BOX_NEW_QTY
            ,CASE
                 WHEN RMNF_COUNT.COUNT &gt; 0 THEN B.SHIP_QTY
                 ELSE 0
             END                        AS BOX_USED_QTY
            ,D.DS_ORD_CATG_CD           AS DS_ORD_CATG_CD
            ,D.DS_ORD_TP_CD             AS DS_ORD_TP_CD
            ,CASE
                 WHEN PRTR_COUNT.COUNT &gt; 0 THEN 'Y'
                 ELSE 'N'
             END                        AS COMP_PRTR_FLG
            ,(SELECT X.CR_REBIL_RSN_CD
                FROM (SELECT RSN.CR_REBIL_RSN_CD
                        FROM DS_CPO_CR_REBIL_RSN RSN
                       WHERE RSN.GLBL_CMPY_CD = D.GLBL_CMPY_CD
                         AND RSN.CPO_ORD_NUM  = D.CPO_ORD_NUM
                         AND RSN.EZCANCELFLAG = '0'
                       ORDER BY
                             RSN.CR_REBIL_RSN_CD
                     ) X
               WHERE ROWNUM = 1
            )                           AS CR_REBIL_RSN_CD
            ,A.GLBL_CMPY_CD             AS GLBL_CMPY_CD
            ,B.INV_BOL_LINE_NUM         AS INV_BOL_LINE_NUM
            ,B.INV_LINE_SUB_TRX_NUM     AS INV_LINE_SUB_TRX_NUM
            ,B.SHIP_QTY                 AS SHIP_QTY
            ,B.INV_LINE_DEAL_NET_AMT    AS INV_LINE_DEAL_NET_AMT
            ,B.DEAL_NET_UNIT_PRC_AMT    AS DEAL_NET_UNIT_PRC_AMT
            ,D.LEASE_TERM_MTH_AOT       AS LEASE_TERM_MTH_AOT
            ,D.DS_ORD_RSN_CD            AS DS_ORD_RSN_CD
            ,F.CR_REBIL_CD              AS CR_REBIL_CD
            ,A.ACCT_DT                  AS ACCT_DT
            ,F.DS_CPO_LINE_NUM          AS DS_CPO_LINE_NUM
            ,F.DS_CPO_LINE_SUB_NUM      AS DS_CPO_LINE_SUB_NUM
            ,F.SVC_MACH_MSTR_PK         AS SVC_MACH_MSTR_PK
            <!-- 2018/11/09 QC#29131 Del Start -->
            <!--
            ,CASE
                 WHEN B.INV_LINE_CATG_CD in (#invLineCatgCharge#, #invLineCatgFreight#) THEN 1
                 ELSE -1
             END                        AS SIGN
             -->
             <!-- 2018/11/09 QC#29131 Del End -->
            ,A.INV_TP_CD                AS INV_TP_CD  <!-- 2018/11/09 QC#29131 Add -->
        FROM
             INV             A
            ,INV_LINE        B
            ,CPO             D
            ,DS_CPO_RTRN_DTL F
            ,DS_CPO_CONFIG   H
            ,MDSE            I
            ,MDL_NM          J
            ,SELL_TO_CUST    M
            ,SELL_TO_CUST    N
            <!-- 2018/10/24 QC#28585 Mod Start -->
            <!--
            ,RWS_HDR         O
            ,RWS_DTL         P
            ,RWS_SER         Q
            -->
           ,(
             SELECT
                   X1.TRX_ORD_NUM
                  ,X2.TRX_LINE_NUM
                  ,X2.TRX_LINE_SUB_NUM
                  ,X3.SER_NUM
             FROM
                   RWS_HDR X1
                  ,RWS_DTL X2
                  ,RWS_SER X3
             WHERE
                      X1.GLBL_CMPY_CD     = #glblCmpyCd#
                  AND X1.EZCANCELFLAG     = '0'
                  AND X1.GLBL_CMPY_CD     = X2.GLBL_CMPY_CD
                  AND X2.EZCANCELFLAG     = '0'
                  AND X1.RWS_NUM          = X2.RWS_NUM
                  AND X2.GLBL_CMPY_CD     = X3.GLBL_CMPY_CD
                  AND X2.RWS_NUM          = X3.RWS_NUM
                  AND X2.RWS_DTL_LINE_NUM = X3.RWS_LINE_NUM
                  AND X3.EZCANCELFLAG     = '0'
                  <!-- 2019/08/15 QC#52707 Mod Start -->
                  AND X1.RWS_STS_CD       &lt;&gt; #rwsStsCancel#
                  AND X2.RWS_PUT_AWAY_QTY &gt; 0
                  <!-- 2019/08/15 QC#52707 Mod End -->
            ) Q
            <!-- 2018/10/24 QC#28585 Mod End -->
            ,(
              SELECT
                   X1.BILL_TO_CUST_ACCT_CD
                  ,COUNT(X1.INV_NUM) AS COUNT
              FROM
                   INV        X1
              WHERE
                      X1.GLBL_CMPY_CD   = #glblCmpyCd#
                  AND X1.EZCANCELFLAG   = '0'
                  AND X1.INV_DT         &gt; TO_CHAR(ADD_MONTHS(TO_DATE(#slsDt#, #dateFormat#), -12), #dateFormat#)
                  AND X1.INV_DT         &lt; TO_CHAR(ADD_MONTHS(TO_DATE(#slsDt#, #dateFormat#), -3), #dateFormat#)
              GROUP BY
                  X1.BILL_TO_CUST_ACCT_CD
             )               ACCT_COUNT
            ,(
              SELECT
                   X1.DS_ORD_CATG_CD
                  ,COUNT(X1.ORD_CATG_BIZ_CTX_PK) AS COUNT
              FROM
                   ORD_CATG_BIZ_CTX     X1
              WHERE
                      X1.GLBL_CMPY_CD       = #glblCmpyCd#
                  AND X1.EZCANCELFLAG       = '0'
                  AND X1.ORD_CATG_CTX_TP_CD = #ordCatgCtxTpLease#
              GROUP BY
                  X1.DS_ORD_CATG_CD
             )               LEASE_COUNT
            ,(
              SELECT
                   X2.RMNF_TO_CMPT_SER_NUM
                  ,COUNT(X2.RMNF_ORD_NUM) AS COUNT
              FROM
                   RMNF_ORD     X1
                  ,RMNF_ORD_DTL X2
              WHERE
                      X1.GLBL_CMPY_CD     = #glblCmpyCd#
                  AND X1.RMNF_ORD_STS_CD  = #rmnfOrdStsCompleted#
                  AND X1.EZCANCELFLAG     = '0'
                  AND X1.GLBL_CMPY_CD     = X2.GLBL_CMPY_CD
                  AND X1.RMNF_ORD_NUM     = X2.RMNF_ORD_NUM
                  AND X2.EZCANCELFLAG     = '0'
              GROUP BY
                  X2.RMNF_TO_CMPT_SER_NUM
             )               RMNF_COUNT
            ,(
              SELECT
                   X.CPO_ORD_NUM
                  ,X.DS_CPO_CONFIG_PK
                  ,X.PSN_CD
              FROM
                  (SELECT /*+ NO_PUSH_PRED */
                        X1.CPO_ORD_NUM
                       ,X1.DS_CPO_CONFIG_PK
                       ,X3.PSN_CD
                       ,ROW_NUMBER() OVER (PARTITION BY X1.CPO_ORD_NUM, X1.DS_CPO_CONFIG_PK ORDER BY X1.SLS_REP_CR_PCT DESC, X1.SLS_REP_TOC_CD ASC) AS ROW_NUM
                   FROM
                        DS_CPO_SLS_CR    X1
                       ,LINE_BIZ_ROLE_TP X2
                       ,ORG_FUNC_ASG     X3
                   WHERE
                           X1.GLBL_CMPY_CD        = #glblCmpyCd#
                       AND X1.EZCANCELFLAG        = '0'
                       AND X1.GLBL_CMPY_CD        = X2.GLBL_CMPY_CD
                       AND X1.SLS_REP_ROLE_TP_CD  = X2.LINE_BIZ_ROLE_TP_CD
                       AND X2.EZCANCELFLAG        = '0'
                       AND X2.PRIM_REP_ROLE_FLG   = 'Y'
                       AND X2.SLS_CR_QUOT_FLG     = 'Y'
                       AND X1.GLBL_CMPY_CD        = X3.GLBL_CMPY_CD
                       AND X1.SLS_REP_TOC_CD      = X3.TOC_CD
                       AND X3.EZCANCELFLAG        = '0'
                       AND X3.EFF_FROM_DT         &lt;= #slsDt#
<!--2019/05/14 #50093 Del Start-->
<!--                       AND NVL(X3.EFF_THRU_DT, #slsDt#) -->
<!--                                                  &gt;= #slsDt#-->
<!--2019/05/14 #50093 Del End-->
                  ) X
              WHERE
                  X.ROW_NUM = 1
             )               SLS_REP
            ,(
              SELECT
                   X.CPO_ORD_NUM
                  ,X.DS_CPO_CONFIG_PK
                  ,X.PSN_CD
              FROM
                  (SELECT /*+ NO_PUSH_PRED */
                        X1.CPO_ORD_NUM
                       ,X1.DS_CPO_CONFIG_PK
                       ,X3.PSN_CD
                       ,ROW_NUMBER() OVER (PARTITION BY X1.CPO_ORD_NUM, X1.DS_CPO_CONFIG_PK ORDER BY X1.SLS_REP_CR_PCT DESC, X1.SLS_REP_TOC_CD ASC) AS ROW_NUM
                   FROM
                        DS_CPO_SLS_CR    X1
                       ,LINE_BIZ_ROLE_TP X2
                       ,ORG_FUNC_ASG     X3
                   WHERE
                           X1.GLBL_CMPY_CD        = #glblCmpyCd#
                       AND X1.EZCANCELFLAG        = '0'
                       AND X1.GLBL_CMPY_CD        = X2.GLBL_CMPY_CD
                       AND X1.SLS_REP_ROLE_TP_CD  = X2.LINE_BIZ_ROLE_TP_CD
                       AND X2.EZCANCELFLAG        = '0'
                       AND X2.PRIM_REP_ROLE_FLG   = 'N'
                       AND X2.SLS_CR_QUOT_FLG     = 'Y'
                       AND X1.GLBL_CMPY_CD        = X3.GLBL_CMPY_CD
                       AND X1.SLS_REP_TOC_CD      = X3.TOC_CD
                       AND X3.EZCANCELFLAG        = '0'
                       AND X3.EFF_FROM_DT         &lt;= #slsDt#
<!--2019/05/14 #50093 Del Start-->
<!--                       AND NVL(X3.EFF_THRU_DT, #slsDt#) -->
<!--                                                  &gt;= #slsDt#-->
<!--2019/05/14 #50093 Del End-->
                  ) X
              WHERE
                  X.ROW_NUM = 1
             )               INST_REP
            ,(
              SELECT
                   X1.CPO_ORD_NUM
                  ,X1.DS_CPO_RTRN_LINE_NUM      AS CPO_DTL_LINE_NUM
                  ,X1.DS_CPO_RTRN_LINE_SUB_NUM  AS CPO_DTL_LINE_SUB_NUM
                  ,COUNT(X3.MDSE_CD) COUNT
              FROM
                   DS_CPO_RTRN_DTL X1
                  ,DS_CPO_CONFIG   X2
                  ,ALL_MDSE_V      X3
                  ,DS_MDL          X4
              WHERE
                      X1.GLBL_CMPY_CD         = #glblCmpyCd#
                  AND X1.BASE_CMPT_FLG        = 'Y'
                  AND X1.EZCANCELFLAG         = '0'
                  AND X1.GLBL_CMPY_CD         = X2.GLBL_CMPY_CD
                  AND X1.CPO_ORD_NUM          = X2.CPO_ORD_NUM
                  AND X1.DS_ORD_POSN_NUM      = X2.DS_ORD_POSN_NUM
                  AND X2.EZCANCELFLAG         = '0'
                  AND X1.GLBL_CMPY_CD         = X3.GLBL_CMPY_CD
                  AND X1.MDSE_CD              = X3.MDSE_CD
                  AND X3.EZCANCELFLAG         = '0'
                  AND X3.COA_MDSE_TP_CD       = #coaMdseTpMachine#
                  AND X2.GLBL_CMPY_CD         = X4.GLBL_CMPY_CD
                  AND X2.MDL_ID               = X4.MDL_ID
                  AND X4.EZCANCELFLAG         = '0'
                  AND X4.MTR_GRP_PK           IS NOT NULL
              GROUP BY
                   X1.CPO_ORD_NUM
                  ,X1.DS_CPO_RTRN_LINE_NUM
                  ,X1.DS_CPO_RTRN_LINE_SUB_NUM
             )               PRTR_COUNT

        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            AND A.TRX_SRC_TP_CD         = #invTrxSrcTpWSReturn#  <!-- 2018/10/30 QC#29033 Add -->
            AND A.EZCANCELFLAG          = '0'
            AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
            AND A.INV_NUM               = B.INV_NUM
            AND B.EZCANCELFLAG          = '0'
            <iterate property="compProcStsCdList" var="compProcStsCd[]" open="AND B.COMP_PROC_STS_CD IN (" close=")" conjunction=",">
                #compProcStsCd[]#
            </iterate>
            AND A.GLBL_CMPY_CD          = D.GLBL_CMPY_CD
            AND A.CPO_ORD_NUM           = D.CPO_ORD_NUM
            AND D.EZCANCELFLAG          = '0'
            AND A.GLBL_CMPY_CD          = F.GLBL_CMPY_CD
            AND A.CPO_ORD_NUM           = F.CPO_ORD_NUM
            AND B.CPO_DTL_LINE_NUM      = F.DS_CPO_RTRN_LINE_NUM
            AND B.CPO_DTL_LINE_SUB_NUM  = F.DS_CPO_RTRN_LINE_SUB_NUM
            AND F.EZCANCELFLAG          = '0'
            AND F.GLBL_CMPY_CD          = H.GLBL_CMPY_CD
            AND F.CPO_ORD_NUM           = H.CPO_ORD_NUM
            AND F.DS_CPO_CONFIG_PK      = H.DS_CPO_CONFIG_PK
            AND H.EZCANCELFLAG          = '0'
            AND B.GLBL_CMPY_CD          = I.GLBL_CMPY_CD
            AND B.MDSE_CD               = I.MDSE_CD
            AND I.EZCANCELFLAG          = '0'
            AND H.GLBL_CMPY_CD          = J.T_GLBL_CMPY_CD (+)
            AND H.MDL_ID                = J.T_MDL_ID (+)
            AND J.EZCANCELFLAG (+)      = '0'
            <!-- 2018/10/24 QC#28585 Mod Start -->
            <!--
            AND O.GLBL_CMPY_CD          = F.GLBL_CMPY_CD
            AND O.TRX_ORD_NUM           = F.CPO_ORD_NUM
            AND O.EZCANCELFLAG          = '0'
            AND P.RWS_NUM (+)           = O.RWS_NUM
            AND P.GLBL_CMPY_CD (+)      = O.GLBL_CMPY_CD
            AND P.TRX_LINE_NUM (+)      = F.DS_CPO_RTRN_LINE_NUM
            AND P.TRX_LINE_SUB_NUM (+)  = F.DS_CPO_RTRN_LINE_SUB_NUM
            AND P.EZCANCELFLAG (+)      = '0'
            AND Q.GLBL_CMPY_CD (+)      = P.GLBL_CMPY_CD
            AND Q.RWS_NUM (+)           = P.RWS_NUM
            AND Q.RWS_LINE_NUM (+)      = P.RWS_DTL_LINE_NUM
            AND Q.EZCANCELFLAG (+)      = '0'
            -->
            AND Q.TRX_ORD_NUM (+)       = F.CPO_ORD_NUM
            AND Q.TRX_LINE_NUM (+)      = F.DS_CPO_RTRN_LINE_NUM
            AND Q.TRX_LINE_SUB_NUM (+)  = F.DS_CPO_RTRN_LINE_SUB_NUM
            <!-- 2018/10/24 QC#28585 Mod End -->
            AND H.GLBL_CMPY_CD          = M.GLBL_CMPY_CD
            AND H.BILL_TO_CUST_ACCT_CD  = M.SELL_TO_CUST_CD
            AND M.EZCANCELFLAG          = '0'
            AND H.GLBL_CMPY_CD          = N.GLBL_CMPY_CD
            AND H.SHIP_TO_CUST_ACCT_CD  = N.SELL_TO_CUST_CD
            AND N.EZCANCELFLAG          = '0'
            AND H.BILL_TO_CUST_ACCT_CD  = ACCT_COUNT.BILL_TO_CUST_ACCT_CD (+)
            AND D.DS_ORD_CATG_CD        = LEASE_COUNT.DS_ORD_CATG_CD (+)
            AND Q.SER_NUM               = RMNF_COUNT.RMNF_TO_CMPT_SER_NUM (+)
            AND H.CPO_ORD_NUM           = SLS_REP.CPO_ORD_NUM (+)
            AND H.DS_CPO_CONFIG_PK      = SLS_REP.DS_CPO_CONFIG_PK (+)
            AND H.CPO_ORD_NUM           = INST_REP.CPO_ORD_NUM (+)
            AND H.DS_CPO_CONFIG_PK      = INST_REP.DS_CPO_CONFIG_PK (+)
            AND F.CPO_ORD_NUM           = PRTR_COUNT.CPO_ORD_NUM (+)
            AND F.DS_CPO_RTRN_LINE_NUM     = PRTR_COUNT.CPO_DTL_LINE_NUM (+)
            AND F.DS_CPO_RTRN_LINE_SUB_NUM = PRTR_COUNT.CPO_DTL_LINE_SUB_NUM (+)
            AND EXISTS (
                    SELECT
                        1
                    FROM
                         DS_CPO_SLS_CR     X1
                        ,LINE_BIZ_ROLE_TP  X2
                        ,CPO_V             X3
                    WHERE
                            X1.GLBL_CMPY_CD        = H.GLBL_CMPY_CD
                        AND X1.CPO_ORD_NUM         = H.CPO_ORD_NUM
                        AND X1.DS_CPO_CONFIG_PK    = H.DS_CPO_CONFIG_PK
                        AND X1.EZCANCELFLAG        = '0'
                        AND X1.GLBL_CMPY_CD        = X2.GLBL_CMPY_CD
                        AND X1.SLS_REP_ROLE_TP_CD  = X2.LINE_BIZ_ROLE_TP_CD
                        AND X2.EZCANCELFLAG        = '0'
                        AND X2.SLS_CR_QUOT_FLG     = 'Y'
                        AND X1.GLBL_CMPY_CD        = X3.GLBL_CMPY_CD
                        AND X1.CPO_ORD_NUM         = X3.CPO_ORD_NUM
                        AND X3.EZCANCELFLAG        = '0'
                        AND X3.LINE_BIZ_TP_CD      = #lineBizTpCd#
                )
    )
    ,INV_COUNT AS (
        SELECT
             COMP_INFO.INV_NUM
            ,COMP_INFO.INV_BOL_LINE_NUM
            ,COMP_INFO.INV_LINE_NUM
            ,COMP_INFO.INV_LINE_SUB_NUM
            ,COMP_INFO.INV_LINE_SUB_TRX_NUM
            ,COUNT(COMP_INFO.INV_NUM) AS COUNT
        FROM
            COMP_INFO
        GROUP BY
             COMP_INFO.INV_NUM
            ,COMP_INFO.INV_BOL_LINE_NUM
            ,COMP_INFO.INV_LINE_NUM
            ,COMP_INFO.INV_LINE_SUB_NUM
            ,COMP_INFO.INV_LINE_SUB_TRX_NUM
    )
    ,CONTR_DURN AS (
        SELECT
             X1.INV_NUM
            ,X1.INV_BOL_LINE_NUM
            ,X1.INV_LINE_NUM
            ,X1.INV_LINE_SUB_NUM
            ,X1.INV_LINE_SUB_TRX_NUM
            ,X1.SER_NUM
            ,X2.CONTR_DURN_AOT * NVL(X3.BLLG_CYCLE_MTH_AOT, X3.BLLG_CYCLE_DAYS_AOT)  AS CONTR_DURN_AOT
        FROM
             (
              SELECT /*+ NO_PUSH_PRED */
                   COMP_INFO.GLBL_CMPY_CD
                  ,COMP_INFO.INV_NUM
                  ,COMP_INFO.INV_BOL_LINE_NUM
                  ,COMP_INFO.INV_LINE_NUM
                  ,COMP_INFO.INV_LINE_SUB_NUM
                  ,COMP_INFO.INV_LINE_SUB_TRX_NUM
                  ,COMP_INFO.SER_NUM
                  ,Y2.DS_CONTR_PK
                  ,ROW_NUMBER() OVER (PARTITION BY Y2.SVC_MACH_MSTR_PK ORDER BY Y2.CONTR_EFF_THRU_DT DESC, Y2.DS_CONTR_DTL_PK DESC) AS ROW_NUM
              FROM
                   COMP_INFO
                  ,SVC_MACH_MSTR  Y1
                  ,DS_CONTR_DTL   Y2
              WHERE
                      COMP_INFO.GLBL_CMPY_CD     = Y1.GLBL_CMPY_CD
                  AND COMP_INFO.SVC_MACH_MSTR_PK = Y1.SVC_MACH_MSTR_PK
                  <!-- 2018/10/02 QC#28585 Add Start -->
                  AND NVL(COMP_INFO.SER_NUM, #defSerNum#)
                                                 = NVL(Y1.SER_NUM, #defSerNum#)
                  <!-- 2018/10/02 QC#28585 Add End -->
                  AND Y1.EZCANCELFLAG            = '0'
                  AND Y1.GLBL_CMPY_CD            = Y2.GLBL_CMPY_CD
                  AND Y1.SVC_MACH_MSTR_PK        = Y2.SVC_MACH_MSTR_PK
                  AND Y2.EZCANCELFLAG            = '0'
                  <iterate property="dsContrDtlStsCdList" var="dsContrDtlStsCd[]" open="AND Y2.DS_CONTR_DTL_STS_CD NOT IN (" close=")" conjunction=",">
                      #dsContrDtlStsCd[]#
                  </iterate>
                  AND Y2.CONTR_EFF_FROM_DT      &lt;= COMP_INFO.ORD_BOOK_DT
                  AND NVL(Y2.CONTR_CLO_DT, Y2.CONTR_EFF_THRU_DT )
                                                &gt;= COMP_INFO.ORD_BOOK_DT
             )                X1
            ,DS_CONTR         X2
            ,BLLG_CYCLE_UOM   X3
        WHERE
                X1.ROW_NUM            = 1
            AND X1.GLBL_CMPY_CD       = X2.GLBL_CMPY_CD
            AND X1.DS_CONTR_PK        = X2.DS_CONTR_PK
            AND X2.EZCANCELFLAG       = '0'
            AND X2.CONTR_DURN_AOT     IS NOT NULL
            AND X2.GLBL_CMPY_CD       = X3.GLBL_CMPY_CD
            AND X2.BLLG_CYCLE_UOM_CD  = X3.BLLG_CYCLE_UOM_CD
            AND X3.EZCANCELFLAG       = '0'
    )
    ,LEASE_TERM AS (
        SELECT
             COMP_INFO.GLBL_CMPY_CD
            ,COMP_INFO.INV_NUM
            ,COMP_INFO.INV_BOL_LINE_NUM
            ,COMP_INFO.INV_LINE_NUM
            ,COMP_INFO.INV_LINE_SUB_NUM
            ,COMP_INFO.INV_LINE_SUB_TRX_NUM
            ,COMP_INFO.SER_NUM
            ,COMP_INFO.LEASE_TERM_MTH_AOT
            ,CASE
             WHEN COMP_INFO.LEASE_TERM_MTH_AOT IS NULL
             THEN (SELECT TRUNC(SUM(MONTHS_BETWEEN(TO_DATE(C1.HDR_END_DT, #dateFormat#), TO_DATE(C1.HDR_START_DT, #dateFormat#)))) LEASE_TERM
                 FROM   CFS_LEASE_CONTR C1
                 WHERE  Z2.GLBL_CMPY_CD  = C1.GLBL_CMPY_CD
                 AND    Z2.SER_NUM       = C1.SER_NUM
                 AND    C1.EZCANCELFLAG  = '0')
            ELSE NULL
            END AS LEASE_TERM_SER
          ,CASE
           WHEN COMP_INFO.LEASE_TERM_MTH_AOT IS NULL
           THEN (SELECT TRUNC(SUM(MONTHS_BETWEEN(TO_DATE(C4.HDR_END_DT, #dateFormat#), TO_DATE(C4.HDR_START_DT, #dateFormat#)))) LEASE_TERM
                 FROM   DS_CONTR_DTL    C2
                       ,DS_CONTR        C3
                       ,CFS_LEASE_CONTR C4
                 WHERE  Z2.GLBL_CMPY_CD     = C2.GLBL_CMPY_CD
                 AND    Z2.SVC_CONFIG_MSTR_PK = C2.SVC_CONFIG_MSTR_PK
                 AND    C2.EZCANCELFLAG = '0'

                 AND    C2.GLBL_CMPY_CD     = C3.GLBL_CMPY_CD
                 AND    C2.DS_CONTR_PK      = C3.DS_CONTR_PK
                 AND    C3.EZCANCELFLAG     = '0'

                 AND    C3.GLBL_CMPY_CD     = C4.GLBL_CMPY_CD
                 AND    C3.DS_CONTR_NUM     = C4.CSA_CONTR_NUM
                 AND    C4.EZCANCELFLAG     = '0'
                 
                 )
            ELSE NULL
            END AS LEASE_TERM_CONTR
      FROM
           COMP_INFO
          ,SVC_CONFIG_MSTR  Z1
          ,SVC_MACH_MSTR    Z2
      WHERE
              COMP_INFO.GLBL_CMPY_CD       = Z1.GLBL_CMPY_CD
          AND COMP_INFO.SVC_CONFIG_MSTR_PK = Z1.SVC_CONFIG_MSTR_PK
          AND Z1.EZCANCELFLAG              = '0'

          AND Z1.GLBL_CMPY_CD              = Z2.GLBL_CMPY_CD
          AND Z1.SVC_MACH_MSTR_PK          = Z2.SVC_MACH_MSTR_PK
          AND Z2.EZCANCELFLAG              = '0'
    )
    ,RENTAL_TERM AS (
        SELECT
             X1.INV_NUM
            ,X1.INV_BOL_LINE_NUM
            ,X1.INV_LINE_NUM
            ,X1.INV_LINE_SUB_NUM
            ,X1.INV_LINE_SUB_TRX_NUM
            ,X1.SER_NUM
            ,TRUNC(MONTHS_BETWEEN(TO_DATE(X2.CONTR_VRSN_EFF_THRU_DT, #dateFormat#), TO_DATE(X2.CONTR_VRSN_EFF_FROM_DT, #dateFormat#))) RENTAL_TERM
        FROM
             (
              SELECT /*+ NO_PUSH_PRED */
                   COMP_INFO.GLBL_CMPY_CD
                  ,COMP_INFO.INV_NUM
                  ,COMP_INFO.INV_BOL_LINE_NUM
                  ,COMP_INFO.INV_LINE_NUM
                  ,COMP_INFO.INV_LINE_SUB_NUM
                  ,COMP_INFO.INV_LINE_SUB_TRX_NUM
                  ,COMP_INFO.SER_NUM
                  ,Y2.DS_CONTR_PK
                  ,ROW_NUMBER() OVER (PARTITION BY Y2.SVC_MACH_MSTR_PK ORDER BY Y2.CONTR_EFF_THRU_DT DESC, Y2.DS_CONTR_DTL_PK DESC) AS ROW_NUM
              FROM
                   COMP_INFO
                  ,SVC_MACH_MSTR    Y1
                  ,DS_CONTR_DTL     Y2
                  ,ORD_CATG_BIZ_CTX Y3
              WHERE
                      Y3.GLBL_CMPY_CD            = COMP_INFO.GLBL_CMPY_CD
                  AND Y3.ORD_CATG_CTX_TP_CD      = #ordCatgCtxTRetal#
                  AND Y3.DS_ORD_CATG_CD          = COMP_INFO.DS_ORD_CATG_CD
                  AND (Y3.DS_ORD_TP_CD           = COMP_INFO.DS_ORD_TP_CD
                      OR  Y3.DS_ORD_TP_CD    IS NULL)
                  AND Y3.EZCANCELFLAG            = '0'
                  AND COMP_INFO.GLBL_CMPY_CD     = Y1.GLBL_CMPY_CD
                  AND COMP_INFO.SVC_MACH_MSTR_PK = Y1.SVC_MACH_MSTR_PK
                  AND Y1.EZCANCELFLAG            = '0'
                  AND Y1.GLBL_CMPY_CD            = Y2.GLBL_CMPY_CD
                  AND Y1.SVC_MACH_MSTR_PK        = Y2.SVC_MACH_MSTR_PK
                  AND Y2.EZCANCELFLAG            = '0'
                  <iterate property="dsContrDtlStsCdForRentalList" var="dsContrDtlStsCdForRental[]" open="AND Y2.DS_CONTR_DTL_STS_CD NOT IN (" close=")" conjunction=",">
                      #dsContrDtlStsCdForRental[]#
                  </iterate>
             )                X1
            ,DS_CONTR         X2
        WHERE
                X1.ROW_NUM            = 1
            AND X1.GLBL_CMPY_CD       = X2.GLBL_CMPY_CD
            AND X1.DS_CONTR_PK        = X2.DS_CONTR_PK
            AND X2.EZCANCELFLAG       = '0'
            AND X2.CONTR_DURN_AOT     IS NOT NULL
    )

        SELECT
             COMP_INFO.CPO_ORD_NUM
            ,COMP_INFO.DS_ORD_POSN_NUM
            ,TO_CHAR(COMP_INFO.DS_CPO_LINE_NUM) AS CPO_DTL_LINE_NUM
            <!-- START 2018/10/24 Hd.Sugawara [QC#28844,MOD] -->
            <!-- ,TO_CHAR(COMP_INFO.DS_CPO_LINE_SUB_NUM) AS CPO_DTL_LINE_SUB_NUM -->
            ,COMP_INFO.CPO_DTL_LINE_SUB_NUM
            <!-- END 2018/10/24 Hd.Sugawara [QC#28844,MOD] -->
            ,COMP_INFO.NEW_CUST_FLG
            ,COMP_INFO.BILL_TO_CUST_ACCT_CD
            ,COMP_INFO.BILL_TO_CUST_ACCT_NM
            ,COMP_INFO.SHIP_TO_CUST_ACCT_CD
            ,COMP_INFO.SHIP_TO_CUST_ACCT_NM
            ,COMP_INFO.CR_CUST_CD
            ,COMP_INFO.LEASE_FLG
            ,COMP_INFO.SVC_CONFIG_MSTR_PK
            ,CASE
             WHEN CONTR_DURN.CONTR_DURN_AOT    IS NOT NULL THEN CONTR_DURN.CONTR_DURN_AOT
             WHEN RENTAL_TERM.RENTAL_TERM      IS NOT NULL THEN RENTAL_TERM.RENTAL_TERM
             WHEN COMP_INFO.LEASE_TERM_MTH_AOT IS NOT NULL THEN COMP_INFO.LEASE_TERM_MTH_AOT
             WHEN LEASE_TERM.LEASE_TERM_SER    IS NOT NULL THEN LEASE_TERM.LEASE_TERM_SER
             WHEN LEASE_TERM.LEASE_TERM_CONTR  IS NOT NULL THEN LEASE_TERM.LEASE_TERM_CONTR
             ELSE NULL
             END AS CONTR_DURN_AOT
            ,COMP_INFO.COMP_QTR_CD
            ,COMP_INFO.ORD_DT
            ,COMP_INFO.ORD_BOOK_DT
            ,COMP_INFO.ORD_RTRN_DT
            ,CASE 
             WHEN COMP_INFO.CR_REBIL_CD IN (#crCdCredit#, #crCdRebill#) THEN COMP_INFO.ACCT_DT
             ELSE COMP_INFO.INV_DT
             END AS INV_DT
            ,COMP_INFO.INV_NUM
            ,COMP_INFO.INV_LINE_NUM
            ,COMP_INFO.INV_LINE_SUB_NUM
            ,COMP_INFO.SLS_REP_PSN_CD
            ,COMP_INFO.ISTL_REP_PSN_CD
            <!-- 2018/11/09 QC#29131 Del Start -->
            <!--
            ,(CASE
                 WHEN INV_COUNT.COUNT &gt; 1 THEN 1
                 ELSE COMP_INFO.SHIP_QTY
             END) * SIGN                 AS COMP_BLLG_QTY
             -->
             <!-- 2018/11/09 QC#29131 Del End -->
             <!-- 2018/11/09 QC#29131 Add Start -->
            ,(CASE
                 WHEN INV_COUNT.COUNT &gt; 1 THEN 1
                 ELSE COMP_INFO.SHIP_QTY
             END)  * -1                   AS COMP_BLLG_QTY
             <!-- 2018/11/09 QC#29131 Add End -->
            ,COMP_INFO.MDSE_CD
            ,COMP_INFO.MDSE_DESC_SHORT_TXT
            ,COMP_INFO.T_MDL_NM
            ,COMP_INFO.SER_NUM
            <!-- 2018/11/09 QC#29131 Del Start -->
            <!--
            ,(CASE
                 WHEN COMP_INFO.BOX_NEW_QTY = 0 THEN 0
                 WHEN INV_COUNT.COUNT &gt; 1 THEN 1
                 ELSE COMP_INFO.BOX_NEW_QTY
             END) * SIGN                 AS BOX_NEW_QTY
             -->
             <!-- 2018/11/09 QC#29131 Del End -->
             <!-- 2018/11/09 QC#29131 Add Start -->
            ,(CASE
                 WHEN COMP_INFO.BOX_NEW_QTY = 0 THEN 0
                 WHEN INV_COUNT.COUNT &gt; 1 THEN 1
                 ELSE COMP_INFO.BOX_NEW_QTY
             END) * -1                    AS BOX_NEW_QTY
             <!-- 2018/11/09 QC#29131 Add End -->
             <!-- 2018/11/09 QC#29131 Del Start -->
             <!--
            ,(CASE
                 WHEN COMP_INFO.BOX_USED_QTY = 0 THEN 0
                 WHEN INV_COUNT.COUNT &gt; 1 THEN 1
                 ELSE COMP_INFO.BOX_USED_QTY
             END) * SIGN                 AS BOX_USED_QTY
             -->
             <!-- 2018/11/09 QC#29131 Del End -->
             <!-- 2018/11/09 QC#29131 Add Start -->
            ,(CASE
                 WHEN COMP_INFO.BOX_USED_QTY = 0 THEN 0
                 WHEN INV_COUNT.COUNT &gt; 1 THEN 1
                 ELSE COMP_INFO.BOX_USED_QTY
             END) * -1                    AS BOX_USED_QTY
             <!-- 2018/11/09 QC#29131 Add End -->
             <!-- 2018/11/09 QC#29131 Del Start -->
             <!--
            ,(CASE
                 WHEN INV_COUNT.COUNT &gt; 1 THEN 
                 CASE
                     WHEN COMP_INFO.CR_REBIL_CD = #crCdCredit# THEN COMP_INFO.DEAL_NET_UNIT_PRC_AMT * (-1)
                     ELSE COMP_INFO.DEAL_NET_UNIT_PRC_AMT
                 END
                 ELSE
                 CASE
                     WHEN COMP_INFO.CR_REBIL_CD = #crCdCredit# THEN COMP_INFO.INV_LINE_DEAL_NET_AMT * (-1)
                     ELSE COMP_INFO.INV_LINE_DEAL_NET_AMT
                 END
             END) * SIGN                 AS COMP_VAL_AMT
             -->
             <!-- 2018/11/09 QC#29131 Del End -->
             <!-- 2018/11/09 QC#29131 Add Start -->
            ,(CASE WHEN INV_COUNT.COUNT &gt; 1 THEN
                 CASE WHEN COMP_INFO.INV_TP_CD = #creditMemo# THEN 
                     COMP_INFO.DEAL_NET_UNIT_PRC_AMT * (-1)
                 ELSE 
                     COMP_INFO.DEAL_NET_UNIT_PRC_AMT
                 END
             ELSE
                 CASE WHEN COMP_INFO.INV_TP_CD = #creditMemo# THEN
                     COMP_INFO.INV_LINE_DEAL_NET_AMT * (-1)
                 ELSE 
                     COMP_INFO.INV_LINE_DEAL_NET_AMT
                 END
              END)  AS COMP_VAL_AMT
             <!-- 2018/11/09 QC#29131 Add End -->
            ,COMP_INFO.DS_ORD_CATG_CD
            ,COMP_INFO.DS_ORD_TP_CD
            ,COMP_INFO.COMP_PRTR_FLG
            ,COMP_INFO.CR_REBIL_RSN_CD
            ,COMP_INFO.INV_BOL_LINE_NUM
            ,COMP_INFO.INV_LINE_SUB_TRX_NUM
            ,COMP_INFO.DS_ORD_RSN_CD
            ,NULL AS AQU_NUM  <!-- 2022/03/01 QC#59744 Add -->
            ,NULL AS ADD_SHIP_TO_CTY_ADDR  <!-- 2022/03/01 QC#59744 Add -->
            ,NULL AS ADD_SHIP_TO_ST_CD  <!-- 2022/03/01 QC#59744 Add -->
            ,NULL AS DEAL_PRC_LIST_PRC_AMT  <!-- 2022/03/01 QC#59744 Add -->
        FROM
             COMP_INFO
            ,INV_COUNT
            ,CONTR_DURN
            ,LEASE_TERM
            ,RENTAL_TERM
        WHERE
                COMP_INFO.INV_NUM               = INV_COUNT.INV_NUM
            AND COMP_INFO.INV_BOL_LINE_NUM      = INV_COUNT.INV_BOL_LINE_NUM
            AND COMP_INFO.INV_LINE_NUM          = INV_COUNT.INV_LINE_NUM
            AND COMP_INFO.INV_LINE_SUB_NUM      = INV_COUNT.INV_LINE_SUB_NUM
            AND COMP_INFO.INV_LINE_SUB_TRX_NUM  = INV_COUNT.INV_LINE_SUB_TRX_NUM
            AND COMP_INFO.INV_NUM               = CONTR_DURN.INV_NUM (+)
            AND COMP_INFO.INV_BOL_LINE_NUM      = CONTR_DURN.INV_BOL_LINE_NUM (+)
            AND COMP_INFO.INV_LINE_NUM          = CONTR_DURN.INV_LINE_NUM (+)
            AND COMP_INFO.INV_LINE_SUB_NUM      = CONTR_DURN.INV_LINE_SUB_NUM (+)
            AND COMP_INFO.INV_LINE_SUB_TRX_NUM  = CONTR_DURN.INV_LINE_SUB_TRX_NUM (+)
            AND NVL(COMP_INFO.SER_NUM, #defSerNum#)
                                                = NVL(CONTR_DURN.SER_NUM (+), #defSerNum#)
            AND COMP_INFO.INV_NUM               = LEASE_TERM.INV_NUM (+)
            AND COMP_INFO.INV_BOL_LINE_NUM      = LEASE_TERM.INV_BOL_LINE_NUM (+)
            AND COMP_INFO.INV_LINE_NUM          = LEASE_TERM.INV_LINE_NUM (+)
            AND COMP_INFO.INV_LINE_SUB_NUM      = LEASE_TERM.INV_LINE_SUB_NUM (+)
            AND COMP_INFO.INV_LINE_SUB_TRX_NUM  = LEASE_TERM.INV_LINE_SUB_TRX_NUM (+)
            AND COMP_INFO.INV_NUM               = RENTAL_TERM.INV_NUM (+)
            AND COMP_INFO.INV_BOL_LINE_NUM      = RENTAL_TERM.INV_BOL_LINE_NUM (+)
            AND COMP_INFO.INV_LINE_NUM          = RENTAL_TERM.INV_LINE_NUM (+)
            AND COMP_INFO.INV_LINE_SUB_NUM      = RENTAL_TERM.INV_LINE_SUB_NUM (+)
            AND COMP_INFO.INV_LINE_SUB_TRX_NUM  = RENTAL_TERM.INV_LINE_SUB_TRX_NUM (+)
        ORDER BY
             COMP_INFO.INV_NUM               ASC
            ,COMP_INFO.INV_BOL_LINE_NUM      ASC
            ,COMP_INFO.INV_LINE_NUM          ASC
            ,COMP_INFO.INV_LINE_SUB_NUM      ASC
            ,COMP_INFO.INV_LINE_SUB_TRX_NUM  ASC
            ,COMP_INFO.SER_NUM               ASC NULLS LAST
    </statement>
    <!-- 2018/09/25 QC#28231 Add End -->
</sqlMap>
