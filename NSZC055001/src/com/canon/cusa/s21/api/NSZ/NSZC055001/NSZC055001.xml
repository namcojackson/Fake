<?xml version="1.0" encoding="UTF-8" standalone="yes"?>

<sqlMap namespace="NSZC055001">
    <statement id="getServiceContractBilling" parameterClass="Map" resultClass="Map">
        SELECT
             BLLG.SVC_CONTR_BLLG_PK
            ,BLLG.DS_CONTR_PK
            ,BLLG.DS_CONTR_DTL_PK
            <!-- START 2018/04/23 K.Kojima [QC#25446,ADD] -->
            ,CONTR.DS_CONTR_CATG_CD
            <!-- END 2018/04/23 K.Kojima [QC#25446,ADD] -->
        FROM
             SVC_CONTR_BLLG BLLG
            <!-- START 2019/11/28 [QC#53567,ADD] -->
            ,SVC_CONTR_MTR_BLLG MBL
            <!-- END   2019/11/28 [QC#53567,ADD] -->
            ,DS_CONTR_DTL DTL
            ,DS_CONTR CONTR
        WHERE
            BLLG.DS_CONTR_PK        = DTL.DS_CONTR_PK
        AND BLLG.DS_CONTR_DTL_PK    = DTL.DS_CONTR_DTL_PK
        AND BLLG.GLBL_CMPY_CD       = DTL.GLBL_CMPY_CD
        AND DTL.DS_CONTR_PK         = CONTR.DS_CONTR_PK
        AND DTL.GLBL_CMPY_CD        = CONTR.GLBL_CMPY_CD
        AND BLLG.GLBL_CMPY_CD       = #glblCmpyCd#
        <isNotNull property="dsContrPk">
        AND BLLG.DS_CONTR_PK        = #dsContrPk#
        </isNotNull>
        <isNotNull property="dsContrNum">
        AND CONTR.DS_CONTR_NUM      = #dsContrNum#
        </isNotNull>
        <isNotNull property="svcMachMstrPk">
        AND BLLG.SVC_MACH_MSTR_PK   = #svcMachMstrPk#
        </isNotNull>
        <isNotNull property="billToCustCd">
        AND BLLG.BILL_TO_CUST_CD    = #billToCustCd#
        </isNotNull>
        <isNotNull property="svcContrBllgThruDt">
        AND BLLG.SVC_CONTR_BLLG_THRU_DT = #svcContrBllgThruDt#
        </isNotNull>
        AND BLLG.BLLG_CPLT_STS_CD   = #bllgCpltStsCd#
        AND BLLG.BLLG_APVL_REQ_FLG  = 'Y'
        AND BLLG.EZCANCELFLAG       = '0'
        <!-- START 2018/12/20 K.Kitachi [QC#29647, ADD] -->
        AND DTL.DS_CONTR_DTL_TP_CD  &lt;&gt; #dsContrDtlTpCd#
        <!-- END 2018/12/20 K.Kitachi [QC#29647, ADD] -->
        AND DTL.EZCANCELFLAG        = '0'
        AND CONTR.EZCANCELFLAG      = '0'
        <!-- START 2019/11/28 [QC#53567,ADD] -->
        AND BLLG.GLBL_CMPY_CD       = MBL.GLBL_CMPY_CD
        AND MBL.EZCANCELFLAG        = '0'
        AND BLLG.SVC_CONTR_BLLG_PK  = MBL.SVC_CONTR_BLLG_PK
        <isEqual property="negFlg" compareValue="Y">
        	AND MBL.MTR_COPY_QTY     &lt; 0
        </isEqual>
        <isEqual property="negFlg" compareValue="N">
        	AND MBL.MTR_COPY_QTY     &gt;= 0
        </isEqual>
        <!-- END   2019/11/28 [QC#53567,ADD] -->
    </statement>

    <statement id="getUnapprovedUsgChrg" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            A.SVC_CONTR_BLLG_PK
        FROM
            SVC_CONTR_BLLG A
        WHERE
                A.EZCANCELFLAG       = '0'
            AND A.GLBL_CMPY_CD       = #glblCmpyCd#
            AND A.DS_CONTR_PK        = #dsContrPk#
            AND A.BLLG_CPLT_STS_CD   = #bllgCpltStsCd#
            AND A.BLLG_APVL_REQ_FLG  = 'Y'
            AND A.BLLG_APVL_CPLT_FLG = 'N'
            AND A.USG_CHRG_FLG       = 'Y'
            <!-- START 2018/12/20 K.Kitachi [QC#29647, ADD] -->
            AND NOT EXISTS (
                SELECT
                    1
                FROM
                    DS_CONTR_DTL X
                WHERE
                        A.GLBL_CMPY_CD       = X.GLBL_CMPY_CD
                    AND A.DS_CONTR_DTL_PK    = X.DS_CONTR_DTL_PK
                    AND X.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCd#
                    AND X.EZCANCELFLAG       = '0'
            )
            <!-- END 2018/12/20 K.Kitachi [QC#29647, ADD] -->
    </statement>

    <!-- START 2018/04/23 K.Kojima [QC#25446,ADD] -->
    <statement id="getUnapprovedUsgChrgForDtl" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            A.SVC_CONTR_BLLG_PK
        FROM
            SVC_CONTR_BLLG A
        WHERE
                A.EZCANCELFLAG       = '0'
            AND A.GLBL_CMPY_CD       = #glblCmpyCd#
            AND A.DS_CONTR_DTL_PK    = #dsContrDtlPk#
            AND A.BLLG_CPLT_STS_CD   = #bllgCpltStsCd#
            AND A.BLLG_APVL_REQ_FLG  = 'Y'
            AND A.BLLG_APVL_CPLT_FLG = 'N'
            AND A.USG_CHRG_FLG       = 'Y'
            <!-- START 2018/12/20 K.Kitachi [QC#29647, ADD] -->
            AND NOT EXISTS (
                SELECT
                    1
                FROM
                    DS_CONTR_DTL X
                WHERE
                        A.GLBL_CMPY_CD       = X.GLBL_CMPY_CD
                    AND A.DS_CONTR_DTL_PK    = X.DS_CONTR_DTL_PK
                    AND X.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCd#
                    AND X.EZCANCELFLAG       = '0'
            )
            <!-- END 2018/12/20 K.Kitachi [QC#29647, ADD] -->
    </statement>
    <!-- END 2018/04/23 K.Kojima [QC#25446,ADD] -->
    <!-- START 2018/07/03 K.Kim [QC#26726,ADD] -->
    <statement id="getCreditAndRebillCnt" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            COUNT(*)
        FROM
            SVC_CR_REBIL     A
           ,SVC_CR_REBIL_DTL B
        WHERE
                A.GLBL_CMPY_CD        = #glblCmpyCd#
            AND A.EZCANCELFLAG        = '0'
            <iterate property="svcCrRebilStsCdList" var="svcCrRebilStsCd[]" open="AND A.SVC_CR_REBIL_STS_CD NOT IN (" conjunction= ", " close=")">
            #svcCrRebilStsCd[]#
            </iterate>
            AND A.GLBL_CMPY_CD        = B.GLBL_CMPY_CD
            AND A.SVC_CR_REBIL_PK     = B.SVC_CR_REBIL_PK
            AND B.DS_CONTR_PK         = #dsContrPk#
            AND B.EZCANCELFLAG        = '0'
    </statement>
    <!-- END 2018/07/03 K.Kim [QC#26726,ADD] -->
    <!-- START 2018/12/20 K.Kitachi [QC#29647, ADD] -->
    <statement id="getBillingHoldBllgMtr" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            A.DS_CONTR_BLLG_MTR_PK
        FROM
            DS_CONTR_BLLG_MTR A
        WHERE
                A.GLBL_CMPY_CD    = #glblCmpyCd#
            AND A.DS_CONTR_DTL_PK = #dsContrDtlPk#
            AND A.BLLG_HLD_FLG    = 'Y'
            AND A.EZCANCELFLAG    = '0'
    </statement>
    <statement id="getBillingHoldPrcEff" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            A.DS_CONTR_PRC_EFF_PK
        FROM
            DS_CONTR_PRC_EFF A
        WHERE
                A.GLBL_CMPY_CD    = #glblCmpyCd#
            AND A.DS_CONTR_DTL_PK = #dsContrDtlPk#
            AND A.BLLG_HLD_FLG    = 'Y'
            AND A.EZCANCELFLAG    = '0'
    </statement>
    <statement id="getBillingHoldAggLine" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            A.DS_CONTR_DTL_PK
        FROM
            DS_CONTR_DTL A
        WHERE
                A.GLBL_CMPY_CD       = #glblCmpyCd#
            AND A.DS_CONTR_PK        = #dsContrPk#
            AND A.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCd#
            AND A.BLLG_HLD_FLG       = 'Y'
            AND A.EZCANCELFLAG       = '0'
    </statement>
    <!-- END 2018/12/20 K.Kitachi [QC#29647, ADD] -->
    <!-- START 2019/07/18  [QC#51706, ADD] -->
    <statement id="getManualHldCnt" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            COUNT(*)
        FROM
            SVC_MEMO    A
        WHERE
                A.GLBL_CMPY_CD      = #glblCmpyCd#
            AND A.EZCANCELFLAG      = '0'
            AND A.DS_CONTR_PK       =  #dsContrPk#
        <isNotNull property="dsContrDtlPk">
            AND A.DS_CONTR_DTL_PK   = #dsContrDtlPk#
        </isNotNull>
        <isNull property="dsContrDtlPk">
            AND A.DS_CONTR_DTL_PK   IS NULL
        </isNull>
        <isNotNull property="dsContrBllgMtrPk">
            AND A.SVC_MEMO_TRX_NUM   = #dsContrBllgMtrPk#
        </isNotNull>
        <isNull property="dsContrBllgMtrPk">
            AND A.SVC_MEMO_TRX_NUM   IS NULL
        </isNull>
            AND A.SVC_MEMO_CATG_CD   = '__'
            AND A.SVC_MEMO_TP_CD     = '__'
            AND A.SVC_MEMO_RSN_CD    = '__'
    </statement>
    <!-- END 2019/07/18  [QC#51706, ADD] -->
</sqlMap>
