<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSAL0450Query">

    <statement id="getDSContractInfo" parameterClass="Map" resultClass="Map">
       SELECT
             DS_CONTR_PK                              AS DS_CONTR_PK
             ,DS.DS_CONTR_NUM                         AS DS_CONTR_NUM
             ,DS.DS_CONTR_CATG_CD                     AS DS_CONTR_CATG_CD
             ,DS.DS_ACCT_NUM                          AS DS_ACCT_NUM
             ,NULL                                    AS DS_CONTR_DTL_PK
             ,NULL                                    AS SVC_MACH_MSTR_PK
             ,NULL                                    AS SER_NUM
             ,NULL                                    AS MDSE_CD
             ,NULL                                    AS SVC_INV_CHRG_TP_CD
             ,NULL                                    AS SVC_INV_CHRG_TP_NM
             ,DCBA.DCBA_COUNT                         AS DCBA_COUNT
             ,DCSA.DCSA_COUNT                         AS DCSA_COUNT
             ,0                                       AS COLLAPSE
             ,1                                       AS LEVEL_NB
       FROM
               DS_CONTR DS
               , (
                  SELECT COUNT(*) AS DCBA_COUNT FROM DS_CONTR_BR_ALLOC
                  WHERE
                       GLBL_CMPY_CD                   = #glblCmpyCd#
                       AND DS_CONTR_PK                = #dsContrPk#
                       AND DS_CONTR_DTL_PK            IS NULL
                       AND SVC_INV_CHRG_TP_CD         IS NULL
                       AND EZCANCELFLAG               = '0'
               ) DCBA
               , (
                 SELECT COUNT(*) AS DCSA_COUNT FROM DS_CONTR_SEG_ALLOC
                 WHERE
                      GLBL_CMPY_CD                   = #glblCmpyCd#
                      AND DS_CONTR_PK                = #dsContrPk#
                      AND DS_CONTR_DTL_PK            IS NULL
                      AND SVC_INV_CHRG_TP_CD         IS NULL
                      AND EZCANCELFLAG               = '0'
               ) DCSA

       WHERE
             DS.GLBL_CMPY_CD                         = #glblCmpyCd#
             AND DS.DS_CONTR_PK                      = #dsContrPk#
             AND DS.EZCANCELFLAG                     = '0'
    </statement>

    <statement id="getNonFleetMachineInfo" parameterClass="Map" resultClass="Map">
<!-- START 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
       SELECT
               DS_CONTR_PK
              ,DS_CONTR_NUM
              ,DS_CONTR_CATG_CD
              ,DS_ACCT_NUM
              ,DS_CONTR_DTL_PK
              ,SVC_MACH_MSTR_PK
              ,NVL(SER_NUM,SVC_MACH_MSTR_PK||'('||MDSE_CD||')') AS SER_NUM
              ,MDSE_CD
              <!-- Add Start 2019/01/21 QC#29782 -->
              ,MDSE_DESC_SHORT_TXT
              <!-- Add End 2019/01/21 QC#29782 -->
              ,SVC_INV_CHRG_TP_CD
              ,SVC_INV_CHRG_TP_NM
              ,DCBA_COUNT
              ,DCSA_COUNT
              ,COLLAPSE
              ,LEVEL_NB
              ,SORT_NUM
              ,PRNT_DS_CONTR_DTL_PK
       FROM
       (
<!-- END 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
               SELECT
                       CONTR.DS_CONTR_PK
                      ,CONTR.DS_CONTR_NUM
                      ,CONTR.DS_CONTR_CATG_CD
                      ,CONTR.DS_ACCT_NUM
                      ,CONTR.DS_CONTR_DTL_PK
                      ,CONTR.SVC_MACH_MSTR_PK
                      ,CONTR.SER_NUM
                      ,CONTR.MDSE_CD 
                      <!-- Add Start 2019/01/21 QC#29782 -->
                      ,CONTR.MDSE_DESC_SHORT_TXT
                      ,CONTR.SVC_PGM_TP_SORT_NUM
                      ,CONTR.DS_CONTR_CRAT_TP_CD
                      <!-- Add End 2019/01/21 QC#29782 -->
                      ,CONTR.SVC_INV_CHRG_TP_CD
                      ,CONTR.SVC_INV_CHRG_TP_NM
                      ,CONTR.DCBA_COUNT
                      ,CONTR.DCSA_COUNT
                      ,CONTR.COLLAPSE
                      ,CONTR.LEVEL_NB
<!-- START 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
                      ,CONTR.SORT_NUM
                      ,CONTR.PRNT_DS_CONTR_DTL_PK
<!-- END 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
               FROM
               (
                      SELECT
                               DS.DS_CONTR_PK              AS DS_CONTR_PK
                              ,DS.DS_CONTR_NUM             AS DS_CONTR_NUM
                              ,DS.DS_CONTR_CATG_CD         AS DS_CONTR_CATG_CD
                              ,DS.DS_ACCT_NUM              AS DS_ACCT_NUM
                              ,DCD.DS_CONTR_DTL_PK         AS DS_CONTR_DTL_PK
                              ,SMM.SVC_MACH_MSTR_PK        AS SVC_MACH_MSTR_PK
                              ,SMM.SER_NUM                 AS SER_NUM
                              ,SMM.MDSE_CD                 AS MDSE_CD
                              <!-- Add Start 2019/01/21 QC#29782 -->
                              ,M.MDSE_DESC_SHORT_TXT       AS MDSE_DESC_SHORT_TXT
                              ,SPT.SVC_PGM_TP_SORT_NUM     AS SVC_PGM_TP_SORT_NUM
                              ,DCD.DS_CONTR_CRAT_TP_CD     AS DS_CONTR_CRAT_TP_CD
                              <!-- Add End 2019/01/21 QC#29782 -->
                              ,NULL                        AS SVC_INV_CHRG_TP_CD
                              ,NULL                        AS SVC_INV_CHRG_TP_NM
                              , (
                                 SELECT COUNT(*) AS DCBA_COUNT FROM DS_CONTR_BR_ALLOC
                                 WHERE
                                  GLBL_CMPY_CD             = #glblCmpyCd# 
                                  AND DS_CONTR_PK          = #dsContrPk#
                                  AND DS_CONTR_DTL_PK      = DCD.DS_CONTR_DTL_PK
                                  AND SVC_INV_CHRG_TP_CD   IS NULL
                                  AND EZCANCELFLAG         = '0'
                              ) DCBA_COUNT
                              ,
                              (
                                 SELECT COUNT(*) AS DCSA_COUNT FROM DS_CONTR_SEG_ALLOC
                                 WHERE
                                  GLBL_CMPY_CD             = #glblCmpyCd# 
                                  AND DS_CONTR_PK          = #dsContrPk#
                                  AND DS_CONTR_DTL_PK      = DCD.DS_CONTR_DTL_PK
                                  AND SVC_INV_CHRG_TP_CD   IS NULL
                                  AND EZCANCELFLAG         = '0'
                              ) DCSA_COUNT
                              ,0   AS COLLAPSE 
                              ,2   AS LEVEL_NB
<!-- START 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
                              ,CASE WHEN DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCdIsAcc# THEN DCD.PRNT_DS_CONTR_DTL_PK
                                    ELSE DCD.DS_CONTR_DTL_PK
                               END                         AS SORT_NUM
                              ,DCD.PRNT_DS_CONTR_DTL_PK    AS PRNT_DS_CONTR_DTL_PK
<!-- END 2016/02/23 T.Tsuchida [QC#1797, ADD] -->

                              ,NVL(SMMP.SER_NUM, SMM.SER_NUM)  AS SER_NUM_SORT
                              ,NVL(SMMP.MDSE_CD, SMM.MDSE_CD)  AS MDSE_CD_SORT
                              ,DCDT.DS_CONTR_DTL_TP_SORT_NUM

                      FROM
                          DS_CONTR DS
                         ,DS_CONTR_DTL DCD
                         ,SVC_MACH_MSTR SMM

                         ,DS_CONTR_DTL_TP DCDT
                         ,DS_CONTR_DTL DCDP
                         ,SVC_MACH_MSTR SMMP
                         <!-- Add Start 2019/01/21 QC#29782 -->
                         ,MDSE M
                         ,SVC_PGM_TP SPT
                         <!-- Add End 2019/01/21 QC#29782 -->

                      WHERE
                          DS.GLBL_CMPY_CD                  = #glblCmpyCd# 
                          AND DS.DS_CONTR_PK               = #dsContrPk#
                          AND DS.EZCANCELFLAG              = '0'
                          AND DCD.GLBL_CMPY_CD             = DS.GLBL_CMPY_CD
                          AND DCD.DS_CONTR_PK              = DS.DS_CONTR_PK
                          AND DCD.EZCANCELFLAGã€€           = '0'
                          AND SMM.GLBL_CMPY_CD             = DCD.GLBL_CMPY_CD
                          AND SMM.SVC_MACH_MSTR_PK         = DCD.SVC_MACH_MSTR_PK
                          AND SMM.EZCANCELFLAG             = '0'

                          AND DCD.GLBL_CMPY_CD             = DCDT.GLBL_CMPY_CD
                          AND DCD.DS_CONTR_DTL_TP_CD       = DCDT.DS_CONTR_DTL_TP_CD
                          AND DCDT.SVC_PRC_FLG             = 'N'
                          AND DCD.EZCANCELFLAG             = DCDT.EZCANCELFLAG

                          AND DCD.PRNT_DS_CONTR_DTL_PK     = DCDP.DS_CONTR_DTL_PK(+)
                          AND DCD.GLBL_CMPY_CD             = DCDP.GLBL_CMPY_CD(+)
                          AND DCDP.EZCANCELFLAG(+)         = '0'
                          AND DCDP.SVC_MACH_MSTR_PK        = SMMP.SVC_MACH_MSTR_PK(+)
                          AND DCDP.GLBL_CMPY_CD            = SMMP.GLBL_CMPY_CD(+)
                          AND SMMP.EZCANCELFLAG(+)         = '0'

                          <!-- Add Start 2019/01/21 QC#29782 -->
                          AND DCD.SVC_PGM_MDSE_CD          = M.MDSE_CD(+)
                          AND DCD.GLBL_CMPY_CD             = M.GLBL_CMPY_CD(+)
                          AND M.EZCANCELFLAG(+)            = '0'

                          AND M.GLBL_CMPY_CD               = SPT.GLBL_CMPY_CD(+)
                          AND M.SVC_PGM_TP_CD              = SPT.SVC_PGM_TP_CD(+)
                          AND SPT.EZCANCELFLAG(+)          = '0'
                          <!-- Add End 2019/01/21 QC#29782 -->

                      UNION ALL
                      SELECT
                                DS.DS_CONTR_PK             AS DS_CONTR_PK
                               ,DS.DS_CONTR_NUM            AS DS_CONTR_NUM
                               ,DS.DS_CONTR_CATG_CD        AS DS_CONTR_CATG_CD
                               ,DS.DS_ACCT_NUM             AS DS_ACCT_NUM
                               ,DCD.DS_CONTR_DTL_PK        AS DS_CONTR_DTL_PK
                               ,SMM.SVC_MACH_MSTR_PK       AS SVC_MACH_MSTR_PK
                               ,SMM.SER_NUM                AS SER_NUM
                               ,SMM.MDSE_CD                AS MDSE_CD
                               <!-- Add Start 2019/01/21 QC#29782 -->
                               ,M.MDSE_DESC_SHORT_TXT      AS MDSE_DESC_SHORT_TXT
                               ,SPT.SVC_PGM_TP_SORT_NUM    AS SVC_PGM_TP_SORT_NUM
                               ,DCD.DS_CONTR_CRAT_TP_CD    AS DS_CONTR_CRAT_TP_CD
                               <!-- Add End 2019/01/21 QC#29782 -->
                               ,#svcInvChrgTpCdIsBc#       AS SVC_INV_CHRG_TP_CD
                               ,'Base'                     AS SVC_INV_CHRG_TP_NM
                               ,
                               (
                                 SELECT COUNT(*) AS DCBA_COUNT FROM DS_CONTR_BR_ALLOC
                                 WHERE
                                  GLBL_CMPY_CD             = #glblCmpyCd#
                                  AND DS_CONTR_PK          = #dsContrPk#
                                  AND DS_CONTR_DTL_PK      = DCD.DS_CONTR_DTL_PK
                                  AND SVC_INV_CHRG_TP_CD   = #svcInvChrgTpCdIsBc#
                                  AND EZCANCELFLAG         = '0'
                               ) DCBA_COUNT
                               , 
                               (
                                 SELECT COUNT(*) AS DCSA_COUNT FROM DS_CONTR_SEG_ALLOC
                                 WHERE
                                  GLBL_CMPY_CD              = #glblCmpyCd#
                                  AND DS_CONTR_PK           = #dsContrPk#
                                  AND DS_CONTR_DTL_PK       = DCD.DS_CONTR_DTL_PK
                                  AND SVC_INV_CHRG_TP_CD    = #svcInvChrgTpCdIsBc#
                                  AND EZCANCELFLAG          = '0'
                              ) DCSA_COUNT
                              ,NULL                        AS COLLAPSE 
                              ,3                           AS LEVEL_NB
<!-- START 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
                              ,CASE WHEN DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCdIsAcc# THEN DCD.PRNT_DS_CONTR_DTL_PK
                                    ELSE DCD.DS_CONTR_DTL_PK
                               END                         AS SORT_NUM
                              ,DCD.PRNT_DS_CONTR_DTL_PK    AS PRNT_DS_CONTR_DTL_PK
<!-- END 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
                              ,NVL(SMMP.SER_NUM, SMM.SER_NUM)  AS SER_NUM_SORT
                              ,NVL(SMMP.MDSE_CD, SMM.MDSE_CD)  AS MDSE_CD_SORT
                              ,DCDT.DS_CONTR_DTL_TP_SORT_NUM
                      FROM
                               DS_CONTR DS
                              ,DS_CONTR_DTL DCD
                              ,SVC_MACH_MSTR SMM
                              ,DS_CONTR_DTL_TP DCDT

                              ,DS_CONTR_DTL DCDP
                              ,SVC_MACH_MSTR SMMP
                              <!-- Add Start 2019/01/21 QC#29782 -->
                              ,MDSE M
                              ,SVC_PGM_TP SPT
                              <!-- Add End 2019/01/21 QC#29782 -->
                      WHERE
                              DS.GLBL_CMPY_CD              = #glblCmpyCd#
                              AND DS.DS_CONTR_PK           = #dsContrPk#
                              AND DS.EZCANCELFLAG          = '0'
                              AND DCD.GLBL_CMPY_CD         = DS.GLBL_CMPY_CD
                              AND DCD.DS_CONTR_PK          = DS.DS_CONTR_PK
                              AND DCD.EZCANCELFLAG         = '0'
                              AND SMM.GLBL_CMPY_CD         = DCD.GLBL_CMPY_CD
                              AND SMM.SVC_MACH_MSTR_PK     = DCD.SVC_MACH_MSTR_PK
                              AND SMM.EZCANCELFLAG         = '0'
                              AND DCDT.GLBL_CMPY_CD        = DCD.GLBL_CMPY_CD
                              AND DCDT.DS_CONTR_DTL_TP_CD  = DCD.DS_CONTR_DTL_TP_CD
                              AND DCDT.BASE_CHRG_FLG       = 'Y'
                              AND DCDT.EZCANCELFLAG        = '0'

                              AND DCD.PRNT_DS_CONTR_DTL_PK = DCDP.DS_CONTR_DTL_PK(+)
                              AND DCD.GLBL_CMPY_CD         = DCDP.GLBL_CMPY_CD(+)
                              AND DCDP.EZCANCELFLAG(+)     = '0'
                              AND DCDP.SVC_MACH_MSTR_PK    = SMMP.SVC_MACH_MSTR_PK(+)
                              AND DCDP.GLBL_CMPY_CD        = SMMP.GLBL_CMPY_CD(+)
                              AND SMMP.EZCANCELFLAG(+)     = '0'

                              <!-- Add Start 2019/01/21 QC#29782 -->
                              AND DCD.SVC_PGM_MDSE_CD      = M.MDSE_CD(+)
                              AND DCD.GLBL_CMPY_CD         = M.GLBL_CMPY_CD(+)
                              AND M.EZCANCELFLAG(+)        = '0'

                              AND M.GLBL_CMPY_CD           = SPT.GLBL_CMPY_CD(+)
                              AND M.SVC_PGM_TP_CD          = SPT.SVC_PGM_TP_CD(+)
                              AND SPT.EZCANCELFLAG(+)      = '0'
                              <!-- Add End 2019/01/21 QC#29782 -->

                      UNION ALL
                      SELECT 
                                DS.DS_CONTR_PK              AS DS_CONTR_PK
                               ,DS.DS_CONTR_NUM             AS DS_CONTR_NUM 
                               ,DS.DS_CONTR_CATG_CD         AS DS_CONTR_CATG_CD
                               ,DS.DS_ACCT_NUM              AS DS_ACCT_NUM 
                               ,DCD.DS_CONTR_DTL_PK         AS DS_CONTR_DTL_PK
                               ,SMM.SVC_MACH_MSTR_PK        AS SVC_MACH_MSTR_PK
                               ,SMM.SER_NUM                 AS SER_NUM
                               ,SMM.MDSE_CD                 AS MDSE_CD
                               <!-- Add Start 2019/01/21 QC#29782 -->
                               ,M.MDSE_DESC_SHORT_TXT       AS MDSE_DESC_SHORT_TXT
                               ,SPT.SVC_PGM_TP_SORT_NUM     AS SVC_PGM_TP_SORT_NUM
                               ,DCD.DS_CONTR_CRAT_TP_CD     AS DS_CONTR_CRAT_TP_CD
                               <!-- Add End 2019/01/21 QC#29782 -->
                               ,#svcInvChrgTpCdIsMc#        AS SVC_INV_CHRG_TP_CD
                               ,'Overage'                   AS SVC_INV_CHRG_TP_NM
                               ,
                                (
                                  SELECT COUNT(*) AS DCBA_COUNT FROM DS_CONTR_BR_ALLOC
                                  WHERE
                                   GLBL_CMPY_CD            = #glblCmpyCd#
                                   AND DS_CONTR_PK         = #dsContrPk#
                                   AND DS_CONTR_DTL_PK     = DCD.DS_CONTR_DTL_PK
                                   AND SVC_INV_CHRG_TP_CD  = #svcInvChrgTpCdIsMc#
                                   AND EZCANCELFLAG        = '0'
                               ) DCBA_COUNT
                               , 
                               (
                                SELECT COUNT(*) AS DCSA_COUNT FROM DS_CONTR_SEG_ALLOC
                                WHERE
                                 GLBL_CMPY_CD             = #glblCmpyCd#
                                 AND DS_CONTR_PK          = #dsContrPk#
                                 AND DS_CONTR_DTL_PK      = DCD.DS_CONTR_DTL_PK
                                 AND SVC_INV_CHRG_TP_CD   = #svcInvChrgTpCdIsMc#
                                 AND EZCANCELFLAG = '0'
                               ) DCSA_COUNT
                               ,NULL                       AS COLLAPSE 
                               ,3                          AS LEVEL_NB
<!-- START 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
                              ,CASE WHEN DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCdIsAcc# THEN DCD.PRNT_DS_CONTR_DTL_PK
                                    ELSE DCD.DS_CONTR_DTL_PK
                               END                         AS SORT_NUM
                              ,DCD.PRNT_DS_CONTR_DTL_PK    AS PRNT_DS_CONTR_DTL_PK
<!-- END 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
                              ,NVL(SMMP.SER_NUM, SMM.SER_NUM)  AS SER_NUM_SORT
                              ,NVL(SMMP.MDSE_CD, SMM.MDSE_CD)  AS MDSE_CD_SORT
                              ,DCDT.DS_CONTR_DTL_TP_SORT_NUM
                      FROM 
                               DS_CONTR DS
                              ,DS_CONTR_DTL DCD
                              ,SVC_MACH_MSTR SMM
                              ,DS_CONTR_DTL_TP DCDT

                              ,DS_CONTR_DTL DCDP
                              ,SVC_MACH_MSTR SMMP
                              <!-- Add Start 2019/01/21 QC#29782 -->
                              ,MDSE M
                              ,SVC_PGM_TP SPT
                              <!-- Add End 2019/01/21 QC#29782 -->

                      WHERE
                              DS.GLBL_CMPY_CD              = #glblCmpyCd#
                              AND DS.DS_CONTR_PK           = #dsContrPk#
                              AND DS.EZCANCELFLAG          = '0'
                              AND DCD.GLBL_CMPY_CD         = DS.GLBL_CMPY_CD
                              AND DCD.DS_CONTR_PK          = DS.DS_CONTR_PK
                              AND DCD.EZCANCELFLAG         = '0'
                              AND SMM.GLBL_CMPY_CD         = DCD.GLBL_CMPY_CD
                              AND SMM.SVC_MACH_MSTR_PK     = DCD.SVC_MACH_MSTR_PK
                              AND SMM.EZCANCELFLAG         = '0'
                              AND DCDT.GLBL_CMPY_CD        = DCD.GLBL_CMPY_CD
                              AND DCDT.DS_CONTR_DTL_TP_CD  = DCD.DS_CONTR_DTL_TP_CD
                              AND DCDT.USG_CHRG_FLG        = 'Y'
                              AND DCDT.EZCANCELFLAG        = '0'

                              AND DCD.PRNT_DS_CONTR_DTL_PK = DCDP.DS_CONTR_DTL_PK(+)
                              AND DCD.GLBL_CMPY_CD         = DCDP.GLBL_CMPY_CD(+)
                              AND DCDP.EZCANCELFLAG(+)     = '0'
                              AND DCDP.SVC_MACH_MSTR_PK    = SMMP.SVC_MACH_MSTR_PK(+)
                              AND DCDP.GLBL_CMPY_CD        = SMMP.GLBL_CMPY_CD(+)
                              AND SMMP.EZCANCELFLAG(+)     = '0'

                              <!-- Add Start 2019/01/21 QC#29782 -->
                              AND DCD.SVC_PGM_MDSE_CD      = M.MDSE_CD(+)
                              AND DCD.GLBL_CMPY_CD         = M.GLBL_CMPY_CD(+)
                              AND M.EZCANCELFLAG(+)        = '0'

                              AND M.GLBL_CMPY_CD           = SPT.GLBL_CMPY_CD(+)
                              AND M.SVC_PGM_TP_CD          = SPT.SVC_PGM_TP_CD(+)
                              AND SPT.EZCANCELFLAG(+)      = '0'
                              <!-- Add End 2019/01/21 QC#29782 -->
               ) CONTR
<!-- START 2016/02/23 T.Tsuchida [QC#1797, DEL] -->
<!--           WHERE -->
<!--           ROWNUM  &lt;=   #limitCount# -->
<!-- END 2016/02/23 T.Tsuchida [QC#1797, DEL] -->
               ORDER BY
                   CONTR.SER_NUM_SORT
                   ,CONTR.MDSE_CD_SORT
                   <!-- Add Start 2019/01/21 QC#29782 -->
                   ,CONTR.SVC_PGM_TP_SORT_NUM
                   ,NVL(CONTR.DS_CONTR_CRAT_TP_CD, #dsContrCratTp#)
                   ,NVL(CONTR.PRNT_DS_CONTR_DTL_PK, CONTR.DS_CONTR_DTL_PK)
                   <!-- Add Start 2019/01/21 QC#29782 -->
                   ,CONTR.DS_CONTR_DTL_TP_SORT_NUM
                   ,CONTR.DS_CONTR_DTL_PK
                   ,CONTR.LEVEL_NB
       )
       WHERE
       ROWNUM  &lt;=   #limitCount#
<!-- END 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
    </statement>

    <statement id="getFleetMachineInfo" parameterClass="Map" resultClass="Map">
<!-- START 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
       SELECT
               DS_CONTR_PK
              ,DS_CONTR_NUM
              ,DS_CONTR_CATG_CD
              ,DS_ACCT_NUM
              ,DS_CONTR_DTL_PK
              ,SVC_MACH_MSTR_PK
              ,SER_NUM
              ,SVC_INV_CHRG_TP_CD
              ,SVC_INV_CHRG_TP_NM
              ,DCBA_COUNT
              ,DCSA_COUNT
              ,COLLAPSE
              ,LEVEL_NB
              ,SORT_NUM
              ,PRNT_DS_CONTR_DTL_PK
       FROM
       (
<!-- END 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
               SELECT
                       CONTR.DS_CONTR_PK
                      ,CONTR.DS_CONTR_NUM
                      ,CONTR.DS_CONTR_CATG_CD
                      ,CONTR.DS_ACCT_NUM
                      ,CONTR.DS_CONTR_DTL_PK
                      ,CONTR.SVC_MACH_MSTR_PK
                      ,CONTR.SER_NUM 
                      ,CONTR.SVC_INV_CHRG_TP_CD
                      ,CONTR.SVC_INV_CHRG_TP_NM
                      ,CONTR.DCBA_COUNT
                      ,CONTR.DCSA_COUNT
                      ,CONTR.COLLAPSE
                      ,CONTR.LEVEL_NB
<!-- START 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
                      ,CONTR.SORT_NUM
                      ,CONTR.PRNT_DS_CONTR_DTL_PK
<!-- END 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
               FROM
               (
                      SELECT
                               DS.DS_CONTR_PK              AS DS_CONTR_PK
                              ,DS.DS_CONTR_NUM             AS DS_CONTR_NUM
                              ,DS.DS_CONTR_CATG_CD         AS DS_CONTR_CATG_CD
                              ,DS.DS_ACCT_NUM              AS DS_ACCT_NUM
                              ,DCD.DS_CONTR_DTL_PK         AS DS_CONTR_DTL_PK
                              ,NULL                        AS SVC_MACH_MSTR_PK
                              ,DS.DS_CONTR_NUM             AS SER_NUM          
                              ,NULL                        AS SVC_INV_CHRG_TP_CD
                              ,NULL                        AS SVC_INV_CHRG_TP_NM
                              , (
                                 SELECT COUNT(*) AS DCBA_COUNT FROM DS_CONTR_BR_ALLOC
                                 WHERE
                                  GLBL_CMPY_CD             = #glblCmpyCd#
                                  AND DS_CONTR_PK          = #dsContrPk#
                                  AND DS_CONTR_DTL_PK      = DCD.DS_CONTR_DTL_PK
                                  AND SVC_INV_CHRG_TP_CD   IS NULL
                                  AND EZCANCELFLAG = '0'
                              ) DCBA_COUNT
                              ,
                              (
                                 SELECT COUNT(*) AS DCSA_COUNT FROM DS_CONTR_SEG_ALLOC
                                 WHERE
                                  GLBL_CMPY_CD             = #glblCmpyCd#
                                  AND DS_CONTR_PK          = #dsContrPk#
                                  AND DS_CONTR_DTL_PK      = DCD.DS_CONTR_DTL_PK
                                  AND SVC_INV_CHRG_TP_CD   IS NULL
                                  AND EZCANCELFLAG         = '0'
                              ) DCSA_COUNT
                              ,0   AS COLLAPSE 
                              ,2   AS LEVEL_NB
<!-- START 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
                              ,CASE WHEN DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCdIsAcc# THEN DCD.PRNT_DS_CONTR_DTL_PK
                                    ELSE DCD.DS_CONTR_DTL_PK
                               END                         AS SORT_NUM
                              ,DCD.PRNT_DS_CONTR_DTL_PK    AS PRNT_DS_CONTR_DTL_PK
<!-- END 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
                      FROM
                          DS_CONTR DS
                         ,DS_CONTR_DTL DCD

                      WHERE
                          DS.GLBL_CMPY_CD                  = #glblCmpyCd# 
                          AND DS.DS_CONTR_PK               = #dsContrPk#
                          AND DS.EZCANCELFLAG              = '0'
                          AND DCD.GLBL_CMPY_CD             = DS.GLBL_CMPY_CD
                          AND DCD.DS_CONTR_PK              = DS.DS_CONTR_PK
                          AND DCD.DS_CONTR_DTL_TP_CD       = #dsContrDtlTpCdIsFleet#
                          AND DCD.EZCANCELFLAGã€€           = '0'
                      UNION ALL
                      SELECT
                                DS.DS_CONTR_PK             AS DS_CONTR_PK
                               ,DS.DS_CONTR_NUM            AS DS_CONTR_NUM
                               ,DS.DS_CONTR_CATG_CD        AS DS_CONTR_CATG_CD
                               ,DS.DS_ACCT_NUM             AS DS_ACCT_NUM
                               ,DCD.DS_CONTR_DTL_PK        AS DS_CONTR_DTL_PK
                               ,NULL                       AS SVC_MACH_MSTR_PK
                               ,DS.DS_CONTR_NUM            AS SER_NUM 
                               ,#svcInvChrgTpCdIsBc#       AS SVC_INV_CHRG_TP_CD
                               ,'Base'                     AS SVC_INV_CHRG_TP_NM
                               ,
                               (
                                 SELECT COUNT(*) AS DCBA_COUNT FROM DS_CONTR_BR_ALLOC
                                 WHERE
                                  GLBL_CMPY_CD             = #glblCmpyCd#
                                  AND DS_CONTR_PK          = #dsContrPk#
                                  AND DS_CONTR_DTL_PK      = DCD.DS_CONTR_DTL_PK
                                  AND SVC_INV_CHRG_TP_CD   = #svcInvChrgTpCdIsBc#
                                  AND EZCANCELFLAG         = '0'
                               ) DCBA_COUNT
                               , 
                               (
                                 SELECT COUNT(*) AS DCSA_COUNT FROM DS_CONTR_SEG_ALLOC
                                 WHERE
                                  GLBL_CMPY_CD              = #glblCmpyCd#
                                  AND DS_CONTR_PK           = #dsContrPk#
                                  AND DS_CONTR_DTL_PK       = DCD.DS_CONTR_DTL_PK
                                  AND SVC_INV_CHRG_TP_CD    = #svcInvChrgTpCdIsBc#
                                  AND EZCANCELFLAG = '0'
                              ) DCSA_COUNT
                              ,NULL                        AS COLLAPSE 
                              ,3                           AS LEVEL_NB
<!-- START 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
                              ,CASE WHEN DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCdIsAcc# THEN DCD.PRNT_DS_CONTR_DTL_PK
                                    ELSE DCD.DS_CONTR_DTL_PK
                               END                         AS SORT_NUM
                              ,DCD.PRNT_DS_CONTR_DTL_PK    AS PRNT_DS_CONTR_DTL_PK
<!-- END 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
                      FROM
                               DS_CONTR DS
                              ,DS_CONTR_DTL DCD
                              ,DS_CONTR_DTL_TP DCDT
                      WHERE
                              DS.GLBL_CMPY_CD              = #glblCmpyCd#
                              AND DS.DS_CONTR_PK           = #dsContrPk#
                              AND DS.EZCANCELFLAG          = '0'
                              AND DCD.GLBL_CMPY_CD         = DS.GLBL_CMPY_CD
                              AND DCD.DS_CONTR_PK          = DS.DS_CONTR_PK
                              AND DCD.DS_CONTR_DTL_TP_CD   = #dsContrDtlTpCdIsFleet#
                              AND DCD.EZCANCELFLAG         = '0'
                              AND DCDT.GLBL_CMPY_CD        = DCD.GLBL_CMPY_CD
                              AND DCDT.DS_CONTR_DTL_TP_CD  = DCD.DS_CONTR_DTL_TP_CD
                              AND DCDT.BASE_CHRG_FLG       = 'Y'
                              AND DCDT.EZCANCELFLAG        = '0'

                      UNION ALL
                      SELECT 
                                DS.DS_CONTR_PK              AS DS_CONTR_PK
                               ,DS.DS_CONTR_NUM             AS DS_CONTR_NUM 
                               ,DS.DS_CONTR_CATG_CD         AS DS_CONTR_CATG_CD
                               ,DS.DS_ACCT_NUM              AS DS_ACCT_NUM
                               ,DCD.DS_CONTR_DTL_PK         AS DS_CONTR_DTL_PK
                               ,NULL                        AS SVC_MACH_MSTR_PK
                               ,DS.DS_CONTR_NUM             AS SER_NUM 
                               ,#svcInvChrgTpCdIsMc#        AS SVC_INV_CHRG_TP_CD
                               ,'Overage'                   AS SVC_INV_CHRG_TP_NM
                               ,
                                (
                                  SELECT COUNT(*) AS DCBA_COUNT FROM DS_CONTR_BR_ALLOC
                                  WHERE
                                   GLBL_CMPY_CD            = #glblCmpyCd#
                                   AND DS_CONTR_PK         = #dsContrPk#
                                   AND DS_CONTR_DTL_PK     = DCD.DS_CONTR_DTL_PK
                                   AND SVC_INV_CHRG_TP_CD  = #svcInvChrgTpCdIsMc#
                                   AND EZCANCELFLAG        = '0'
                               ) DCBA_COUNT
                               , 
                               (
                                SELECT COUNT(*) AS DCSA_COUNT FROM DS_CONTR_SEG_ALLOC
                                WHERE
                                 GLBL_CMPY_CD             = #glblCmpyCd#
                                 AND DS_CONTR_PK          = #dsContrPk#
                                 AND DS_CONTR_DTL_PK      = DCD.DS_CONTR_DTL_PK
                                 AND SVC_INV_CHRG_TP_CD   = #svcInvChrgTpCdIsMc#
                                 AND EZCANCELFLAG = '0'
                               ) DCSA_COUNT
                               ,NULL                       AS COLLAPSE 
                               ,3                          AS LEVEL_NB
<!-- START 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
                              ,CASE WHEN DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCdIsAcc# THEN DCD.PRNT_DS_CONTR_DTL_PK
                                    ELSE DCD.DS_CONTR_DTL_PK
                               END                         AS SORT_NUM
                              ,DCD.PRNT_DS_CONTR_DTL_PK    AS PRNT_DS_CONTR_DTL_PK
<!-- END 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
                      FROM 
                               DS_CONTR DS
                              ,DS_CONTR_DTL DCD
                              ,DS_CONTR_DTL_TP DCDT
                      WHERE
                              DS.GLBL_CMPY_CD              = #glblCmpyCd#
                              AND DS.DS_CONTR_PK           = #dsContrPk#
                              AND DS.EZCANCELFLAG          = '0'
                              AND DCD.GLBL_CMPY_CD         = DS.GLBL_CMPY_CD
                              AND DCD.DS_CONTR_PK          = DS.DS_CONTR_PK
                              AND DCD.DS_CONTR_DTL_TP_CD   = #dsContrDtlTpCdIsFleet#
                              AND DCD.EZCANCELFLAG         = '0'
                              AND DCDT.GLBL_CMPY_CD        = DCD.GLBL_CMPY_CD
                              AND DCDT.DS_CONTR_DTL_TP_CD  = DCD.DS_CONTR_DTL_TP_CD
                              AND DCDT.USG_CHRG_FLG        = 'Y'
                              AND DCDT.EZCANCELFLAG        = '0'
               ) CONTR
<!-- START 2016/02/23 T.Tsuchida [QC#1797, DEL] -->
<!--           WHERE -->
<!--           ROWNUM  &lt;=   #limitCount# -->
<!-- END 2016/02/23 T.Tsuchida [QC#1797, DEL] -->
               ORDER BY
<!-- START 2016/02/23 T.Tsuchida [QC#1797, MOD] -->
                       CONTR.SORT_NUM,
                       CONTR.PRNT_DS_CONTR_DTL_PK NULLS FIRST,
                       CONTR.SER_NUM NULLS FIRST,
<!-- END 2016/02/23 T.Tsuchida [QC#1797, MOD] -->
                       CONTR.SVC_INV_CHRG_TP_CD NULLS FIRST,
                       CONTR.LEVEL_NB
<!-- START 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
       )
       WHERE
       ROWNUM  &lt;=   #limitCount#
<!-- END 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
    </statement>

    <statement id="getAggregateMachineInfo" parameterClass="Map" resultClass="Map">
<!-- START 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
       SELECT
               DS_CONTR_PK
              ,DS_CONTR_NUM
              ,DS_CONTR_CATG_CD
              ,DS_ACCT_NUM
              ,DS_CONTR_DTL_PK
              ,SVC_MACH_MSTR_PK
              ,NVL(SER_NUM,SVC_MACH_MSTR_PK||'('||MDSE_CD||')') AS SER_NUM
              ,MDSE_CD
              <!-- Add Start 2019/01/21 QC#29782 -->
              ,MDSE_DESC_SHORT_TXT
              ,SVC_PGM_TP_SORT_NUM
              <!-- Add End 2019/01/21 QC#29782 -->
              ,SVC_INV_CHRG_TP_CD
              ,SVC_INV_CHRG_TP_NM
              ,DCBA_COUNT
              ,DCSA_COUNT
              ,COLLAPSE
              ,LEVEL_NB
              ,SORT_NUM
              ,PRNT_DS_CONTR_DTL_PK
       FROM
       (
<!-- END 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
               SELECT
                       CONTR.DS_CONTR_PK
                      ,CONTR.DS_CONTR_NUM
                      ,CONTR.DS_CONTR_CATG_CD
                      ,CONTR.DS_ACCT_NUM
                      ,CONTR.DS_CONTR_DTL_PK
                      ,CONTR.SVC_MACH_MSTR_PK
                      ,CONTR.SER_NUM
                      ,CONTR.MDSE_CD AS MDSE_CD
                      <!-- Add Start 2019/01/21 QC#29782 -->
                      ,CONTR.MDSE_DESC_SHORT_TXT
                      ,CONTR.SVC_PGM_TP_SORT_NUM
                      ,CONTR.DS_CONTR_CRAT_TP_CD
                      <!-- Add End 2019/01/21 QC#29782 -->
                      ,CONTR.SVC_INV_CHRG_TP_CD
                      ,CONTR.SVC_INV_CHRG_TP_NM
                      ,CONTR.DCBA_COUNT
                      ,CONTR.DCSA_COUNT
                      ,CONTR.COLLAPSE
                      ,CONTR.LEVEL_NB
<!-- START 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
                      ,CONTR.SORT_NUM
                      ,CONTR.PRNT_DS_CONTR_DTL_PK
<!-- END 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
               FROM
               (
                      SELECT
                               DS.DS_CONTR_PK              AS DS_CONTR_PK
                              ,DS.DS_CONTR_NUM             AS DS_CONTR_NUM
                              ,DS.DS_CONTR_CATG_CD         AS DS_CONTR_CATG_CD
                              ,DS.DS_ACCT_NUM              AS DS_ACCT_NUM
                              ,DCD.DS_CONTR_DTL_PK         AS DS_CONTR_DTL_PK
                              ,SMM.SVC_MACH_MSTR_PK        AS SVC_MACH_MSTR_PK
                              ,SMM.SER_NUM                 AS SER_NUM
                              ,SMM.MDSE_CD                 AS MDSE_CD
                              <!-- Add Start 2019/01/21 QC#29782 -->
                              ,M.MDSE_DESC_SHORT_TXT       AS MDSE_DESC_SHORT_TXT
                              ,SPT.SVC_PGM_TP_SORT_NUM     AS SVC_PGM_TP_SORT_NUM
                              ,DCD.DS_CONTR_CRAT_TP_CD     AS DS_CONTR_CRAT_TP_CD
                              <!-- Add End 2019/01/21 QC#29782 -->
                              ,NULL                        AS SVC_INV_CHRG_TP_CD
                              ,NULL                        AS SVC_INV_CHRG_TP_NM
                              , (
                                 SELECT COUNT(*) AS DCBA_COUNT FROM DS_CONTR_BR_ALLOC
                                 WHERE
                                  GLBL_CMPY_CD             = #glblCmpyCd#
                                  AND DS_CONTR_PK          = #dsContrPk#
                                  AND DS_CONTR_DTL_PK      = DCD.DS_CONTR_DTL_PK
                                  AND SVC_INV_CHRG_TP_CD   IS NULL
                                  AND EZCANCELFLAG = '0'
                              ) DCBA_COUNT
                              ,
                              (
                                 SELECT COUNT(*) AS DCSA_COUNT FROM DS_CONTR_SEG_ALLOC
                                 WHERE
                                  GLBL_CMPY_CD             = #glblCmpyCd#
                                  AND DS_CONTR_PK          = #dsContrPk#
                                  AND DS_CONTR_DTL_PK      = DCD.DS_CONTR_DTL_PK
                                  AND SVC_INV_CHRG_TP_CD   IS NULL
                                  AND EZCANCELFLAG         = '0'
                              ) DCSA_COUNT
                              ,0   AS COLLAPSE 
                              ,2   AS LEVEL_NB
<!-- START 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
                              ,CASE WHEN DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCdIsAcc# THEN DCD.PRNT_DS_CONTR_DTL_PK
                                    ELSE DCD.DS_CONTR_DTL_PK
                               END                         AS SORT_NUM
                              ,DCD.PRNT_DS_CONTR_DTL_PK    AS PRNT_DS_CONTR_DTL_PK
<!-- END 2016/02/23 T.Tsuchida [QC#1797, ADD] -->

                              ,NVL(SMMP.SER_NUM, SMM.SER_NUM)  AS SER_NUM_SORT
                              ,NVL(SMMP.MDSE_CD, SMM.MDSE_CD)  AS MDSE_CD_SORT
                              ,DCDT.DS_CONTR_DTL_TP_SORT_NUM
                      FROM
                          DS_CONTR DS
                         ,DS_CONTR_DTL DCD
                         ,SVC_MACH_MSTR SMM
                         ,DS_CONTR_DTL_TP DCDT
                         ,DS_CONTR_DTL DCDP
                         ,SVC_MACH_MSTR SMMP
                         <!-- Add Start 2019/01/21 QC#29782 -->
                         ,MDSE M
                         ,SVC_PGM_TP SPT
                         <!-- Add End 2019/01/21 QC#29782 -->
                      WHERE
                          DS.GLBL_CMPY_CD                  = #glblCmpyCd#
                          AND DS.DS_CONTR_PK               = #dsContrPk#
                          AND DS.EZCANCELFLAG              = '0'
                          AND DCD.GLBL_CMPY_CD             = DS.GLBL_CMPY_CD
                          AND DCD.DS_CONTR_PK              = DS.DS_CONTR_PK
                          AND DCD.DS_CONTR_DTL_TP_CD       &lt;&gt; #dsContrDtlTpCdIsAgg#
                          AND DCD.EZCANCELFLAGã€€           = '0'
                          AND SMM.GLBL_CMPY_CD             = DCD.GLBL_CMPY_CD
                          AND SMM.SVC_MACH_MSTR_PK         = DCD.SVC_MACH_MSTR_PK
                          AND SMM.EZCANCELFLAG             = '0'

                          AND DCD.GLBL_CMPY_CD             = DCDT.GLBL_CMPY_CD
                          AND DCD.DS_CONTR_DTL_TP_CD       = DCDT.DS_CONTR_DTL_TP_CD
                          AND DCDT.SVC_PRC_FLG             = 'N'
                          AND DCD.EZCANCELFLAG             = DCDT.EZCANCELFLAG

                          AND DCD.PRNT_DS_CONTR_DTL_PK     = DCDP.DS_CONTR_DTL_PK(+)
                          AND DCD.GLBL_CMPY_CD             = DCDP.GLBL_CMPY_CD(+)
                          AND DCDP.EZCANCELFLAG(+)         = '0'
                          AND DCDP.SVC_MACH_MSTR_PK        = SMMP.SVC_MACH_MSTR_PK(+)
                          AND DCDP.GLBL_CMPY_CD            = SMMP.GLBL_CMPY_CD(+)
                          AND SMMP.EZCANCELFLAG(+)         = '0'

                          <!-- Add Start 2019/01/21 QC#29782 -->
                          AND DCD.SVC_PGM_MDSE_CD          = M.MDSE_CD(+)
                          AND DCD.GLBL_CMPY_CD             = M.GLBL_CMPY_CD(+)
                          AND M.EZCANCELFLAG(+)            = '0'

                          AND M.GLBL_CMPY_CD               = SPT.GLBL_CMPY_CD(+)
                          AND M.SVC_PGM_TP_CD              = SPT.SVC_PGM_TP_CD(+)
                          AND SPT.EZCANCELFLAG(+)          = '0'
                          <!-- Add End 2019/01/21 QC#29782 -->

                      UNION ALL
                      SELECT
                                DS.DS_CONTR_PK             AS DS_CONTR_PK
                               ,DS.DS_CONTR_NUM            AS DS_CONTR_NUM
                               ,DS.DS_CONTR_CATG_CD        AS DS_CONTR_CATG_CD
                               ,DS.DS_ACCT_NUM             AS DS_ACCT_NUM
                               ,DCD.DS_CONTR_DTL_PK        AS DS_CONTR_DTL_PK
                               ,SMM.SVC_MACH_MSTR_PK       AS SVC_MACH_MSTR_PK
                               ,SMM.SER_NUM                AS SER_NUM
                               ,SMM.MDSE_CD                AS MDSE_CD
                               <!-- Add Start 2019/01/21 QC#29782 -->
                               ,M.MDSE_DESC_SHORT_TXT      AS MDSE_DESC_SHORT_TXT
                               ,SPT.SVC_PGM_TP_SORT_NUM    AS SVC_PGM_TP_SORT_NUM
                               ,DCD.DS_CONTR_CRAT_TP_CD    AS DS_CONTR_CRAT_TP_CD
                               <!-- Add End 2019/01/21 QC#29782 -->
                               ,#svcInvChrgTpCdIsBc#       AS SVC_INV_CHRG_TP_CD
                               ,'Base'                     AS SVC_INV_CHRG_TP_NM
                               ,
                               (
                                 SELECT COUNT(*) AS DCBA_COUNT FROM DS_CONTR_BR_ALLOC
                                 WHERE
                                  GLBL_CMPY_CD             = #glblCmpyCd#
                                  AND DS_CONTR_PK          = #dsContrPk#
                                  AND DS_CONTR_DTL_PK      = DCD.DS_CONTR_DTL_PK
                                  AND SVC_INV_CHRG_TP_CD   = #svcInvChrgTpCdIsBc#
                                  AND EZCANCELFLAG         = '0'
                               ) DCBA_COUNT
                               , 
                               (
                                 SELECT COUNT(*) AS DCSA_COUNT FROM DS_CONTR_SEG_ALLOC
                                 WHERE
                                  GLBL_CMPY_CD              = #glblCmpyCd#
                                  AND DS_CONTR_PK           = #dsContrPk#
                                  AND DS_CONTR_DTL_PK       = DCD.DS_CONTR_DTL_PK
                                  AND SVC_INV_CHRG_TP_CD    = #svcInvChrgTpCdIsBc#
                                  AND EZCANCELFLAG          = '0'
                              ) DCSA_COUNT
                              ,NULL                        AS COLLAPSE 
                              ,3                           AS LEVEL_NB
<!-- START 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
                              ,CASE WHEN DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCdIsAcc# THEN DCD.PRNT_DS_CONTR_DTL_PK
                                    ELSE DCD.DS_CONTR_DTL_PK
                               END                         AS SORT_NUM
                              ,DCD.PRNT_DS_CONTR_DTL_PK    AS PRNT_DS_CONTR_DTL_PK
<!-- END 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
                              ,NVL(SMMP.SER_NUM, SMM.SER_NUM)  AS SER_NUM_SORT
                              ,NVL(SMMP.MDSE_CD, SMM.MDSE_CD)  AS MDSE_CD_SORT
                              ,DCDT.DS_CONTR_DTL_TP_SORT_NUM
 
                      FROM
                               DS_CONTR DS
                              ,DS_CONTR_DTL DCD
                              ,SVC_MACH_MSTR SMM
                              ,DS_CONTR_DTL_TP DCDT
                              ,DS_CONTR_DTL DCDP
                              ,SVC_MACH_MSTR SMMP
                              <!-- Add Start 2019/01/21 QC#29782 -->
                              ,MDSE M
                              ,SVC_PGM_TP SPT
                              <!-- Add End 2019/01/21 QC#29782 -->
                      WHERE
                              DS.GLBL_CMPY_CD              = #glblCmpyCd#
                              AND DS.DS_CONTR_PK           = #dsContrPk#
                              AND DS.EZCANCELFLAG          = '0'
                              AND DCD.GLBL_CMPY_CD         = DS.GLBL_CMPY_CD
                              AND DCD.DS_CONTR_PK          = DS.DS_CONTR_PK
                              AND DCD.DS_CONTR_DTL_TP_CD   &lt;&gt; #dsContrDtlTpCdIsAgg#
                              AND DCD.EZCANCELFLAG         = '0'
                              AND SMM.GLBL_CMPY_CD         = DCD.GLBL_CMPY_CD
                              AND SMM.SVC_MACH_MSTR_PK     = DCD.SVC_MACH_MSTR_PK
                              AND SMM.EZCANCELFLAG         = '0'
                              AND DCDT.GLBL_CMPY_CD        = DCD.GLBL_CMPY_CD
                              AND DCDT.DS_CONTR_DTL_TP_CD  = DCD.DS_CONTR_DTL_TP_CD
                              AND DCDT.BASE_CHRG_FLG       = 'Y'
                              AND DCDT.EZCANCELFLAG        = '0'
                              AND DCD.PRNT_DS_CONTR_DTL_PK = DCDP.DS_CONTR_DTL_PK(+)
                              AND DCD.GLBL_CMPY_CD         = DCDP.GLBL_CMPY_CD(+)
                              AND DCDP.EZCANCELFLAG(+)     = '0'
                              AND DCDP.SVC_MACH_MSTR_PK    = SMMP.SVC_MACH_MSTR_PK(+)
                              AND DCDP.GLBL_CMPY_CD        = SMMP.GLBL_CMPY_CD(+)
                              AND SMMP.EZCANCELFLAG(+)     = '0'
                              <!-- Add Start 2019/01/21 QC#29782 -->
                              AND DCD.SVC_PGM_MDSE_CD      = M.MDSE_CD(+)
                              AND DCD.GLBL_CMPY_CD         = M.GLBL_CMPY_CD(+)
                              AND M.EZCANCELFLAG(+)        = '0'

                              AND M.GLBL_CMPY_CD           = SPT.GLBL_CMPY_CD(+)
                              AND M.SVC_PGM_TP_CD          = SPT.SVC_PGM_TP_CD(+)
                              AND SPT.EZCANCELFLAG(+)      = '0'
                              <!-- Add End 2019/01/21 QC#29782 -->

                      UNION ALL
                      SELECT 
                                DS.DS_CONTR_PK              AS DS_CONTR_PK
                               ,DS.DS_CONTR_NUM             AS DS_CONTR_NUM 
                               ,DS.DS_CONTR_CATG_CD         AS DS_CONTR_CATG_CD
                               ,DS.DS_ACCT_NUM              AS DS_ACCT_NUM
                               ,DCD.DS_CONTR_DTL_PK         AS DS_CONTR_DTL_PK
                               ,SMM.SVC_MACH_MSTR_PK        AS SVC_MACH_MSTR_PK
                               ,SMM.SER_NUM                 AS SER_NUM
                               ,SMM.MDSE_CD                 AS MDSE_CD
                               <!-- Add Start 2019/01/21 QC#29782 -->
                               ,M.MDSE_DESC_SHORT_TXT       AS MDSE_DESC_SHORT_TXT
                               ,SPT.SVC_PGM_TP_SORT_NUM     AS SVC_PGM_TP_SORT_NUM
                               ,DCD.DS_CONTR_CRAT_TP_CD     AS DS_CONTR_CRAT_TP_CD
                               <!-- Add End 2019/01/21 QC#29782 -->
                               ,#svcInvChrgTpCdIsMc#        AS SVC_INV_CHRG_TP_CD
                               ,'Overage'                   AS SVC_INV_CHRG_TP_NM
                               ,
                                (
                                  SELECT COUNT(*) AS DCBA_COUNT FROM DS_CONTR_BR_ALLOC
                                  WHERE
                                   GLBL_CMPY_CD            = #glblCmpyCd#
                                   AND DS_CONTR_PK         = #dsContrPk#
                                   AND DS_CONTR_DTL_PK     = DCD.DS_CONTR_DTL_PK
                                   AND SVC_INV_CHRG_TP_CD  = #svcInvChrgTpCdIsMc#
                                   AND EZCANCELFLAG        = '0'
                               ) DCBA_COUNT
                               , 
                               (
                                SELECT COUNT(*) AS DCSA_COUNT FROM DS_CONTR_SEG_ALLOC
                                WHERE
                                 GLBL_CMPY_CD             = #glblCmpyCd#
                                 AND DS_CONTR_PK          = #dsContrPk#
                                 AND DS_CONTR_DTL_PK      = DCD.DS_CONTR_DTL_PK
                                 AND SVC_INV_CHRG_TP_CD   = #svcInvChrgTpCdIsMc#
                                 AND EZCANCELFLAG = '0'
                               ) DCSA_COUNT
                               ,NULL                       AS COLLAPSE 
                               ,3                          AS LEVEL_NB
<!-- START 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
                              ,CASE WHEN DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCdIsAcc# THEN DCD.PRNT_DS_CONTR_DTL_PK
                                    ELSE DCD.DS_CONTR_DTL_PK
                               END                         AS SORT_NUM
                              ,DCD.PRNT_DS_CONTR_DTL_PK    AS PRNT_DS_CONTR_DTL_PK
<!-- END 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
                              ,NVL(SMMP.SER_NUM, SMM.SER_NUM)  AS SER_NUM_SORT
                              ,NVL(SMMP.MDSE_CD, SMM.MDSE_CD)  AS MDSE_CD_SORT
                              ,DCDT.DS_CONTR_DTL_TP_SORT_NUM
 
                      FROM 
                               DS_CONTR DS
                              ,DS_CONTR_DTL DCD
                              ,SVC_MACH_MSTR SMM
                              ,DS_CONTR_DTL_TP DCDT
                              ,DS_CONTR_DTL DCDP
                              ,SVC_MACH_MSTR SMMP
                              <!-- Add Start 2019/01/21 QC#29782 -->
                              ,MDSE M
                              ,SVC_PGM_TP SPT
                              <!-- Add End 2019/01/21 QC#29782 -->
                      WHERE
                              DS.GLBL_CMPY_CD              = #glblCmpyCd#
                              AND DS.DS_CONTR_PK           = #dsContrPk#
                              AND DS.EZCANCELFLAG          = '0'
                              AND DCD.GLBL_CMPY_CD         = DS.GLBL_CMPY_CD
                              AND DCD.DS_CONTR_PK          = DS.DS_CONTR_PK
                              AND DCD.DS_CONTR_DTL_TP_CD   &lt;&gt; #dsContrDtlTpCdIsAgg#
                              AND DCD.EZCANCELFLAG         = '0'
                              AND SMM.GLBL_CMPY_CD         = DCD.GLBL_CMPY_CD
                              AND SMM.SVC_MACH_MSTR_PK     = DCD.SVC_MACH_MSTR_PK
                              AND SMM.EZCANCELFLAG         = '0'
                              AND DCDT.GLBL_CMPY_CD        = DCD.GLBL_CMPY_CD
                              AND DCDT.DS_CONTR_DTL_TP_CD  = DCD.DS_CONTR_DTL_TP_CD
                              AND DCDT.USG_CHRG_FLG        = 'Y'
                              AND DCDT.EZCANCELFLAG        = '0'

                              AND DCD.PRNT_DS_CONTR_DTL_PK = DCDP.DS_CONTR_DTL_PK(+)
                              AND DCD.GLBL_CMPY_CD         = DCDP.GLBL_CMPY_CD(+)
                              AND DCDP.EZCANCELFLAG(+)     = '0'
                              AND DCDP.SVC_MACH_MSTR_PK    = SMMP.SVC_MACH_MSTR_PK(+)
                              AND DCDP.GLBL_CMPY_CD        = SMMP.GLBL_CMPY_CD(+)
                              AND SMMP.EZCANCELFLAG(+)     = '0'

                              <!-- Add Start 2019/01/21 QC#29782 -->
                              AND DCD.SVC_PGM_MDSE_CD      = M.MDSE_CD(+)
                              AND DCD.GLBL_CMPY_CD         = M.GLBL_CMPY_CD(+)
                              AND M.EZCANCELFLAG(+)        = '0'

                              AND M.GLBL_CMPY_CD           = SPT.GLBL_CMPY_CD(+)
                              AND M.SVC_PGM_TP_CD          = SPT.SVC_PGM_TP_CD(+)
                              AND SPT.EZCANCELFLAG(+)      = '0'
                              <!-- Add End 2019/01/21 QC#29782 -->
               ) CONTR
               ORDER BY
                   CONTR.SER_NUM_SORT
                   ,CONTR.MDSE_CD_SORT
                   <!-- Add Start 2019/01/21 QC#29782 -->
                   ,CONTR.SVC_PGM_TP_SORT_NUM
                   ,NVL(CONTR.DS_CONTR_CRAT_TP_CD, #dsContrCratTp#)
                   ,NVL(CONTR.PRNT_DS_CONTR_DTL_PK, CONTR.DS_CONTR_DTL_PK)
                   <!-- Add End 2019/01/21 QC#29782 -->
                   ,CONTR.DS_CONTR_DTL_TP_SORT_NUM
                   ,CONTR.DS_CONTR_DTL_PK
                   ,CONTR.LEVEL_NB
       )
       WHERE
       ROWNUM  &lt;=   #limitCount#
<!-- END 2016/02/23 T.Tsuchida [QC#1797, ADD] -->
    </statement>
</sqlMap>
