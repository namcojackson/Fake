<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NWXC100001GetLastInvUptoDt">

    <statement id="getLastInvUptoDt" parameterClass="Map" resultClass="Map">
        SELECT 
              DC.DS_CONTR_NUM
            , DC.DS_CONTR_SQ_NUM
            , DC.DS_CONTR_TP_CD
            , DCD1.SVC_CONFIG_MSTR_PK
            , DCD1.DS_CONTR_DTL_TP_CD
            , DCD1.DS_CONTR_DTL_PK
            , DCD1.CONTR_CLO_DT
            , CASE 
                WHEN DCD1.BASE_INV_UP_TO_DT IS NULL THEN
                    CASE 
                        WHEN DCDT.FLEET_LINE_FLG = 'Y' THEN
                            DCD2.BASE_INV_UP_TO_DT
                        ELSE
                            DCD1.BASE_INV_UP_TO_DT
                    END
                ELSE 
                    DCD1.BASE_INV_UP_TO_DT
              END BASE_INV_UP_TO_DT
            , CASE 
                WHEN DCD1.MTR_INV_UP_TO_DT IS NULL THEN
                    CASE 
                        WHEN DCDT.FLEET_LINE_FLG = 'Y' THEN
                            DCD2.MTR_INV_UP_TO_DT
                        ELSE
                            DCD1.MTR_INV_UP_TO_DT
                    END
                ELSE 
                    DCD1.MTR_INV_UP_TO_DT
              END MTR_INV_UP_TO_DT
            , DCD2.DS_CONTR_DTL_PK FLEET_DS_CONTR_DTL_PK
        FROM
              DS_CONTR_DTL    DCD1
            , DS_CONTR        DC
            , DS_CONTR_DTL    DCD2 -- Fleet
            , DS_CONTR_DTL_TP DCDT
        WHERE 
                DCD1.GLBL_CMPY_CD           = #glblCmpyCd#
            AND DCD1.SVC_CONFIG_MSTR_PK     = #svcConfigMstrPk#
            AND DCD1.DS_CONTR_DTL_STS_CD    &lt;&gt; #dsContrDtlStsCd#
            AND DCD1.GLBL_CMPY_CD           = DC.GLBL_CMPY_CD
            AND DCD1.DS_CONTR_PK            = DC.DS_CONTR_PK
            AND DC.DS_CONTR_TP_CD           &lt;&gt; #dsContrTpCd#
            AND DCD1.GLBL_CMPY_CD           = DCD2.GLBL_CMPY_CD(+)
            AND DCD1.PRNT_DS_CONTR_DTL_PK   = DCD2.DS_CONTR_DTL_PK(+)
            AND DCD2.DS_CONTR_DTL_STS_CD(+) &lt;&gt; #dsContrDtlStsCd#
            AND DCD2.GLBL_CMPY_CD           = DCDT.GLBL_CMPY_CD (+)
            AND DCD2.DS_CONTR_DTL_TP_CD     = DCDT.DS_CONTR_DTL_TP_CD (+)
            AND DCD1.EZCANCELFLAG           = '0'
            AND DC.EZCANCELFLAG             = '0'
            AND DCD2.EZCANCELFLAG(+)        = '0'
            AND DCDT.EZCANCELFLAG(+)        = '0'
        ORDER BY
            DCD1.DS_CONTR_DTL_PK
    </statement>

    <statement id="getSupplyLastInvUptoDt" parameterClass="Map" resultClass="Map">
        SELECT 
              DC.DS_CONTR_NUM
            , DC.DS_CONTR_SQ_NUM
            , DC.DS_CONTR_TP_CD
            , DCD1.SVC_CONFIG_MSTR_PK
            , DCD1.DS_CONTR_DTL_TP_CD
            , DCD1.DS_CONTR_DTL_PK
            , DCD1.CONTR_CLO_DT
            , DCD1.BASE_INV_UP_TO_DT
            , DCD1.MTR_INV_UP_TO_DT
        FROM
              DS_CONTR_DTL    DCD1
            , DS_CONTR        DC
            , DS_CONTR_DTL_TP DCDT
        WHERE 
                DCD1.GLBL_CMPY_CD           = #glblCmpyCd#
            AND DCD1.PRNT_DS_CONTR_DTL_PK   = #prntDsContrDtlPk#
            AND DCD1.DS_CONTR_DTL_STS_CD    &lt;&gt; #dsContrDtlStsCd#
            AND DCD1.GLBL_CMPY_CD           = DC.GLBL_CMPY_CD
            AND DCD1.DS_CONTR_PK            = DC.DS_CONTR_PK
            AND DC.DS_CONTR_TP_CD           &lt;&gt; #dsContrTpCd#
            AND DCD1.GLBL_CMPY_CD           = DCDT.GLBL_CMPY_CD
            AND DCD1.DS_CONTR_DTL_TP_CD     = DCDT.DS_CONTR_DTL_TP_CD
            AND DCDT.SPLY_LINE_FLG          = #splyLineFlg#
            AND DCD1.EZCANCELFLAG           = '0'
            AND DC.EZCANCELFLAG             = '0'
            AND DCDT.EZCANCELFLAG           = '0'
        ORDER BY
            DCD1.DS_CONTR_DTL_PK
    </statement>
</sqlMap>
