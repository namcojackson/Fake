<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NLCB114001">

    <statement id="getTrgtYrMth" parameterClass="Map" resultClass="String">
        SELECT
            CAL.DWH_TRGT_YR_MTH
        FROM
            DMN_RPT_CAL            CAL
        WHERE 
            CAL.GLBL_CMPY_CD       = #glblCmpyCd#
        AND CAL.DWH_TRGT_DT        = #trgtDt#
        AND CAL.EZCANCELFLAG       = '0'
    </statement>

    <statement id="getTrgtYrMthRec" parameterClass="Map" resultClass="BigDecimal">
        SELECT COUNT(1)
        FROM
            FCT_INVTY_OH_SMRY        OH
        WHERE 
            OH.GLBL_CMPY_CD         = #glblCmpyCd#
        AND OH.DWH_TRGT_YR_MTH      = #trgtYrMth#
        AND OH.EZCANCELFLAG         = '0'
    </statement>

    <statement id="getMainData" parameterClass="Map" resultClass="Map">

        SELECT
            INVTY2.RTL_WH_CD
           ,INVTY2.RTL_SWH_CD
           ,INVTY2.RTL_WH_CATG_CD
           ,INVTY2.TECH_TOC_CD
           ,INVTY2.MDSE_CD
           ,MDSE.MKT_MDL_CD                                            AS MKTG_MDL_CD
           ,MDSE.THIS_MTH_TOT_STD_COST_AMT                             AS UNIT_COST_AMT
           ,INVTY2.INVTY_AVAL_QTY
           ,MDSE.THIS_MTH_TOT_STD_COST_AMT * INVTY2.INVTY_AVAL_QTY     AS AVAL_INVTY_COST_AMT
           ,INVTY2.BO_QTY
           ,INVTY2.IN_TRNST_QTY
           ,INVTY2.ON_ORD_QTY_01
           ,INVTY2.ON_ORD_QTY_02
           ,INVTY2.ON_ORD_QTY_03
           ,INVTY2.ON_ORD_QTY_04
           ,INVTY2.ON_ORD_QTY_05
           ,INVTY2.ORD_QTY_01
           ,INVTY2.ORD_QTY_02
           ,INVTY2.ORD_QTY_03
           ,INVTY2.ORD_QTY_04
           ,INVTY2.ORD_QTY_05
           ,INVTY2.LAST_RCPT_DT
           ,INVTY2.LAST_USG_DT
           ,INVTY2.TMTH_RCV_QTY
           ,INVTY2.TMTH_RCV_QTY * MDSE.THIS_MTH_TOT_STD_COST_AMT       AS TMTH_RCV_INVTY_AMT
           ,INVTY2.TMTH_RTRN_QTY
           ,INVTY2.TMTH_RTRN_QTY * MDSE.THIS_MTH_TOT_STD_COST_AMT      AS TMTH_RTRN_AMT
           ,INVTY2.TMTH_ADJ_QTY
           ,INVTY2.TMTH_ADJ_QTY * MDSE.THIS_MTH_TOT_STD_COST_AMT       AS TMTH_ADJ_AMT
           ,INVTY2.TMTH_USG_QTY
           ,INVTY2.TMTH_USG_QTY * MDSE.THIS_MTH_TOT_STD_COST_AMT       AS TMTH_USG_AMT
           ,NVL(MRP.ROP_QTY,0)                                         AS ROP_QTY
           ,NVL(MRP.MAX_INVTY_QTY,0)                                   AS MAX_INVTY_QTY
           ,NVL(MAX_INVTY_QTY * MDSE.THIS_MTH_TOT_STD_COST_AMT,0)      AS RPLSH_AUTH_AMT
           ,NVL(MRP.MAX_INVTY_QTY,0)                                   AS RPLSH_AUTH_QTY
           ,CASE MRP.RPLSH_DLY_FLG WHEN 'Y' THEN RPLSH_DLY_FLG ELSE NVL(MRP.RPLSH_MON_FLG,'N') END RPLSH_MON_FLG
           ,CASE MRP.RPLSH_DLY_FLG WHEN 'Y' THEN RPLSH_DLY_FLG ELSE NVL(MRP.RPLSH_TUE_FLG,'N') END RPLSH_TUE_FLG
           ,CASE MRP.RPLSH_DLY_FLG WHEN 'Y' THEN RPLSH_DLY_FLG ELSE NVL(MRP.RPLSH_WED_FLG,'N') END RPLSH_WED_FLG
           ,CASE MRP.RPLSH_DLY_FLG WHEN 'Y' THEN RPLSH_DLY_FLG ELSE NVL(MRP.RPLSH_THU_FLG,'N') END RPLSH_THU_FLG
           ,CASE MRP.RPLSH_DLY_FLG WHEN 'Y' THEN RPLSH_DLY_FLG ELSE NVL(MRP.RPLSH_FRI_FLG,'N') END RPLSH_FRI_FLG
        FROM
            (
            SELECT
                INVTY1.GLBL_CMPY_CD
               ,INVTY1.RTL_WH_CD
               ,INVTY1.RTL_SWH_CD
               ,INVTY1.RTL_WH_CATG_CD
               ,INVTY1.TECH_TOC_CD
               ,INVTY1.MDSE_CD
               ,SUM(NVL(INVTY1.INVTY_AVAL_QTY,0)) AS INVTY_AVAL_QTY
               ,SUM(NVL(INVTY1.BOQTY,0))          AS BO_QTY
               ,SUM(NVL(INVTY1.INTRANSIT,0))      AS IN_TRNST_QTY
               ,SUM(CASE INVTY1.ONORDERWEEK WHEN #onOrderWeek1# THEN NVL(INVTY1.ONORDER,0) ELSE 0 END)   AS ON_ORD_QTY_01
               ,SUM(CASE INVTY1.ONORDERWEEK WHEN #onOrderWeek2# THEN NVL(INVTY1.ONORDER,0) ELSE 0 END)   AS ON_ORD_QTY_02
               ,SUM(CASE INVTY1.ONORDERWEEK WHEN #onOrderWeek3# THEN NVL(INVTY1.ONORDER,0) ELSE 0 END)   AS ON_ORD_QTY_03
               ,SUM(CASE INVTY1.ONORDERWEEK WHEN #onOrderWeek4# THEN NVL(INVTY1.ONORDER,0) ELSE 0 END)   AS ON_ORD_QTY_04
               ,SUM(CASE INVTY1.ONORDERWEEK WHEN #onOrderWeek5# THEN NVL(INVTY1.ONORDER,0) ELSE 0 END)   AS ON_ORD_QTY_05
               ,SUM(CASE INVTY1.ORDEREDWEEK WHEN #orderedWeek1# THEN NVL(INVTY1.POORDERED,0) ELSE 0 END) AS ORD_QTY_01
               ,SUM(CASE INVTY1.ORDEREDWEEK WHEN #orderedWeek2# THEN NVL(INVTY1.POORDERED,0) ELSE 0 END) AS ORD_QTY_02
               ,SUM(CASE INVTY1.ORDEREDWEEK WHEN #orderedWeek3# THEN NVL(INVTY1.POORDERED,0) ELSE 0 END) AS ORD_QTY_03
               ,SUM(CASE INVTY1.ORDEREDWEEK WHEN #orderedWeek4# THEN NVL(INVTY1.POORDERED,0) ELSE 0 END) AS ORD_QTY_04
               ,SUM(CASE INVTY1.ORDEREDWEEK WHEN #orderedWeek5# THEN NVL(INVTY1.POORDERED,0) ELSE 0 END) AS ORD_QTY_05
               ,MAX(INVTY1.RECEIVEDDATE)          AS LAST_RCPT_DT
               ,MAX(INVTY1.USAGEDATE)             AS LAST_USG_DT
               ,SUM(NVL(INVTY1.RECEIVEDQTY,0))    AS TMTH_RCV_QTY
               ,SUM(NVL(INVTY1.RETURNEDQTY,0))    AS TMTH_RTRN_QTY
               ,SUM(NVL(INVTY1.ADJUSTEDQTY,0))    AS TMTH_ADJ_QTY
               ,SUM(NVL(INVTY1.USAGE,0))          AS TMTH_USG_QTY
            FROM
                (
                SELECT
                    INV.GLBL_CMPY_CD
                   ,INV.MDSE_CD
                   ,RSWH.RTL_WH_CD
                   ,RSWH.RTL_SWH_CD
                   ,RSWH.RTL_WH_CATG_CD
                   ,TECH.TECH_TOC_CD
                   ,INV.INVTY_AVAL_QTY
                   ,0    AS BOQTY
                   ,0    AS INTRANSIT
                   ,0    AS ONORDER
                   ,NULL AS ONORDERWEEK
                   ,0    AS POORDERED
                   ,NULL AS ORDEREDWEEK
                   ,NULL AS RECEIVEDDATE
                   ,NULL AS USAGEDATE
                   ,0    AS RECEIVEDQTY
                   ,0    AS RETURNEDQTY
                   ,0    AS ADJUSTEDQTY
                   ,0    AS USAGE
                FROM
                    INVTY    INV
                   ,RTL_SWH  RSWH
                   ,TECH_LOC TECH
                WHERE
                    INV.GLBL_CMPY_CD     = #glblCmpyCd#
                AND INV.LOC_STS_CD       = #locStsCdOnHand#
                AND INV.GLBL_CMPY_CD     = RSWH.GLBL_CMPY_CD
                AND INV.INVTY_LOC_CD     = RSWH.INVTY_LOC_CD
                AND INV.GLBL_CMPY_CD     = TECH.GLBL_CMPY_CD(+)
                AND INV.INVTY_LOC_CD     = TECH.TECH_LOC_CD(+)
                AND INV.EZCANCELFLAG     = '0'
                AND RSWH.EZCANCELFLAG    = '0'
                AND TECH.EZCANCELFLAG(+) = '0'
                
                UNION ALL
                
                SELECT
                    INV.GLBL_CMPY_CD
                   ,INV.MDSE_CD
                   ,RSWH.RTL_WH_CD
                   ,RSWH.RTL_SWH_CD
                   ,RSWH.RTL_WH_CATG_CD
                   ,TECH.TECH_TOC_CD
                   ,0
                   ,0                  AS BOQTY
                   ,INV.INVTY_AVAL_QTY AS INTRANSIT
                   ,0                  AS ONORDER
                   ,NULL               AS ONORDERWEEK
                   ,0                  AS POORDERED
                   ,NULL               AS ORDEREDWEEK
                   ,NULL               AS RECEIVEDDATE
                   ,NULL               AS USAGEDATE
                   ,0                  AS RECEIVEDQTY
                   ,0                  AS RETURNEDQTY
                   ,0                  AS ADJUSTEDQTY
                   ,0                  AS USAGE
                FROM
                    INVTY    INV
                   ,RTL_SWH  RSWH
                   ,TECH_LOC TECH
                WHERE
                    INV.GLBL_CMPY_CD     = #glblCmpyCd#
                AND INV.LOC_STS_CD       = #locStsCdIntransit#
                AND INV.GLBL_CMPY_CD     = RSWH.GLBL_CMPY_CD
                AND INV.INVTY_LOC_CD     = RSWH.INVTY_LOC_CD
                AND INV.GLBL_CMPY_CD     = TECH.GLBL_CMPY_CD(+)
                AND INV.INVTY_LOC_CD     = TECH.TECH_LOC_CD(+)
                AND INV.EZCANCELFLAG     = '0'
                AND RSWH.EZCANCELFLAG    = '0'
                AND TECH.EZCANCELFLAG(+) = '0'
                
                UNION ALL
                
                SELECT
                    SHPG.GLBL_CMPY_CD
                   ,SHPG.MDSE_CD
                   ,RSWH.RTL_WH_CD
                   ,RSWH.RTL_SWH_CD
                   ,RSWH.RTL_WH_CATG_CD
                   ,TECH.TECH_TOC_CD
                   ,0
                   ,SHPG.ORD_QTY AS BOQTY
                   ,0            AS INTRANSIT
                   ,0            AS ONORDER
                   ,NULL         AS ONORDERWEEK
                   ,0            AS POORDERED
                   ,NULL         AS ORDEREDWEEK
                   ,NULL         AS RECEIVEDDATE
                   ,NULL         AS USAGEDATE
                   ,0            AS RECEIVEDQTY
                   ,0            AS RETURNEDQTY
                   ,0            AS ADJUSTEDQTY
                   ,0            AS USAGE
                FROM
                    SHPG_PLN SHPG
                   ,CPO_DTL  CPO
                   ,RTL_SWH  RSWH
                   ,TECH_LOC TECH
                WHERE
                    SHPG.GLBL_CMPY_CD        = #glblCmpyCd#
                AND SHPG.SHPG_STS_CD         = #shpgStsCdBo#
                AND SHPG.CR_HLD_QTY          = 0
                AND SHPG.CR_CHK_QTY          > 0
                AND CPO.CPO_ORD_NUM          = SHPG.TRX_HDR_NUM
                AND CPO.CPO_DTL_LINE_NUM     = SHPG.TRX_LINE_NUM
                AND CPO.CPO_DTL_LINE_SUB_NUM = SHPG.TRX_LINE_SUB_NUM
                AND SHPG.GLBL_CMPY_CD        = RSWH.GLBL_CMPY_CD
                AND SHPG.INVTY_LOC_CD        = RSWH.INVTY_LOC_CD
                AND SHPG.GLBL_CMPY_CD        = TECH.GLBL_CMPY_CD(+)
                AND SHPG.INVTY_LOC_CD        = TECH.TECH_LOC_CD(+)
                AND SHPG.EZCANCELFLAG        = '0'
                AND CPO.EZCANCELFLAG         = '0'
                AND RSWH.EZCANCELFLAG        = '0'
                AND TECH.EZCANCELFLAG(+)     = '0'
                
                UNION ALL
                
                SELECT
                    SHPG.GLBL_CMPY_CD
                   ,SHPG.MDSE_CD
                   ,RSWH.RTL_WH_CD
                   ,RSWH.RTL_SWH_CD
                   ,RSWH.RTL_WH_CATG_CD
                   ,TECH.TECH_TOC_CD
                   ,0
                   ,0            AS BOQTY
                   ,0            AS INTRANSIT
                   ,SHPG.ORD_QTY AS ONORDER
                   ,CASE WHEN to_date(SHPG.RDD_DT, 'yyyyMMdd') IS NULL THEN #onOrderWeek1#
                         WHEN to_date(#trgtDt#, 'yyyyMMdd') + #week# > to_date(SHPG.RDD_DT, 'yyyyMMdd') THEN  #onOrderWeek1# 
                         WHEN to_date(SHPG.RDD_DT, 'yyyyMMdd' ) >= to_date(#trgtDt#, 'yyyyMMdd') + #week# AND to_date(#trgtDt#, 'yyyyMMdd') + 14 > to_date(SHPG.RDD_DT, 'yyyyMMdd') THEN #onOrderWeek2#
                         WHEN to_date(SHPG.RDD_DT, 'yyyyMMdd' ) >= to_date(#trgtDt#, 'yyyyMMdd') + #week# * #onOrderWeek2# AND to_date(#trgtDt#, 'yyyyMMdd') + #week# * #onOrderWeek3# > to_date(SHPG.RDD_DT, 'yyyyMMdd') THEN #onOrderWeek3#
                         WHEN to_date(SHPG.RDD_DT, 'yyyyMMdd' ) >= to_date(#trgtDt#, 'yyyyMMdd') + #week# * #onOrderWeek3# AND to_date(#trgtDt#, 'yyyyMMdd') + #week# * #onOrderWeek4# > to_date(SHPG.RDD_DT, 'yyyyMMdd') THEN #onOrderWeek4#
                         WHEN to_date(SHPG.RDD_DT, 'yyyyMMdd' ) >= to_date(#trgtDt#, 'yyyyMMdd') + #week# * #onOrderWeek4# THEN #onOrderWeek5# ELSE '' END AS ONORDERWEEK
                   ,0            AS POORDERED
                   ,NULL         AS ORDEREDWEEK
                   ,NULL         AS RECEIVEDDATE
                   ,NULL         AS USAGEDATE
                   ,0            AS RECEIVEDQTY
                   ,0            AS RETURNEDQTY
                   ,0            AS ADJUSTEDQTY
                   ,0            AS USAGE
                FROM
                    SHPG_PLN SHPG
                   ,CPO_DTL  CPO
                   ,RTL_SWH  RSWH
                   ,TECH_LOC TECH
                   ,SHPG_STS STS
                WHERE
                    SHPG.GLBL_CMPY_CD        = #glblCmpyCd#
                AND SHPG.SHIP_PLN_CANC_FLG   = 'N'
                AND CPO.CPO_ORD_NUM          = SHPG.TRX_HDR_NUM
                AND CPO.CPO_DTL_LINE_NUM     = SHPG.TRX_LINE_NUM
                AND CPO.CPO_DTL_LINE_SUB_NUM = SHPG.TRX_LINE_SUB_NUM
                AND SHPG.GLBL_CMPY_CD        = RSWH.GLBL_CMPY_CD
                AND SHPG.INVTY_LOC_CD        = RSWH.INVTY_LOC_CD
                AND RSWH.RTL_SWH_CD          NOT IN (#rtlSwhCd1#, #rtlSwhCd2#)
                AND SHPG.GLBL_CMPY_CD        = TECH.GLBL_CMPY_CD(+)
                AND SHPG.INVTY_LOC_CD        = TECH.TECH_LOC_CD(+)
                AND SHPG.GLBL_CMPY_CD        = STS.GLBL_CMPY_CD
                AND SHPG.SHPG_STS_CD         = STS.SHPG_STS_CD
                AND STS.SHIP_FLG             = 'N'
                AND SHPG.EZCANCELFLAG        = '0'
                AND CPO.EZCANCELFLAG         = '0'
                AND RSWH.EZCANCELFLAG        = '0'
                AND TECH.EZCANCELFLAG(+)     = '0'
                AND STS.EZCANCELFLAG         = '0'
                
                UNION ALL
                
                SELECT
                    PO.GLBL_CMPY_CD
                   ,POD.MDSE_CD
                   ,POD.DEST_RTL_WH_CD
                   ,POD.DEST_RTL_SWH_CD
                   ,RSWH.RTL_WH_CATG_CD
                   ,TECH.TECH_TOC_CD
                   ,0
                   ,0              AS BOQTY
                   ,0              AS INTRANSIT
                   ,0              AS ONORDER
                   ,NULL           AS ONORDERWEEK
                   ,POD.PO_BAL_QTY AS POORDERED
                   ,CASE WHEN to_date(POD.RQST_RCV_DT, 'yyyyMMdd') IS NULL THEN #orderedWeek1#
                         WHEN to_date(#trgtDt#, 'yyyyMMdd') + #week# > to_date(POD.RQST_RCV_DT, 'yyyyMMdd') THEN '1'
                         WHEN to_date(POD.RQST_RCV_DT, 'yyyyMMdd') >= to_date(#trgtDt#, 'yyyyMMdd') + #week# AND to_date(#trgtDt#, 'yyyyMMdd') + #week# * #orderedWeek2# > to_date(POD.RQST_RCV_DT, 'yyyyMMdd') THEN #orderedWeek2#
                         WHEN to_date(POD.RQST_RCV_DT, 'yyyyMMdd') >= to_date(#trgtDt#, 'yyyyMMdd') + #week# * #orderedWeek2# AND to_date(#trgtDt#, 'yyyyMMdd') + #week# * #orderedWeek3# > to_date(POD.RQST_RCV_DT, 'yyyyMMdd') THEN #orderedWeek3#
                         WHEN to_date(POD.RQST_RCV_DT, 'yyyyMMdd') >= to_date(#trgtDt#, 'yyyyMMdd') + #week# * #orderedWeek3# AND to_date(#trgtDt#, 'yyyyMMdd') + #week# * #orderedWeek4# > to_date(POD.RQST_RCV_DT, 'yyyyMMdd') THEN #orderedWeek4#
                         WHEN to_date(POD.RQST_RCV_DT, 'yyyyMMdd') >= to_date(#trgtDt#, 'yyyyMMdd') + #week# * #orderedWeek4# THEN #orderedWeek5# ELSE '' END AS ORDEREDWEEK
                   ,NULL           AS RECEIVEDDATE
                   ,NULL           AS USAGEDATE
                   ,0              AS RECEIVEDQTY
                   ,0              AS RETURNEDQTY
                   ,0              AS ADJUSTEDQTY
                   ,0              AS USAGE
                FROM
                    PO        PO
                   ,PO_DTL    POD
                   ,RTL_SWH   RSWH
                   ,TECH_LOC  TECH
                WHERE
                    PO.GLBL_CMPY_CD         = #glblCmpyCd#
                AND PO.PO_HDR_STS_CD        = #poHdrStsCd#
                AND PO.GLBL_CMPY_CD         = POD.GLBL_CMPY_CD
                AND PO.PO_ORD_NUM           = POD.PO_ORD_NUM
                AND POD.DEST_RTL_SWH_CD     NOT IN (#rtlSwhCd1#, #rtlSwhCd2#)
                AND POD.PO_BAL_QTY         != 0
                AND POD.GLBL_CMPY_CD        = RSWH.GLBL_CMPY_CD(+)
                AND POD.DEST_RTL_WH_CD      = RSWH.RTL_WH_CD(+)
                AND POD.DEST_RTL_SWH_CD     = RSWH.RTL_SWH_CD(+)
                AND RSWH.GLBL_CMPY_CD       = TECH.GLBL_CMPY_CD(+)
                AND RSWH.INVTY_LOC_CD       = TECH.TECH_LOC_CD(+)
                AND PO.EZCANCELFLAG         = '0'
                AND POD.EZCANCELFLAG        = '0'
                AND RSWH.EZCANCELFLAG(+)    = '0'
                AND TECH.EZCANCELFLAG(+)    = '0'
                
                UNION ALL
                
                SELECT
                    INVT.GLBL_CMPY_CD
                   ,INVT.MDSE_CD
                   ,RSWH.RTL_WH_CD
                   ,RSWH.RTL_SWH_CD
                   ,RSWH.RTL_WH_CATG_CD
                   ,TECH.TECH_TOC_CD
                   ,0
                   ,0                  AS BOQTY
                   ,0                  AS INTRANSIT
                   ,0                  AS ONORDER
                   ,NULL               AS ONORDERWEEK
                   ,0                  AS POORDERED
                   ,NULL               AS ORDEREDWEEK
                   ,INVT.INVTY_TRX_DT  AS RECEIVEDDATE
                   ,NULL               AS USAGEDATE
                   ,INVT.INVTY_TRX_QTY AS RECEIVEDQTY
                   ,0                  AS RETURNEDQTY
                   ,0                  AS ADJUSTEDQTY
                   ,0                  AS USAGE
                FROM
                    INVTY_TRX INVT
                   ,RTL_SWH   RSWH
                   ,TECH_LOC  TECH
                WHERE
                    INVT.GLBL_CMPY_CD                             = #glblCmpyCd#
                AND INVT.LOC_TP_CD                                = #locTpCd#
                AND INVT.LOC_STS_CD || INVT.TRX_CD || INVT.TRX_RSN_CD IN (#cdReceived1#, #cdReceived2#, #cdReceived3#)
                AND INVT.GLBL_CMPY_CD                             = RSWH.GLBL_CMPY_CD
                AND INVT.INVTY_LOC_CD                             = RSWH.INVTY_LOC_CD
                AND INVT.GLBL_CMPY_CD                             = TECH.GLBL_CMPY_CD(+)
                AND INVT.INVTY_LOC_CD                             = TECH.TECH_LOC_CD(+)
                AND SUBSTR(INVT.INVTY_TRX_DT, 0, #invtyTrxYrMth#) = SUBSTR(#trgtDt#, 0, #invtyTrxYrMth#)
                AND INVT.EZCANCELFLAG                             = '0'
                AND RSWH.EZCANCELFLAG                             = '0'
                AND TECH.EZCANCELFLAG(+)                          = '0'
                
                UNION ALL
                
                SELECT
                    INVT.GLBL_CMPY_CD
                   ,INVT.MDSE_CD
                   ,RSWH.RTL_WH_CD
                   ,RSWH.RTL_SWH_CD
                   ,RSWH.RTL_WH_CATG_CD
                   ,TECH.TECH_TOC_CD
                   ,0
                   ,0                       AS BOQTY
                   ,0                       AS INTRANSIT
                   ,0                       AS ONORDER
                   ,NULL                    AS ONORDERWEEK
                   ,0                       AS POORDERED
                   ,NULL                    AS ORDEREDWEEK
                   ,NULL                    AS RECEIVEDDATE
                   ,NULL                    AS USAGEDATE
                   ,0                       AS RECEIVEDQTY
                   ,INVT.INVTY_TRX_QTY * -1 AS RETURNEDQTY
                   ,0                       AS ADJUSTEDQTY
                   ,0                       AS USAGE
                FROM
                    INVTY_TRX INVT
                   ,RTL_SWH   RSWH
                   ,TECH_LOC  TECH
                WHERE
                    INVT.GLBL_CMPY_CD                             = #glblCmpyCd#
                AND INVT.LOC_TP_CD                                = #locTpCd#
                AND INVT.LOC_STS_CD || INVT.TRX_CD || INVT.TRX_RSN_CD IN (#cdReturned1#, #cdReturned2#)
                AND INVT.GLBL_CMPY_CD                             = RSWH.GLBL_CMPY_CD
                AND INVT.INVTY_LOC_CD                             = RSWH.INVTY_LOC_CD
                AND INVT.GLBL_CMPY_CD                             = TECH.GLBL_CMPY_CD(+)
                AND INVT.INVTY_LOC_CD                             = TECH.TECH_LOC_CD(+)
                AND SUBSTR(INVT.INVTY_TRX_DT, 0, #invtyTrxYrMth#) = SUBSTR(#trgtDt#, 0, #invtyTrxYrMth#)
                AND INVT.EZCANCELFLAG                             = '0'
                AND RSWH.EZCANCELFLAG                             = '0'
                AND TECH.EZCANCELFLAG(+)                          = '0'
                
                UNION ALL
                
                SELECT
                    INVT.GLBL_CMPY_CD
                   ,INVT.MDSE_CD
                   ,RSWH.RTL_WH_CD
                   ,RSWH.RTL_SWH_CD
                   ,RSWH.RTL_WH_CATG_CD
                   ,TECH.TECH_TOC_CD
                   ,0
                   ,0                  AS BOQTY
                   ,0                  AS INTRANSIT
                   ,0                  AS ONORDER
                   ,NULL               AS ONORDERWEEK
                   ,0                  AS POORDERED
                   ,NULL               AS ORDEREDWEEK
                   ,NULL               AS RECEIVEDDATE
                   ,NULL               AS USAGEDATE
                   ,0                  AS RECEIVEDQTY
                   ,0                  AS RETURNEDQTY
                   ,INVT.INVTY_TRX_QTY AS ADJUSTEDQTY
                   ,0                  AS USAGE
                FROM
                    INVTY_TRX INVT
                   ,RTL_SWH   RSWH
                   ,TECH_LOC  TECH
                WHERE
                    INVT.GLBL_CMPY_CD                             = #glblCmpyCd#
                AND INVT.LOC_TP_CD                                = #locTpCd#
                AND INVT.LOC_STS_CD || INVT.TRX_CD || INVT.TRX_RSN_CD IN (#cdAdjusted1#, #cdAdjusted2#, #cdAdjusted3#) 
                AND INVT.GLBL_CMPY_CD                             = RSWH.GLBL_CMPY_CD
                AND INVT.INVTY_LOC_CD                             = RSWH.INVTY_LOC_CD
                AND INVT.GLBL_CMPY_CD                             = TECH.GLBL_CMPY_CD(+)
                AND INVT.INVTY_LOC_CD                             = TECH.TECH_LOC_CD(+)
                AND SUBSTR(INVT.INVTY_TRX_DT, 0, #invtyTrxYrMth#) = SUBSTR(#trgtDt#, 0, #invtyTrxYrMth#)
                AND INVT.EZCANCELFLAG                             = '0'
                AND RSWH.EZCANCELFLAG                             = '0'
                AND TECH.EZCANCELFLAG(+)                          = '0'
                
                UNION ALL
                
                SELECT
                    INVT.GLBL_CMPY_CD
                   ,INVT.MDSE_CD
                   ,RSWH.RTL_WH_CD
                   ,RSWH.RTL_SWH_CD
                   ,RSWH.RTL_WH_CATG_CD
                   ,TECH.TECH_TOC_CD
                   ,0
                   ,0                       AS BOQTY
                   ,0                       AS INTRANSIT
                   ,0                       AS ONORDER
                   ,NULL                    AS ONORDERWEEK
                   ,0                       AS POORDERED
                   ,NULL                    AS ORDEREDWEEK
                   ,NULL                    AS RECEIVEDDATE
                   ,INVT.INVTY_TRX_DT       AS USAGEDATE
                   ,0                       AS RECEIVEDQTY
                   ,0                       AS RETURNEDQTY
                   ,0                       AS ADJUSTEDQTY
                   ,INVT.INVTY_TRX_QTY * -1 AS USAGE
                FROM
                    INVTY_TRX INVT
                   ,RTL_SWH   RSWH
                   ,TECH_LOC  TECH
                WHERE
                    INVT.GLBL_CMPY_CD                             = #glblCmpyCd#
                AND INVT.LOC_TP_CD                                = #locTpCd#
                AND INVT.LOC_STS_CD || INVT.TRX_CD || INVT.TRX_RSN_CD = #cdUsage#
                AND INVT.GLBL_CMPY_CD                             = RSWH.GLBL_CMPY_CD
                AND INVT.INVTY_LOC_CD                             = RSWH.INVTY_LOC_CD
                AND INVT.GLBL_CMPY_CD                             = TECH.GLBL_CMPY_CD(+)
                AND INVT.INVTY_LOC_CD                             = TECH.TECH_LOC_CD(+)
                AND SUBSTR(INVT.INVTY_TRX_DT, 0, #invtyTrxYrMth#) = SUBSTR(#trgtDt#, 0, #invtyTrxYrMth#)
                AND INVT.EZCANCELFLAG                             = '0'
                AND RSWH.EZCANCELFLAG                             = '0'
                AND TECH.EZCANCELFLAG(+)                          = '0'
                ) INVTY1
                
            GROUP BY
                INVTY1.GLBL_CMPY_CD
               ,INVTY1.RTL_WH_CD
               ,INVTY1.RTL_SWH_CD
               ,INVTY1.RTL_WH_CATG_CD
               ,INVTY1.TECH_TOC_CD
               ,INVTY1.MDSE_CD
            )             INVTY2
            ,MDSE         MDSE
            ,MRP_INFO     MRP
        WHERE
            INVTY2.GLBL_CMPY_CD = MDSE.GLBL_CMPY_CD(+)
        AND MDSE.EZCANCELFLAG(+)  = '0'
        AND INVTY2.MDSE_CD      = MDSE.MDSE_CD(+)
        AND INVTY2.GLBL_CMPY_CD = MRP.GLBL_CMPY_CD(+)
        AND MRP.EZCANCELFLAG(+)  = '0'
        AND INVTY2.RTL_WH_CD    = MRP.RTL_WH_CD(+)
        AND INVTY2.RTL_SWH_CD   = MRP.RTL_SWH_CD(+)
        AND INVTY2.MDSE_CD      = MRP.MDSE_CD(+)
        AND MRP.MRP_INFO_RGTN_STS_CD(+) = 'P20'

    </statement>

</sqlMap>
