<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NFAB309001">
    <statement id="getAjeInvMdlGrpAlloc" resultClass="Map">
        SELECT
             '1' AS XX_MODE
            ,AIMGA.MDL_GRP_ID
            ,AIMGA.SVC_ALLOC_TP_CD
            ,AIMGA.SVC_INV_CHRG_TP_CD
            ,NVL(AIMGA.EQUIP_ALLOC_PCT, 0) AS EQUIP_ALLOC_PCT
            ,NVL(AIMGA.SVC_ALLOC_PCT, 0) AS SVC_ALLOC_PCT
            ,NVL(AIMGA.SPLY_ALLOC_PCT, 0) AS SPLY_ALLOC_PCT
            ,DM.MDL_ID
            ,MN.T_MDL_NM
            ,SAT.SVC_ALLOC_TP_NM
        FROM
             AJE_INV_MDL_GRP_ALLOC AIMGA
            ,DS_MDL_GRP DMG
            ,DS_MDL DM
            ,MDL_NM MN
            ,SVC_ALLOC_TP SAT
        WHERE
            AIMGA.GLBL_CMPY_CD = 'ADB'
        AND AIMGA.EZCANCELFLAG = '0'
        AND AIMGA.GLBL_CMPY_CD = DMG.GLBL_CMPY_CD
        AND AIMGA.MDL_GRP_ID = DMG.MDL_GRP_ID
        AND DMG.EZCANCELFLAG = '0'
        AND DMG.GLBL_CMPY_CD = DM.GLBL_CMPY_CD
        AND DMG.MDL_GRP_ID = DM.MDL_GRP_ID
        AND DM.EZCANCELFLAG = '0'
        AND DM.MDL_ACTV_FLG = 'Y'
        AND DM.GLBL_CMPY_CD = MN.T_GLBL_CMPY_CD
        AND DM.MDL_ID = MN.T_MDL_ID
        AND MN.EZCANCELFLAG = '0'
        AND AIMGA.GLBL_CMPY_CD = SAT.GLBL_CMPY_CD
        AND AIMGA.SVC_ALLOC_TP_CD = SAT.SVC_ALLOC_TP_CD
        AND SAT.EZCANCELFLAG = '0'
        AND NOT EXISTS(
            SELECT 1
            FROM AJE_INV_LINE_ALLOC AILA
            WHERE AILA.GLBL_CMPY_CD = AIMGA.GLBL_CMPY_CD
            AND AILA.SVC_ALLOC_TP_CD = AIMGA.SVC_ALLOC_TP_CD
            AND AILA.SVC_INV_CHRG_TP_CD = AIMGA.SVC_INV_CHRG_TP_CD
            AND AILA.MDL_ID = DM.MDL_ID
            AND AILA.EZCANCELFLAG = '0'
        )
        UNION ALL
        SELECT
             '2' AS XX_MODE
            ,AIMGA.MDL_GRP_ID
            ,AIMGA.SVC_ALLOC_TP_CD
            ,AIMGA.SVC_INV_CHRG_TP_CD
            ,NVL(AIMGA.EQUIP_ALLOC_PCT, 0) AS EQUIP_ALLOC_PCT
            ,NVL(AIMGA.SVC_ALLOC_PCT, 0) AS SVC_ALLOC_PCT
            ,NVL(AIMGA.SPLY_ALLOC_PCT, 0) AS SPLY_ALLOC_PCT
            ,DM.MDL_ID
            ,MN.T_MDL_NM
            ,SAT.SVC_ALLOC_TP_NM
        FROM
             AJE_INV_MDL_GRP_ALLOC AIMGA
            ,DS_MDL_GRP DMG
            ,DS_MDL DM
            ,MDL_NM MN
            ,SVC_ALLOC_TP SAT
        WHERE
            AIMGA.GLBL_CMPY_CD = 'ADB'
        AND AIMGA.EZCANCELFLAG = '0'
        AND AIMGA.GLBL_CMPY_CD = DMG.GLBL_CMPY_CD
        AND AIMGA.MDL_GRP_ID = DMG.MDL_GRP_ID
        AND DMG.EZCANCELFLAG = '0'
        AND DMG.GLBL_CMPY_CD = DM.GLBL_CMPY_CD
        AND DMG.MDL_GRP_ID = DM.MDL_GRP_ID
        AND DM.EZCANCELFLAG = '0'
        AND DM.MDL_ACTV_FLG = 'Y'
        AND DM.GLBL_CMPY_CD = MN.T_GLBL_CMPY_CD
        AND DM.MDL_ID = MN.T_MDL_ID
        AND MN.EZCANCELFLAG = '0'
        AND AIMGA.GLBL_CMPY_CD = SAT.GLBL_CMPY_CD
        AND AIMGA.SVC_ALLOC_TP_CD = SAT.SVC_ALLOC_TP_CD
        AND SAT.EZCANCELFLAG = '0'
        AND EXISTS(
            SELECT 1 
            FROM AJE_INV_LINE_ALLOC AILA
            WHERE AILA.GLBL_CMPY_CD = AIMGA.GLBL_CMPY_CD
            AND AILA.SVC_ALLOC_TP_CD = AIMGA.SVC_ALLOC_TP_CD
            AND AILA.SVC_INV_CHRG_TP_CD = AIMGA.SVC_INV_CHRG_TP_CD
            AND AILA.MDL_ID = DM.MDL_ID
            AND AILA.EZCANCELFLAG = '0'
            AND (
                   NVL(AILA.EQUIP_ALLOC_PCT,0) != NVL(AIMGA.EQUIP_ALLOC_PCT,0)
                OR NVL(AILA.SVC_ALLOC_PCT,0) != NVL(AIMGA.SVC_ALLOC_PCT,0)
                OR NVL(AILA.SPLY_ALLOC_PCT,0) != NVL(AIMGA.SPLY_ALLOC_PCT,0)
                )
        )
        UNION ALL
        SELECT
             '3' AS XX_MODE
            ,AIMGA.MDL_GRP_ID
            ,AIMGA.SVC_ALLOC_TP_CD
            ,AIMGA.SVC_INV_CHRG_TP_CD
            ,NVL(AIMGA.EQUIP_ALLOC_PCT, 0) AS EQUIP_ALLOC_PCT
            ,NVL(AIMGA.SVC_ALLOC_PCT, 0) AS SVC_ALLOC_PCT
            ,NVL(AIMGA.SPLY_ALLOC_PCT, 0) AS SPLY_ALLOC_PCT
            ,DM.MDL_ID
            ,MN.T_MDL_NM
            ,SAT.SVC_ALLOC_TP_NM
        FROM
             AJE_INV_MDL_GRP_ALLOC AIMGA
            ,DS_MDL_GRP DMG
            ,DS_MDL DM
            ,MDL_NM MN
            ,SVC_ALLOC_TP SAT
        WHERE
            AIMGA.GLBL_CMPY_CD = 'ADB'
        AND AIMGA.EZCANCELFLAG = '0'
        AND AIMGA.GLBL_CMPY_CD = DMG.GLBL_CMPY_CD
        AND AIMGA.MDL_GRP_ID = DMG.MDL_GRP_ID
        AND DMG.EZCANCELFLAG = '0'
        AND DMG.GLBL_CMPY_CD = DM.GLBL_CMPY_CD
        AND DMG.MDL_GRP_ID = DM.MDL_GRP_ID
        AND DM.EZCANCELFLAG = '0'
        AND DM.MDL_ACTV_FLG = 'N'
        AND DM.GLBL_CMPY_CD = MN.T_GLBL_CMPY_CD
        AND DM.MDL_ID = MN.T_MDL_ID
        AND MN.EZCANCELFLAG = '0'
        AND AIMGA.GLBL_CMPY_CD = SAT.GLBL_CMPY_CD
        AND AIMGA.SVC_ALLOC_TP_CD = SAT.SVC_ALLOC_TP_CD
        AND SAT.EZCANCELFLAG = '0'
        AND EXISTS(
            SELECT 1 
            FROM AJE_INV_LINE_ALLOC AILA
            WHERE AILA.GLBL_CMPY_CD = AIMGA.GLBL_CMPY_CD
            AND AILA.SVC_ALLOC_TP_CD = AIMGA.SVC_ALLOC_TP_CD
            AND AILA.SVC_INV_CHRG_TP_CD = AIMGA.SVC_INV_CHRG_TP_CD
            AND AILA.MDL_ID = DM.MDL_ID
            AND AILA.EZCANCELFLAG = '0'
        )
        UNION ALL
        SELECT
             '3' AS XX_MODE
            ,AIMGA.MDL_GRP_ID
            ,AIMGA.SVC_ALLOC_TP_CD
            ,AIMGA.SVC_INV_CHRG_TP_CD
            ,NVL(AIMGA.EQUIP_ALLOC_PCT, 0) AS EQUIP_ALLOC_PCT
            ,NVL(AIMGA.SVC_ALLOC_PCT, 0) AS SVC_ALLOC_PCT
            ,NVL(AIMGA.SPLY_ALLOC_PCT, 0) AS SPLY_ALLOC_PCT
            ,DM.MDL_ID
            ,MN.T_MDL_NM
            ,SAT.SVC_ALLOC_TP_NM
        FROM
             AJE_INV_MDL_GRP_ALLOC AIMGA
            ,DS_MDL_GRP DMG
            ,DS_MDL DM
            ,MDL_NM MN
            ,SVC_ALLOC_TP SAT
        WHERE
            AIMGA.GLBL_CMPY_CD = 'ADB'
        AND AIMGA.EZCANCELFLAG = '1'
        AND AIMGA.GLBL_CMPY_CD = DMG.GLBL_CMPY_CD
        AND AIMGA.MDL_GRP_ID = DMG.MDL_GRP_ID
        AND DMG.EZCANCELFLAG = '0'
        AND DMG.GLBL_CMPY_CD = DM.GLBL_CMPY_CD
        AND DMG.MDL_GRP_ID = DM.MDL_GRP_ID
        AND DM.EZCANCELFLAG = '0'
        AND DM.GLBL_CMPY_CD = MN.T_GLBL_CMPY_CD
        AND DM.MDL_ID = MN.T_MDL_ID
        AND MN.EZCANCELFLAG = '0'
        AND AIMGA.GLBL_CMPY_CD = SAT.GLBL_CMPY_CD
        AND AIMGA.SVC_ALLOC_TP_CD = SAT.SVC_ALLOC_TP_CD
        AND SAT.EZCANCELFLAG = '0'
        AND EXISTS(
            SELECT 1 
            FROM AJE_INV_LINE_ALLOC AILA
            WHERE AILA.GLBL_CMPY_CD = AIMGA.GLBL_CMPY_CD
            AND AILA.SVC_ALLOC_TP_CD = AIMGA.SVC_ALLOC_TP_CD
            AND AILA.SVC_INV_CHRG_TP_CD = AIMGA.SVC_INV_CHRG_TP_CD
            AND AILA.MDL_ID = DM.MDL_ID
            AND AILA.EZCANCELFLAG = '0'
        )
        ORDER BY XX_MODE, MDL_GRP_ID, SVC_ALLOC_TP_CD, SVC_INV_CHRG_TP_CD
    </statement>
    
    <statement id ="getAjeInvLineAllocCd" parameterClass="Map"  resultClass="String">
        SELECT 
            AILA.AJE_INV_LINE_ALLOC_CD
        FROM 
            AJE_INV_LINE_ALLOC AILA
        WHERE 
            AILA.EZCANCELFLAG = '0'
        AND AILA.GLBL_CMPY_CD = #glblCmpyCd#
        AND AILA.SVC_ALLOC_TP_CD = #svcAllocTpCd#
        AND AILA.MDL_ID = #mdlId#
        AND AILA.SVC_INV_CHRG_TP_CD = #svcInvChrgTpCd#
    </statement>
</sqlMap>