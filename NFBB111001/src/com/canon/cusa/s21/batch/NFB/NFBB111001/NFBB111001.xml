<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NFBB111001">

    <statement id="SELECT_AP_MAINT_TOL" parameterClass="Map">
        SELECT
            AP_MAINT_TOL_CD
        ,   AP_MAINT_INV_FROM_AMT
        ,   AP_MAINT_INV_TO_AMT
        ,   AP_MAINT_INV_BASE_FROM_RATE
        ,   AP_MAINT_INV_BASE_TO_RATE
        ,   AP_MAINT_INV_OVER_FROM_RATE
        ,   AP_MAINT_INV_OVER_TO_RATE
        ,   AP_MAINT_INV_FROM_CNT
        ,   AP_MAINT_INV_TO_CNT
        ,   AP_MAINT_INV_MTR_FROM_RATE
        ,   AP_MAINT_INV_MTR_TO_RATE
        ,   AP_MAINT_INV_MTH_TOL_CNT
        FROM
            AP_MAINT_TOL AMT
        WHERE
            AMT.GLBL_CMPY_CD        = #glblCmpyCd#
        AND AMT.AP_MAINT_TOL_CD     = #apMaintTolCd#
        AND AMT.EZCANCELFLAG        = '0'
    </statement>

    <statement id="SELECT_CM_MAINT_INV" parameterClass="Map">
        SELECT
            CMI.AP_INV_NUM
        ,   CMI.AP_VND_CD
        ,   CMIS.SER_NUM
        ,   CMIS.START_DT
        ,   CMIM.CNT_TP_CD
        ,   CMI.INV_DT
        ,   PV.PRNT_VND_NM
        ,   CMI.AP_INV_AMT
        ,   CMI.AP_MISC_AMT
        ,   CMI.AP_TAX_AMT
        ,   CMI.LATE_FEE_AMT
        ,   CMI.AP_ADJ_AMT
        ,   CMI.AP_MAINT_INV_STS_CD
        ,   CMIS.OVRD_SER_NUM
        ,   CMIS.BASE_AMT
        ,   CMIS.END_DT
        ,   CMIM.START_READ_MTR_CNT
        ,   CMIM.END_READ_MTR_CNT
        ,   CMIM.READ_MTR_CNT
        ,   CMIM.AP_TOL_AMT
        ,   CT.CNTR_TP_NM
        ,   CMI.VND_SITE_NM
        FROM
            CM_MAINT_INV     CMI
        ,   CM_MAINT_INV_SER CMIS
        ,   CM_MAINT_INV_MTR CMIM
        ,   CNTR_TP          CT
        ,   PO_VND_V         PV
        WHERE
            CMI.GLBL_CMPY_CD        = #glblCmpyCd#
        AND CMI.GLBL_CMPY_CD        = CMIS.GLBL_CMPY_CD
        AND CMI.AP_INV_NUM          = CMIS.AP_INV_NUM
        AND CMI.AP_VND_CD           = CMIS.AP_VND_CD
        AND CMI.AP_DS_WF_STS_CD     = #apDsWfStsCd#
        AND CMI.AP_MAINT_INV_STS_CD = #apMaintInvStsCd#
        AND CMI.EZCANCELFLAG        = '0'
        AND CMIS.EZCANCELFLAG       = '0'
        AND CMIS.GLBL_CMPY_CD       = CMIM.GLBL_CMPY_CD(+)
        AND CMIS.AP_INV_NUM         = CMIM.AP_INV_NUM(+)
        AND CMIS.AP_VND_CD          = CMIM.AP_VND_CD(+)
        AND CMIS.SER_NUM            = CMIM.SER_NUM(+)
        AND CMIS.START_DT           = CMIM.START_DT(+)
        AND '0'                     = CMIM.EZCANCELFLAG(+)
        AND CMIM.GLBL_CMPY_CD       = CT.GLBL_CMPY_CD(+)
        AND CMIM.CNT_TP_CD          = CT.CNTR_TP_CD(+)
        AND '0'                     = CT.EZCANCELFLAG(+)
        AND CMI.GLBL_CMPY_CD        = PV.GLBL_CMPY_CD(+)
        AND CMI.AP_VND_CD           = PV.PRNT_VND_CD(+)
        AND '0'                     = PV.EZCANCELFLAG(+)
        ORDER BY
            CMI.AP_INV_NUM
        ,   CMI.AP_VND_CD
        ,   CMIS.SER_NUM
        ,   CMIS.START_DT
        ,   CMIM.CNT_TP_CD
    </statement>

    <statement id="SELECT_CONTR_FROM_SER_NUM" parameterClass="Map" resultClass="Map">
        SELECT
            DSC.BASE_PRC_DEAL_AMT
        ,   DSC.BW_MTR_ALWNC_CNT
        ,   DSC.BW_MTR_PRC_AMT_RATE
        ,   DSC.COLOR_MTR_ALWNC_CNT
        ,   DSC.COLOR_MTR_PRC_AMT_RATE
        ,   DC.CONTR_ADMIN_PSN_CD
        ,   AP.EML_ADDR
        ,   AP.LANG_CD
        ,   AP.CTRY_CD
        ,   AP.FIRST_NM
        ,   AP.MID_NM
        ,   AP.LAST_NM
        FROM
            SVC_MACH_MSTR   SMM
        ,   DS_CONTR        DC
        ,   DS_CONTR_DTL    DCD
        ,   DS_CONTR_DTL_TP DCDT
        ,   DS_SUB_CONTR    DSC
        ,   AUTH_PSN        AP
        WHERE
            SMM.GLBL_CMPY_CD         =  #glblCmpyCd#
        AND SMM.GLBL_CMPY_CD         =  DC.GLBL_CMPY_CD
        AND SMM.GLBL_CMPY_CD         =  DCD.GLBL_CMPY_CD
        AND SMM.GLBL_CMPY_CD         =  DCDT.GLBL_CMPY_CD
        AND SMM.GLBL_CMPY_CD         =  DSC.GLBL_CMPY_CD
        AND DC.GLBL_CMPY_CD          =  DCD.GLBL_CMPY_CD
        AND DC.GLBL_CMPY_CD          =  DCDT.GLBL_CMPY_CD
        AND DC.GLBL_CMPY_CD          =  DSC.GLBL_CMPY_CD
        AND DCD.GLBL_CMPY_CD         =  DCDT.GLBL_CMPY_CD
        AND DCD.GLBL_CMPY_CD         =  DSC.GLBL_CMPY_CD
        AND DCDT.GLBL_CMPY_CD        =  DSC.GLBL_CMPY_CD
        AND SMM.SVC_MACH_MSTR_PK     =  DCD.SVC_MACH_MSTR_PK
        AND DC.DS_CONTR_PK           =  DCD.DS_CONTR_PK
        AND DCD.DS_CONTR_DTL_PK      =  DSC.DS_CONTR_DTL_PK
        AND DCD.DS_CONTR_DTL_TP_CD   =  DCDT.DS_CONTR_DTL_TP_CD
        AND SMM.SER_NUM              =  #serNum#
        AND SMM.SVC_MACH_MSTR_STS_CD IN (#svcMachMstrStsCd_W4I#,#svcMachMstrStsCd_INSTL#)
        AND DCD.DS_CONTR_DTL_STS_CD  =  #dsContrDtlStsCd_ACTV#
        AND DCDT.BASE_CHRG_FLG       =  #flg_Y#
        AND DSC.CONTR_TRMN_FLG       =  #flg_N#
        AND DSC.EFF_FROM_DT      &lt;=  #procDt#
        AND DSC.EFF_THRU_DT      &gt;=  #procDt#
        AND SMM.EZCANCELFLAG         = '0'
        AND DC.EZCANCELFLAG          = '0'
        AND DCD.EZCANCELFLAG         = '0'
        AND DCDT.EZCANCELFLAG        = '0'
        AND DSC.EZCANCELFLAG         = '0'
        AND DC.GLBL_CMPY_CD          = AP.GLBL_CMPY_CD(+)
        AND DC.CONTR_ADMIN_PSN_CD    = AP.USR_NM(+)
        AND '0'                      = AP.EZCANCELFLAG(+)
        ORDER BY
            DSC.EFF_FROM_DT DESC
    </statement>

    <statement id="SELECT_AVG_COPY_QTY_BY_READ_DT" parameterClass="Map" resultClass="Map">
        SELECT
            SILM.MTR_READ_DT                   MTR_READ_DT
        ,   SUM(SILM.BLLG_COPY_QTY) / COUNT(*) AVG_COPY_QTY
        FROM
            SVC_MACH_MSTR    SMM
        ,   DS_CONTR_DTL     DCD
        ,   DS_CONTR_DTL_TP  DCDT
        ,   DS_SUB_CONTR     DSC
        ,   SVC_INV          SI
        ,   SVC_INV_LINE     SIL
        ,   SVC_INV_LINE_MTR SILM
        WHERE
            SMM.GLBL_CMPY_CD         =  #glblCmpyCd#
        AND SMM.GLBL_CMPY_CD         =  SIL.GLBL_CMPY_CD
        AND SMM.SVC_MACH_MSTR_PK     =  SIL.SVC_MACH_MSTR_PK
        AND SIL.GLBL_CMPY_CD         =  SI.GLBL_CMPY_CD
        AND SIL.SVC_INV_NUM          =  SI.SVC_INV_NUM
        AND SIL.GLBL_CMPY_CD         =  SILM.GLBL_CMPY_CD
        AND SIL.SVC_INV_LINE_PK      =  SILM.SVC_INV_LINE_PK
        AND SIL.GLBL_CMPY_CD         =  DCD.GLBL_CMPY_CD
        AND SIL.SVC_MACH_MSTR_PK     =  DCD.SVC_MACH_MSTR_PK
        AND SIL.DS_CONTR_DTL_PK      =  DCD.DS_CONTR_DTL_PK
        AND DCD.GLBL_CMPY_CD         =  DSC.GLBL_CMPY_CD
        AND DCD.DS_CONTR_DTL_PK      =  DSC.DS_CONTR_DTL_PK
        AND DCD.GLBL_CMPY_CD         =  DCDT.GLBL_CMPY_CD
        AND DCD.DS_CONTR_DTL_TP_CD   =  DCDT.DS_CONTR_DTL_TP_CD
        AND SMM.SER_NUM              =  #serNum#
        AND SMM.SVC_MACH_MSTR_STS_CD IN (#svcMachMstrStsCd_W4I#,#svcMachMstrStsCd_INSTL#)
        AND DCD.DS_CONTR_DTL_STS_CD  =  #dsContrDtlStsCd_ACTV#
        AND DCDT.BASE_CHRG_FLG       =  #flg_Y#
        AND DSC.CONTR_TRMN_FLG       =  #flg_N#
        AND DSC.EFF_FROM_DT      &lt;=  #procDt#
        AND (DSC.EFF_THRU_DT     &gt;=  #procDt# OR DSC.EFF_THRU_DT IS NULL)
        AND SIL.SVC_INV_CHRG_TP_CD   =  #svcInvChrgTpCd_MC#
        AND SMM.EZCANCELFLAG         = '0'
        AND DCD.EZCANCELFLAG         = '0'
        AND DCDT.EZCANCELFLAG        = '0'
        AND DSC.EZCANCELFLAG         = '0'
        AND SI.EZCANCELFLAG          = '0'
        AND SIL.EZCANCELFLAG         = '0'
        AND SILM.EZCANCELFLAG        = '0'
        GROUP BY
            SILM.MTR_READ_DT
        ORDER BY
            SILM.MTR_READ_DT DESC
    </statement>

    <statement id="SELECT_SVC_PHYS_MTR_READ" parameterClass="Map" resultClass="Map">
        SELECT
            MTR_READ_DT                                                        MTR_READ_DT
        ,   ABS(TO_DATE(#endDt#,#yyyymmdd#) - TO_DATE(MTR_READ_DT,#yyyymmdd#)) DAY_CNT
        ,   TO_DATE(#endDt#,#yyyymmdd#) - TO_DATE(MTR_READ_DT,#yyyymmdd#)      DAY_DIFF
        ,   READ_MTR_CNT                                                       READ_MTR_CNT
        FROM
            (
                SELECT
                    SPMR.MTR_READ_DT       MTR_READ_DT
                ,   SPMR.SVC_PHYS_MTR_READ_GRP_SQ
                ,   SUM(SPMR.READ_MTR_CNT) READ_MTR_CNT
                FROM
                    SVC_MACH_MSTR     SMM
                ,   SVC_PHYS_MTR      SPM
                ,   SVC_PHYS_MTR_READ SPMR
                ,   MTR_LB            ML
                WHERE
                    SMM.GLBL_CMPY_CD     = #glblCmpyCd#
                AND SMM.GLBL_CMPY_CD     = SPM.GLBL_CMPY_CD
                AND SMM.GLBL_CMPY_CD     = SPMR.GLBL_CMPY_CD
                AND SMM.GLBL_CMPY_CD     = ML.GLBL_CMPY_CD
                AND SPM.GLBL_CMPY_CD     = SPMR.GLBL_CMPY_CD
                AND SPM.GLBL_CMPY_CD     = ML.GLBL_CMPY_CD
                AND SPMR.GLBL_CMPY_CD    = ML.GLBL_CMPY_CD
                AND SMM.SER_NUM          = #serNum#
                AND SMM.SVC_MACH_MSTR_STS_CD IN (#svcMachMstrStsCd_W4I#,#svcMachMstrStsCd_INSTL#)
                AND SMM.SVC_MACH_MSTR_PK = SPM.SVC_MACH_MSTR_PK
                AND SMM.SVC_MACH_MSTR_PK = SPMR.SVC_MACH_MSTR_PK
                AND SPM.SVC_MACH_MSTR_PK = SPMR.SVC_MACH_MSTR_PK
                AND SPM.DS_MDL_MTR_PK    = SPMR.DS_MDL_MTR_PK
                AND SPM.SVC_PHYS_MTR_PK  = SPMR.SVC_PHYS_MTR_PK
                AND SPMR.MTR_LB_CD       = ML.MTR_LB_CD
                <!-- START 2018/10/17 [QC#28592,ADD] -->
                AND SPMR.VLD_MTR_FLG     = 'Y'
                <!-- START 2018/10/17 [QC#28592,ADD] -->
                <isEqual property="cntrTpCd" compareValue="BW">
                AND ML.BW_MTR_FLG        = #flg_Y#
                AND ML.COLOR_MTR_FLG     = #flg_N#
                </isEqual>
                <isEqual property="cntrTpCd" compareValue="CLR">
                AND ML.BW_MTR_FLG        = #flg_N#
                AND ML.COLOR_MTR_FLG     = #flg_Y#
                </isEqual>
                AND SMM.EZCANCELFLAG     = '0'
                AND SPM.EZCANCELFLAG     = '0'
                AND SPMR.EZCANCELFLAG    = '0'
                AND ML.EZCANCELFLAG      = '0'
                GROUP BY
                     SPMR.MTR_READ_DT
                    ,SPMR.SVC_PHYS_MTR_READ_GRP_SQ
            )
        ORDER BY
             ABS(TO_DATE(#endDt#,#yyyymmdd#) - TO_DATE(MTR_READ_DT,#yyyymmdd#))
            ,SVC_PHYS_MTR_READ_GRP_SQ DESC
    </statement>

    <statement id="SELECT_SVC_AVG_MTR_READ_CNT" parameterClass="Map" resultClass="Map">
        SELECT
            NVL(AVG(SABS.AVG_MTR_READ_CNT),0) AVG_MTR_READ_CNT
        FROM
             SVC_ADCV_BY_SER SABS
            ,MTR_LB          ML
        WHERE
            SABS.GLBL_CMPY_CD = #glblCmpyCd#
        AND SABS.SER_NUM      = #serNum#
        AND SABS.GLBL_CMPY_CD = ML.GLBL_CMPY_CD
        AND SABS.MTR_LB_CD    = ML.MTR_LB_CD
        <isEqual property="cntrTpCd" compareValue="BW">
        AND ML.BW_MTR_FLG        = #flg_Y#
        AND ML.COLOR_MTR_FLG     = #flg_N#
        </isEqual>
        <isEqual property="cntrTpCd" compareValue="CLR">
        AND ML.BW_MTR_FLG        = #flg_N#
        AND ML.COLOR_MTR_FLG     = #flg_Y#
        </isEqual>
        AND SABS.EZCANCELFLAG = '0'
        AND ML.EZCANCELFLAG   = '0'
        GROUP BY
            SABS.SER_NUM
    </statement>

    <statement id="countSerNum" parameterClass="Map" resultClass="Integer">
        
        SELECT
            COUNT(1)
        FROM 
            DS_SUB_CONTR DSC
           ,DS_CONTR_DTL DCD
           ,SVC_MACH_MSTR SMM
           ,VND V
        WHERE 
            DSC.GLBL_CMPY_CD     = #glblCmpyCd#
        AND (DSC.EFF_THRU_DT &gt;= #batchDt# OR DSC.EFF_THRU_DT IS NULL )
        AND DSC.EZCANCELFLAG     = '0'
        
        AND DSC.GLBL_CMPY_CD     = DCD.GLBL_CMPY_CD
        AND DSC.DS_CONTR_DTL_PK  = DCD.DS_CONTR_DTL_PK
        AND DCD.EZCANCELFLAG     = '0'
        
        AND DCD.GLBL_CMPY_CD     = SMM.GLBL_CMPY_CD
        AND DCD.SVC_MACH_MSTR_PK = SMM.SVC_MACH_MSTR_PK
        AND SMM.SER_NUM          = #serNum#
        AND SMM.EZCANCELFLAG     = '0'
        
        AND DSC.GLBL_CMPY_CD    = V.GLBL_CMPY_CD
        AND DSC.VND_CD          = V.VND_CD
        AND V.LOC_NM            = #locNm#
        AND V.EZCANCELFLAG      = '0'
    </statement>

</sqlMap>
