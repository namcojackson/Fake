<?xml version="1.0" encoding="UTF-8"?>

<sqlMap namespace="NLAL2040Query">
    <typeAlias alias="NLAL2040CMsg" type="business.blap.NLAL2040.NLAL2040CMsg" />
    <typeAlias alias="NLAL2040SMsg" type="business.blap.NLAL2040.NLAL2040SMsg" />
    <typeAlias alias="NLAL2040_ASMsg" type="business.blap.NLAL2040.NLAL2040_ASMsg" />

    <statement id="getRtlWhCatgSwPulldownList" parameterClass="Map"
        resultClass="String">
        SELECT
            RS.RTL_SWH_CD
        FROM
            RTL_WH_CATG_SWH_RELN    RS
        WHERE
                RS.GLBL_CMPY_CD    = #GLBL_CMPY_CD#
            AND RS.RTL_WH_CATG_CD  = #RTL_WH_CATG_CD#
            AND RS.EZCANCELFLAG    = '0'
        ORDER BY
            RS.RTL_SWH_SORT_NUM NULLS LAST
    </statement>


    <statement id="search" parameterClass="Map"
        resultMap="result.NLAL2040_ASMsg">
        SELECT
             MAIN.EFF_FROM_DT
            ,MAIN.EFF_THRU_DT
            ,MAIN.T_MDL_NM
            ,MAIN.SVC_SEG_DESC_TXT
            ,MAIN.COA_MDSE_TP_CD
            ,MAIN.COA_PROD_CD
            ,MAIN.FROM_MTR_CNT
            ,MAIN.TO_MTR_CNT
            ,MAIN.FROM_ELPS_MTH_AOT
            ,MAIN.TO_ELPS_MTH_AOT
            ,MAIN.DEST_RTL_SWH_CD
            ,MAIN.THIRD_PTY_DSP_TP_CD
            ,MAIN.THIRD_PTY_DSP_TP_NM
            ,MAIN.MDL_ID
            ,MAIN.SQ_ID
            ,MAIN.MTR_REQ_MDL_FLG
            ,MAIN.EZUPTIME
            ,MAIN.EZUPTIMEZONE
            ,MAIN.INVTY_OWNR_CD
            ,MAIN.INVTY_OWNR_DESC_TXT
        FROM (
            SELECT DISTINCT
                 DSBM.EFF_FROM_DT
                ,DSBM.EFF_THRU_DT
                ,MDLN.T_MDL_NM
                ,SVCS.SVC_SEG_DESC_TXT
                ,MDSE.COA_MDSE_TP_CD
                ,MDSE.COA_PROD_CD
                ,DSBM.FROM_MTR_CNT
                ,DSBM.TO_MTR_CNT
                ,DSBM.FROM_ELPS_MTH_AOT
                ,DSBM.TO_ELPS_MTH_AOT
                ,DSBM.DEST_RTL_SWH_CD
                ,DSBM.THIRD_PTY_DSP_TP_CD
                ,TPDT.THIRD_PTY_DSP_TP_NM
                ,DSBM.MDL_ID
                ,DSBM.SQ_ID
                ,DMDL.MTR_REQ_MDL_FLG
                ,DSBM.EZUPTIME
                ,DSBM.EZUPTIMEZONE
                ,DSBM.INVTY_OWNR_CD
                ,IO.INVTY_OWNR_DESC_TXT
            FROM
                 DEF_SWH_BY_MDL                       DSBM
                ,DS_MDL                               DMDL
                ,MDL_NM                               MDLN
                ,ALL_MDSE_V                           MDSE
                ,SVC_SEG                              SVCS
                ,THIRD_PTY_DSP_TP                     TPDT
                ,INVTY_OWNR                           IO
                ,(SELECT
                      PRNT_MDSE_CD
                     ,MDL_ID
                  FROM
                     (SELECT
                          PRNT_MDSE_CD
                         ,MDL_ID
                         ,ROW_NUMBER() OVER(PARTITION BY MDL_ID ORDER BY PRNT_MDSE_CD) ROW_NUM
                      FROM
                          DS_MDL_CONFIG
                      WHERE
                          GLBL_CMPY_CD     = #GLBL_CMPY_CD#
                      AND DS_MDL_CONFIG_PK = PRNT_CONFIG_PK
                      AND EZCANCELFLAG     = '0')
                  WHERE ROW_NUM = 1)    MCON
            WHERE
                 DSBM.GLBL_CMPY_CD                    = #GLBL_CMPY_CD#
            <isNotNull property="EFF_FROM_DT">
                AND  DSBM.EFF_FROM_DT                     &gt;= #EFF_FROM_DT#
            </isNotNull>
            <isNotNull property="EFF_THRU_DT">
                AND  NVL(DSBM.EFF_THRU_DT, '99991231')    &lt;= #EFF_THRU_DT#
            </isNotNull>
            <isNotNull property="SALES_DATE">
                AND  DSBM.EFF_FROM_DT                     &lt;= #SALES_DATE#
                AND  NVL(DSBM.EFF_THRU_DT, '99991231')    &gt;= #SALES_DATE#
            </isNotNull>
            AND  DSBM.GLBL_CMPY_CD                    = DMDL.GLBL_CMPY_CD
            AND  DSBM.MDL_ID                          = DMDL.MDL_ID
            <isNotNull property="SVC_SEG_CD">
                AND  DMDL.SVC_SEG_CD                      = #SVC_SEG_CD#
            </isNotNull>
            AND  DMDL.GLBL_CMPY_CD                    = MDLN.T_GLBL_CMPY_CD
            AND  DMDL.MDL_ID                          = MDLN.T_MDL_ID
            <isNotNull property="T_MDL_NM">
                AND  MDLN.T_MDL_NM                        LIKE #T_MDL_NM#
            </isNotNull>
            AND  DMDL.MDL_ID                          = MCON.MDL_ID(+)
            AND  MCON.PRNT_MDSE_CD                    = MDSE.MDSE_CD(+)
            <isNotNull property="COA_PROD_CD">
                AND  MDSE.COA_PROD_CD                  = #COA_PROD_CD#
            </isNotNull>
            <isNotNull property="COA_MDSE_TP_CD">
                AND  MDSE.COA_MDSE_TP_CD               = #COA_MDSE_TP_CD#
            </isNotNull>
            AND  DMDL.GLBL_CMPY_CD                    = SVCS.GLBL_CMPY_CD(+)
            AND  DMDL.SVC_SEG_CD                      = SVCS.SVC_SEG_CD(+)
            AND  DSBM.GLBL_CMPY_CD                    = TPDT.GLBL_CMPY_CD(+)
            AND  DSBM.THIRD_PTY_DSP_TP_CD             = TPDT.THIRD_PTY_DSP_TP_CD(+)
            AND  DSBM.GLBL_CMPY_CD                    = IO.GLBL_CMPY_CD(+)
            AND  DSBM.INVTY_OWNR_CD                   = IO.INVTY_OWNR_CD(+)
            AND  DSBM.EZCANCELFLAG     = '0'
            AND  DMDL.EZCANCELFLAG     = '0'
            AND  MDLN.EZCANCELFLAG     = '0'
            AND  MDSE.EZCANCELFLAG(+)  = '0'
            AND  SVCS.EZCANCELFLAG(+)  = '0'
            AND  TPDT.EZCANCELFLAG(+)  = '0'
            AND  IO.EZCANCELFLAG(+)    = '0'
            ORDER BY
                 DSBM.MDL_ID
                ,DSBM.INVTY_OWNR_CD
                ,DSBM.FROM_MTR_CNT
                ,DSBM.TO_MTR_CNT
                ,DSBM.FROM_ELPS_MTH_AOT
                ,DSBM.TO_ELPS_MTH_AOT
                ,DSBM.SQ_ID
        ) MAIN
        WHERE ROWNUM &lt;= #ROWNUM#
    </statement>


    <resultMap id="result.NLAL2040_ASMsg" class="NLAL2040_ASMsg">
        <result property="effFromDt_A1"          column="EFF_FROM_DT"          javaType="EZDSStringItem"/>
        <result property="effThruDt_A1"          column="EFF_THRU_DT"          javaType="EZDSStringItem"/>
        <result property="t_MdlNm_A1"            column="T_MDL_NM"             javaType="EZDSStringItem"/>
        <result property="svcSegDescTxt_A1"      column="SVC_SEG_DESC_TXT"     javaType="EZDSStringItem"/>
        <result property="coaMdseTpCd_A1"        column="COA_MDSE_TP_CD"       javaType="EZDSStringItem"/>
        <result property="coaProdCd_A1"          column="COA_PROD_CD"          javaType="EZDSStringItem"/>
        <result property="fromMtrCnt_A1"         column="FROM_MTR_CNT"         javaType="EZDSBigDecimalItem"/>
        <result property="toMtrCnt_A1"           column="TO_MTR_CNT"           javaType="EZDSBigDecimalItem"/>
        <result property="fromElpsMthAot_A1"     column="FROM_ELPS_MTH_AOT"    javaType="EZDSBigDecimalItem"/>
        <result property="toElpsMthAot_A1"       column="TO_ELPS_MTH_AOT"      javaType="EZDSBigDecimalItem"/>
        <result property="rtlSwhCd_AS"           column="DEST_RTL_SWH_CD"      javaType="EZDSStringItem"/>
        <result property="thirdPtyDspTpCd_AS"    column="THIRD_PTY_DSP_TP_CD"  javaType="EZDSStringItem"/>
        <result property="mdlId_A1"              column="MDL_ID"               javaType="EZDSBigDecimalItem"/>
        <result property="sqId_A1"               column="SQ_ID"                javaType="EZDSStringItem"/>
        <result property="mtrReqMdlFlg_A1"       column="MTR_REQ_MDL_FLG"      javaType="EZDSStringItem"/>
        <result property="xxRqstTs_A1"           column="EZUPTIME"             javaType="EZDSStringItem"/>
        <result property="xxRqstTz_A1"           column="EZUPTIMEZONE"         javaType="EZDSStringItem"/>
        <result property="invtyOwnrCd_AS"        column="INVTY_OWNR_CD"        javaType="EZDSStringItem"/>
    </resultMap>


    <statement id="checkModelExist" parameterClass="Map"
        resultClass="Map">
        SELECT
            DMDL.MDL_ID
           ,DMDL.MTR_REQ_MDL_FLG
        FROM
            DS_MDL         DMDL
           ,MDL_NM         MDLN
        WHERE
            MDLN.T_GLBL_CMPY_CD   = #GLBL_CMPY_CD#
        AND MDLN.T_MDL_NM         = #T_MDL_NM#
        AND MDLN.T_GLBL_CMPY_CD   = DMDL.GLBL_CMPY_CD
        AND MDLN.T_MDL_ID         = DMDL.MDL_ID
        AND MDLN.EZCANCELFLAG     = '0'
        AND DMDL.EZCANCELFLAG     = '0'
    </statement>


    <statement id="getSwfByMdl" parameterClass="Map"
        resultClass="Map">
        SELECT
            SW.EFF_FROM_DT
           ,SW.EFF_THRU_DT
           ,SW.FROM_MTR_CNT
           ,SW.TO_MTR_CNT
           ,SW.FROM_ELPS_MTH_AOT
           ,SW.TO_ELPS_MTH_AOT
           ,SW.INVTY_OWNR_CD
        FROM
            DEF_SWH_BY_MDL    SW
        WHERE
             SW.GLBL_CMPY_CD                  = #GLBL_CMPY_CD#
        AND  SW.MDL_ID                        = #MDL_ID#
        <iterate property="SQ_ID" var="SQ_ID[]" open="AND SW.SQ_ID NOT IN (" close=")" conjunction=",">
            #SQ_ID[]#
        </iterate>
        AND  NVL(SW.EFF_THRU_DT, '99991231')  &gt;= #EFF_THRU_DT#
        AND  SW.EZCANCELFLAG                  = '0'
    </statement>


    <statement id="getNewSqId" parameterClass="Map"
        resultClass="String">
        SELECT
            NVL(TO_CHAR(MAX(TO_NUMBER(SW.SQ_ID))+1),'1') SQ_ID
        FROM
            DEF_SWH_BY_MDL    SW
        WHERE
            SW.GLBL_CMPY_CD     = #GLBL_CMPY_CD#
        AND SW.MDL_ID           = #MDL_ID#
    </statement>


    <statement id="getInvtyOwnerCd" parameterClass="Map"
        resultClass="String">
        SELECT
            IO.INVTY_OWNR_CD
        FROM
            INVTY_OWNR IO
        WHERE
            IO.GLBL_CMPY_CD = #GLBL_CMPY_CD#
        AND UPPER(IO.INVTY_OWNR_DESC_TXT) = UPPER(#INVTY_OWNR_DESC_TXT#)
        AND IO.EZCANCELFLAG = '0'
    </statement>


    <statement id="getThirdPtyDspTpCd" parameterClass="Map"
        resultClass="String">
        SELECT
            TP.THIRD_PTY_DSP_TP_CD
        FROM
            THIRD_PTY_DSP_TP    TP
        WHERE
            TP.GLBL_CMPY_CD                = #GLBL_CMPY_CD#
        AND UPPER(TP.THIRD_PTY_DSP_TP_NM)  = UPPER(#THIRD_PTY_DSP_TP_NM#)
        AND TP.EZCANCELFLAG                = '0'
    </statement>


    <statement id="getMtrReqMdlFlg" parameterClass="Map"
        resultClass="String">
        SELECT
            MD.MTR_REQ_MDL_FLG
        FROM
            DS_MDL    MD
        WHERE
            MD.GLBL_CMPY_CD  = #GLBL_CMPY_CD#
        AND MD.MDL_ID        = #MDL_ID#
        AND MD.EZCANCELFLAG  = '0'
    </statement>

    <statement id="getOwnerCdPulldownList" parameterClass="Map"
        resultClass="Map">
        SELECT
            IO.INVTY_OWNR_CD
           ,IO.INVTY_OWNR_DESC_TXT
        FROM
            INVTY_OWNR IO
        WHERE
            IO.GLBL_CMPY_CD = #GLBL_CMPY_CD#
        AND IO.EZCANCELFLAG = '0'
        ORDER BY
            IO.INVTY_OWNR_SORT_NUM NULLS LAST
    </statement>

    <statement id="checkFromZeroForMeter" parameterClass="Map"
        resultClass="Integer">
        SELECT
            COUNT(*) CNT
        FROM
            DEF_SWH_BY_MDL DSM
        WHERE
            DSM.GLBL_CMPY_CD  = #GLBL_CMPY_CD#
        AND DSM.EZCANCELFLAG  = '0'
        AND DSM.MDL_ID        = #MDL_ID#
        <isNotNull property="INVTY_OWNR_CD">
        AND DSM.INVTY_OWNR_CD = #INVTY_OWNR_CD#
        </isNotNull>
        <isNull property="INVTY_OWNR_CD">
        AND DSM.INVTY_OWNR_CD IS NULL
        </isNull>
        AND DSM.FROM_MTR_CNT  = 0
    </statement>

    <statement id="checkFromZeroForAge" parameterClass="Map"
        resultClass="Integer">
        SELECT
            COUNT(*) CNT
        FROM
            DEF_SWH_BY_MDL DSM
        WHERE
            DSM.GLBL_CMPY_CD       = #GLBL_CMPY_CD#
        AND DSM.EZCANCELFLAG       = '0'
        AND DSM.MDL_ID             = #MDL_ID#
        <isNotNull property="INVTY_OWNR_CD">
        AND DSM.INVTY_OWNR_CD = #INVTY_OWNR_CD#
        </isNotNull>
        <isNull property="INVTY_OWNR_CD">
        AND DSM.INVTY_OWNR_CD IS NULL
        </isNull>
        AND DSM.FROM_ELPS_MTH_AOT  = 0
    </statement>

</sqlMap>