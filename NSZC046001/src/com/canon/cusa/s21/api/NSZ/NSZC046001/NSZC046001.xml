<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NSZC046001">
<statement id="getChargeFlg" parameterClass="Map" resultClass="Map">
SELECT
     B.BASE_CHRG_FLG            AS BASE_CHRG_FLG
    ,B.USG_CHRG_FLG             AS USG_CHRG_FLG
FROM 
     DS_CONTR_DTL        A
    ,DS_CONTR_DTL_TP     B
WHERE
        A.GLBL_CMPY_CD       = #glblCmpyCd#
    AND A.DS_CONTR_DTL_PK    = #dContrDtlPk#
    AND A.EZCANCELFLAG       = '0'
    AND A.GLBL_CMPY_CD       = B.GLBL_CMPY_CD
    AND A.DS_CONTR_DTL_TP_CD = B.DS_CONTR_DTL_TP_CD
    AND B.EZCANCELFLAG       = '0'
</statement>
    <statement id="getMachMstrByAcc" parameterClass="Map" resultClass="java.math.BigDecimal">
        SELECT
            MACH.SVC_MACH_MSTR_PK
        FROM
            SVC_MACH_MSTR ACC
            ,SVC_MACH_MSTR MACH
        WHERE
                ACC.GLBL_CMPY_CD        = #glblCmpyCd#
            AND ACC.EZCANCELFLAG        = '0'
            AND ACC.SVC_MACH_MSTR_PK    = #svcMachMstrPk#
            AND ACC.GLBL_CMPY_CD        = MACH.GLBL_CMPY_CD
            AND MACH.EZCANCELFLAG       = '0'
            AND ACC.SVC_CONFIG_MSTR_PK  = MACH.SVC_CONFIG_MSTR_PK
            AND MACH.SVC_MACH_TP_CD     = #machine#
    </statement>
    <statement id="getEffectiveDsContrDtl" parameterClass="Map" resultClass="java.math.BigDecimal">
        SELECT
            A.DS_CONTR_DTL_PK
        FROM
            DS_CONTR_DTL A
            ,DS_CONTR_DTL_STS_V B
        WHERE
            A.GLBL_CMPY_CD          = #glblCmpyCd#
        AND A.EZCANCELFLAG          = '0'
        AND A.DS_CONTR_PK           = #dsContrPk#
        AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
        AND B.EZCANCELFLAG          = '0'
        AND A.DS_CONTR_DTL_PK       = B.DS_CONTR_DTL_PK
        <!-- START 2019/05/15 K.Fujimoto [QC#50279, MOD] -->
        <!-- AND B.DS_CONTR_CTRL_STS_CD  NOT IN (#cancelled#,#terminated#,#expired#) -->
        AND B.DS_CONTR_CTRL_STS_CD  NOT IN (#cancelled#,#terminated#,#expired#,#terminatedHold#)
        <!-- END   2019/05/15 K.Fujimoto [QC#50279, MOD] -->
    </statement>
    <statement id="getMaxContrDtlEffThruDt" parameterClass="Map" resultClass="String">
        SELECT
            MAX(A.CONTR_EFF_THRU_DT) CONTR_EFF_THRU_DT
        FROM
            DS_CONTR_DTL A
            ,DS_CONTR_DTL_STS_V B
        WHERE
            A.GLBL_CMPY_CD          = #glblCmpyCd#
        AND A.EZCANCELFLAG          = '0'
        AND A.DS_CONTR_PK           = #dsContrPk#
        AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
        AND B.EZCANCELFLAG          = '0'
        AND A.DS_CONTR_DTL_PK       = B.DS_CONTR_DTL_PK
        <!-- START 2019/05/15 K.Fujimoto [QC#50279, MOD] -->
        <!-- AND B.DS_CONTR_CTRL_STS_CD  NOT IN (#cancelled#,#terminated#,#expired#) -->
        AND B.DS_CONTR_CTRL_STS_CD  NOT IN (#cancelled#,#terminated#,#expired#,#terminatedHold#)
        <!-- END   2019/05/15 K.Fujimoto [QC#50279, MOD] -->
    </statement>
    <statement id="getBaseBillToAndAcct" parameterClass="Map" resultClass="Map">
        SELECT
            A.BASE_BILL_TO_CUST_CD  AS BILL_TO_CUST_CD
            ,B.DS_ACCT_NUM          AS DS_ACCT_NUM
        FROM
            DS_CONTR_DTL A
            ,DS_CONTR B
        WHERE
            A.GLBL_CMPY_CD          = #glblCmpyCd#
        AND A.EZCANCELFLAG          = '0'
        AND A.DS_CONTR_DTL_PK       = #dsContrDtlPk#
        AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
        AND B.EZCANCELFLAG          = '0'
        AND A.DS_CONTR_PK           = B.DS_CONTR_PK
    </statement>
    <statement id="getUsgBillToAndAcct" parameterClass="Map" resultClass="Map">
        SELECT
            A.BLLG_MTR_BILL_TO_CUST_CD  AS BILL_TO_CUST_CD
            ,C.DS_ACCT_NUM              AS DS_ACCT_NUM
        FROM
            DS_CONTR_BLLG_MTR A
            ,DS_CONTR_DTL B
            ,DS_CONTR C
        WHERE
            A.GLBL_CMPY_CD          = #glblCmpyCd#
        AND A.EZCANCELFLAG          = '0'
        AND A.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
        AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
        AND B.EZCANCELFLAG          = '0'
        AND A.DS_CONTR_DTL_PK       = B.DS_CONTR_DTL_PK
        AND B.GLBL_CMPY_CD          = C.GLBL_CMPY_CD
        AND B.EZCANCELFLAG          = '0'
        AND B.DS_CONTR_PK           = C.DS_CONTR_PK
    </statement>
    <!-- START 2017/10/05 M.Kidokoro [QC#21544, DEL] -->
    <!-- <statement id="getDsContrCrCard" parameterClass="Map" resultClass="String"> -->
        <!-- SELECT -->
        <!--     A.PO_DT -->
        <!-- FROM -->
        <!--     DS_CONTR_CR_CARD_PO A -->
        <!-- WHERE -->
        <!--         A.GLBL_CMPY_CD          = #glblCmpyCd# -->
        <!--     AND A.EZCANCELFLAG          = '0' -->
        <!--     AND A.DS_CONTR_PK           = #dsContrPk# -->
        <!--     <isNotNull property="dsContrDtlPk"> -->
        <!--     AND A.DS_CONTR_DTL_PK       = #dsContrDtlPk# -->
        <!--     </isNotNull> -->
        <!--     <isNotNull property="dsContrBllgMtrPk"> -->
        <!--     AND A.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk# -->
        <!--     </isNotNull> -->
        <!-- ORDER BY -->
        <!--     A.DS_CONTR_MACH_LVL_NUM DESC -->
    <!-- </statement> -->
    <!-- END 2017/10/05 M.Kidokoro [QC#21544, DEL] -->
    <!-- START 2017/10/05 M.Kidokoro [QC#21544, ADD] -->
    <statement id="getPoDtListForBase" parameterClass="Map" resultClass="String">
        <!-- START 2017/12/26 K.Kojima [QC#23260, ADD] -->
        SELECT
            PO_DT
        FROM
            (
        <!-- END 2017/12/26 K.Kojima [QC#23260, ADD] -->
        SELECT
            NVL(NVL(DCCCPB.PO_DT, DCCCPD.PO_DT), DCCCPH.PO_DT) AS PO_DT
        FROM
             DS_CONTR_DTL        DCD
            ,DS_CONTR_CR_CARD_PO DCCCPH
            ,DS_CONTR_CR_CARD_PO DCCCPD
            ,DS_CONTR_CR_CARD_PO DCCCPB
        WHERE
                DCD.GLBL_CMPY_CD                = #glblCmpyCd#
            AND DCD.DS_CONTR_PK                 = #dsContrPk#
            AND DCD.DS_CONTR_DTL_PK             = #dsContrDtlPk#
            AND DCD.EZCANCELFLAG                = '0'
            AND DCD.GLBL_CMPY_CD                = DCCCPH.GLBL_CMPY_CD(+)
            AND DCD.DS_CONTR_PK                 = DCCCPH.DS_CONTR_PK(+)
            AND DCCCPH.DS_CONTR_MACH_LVL_NUM(+) = #dsContrMachLvlNum1#
            AND DCCCPH.EZCANCELFLAG(+)          = '0'
            AND DCD.GLBL_CMPY_CD                = DCCCPD.GLBL_CMPY_CD(+)
            AND DCD.DS_CONTR_DTL_PK             = DCCCPD.DS_CONTR_DTL_PK(+)
            AND DCCCPD.DS_CONTR_MACH_LVL_NUM(+) = #dsContrMachLvlNum2#
            AND DCCCPD.EZCANCELFLAG(+)          = '0'
            AND DCD.GLBL_CMPY_CD                = DCCCPB.GLBL_CMPY_CD(+)
            AND DCD.DS_CONTR_DTL_PK             = DCCCPB.DS_CONTR_DTL_PK(+)
            AND DCCCPB.DS_CONTR_MACH_LVL_NUM(+) = #dsContrMachLvlNum3#
            AND DCCCPB.DS_CONTR_BLLG_MTR_PK IS NULL
            AND DCCCPB.EZCANCELFLAG(+)          = '0'
        <!-- START 2017/12/26 K.Kojima [QC#23260, ADD] -->
            )
        WHERE
            PO_DT IS NOT NULL
        <!-- END 2017/12/26 K.Kojima [QC#23260, ADD] -->
    </statement>
    <statement id="getPoDtListForUsg" parameterClass="Map" resultClass="String">
        <!-- START 2017/12/26 K.Kojima [QC#23260, ADD] -->
        SELECT
            PO_DT
        FROM
            (
        <!-- END 2017/12/26 K.Kojima [QC#23260, ADD] -->
        SELECT
            NVL(NVL(DCCCPU.PO_DT, DCCCPD.PO_DT), DCCCPH.PO_DT) AS PO_DT
        FROM
             DS_CONTR_DTL        DCD
            ,DS_CONTR_BLLG_MTR   DCBM
            ,DS_CONTR_CR_CARD_PO DCCCPH
            ,DS_CONTR_CR_CARD_PO DCCCPD
            ,DS_CONTR_CR_CARD_PO DCCCPU
        WHERE
                DCD.GLBL_CMPY_CD                = #glblCmpyCd#
            AND DCD.DS_CONTR_PK                 = #dsContrPk#
            AND DCD.DS_CONTR_DTL_PK             = #dsContrDtlPk#
            AND DCD.EZCANCELFLAG                = '0'
            AND DCD.GLBL_CMPY_CD                = DCBM.GLBL_CMPY_CD
            AND DCD.DS_CONTR_DTL_PK             = DCBM.DS_CONTR_DTL_PK
            AND DCBM.EZCANCELFLAG               = '0'
            AND DCBM.DS_CONTR_BLLG_MTR_PK       = #dsContrBllgMtrPk#
            AND DCD.GLBL_CMPY_CD                = DCCCPH.GLBL_CMPY_CD(+)
            AND DCD.DS_CONTR_PK                 = DCCCPH.DS_CONTR_PK(+)
            AND DCCCPH.DS_CONTR_MACH_LVL_NUM(+) = #dsContrMachLvlNum1#
            AND DCCCPH.EZCANCELFLAG(+)          = '0'
            AND DCD.GLBL_CMPY_CD                = DCCCPD.GLBL_CMPY_CD(+)
            AND DCD.DS_CONTR_DTL_PK             = DCCCPD.DS_CONTR_DTL_PK(+)
            AND DCCCPD.DS_CONTR_MACH_LVL_NUM(+) = #dsContrMachLvlNum2#
            AND DCCCPD.EZCANCELFLAG(+)          = '0'
            AND DCBM.GLBL_CMPY_CD               = DCCCPU.GLBL_CMPY_CD(+)
            AND DCBM.DS_CONTR_DTL_PK            = DCCCPU.DS_CONTR_DTL_PK(+)
            AND DCBM.DS_CONTR_BLLG_MTR_PK       = DCCCPU.DS_CONTR_BLLG_MTR_PK(+)
            AND DCCCPU.DS_CONTR_MACH_LVL_NUM(+) = #dsContrMachLvlNum3#
            AND DCCCPU.EZCANCELFLAG(+)          = '0'
        <!-- START 2017/12/26 K.Kojima [QC#23260, ADD] -->
            )
        WHERE
            PO_DT IS NOT NULL
        <!-- END 2017/12/26 K.Kojima [QC#23260, ADD] -->
    </statement>
    <!-- END 2017/10/05 M.Kidokoro [QC#21544, ADD] -->
    <statement id="getInvdBllgSchd" parameterClass="Map" resultClass="Map">
        SELECT
            A.DS_CONTR_BLLG_SCHD_PK
            ,A.BLLG_SCHD_THRU_DT
            ,A.NEXT_BLLG_DT
        FROM
            DS_CONTR_BLLG_SCHD A
        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            AND A.EZCANCELFLAG          = '0'
            AND A.DS_CONTR_DTL_PK       = #dsContrDtlPk#
            <isNotNull property="dsContrBllgMtrPk">
            AND A.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
            </isNotNull>
            <isEqual property="baseChrgFlg" compareValue="Y">
            AND A.BASE_CHRG_FLG         = 'Y'
            </isEqual>
            <isEqual property="usgChrgFlg" compareValue="Y">
            AND A.USG_CHRG_FLG          = 'Y'
            </isEqual>
            AND A.BLLG_SCHD_THRU_DT     &lt;= #invUpDt#
            AND A.INV_FLG               = 'N'
        ORDER BY
            A.DS_CONTR_BLLG_SCHD_SQ_NUM
    </statement>
    <statement id="getRnwHoldContr" parameterClass="Map" resultClass="Map">
        SELECT
            B.DS_CONTR_PRC_EFF_PK
            ,B.CONTR_PRC_EFF_THRU_DT
            ,B.BASE_CHRG_FLG
            ,B.USG_CHRG_FLG
        FROM
            DS_CONTR_DTL A
            ,DS_CONTR_PRC_EFF B
        WHERE
                A.GLBL_CMPY_CD              = #glblCmpyCd#
            AND A.EZCANCELFLAG              = '0'
            AND A.DS_CONTR_DTL_PK           = #dsContrDtlPk#
            AND A.GLBL_CMPY_CD              = B.GLBL_CMPY_CD
            AND B.EZCANCELFLAG              = '0'
            AND A.DS_CONTR_DTL_PK           = B.DS_CONTR_DTL_PK
            AND B.DS_CONTR_PRC_EFF_STS_CD   = #renewalHoldWithPo#
        ORDER BY
            B.DS_CONTR_PRC_EFF_SQ_NUM
            ,B.BASE_CHRG_FLG DESC
    </statement>
    <statement id="getDsContrFormCtrl" parameterClass="Map" resultClass="Map">
                SELECT
             DCF.DS_CONTR_FORM_CTRL_PK
            ,DCF.DS_CONTR_SCR_FLD_NM
            ,DCF.BTN_READ_ONLY_FLG
            ,DCF.SCR_FLD_ACTV_FLG
            ,DCF.DS_CONTR_CATG_CD
            ,DCF.DS_CONTR_STS_CD
            ,DCF.DS_CONTR_DTL_STS_CD
            ,DCF.DS_CONTR_DTL_TP_CD
            ,(
                 CASE
                     WHEN DCF.DS_CONTR_SCR_FLD_NM = #scrnFldNm# THEN 1
                     ELSE 99 
                 END
            ) AS DS_CONTR_SCR_FLD_NM_SQ
            ,(
                 CASE
                     WHEN DCF.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCd# THEN 1
                 ELSE 99 
                 END
            ) AS DS_CONTR_DTL_TP_CD_SQ
            ,(
                 CASE
                       WHEN DCF.DS_CONTR_CATG_CD = #dsContrCatgCd# THEN 1
                 ELSE 99 
                 END
            ) AS DS_CONTR_CATG_CD_SQ
            ,(
                 CASE
                       WHEN DCF.DS_CONTR_BLLG_MTR_STS_CD = #contrStsCd# THEN 1
                 ELSE 99 
                 END
            ) AS DS_CONTR_BLLG_MTR_STS_CD_SQ
            ,(
                 CASE
                       WHEN DCF.DS_CONTR_DTL_STS_CD = #contrStsCd# THEN 1
                 ELSE 99 
                 END
            ) AS DS_CONTR_DTL_STS_CD_SQ
            ,(
                 CASE
                       WHEN DCF.DS_CONTR_STS_CD = #contrStsCd# THEN 1
                 ELSE 99 
                 END
            ) AS DS_CONTR_STS_CD_SQ
        FROM
            DS_CONTR_FORM_CTRL      DCF
        WHERE
            DCF.GLBL_CMPY_CD = #glblCmpyCd#
            AND DCF.EZCANCELFLAG = '0'
            AND 
            (
            (DCF.DS_CONTR_SCR_FLD_NM = #scrnFldNm#
             OR DCF.DS_CONTR_SCR_FLD_NM = '*')
            AND
            (DCF.DS_CONTR_STS_CD = #contrStsCd#
             OR DCF.DS_CONTR_STS_CD = '*')
            AND
            (DCF.DS_CONTR_DTL_STS_CD = #contrStsCd#
             OR DCF.DS_CONTR_DTL_STS_CD = '*')
            AND
            (DCF.DS_CONTR_BLLG_MTR_STS_CD = #contrStsCd#
             OR DCF.DS_CONTR_BLLG_MTR_STS_CD = '*')
            AND
            (DCF.DS_CONTR_CATG_CD = #dsContrCatgCd#
             OR DCF.DS_CONTR_CATG_CD = '*')
            AND
            (DCF.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCd#
             OR DCF.DS_CONTR_DTL_TP_CD = '*')
            )
        ORDER BY
             DS_CONTR_SCR_FLD_NM_SQ
            ,DS_CONTR_DTL_TP_CD_SQ
            ,DS_CONTR_CATG_CD_SQ
            ,DS_CONTR_BLLG_MTR_STS_CD_SQ
            ,DS_CONTR_DTL_STS_CD_SQ
            ,DS_CONTR_STS_CD_SQ
    </statement>
    <statement id="getDsContrStsV" parameterClass="Map" resultClass="String">
        SELECT
            A.DS_CONTR_CTRL_STS_CD
        FROM
            DS_CONTR_STS_V A
        WHERE
            A.GLBL_CMPY_CD  = #glblCmpyCd#
        AND A.EZCANCELFLAG  = '0'
        AND A.DS_CONTR_PK   = #dsContrPk#
    </statement>
    <statement id="getDsContrDtlStsV" parameterClass="Map" resultClass="String">
        SELECT
            A.DS_CONTR_CTRL_STS_CD
        FROM
            DS_CONTR_DTL_STS_V A
        WHERE
            A.GLBL_CMPY_CD      = #glblCmpyCd#
        AND A.EZCANCELFLAG      = '0'
        AND A.DS_CONTR_DTL_PK   = #dsContrDtlPk#
    </statement>
    <statement id="getDsContrBllgMtrStsV" parameterClass="Map" resultClass="String">
        SELECT
            A.DS_CONTR_CTRL_STS_CD
        FROM
            DS_CONTR_BLLG_MTR_STS_V A
        WHERE
            A.GLBL_CMPY_CD           = #glblCmpyCd#
        AND A.EZCANCELFLAG           = '0'
        AND A.DS_CONTR_BLLG_MTR_PK   = #dsContrBllgMtrPk#
    </statement>
    <!-- START 2017/07/11 K.Kojima [QC#19822,DEL] -->
    <!-- <statement id="getPrcEffForBase" parameterClass="Map" resultClass="Map"> -->
    <!--     SELECT -->
    <!--         A.DS_CONTR_PRC_EFF_PK -->
    <!--         ,A.DS_CONTR_PRC_EFF_SQ_NUM -->
    <!--         ,A.CONTR_PRC_EFF_FROM_DT -->
    <!--         ,A.CONTR_PRC_EFF_THRU_DT -->
    <!--     FROM -->
    <!--         DS_CONTR_PRC_EFF A  -->
    <!--     WHERE -->
    <!--         A.GLBL_CMPY_CD          = #glblCmpyCd# -->
    <!--     AND A.EZCANCELFLAG          = '0' -->
    <!--     AND A.DS_CONTR_DTL_PK       = #dsContrDtlPk# -->
    <!--     AND A.BASE_CHRG_FLG         = 'Y' -->
    <!--     AND A.CONTR_PRC_EFF_FROM_DT &lt;= #slsDt# -->
    <!--     AND A.CONTR_PRC_EFF_THRU_DT &gt;= #slsDt# -->
    <!-- </statement> -->
    <!-- <statement id="getPrcEffForUsg" parameterClass="Map" resultClass="Map"> -->
    <!--     SELECT -->
    <!--         A.DS_CONTR_PRC_EFF_PK -->
    <!--         ,A.DS_CONTR_PRC_EFF_SQ_NUM -->
    <!--         ,A.CONTR_PRC_EFF_FROM_DT -->
    <!--         ,A.CONTR_PRC_EFF_THRU_DT -->
    <!--     FROM -->
    <!--         DS_CONTR_PRC_EFF A  -->
    <!--     WHERE -->
    <!--         A.GLBL_CMPY_CD          = #glblCmpyCd# -->
    <!--     AND A.EZCANCELFLAG          = '0' -->
    <!--     AND A.DS_CONTR_DTL_PK       = #dsContrDtlPk# -->
    <!--     AND A.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk# -->
    <!--     AND A.USG_CHRG_FLG         = 'Y' -->
    <!--     AND A.CONTR_PRC_EFF_FROM_DT &lt;= #slsDt# -->
    <!--     AND A.CONTR_PRC_EFF_THRU_DT &gt;= #slsDt# -->
    <!-- </statement> -->
    <!-- END 2017/07/11 K.Kojima [QC#19822,DEL] -->
    <!-- START 2017/07/10 K.Kojima [QC#19822,ADD] -->
    <!-- START 2017/07/11 K.Kojima [QC#19822,MOD] -->
    <!-- <statement id="getPrcEffForBaseForAggregateLine" parameterClass="Map" resultClass="Map"> -->
    <statement id="getPrcEffForBase" parameterClass="Map" resultClass="Map">
    <!-- END 2017/07/11 K.Kojima [QC#19822,MOD] -->
        SELECT
             DS_CONTR_PRC_EFF_PK
            ,DS_CONTR_PRC_EFF_SQ_NUM
            ,CONTR_PRC_EFF_FROM_DT
            ,CONTR_PRC_EFF_THRU_DT
        FROM
            (
                SELECT
                     A.DS_CONTR_PRC_EFF_PK
                    ,A.DS_CONTR_PRC_EFF_SQ_NUM
                    ,A.CONTR_PRC_EFF_FROM_DT
                    ,A.CONTR_PRC_EFF_THRU_DT
                    ,1                            AS SORT_KEY1
                    ,0                            AS SORT_KEY2
                FROM
                    DS_CONTR_PRC_EFF A 
                WHERE
                        A.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND A.EZCANCELFLAG          = '0'
                    AND A.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND A.BASE_CHRG_FLG         = 'Y'
                    AND A.CONTR_PRC_EFF_FROM_DT &lt;= #slsDt#
                    AND A.CONTR_PRC_EFF_THRU_DT &gt;= #slsDt#
                UNION
                SELECT
                     A.DS_CONTR_PRC_EFF_PK
                    ,A.DS_CONTR_PRC_EFF_SQ_NUM
                    ,A.CONTR_PRC_EFF_FROM_DT
                    ,A.CONTR_PRC_EFF_THRU_DT
                    ,2                            AS SORT_KEY1
                    ,(TO_DATE(A.CONTR_PRC_EFF_FROM_DT, 'YYYYMMDD') - TO_DATE(#slsDt#, 'YYYYMMDD'))  AS SORT_KEY2
                FROM
                    DS_CONTR_PRC_EFF A 
                WHERE
                        A.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND A.EZCANCELFLAG          = '0'
                    AND A.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND A.BASE_CHRG_FLG         = 'Y'
                    AND A.CONTR_PRC_EFF_FROM_DT &gt;= #slsDt#
                UNION
                SELECT
                     A.DS_CONTR_PRC_EFF_PK
                    ,A.DS_CONTR_PRC_EFF_SQ_NUM
                    ,A.CONTR_PRC_EFF_FROM_DT
                    ,A.CONTR_PRC_EFF_THRU_DT
                    ,3                            AS SORT_KEY1
                    ,(TO_DATE(#slsDt#, 'YYYYMMDD') - TO_DATE(A.CONTR_PRC_EFF_THRU_DT, 'YYYYMMDD'))  AS SORT_KEY2
                FROM
                    DS_CONTR_PRC_EFF A
                WHERE
                        A.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND A.EZCANCELFLAG          = '0'
                    AND A.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND A.BASE_CHRG_FLG         = 'Y'
                    AND A.CONTR_PRC_EFF_THRU_DT &lt;= #slsDt#
                ORDER BY
                     SORT_KEY1                    ASC
                    ,SORT_KEY2                    ASC
                    ,DS_CONTR_PRC_EFF_PK          DESC
            )
        WHERE
            ROWNUM = 1
    </statement>
    <!-- START 2017/07/11 K.Kojima [QC#19822,MOD] -->
    <!-- <statement id="getPrcEffForUsgForAggregateLine" parameterClass="Map" resultClass="Map"> -->
    <statement id="getPrcEffForUsg" parameterClass="Map" resultClass="Map">
    <!-- END 2017/07/11 K.Kojima [QC#19822,MOD] -->
        SELECT
             DS_CONTR_PRC_EFF_PK
            ,DS_CONTR_PRC_EFF_SQ_NUM
            ,CONTR_PRC_EFF_FROM_DT
            ,CONTR_PRC_EFF_THRU_DT
        FROM
            (
                SELECT
                     A.DS_CONTR_PRC_EFF_PK
                    ,A.DS_CONTR_PRC_EFF_SQ_NUM
                    ,A.CONTR_PRC_EFF_FROM_DT
                    ,A.CONTR_PRC_EFF_THRU_DT
                    ,1                            AS SORT_KEY1
                    ,0                            AS SORT_KEY2
                FROM
                    DS_CONTR_PRC_EFF A 
                WHERE
                        A.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND A.EZCANCELFLAG          = '0'
                    AND A.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND A.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
                    AND A.USG_CHRG_FLG          = 'Y'
                    AND A.CONTR_PRC_EFF_FROM_DT &lt;= #slsDt#
                    AND A.CONTR_PRC_EFF_THRU_DT &gt;= #slsDt#
                UNION
                SELECT
                     A.DS_CONTR_PRC_EFF_PK
                    ,A.DS_CONTR_PRC_EFF_SQ_NUM
                    ,A.CONTR_PRC_EFF_FROM_DT
                    ,A.CONTR_PRC_EFF_THRU_DT
                    ,2                            AS SORT_KEY1
                    ,(TO_DATE(A.CONTR_PRC_EFF_FROM_DT, 'YYYYMMDD') - TO_DATE(#slsDt#, 'YYYYMMDD'))  AS SORT_KEY2
                FROM
                    DS_CONTR_PRC_EFF A 
                WHERE
                        A.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND A.EZCANCELFLAG          = '0'
                    AND A.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND A.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
                    AND A.USG_CHRG_FLG          = 'Y'
                    AND A.CONTR_PRC_EFF_FROM_DT &gt;= #slsDt#
                UNION
                SELECT
                     A.DS_CONTR_PRC_EFF_PK
                    ,A.DS_CONTR_PRC_EFF_SQ_NUM
                    ,A.CONTR_PRC_EFF_FROM_DT
                    ,A.CONTR_PRC_EFF_THRU_DT
                    ,3                            AS SORT_KEY1
                    ,(TO_DATE(#slsDt#, 'YYYYMMDD') - TO_DATE(A.CONTR_PRC_EFF_THRU_DT, 'YYYYMMDD'))  AS SORT_KEY2
                FROM
                    DS_CONTR_PRC_EFF A 
                WHERE
                        A.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND A.EZCANCELFLAG          = '0'
                    AND A.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND A.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
                    AND A.USG_CHRG_FLG          = 'Y'
                    AND A.CONTR_PRC_EFF_THRU_DT &lt;= #slsDt#
                ORDER BY
                     SORT_KEY1                    ASC
                    ,SORT_KEY2                    ASC
                    ,DS_CONTR_PRC_EFF_PK          DESC
            )
        WHERE
            ROWNUM = 1
    </statement>
    <!-- END 2017/07/10 K.Kojima [QC#19822,ADD] -->
    
    <!-- START 2019/04/18  K.Fujimoto [QC#31137/50058, ADD] -->
    <statement id="getMultiPrcEffForBase" parameterClass="Map" resultClass="Map">
        WITH TARGET_PRC_EFF AS (
            SELECT
                  DCPE.DS_CONTR_PRC_EFF_PK
                 ,DCPE.DS_CONTR_PRC_EFF_SQ_NUM
                 ,DCPE.CONTR_PRC_EFF_FROM_DT
                 ,DCPE.CONTR_PRC_EFF_THRU_DT
                 ,DCPE.BLLG_CYCLE_CD
                 ,DCPE.BASE_PRC_DEAL_AMT
                 ,DCPE.BASE_PRC_TERM_DEAL_AMT_RATE
                 ,DCPE.QLTY_ASRN_HLD_FLG
                 ,DCPE.MTR_HLD_FLG
                 ,DCPE.CONTR_HLD_FLG
                 ,DCPE.BLLG_HLD_FLG
                 ,DCPE.DS_CONTR_PRC_EFF_STS_CD
                 ,DCPE.QLTY_ASRN_HLD_PEND_APVL_FLG
            FROM 
                  DS_CONTR_PRC_EFF DCPE
            WHERE
                  DCPE.GLBL_CMPY_CD = #glblCmpyCd#
              AND DCPE.EZCANCELFLAG = '0'
              AND DCPE.DS_CONTR_DTL_PK = #dsContrDtlPk#
              AND DCPE.BASE_CHRG_FLG = 'Y'
        )
        SELECT
              DS_CONTR_PRC_EFF_PK
             ,ROW_NUMBER() OVER (ORDER BY DS_CONTR_PRC_EFF_SQ_NUM, CONTR_PRC_EFF_FROM_DT) AS DS_CONTR_PRC_EFF_SQ_NUM
             ,CONTR_PRC_EFF_FROM_DT
             ,CONTR_PRC_EFF_THRU_DT
             ,BLLG_CYCLE_CD
             ,BASE_PRC_DEAL_AMT
             ,BASE_PRC_TERM_DEAL_AMT_RATE
             ,QLTY_ASRN_HLD_FLG
             ,CONTR_HLD_FLG
             ,BLLG_HLD_FLG
             ,DS_CONTR_PRC_EFF_STS_CD
        FROM
        (
            SELECT
                  TPE.DS_CONTR_PRC_EFF_PK
                 ,TPE.DS_CONTR_PRC_EFF_SQ_NUM
                 ,TPE.CONTR_PRC_EFF_FROM_DT
                 ,TPE.CONTR_PRC_EFF_THRU_DT
                 ,TPE.BLLG_CYCLE_CD
                 ,TPE.BASE_PRC_DEAL_AMT
                 ,TPE.BASE_PRC_TERM_DEAL_AMT_RATE
                 ,TPE.QLTY_ASRN_HLD_FLG
                 ,TPE.CONTR_HLD_FLG
                 ,TPE.BLLG_HLD_FLG
                 ,TPE.DS_CONTR_PRC_EFF_STS_CD
            FROM TARGET_PRC_EFF TPE
            WHERE
                  (
                      (
                          TPE.CONTR_PRC_EFF_FROM_DT &lt;= #exchDt#
                      AND TPE.CONTR_PRC_EFF_THRU_DT &gt;= #exchDt#
                      )
                      OR TPE.CONTR_PRC_EFF_FROM_DT &gt; #exchDt#
                  )
            UNION
            SELECT
                  TPE.DS_CONTR_PRC_EFF_PK
                 ,TPE.DS_CONTR_PRC_EFF_SQ_NUM
                 ,TPE.CONTR_PRC_EFF_FROM_DT
                 ,TPE.CONTR_PRC_EFF_THRU_DT
                 ,TPE.BLLG_CYCLE_CD
                 ,TPE.BASE_PRC_DEAL_AMT
                 ,TPE.BASE_PRC_TERM_DEAL_AMT_RATE
                 ,TPE.QLTY_ASRN_HLD_FLG
                 ,TPE.CONTR_HLD_FLG
                 ,TPE.BLLG_HLD_FLG
                 ,TPE.DS_CONTR_PRC_EFF_STS_CD
            FROM TARGET_PRC_EFF TPE
            WHERE TPE.DS_CONTR_PRC_EFF_SQ_NUM IN
            (
                SELECT
                     MAX(DS_CONTR_PRC_EFF_SQ_NUM)
                 FROM TARGET_PRC_EFF TPE
                WHERE NOT EXISTS
                        (
                            SELECT
                                  1
                            FROM   
                                  TARGET_PRC_EFF TPE2
                            WHERE 
                                  TPE2.CONTR_PRC_EFF_FROM_DT &lt;= #exchDt#
                              AND TPE2.CONTR_PRC_EFF_THRU_DT &gt;= #exchDt#
                        )
                  AND TPE.CONTR_PRC_EFF_THRU_DT &lt; #exchDt#
            )
        )
        ORDER BY DS_CONTR_PRC_EFF_SQ_NUM, CONTR_PRC_EFF_FROM_DT
    </statement>
    <statement id="getMultiPrcEffForUsg" parameterClass="Map" resultClass="Map">
        SELECT
              OLD_PRC.DS_CONTR_PRC_EFF_PK
             ,OLD_PRC.DS_CONTR_PRC_EFF_SQ_NUM
             ,OLD_PRC.CONTR_PRC_EFF_FROM_DT
             ,OLD_PRC.CONTR_PRC_EFF_THRU_DT
             ,OLD_PRC.BLLG_CYCLE_CD
             ,OLD_PRC.DS_CONTR_BLLG_MTR_PK
             ,OLD_PRC.QLTY_ASRN_HLD_FLG
             ,OLD_PRC.CONTR_HLD_FLG
             ,OLD_PRC.BLLG_HLD_FLG
             ,OLD_PRC.MTR_HLD_FLG
             ,OLD_PRC.DS_CONTR_PRC_EFF_STS_CD
             ,CXC.CONTR_XS_COPY_PK
             ,DCPEM.XS_MTR_COPY_QTY
             ,DCPEM.XS_MTR_AMT_RATE
             ,DCPEM.XS_MTR_FIRST_FLG
        FROM
        (
            SELECT
                  DCPE.GLBL_CMPY_CD
                 ,DCPE.DS_CONTR_PRC_EFF_PK
                 ,ROW_NUMBER() OVER (ORDER BY DCPE.DS_CONTR_PRC_EFF_SQ_NUM, DCPE.CONTR_PRC_EFF_FROM_DT) AS DS_CONTR_PRC_EFF_SQ_NUM
                 ,DCPE.CONTR_PRC_EFF_FROM_DT
                 ,DCPE.CONTR_PRC_EFF_THRU_DT
                 ,DCPE.BLLG_CYCLE_CD
                 ,EXCH_DCBM.DS_CONTR_BLLG_MTR_PK
                 ,DCPE.QLTY_ASRN_HLD_FLG
                 ,DCPE.CONTR_HLD_FLG
                 ,DCPE.BLLG_HLD_FLG
                 ,DCPE.MTR_HLD_FLG
                 ,DCPE.DS_CONTR_PRC_EFF_STS_CD
            FROM 
                  DS_CONTR_PRC_EFF DCPE
                 ,DS_CONTR_BLLG_MTR DCBM
                 ,DS_CONTR_BLLG_MTR EXCH_DCBM
            WHERE
                  DCPE.GLBL_CMPY_CD = #glblCmpyCd#
              AND DCPE.EZCANCELFLAG = '0'
              AND DCPE.GLBL_CMPY_CD = DCBM.GLBL_CMPY_CD
              AND DCPE.DS_CONTR_BLLG_MTR_PK = DCBM.DS_CONTR_BLLG_MTR_PK
              AND DCBM.EZCANCELFLAG = '0'
              AND DCPE.DS_CONTR_DTL_PK = #dsContrDtlPk#
              AND EXCH_DCBM.GLBL_CMPY_CD = DCBM.GLBL_CMPY_CD
              AND EXCH_DCBM.EZCANCELFLAG = '0'
              AND EXCH_DCBM.DS_CONTR_BLLG_MTR_PK = #dsContrBllgMtrPk#
              AND EXCH_DCBM.BLLG_MTR_LB_CD = DCBM.BLLG_MTR_LB_CD
              AND (
                     (
                          DCPE.CONTR_PRC_EFF_FROM_DT &lt;= #exchDt#
                      AND DCPE.CONTR_PRC_EFF_THRU_DT &gt;= #exchDt#
                     )
                  OR
                     DCPE.CONTR_PRC_EFF_FROM_DT &gt; #exchDt#
                   )
              AND DCPE.USG_CHRG_FLG = 'Y'
             ORDER BY DCPE.DS_CONTR_PRC_EFF_SQ_NUM, DCPE.CONTR_PRC_EFF_FROM_DT
         ) OLD_PRC
         ,DS_CONTR_PRC_EFF_MTR DCPEM
         ,CONTR_XS_COPY OLD_CXC
         ,CONTR_XS_COPY CXC
         WHERE 
               OLD_PRC.GLBL_CMPY_CD         = DCPEM.GLBL_CMPY_CD
           AND OLD_PRC.DS_CONTR_PRC_EFF_PK  = DCPEM.DS_CONTR_PRC_EFF_PK
           AND DCPEM.EZCANCELFLAG           = '0'
           AND DCPEM.CONTR_XS_COPY_PK       = OLD_CXC.CONTR_XS_COPY_PK(+)
           AND DCPEM.GLBL_CMPY_CD           = OLD_CXC.GLBL_CMPY_CD(+)
           AND OLD_CXC.EZCANCELFLAG(+)      = '0'
           AND OLD_CXC.GLBL_CMPY_CD         = CXC.GLBL_CMPY_CD(+)
           AND OLD_CXC.XS_MTR_COPY_QTY      = CXC.XS_MTR_COPY_QTY(+)
           AND OLD_PRC.DS_CONTR_BLLG_MTR_PK = CXC.DS_CONTR_BLLG_MTR_PK(+)
           AND CXC.EZCANCELFLAG(+)          = '0'
    </statement>
    <!-- END   2019/04/18  K.Fujimoto [QC#31137/50058, ADD] -->
    
    <statement id="getDsContrDtlForAddToContract" parameterClass="Map" resultClass="Map">
        SELECT
            DCD.DS_CONTR_DTL_PK
            ,DCD.DS_CONTR_DTL_TP_CD
            ,DCD.PRNT_DS_CONTR_DTL_PK
        FROM
            DS_CONTR      DC
            ,DS_CONTR_DTL DCD
        WHERE
                DC.GLBL_CMPY_CD              = #glblCmpyCd#
            AND DC.DS_CONTR_NUM              = #dsContrNum#
            AND DC.EZCANCELFLAG              = '0'
            AND DC.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
            AND DC.DS_CONTR_PK               = DCD.DS_CONTR_PK
            AND DCD.DS_CONTR_DTL_TP_CD       = #dsContrDtlTpCd#
            AND DCD.EZCANCELFLAG             = '0'
    </statement>
    <statement id="getInvLineKey" parameterClass="Map" resultClass="Map">
        SELECT
             B.INV_NUM
            ,B.INV_BOL_LINE_NUM
            ,B.INV_LINE_NUM
            ,B.INV_LINE_SUB_NUM
            ,B.INV_LINE_SUB_TRX_NUM
        FROM
             INV         A
            ,INV_LINE    B
        WHERE
                A.GLBL_CMPY_CD   = #glblCmpyCd#
            AND A.CPO_ORD_NUM    = #cpoOrdNum#
            AND A.EZCANCELFLAG   = '0'
            AND A.GLBL_CMPY_CD   = B.GLBL_CMPY_CD
            AND A.INV_NUM        = B.INV_NUM
            AND B.CPO_SVC_DTL_PK = #cpoSvcDtlPk#
            AND B.EZCANCELFLAG   = '0'
    </statement>
    <statement id="getEffectiveDsContrDtlFltAggLine" parameterClass="Map" resultClass="Map">
        SELECT
             A.DS_CONTR_DTL_PK
            ,A.DS_CONTR_DTL_TP_CD
            ,A.SUPPR_CR_FLG
            <!-- START 2022/02/04 K.Kitachi [QC#59684, ADD] -->
            ,A.MAN_TRMN_TP_CD
            <!-- END 2022/02/04 K.Kitachi [QC#59684, ADD] -->
        FROM
             DS_CONTR_DTL A
            ,DS_CONTR_DTL_STS_V B
        WHERE
            A.GLBL_CMPY_CD          = #glblCmpyCd#
        AND A.EZCANCELFLAG          = '0'
        AND A.DS_CONTR_PK           = #dsContrPk#
        AND A.DS_CONTR_DTL_TP_CD    IN (#fleet#, #aggregate#)
        AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
        AND B.EZCANCELFLAG          = '0'
        AND A.DS_CONTR_DTL_PK       = B.DS_CONTR_DTL_PK
        <!-- START 2019/05/15 K.Fujimoto [QC#50279, MOD] -->
        <!-- AND B.DS_CONTR_CTRL_STS_CD  NOT IN (#cancelled#,#terminated#,#expired#) -->
        AND B.DS_CONTR_CTRL_STS_CD  NOT IN (#cancelled#,#terminated#,#expired#,#terminatedHold#)
        <!-- END   2019/05/15 K.Fujimoto [QC#50279, MOD] -->
    </statement>
    <statement id="getEffectiveDsContrDtlCount" parameterClass="Map" resultClass="Integer">
        SELECT
            COUNT(A.DS_CONTR_DTL_PK)
        FROM
             DS_CONTR_DTL A
            ,DS_CONTR_DTL_STS_V B
        WHERE
            A.GLBL_CMPY_CD          = #glblCmpyCd#
        AND A.EZCANCELFLAG          = '0'
        AND A.DS_CONTR_PK           = #dsContrPk#
        AND A.DS_CONTR_DTL_TP_CD    NOT IN (#fleet#, #aggregate#)
        AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
        AND B.EZCANCELFLAG          = '0'
        AND A.DS_CONTR_DTL_PK       = B.DS_CONTR_DTL_PK
        <!-- START 2019/05/15 K.Fujimoto [QC#50279, MOD] -->
        <!-- AND B.DS_CONTR_CTRL_STS_CD  NOT IN (#cancelled#,#terminated#,#expired#) -->
        AND B.DS_CONTR_CTRL_STS_CD  NOT IN (#cancelled#,#terminated#,#expired#,#terminatedHold#)
        <!-- END   2019/05/15 K.Fujimoto [QC#50279, MOD] -->
    </statement>
    <statement id="getCloseDate" parameterClass="Map" resultClass="String">
        SELECT
            MAX(A.CONTR_CLO_DT)
        FROM
             DS_CONTR_DTL A
            ,DS_CONTR_DTL_STS_V B
        WHERE
            A.GLBL_CMPY_CD          = #glblCmpyCd#
        AND A.EZCANCELFLAG          = '0'
        AND A.DS_CONTR_PK           = #dsContrPk#
        AND A.DS_CONTR_DTL_TP_CD    NOT IN (#fleet#, #aggregate#)
        AND A.CONTR_CLO_DT          IS NOT NULL
        AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
        AND B.EZCANCELFLAG          = '0'
        AND A.DS_CONTR_DTL_PK       = B.DS_CONTR_DTL_PK
        <!-- START 2019/05/15 K.Fujimoto [QC#50279, MOD] -->
        <!-- AND B.DS_CONTR_CTRL_STS_CD  = #terminated#  -->
        AND B.DS_CONTR_CTRL_STS_CD  in (#terminated#,#terminatedHold#)
        <!-- END   2019/05/15 K.Fujimoto [QC#50279, MOD] -->
     </statement>
    <statement id="getAggLinePk" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            A.DS_CONTR_DTL_PK
        FROM
             DS_CONTR_DTL A
        WHERE
            A.GLBL_CMPY_CD          = #glblCmpyCd#
        AND A.EZCANCELFLAG          = '0'
        AND A.DS_CONTR_PK           = #dsContrPk#
        AND A.DS_CONTR_DTL_TP_CD    = #aggregate#
     </statement>

     <statement id="getAddlChrgInfo" parameterClass="Map" resultClass="Map">
        SELECT
            A.DS_CONTR_ADDL_CHRG_PK
            ,A.ADDL_CHRG_TP_CD
            ,A.ADDL_CHRG_FLAT_DEAL_PRC_AMT
            ,A.ADDL_CHRG_APLC_PCT
            ,A.ADDL_CHRG_INV_TP_CD
            ,A.SVC_BILL_BY_TP_CD
            ,A.PRINT_DTL_FLG
            ,A.EFF_FROM_DT
            ,A.EFF_THRU_DT
            ,A.BLLG_CYCLE_CD
        FROM
            DS_CONTR_ADDL_CHRG A
        WHERE
            A.GLBL_CMPY_CD              = #glblCmpyCd#
        AND A.DS_CONTR_PK               = #dsContrPk#
        <isNotNull property="dsContrDtlPk">
            AND A.DS_CONTR_DTL_PK       = #dsContrDtlPk#
        </isNotNull>
        <isNull property="dsContrDtlPk">
            AND A.DS_CONTR_DTL_PK       IS NULL
        </isNull>
        <!-- START 2018/05/15 K.Kojima [QC#23303,DEL] -->
        <!-- AND A.EFF_FROM_DT               &lt;= #slsDt# -->
        <!-- END 2018/05/15 K.Kojima [QC#23303,DEL] -->
        <!-- START 2018/05/15 K.Kojima [QC#23303,ADD] -->
        AND A.TRMN_DT                   IS NULL
        <!-- END 2018/05/15 K.Kojima [QC#23303,ADD] -->
        AND A.EZCANCELFLAG              = '0'
     </statement>

     <!-- START 2018/06/04 T.Wada [QC#17645,ADD] -->
     <statement id="getPrcUpRatio" parameterClass="Map" resultClass="Map">
        SELECT 
            DS_CONTR_MACH_LVL_NUM
            ,CONTR_AUTO_RNW_TP_CD
            ,RNW_PRC_METH_CD
            ,BASE_PRC_UP_RATIO
            ,MTR_PRC_UP_RATIO
            ,CONTR_AUTO_RNW_TP_NM
            ,AUTO_RNW_FLG
            ,RNW_BASE_FLG
        FROM
        (
            SELECT
                DS_CONTR_MACH_LVL_NUM
                ,CONTR_AUTO_RNW_TP_CD
                ,RNW_PRC_METH_CD
                ,BASE_PRC_UP_RATIO
                ,MTR_PRC_UP_RATIO
                ,CONTR_AUTO_RNW_TP_NM
                ,AUTO_RNW_FLG
                ,RNW_BASE_FLG
            FROM
            (
                SELECT 
                    3     AS RNUM
                    ,A.DS_CONTR_MACH_LVL_NUM
                    ,A.CONTR_AUTO_RNW_TP_CD
                    ,A.RNW_PRC_METH_CD
                    ,A.BASE_PRC_UP_RATIO
                    ,A.MTR_PRC_UP_RATIO
                    ,B.CONTR_AUTO_RNW_TP_NM
                    ,B.AUTO_RNW_FLG
                    ,B.RNW_BASE_FLG
                FROM
                    DS_CONTR_RNW_ESCL    A
                    ,CONTR_AUTO_RNW_TP   B
                WHERE 
                    A.GLBL_CMPY_CD              = #glblCmpyCd#
                AND A.DS_CONTR_PK               = #dsContrPk#
                <isNotNull property="dsContrDtlPk">
                    AND A.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                </isNotNull>
                <isNull property="dsContrDtlPk">
                    AND A.DS_CONTR_DTL_PK       IS NULL
                </isNull>
                AND A.DS_CONTR_MACH_LVL_NUM     = #dsContrMachLvlNum3#
                AND (A.DS_CONTR_BASE_USG_NM      = #usgNm# 
                    OR A.DS_CONTR_BASE_USG_NM IS NULL)
                AND A.EZCANCELFLAG              = '0'
                AND A.GLBL_CMPY_CD              = B.GLBL_CMPY_CD
                AND A.CONTR_AUTO_RNW_TP_CD      = B.CONTR_AUTO_RNW_TP_CD
                AND B.EZCANCELFLAG              = '0'
                UNION ALL
                SELECT 
                    2     AS RNUM
                    ,A.DS_CONTR_MACH_LVL_NUM
                    ,A.CONTR_AUTO_RNW_TP_CD
                    ,A.RNW_PRC_METH_CD
                    ,A.BASE_PRC_UP_RATIO
                    ,A.MTR_PRC_UP_RATIO
                    ,B.CONTR_AUTO_RNW_TP_NM
                    ,B.AUTO_RNW_FLG
                    ,B.RNW_BASE_FLG
                FROM
                    DS_CONTR_RNW_ESCL    A
                    ,CONTR_AUTO_RNW_TP   B
                WHERE 
                    A.GLBL_CMPY_CD              = #glblCmpyCd#
                AND A.DS_CONTR_PK               = #dsContrPk#
                <isNotNull property="dsContrDtlPk">
                    AND A.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                </isNotNull>
                <isNull property="dsContrDtlPk">
                    AND A.DS_CONTR_DTL_PK       IS NULL
                </isNull>
                AND A.DS_CONTR_MACH_LVL_NUM     = #dsContrMachLvlNum2#
                AND (A.DS_CONTR_BASE_USG_NM      = #usgNm# 
                    OR A.DS_CONTR_BASE_USG_NM IS NULL)
                AND A.EZCANCELFLAG              = '0'
                AND A.GLBL_CMPY_CD              = B.GLBL_CMPY_CD
                AND A.CONTR_AUTO_RNW_TP_CD      = B.CONTR_AUTO_RNW_TP_CD
                AND B.EZCANCELFLAG              = '0'
                UNION ALL
                SELECT 
                    1     AS RNUM
                    ,A.DS_CONTR_MACH_LVL_NUM
                    ,A.CONTR_AUTO_RNW_TP_CD
                    ,A.RNW_PRC_METH_CD
                    ,A.BASE_PRC_UP_RATIO
                    ,A.MTR_PRC_UP_RATIO
                    ,B.CONTR_AUTO_RNW_TP_NM
                    ,B.AUTO_RNW_FLG
                    ,B.RNW_BASE_FLG
                FROM
                    DS_CONTR_RNW_ESCL    A
                    ,CONTR_AUTO_RNW_TP   B
                WHERE 
                    A.GLBL_CMPY_CD              = #glblCmpyCd#
                AND A.DS_CONTR_PK               = #dsContrPk#
                AND A.DS_CONTR_MACH_LVL_NUM     = #dsContrMachLvlNum1#
                AND A.EZCANCELFLAG              = '0'
                AND A.GLBL_CMPY_CD              = B.GLBL_CMPY_CD
                AND A.CONTR_AUTO_RNW_TP_CD      = B.CONTR_AUTO_RNW_TP_CD
                AND B.EZCANCELFLAG              = '0'
            )  MAIN
            ORDER BY MAIN.RNUM DESC
        )RSLT
        WHERE 
            ROWNUM = 1
     </statement>

     <statement id="getUplftBasePrcUpRatio" parameterClass="Map" resultClass="java.math.BigDecimal">
        SELECT
            DMER.UPLFT_BASE_PRC_UP_RATIO 
        FROM
            DS_CONTR_DTL           DTL
            ,SVC_MACH_MSTR          SMM
            ,SVC_CONFIG_MSTR        SCM
            ,MDL_NM                 MDL
            ,DS_MDL_ESCL_RULE       DMER
        WHERE 
            DTL.GLBL_CMPY_CD                = #glblCmpyCd#
        AND DTL.DS_CONTR_PK                 = #dsContrPk#
        AND DTL.DS_CONTR_DTL_PK             = #dsContrDtlPk#
        AND DTL.EZCANCELFLAG                = '0'
        AND DTL.GLBL_CMPY_CD                = SMM.GLBL_CMPY_CD
        AND DTL.SVC_MACH_MSTR_PK            = SMM.SVC_MACH_MSTR_PK
        AND SMM.EZCANCELFLAG                = '0'
        AND SMM.GLBL_CMPY_CD                = SCM.GLBL_CMPY_CD(+)
        AND SMM.SVC_CONFIG_MSTR_PK          = SCM.SVC_CONFIG_MSTR_PK(+)
        AND SCM.EZCANCELFLAG(+)             = '0'
        AND SCM.GLBL_CMPY_CD                = MDL.T_GLBL_CMPY_CD(+)
        AND SCM.MDL_ID                      = MDL.T_MDL_ID(+)
        AND MDL.EZCANCELFLAG(+)             = '0'
        AND SCM.GLBL_CMPY_CD                = DMER.GLBL_CMPY_CD(+)
        AND SCM.MDL_ID                      = DMER.MDL_ID(+)
        AND DMER.EZCANCELFLAG(+)            = '0'
     </statement>
     <!-- END 2018/06/04 T.Wada [QC#17645,ADD] -->

    <!-- START 2019/11/06 K.Kitachi [QC#54368, ADD] -->
    <statement id="countPoInclRenewFromDate" parameterClass="Map" resultClass="java.math.BigDecimal">
        WITH DS_CONTR_PO AS (
            SELECT
                 A.DS_CONTR_PK
                ,A.DS_CONTR_DTL_PK
                ,A.DS_CONTR_BLLG_MTR_PK
                ,A.DS_CONTR_MACH_LVL_NUM
                ,A.PO_FROM_DT
                ,A.PO_DT
            FROM
                DS_CONTR_CR_CARD_PO A
            WHERE
                    A.GLBL_CMPY_CD = #glblCmpyCd#
                AND A.DS_CONTR_PK  = #dsContrPk#
                AND A.CR_CARD_FLG  = 'N'
                AND A.PO_FROM_DT   IS NOT NULL
                AND A.PO_DT        IS NOT NULL
                AND A.EZCANCELFLAG = '0'
        )
        SELECT
            COUNT(*)
        FROM
            DS_CONTR_DTL A
        WHERE
                A.GLBL_CMPY_CD    = #glblCmpyCd#
            AND A.DS_CONTR_DTL_PK = #dsContrDtlPk#
            AND A.RNW_EFF_FROM_DT IS NOT NULL
            AND A.EZCANCELFLAG    = '0'
            AND (
                EXISTS (
                    SELECT
                        1
                    FROM
                        DS_CONTR_PO X
                    WHERE
                            A.DS_CONTR_PK           = X.DS_CONTR_PK
                        AND A.RNW_EFF_FROM_DT BETWEEN X.PO_FROM_DT AND X.PO_DT
                        AND X.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvlNum1#
                )
             OR EXISTS (
                    SELECT
                        1
                    FROM
                        DS_CONTR_PO X
                    WHERE
                            A.DS_CONTR_DTL_PK       = X.DS_CONTR_DTL_PK
                        AND A.RNW_EFF_FROM_DT BETWEEN X.PO_FROM_DT AND X.PO_DT
                        AND X.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvlNum2#
                )
             OR EXISTS (
                    SELECT
                        1
                    FROM
                        DS_CONTR_PO X
                    WHERE
                            A.DS_CONTR_DTL_PK       = X.DS_CONTR_DTL_PK
                        AND A.RNW_EFF_FROM_DT BETWEEN X.PO_FROM_DT AND X.PO_DT
                        AND X.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvlNum3#
                        <isNotNull property="dsContrBllgMtrPk">
                        AND X.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
                        </isNotNull>
                        <isNull property="dsContrBllgMtrPk">
                        AND X.DS_CONTR_BLLG_MTR_PK  IS NULL
                        </isNull>
                )
            )
    </statement>
    <!-- END 2019/11/06 K.Kitachi [QC#54368, ADD] -->
</sqlMap>