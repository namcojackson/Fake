<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NPBB003001">
    <statement id="search" parameterClass="Map" resultClass="Map">
        SELECT
            RMA.RTL_WH_CD
           ,RMA.RTL_WH_NM
           ,RMA.INVTY_LOC_CD
           ,RMA.MDSE_CD
           ,RMA.STK_STS_CD
           ,RMA.QTY REQ_QTY
           ,RWH.SHIP_TO_CUST_CD
           ,RWH.SHIP_TO_LOC_NM
           ,RWH.ADDL_LOC_NM
           ,RWH.FIRST_LINE_ADDR
           ,RWH.SCD_LINE_ADDR
           ,RWH.THIRD_LINE_ADDR
           ,RWH.FRTH_LINE_ADDR
           ,RWH.CTY_ADDR
           ,RWH.ST_CD
           ,RWH.PROV_NM
           ,RWH.POST_CD
           ,RWH.CTRY_CD
           ,RWH.PRNT_VND_CD
           ,RWH.VND_CD
           ,CNTY.CNTY_NM
        FROM
           -- RMA DATA
           (SELECT
                RTRN.RTL_WH_CD
               ,RWH.RTL_WH_NM
               ,RTRN.INVTY_LOC_CD
               ,RTRN.MDSE_CD
               ,RTRN.STK_STS_CD
               ,SUM(TRX.INVTY_TRX_QTY) QTY
            FROM
                DS_CPO_RTRN_DTL RTRN
               ,RTL_WH          RWH
               ,MDSE            MDSE
               ,INVTY_TRX TRX
               ,INVTY     INV
            WHERE
                RTRN.GLBL_CMPY_CD            = #glblCmpyCd#
            AND RTRN.GLBL_CMPY_CD            = RWH.GLBL_CMPY_CD
            AND RTRN.RTL_WH_CD               = RWH.RTL_WH_CD
            AND RWH.RTL_WH_CATG_CD           = #dropRma#
            AND RTRN.GLBL_CMPY_CD            = MDSE.GLBL_CMPY_CD
            AND RTRN.MDSE_CD                 = MDSE.MDSE_CD
            AND MDSE.DROP_RTRN_VND_CD        IS NOT NULL
            AND TRX.GLBL_CMPY_CD             = RTRN.GLBL_CMPY_CD
            AND TRX.INVTY_LOC_CD             = RTRN.INVTY_LOC_CD
            AND TRX.MDSE_CD                  = RTRN.MDSE_CD
            AND TRX.CPO_ORD_NUM              = RTRN.CPO_ORD_NUM
            AND TRX.CPO_DTL_LINE_NUM         = RTRN.DS_CPO_RTRN_LINE_NUM
            AND TRX.CPO_DTL_LINE_SUB_NUM     = RTRN.DS_CPO_RTRN_LINE_SUB_NUM
            AND TRX.INVTY_TRX_DT             = #salesDate#
            AND TRX.GLBL_CMPY_CD             = INV.GLBL_CMPY_CD
            AND TRX.INVTY_LOC_CD             = INV.INVTY_LOC_CD
            AND TRX.MDSE_CD                  = INV.MDSE_CD
            AND TRX.LOC_STS_CD               = INV.LOC_STS_CD
            AND TRX.STK_STS_CD               = INV.STK_STS_CD
            AND INV.INVTY_QTY                > 0
            AND RTRN.EZCANCELFLAG            = '0'
            AND RWH.EZCANCELFLAG             = '0'
            AND MDSE.EZCANCELFLAG            = '0'
            AND TRX.EZCANCELFLAG             = '0'
            AND INV.EZCANCELFLAG             = '0'
            GROUP BY
                RTRN.RTL_WH_CD
               ,RWH.RTL_WH_NM 
               ,RTRN.INVTY_LOC_CD
               ,RTRN.MDSE_CD
               ,RTRN.STK_STS_CD
            )             RMA
           ,RTL_WH        RWH
           ,CNTY          CNTY
        WHERE
            RMA.RTL_WH_CD        = RWH.RTL_WH_CD
        AND RWH.GLBL_CMPY_CD     = #glblCmpyCd#
        <!-- 2018/11/29 QC#29377 Mod Start Left Outer Join To CNTY -->
        AND RWH.GLBL_CMPY_CD     = CNTY.GLBL_CMPY_CD(+)
        AND RWH.CNTY_PK          = CNTY.CNTY_PK(+)
        AND RWH.EZCANCELFLAG     = '0'
        AND CNTY.EZCANCELFLAG(+) = '0'
        <!-- 2018/11/29 QC#29377 Mod End -->
        ORDER BY
            RMA.INVTY_LOC_CD
           ,RMA.MDSE_CD
    </statement>
</sqlMap>
