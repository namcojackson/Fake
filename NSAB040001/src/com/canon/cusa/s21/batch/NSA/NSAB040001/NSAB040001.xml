<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSAB040001">

    <statement id="getCfsSerAudPkForPurge" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            T.CFS_SER_AUD_QLTY_ASRN_PK
        FROM
            CFS_SER_AUD_QLTY_ASRN T
        WHERE
            T.GLBL_CMPY_CD  = #GLBL_CMPY_CD#
        AND T.CRAT_DT       &lt;= #SALES_DT#
    </statement>


<!-- START 2017/02/22 K.Kitachi [QC#17626, MOD] -->
    <statement id="getDsContr" parameterClass="Map" resultClass="Map">
<!-- END 2017/02/22 K.Kitachi [QC#17626, MOD] -->
        SELECT
            TRN.DS_CONTR_NUM
<!-- START 2017/02/22 K.Kitachi [QC#17626, ADD] -->
            ,TRN.DS_CONTR_PK
            ,SUB.DS_CONTR_CTRL_STS_CD
<!-- END 2017/02/22 K.Kitachi [QC#17626, ADD] -->
        FROM
            DS_CONTR                   TRN
           ,DS_CONTR_STS_V             SUB
        WHERE
            TRN.GLBL_CMPY_CD           = #GLBL_CMPY_CD#
        AND TRN.DS_CONTR_EDI_CD        = #DS_CONTR_EDI_CD#
        AND TRN.GLBL_CMPY_CD           = SUB.GLBL_CMPY_CD
        AND TRN.DS_CONTR_PK            = SUB.DS_CONTR_PK
        AND SUB.CFS_QLTY_ASRN_CHK_FLG  = #CFS_QLTY_ASRN_CHK_FLG#
        AND TRN.EZCANCELFLAG           = '0'
        AND SUB.EZCANCELFLAG           = '0'
        AND NOT EXISTS (
            SELECT 1
            FROM   CFS_SER_AUD_QLTY_ASRN AUD
            WHERE  AUD.GLBL_CMPY_CD = TRN.GLBL_CMPY_CD
            AND    AUD.DS_CONTR_PK  = TRN.DS_CONTR_PK
            AND    AUD.CRAT_DT      = #SALES_DT#
            AND    AUD.EZCANCELFLAG = '0'
        )
<!-- START 2018/02/02 U.Kim [QC#23687,ADD] -->
        AND MOD(NVL(TRN.DS_CONTR_PK,0),#multiCnt#) = #usrVar1#
<!-- END 2018/02/02 U.Kim [QC#23687,ADD] -->
        ORDER BY
            DS_CONTR_NUM
    </statement>


    <statement id="getCfsSerAud" parameterClass="Map" resultClass="Map">
        SELECT
            TRN.LEASE_CMPY_CD
           ,TRN.SVC_CONTR_BR_CD
           ,WRK.DS_CONTR_PK
           ,WRK.DS_CONTR_DTL_PK
           ,WRK.DS_CONTR_VLD_RSLT_WRK_PK
           ,WRK.DS_CONTR_VLD_RSLT_MSG_TXT
           ,VLD.DS_CONTR_VLD_CATG_CD
           ,MST.SER_NUM
        FROM
            DS_CONTR                  TRN
           ,DS_CONTR_VLD_RSLT_WRK     WRK
           ,DS_CONTR_VLD              VLD
           ,DS_CONTR_DTL              DTL
           ,SVC_MACH_MSTR             MST
        WHERE 
            TRN.GLBL_CMPY_CD          = #GLBL_CMPY_CD#
        AND TRN.DS_CONTR_NUM          = #DS_CONTR_NUM#
        AND TRN.GLBL_CMPY_CD          = WRK.GLBL_CMPY_CD
        AND TRN.DS_CONTR_PK           = WRK.DS_CONTR_PK
        <iterate property="DS_CONTR_VLD_STS_CD" var="DS_CONTR_VLD_STS_CD[]" open="AND WRK.DS_CONTR_VLD_STS_CD NOT IN (" close=")" conjunction=",">
            #DS_CONTR_VLD_STS_CD[]#
        </iterate>
        AND WRK.GLBL_CMPY_CD          = VLD.GLBL_CMPY_CD
        AND WRK.DS_CONTR_VLD_PK       = VLD.DS_CONTR_VLD_PK
        AND VLD.DS_CONTR_VLD_CATG_CD  = #DS_CONTR_VLD_CATG_CD#
        AND VLD.GLBL_CMPY_CD          = DTL.GLBL_CMPY_CD
        AND WRK.DS_CONTR_DTL_PK       = DTL.DS_CONTR_DTL_PK
        AND DTL.GLBL_CMPY_CD          = MST.GLBL_CMPY_CD(+)
        AND DTL.SVC_MACH_MSTR_PK      = MST.SVC_MACH_MSTR_PK(+)
        AND TRN.EZCANCELFLAG          = '0'
        AND WRK.EZCANCELFLAG          = '0'
        AND VLD.EZCANCELFLAG          = '0'
        AND DTL.EZCANCELFLAG          = '0'
        AND MST.EZCANCELFLAG(+)       = '0'
    </statement>


    <statement id="getDsConVldRsltWkPkForDel" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            WRK.DS_CONTR_VLD_RSLT_WRK_PK
        FROM
            DS_CONTR                  TRN
           ,DS_CONTR_VLD_RSLT_WRK     WRK
           ,DS_CONTR_VLD              VLD
        WHERE
            TRN.GLBL_CMPY_CD          = #GLBL_CMPY_CD#
        AND TRN.DS_CONTR_NUM          = #DS_CONTR_NUM#
        AND TRN.GLBL_CMPY_CD          = WRK.GLBL_CMPY_CD
        AND TRN.DS_CONTR_PK           = WRK.DS_CONTR_PK
        AND WRK.GLBL_CMPY_CD          = VLD.GLBL_CMPY_CD
        AND WRK.DS_CONTR_VLD_PK       = VLD.DS_CONTR_VLD_PK
        AND VLD.DS_CONTR_VLD_CATG_CD  = #DS_CONTR_VLD_CATG_CD#
        AND TRN.EZCANCELFLAG          = '0'
        AND WRK.EZCANCELFLAG          = '0'
        AND VLD.EZCANCELFLAG          = '0'
    </statement>

<!-- START 2017/02/22 K.Kitachi [QC#17626, ADD] -->
    <statement id="getUpdDsContrDtl" parameterClass="Map" resultClass="Map">
        SELECT
             A.DS_CONTR_DTL_PK
            ,B.DS_CONTR_CTRL_STS_CD
        FROM
             DS_CONTR_DTL       A
            ,DS_CONTR_DTL_STS_V B
        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            AND A.EZCANCELFLAG          = '0'
            AND A.DS_CONTR_PK           = #dsContrPk#
            AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
            AND A.DS_CONTR_DTL_PK       = B.DS_CONTR_DTL_PK
            AND B.CFS_QLTY_ASRN_CHK_FLG = #cfsQltyAsrnChkFlg#
    </statement>
    <statement id="getUpdDsContrBllgMtr" parameterClass="Map" resultClass="Map">
        SELECT
             A.DS_CONTR_BLLG_MTR_PK
            ,B.DS_CONTR_CTRL_STS_CD
        FROM
             DS_CONTR_BLLG_MTR       A
            ,DS_CONTR_BLLG_MTR_STS_V B
        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            AND A.EZCANCELFLAG          = '0'
            AND A.DS_CONTR_DTL_PK       = #dsContrDtlPk#
            AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
            AND A.DS_CONTR_BLLG_MTR_PK  = B.DS_CONTR_BLLG_MTR_PK
            AND B.CFS_QLTY_ASRN_CHK_FLG = #cfsQltyAsrnChkFlg#
    </statement>
    <statement id="getUpdDsContrPrcEffBase" parameterClass="Map" resultClass="Map">
        SELECT
             A.DS_CONTR_PRC_EFF_PK
            ,B.DS_CONTR_CTRL_STS_CD
        FROM
             DS_CONTR_PRC_EFF       A
            ,DS_CONTR_PRC_EFF_STS_V B
        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            AND A.EZCANCELFLAG          = '0'
            AND A.DS_CONTR_DTL_PK       = #dsContrDtlPk#
            AND A.BASE_CHRG_FLG         = 'Y'
            AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
            AND A.DS_CONTR_PRC_EFF_PK   = B.DS_CONTR_PRC_EFF_PK
            AND B.CFS_QLTY_ASRN_CHK_FLG = #cfsQltyAsrnChkFlg#
    </statement>
    <statement id="getUpdDsContrPrcEffUsg" parameterClass="Map" resultClass="Map">
        SELECT
             A.DS_CONTR_PRC_EFF_PK
            ,B.DS_CONTR_CTRL_STS_CD
        FROM
             DS_CONTR_PRC_EFF       A
            ,DS_CONTR_PRC_EFF_STS_V B
        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            AND A.EZCANCELFLAG          = '0'
            AND A.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
            AND A.USG_CHRG_FLG          = 'Y'
            AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
            AND A.DS_CONTR_PRC_EFF_PK   = B.DS_CONTR_PRC_EFF_PK
            AND B.CFS_QLTY_ASRN_CHK_FLG = #cfsQltyAsrnChkFlg#
    </statement>
    <statement id="findErrContrVldRslt" parameterClass="Map" resultClass="Map">
        SELECT
             SER_NUM
            ,DS_CONTR_VLD_NM
            ,DS_CONTR_VLD_STS_DESC_TXT
        FROM
            (
                SELECT
                     B.DS_CONTR_PK
                    ,A.DS_CONTR_NUM
                    ,F.SER_NUM
                    ,F.SVC_MACH_MSTR_PK
                    ,B.DS_CONTR_VLD_PK
                    ,C.DS_CONTR_VLD_NM
                    ,B.DS_CONTR_VLD_STS_CD
                    ,G.DS_CONTR_VLD_STS_DESC_TXT
                    ,B.DS_CONTR_VLD_RSLT_MSG_TXT
                FROM
                     DS_CONTR              A
                    ,DS_CONTR_VLD_RSLT_WRK B
                    ,DS_CONTR_VLD          C
                    ,DS_CONTR_VLD_RELN     D
                    ,DS_CONTR_DTL          E
                    ,SVC_MACH_MSTR         F
                    ,DS_CONTR_VLD_STS      G
                WHERE
                        A.GLBL_CMPY_CD         = #glblCmpyCd#
                    AND A.DS_CONTR_NUM         = #dsContrNum#
                    AND A.EZCANCELFLAG         = '0'
                    AND A.GLBL_CMPY_CD         = B.GLBL_CMPY_CD
                    AND A.DS_CONTR_PK          = B.DS_CONTR_PK
                    <iterate property="vldStsSet" var="dsContrVldStsCd[]" open="AND B.DS_CONTR_VLD_STS_CD IN (" close=")" conjunction=",">
                        #dsContrVldStsCd[]#
                    </iterate>
                    AND B.EZCANCELFLAG         = '0'
                    AND B.GLBL_CMPY_CD         = C.GLBL_CMPY_CD
                    AND B.DS_CONTR_VLD_PK      = C.DS_CONTR_VLD_PK
                    AND C.EZCANCELFLAG         = '0'
                    AND B.GLBL_CMPY_CD         = D.GLBL_CMPY_CD
                    AND B.DS_CONTR_VLD_PK      = D.DS_CONTR_VLD_PK
                    AND B.DS_CONTR_VLD_LIST_PK = D.DS_CONTR_VLD_LIST_PK
                    AND D.EZCANCELFLAG         = '0'
                    AND B.GLBL_CMPY_CD         = E.GLBL_CMPY_CD(+)
                    AND B.DS_CONTR_DTL_PK      = E.DS_CONTR_DTL_PK(+)
                    AND E.EZCANCELFLAG(+)      = '0'
                    AND E.GLBL_CMPY_CD         = F.GLBL_CMPY_CD(+)
                    AND E.SVC_MACH_MSTR_PK     = F.SVC_MACH_MSTR_PK(+)
                    AND F.EZCANCELFLAG(+)      = '0'
                    AND B.GLBL_CMPY_CD         = G.GLBL_CMPY_CD
                    AND B.DS_CONTR_VLD_STS_CD  = G.DS_CONTR_VLD_STS_CD
                    AND G.EZCANCELFLAG         = '0'
                ORDER BY
                     B.DS_CONTR_DTL_PK ASC  NULLS FIRST
                    ,C.PRIM_VLD_FLG    DESC
                    ,D.VLD_SORT_NUM    ASC
            )
        WHERE
            ROWNUM &lt;= #rowNum#
    </statement>
<!-- END 2017/02/22 K.Kitachi [QC#17626, ADD] -->
</sqlMap>
