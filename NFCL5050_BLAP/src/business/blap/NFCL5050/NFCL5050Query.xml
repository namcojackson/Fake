<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NFCL5050Query">

    <!-- *********************************************************** -->
    <!-- ********** Bean Definition ******************************** -->
    <!-- *********************************************************** -->
    <typeAlias alias="NFCL5050_ASMsg"    type="business.blap.NFCL5050.NFCL5050_ASMsg"/>
    
    <statement id="findApplicationInfoList" parameterClass="Map" resultMap="result.findApplicationInfoList">
     SELECT
             AR.XX_TOT_CNT                 XX_TOT_CNT
            ,AR.AR_TRX_NUM                 AR_TRX_NUM
            ,AR.GRP_INV_NUM                GRP_INV_NUM
            ,AR.AR_TRX_TP_CD               AR_TRX_TP_CD
            ,AR.AR_TRX_TP_NM               AR_TRX_TP_NM
            ,AR.AR_TRX_DT                  AR_TRX_DT
            ,AR.INV_DUE_DT                 INV_DUE_DT
            ,AR.SHIP_DT                    SHIP_DT
            ,AR.AR_CUST_REF_NUM            AR_CUST_REF_NUM
            ,AR.CPO_ORD_NUM                CPO_ORD_NUM
            ,AR.CUST_ISS_PO_NUM            CUST_ISS_PO_NUM
            ,AR.DEAL_ORIG_GRS_AMT          DEAL_ORIG_GRS_AMT
            ,AR.DEAL_APPLY_GRS_AMT         DEAL_APPLY_GRS_AMT
            ,AR.DEAL_RMNG_BAL_GRS_AMT      DEAL_RMNG_BAL_GRS_AMT
            ,AR.DEAL_NET_SLS_AMT           DEAL_NET_SLS_AMT
            ,AR.DEAL_FRT_AMT               DEAL_FRT_AMT
            ,AR.DEAL_TAX_AMT               DEAL_TAX_AMT
            ,AR.DEAL_APPLY_CASH_DISC_AMT   DEAL_APPLY_CASH_DISC_AMT
            ,AR.DEAL_APPLY_CR_AMT          DEAL_APPLY_CR_AMT
            ,AR.DEAL_APPLY_ADJ_AMT         DEAL_APPLY_ADJ_AMT
            ,AR.AR_TRX_BAL_PK              AR_TRX_BAL_PK
            ,AR.CR_CARD_ORD_NUM            CR_CARD_ORD_NUM
            ,AR.BILL_TO_CUST_ACCT_CD       BILL_TO_CUST_ACCT_CD
            ,AR.DS_ACCT_NM                 DS_ACCT_NM
     FROM(
             SELECT
                     COUNT(*) OVER (PARTITION BY A.GLBL_CMPY_CD)    XX_TOT_CNT
                    ,A.AR_TRX_NUM                 					AR_TRX_NUM
                    ,A.GRP_INV_NUM                					GRP_INV_NUM
                    ,A.AR_TRX_TP_CD               					AR_TRX_TP_CD
                    ,C.AR_TRX_TP_NM               					AR_TRX_TP_NM
                    ,A.AR_TRX_DT                  					AR_TRX_DT
                    ,A.INV_DUE_DT                 					INV_DUE_DT
                    ,MAX(B.SHIP_DT)               					SHIP_DT
                    ,A.AR_CUST_REF_NUM            					AR_CUST_REF_NUM
                    ,A.CPO_ORD_NUM                					CPO_ORD_NUM
                    ,A.CUST_ISS_PO_NUM            					CUST_ISS_PO_NUM
                    ,A.DEAL_ORIG_GRS_AMT          					DEAL_ORIG_GRS_AMT
                    ,A.DEAL_APPLY_GRS_AMT         					DEAL_APPLY_GRS_AMT
                    ,A.DEAL_RMNG_BAL_GRS_AMT      					DEAL_RMNG_BAL_GRS_AMT
                    ,A.DEAL_NET_SLS_AMT           					DEAL_NET_SLS_AMT
                    ,A.DEAL_FRT_AMT               					DEAL_FRT_AMT
                    ,A.DEAL_TAX_AMT               					DEAL_TAX_AMT
                    ,A.DEAL_APPLY_CASH_DISC_AMT   					DEAL_APPLY_CASH_DISC_AMT
                    ,A.DEAL_APPLY_CR_AMT          					DEAL_APPLY_CR_AMT
                    ,A.DEAL_APPLY_ADJ_AMT         					DEAL_APPLY_ADJ_AMT
                    ,A.AR_TRX_BAL_PK              					AR_TRX_BAL_PK
                    ,D.CR_CARD_ORD_NUM            					CR_CARD_ORD_NUM
                    ,A.BILL_TO_CUST_ACCT_CD              			BILL_TO_CUST_ACCT_CD
                    ,F.DS_ACCT_NM              					    DS_ACCT_NM
             FROM
                     AR_TRX_BAL       A
                    ,INV_BOL          B
                    ,AR_TRX_TP        C
                    ,INV              D
                    ,SELL_TO_CUST     F

             WHERE
                          A.GLBL_CMPY_CD            =  #cMsg.glblCmpyCd#
                     AND  A.DEAL_ORIG_GRS_AMT      !=  #cMsg.dealOrigGrsAmt_H2#
                     AND  A.AR_CASH_APPLY_STS_CD    IN ('U','P')
                <isNotNull property="arTrxBalPk01">
                <!-- START 2018/08/02 Y.Matsui [QC#26985-1,MOD] -->
                <iterate property="arTrxBalPk01" var="elem[]" open="AND (" close=")"  conjunction=" AND ">
                     A.AR_TRX_BAL_PK != #elem[]#
                </iterate>
                <!-- END   2018/08/02 Y.Matsui [QC#26985-1,MOD] -->
                </isNotNull>

                <isNull property="cMsg.xxChkBox_H5">
                     AND  A.BILL_TO_CUST_ACCT_CD    =  #cMsg.payerCustCd#
                </isNull>                        
                <isNotNull property="cMsg.xxChkBox_H5">
                     <!-- AND (
                                A.BILL_TO_CUST_ACCT_CD    =  #cMsg.payerCustCd#
                          OR    A.BILL_TO_CUST_ACCT_CD    IN (SELECT 
                                                                E.RELN_DS_ACCT_NUM
                                                             FROM
                                                                DS_ACCT_RELN E
                                                             WHERE
                                                                    E.GLBL_CMPY_CD          = #cMsg.glblCmpyCd#
                                                                AND E.DS_ACCT_NUM(+)        =  #cMsg.payerCustCd#
                                                                AND E.DS_ACCT_RELN_TP_CD(+) IN (#dsAcctRelnTp1#,#dsAcctRelnTp2#)
                                                                AND E.EZCANCELFLAG          = '0'
                                                             )
                                                                
                     )  -->
                     AND
                         EXISTS (
                                 SELECT
                                    'X'
                                 FROM
                                     (
                                      SELECT
                                          #cMsg.payerCustCd# AS RELN_DS_ACCT_NUM
                                      FROM
                                          DUAL
                                      UNION ALL
                                      SELECT
                                          E.RELN_DS_ACCT_NUM
                                      FROM
                                          DS_ACCT_RELN E
                                      WHERE
                                          E.GLBL_CMPY_CD          = #cMsg.glblCmpyCd#
                                      AND E.DS_ACCT_NUM           = #cMsg.payerCustCd#
                                      AND E.DS_ACCT_RELN_TP_CD    IN (#dsAcctRelnTp1#,#dsAcctRelnTp2#)
                                      AND E.EZCANCELFLAG          = '0'
                                     )
                                 WHERE
                                      RELN_DS_ACCT_NUM = A.BILL_TO_CUST_ACCT_CD
                                )
                     <!-- START 2018/07/20 Y.Matsui [QC#26985,ADD] -->
                     <isNotNull property="cMsg.payerCustCd_H1">
                         AND  A.BILL_TO_CUST_ACCT_CD    = #cMsg.payerCustCd_H1#
                     </isNotNull>
                     <!-- END   2018/07/20 Y.Matsui [QC#26985,ADD] -->
                </isNotNull>                        

                     AND  A.DEAL_CCY_CD             =  #cMsg.dealCcyCd#
                     AND  A.AR_TRX_TP_CD            =  C.AR_TRX_TP_CD(+)
                     AND  A.GLBL_CMPY_CD            =  C.GLBL_CMPY_CD(+)
                     AND  A.AR_TRX_NUM              =  D.INV_NUM(+)
                     AND  A.GLBL_CMPY_CD            =  D.GLBL_CMPY_CD(+)
                     AND  D.INV_NUM                 =  B.INV_NUM(+)
                     AND  D.GLBL_CMPY_CD            =  B.GLBL_CMPY_CD(+)
                
                <isNotNull property="cMsg.arTrxNum">
                     AND  A.AR_TRX_NUM             &gt;=  #cMsg.arTrxNum#
                </isNotNull>
                
                <isNotNull property="cMsg.arTrxNum_H1">
                     AND  A.AR_TRX_NUM             &lt;=  #cMsg.arTrxNum_H1#
                </isNotNull>
                
                <isNotNull property="cMsg.soNum">
                     AND  B.SO_NUM                     =  #cMsg.soNum#
                </isNotNull>

                <isNotNull property="cMsg.grpInvNum">
                     AND  A.GRP_INV_NUM                LIKE  #cMsg.grpInvNum#
                </isNotNull>

                <isNotNull property="cMsg.cpoOrdNum">
                     AND  A.CPO_ORD_NUM                =  #cMsg.cpoOrdNum#
                </isNotNull>
                
                <isNotNull property="cMsg.arTrxDt">
                     AND  A.AR_TRX_DT           &gt;   =  #cMsg.arTrxDt#
                </isNotNull>
                
                <isNotNull property="cMsg.arTrxDt_H1">
                     AND  A.AR_TRX_DT           &lt;   =  #cMsg.arTrxDt_H1#
                </isNotNull>

                <isNotNull property="maxArTrxDate">
                     AND  A.AR_TRX_DT           &lt;   =  #maxArTrxDate#
                </isNotNull>

                <isNotNull property="cMsg.custIssPoNum">
                    <!-- 2019/03/25 QC#30758 Mod Start -->
                     <!-- AND  A.UPPER_CUST_ISS_PO_NUM      =  #cMsg.custIssPoNum# -->
                     AND  UPPER(A.CUST_ISS_PO_NUM)      =  UPPER(#cMsg.custIssPoNum#)
                    <!-- 2019/03/25 QC#30758 Mod End -->
                </isNotNull>

                <!-- START 2018/07/20 Y.Matsui [QC#26985,MOD] -->
                <!--
                <isEqual property="cMsg.xxChkBox_S1" compareValue="Y">
                     AND  A.AR_CUST_REF_NUM        like  #cMsg.arCustRefNum#
                </isEqual>
                <isNotEqual property="cMsg.xxChkBox_S1" compareValue="Y">
                    <isNotNull property="cMsg.arCustRefNum">
                         AND  A.AR_CUST_REF_NUM        &gt;=  #cMsg.arCustRefNum#
                    </isNotNull>
                    
                    <isNotNull property="cMsg.arCustRefNum_H1">
                         AND  A.AR_CUST_REF_NUM        &lt;=  #cMsg.arCustRefNum_H1#
                    </isNotNull>
                </isNotEqual>
                -->
                <isEqual property="cMsg.xxChkBox_S1" compareValue="Y">
                     AND  A.AR_CUST_REF_NUM        like  #cMsg.xxTrxNumSrchTxt#
                </isEqual>
                <isNotEqual property="cMsg.xxChkBox_S1" compareValue="Y">
                    <isNotNull property="invoices">
                        <iterate property="invoices" var="invoice[]" open="AND (" close=")"  conjunction=" OR ">
                             A.AR_CUST_REF_NUM = #invoice[]#
                        </iterate>
                    </isNotNull>
                    <isNull property="invoices">
                        <isNotNull property="cMsg.xxTrxNumSrchTxt">
                             AND  A.AR_CUST_REF_NUM =  #cMsg.xxTrxNumSrchTxt#
                        </isNotNull>
                    </isNull>
                </isNotEqual>
                <!-- END   2018/07/20 Y.Matsui [QC#26985,MOD] -->

                <isNotNull property="cMsg.xxInpAmtNum">
                     AND  A.DEAL_ORIG_GRS_AMT      &gt;=  #cMsg.xxInpAmtNum#
                </isNotNull>
                
                <isNotNull property="cMsg.xxInpAmtNum_H1">
                     AND  A.DEAL_ORIG_GRS_AMT      &lt;=  #cMsg.xxInpAmtNum_H1#
                </isNotNull>
                
                <!-- TRX Type -->
                <isNotNull property="arTrxTpCdisEmpty">
                     AND A.AR_TRX_TP_CD                                  IN
                      <iterate property="arTrxTpCd" var="elem[]" open="(" close=")" conjunction=",">
                          #elem[]#
                      </iterate>
                </isNotNull>
              
                <isNotNull property="cMsg.crCardOrdNum">
                     AND  D.CR_CARD_ORD_NUM        =  #cMsg.crCardOrdNum#
                </isNotNull>
                 
                     AND  A.EZCANCELFLAG           =  '0'
                     AND  B.EZCANCELFLAG(+)        =  '0'
                     AND  C.EZCANCELFLAG(+)        =  '0'
                     AND  D.EZCANCELFLAG(+)        =  '0'
                     AND  A.EXPT_FLG               =  #cMsg.exptFlg_H1#
                     <!-- START 2016/04/18 S.Fujita [QC#6462,MOD] -->
                     AND A.GLBL_CMPY_CD                = F.GLBL_CMPY_CD(+)
                     AND A.BILL_TO_CUST_ACCT_CD        = F.SELL_TO_CUST_CD(+)
                     AND F.EZCANCELFLAG(+)             = '0'
                     <!-- END 2016/04/18 S.Fujita [QC#6462,MOD] -->

             GROUP BY
                          A.GLBL_CMPY_CD
                         ,A.AR_TRX_NUM
                         ,A.GRP_INV_NUM
                         ,A.AR_TRX_TP_CD
                         ,C.AR_TRX_TP_NM
                         ,A.AR_TRX_DT
                         ,A.INV_DUE_DT
                         ,A.AR_CUST_REF_NUM
                         ,A.CPO_ORD_NUM
                         ,A.CUST_ISS_PO_NUM
                         ,A.DEAL_ORIG_GRS_AMT
                         ,A.DEAL_APPLY_GRS_AMT
                         ,A.DEAL_RMNG_BAL_GRS_AMT
                         ,A.DEAL_NET_SLS_AMT
                         ,A.DEAL_FRT_AMT
                         ,A.DEAL_TAX_AMT
                         ,A.DEAL_APPLY_CASH_DISC_AMT
                         ,A.DEAL_APPLY_CR_AMT
                         ,A.DEAL_APPLY_ADJ_AMT
                         ,A.AR_TRX_BAL_PK
                         ,D.CR_CARD_ORD_NUM
                         ,A.BILL_TO_CUST_ACCT_CD
                         ,F.DS_ACCT_NM
             ORDER BY
                          A.AR_CUST_REF_NUM   ASC
                         ,A.AR_TRX_NUM        ASC
     ) AR
     WHERE ROWNUM                              &lt;= #rowNum#

    </statement>
    
    <resultMap id="result.findApplicationInfoList" class="NFCL5050_ASMsg">
        <result property="xxTotCnt"                    column="XX_TOT_CNT"                         javaType="EZDSBigDecimalItem"/>
        <result property="arTrxNum_A1"                 column="AR_TRX_NUM"                         javaType="EZDSStringItem"/>
        <result property="grpInvNum_A1"                column="GRP_INV_NUM"                        javaType="EZDSStringItem"/>
        <result property="arTrxTpCd_A1"                column="AR_TRX_TP_CD"                       javaType="EZDSStringItem"/>
        <result property="arTrxTpNm"                   column="AR_TRX_TP_NM"                       javaType="EZDSStringItem"/>
        <result property="arTrxDt_A1"                  column="AR_TRX_DT"                          javaType="EZDSDateItem"/>
        <result property="invDueDt_A1"                 column="INV_DUE_DT"                         javaType="EZDSDateItem"/>
        <result property="shipDt_A1"                   column="SHIP_DT"                            javaType="EZDSDateItem"/>
        <result property="arCustRefNum_A1"             column="AR_CUST_REF_NUM"                    javaType="EZDSStringItem"/>
        <result property="cpoOrdNum_A1"                column="CPO_ORD_NUM"                        javaType="EZDSStringItem"/>
        <result property="custIssPoNum_A1"             column="CUST_ISS_PO_NUM"                    javaType="EZDSStringItem"/>
        <result property="dealOrigGrsAmt_A1"           column="DEAL_ORIG_GRS_AMT"                  javaType="EZDSBigDecimalItem"/>
        <result property="dealApplyGrsAmt"             column="DEAL_APPLY_GRS_AMT"                 javaType="EZDSBigDecimalItem"/>
        <result property="dealRmngBalGrsAmt"           column="DEAL_RMNG_BAL_GRS_AMT"              javaType="EZDSBigDecimalItem"/>
        <result property="dealNetSlsAmt"               column="DEAL_NET_SLS_AMT"                   javaType="EZDSBigDecimalItem"/>
        <result property="dealFrtAmt"                  column="DEAL_FRT_AMT"                       javaType="EZDSBigDecimalItem"/>
        <result property="dealTaxAmt"                  column="DEAL_TAX_AMT"                       javaType="EZDSBigDecimalItem"/>
        <result property="dealApplyCashDiscAmt"        column="DEAL_APPLY_CASH_DISC_AMT"           javaType="EZDSBigDecimalItem"/>
        <result property="dealApplyCrAmt"              column="DEAL_APPLY_CR_AMT"                  javaType="EZDSBigDecimalItem"/>
        <result property="dealApplyAdjAmt"             column="DEAL_APPLY_ADJ_AMT"                 javaType="EZDSBigDecimalItem"/>
        <result property="arTrxBalPk"                  column="AR_TRX_BAL_PK"                      javaType="EZDSBigDecimalItem"/>
        <result property="crCardOrdNum_A1"             column="CR_CARD_ORD_NUM"                    javaType="EZDSStringItem"/>
        <result property="billToCustAcctCd_A1"         column="BILL_TO_CUST_ACCT_CD"               javaType="EZDSStringItem"/>
        <result property="dsAcctNm_A1"                 column="DS_ACCT_NM"                         javaType="EZDSStringItem"/>
    </resultMap>

</sqlMap>
