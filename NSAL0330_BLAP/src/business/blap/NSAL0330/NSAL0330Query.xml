<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSAL0330Query">

    <statement id="getDsContrDtlInfo" parameterClass="Map" resultClass="Map">
        SELECT
                DCD.EZUPTIME
               ,DCD.EZUPTIMEZONE
               ,DCD.GLBL_CMPY_CD
               ,DCD.DS_CONTR_PK
               ,DCD.DS_CONTR_DTL_PK
               ,DCPE.DS_CONTR_PRC_EFF_PK
               ,DCPE.DS_CONTR_PRC_EFF_SQ_NUM
               ,DCPE.CONTR_PRC_EFF_FROM_DT
               ,DCPE.CONTR_PRC_EFF_THRU_DT
               ,DCD.BASE_BLLG_LAST_BLLG_DT
               ,DCD.BASE_BLLG_TMG_CD
               ,DCD.BASE_BILL_TO_CUST_CD
               ,DCD.CONTR_CLO_DAY
               ,DCD.CONTR_BLLG_DAY
               ,DCD.BASE_DPLY_PER_END_DAY
               ,DCD.CONTR_EFF_FROM_DT
               ,DC.DS_CONTR_NUM
               ,DC.CCY_CD
               ,SMM.SER_NUM
               ,DCPE.BLLG_CYCLE_CD
               ,BC.BLLG_CYCLE_DESC_TXT
               ,BC.BLLG_CYCLE_START_MTH
               ,DCPE.BASE_PRC_DEAL_AMT
               ,DC.INV_SEPT_BASE_USG_FLG
<!-- START 2018/05/11 K.Kim [QC#25897, ADD] -->
               ,DC.DS_CONTR_CATG_CD
               ,DCD.DS_CONTR_DTL_TP_CD
<!-- END 2018/05/11 K.Kim [QC#25897, ADD] -->
        FROM
                DS_CONTR_DTL DCD
               ,DS_CONTR DC
               ,SVC_MACH_MSTR SMM
               ,DS_CONTR_PRC_EFF DCPE
               ,BLLG_CYCLE BC
        WHERE
                DCD.GLBL_CMPY_CD         = #glblCmpyCd#
        AND     DCD.DS_CONTR_DTL_PK      = #dsContrDtlPk#
        AND     DCPE.DS_CONTR_PRC_EFF_PK = #dsContrPrcEffPk#
        AND     DCD.GLBL_CMPY_CD         = DC.GLBL_CMPY_CD
        AND     DCD.DS_CONTR_PK          = DC.DS_CONTR_PK
        AND     DCD.GLBL_CMPY_CD         = SMM.GLBL_CMPY_CD(+)
        AND     DCD.SVC_MACH_MSTR_PK     = SMM.SVC_MACH_MSTR_PK(+)
        AND     DCD.GLBL_CMPY_CD         = DCPE.GLBL_CMPY_CD
        AND     DCD.DS_CONTR_DTL_PK      = DCPE.DS_CONTR_DTL_PK
        AND     DCPE.GLBL_CMPY_CD        = BC.GLBL_CMPY_CD
        AND     DCPE.BLLG_CYCLE_CD       = BC.BLLG_CYCLE_CD
        AND     DCD.EZCANCELFLAG         = '0'
        AND     DC.EZCANCELFLAG          = '0'
        AND     SMM.EZCANCELFLAG(+)      = '0'
        AND     DCPE.EZCANCELFLAG        = '0'
        AND     BC.EZCANCELFLAG          = '0'

    </statement>
    
    <statement id="getSvcMemo" parameterClass="Map" resultClass="Map">
        SELECT
                SM.EZUPTIME
               ,SM.EZUPTIMEZONE
               ,SM.SVC_MEMO_PK
               ,SM.SVC_MEMO_TP_CD
               ,SM.SVC_CMNT_TXT
               ,SM.SVC_MEMO_RSN_CD
        FROM
                SVC_MEMO SM
        WHERE
                SM.GLBL_CMPY_CD          = #glblCmpyCd#
        AND     SM.DS_CONTR_DTL_PK       = #dsContrDtlPk#
        AND     SM.SVC_MEMO_TP_CD        = #svcMemoTpCd#
        AND     SM.EZCANCELFLAG          = '0'

    </statement>

    <statement id="getScheduleInfoList" parameterClass="Map" resultClass="Map">
        SELECT
                DCBSS.EZUPTIME
               ,DCBSS.EZUPTIMEZONE
               ,DCBSS.DS_CONTR_BLLG_SCHD_SMRY_PK
               ,DCBSS.DS_CONTR_BLLG_SCHD_SQ_NUM
               ,DCBSS.DS_CONTR_PRC_EFF_SQ_NUM
               ,DCBSS.PER_SCHD_NUM
               ,DCBSS.PER_BLLG_CYCLE_CD
               ,DCBSS.BLLG_SCHD_FROM_DT
               ,DCBSS.BLLG_SCHD_THRU_DT
               ,DCBSS.BLLG_CYCLE_CD
               ,BC.BLLG_CYCLE_DESC_TXT
               ,DCBSS.BASE_PRC_DEAL_AMT
               ,DCBSS.BASE_PRC_DEAL_ADJ_AMT
               ,DCBSS.BASE_SUB_TOT_PRC_DEAL_AMT
               ,DCBSS.CCY_CD
               ,CASE WHEN COUNT(DECODE(DCBS.INV_FLG, 'Y', DCBS.DS_CONTR_BLLG_SCHD_PK)) > 0 THEN
                       'Y'
                ELSE 
                       'N' 
                END AS INV_FLG
               ,BC.BLLG_CYCLE_UOM_CD
<!-- START 2016/11/29 K.Ochiai [QC#14204, ADD] -->
               ,DCBSS.EZINTIME                      AS XX_REC_HIST_CRAT_TS
               ,DCBSS.EZINUSERID                    AS XX_REC_HIST_CRAT_BY_NM
               ,DCBSS.EZUPTIME                      AS XX_REC_HIST_UPD_TS
               ,DCBSS.EZUPUSERID                    AS XX_REC_HIST_UPD_BY_NM
               ,DCBSS.EZTABLEID                     AS XX_REC_HIST_TBL_NM
<!-- END 2016/11/29 K.Ochiai [QC#14204, ADD] -->
        FROM
                DS_CONTR_BLLG_SCHD_SMRY DCBSS
               ,DS_CONTR_BLLG_SCHD DCBS
               ,BLLG_CYCLE BC
        WHERE
                DCBSS.GLBL_CMPY_CD               = #glblCmpyCd#
        AND     DCBSS.DS_CONTR_DTL_PK            = #dsContrDtlPk#
        AND     DCBSS.DS_CONTR_PRC_EFF_PK        = #dsContrPrcEffPk#
        AND     DCBSS.DS_CONTR_BLLG_MTR_PK       IS NULL
<!-- START 2017/10/25 K.Ochiai [QC#22076, DEL] -->
<!--         AND     DCBSS.DS_BLLG_SCHD_TP_CD         = #dsBllgSchdTpCd#  -->
<!-- END 2016/10/25 K.Ochiai [QC#22076, DEL] -->
        AND     DCBSS.GLBL_CMPY_CD               = DCBS.GLBL_CMPY_CD 
        AND     DCBSS.DS_CONTR_DTL_PK            = DCBS.DS_CONTR_DTL_PK
        AND     DCBSS.DS_CONTR_BLLG_SCHD_SMRY_PK = DCBS.DS_CONTR_BLLG_SCHD_SMRY_PK
        AND     DCBSS.GLBL_CMPY_CD               = BC.GLBL_CMPY_CD
<!-- START 2016/08/04 K.Kishimoto [QC#12426, MOD] -->
<!--    AND     DCBSS.BLLG_CYCLE_CD              = BC.BLLG_CYCLE_CD -->
        AND     DCBSS.PER_BLLG_CYCLE_CD          = BC.BLLG_CYCLE_CD
<!-- END 2016/08/04 K.Kishimoto [QC#12426, MOD] -->
        AND     DCBSS.EZCANCELFLAG               = '0'
        AND     DCBS.EZCANCELFLAG                = '0'
        AND     BC.EZCANCELFLAG                  = '0'
        GROUP BY
                DCBSS.EZUPTIME
               ,DCBSS.EZUPTIMEZONE
               ,DCBSS.DS_CONTR_BLLG_SCHD_SMRY_PK
               ,DCBSS.DS_CONTR_BLLG_SCHD_SQ_NUM
               ,DCBSS.DS_CONTR_PRC_EFF_SQ_NUM
               ,DCBSS.PER_SCHD_NUM
               ,DCBSS.PER_BLLG_CYCLE_CD
               ,DCBSS.BLLG_SCHD_FROM_DT
               ,DCBSS.BLLG_SCHD_THRU_DT
               ,DCBSS.BLLG_CYCLE_CD
               ,BC.BLLG_CYCLE_DESC_TXT
               ,DCBSS.BASE_PRC_DEAL_AMT
               ,DCBSS.BASE_PRC_DEAL_ADJ_AMT
               ,DCBSS.BASE_SUB_TOT_PRC_DEAL_AMT
               ,DCBSS.CCY_CD
               ,BC.BLLG_CYCLE_UOM_CD
<!-- START 2016/11/29 K.Ochiai [QC#14204, ADD] -->
               ,DCBSS.EZINTIME
               ,DCBSS.EZINUSERID
               ,DCBSS.EZUPUSERID
               ,DCBSS.EZTABLEID
<!-- END 2016/11/29 K.Ochiai [QC#14204, ADD] -->
        ORDER BY
               LPAD(DCBSS.DS_CONTR_BLLG_SCHD_SQ_NUM, 3, '0')
    </statement>

<!-- START 2016/11/17 T.Tomita [QC#15942, ADD] -->
    <statement id="getDsContrDtlPkListByAggMach" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            DCD.DS_CONTR_DTL_PK
        FROM
             DS_CONTR     DCH
            ,DS_CONTR_DTL DCD
        WHERE
                DCH.GLBL_CMPY_CD              = #glblCmpyCd#
            AND DCH.DS_CONTR_PK               = #dsContrPk#
            AND DCH.DS_CONTR_CATG_CD          = #dsContrCatgCd#
            AND DCH.EZCANCELFLAG              = '0'
            AND DCH.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
            AND DCH.DS_CONTR_PK               = DCD.DS_CONTR_PK
            AND DCD.DS_CONTR_DTL_TP_CD &lt;&gt; #dsContrDtlTpCd#
            <iterate property="dsContrDtlStsCdList" var="dsContrDtlStsCd[]" open="AND DCD.DS_CONTR_DTL_STS_CD NOT IN (" close=")" conjunction=",">
                #dsContrDtlStsCd[]#
            </iterate>
            AND DCD.EZCANCELFLAG              = '0'
            AND EXISTS (
                SELECT
                    1
                FROM
                    DS_CONTR_DTL_TP DTP
                WHERE
                        DTP.GLBL_CMPY_CD       = DCD.GLBL_CMPY_CD
                    AND DTP.DS_CONTR_DTL_TP_CD = DCD.DS_CONTR_DTL_TP_CD
                    AND DTP.BASE_CHRG_FLG      = 'Y'
                    AND DTP.EZCANCELFLAG       = '0'
            )
    </statement>

    <statement id="getDsContrDtlPkListByAgg" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             DCD.DS_CONTR_DTL_PK
            ,1 AS SORT_KEY
        FROM
             DS_CONTR     DCH
            ,DS_CONTR_DTL DCD
        WHERE
                DCH.GLBL_CMPY_CD              = #glblCmpyCd#
            AND DCH.DS_CONTR_PK               = #dsContrPk#
            AND DCH.DS_CONTR_CATG_CD          = #dsContrCatgCd#
            AND DCH.EZCANCELFLAG              = '0'
            AND DCH.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
            AND DCH.DS_CONTR_PK               = DCD.DS_CONTR_PK
            AND DCD.DS_CONTR_DTL_TP_CD        = #dsContrDtlTpCdIsAgg#
            <iterate property="dsContrDtlStsCdList" var="dsContrDtlStsCd[]" open="AND DCD.DS_CONTR_DTL_STS_CD NOT IN (" close=")" conjunction=",">
                #dsContrDtlStsCd[]#
            </iterate>
            AND DCD.EZCANCELFLAG              = '0'
        UNION
        SELECT
             DCD.DS_CONTR_DTL_PK
            ,2 AS SORT_KEY
        FROM
             DS_CONTR     DCH
            ,DS_CONTR_DTL DCD
        WHERE
                DCH.GLBL_CMPY_CD              = #glblCmpyCd#
            AND DCH.DS_CONTR_PK               = #dsContrPk#
            AND DCH.DS_CONTR_CATG_CD          = #dsContrCatgCd#
            AND DCH.EZCANCELFLAG              = '0'
            AND DCH.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
            AND DCH.DS_CONTR_PK               = DCD.DS_CONTR_PK
            <iterate property="dsContrDtlTpCdList" var="dsContrDtlTpCd[]" open="AND DCD.DS_CONTR_DTL_TP_CD NOT IN (" close=")" conjunction=",">
                #dsContrDtlTpCd[]#
            </iterate>
            <iterate property="dsContrDtlStsCdList" var="dsContrDtlStsCd[]" open="AND DCD.DS_CONTR_DTL_STS_CD NOT IN (" close=")" conjunction=",">
                #dsContrDtlStsCd[]#
            </iterate>
            AND DCD.EZCANCELFLAG              = '0'
            AND EXISTS (
                SELECT
                    1
                FROM
                    DS_CONTR_DTL_TP DTP
                WHERE
                        DTP.GLBL_CMPY_CD       = DCD.GLBL_CMPY_CD
                    AND DTP.DS_CONTR_DTL_TP_CD = DCD.DS_CONTR_DTL_TP_CD
                    AND DTP.BASE_CHRG_FLG      = 'Y'
                    AND DTP.EZCANCELFLAG       = '0'
            )
        UNION
        SELECT
             DCD.DS_CONTR_DTL_PK
            ,3 AS SORT_KEY
        FROM
             DS_CONTR     DCH
            ,DS_CONTR_DTL DCD
        WHERE
                DCH.GLBL_CMPY_CD              = #glblCmpyCd#
            AND DCH.DS_CONTR_PK               = #dsContrPk#
            AND DCH.DS_CONTR_CATG_CD          = #dsContrCatgCd#
            AND DCH.EZCANCELFLAG              = '0'
            AND DCH.GLBL_CMPY_CD              = DCD.GLBL_CMPY_CD
            AND DCH.DS_CONTR_PK               = DCD.DS_CONTR_PK
            AND DCD.DS_CONTR_DTL_TP_CD        = #dsContrDtlTpCdIsAcc#
            <iterate property="dsContrDtlStsCdList" var="dsContrDtlStsCd[]" open="AND DCD.DS_CONTR_DTL_STS_CD NOT IN (" close=")" conjunction=",">
                #dsContrDtlStsCd[]#
            </iterate>
            AND DCD.EZCANCELFLAG              = '0'
            AND EXISTS (
                SELECT
                    1
                FROM
                    DS_CONTR_DTL_TP DTP
                WHERE
                        DTP.GLBL_CMPY_CD       = DCD.GLBL_CMPY_CD
                    AND DTP.DS_CONTR_DTL_TP_CD = DCD.DS_CONTR_DTL_TP_CD
                    AND DTP.BASE_CHRG_FLG      = 'Y'
                    AND DTP.EZCANCELFLAG       = '0'
            )
        ORDER BY
            SORT_KEY
    </statement>
<!-- END 2016/11/17 T.Tomita [QC#15942, ADD] -->
<!-- START 2017/12/11 U.Kim [QC#18879, ADD]-->
    <statement id="getBllgDays" parameterClass="Map" resultClass="String">
        SELECT
            BDT.BLLG_DAYS_AOT
        FROM
             BLLG_DAY_TP   BDT
            ,DS_CONTR_DTL  DCD
        WHERE
                BDT.GLBL_CMPY_CD     = #glblCmpyCd#
            AND BDT.BASE_CHRG_FLG    = #flgOn#
            AND BDT.EZCANCELFLAG     = '0'
            AND BDT.GLBL_CMPY_CD     = DCD.GLBL_CMPY_CD
            AND BDT.BLLG_TMG_TP_CD   = DCD.BASE_BLLG_TMG_CD
            AND DCD.DS_CONTR_DTL_PK  = #dsContrDtlPk#
            AND DCD.EZCANCELFLAG     = '0'
        ORDER BY
            BDT.BLLG_DAY_TP_SORT_NUM  ASC
    </statement>
<!-- END 2017/12/11 U.Kim [QC#18879, ADD]-->
</sqlMap>
