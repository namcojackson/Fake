<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NPZC130001">

    <statement id="SPECIFY_APVL_POSN_CD" parameterClass="Map" resultClass="Map">
    --01.PO
    --04.PO Requisition
    --05.Inventory Request
    --1).Specify Approval position code
<!-- 12/07/2017 Sol:304  QC#18750 Mod Start. -->
        SELECT
             RSLT.PSN_CD AS COND_STR_9
            ,RSLT.APVL_TEAM_POSN_LAYER_NUM AS COND_NUM_2
            ,RSLT.APVL_TEAM_PK AS COND_NUM_3
            ,RSLT.DEC_COND
            ,CASE 
             WHEN  RSLT.DEC_COND = 'Next2'
             THEN '1'
             ELSE ''
             END AS COND_STR_10
        FROM (
                SELECT   TOT.PSN_CD
                        ,TOT.APVL_TEAM_POSN_LAYER_NUM
                        ,TOT.APVL_TEAM_PK AS APVL_TEAM_PK
                        ,CASE WHEN PSN_CD = #condStr1# THEN 'Next2' ELSE 'Next' END DEC_COND
                FROM    (
                        SELECT   ATM.APVL_TEAM_MBR_PK
                                ,ATM.APVL_TEAM_PK
                                ,ATM.APVL_TEAM_POSN_TP_CD_ATM
                                ,ATM.PSN_CD
                                ,ATM.APVL_TEAM_POSN_TP_CD_ATP
                                ,ATM.APVL_TEAM_POSN_TP_NM
                                ,ATM.APVL_TEAM_POSN_TP_SORT_NUM
                                ,ATM.APVL_TEAM_POSN_TP_DESC_TXT
                                ,ATM.APVL_TEAM_POSN_LAYER_NUM
                                ,ATM.SORT_PSN_CD
                        FROM    (
                                    SELECT   INLINE1.APVL_TEAM_MBR_PK
                                            ,INLINE1.APVL_TEAM_PK
                                            ,INLINE1.APVL_TEAM_POSN_TP_CD APVL_TEAM_POSN_TP_CD_ATM
                                            ,INLINE1.PSN_CD
                                            ,INLINE2.APVL_TEAM_POSN_TP_CD APVL_TEAM_POSN_TP_CD_ATP
                                            ,INLINE2.APVL_TEAM_POSN_TP_NM
                                            ,INLINE2.APVL_TEAM_POSN_TP_SORT_NUM
                                            ,INLINE2.APVL_TEAM_POSN_TP_DESC_TXT
                                            ,INLINE2.APVL_TEAM_POSN_LAYER_NUM
                                            ,CASE WHEN INLINE1.PSN_CD =  #condStr1#  THEN '1' ELSE '2' END SORT_PSN_CD
                                    FROM    APVL_TEAM_MBR INLINE1
                                            ,APVL_TEAM_POSN_TP INLINE2
                                            ,(
                                                SELECT  DISTINCT(INLINE1.APVL_TEAM_PK) AS APVL_TEAM_PK_DIST
                                                FROM    APVL_TEAM_MBR INLINE1
                                                       ,APVL_TEAM     INLINE2
                                                WHERE   INLINE1.GLBL_CMPY_CD = #glblCmpyCd#
                                                AND     INLINE1.PSN_CD       =  #condStr1#
                                                AND     INLINE1.EZCANCELFLAG = '0'
                                                AND     INLINE2.GLBL_CMPY_CD = INLINE1.GLBL_CMPY_CD
                                                AND     INLINE2.APVL_TEAM_PK = INLINE1.APVL_TEAM_PK
                                                AND     INLINE2.EZCANCELFLAG = '0'
                                            ) INLINE3
                                    WHERE    INLINE1.GLBL_CMPY_CD              = #glblCmpyCd#
                                    AND        INLINE1.GLBL_CMPY_CD            = INLINE2.GLBL_CMPY_CD
                                    AND        INLINE1.APVL_TEAM_POSN_TP_CD    = INLINE2.APVL_TEAM_POSN_TP_CD
                                    AND        INLINE1.APVL_TEAM_PK            = INLINE3.APVL_TEAM_PK_DIST
                                    AND        INLINE1.EZCANCELFLAG            = '0'
                                    AND        INLINE2.EZCANCELFLAG            = '0'
                                ) ATM
                                ,(
                                   SELECT * 
                                   FROM
                                   (
                                      SELECT
                                              INLINE1.APVL_TEAM_PK
                                             ,APVL_TEAM_POSN_LAYER_NUM
<!-- START [QC#61590, MOD]-->
                                             ,RANK() OVER(PARTITION BY INLINE2.APVL_LIMIT_AMT ORDER BY PRCH_REQ_TP_CD NULLS LAST, APVL_TEAM_POSN_LAYER_NUM) RK
<!-- END [QC#61590, MOD]-->
                                      FROM
                                             APVL_TEAM_TRX INLINE1
                                            ,APVL_LIMIT INLINE2
                                            ,APVL_TEAM_POSN_TP INLINE3
                                      WHERE
                                               INLINE1.GLBL_CMPY_CD             = #glblCmpyCd#
                                      AND      (INLINE1.PRCH_GRP_CD             = #condStr4# OR NVL(INLINE1.PRCH_GRP_CD,'*') = '*' )
                                      AND      INLINE1.APVL_HIST_SRC_TP_CD      = #condStr3#
                                      AND      (INLINE1.PO_MDSE_TP_CD           = #condStr6# OR NVL(INLINE1.PO_MDSE_TP_CD,'*') = '*' )
                                      AND      INLINE1.GLBL_CMPY_CD             = INLINE2.GLBL_CMPY_CD
                                      AND      INLINE1.APVL_HIST_SRC_TP_CD      = INLINE2.APVL_HIST_SRC_TP_CD
                                      AND      (INLINE2.PRCH_GRP_CD             = #condStr4# OR NVL(INLINE2.PRCH_GRP_CD,'*') = '*' )
                                      AND      INLINE1.GLBL_CMPY_CD             = INLINE3.GLBL_CMPY_CD
                                      AND      INLINE2.APVL_TEAM_POSN_TP_CD     = INLINE3.APVL_TEAM_POSN_TP_CD
                                      AND      INLINE2.APVL_LIMIT_AMT       &gt;= #condNum1#
<!-- START [QC#61590, ADD]-->
                                      <isNotNull property="condStr7">
                                      AND      INLINE2.PRCH_REQ_TP_CD       = #condStr7#
                                      </isNotNull>
<!-- END [QC#61590, ADD]-->
                                      AND      INLINE1.EZCANCELFLAG             = '0'
                                      AND      INLINE2.EZCANCELFLAG             = '0'
                                      AND      INLINE3.EZCANCELFLAG             = '0'
                                      UNION ALL
                                      SELECT
                                              INLINE1.APVL_TEAM_PK
                                              ,99
<!-- START [QC#61590, MOD]-->
                                             ,RANK() OVER(PARTITION BY INLINE2.APVL_LIMIT_AMT ORDER BY PRCH_REQ_TP_CD NULLS LAST, APVL_TEAM_POSN_LAYER_NUM) RK
<!-- END [QC#61590, MOD]-->
                                      FROM
                                             APVL_TEAM_TRX INLINE1
                                            ,APVL_LIMIT INLINE2
                                            ,APVL_TEAM_POSN_TP INLINE3
                                            ,APVL_TEAM_MBR INLINE4
                                      WHERE
                                               INLINE1.GLBL_CMPY_CD             = #glblCmpyCd#
                                      AND      (INLINE1.PRCH_GRP_CD             = #condStr4# OR NVL(INLINE1.PRCH_GRP_CD,'*') = '*' )
                                      AND      INLINE1.APVL_HIST_SRC_TP_CD      = #condStr3#
                                      AND      (INLINE1.PO_MDSE_TP_CD           = #condStr6# OR NVL(INLINE1.PO_MDSE_TP_CD,'*') = '*' )
                                      AND      INLINE1.GLBL_CMPY_CD             = INLINE2.GLBL_CMPY_CD
                                      AND      INLINE1.APVL_HIST_SRC_TP_CD      = INLINE2.APVL_HIST_SRC_TP_CD
                                      AND      (INLINE2.PRCH_GRP_CD             = #condStr4# OR NVL(INLINE2.PRCH_GRP_CD,'*') = '*' )
                                      AND      INLINE1.GLBL_CMPY_CD             = INLINE3.GLBL_CMPY_CD
                                      AND      INLINE2.APVL_TEAM_POSN_TP_CD     = INLINE3.APVL_TEAM_POSN_TP_CD
                                      AND      INLINE2.APVL_LIMIT_AMT       &gt;= #condNum1#
<!-- START [QC#61590, ADD]-->
                                     <isNotNull property="condStr7">
                                      AND      INLINE2.PRCH_REQ_TP_CD       = #condStr7#
                                     </isNotNull>
<!-- END [QC#61590, ADD]-->
                                      AND      INLINE1.EZCANCELFLAG             = '0'
                                      AND      INLINE2.EZCANCELFLAG             = '0'
                                      AND      INLINE3.EZCANCELFLAG             = '0'
                                      AND      INLINE4.EZCANCELFLAG             = '0'  
                                      AND      INLINE1.APVL_TEAM_PK             = INLINE4.APVL_TEAM_PK
                                      AND      INLINE3.APVL_TEAM_POSN_TP_CD     = INLINE4.APVL_TEAM_POSN_TP_CD
                                      AND      INLINE4.PSN_CD                   = #condStr1#
                                    )
                                    WHERE RK = 1
                                ) ATT
                        WHERE    ATM.APVL_TEAM_PK = ATT.APVL_TEAM_PK
                        AND        ATM.APVL_TEAM_PK = ATT.APVL_TEAM_PK
                        <!-- 02/08/2017 QC#17476 Mod Start. -->
                        AND        ATM.APVL_TEAM_POSN_LAYER_NUM &lt;= ATT.APVL_TEAM_POSN_LAYER_NUM
                        <!-- 02/08/2017 QC#17476 Mod End. -->
                        AND        (
                                    EXISTS    (
                                                SELECT   INLINE1.APVL_TEAM_PK
                                                FROM     APVL_TEAM_LOC INLINE1
                                                WHERE    INLINE1.GLBL_CMPY_CD = #glblCmpyCd#
                                                AND      INLINE1.RTL_WH_CD    = #condStr5#
                                                AND      INLINE1.APVL_TEAM_PK = ATM.APVL_TEAM_PK
                                                AND      INLINE1.EZCANCELFLAG = '0'
                                            )
                                    OR
                                    NOT EXISTS (
                                                SELECT    INLINE1.APVL_TEAM_PK
                                                FROM      APVL_TEAM_LOC INLINE1
                                                WHERE     INLINE1.GLBL_CMPY_CD = #glblCmpyCd#
                                                AND       INLINE1.APVL_TEAM_PK = ATM.APVL_TEAM_PK
                                                AND       INLINE1.EZCANCELFLAG = '0'
                                               )
                                )
                        ORDER BY ATM.SORT_PSN_CD
                               , ATM.APVL_TEAM_POSN_LAYER_NUM DESC
                               , ATM.PSN_CD
                    ) TOT
                WHERE    ROWNUM = 1
            UNION ALL
            SELECT 
                    'DEF' AS PSN_CD,
                    -1 AS APVL_TEAM_POSN_LAYER_NUM,
                    -1 AS APVL_TEAM_PK,
                    'Next' AS DEC_COND
            FROM
                   APVL_TEAM APT
            WHERE
                   APT.GLBL_CMPY_CD = #glblCmpyCd#
            AND    APT.EZCANCELFLAG = '0'
            AND    ROWNUM           = 1
        ) RSLT
        WHERE    ROWNUM = 1
<!-- 11/28/2017 Sol:304  QC#18750 Mod End. -->
    </statement>

    <statement id="SPECIFY_APVL_PSN_CD_BY_APVL_TEAM_POSN" parameterClass="Map" resultClass="Map">
    --2).Specify Approval Person code by Approval team/Position
<!-- 11/28/2017 Sol:304  QC#18750 Mod Start. -->
<!--
        WITH APLV AS ( 
             SELECT 
                     DISTINCT INLINE1.PSN_CD AS VAL_STR_1
             FROM
                     APVL_TEAM_MBR INLINE1
                    ,APVL_TEAM_POSN_TP INLINE2
                    ,(
                         SELECT
                                 DISTINCT(INLINE1.APVL_TEAM_PK) AS APVL_TEAM_PK_DIST
                         FROM
                                 APVL_TEAM_MBR INLINE1
                                ,APVL_TEAM     INLINE2
                         WHERE
                                 INLINE1.GLBL_CMPY_CD = #glblCmpyCd#
                         AND     INLINE1.PSN_CD       = #condStr1#
                         AND     INLINE1.EZCANCELFLAG = '0'
                         AND     INLINE2.GLBL_CMPY_CD = INLINE1.GLBL_CMPY_CD
                         AND     INLINE2.APVL_TEAM_PK = INLINE1.APVL_TEAM_PK
                         AND     INLINE2.APVL_TEAM_PK = #condNum3#
                         AND     INLINE2.EZCANCELFLAG = '0'
                     ) INLINE3
             WHERE
                     INLINE1.GLBL_CMPY_CD                = #glblCmpyCd# 
                 AND INLINE1.GLBL_CMPY_CD                = INLINE2.GLBL_CMPY_CD
                 AND INLINE1.APVL_TEAM_POSN_TP_CD        = INLINE2.APVL_TEAM_POSN_TP_CD
                 AND INLINE1.APVL_TEAM_PK                = INLINE3.APVL_TEAM_PK_DIST
                 AND INLINE2.APVL_TEAM_POSN_LAYER_NUM    = (
                                                           SELECT
                                                                    MIN(INLINE2.APVL_TEAM_POSN_LAYER_NUM)
                                                           FROM
                                                                    APVL_TEAM_MBR     INLINE1
                                                                   ,APVL_TEAM_POSN_TP INLINE2
                                                                   ,(
                                                                      SELECT
                                                                              DISTINCT(INLINE1.APVL_TEAM_PK) AS APVL_TEAM_PK_DIST
                                                                      FROM
                                                                              APVL_TEAM_MBR INLINE1
                                                                             ,APVL_TEAM     INLINE2
                                                                      WHERE
                                                                              INLINE1.GLBL_CMPY_CD = #glblCmpyCd#
                                                                      AND     INLINE1.PSN_CD       =  #condStr1#
                                                                      AND     INLINE1.EZCANCELFLAG = '0'
                                                                      AND     INLINE2.GLBL_CMPY_CD = INLINE1.GLBL_CMPY_CD
                                                                      AND     INLINE2.APVL_TEAM_PK = INLINE1.APVL_TEAM_PK
                                                                      AND     INLINE2.APVL_TEAM_PK = #condNum3#
                                                                      AND     INLINE2.EZCANCELFLAG = '0'
                                                                   ) INLINE3
                                                           WHERE INLINE1.GLBL_CMPY_CD                = #glblCmpyCd#
                                                           AND INLINE1.GLBL_CMPY_CD                  = INLINE2.GLBL_CMPY_CD
                                                           AND INLINE1.APVL_TEAM_POSN_TP_CD          = INLINE2.APVL_TEAM_POSN_TP_CD
                                                           AND INLINE1.APVL_TEAM_PK                  = INLINE3.APVL_TEAM_PK_DIST
                                                           AND INLINE2.APVL_TEAM_POSN_LAYER_NUM  &gt;= #condNum2#
                                                           AND INLINE1.EZCANCELFLAG                  = '0'
                                                           AND INLINE2.EZCANCELFLAG                  = '0'
                                                       )
                 AND INLINE1.EZCANCELFLAG = '0'
                 AND INLINE2.EZCANCELFLAG = '0'
                 AND #condNum3#    &lt;&gt; -1

             UNION

             SELECT
                 DISTINCT
                 ATM.PSN_CD AS VAL_STR_1
             FROM
                 APVL_TEAM_MBR ATM
             WHERE ATM.GLBL_CMPY_CD      = #glblCmpyCd#
                 AND    ATM.APVL_TEAM_PK = '-1'
                 AND    ATM.EZCANCELFLAG = '0'
                 AND    #condNum3#       = -1
               )
         SELECT
              VAL_STR_1
             ,#condStr1# AS COND_STR_1
         FROM
           (SELECT VAL_STR_1 FROM APLV ORDER BY VAL_STR_1) 
         WHERE
           ROWNUM &lt;= 1
-->
        SELECT
               AP.PSN_CD                    AS VAL_STR_1
              ,#condStr1#                   AS COND_STR_1
          FROM (
                SELECT
                       ATM.PSN_CD
                      ,ATPT.APVL_TEAM_POSN_LAYER_NUM
                      ,RANK() OVER(PARTITION BY ATM.APVL_TEAM_POSN_TP_CD ORDER BY ATM.PSN_CD) RK
                  FROM
                       APVL_TEAM_MBR     ATM
                      ,APVL_TEAM_POSN_TP ATPT
                      ,(
                        SELECT 
                               AT.GLBL_CMPY_CD
                              ,AT.APVL_TEAM_PK
                              ,ATM2.APVL_TEAM_POSN_TP_CD 
                          FROM 
                               APVL_TEAM     AT
                              ,APVL_TEAM_MBR ATM2
                         WHERE AT.GLBL_CMPY_CD    = #glblCmpyCd#
                           AND AT.GLBL_CMPY_CD    = ATM2.GLBL_CMPY_CD
                           AND AT.APVL_TEAM_PK    = ATM2.APVL_TEAM_PK
                           AND AT.APVL_TEAM_PK    = #condNum3#
                           AND ATM2.PSN_CD        = #condStr1#
                           AND AT.EZCANCELFLAG    = '0'
                           AND ATM2.EZCANCELFLAG  = '0'
                        ) T_M
                 WHERE 
                       ATM.GLBL_CMPY_CD               = #glblCmpyCd#
                   AND ATM.GLBL_CMPY_CD               = ATPT.GLBL_CMPY_CD
                   AND ATM.APVL_TEAM_POSN_TP_CD       = ATPT.APVL_TEAM_POSN_TP_CD 
                   AND ATM.GLBL_CMPY_CD               = T_M.GLBL_CMPY_CD
                   AND ATM.APVL_TEAM_PK               = T_M.APVL_TEAM_PK
                   AND ATM.APVL_TEAM_POSN_TP_CD       &lt; T_M.APVL_TEAM_POSN_TP_CD
                   AND ATPT.APVL_TEAM_POSN_LAYER_NUM  &gt;= #condNum2#
                   AND ATM.EZCANCELFLAG               = '0'
                   AND ATPT.EZCANCELFLAG              = '0'
                 ORDER BY ATPT.APVL_TEAM_POSN_LAYER_NUM DESC
                ) AP
         WHERE
               AP.RK = 1
         UNION ALL
        SELECT
               DISTINCT
               ATM.PSN_CD   AS VAL_STR_1
              ,#condStr1#   AS COND_STR_1
          FROM
               APVL_TEAM_MBR ATM
         WHERE 
               ATM.GLBL_CMPY_CD   = #glblCmpyCd#
           AND ATM.APVL_TEAM_PK   = -1
           AND ATM.EZCANCELFLAG   = '0'
           AND #condNum3#         = -1
           AND ROWNUM             &lt;= 1
<!-- 11/28/2017 Sol:304  QC#18750 Mod End. -->
    </statement>

    <statement id="SPECIFY_APVL_PSN_CD_GRP_BY_APVL_TEAM_POSN" parameterClass="Map" resultClass="Map">
    --3).set group
     <isEqual property="condStr10" compareValue="1">
         SELECT
          '' AS BIZ_ID
          , '' AS USER_GROUP_NAME
          , '' AS USER_GROUP_LEVEL
          , '' AS WF_USR_ID 
         FROM
           DUAL 
         WHERE
           ROWNUM  &gt;= 2
     </isEqual>
     <isNotEqual property="condStr10" compareValue="1">
<!-- 11/28/2017 Sol:304  QC#18750 Mod Start. -->
<!--
        WITH APLV AS ( 
             SELECT 
                     DISTINCT INLINE1.PSN_CD AS VAL_STR_1

             FROM    APVL_TEAM_MBR INLINE1
                    ,APVL_TEAM_POSN_TP INLINE2
                    ,(
                         SELECT  DISTINCT(INLINE1.APVL_TEAM_PK) AS APVL_TEAM_PK_DIST
                         FROM    APVL_TEAM_MBR INLINE1
                                ,APVL_TEAM     INLINE2
                         WHERE   INLINE1.GLBL_CMPY_CD = #glblCmpyCd#
                         AND     INLINE1.PSN_CD       = #condStr1#
                         AND     INLINE1.EZCANCELFLAG = '0'
                         AND     INLINE2.GLBL_CMPY_CD = INLINE1.GLBL_CMPY_CD
                         AND     INLINE2.APVL_TEAM_PK = INLINE1.APVL_TEAM_PK
                         AND     INLINE2.APVL_TEAM_PK = #condNum3#
                         AND     INLINE2.EZCANCELFLAG = '0'
                     ) INLINE3

             WHERE
                     INLINE1.GLBL_CMPY_CD                = #glblCmpyCd# 
                 AND INLINE1.GLBL_CMPY_CD                = INLINE2.GLBL_CMPY_CD
                 AND INLINE1.APVL_TEAM_POSN_TP_CD        = INLINE2.APVL_TEAM_POSN_TP_CD
                 AND INLINE1.APVL_TEAM_PK                = INLINE3.APVL_TEAM_PK_DIST
                 AND INLINE2.APVL_TEAM_POSN_LAYER_NUM    = (
                                                           SELECT  MIN(INLINE2.APVL_TEAM_POSN_LAYER_NUM)
                                                           FROM    APVL_TEAM_MBR INLINE1
                                                                   ,APVL_TEAM_POSN_TP INLINE2
                                                                   ,(
                                                                      SELECT  DISTINCT(INLINE1.APVL_TEAM_PK) AS APVL_TEAM_PK_DIST
                                                                      FROM    APVL_TEAM_MBR INLINE1
                                                                             ,APVL_TEAM     INLINE2
                                                                      WHERE   INLINE1.GLBL_CMPY_CD = #glblCmpyCd#
                                                                      AND     INLINE1.PSN_CD       =  #condStr1#
                                                                      AND     INLINE1.EZCANCELFLAG = '0'
                                                                      AND     INLINE2.GLBL_CMPY_CD = INLINE1.GLBL_CMPY_CD
                                                                      AND     INLINE2.APVL_TEAM_PK = INLINE1.APVL_TEAM_PK
                                                                      AND     INLINE2.APVL_TEAM_PK = #condNum3#
                                                                      AND     INLINE2.EZCANCELFLAG = '0'
                                                                   ) INLINE3
                                                           WHERE INLINE1.GLBL_CMPY_CD                = #glblCmpyCd#
                                                           AND INLINE1.GLBL_CMPY_CD                  = INLINE2.GLBL_CMPY_CD
                                                           AND INLINE1.APVL_TEAM_POSN_TP_CD          = INLINE2.APVL_TEAM_POSN_TP_CD
                                                           AND INLINE1.APVL_TEAM_PK                  = INLINE3.APVL_TEAM_PK_DIST
                                                           AND INLINE2.APVL_TEAM_POSN_LAYER_NUM  &gt;= #condNum2#
                                                           AND INLINE1.EZCANCELFLAG                  = '0'    
                                                           AND INLINE2.EZCANCELFLAG                  = '0'    
                                                       )
                 AND INLINE1.EZCANCELFLAG = '0'
                 AND INLINE2.EZCANCELFLAG = '0'
                 AND #condNum3#    &lt;&gt; -1

             UNION

             SELECT
                 DISTINCT
                 ATM.PSN_CD AS VAL_STR_1
             FROM
                 APVL_TEAM_MBR ATM
             WHERE ATM.GLBL_CMPY_CD      = #glblCmpyCd#
                 AND    ATM.APVL_TEAM_PK = '-1'
                 AND    ATM.EZCANCELFLAG = '0'
                 AND    #condNum3#       = -1
               )
         SELECT
                'NPZC1300'       AS BIZ_ID
                , 'GRP_APVL_PSN' AS USER_GROUP_NAME
                , '000'          AS USER_GROUP_LEVEL
                , AP.VAL_STR_1   AS WF_USR_ID 
         FROM
           (SELECT VAL_STR_1,ROWNUM APLVROWNUM FROM APLV ORDER BY VAL_STR_1) AP
         WHERE
           AP.APLVROWNUM &gt;= 2
-->
         SELECT
                'NPZC1300'        AS BIZ_ID
               ,'GRP_APVL_PSN'    AS USER_GROUP_NAME
               ,TO_CHAR(ALR.NUM)  AS USER_GROUP_LEVEL
               ,AP.PSN_CD         AS WF_USR_ID
           FROM (
                 SELECT
                        ATM.PSN_CD
                       ,ATM.APVL_TEAM_POSN_TP_CD
                       ,RANK() OVER(PARTITION BY ATM.APVL_TEAM_POSN_TP_CD ORDER BY ATM.PSN_CD) RK
                   FROM
                        APVL_TEAM_MBR     ATM
                       ,APVL_TEAM_POSN_TP ATPT
                       ,(
                         SELECT 
                                AT.GLBL_CMPY_CD
                               ,AT.APVL_TEAM_PK
                               ,ATM2.APVL_TEAM_POSN_TP_CD
                           FROM 
                                APVL_TEAM     AT
                               ,APVL_TEAM_MBR ATM2
                          WHERE 
                                AT.GLBL_CMPY_CD    = #glblCmpyCd#
                            AND AT.GLBL_CMPY_CD    = ATM2.GLBL_CMPY_CD
                            AND AT.APVL_TEAM_PK    = ATM2.APVL_TEAM_PK
                            AND AT.APVL_TEAM_PK    = #condNum3#
                            AND ATM2.PSN_CD        = #condStr1#
                            AND AT.EZCANCELFLAG    = '0'
                            AND ATM2.EZCANCELFLAG  = '0'
                        ) T_M
                 WHERE 
                       ATM.GLBL_CMPY_CD               = #glblCmpyCd#
                   AND ATM.GLBL_CMPY_CD               = ATPT.GLBL_CMPY_CD
                   AND ATM.APVL_TEAM_POSN_TP_CD       = ATPT.APVL_TEAM_POSN_TP_CD 
                   AND ATM.GLBL_CMPY_CD               = T_M.GLBL_CMPY_CD
                   AND ATM.APVL_TEAM_PK               = T_M.APVL_TEAM_PK
                   AND ATM.APVL_TEAM_POSN_TP_CD       &lt; T_M.APVL_TEAM_POSN_TP_CD
                   AND ATPT.APVL_TEAM_POSN_LAYER_NUM  &gt;= #condNum2#
                   AND ATM.EZCANCELFLAG               = '0'
                   AND ATPT.EZCANCELFLAG              = '0'
                ) AP
               ,(
                 SELECT
                        ROWNUM                  AS NUM
                       ,AL.APVL_TEAM_POSN_TP_CD
                   FROM
                       (
                        SELECT
                              DISTINCT
                              ATM3.APVL_TEAM_POSN_TP_CD
                         FROM 
                              APVL_TEAM_MBR     ATM3
                             ,APVL_TEAM_POSN_TP ATPT2
                             ,(
                               SELECT
                                      AT2.GLBL_CMPY_CD
                                     ,AT2.APVL_TEAM_PK
                                     ,ATM4.APVL_TEAM_POSN_TP_CD 
                                 FROM 
                                      APVL_TEAM     AT2
                                     ,APVL_TEAM_MBR ATM4
                                WHERE 
                                      AT2.GLBL_CMPY_CD  = #glblCmpyCd#
                                  AND AT2.GLBL_CMPY_CD  = ATM4.GLBL_CMPY_CD
                                  AND AT2.APVL_TEAM_PK  = ATM4.APVL_TEAM_PK
                                  AND ATM4.PSN_CD       = #condStr1#
                                  AND AT2.EZCANCELFLAG  = '0'
                                  AND ATM4.EZCANCELFLAG = '0'
                              ) M
                        WHERE 
                              ATM3.GLBL_CMPY_CD               = #glblCmpyCd#
                          AND ATM3.GLBL_CMPY_CD               = M.GLBL_CMPY_CD
                          AND ATM3.GLBL_CMPY_CD               = ATPT2.GLBL_CMPY_CD
                          AND ATM3.APVL_TEAM_POSN_TP_CD       = ATPT2.APVL_TEAM_POSN_TP_CD 
                          AND ATM3.APVL_TEAM_PK               = M.APVL_TEAM_PK
                          AND ATM3.APVL_TEAM_POSN_TP_CD       &lt; M.APVL_TEAM_POSN_TP_CD
                          AND ATPT2.APVL_TEAM_POSN_LAYER_NUM  &gt;= #condNum2#
                          AND ATM3.EZCANCELFLAG               = '0'
                          AND ATPT2.EZCANCELFLAG              = '0'
                        ORDER BY ATM3.APVL_TEAM_POSN_TP_CD DESC
                       ) AL
                ) ALR
         WHERE
               AP.RK &gt; 1
           AND AP.APVL_TEAM_POSN_TP_CD = ALR.APVL_TEAM_POSN_TP_CD
         UNION
         SELECT
                'NPZC1300'     AS BIZ_ID
               ,'GRP_APVL_PSN' AS USER_GROUP_NAME
               ,'1'            AS USER_GROUP_LEVEL
               ,VAL_STR_1      AS WF_USR_ID
           FROM 
               (
                SELECT
                       ATM.PSN_CD   AS VAL_STR_1
                      ,#condStr1#   AS COND_STR_1
                      ,ROWNUM       AS NUM2
                  FROM
                       APVL_TEAM_MBR ATM
                 WHERE
                       ATM.GLBL_CMPY_CD = #glblCmpyCd#
                   AND ATM.APVL_TEAM_PK = -1
                   AND ATM.EZCANCELFLAG = '0'
                   AND #condNum3#       = -1
               ) A
         WHERE A.NUM2 &gt;= 2
         ORDER BY USER_GROUP_LEVEL
<!-- 11/28/2017 Sol:304  QC#18750 Mod End. -->
     </isNotEqual>
    </statement>

    <statement id="SPECIFY_APVL_POSN_CD_2" parameterClass="Map" resultClass="Map">
         SELECT
            #condStr9# AS VAL_STR_1
           ,#condStr1# AS COND_STR_1
         FROM
           DUAL
    </statement>

    <statement id="GET_REASIGN_USR_BY_TEAM_POSN_LAYER_NUM" parameterClass="Map" resultClass="Map">
    --01.PO REASIGN_
    --04.PO Requisition REASIGN_
    --05.Inventory Request REASIGN_
        WITH VIEW01 AS (
             SELECT 
                     DISTINCT INLINE1.PSN_CD

             FROM    APVL_TEAM_MBR INLINE1
                    ,APVL_TEAM_POSN_TP INLINE2
                    ,(
                         SELECT
                                 DISTINCT(INLINE1.APVL_TEAM_PK) AS APVL_TEAM_PK_DIST
                         FROM
                                 APVL_TEAM_MBR INLINE1
                                ,APVL_TEAM     INLINE2
                         WHERE
                                 INLINE1.GLBL_CMPY_CD = #glblCmpyCd#
                         AND     INLINE1.PSN_CD       = #condStr1#
                         AND     INLINE1.EZCANCELFLAG = '0'
                         AND     INLINE2.GLBL_CMPY_CD = INLINE1.GLBL_CMPY_CD
                         AND     INLINE2.APVL_TEAM_PK = INLINE1.APVL_TEAM_PK
                         AND     INLINE2.APVL_TEAM_PK = #condNum3#
                         AND     INLINE2.EZCANCELFLAG = '0'
                     ) INLINE3

             WHERE
                     INLINE1.GLBL_CMPY_CD                     = #glblCmpyCd# 
                 AND INLINE1.GLBL_CMPY_CD                     = INLINE2.GLBL_CMPY_CD
                 AND INLINE1.APVL_TEAM_POSN_TP_CD             = INLINE2.APVL_TEAM_POSN_TP_CD
                 AND INLINE1.APVL_TEAM_PK                     = INLINE3.APVL_TEAM_PK_DIST
                 AND INLINE1.PSN_CD                    &lt;&gt; #condStr1#
                 AND INLINE2.APVL_TEAM_POSN_LAYER_NUM     &gt;= #condNum2#
                 AND INLINE1.EZCANCELFLAG = '0'
                 AND INLINE2.EZCANCELFLAG = '0'
                 AND #condNum3#   &lt;&gt;  -1

             UNION

             SELECT
                    DISTINCT
                    ATM.PSN_CD
             FROM
                    APVL_TEAM_MBR ATM
             WHERE
                    ATM.GLBL_CMPY_CD = #glblCmpyCd#
               AND  ATM.APVL_TEAM_PK = -1
               AND  ATM.EZCANCELFLAG = '0'
               AND  #condNum3#       = -1
            )
         SELECT
                  'NPZC130001'      AS BIZ_ID
                , 'GRP_REASIGN_PSN' AS USER_GROUP_NAME
                , '000'             AS USER_GROUP_LEVEL
                , VIEW01.PSN_CD     AS WF_USR_ID 
         FROM
           VIEW01
    </statement>

    <statement id="CHECK_APVL_LIMIT_BY_REQUESTER" parameterClass="Map" resultClass="Map">
    --02.Tech Parts Request
    --1).Check Aprroval Limit by Requester
        SELECT
             RSLT.PSN_CD AS COND_STR_9
            ,RSLT.DEC_COND
        FROM
        (
            SELECT
                  AL.PSN_CD
                , CASE WHEN AL.APVL_LIMIT_AMT &gt;= #condNum1# THEN 'Next2' ELSE 'Next' END AS DEC_COND
                , 1 AS SORT_NUM
            FROM
                  APVL_LIMIT AL
            WHERE
                  AL.GLBL_CMPY_CD           = #glblCmpyCd#
              AND AL.APVL_HRCH_TP_CD        = #condStr2#
              AND AL.PSN_CD                 = #condStr1#
              AND (AL.PRCH_GRP_CD           = #condStr4# OR NVL(AL.PRCH_GRP_CD,'*') = '*' )
              AND AL.APVL_HIST_SRC_TP_CD    = #condStr3#
              AND AL.EZCANCELFLAG           = '0'
            <!-- START 05/27/2020 [QC#56548,MOD] -->
            <!-- 11/28/2017 Sol:303  QC#18689 Mod Start. -->
            UNION ALL
            SELECT 
	              S_P.PSN_CD
                , CASE WHEN T_A_T.TECH_APVL_THRHD_AMT &gt;= #condNum1# THEN 'Next2' ELSE 'Next' END AS DEC_COND
                , 2 AS SORT_NUM
            <!-- FROM  AUTH_PSN        A_P  -->
            FROM  S21_PSN         S_P
                 ,TECH_APVL_THRHD T_A_T
            WHERE
            <!-- A_P.GLBL_CMPY_CD           = #glblCmpyCd# -->
                 S_P.GLBL_CMPY_CD           = #glblCmpyCd#
            <!-- AND A_P.GLBL_CMPY_CD           = S_P.GLBL_CMPY_CD -->
             AND S_P.GLBL_CMPY_CD           = T_A_T.GLBL_CMPY_CD
            <!-- AND A_P.USR_NM                 = S_P.PSN_CD -->
            <!-- AND A_P.EZCANCELFLAG           = '0' -->
             AND S_P.EZCANCELFLAG           = '0'
             AND T_A_T.EZCANCELFLAG         = '0'
            <!-- AND A_P.USR_NM                 = #condStr1# -->
             AND S_P.PSN_CD                 = #condStr1#
             AND S_P.LINE_BIZ_TP_CD         = T_A_T.LINE_BIZ_TP_CD
            <!-- 11/28/2017 Sol:303  QC#18689 Mod End. -->
            <!-- END   05/27/2020 [QC#56548,MOD] -->
            UNION ALL
           SELECT
                 #condStr1# AS PSN_CD
                ,CASE WHEN AL.APVL_LIMIT_AMT &gt;= #condNum1# THEN 'Next2' ELSE 'Next' END as DEC_COND
                ,3 AS SORT_NUM
             FROM
                  APVL_LIMIT AL
            WHERE
                  AL.GLBL_CMPY_CD = #glblCmpyCd#
              AND AL.PSN_CD       = '*' --'*'=Special User.
              AND AL.EZCANCELFLAG = '0'
        ) RSLT 
        WHERE    ROWNUM = 1
    </statement>

    <statement id="CHECK_APVL_LIMIT_BY_SUPV" parameterClass="Map" resultClass="Map">
    --2).Check Approval Limit by Supervisor
    --If Approval Limit Amount is smaller than requested Total Amount, we should search super visor of Requester from HR Info.
<!-- 11/28/2017 Sol:303  QC#18689 Mod Start. -->
<!--
        WITH VIEW01 AS (
            SELECT
                  USR_NM
            FROM
                  AUTH_PSN
            START WITH
                 GLBL_CMPY_CD  = #glblCmpyCd#
             AND USR_NM        = #condStr1#
             AND EZCANCELFLAG  = '0'
            CONNECT BY
                 PRIOR MGR_ID  = USR_NM
             AND GLBL_CMPY_CD  = #glblCmpyCd#
             AND EZCANCELFLAG  = '0'
            )
        SELECT
            V01.USR_NM        AS VAL_STR_1
            , #condStr1#      AS COND_STR_1
        FROM
             APVL_LIMIT AL
            ,VIEW01     V01
        WHERE 
                AL.GLBL_CMPY_CD           = #glblCmpyCd#
            AND AL.APVL_HRCH_TP_CD        = #condStr2#
            AND AL.PSN_CD                 = V01.USR_NM
            AND (AL.PRCH_GRP_CD           = #condStr4# OR NVL(AL.PRCH_GRP_CD,'*') = '*' )
            AND AL.APVL_HIST_SRC_TP_CD    = #condStr3#
            AND AL.APVL_LIMIT_AMT     &gt;= #condNum1#
            AND AL.EZCANCELFLAG           = '0'
            AND ROWNUM = 1
        ORDER BY AL.APVL_LIMIT_AMT,AL.PSN_CD
-->
         SELECT
	            S_P.HR_SUPV_ID AS VAL_STR_1
               ,#condStr1#     AS COND_STR_1
         FROM  S21_PSN S_P
         WHERE
                 S_P.GLBL_CMPY_CD           = #glblCmpyCd#
             AND S_P.EZCANCELFLAG           = '0'
             AND S_P.PSN_CD                 = #condStr1#
<!-- 11/28/2017 Sol:303  QC#18689 Mod End. -->
    </statement>

    <statement id="CHECK_APVL_LIMIT_BY_REQUESTER_2" parameterClass="Map" resultClass="Map">
    --2).Set Group
         SELECT
            #condStr9#  AS VAL_STR_1
           ,#condStr1#  AS COND_STR_1
         FROM
           DUAL
    </statement>

    <statement id="TECH_PARTS_REQ_RUSH" parameterClass="Map" resultClass="Map">
    --03.Tech Parts Request Rush
<!-- 11/28/2017 Sol:303  QC#18689 Mod Start. -->
<!--
       SELECT
              AP.MGR_ID    AS VAL_STR_1
             ,#condStr1#   AS COND_STR_1
       FROM
              AUTH_PSN AP
       WHERE
              AP.GLBL_CMPY_CD = #glblCmpyCd#
          AND AP.USR_NM       = #condStr1#
          AND AP.EZCANCELFLAG = '0'
-->
       SELECT
	          S_P.HR_SUPV_ID AS VAL_STR_1
             ,#condStr1#     AS COND_STR_1
       FROM  S21_PSN S_P
       WHERE
             S_P.GLBL_CMPY_CD           = #glblCmpyCd#
         AND S_P.EZCANCELFLAG           = '0'
         AND S_P.PSN_CD                 = #condStr1#
<!-- 11/28/2017 Sol:303  QC#18689 Mod End. -->
    </statement>

    <statement id="GET_REASIGN_USR_BY_APPROVER" parameterClass="Map" resultClass="Map">
    --02.Tech Parts Request REASIGN
<!-- 11/28/2017 Sol:303  QC#18689 Mod Start. -->
<!--    
        WITH VIEW01 AS (
            SELECT
                 USR_NM
                ,LEVEL AS LVL
            FROM
                 AUTH_PSN
            START WITH
                        GLBL_CMPY_CD  = #glblCmpyCd#
                AND     USR_NM        = #condStr1#
                AND     EZCANCELFLAG  = '0'
            CONNECT BY
                        PRIOR MGR_ID  = USR_NM
                AND     GLBL_CMPY_CD  = #glblCmpyCd#
                AND     EZCANCELFLAG  = '0'
            ORDER BY LEVEL
            )
         SELECT
                  'NPZC130001'           AS BIZ_ID
                , 'GRP_REASIGN_TECH'     AS USER_GROUP_NAME
                , '000'                  AS USER_GROUP_LEVEL
                , VIEW01.USR_NM          AS WF_USR_ID 
         FROM
           VIEW01
         WHERE LVL &gt; 1
-->
       WITH VIEW01 AS (
           SELECT
                 S_P.PSN_CD
                ,LEVEL AS LVL
            FROM
                 S21_PSN S_P
            START WITH
                        S_P.GLBL_CMPY_CD      = #glblCmpyCd#
                AND     S_P.PSN_CD            = #condStr1#
                AND     S_P.EZCANCELFLAG      = '0'
            CONNECT BY
                        PRIOR S_P.HR_SUPV_ID  = S_P.PSN_CD
                AND     S_P.GLBL_CMPY_CD      = #glblCmpyCd#
                AND     S_P.EZCANCELFLAG      = '0'
            ORDER BY LEVEL
            )
         SELECT
                  'NPZC130001'           AS BIZ_ID
                , 'GRP_REASIGN_TECH'     AS USER_GROUP_NAME
                , '000'                  AS USER_GROUP_LEVEL
                , VIEW01.PSN_CD          AS WF_USR_ID 
         FROM
           VIEW01
        WHERE LVL &gt; 1
<!-- 11/28/2017 Sol:303  QC#18689 Mod End. -->
    </statement>
</sqlMap>
