<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NFBB129001">

    <statement id="getArRfTrxInfo" parameterClass="Map" resultClass="Map">
        SELECT
               ART.VND_CD                          AS VND_CD
              ,ART.AP_VND_INV_NUM                  AS AP_VND_INV_NUM
              ,ART.AR_RF_RQST_PK                   AS AR_RF_RQST_PK
              ,SUM(NVL(ART.FUNC_RF_AMT, 0) * -1)   AS FUNC_RF_AMT
              ,MAX(V.SPLY_COA_CMPY_CD)             AS SPLY_COA_CMPY_CD
              ,MAX(V.SPLY_COA_BR_CD)               AS SPLY_COA_BR_CD
              ,MAX(V.SPLY_COA_CC_CD)               AS SPLY_COA_CC_CD
              ,MAX(V.SPLY_COA_ACCT_CD)             AS SPLY_COA_ACCT_CD
              ,MAX(V.SPLY_COA_PROD_CD)             AS SPLY_COA_PROD_CD
              ,MAX(V.SPLY_COA_CH_CD)               AS SPLY_COA_CH_CD
              ,MAX(V.SPLY_COA_AFFL_CD)             AS SPLY_COA_AFFL_CD
              ,MAX(V.SPLY_COA_PROJ_CD)             AS SPLY_COA_PROJ_CD
              ,MAX(V.SPLY_COA_EXTN_CD)             AS SPLY_COA_EXTN_CD
              ,MAX(CDA.CM_COA_CMPY_CD)             AS CM_COA_CMPY_CD
              ,MAX(CDA.CM_COA_BR_CD)               AS CM_COA_BR_CD
              ,MAX(CDA.CM_COA_CC_CD)               AS CM_COA_CC_CD
              ,MAX(CDA.CM_COA_ACCT_CD)             AS CM_COA_ACCT_CD
              ,MAX(CDA.CM_COA_PROD_CD)             AS CM_COA_PROD_CD
              ,MAX(CDA.CM_COA_CH_CD)               AS CM_COA_CH_CD
              ,MAX(CDA.CM_COA_AFFL_CD)             AS CM_COA_AFFL_CD
              ,MAX(CDA.CM_COA_PROJ_CD)             AS CM_COA_PROJ_CD
              ,MAX(CDA.CM_COA_EXTN_CD)             AS CM_COA_EXTN_CD
              ,MAX(PV.PRNT_VND_CD)                 AS PRNT_VND_CD
              <!-- start 2018/05/29 QC#26156 MOD -->
              <!-- start 2018/03/23 QC#20316 ADD -->
              ,LPAD(TO_CHAR(ROW_NUMBER() OVER (PARTITION BY ART.VND_CD, ART.AP_VND_INV_NUM ORDER BY ART.VND_CD, ART.AP_VND_INV_NUM, ART.AR_RF_RQST_PK)), 4, '0')
                                                   AS AP_VND_INV_LINE_NUM
              <!-- end 2018/03/23 QC#20316 ADD -->
              <!-- start 2016/11/17 QC#15966 ADD -->
              ,LPAD(TO_CHAR(ROW_NUMBER() OVER (PARTITION BY ART.VND_CD, ART.AP_VND_INV_NUM ORDER BY ART.VND_CD, ART.AP_VND_INV_NUM, ART.AR_RF_RQST_PK)), 3, '0')
                                                   AS CM_INV_ACCT_DIST_LINE_NUM
              <!-- end 2016/09/30 QC#15966 ADD -->
              <!-- end 2018/05/29 QC#26156 MOD -->
              <!-- start 2017/12/19 QC#23022 ADD -->
              ,ART.AR_RF_RQST_PK                   AS AR_RF_RQST_PK
              <!-- end   2017/12/19 QC#23022 ADD -->
              <!-- start 2018/03/02 QC#22765 ADD -->
              ,MAX(ART.AR_RF_CHK_CMNT_TXT)         AS AR_RF_CHK_CMNT_TXT
              <!-- end 2018/03/02 QC#22765 ADD -->
              ,MAX(PV.VND_PMT_TERM_CD)             AS VND_PMT_TERM_CD

        FROM
               AR_RF_TRX       ART
              ,VND             V
              ,PRNT_VND        PV
              ,CM_DEF_ACCT     CDA

        WHERE

             ART.GLBL_CMPY_CD                      = #glblCmpyCd#
             AND ART.AR_RF_STS_CD                  = #arRfStsC#
             AND ART.EZCANCELFLAG                  = '0'
             AND ART.GLBL_CMPY_CD                  = V.GLBL_CMPY_CD(+)
             AND ART.VND_CD                        = V.VND_CD(+)
             AND V.EZCANCELFLAG(+)                 = '0'
             AND V.GLBL_CMPY_CD                    = PV.GLBL_CMPY_CD(+)
             AND V.PRNT_VND_PK                     = PV.PRNT_VND_PK(+)
             AND PV.EZCANCELFLAG(+)                = '0'
             AND ART.GLBL_CMPY_CD                  = CDA.GLBL_CMPY_CD(+)
             AND CDA.CM_DEF_ACCT_CD(+)             = #cmDefAcctCd#
             AND CDA.EZCANCELFLAG(+)               = '0'
        GROUP BY 
              <!-- start 2018/05/29 QC#26156 MOD -->
               ART.VND_CD
              ,ART.AP_VND_INV_NUM
              ,ART.AR_RF_RQST_PK
              <!-- start 2016/11/17 QC#15966 ADD -->
        ORDER BY
               ART.VND_CD
              ,ART.AP_VND_INV_NUM
              ,ART.AR_RF_RQST_PK
              <!-- end 2018/05/29 QC#26156 MOD -->
              <!-- end 2016/11/17 QC#15966 ADD -->
    </statement>
</sqlMap>
