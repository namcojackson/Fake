<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NFBB002301">
    <statement id="getCmHistTsFromHistory" parameterClass="Map" resultClass="Map">
        SELECT 
            MAX(CM_HIST_TS)  CM_HIST_TS
        FROM 
            CM_MDSE_INVTY_IMPT_HIST
        WHERE
            EZCANCELFLAG                =   '0'
        AND GLBL_CMPY_CD                =   #glblCmpyCd#                            
    </statement>

<statement id="SELECT_CM_STK_IN" parameterClass="Map">
        SELECT
            STK_IN.EZINTIME
        ,   STK_IN.INVTY_TRX_PK
        ,   CM_STK_IN_SQ.NEXTVAL                        CM_STK_IN_PK
        ,   STK_IN.VND_CD
        ,   STK_IN.INVTY_LOC_CD
        ,   STK_IN.DELY_ORD_NUM
        ,   STK_IN.PROD_LINE_PROD_CTRL_CD
        ,   STK_IN.MDSE_CD
        ,   STK_IN.MDSE_OR_PRT_CD
        ,   STK_IN.VND_REF_NUM
        ,   STK_IN.IMPT_DO_SO_NUM
        ,   STK_IN.ACCT_REC_CNT
        ,   STK_IN.STK_IN_ERR_FLG
        ,   STK_IN.VND_INV_NUM
        ,   STK_IN.VND_INV_SQ_NUM
        ,   STK_IN.COA_PROD_CD
        ,   STK_IN.ACCT_YR_MTH
        ,   STK_IN.INV_LOC_RCV_DT
        ,   STK_IN.INV_SEND_CD
        ,   STK_IN.LC_DA_NUM
        ,   STK_IN.VND_SHIP_VIA_PRCH_CD
        ,   STK_IN.ACTL_FOB_CD
        ,   STK_IN.ACCT_SHPG_TERM_CD
        ,   STK_IN.STK_IN_RSN_DESC_TXT
        ,   STK_IN.INV_SC_FOB_COST_AMT
        ,   STK_IN.INV_SC_FRT_COST_AMT
        ,   STK_IN.INV_SC_INS_COST_AMT
        ,   STK_IN.INV_OC_FOB_COST_AMT
        ,   STK_IN.INV_OC_FRT_COST_AMT
        ,   STK_IN.INV_OC_INS_COST_AMT
        ,   STK_IN.INV_QTY
        ,   STK_IN.FOB_CCY_CD
        ,   STK_IN.FRT_CCY_CD
        ,   STK_IN.INS_CCY_CD
        ,   STK_IN.RCV_QTY
        ,   STK_IN.SLS_PRMO_QTY
        ,   STK_IN.AC_MDSE_FOB_COST_AMT
        ,   STK_IN.PLN_SC_FOB_COST_AMT
        ,   STK_IN.PLN_SC_FRT_COST_AMT
        ,   STK_IN.PLN_SC_INS_COST_AMT
        ,   STK_IN.PLN_SC_DTY_COST_AMT
        ,   STK_IN.PLN_SC_OTH_COST_AMT
        ,   STK_IN.STK_IN_SC_FOB_COST_AMT
        ,   STK_IN.STK_IN_SC_FRT_COST_AMT
        ,   STK_IN.STK_IN_SC_INS_COST_AMT
        ,   STK_IN.STK_IN_SC_DTY_COST_AMT
        ,   STK_IN.STK_IN_SC_OTH_COST_AMT
        ,   STK_IN.SLS_PRMO_SC_FOB_COST_AMT
        ,   STK_IN.SLS_PRMO_SC_FRT_COST_AMT
        ,   STK_IN.SLS_PRMO_SC_INS_COST_AMT
        ,   STK_IN.SLS_PRMO_SC_DTY_COST_AMT
        ,   STK_IN.SLS_PRMO_SC_OTH_COST_AMT
        ,   STK_IN.PSET_VND_FLG
        ,   STK_IN.INV_ASG_FLG
        ,   STK_IN.STK_IN_ITEM_DEL_FLG
        ,   STK_IN.PSET_ASG_FLG
        ,   STK_IN.PO_NUM
        ,   STK_IN.PO_QTY
        ,   STK_IN.THIS_MTH_FOB_COST_AMT
        ,   STK_IN.TRX_CD
        ,   STK_IN.TRX_RSN_CD
        ,   STK_IN.PO_ORD_NUM
        ,   STK_IN.PO_ORD_DTL_LINE_NUM
        ,   STK_IN.VND_RTRN_NUM
        ,   STK_IN.TRX_LINE_NUM
        ,   STK_IN.TRX_LINE_SUB_NUM
        ,   STK_IN.CM_STK_IN_VAR_CALC_FLG
        ,   STK_IN.CM_STK_IN_VAR_FRCE_CALC_FLG
        ,   STK_IN.STK_IN_ASG_ERR_RSN_CD
        ,   STK_IN.ENT_DEAL_NET_UNIT_PRC_AMT
        ,   STK_IN.ENT_PO_DTL_DEAL_NET_AMT
        ,   STK_IN.ENT_FUNC_NET_UNIT_PRC_AMT
        ,   STK_IN.ENT_PO_DTL_FUNC_NET_AMT
        ,   STK_IN.EXCH_RATE
        FROM
            (
            SELECT  /* for finding outstanding items */
                I.EZINTIME                                               EZINTIME
            ,   I.INVTY_TRX_PK                                           INVTY_TRX_PK
            ,   NVL(VND.INV_VND_CD, NVL(I.VND_CD, M.VND_CD))             VND_CD
            ,   I.INVTY_LOC_CD                                           INVTY_LOC_CD
            ,   NVL(NVL(DPRD.ASN_SO_NUM, I.INVTY_TRX_REF_NUM), 'NONE')   DELY_ORD_NUM
            ,   I.FIRST_PROD_CTRL_CD                                     PROD_LINE_PROD_CTRL_CD
            ,   I.MDSE_CD                                                MDSE_CD
            ,   'M'                                                      MDSE_OR_PRT_CD
            ,   CASE
                   WHEN I.TRX_CD = '000' AND I.TRX_RSN_CD='01' THEN I.PO_ORD_NUM
                   WHEN I.TRX_CD = '000' AND I.TRX_RSN_CD='03' THEN I.VND_RTRN_NUM
                ELSE I.PO_ORD_NUM
                END                                                      VND_REF_NUM
            ,   INTG_IF.CM_SO_INV_NUM                                    IMPT_DO_SO_NUM
            ,   0                                                        ACCT_REC_CNT
            ,   'N'                                                      STK_IN_ERR_FLG
            ,   I.IMPT_INV_NUM                                           VND_INV_NUM
            ,   '00'                                                     VND_INV_SQ_NUM
            ,   M.COA_PROD_CD                                            COA_PROD_CD
            ,   NULL                                                     ACCT_YR_MTH
            ,   I.INVTY_TRX_DT                                           INV_LOC_RCV_DT
            ,   NULL                                                     INV_SEND_CD
            ,   NULL                                                     LC_DA_NUM
            ,   NULL                                                     VND_SHIP_VIA_PRCH_CD
            ,   NULL                                                     ACTL_FOB_CD
            ,   NULL                                                     ACCT_SHPG_TERM_CD
            ,   NULL                                                     STK_IN_RSN_DESC_TXT
            ,   0                                                        INV_SC_FOB_COST_AMT
            ,   0                                                        INV_SC_FRT_COST_AMT
            ,   0                                                        INV_SC_INS_COST_AMT
            ,   0                                                        INV_OC_FOB_COST_AMT
            ,   0                                                        INV_OC_FRT_COST_AMT
            ,   0                                                        INV_OC_INS_COST_AMT
            ,   0                                                        INV_QTY
            ,   NULL                                                     FOB_CCY_CD
            ,   NULL                                                     FRT_CCY_CD
            ,   NULL                                                     INS_CCY_CD
            ,   I.INVTY_TRX_QTY                                          RCV_QTY
            ,   0                                                        SLS_PRMO_QTY
            ,   0                                                        AC_MDSE_FOB_COST_AMT
            ,   0                                                        PLN_SC_FOB_COST_AMT
            ,   0                                                        PLN_SC_FRT_COST_AMT
            ,   0                                                        PLN_SC_INS_COST_AMT
            ,   0                                                        PLN_SC_DTY_COST_AMT
            ,   0                                                        PLN_SC_OTH_COST_AMT
            ,   NVL(M.THIS_MTH_FOB_AMT,0) * NVL(I.INVTY_TRX_QTY,0)       STK_IN_SC_FOB_COST_AMT
            ,   NVL(M.THIS_MTH_INTL_FRT_AMT,0) * NVL(I.INVTY_TRX_QTY,0)  STK_IN_SC_FRT_COST_AMT
            ,   NVL(M.THIS_MTH_INS_AMT,0) * NVL(I.INVTY_TRX_QTY,0)       STK_IN_SC_INS_COST_AMT
            ,   NVL(M.THIS_MTH_IMPT_DTY_AMT,0) * NVL(I.INVTY_TRX_QTY,0)  STK_IN_SC_DTY_COST_AMT
            ,   NVL(M.THIS_MTH_INLND_FRT_AMT,0) * NVL(I.INVTY_TRX_QTY,0) STK_IN_SC_OTH_COST_AMT
            ,   0                                 SLS_PRMO_SC_FOB_COST_AMT
            ,   0                                 SLS_PRMO_SC_FRT_COST_AMT
            ,   0                                 SLS_PRMO_SC_INS_COST_AMT
            ,   0                                 SLS_PRMO_SC_DTY_COST_AMT
            ,   0                                 SLS_PRMO_SC_OTH_COST_AMT
            ,   'N'                               PSET_VND_FLG
            ,   'N'                               INV_ASG_FLG
            ,   'N'                               STK_IN_ITEM_DEL_FLG

          <isNotNull property="csaFlg">
            ,  'N'                                PSET_ASG_FLG
          </isNotNull>
          <isNull property="csaFlg">
            ,   'Y'                               PSET_ASG_FLG
          </isNull>

            ,   CASE
                    WHEN I.TRX_CD = '000' AND I.TRX_RSN_CD='01' THEN I.PO_ORD_NUM
                    WHEN I.TRX_CD = '000' AND I.TRX_RSN_CD='03' THEN I.VND_RTRN_NUM
                    ELSE I.PO_ORD_NUM
                END                               PO_NUM
            ,   DECODE(PD.PO_QTY,null,0,PD.PO_QTY) 
                                                  PO_QTY
            ,   DECODE(PD.THIS_MTH_FOB_COST_AMT,null,0,PD.THIS_MTH_FOB_COST_AMT)
                                                  THIS_MTH_FOB_COST_AMT
            ,   I.TRX_CD                          TRX_CD
            ,   I.TRX_RSN_CD                      TRX_RSN_CD
            ,   CASE
                    WHEN I.TRX_CD = '000' AND I.TRX_RSN_CD='01' THEN I.PO_ORD_NUM
                    WHEN I.TRX_CD = '000' AND I.TRX_RSN_CD='03' THEN I.VND_RTRN_NUM
                    ELSE I.PO_ORD_NUM
                END                     PO_ORD_NUM
            ,   I.PO_ORD_DTL_LINE_NUM             PO_ORD_DTL_LINE_NUM
            ,   I.VND_RTRN_NUM                    VND_RTRN_NUM
            ,   I.TRX_LINE_NUM                    TRX_LINE_NUM
            ,   I.TRX_LINE_SUB_NUM                TRX_LINE_SUB_NUM
            ,   'N'                               CM_STK_IN_VAR_CALC_FLG
            ,   'N'                               CM_STK_IN_VAR_FRCE_CALC_FLG
            ,   NULL                              STK_IN_ASG_ERR_RSN_CD
            ,   DECODE(PD.ENT_DEAL_NET_UNIT_PRC_AMT,null,0,PD.ENT_DEAL_NET_UNIT_PRC_AMT)
                                                  ENT_DEAL_NET_UNIT_PRC_AMT
            ,   DECODE(PD.ENT_PO_DTL_DEAL_NET_AMT,null,0,PD.ENT_PO_DTL_DEAL_NET_AMT)
                                                  ENT_PO_DTL_DEAL_NET_AMT
            ,   DECODE(PD.ENT_FUNC_NET_UNIT_PRC_AMT,null,0,PD.ENT_FUNC_NET_UNIT_PRC_AMT)
                                                  ENT_FUNC_NET_UNIT_PRC_AMT
            ,   DECODE(PD.ENT_PO_DTL_FUNC_NET_AMT,null,0,PD.ENT_PO_DTL_FUNC_NET_AMT)
                                                  ENT_PO_DTL_FUNC_NET_AMT
            ,   DECODE(PD.EXCH_RATE,null,0,PD.EXCH_RATE)
                                                  EXCH_RATE
            FROM
                MDSE                M
            ,   INVTY_TRX           I
            ,   VND                 VND
            ,   PO_RCV_DTL          DPRD
            ,   CM_IF_SLS_OTBD      INTG_IF
            ,   PO_DTL              PD
            WHERE
                M.GLBL_CMPY_CD                          = #glblCmpyCd#
            AND M.GLBL_CMPY_CD                          = I.GLBL_CMPY_CD
            AND M.MDSE_CD                               = I.MDSE_CD
            AND 
            (
                (
                    /* TRX_CD '000': Purchase Stock-In */
                    /* TRX_RSN_CD '01': Purchase Stock-In */
                    /*            '03': Domestic Vendor Return */
                    I.TRX_CD                    =       '000'
                AND (   
                        I.TRX_RSN_CD            =       '01'
                    OR  I.TRX_RSN_CD            =       '03'
                    )
                )
            )
            <!-- START 2019/11/07 H.Ikeda [QC#54488, MOD] -->
            <!-- AND TO_NUMBER(I.EZINTIME)                   &gt;   TO_NUMBER(#cmHistTs#)  -->
            <!-- START 2019/12/03 H.Nagashima [QC#54853, MOD] -->
            <!-- AND I.INVTY_TRX_DT                       LIKE #invtyTrxDt# || '%'
            AND NOT EXISTS (
                            SELECT
                                1
                            FROM
                                CM_STK_IN CSI
                            WHERE
                                CSI.GLBL_CMPY_CD        = I.GLBL_CMPY_CD
                            AND CSI.PO_ORD_NUM          = I.PO_ORD_NUM
                            AND CSI.PO_ORD_DTL_LINE_NUM = I.PO_ORD_DTL_LINE_NUM
                            AND CSI.EZCANCELFLAG        = '0'
                           )
            AND NOT EXISTS (
                            SELECT
                                1
                            FROM
                                CM_STK_IN CSI
                            WHERE 
                                CSI.GLBL_CMPY_CD     = I.GLBL_CMPY_CD
                            AND CSI.VND_RTRN_NUM     = I.VND_RTRN_NUM
                            AND CSI.TRX_LINE_NUM     = I.TRX_LINE_NUM
                            AND CSI.TRX_LINE_SUB_NUM = I.TRX_LINE_SUB_NUM
                            AND CSI.EZCANCELFLAG     = '0'
                           )
            -->
            <!-- END   2019/11/07 H.Ikeda [QC#54488, MOD] -->
            AND NOT EXISTS (
                            SELECT
                                1
                            FROM
                                CM_STK_IN CSI
                            WHERE
                                CSI.GLBL_CMPY_CD     = I.GLBL_CMPY_CD
                            AND CSI.INVTY_TRX_PK     = I.INVTY_TRX_PK
                            AND CSI.EZCANCELFLAG     = '0'
            )
            <!-- END   2019/12/03 H.Nagashima [QC#54853, MOD] -->
            AND I.GLBL_CMPY_CD                          = VND.GLBL_CMPY_CD(+)
            AND I.VND_CD                                = VND.VND_CD(+)
            AND I.GLBL_CMPY_CD                          = DPRD.GLBL_CMPY_CD(+)
            AND I.PO_RCV_NUM                            = DPRD.PO_RCV_NUM(+)
            AND I.PO_RCV_LINE_NUM                       = DPRD.PO_RCV_LINE_NUM(+)
            AND I.GLBL_CMPY_CD                          = INTG_IF.GLBL_CMPY_CD(+)
            AND 'N'                                     = INTG_IF.IF_PROC_STS_CD(+)
            AND I.INVTY_TRX_PK                          = INTG_IF.INVTY_TRX_PK(+)
            AND I.GLBL_CMPY_CD                          = PD.GLBL_CMPY_CD(+)
            AND I.PO_ORD_NUM                            = PD.PO_ORD_NUM(+)
            AND I.PO_ORD_DTL_LINE_NUM                   = PD.PO_ORD_DTL_LINE_NUM(+)

            AND M.EZCANCELFLAG                          = '0'
            AND M.EZCANCELFLAG                          = I.EZCANCELFLAG
            AND I.EZCANCELFLAG                          = VND.EZCANCELFLAG(+)
            AND I.EZCANCELFLAG                          = DPRD.EZCANCELFLAG(+)
            AND I.EZCANCELFLAG                          = INTG_IF.EZCANCELFLAG(+)
            AND I.EZCANCELFLAG                          = PD.EZCANCELFLAG(+)
            ORDER BY
                I.EZINTIME
            )               STK_IN
</statement>

<statement id="UPDATE_CM_STK_IN" parameterClass="Map">
        SELECT
            CSI.CM_STK_IN_PK
        ,   PD.PO_ORD_NUM
        ,   PD.PO_ORD_DTL_LINE_NUM
        ,   PD.PO_QTY
        ,   PD.THIS_MTH_FOB_COST_AMT
        ,   PD.ENT_DEAL_NET_UNIT_PRC_AMT
        ,   PD.ENT_PO_DTL_DEAL_NET_AMT
        ,   PD.ENT_FUNC_NET_UNIT_PRC_AMT
        ,   PD.ENT_PO_DTL_FUNC_NET_AMT
        ,   PD.EXCH_RATE
        FROM
            CM_STK_IN           CSI
        ,   PO_DTL              PD
        WHERE
            CSI.GLBL_CMPY_CD                        = #glblCmpyCd#
        AND CSI.INV_RCV_DT                          = #procDt#
        AND CSI.GLBL_CMPY_CD                        = PD.GLBL_CMPY_CD
        AND CSI.PO_ORD_NUM                          = PD.PO_ORD_NUM
        AND CSI.PO_ORD_DTL_LINE_NUM                 = PD.PO_ORD_DTL_LINE_NUM
        AND ((CSI.PO_QTY != PD.PO_QTY)
                 OR (CSI.ENT_DEAL_NET_UNIT_PRC_AMT != PD.ENT_DEAL_NET_UNIT_PRC_AMT))
        AND CSI.EZCANCELFLAG                        = '0'
        AND PD.EZCANCELFLAG                         = '0'
        ORDER BY
            CSI.CM_STK_IN_PK
</statement>

<statement id="FIND_AUTHORIZED_AP_INVOICES" parameterClass="Map" resultClass="Map">
        SELECT DISTINCT
            CAIH.AP_VND_CD
        ,   CAIH.AP_VND_INV_NUM
        ,   CAIH.AP_VND_INV_SQ_NUM
        FROM
            CM_AP_INV_HDR      CAIH
        ,   CM_AP_INV_DTL      CAID
        WHERE
            CAIH.GLBL_CMPY_CD                       = #glblCmpyCd#
        AND CAIH.ACCT_INV_STS_CD                    = #acctInvStsCd#
        AND CAIH.GLBL_CMPY_CD                       = CAID.GLBL_CMPY_CD
        AND CAIH.AP_VND_CD                          = CAID.AP_VND_CD
        AND CAIH.AP_VND_INV_NUM                     = CAID.AP_VND_INV_NUM
        AND CAIH.AP_VND_INV_SQ_NUM                  = CAID.AP_VND_INV_SQ_NUM
        AND CAID.PO_NUM                             = #poNum#
        AND CAID.PO_ORD_DTL_LINE_NUM                = #poOrdDtlLineNum#
        AND CAIH.EZCANCELFLAG                       = '0'
        AND CAIH.EZCANCELFLAG                       = CAID.EZCANCELFLAG
        ORDER BY
            CAIH.AP_VND_CD
        ,   CAIH.AP_VND_INV_NUM
        ,   CAIH.AP_VND_INV_SQ_NUM
</statement>
</sqlMap>
