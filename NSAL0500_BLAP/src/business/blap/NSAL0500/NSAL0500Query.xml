<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSAL0500Query">

    <typeAlias alias="NSAL0500CMsg"             type="business.blap.NSAL0500.NSAL0500CMsg"/>
    <typeAlias alias="NSAL0500_ASMsg"             type="business.blap.NSAL0500.NSAL0500_ASMsg"/>
    <typeAlias alias="NSAL0500_BSMsg"             type="business.blap.NSAL0500.NSAL0500_BSMsg"/>
    <typeAlias alias="NSAL0500_CSMsg"             type="business.blap.NSAL0500.NSAL0500_CSMsg"/>
    <!-- START 2018/12/10  K.Fujimoto [QC#29079, ADD] -->
    <typeAlias alias="NSAL0500_ECMsg"             type="business.blap.NSAL0500.NSAL0500_ECMsg"/>
    <!-- END   2018/12/10  K.Fujimoto [QC#29079, ADD] -->

    <statement id="getRecentSubContrPk" parameterClass="Map" resultMap="result.getRecentSubContrPk">
        SELECT
            B.DS_SUB_CONTR_PK
        FROM (
            SELECT
                A.DS_SUB_CONTR_PK
            FROM
                DS_SUB_CONTR A
            WHERE
                    A.EZCANCELFLAG    =     '0'
                AND A.GLBL_CMPY_CD    =     #cMsg.glblCmpyCd#
                AND A.DS_CONTR_DTL_PK =     #cMsg.dsContrDtlPk#
                AND A.EFF_THRU_DT     &gt;= #salesDt#
            ORDER BY
                EFF_FROM_DT ASC
            ) B
        WHERE
            ROWNUM = #rowNum#
    </statement>
    <resultMap id="result.getRecentSubContrPk" class="NSAL0500CMsg">
        <result property="dsSubContrPk"  column="DS_SUB_CONTR_PK"    javaType="EZDCBigDecimalItem"/>
    </resultMap>

    <statement id="getContrInfo" parameterClass="Map" resultMap="result.getContrInfo">
        SELECT
             C.SER_NUM
            ,C.SVC_MACH_MSTR_PK
            ,E.T_MDL_NM
            ,H.VND_CD
            ,M.PRNT_VND_NM
            ,B.DS_CONTR_NUM
            ,F.DS_CONTR_CTRL_STS_CD
            ,F.DS_CONTR_CTRL_STS_NM
            ,H.TECH_TOC_CD
            ,NVL(H.DS_ACCT_NUM, B.DS_ACCT_NUM) AS DS_ACCT_NUM
            ,NVL(J.DS_ACCT_NM, G.DS_ACCT_NM)   AS DS_ACCT_NM
            ,H.CONTR_TRMN_FLG
            ,H.EFF_FROM_DT
            ,H.EFF_THRU_DT
            ,H.BASE_PRC_DEAL_AMT
            ,H.ADMIN_PRC_DEAL_AMT
            ,H.PREPD_MAINT_FLG
            ,H.BW_MTR_ALWNC_CNT
            ,H.COLOR_MTR_ALWNC_CNT
            ,H.BW_MTR_PRC_AMT_RATE
            ,H.COLOR_MTR_PRC_AMT_RATE
            ,H.SPLY_INCL_FLG
            ,H.BLLG_CYCLE_CD
            ,H.DLR_FLEET_FLG
            ,H.DLR_FLEET_NUM
            ,A.CONTR_EFF_FROM_DT
            ,A.CONTR_EFF_THRU_DT
            ,H.EZUPTIME
            ,H.EZUPTIMEZONE
            ,H.ATT_FILE_NM
            <!-- START 2016/12/07 K.Kojima [QC#14204, ADD] -->
            ,H.EZINTIME    AS XX_REC_HIST_CRAT_TS
            ,H.EZINUSERID  AS XX_REC_HIST_CRAT_BY_NM
            ,H.EZUPTIME    AS XX_REC_HIST_UPD_TS
            ,H.EZUPUSERID  AS XX_REC_HIST_UPD_BY_NM
            ,H.EZTABLEID   AS XX_REC_HIST_TBL_NM
            <!-- END 2016/12/07 K.Kojima [QC#14204, ADD] -->
        FROM
             DS_CONTR_DTL     A
            ,DS_CONTR         B
            ,SVC_MACH_MSTR    C
            ,SVC_CONFIG_MSTR  D
            ,MDL_NM           E
            ,DS_CONTR_STS_V   F
            ,SELL_TO_CUST     G
            ,DS_SUB_CONTR     H
            ,VND              I
            ,SELL_TO_CUST     J
            ,VND_TP_RELN      L
            ,PRNT_VND         M
        WHERE
                A.EZCANCELFLAG        = '0'
            AND A.GLBL_CMPY_CD        = #cMsg.glblCmpyCd#
            AND A.DS_CONTR_DTL_PK     = #cMsg.dsContrDtlPk#
            AND B.EZCANCELFLAG        = '0'
            AND A.GLBL_CMPY_CD        = B.GLBL_CMPY_CD
            AND A.DS_CONTR_PK         = B.DS_CONTR_PK
            AND C.EZCANCELFLAG        = '0'
            AND A.GLBL_CMPY_CD        = C.GLBL_CMPY_CD
            AND A.SVC_MACH_MSTR_PK    = C.SVC_MACH_MSTR_PK
            AND D.EZCANCELFLAG        = '0'
            AND C.GLBL_CMPY_CD        = D.GLBL_CMPY_CD
            AND C.SVC_MACH_MSTR_PK    = D.SVC_MACH_MSTR_PK
            AND E.EZCANCELFLAG        = '0'
            AND D.GLBL_CMPY_CD        = E.T_GLBL_CMPY_CD
            AND D.MDL_ID              = E.T_MDL_ID
            AND F.EZCANCELFLAG        = '0'
            AND B.GLBL_CMPY_CD        = F.GLBL_CMPY_CD
            AND B.DS_CONTR_PK         = F.DS_CONTR_PK
            AND G.EZCANCELFLAG        = '0'
            AND B.GLBL_CMPY_CD        = G.GLBL_CMPY_CD
            AND B.DS_ACCT_NUM         = G.SELL_TO_CUST_CD
            AND H.EZCANCELFLAG(+)     = '0'
            AND A.GLBL_CMPY_CD        = H.GLBL_CMPY_CD(+)
            AND A.DS_CONTR_DTL_PK     = H.DS_CONTR_DTL_PK(+)
        <isNotNull property="cMsg.dsSubContrPk">
            AND H.DS_SUB_CONTR_PK(+)  = #cMsg.dsSubContrPk#
        </isNotNull>
        <isNull property="cMsg.dsSubContrPk">
            AND H.DS_SUB_CONTR_PK(+)  IS NULL
        </isNull>
            AND I.EZCANCELFLAG(+)     = '0'
            AND H.GLBL_CMPY_CD        = I.GLBL_CMPY_CD(+)
            AND H.VND_CD              = I.VND_CD(+)
            AND J.EZCANCELFLAG(+)     = '0'
            AND H.GLBL_CMPY_CD        = J.GLBL_CMPY_CD(+)
            AND H.DS_ACCT_NUM         = J.SELL_TO_CUST_CD(+)
            AND L.EZCANCELFLAG(+)     = '0'
            AND I.GLBL_CMPY_CD        = L.GLBL_CMPY_CD(+)
            AND I.VND_CD              = L.VND_CD(+)
            AND M.EZCANCELFLAG(+)     = '0'
            AND I.GLBL_CMPY_CD        = M.GLBL_CMPY_CD(+)
            AND I.PRNT_VND_PK         = M.PRNT_VND_PK(+)
    </statement>
    <resultMap id="result.getContrInfo" class="NSAL0500CMsg">
        <result property="serNum"              column="SER_NUM"                  javaType="EZDCStringItem"/>
        <result property="svcMachMstrPk"       column="SVC_MACH_MSTR_PK"         javaType="EZDCBigDecimalItem"/>
        <result property="mdlNm"               column="T_MDL_NM"                 javaType="EZDCStringItem"/>
        <result property="vndCd"               column="VND_CD"                   javaType="EZDCStringItem"/>
        <result property="prntVndNm"           column="PRNT_VND_NM"              javaType="EZDCStringItem"/>
        <result property="dsContrNum"          column="DS_CONTR_NUM"             javaType="EZDCStringItem"/>
        <result property="dsContrCtrlStsCd"    column="DS_CONTR_CTRL_STS_CD"     javaType="EZDCStringItem"/>
        <result property="dsContrCtrlStsNm"    column="DS_CONTR_CTRL_STS_NM"     javaType="EZDCStringItem"/>
        <result property="techTocCd"           column="TECH_TOC_CD"              javaType="EZDCStringItem"/>
        <result property="dsAcctNum"           column="DS_ACCT_NUM"              javaType="EZDCStringItem"/>
        <result property="dsAcctNm"            column="DS_ACCT_NM"               javaType="EZDCStringItem"/>
        <result property="contrTrmnFlg"        column="CONTR_TRMN_FLG"           javaType="EZDCStringItem"/>
        <result property="effFromDt"           column="EFF_FROM_DT"              javaType="EZDCStringItem"/>
        <result property="effThruDt"           column="EFF_THRU_DT"              javaType="EZDCStringItem"/>
        <result property="effThruDt_BK"        column="EFF_THRU_DT"              javaType="EZDCStringItem"/>
        <result property="basePrcDealAmt"      column="BASE_PRC_DEAL_AMT"        javaType="EZDCBigDecimalItem"/>
        <result property="adminPrcDealAmt"     column="ADMIN_PRC_DEAL_AMT"       javaType="EZDCBigDecimalItem"/>
        <result property="prepdMaintFlg"       column="PREPD_MAINT_FLG"          javaType="EZDCStringItem"/>
        <!-- START 2018/12/10  K.Fujimoto [QC#29079, DEL] -->
        <!-- 
        <result property="bwMtrAlwncCnt"       column="BW_MTR_ALWNC_CNT"         javaType="EZDCBigDecimalItem"/>
        <result property="colorMtrAlwncCnt"    column="COLOR_MTR_ALWNC_CNT"      javaType="EZDCBigDecimalItem"/>
        <result property="bwMtrPrcAmtRate"     column="BW_MTR_PRC_AMT_RATE"      javaType="EZDCBigDecimalItem"/>
        <result property="colorMtrPrcAmtRate"  column="COLOR_MTR_PRC_AMT_RATE"   javaType="EZDCBigDecimalItem"/>
         -->
        <!-- END   2018/12/10  K.Fujimoto [QC#29079, DEL] -->
        <result property="splyInclFlg"         column="SPLY_INCL_FLG"            javaType="EZDCStringItem"/>
        <result property="bllgCycleCd"         column="BLLG_CYCLE_CD"            javaType="EZDCStringItem"/>
        <result property="dlrFleetFlg"         column="DLR_FLEET_FLG"            javaType="EZDCStringItem"/>
        <result property="dlrFleetNum"         column="DLR_FLEET_NUM"            javaType="EZDCStringItem"/>
        <result property="contrEffFromDt"      column="CONTR_EFF_FROM_DT"        javaType="EZDCStringItem"/>
        <result property="contrEffThruDt"      column="CONTR_EFF_THRU_DT"        javaType="EZDCStringItem"/>
        <result property="ezUpTime"            column="EZUPTIME"                 javaType="EZDCStringItem"/>
        <result property="ezUpTimeZone"        column="EZUPTIMEZONE"             javaType="EZDCStringItem"/>
        <result property="attFileNm"           column="ATT_FILE_NM"              javaType="EZDCStringItem"/>
        <!-- START 2016/12/07 K.Kojima [QC#14204, ADD] -->
        <result property="xxRecHistCratTs"     column="XX_REC_HIST_CRAT_TS"      javaType="EZDSStringItem"/>
        <result property="xxRecHistCratByNm"   column="XX_REC_HIST_CRAT_BY_NM"   javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdTs"      column="XX_REC_HIST_UPD_TS"       javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdByNm"    column="XX_REC_HIST_UPD_BY_NM"    javaType="EZDSStringItem"/>
        <result property="xxRecHistTblNm"      column="XX_REC_HIST_TBL_NM"       javaType="EZDSStringItem"/>
        <!-- END 2016/12/07 K.Kojima [QC#14204, ADD] -->
    </resultMap>

    <statement id="getSvcCmntTxt" parameterClass="Map" resultClass="String">
        SELECT
            A.SVC_CMNT_TXT
        FROM
            SVC_MEMO A
        WHERE
                A.EZCANCELFLAG     = '0'
            AND A.GLBL_CMPY_CD     = #cMsg.glblCmpyCd#
            AND A.SVC_MEMO_CATG_CD = #svcMemoCatgCd#
            AND A.SVC_MEMO_TP_CD   IN (
                <iterate property="svcMemoTpList" var="svcMemoTp[]" open="" close="" conjunction=",">
                    #svcMemoTp[]#
                </iterate>
                )
            AND A.DS_CONTR_DTL_PK  = #cMsg.dsContrDtlPk#
            AND A.DS_SUB_CONTR_PK  = #cMsg.dsSubContrPk#
        ORDER BY
            A.SVC_MEMO_TP_CD ASC
    </statement>

    <statement id="getLtstSvcMemoPk" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            B.SVC_MEMO_PK
        FROM
            (SELECT
                A.SVC_MEMO_PK
            FROM
                SVC_MEMO A
            WHERE
                    A.EZCANCELFLAG     = '0'
                AND A.GLBL_CMPY_CD     = #cMsg.glblCmpyCd#
                AND A.SVC_MEMO_CATG_CD = #svcMemoCatgCd#
                AND A.SVC_MEMO_TP_CD   IN (
                    <iterate property="svcMemoTpList" var="svcMemoTp[]" open="" close="" conjunction=",">
                        #svcMemoTp[]#
                    </iterate>
                    )
                AND A.DS_CONTR_DTL_PK  = #cMsg.dsContrDtlPk#
                AND A.DS_SUB_CONTR_PK  = #cMsg.dsSubContrPk#
            ORDER BY
                A.SVC_MEMO_TP_CD DESC
            ) B
        WHERE
            ROWNUM = #rowNum#
    </statement>

    <statement id="countDuplicateContr" parameterClass="Map" resultClass="Integer">
        SELECT
            COUNT(A.DS_SUB_CONTR_PK) AS CNT
        FROM
            DS_SUB_CONTR A
        WHERE
                A.EZCANCELFLAG     = '0'
            AND A.GLBL_CMPY_CD     = #cMsg.glblCmpyCd#
            AND A.DS_CONTR_DTL_PK  = #cMsg.dsContrDtlPk#
            AND A.CONTR_TRMN_FLG   = 'N'
        <isNotNull property="cMsg.dsSubContrPk">
            AND A.DS_SUB_CONTR_PK  &lt;&gt; #cMsg.dsSubContrPk#
        </isNotNull>
            AND (
                #cMsg.effFromDt# BETWEEN A.EFF_FROM_DT AND A.EFF_THRU_DT
                OR
                #cMsg.effThruDt# BETWEEN A.EFF_FROM_DT AND A.EFF_THRU_DT
                )
    </statement>

    <statement id="getContrDtlInfo" parameterClass="NSAL0500CMsg" resultClass="Map">
        SELECT
             CNT.DS_CONTR_PK           AS DS_CONTR_PK
            ,CNT.DS_CONTR_CATG_CD      AS DS_CONTR_CATG_CD
        FROM
             DS_CONTR_DTL    DCD
            ,DS_CONTR        CNT
        WHERE
                DCD.GLBL_CMPY_CD       = #glblCmpyCd#
            AND DCD.DS_CONTR_DTL_PK    = #dsContrDtlPk#
            AND DCD.EZCANCELFLAG       = '0'
            AND DCD.GLBL_CMPY_CD       = CNT.GLBL_CMPY_CD
            AND DCD.DS_CONTR_PK        = CNT.DS_CONTR_PK
            AND CNT.EZCANCELFLAG       = '0'
            AND ROWNUM                 = 1
    </statement>

    <statement id="getCustHistInfo" parameterClass="Map" resultMap="result.getCustHistInfo">
        SELECT
             A.SVC_INV_NUM              AS SVC_INV_NUM
            <isNotNull property="dsContrPk">
            ,'Y'                        AS FLEET_LINE_FLG
            </isNotNull>
            <isNull property="dsContrPk">
            ,'N'                        AS FLEET_LINE_FLG
            </isNull>
            ,B.SVC_INV_CHRG_TP_DESC_TXT AS SVC_INV_CHRG_TP_DESC_TXT
            ,A.BLLG_PER_FROM_DT         AS BLLG_PER_FROM_DT
            ,A.BLLG_PER_THRU_DT         AS BLLG_PER_THRU_DT
            ,A.INV_LINE_DEAL_NET_AMT    AS INV_LINE_DEAL_NET_AMT
<!-- START 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
            ,C.INV_TP_CD                AS INV_TP_CD
<!-- END 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
        FROM
             SVC_INV_LINE       A
            ,SVC_INV_CHRG_TP    B
<!-- START 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
            ,SVC_INV            C
<!-- END 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
        WHERE
                A.EZCANCELFLAG        = '0'
            AND A.GLBL_CMPY_CD        = #cMsg.glblCmpyCd#
            <isNotNull property="dsContrPk">
            AND A.DS_CONTR_PK         = #dsContrPk#
            </isNotNull>
            <isNull property="dsContrPk">
            AND A.DS_CONTR_DTL_PK     = #cMsg.dsContrDtlPk#
            </isNull>
            AND B.EZCANCELFLAG        = '0'
            AND A.GLBL_CMPY_CD        = B.GLBL_CMPY_CD
            AND A.SVC_INV_CHRG_TP_CD  = B.SVC_INV_CHRG_TP_CD
<!-- START 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
            AND A.GLBL_CMPY_CD        = C.GLBL_CMPY_CD
            AND A.SVC_INV_NUM         = C.SVC_INV_NUM
            AND C.EZCANCELFLAG        = '0'
<!-- END 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
        ORDER BY A.SVC_INV_NUM, B.SVC_INV_CHRG_TP_SORT_NUM
    </statement>
    <resultMap id="result.getCustHistInfo" class="NSAL0500_ASMsg">
        <result property="svcInvNum_A0"           column="SVC_INV_NUM"              javaType="EZDSStringItem"/>
        <result property="fleetLineFlg_A0"        column="FLEET_LINE_FLG"           javaType="EZDSStringItem"/>
        <result property="svcInvChrgTpDescTxt_A0" column="SVC_INV_CHRG_TP_DESC_TXT" javaType="EZDSStringItem"/>
        <result property="bllgPerFromDt_A0"       column="BLLG_PER_FROM_DT"         javaType="EZDSDateItem"/>
        <result property="bllgPerThruDt_A0"       column="BLLG_PER_THRU_DT"         javaType="EZDSDateItem"/>
        <result property="invLineDealNetAmt_A0"   column="INV_LINE_DEAL_NET_AMT"    javaType="EZDSBigDecimalItem"/>
<!-- START 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
        <result property="invTpCd_A0"             column="INV_TP_CD"                javaType="EZDSStringItem"/>
<!-- END 2017/12/04 M.Kidokoro [QC#22598, ADD] -->
    </resultMap>

<!-- QC#26845 Add Start -->
    <statement id="getMtrHistInfo" parameterClass="Map" resultMap="result.getMtrHistInfo">
        SELECT
            DISTINCT
             D.MTR_READ_DT          AS MTR_READ_DT
            ,C.MTR_LB_DESC_TXT      AS MTR_LB_DESC_TXT
            ,B.BLLG_COPY_QTY        AS BLLG_COPY_QTY
            ,B.TEST_COPY_QTY        AS TEST_COPY_QTY
            ,B.TOT_COPY_QTY         AS TOT_COPY_QTY
            ,C.MTR_LB_SORT_NUM      AS MTR_LB_SORT_NUM
        FROM
             SVC_INV_LINE       A
            ,SVC_INV_LINE_MTR   B
            ,MTR_LB             C
            ,SVC_PHYS_MTR_READ  D
        WHERE
                A.EZCANCELFLAG        = '0'
            AND A.GLBL_CMPY_CD        = #cMsg.glblCmpyCd#
            AND A.DS_CONTR_DTL_PK     = #cMsg.dsContrDtlPk#
            AND A.SVC_INV_CHRG_TP_CD  = #svcInvChrgTpCdIsMeter#
            AND B.EZCANCELFLAG        = '0'
            AND A.GLBL_CMPY_CD        = B.GLBL_CMPY_CD
            AND A.SVC_INV_LINE_PK     = B.SVC_INV_LINE_PK
            AND C.EZCANCELFLAG        = '0'
            AND B.GLBL_CMPY_CD        = C.GLBL_CMPY_CD
            AND B.MTR_LB_CD           = C.MTR_LB_CD
            AND B.GLBL_CMPY_CD        = D.GLBL_CMPY_CD
            AND B.SVC_PHYS_MTR_READ_GRP_SQ = D.SVC_PHYS_MTR_READ_GRP_SQ
            AND D.EZCANCELFLAG        = '0'
        ORDER BY 
            D.MTR_READ_DT
            ,C.MTR_LB_SORT_NUM
    </statement>
<!-- QC#26845 Add End -->
<!-- QC#26845 Del Start -->
<!-- 
    <statement id="getMtrHistInfo" parameterClass="Map" resultMap="result.getMtrHistInfo">
        SELECT
             (
                SELECT
                    SPMR.MTR_READ_DT
                FROM
                    SVC_PHYS_MTR_READ SPMR
                WHERE
                        SPMR.GLBL_CMPY_CD             = B.GLBL_CMPY_CD
                    AND SPMR.SVC_PHYS_MTR_READ_GRP_SQ = B.SVC_PHYS_MTR_READ_GRP_SQ
                    AND SPMR.EZCANCELFLAG             = '0'
                    AND ROWNUM                        = 1
             )                      AS MTR_READ_DT
            ,C.MTR_LB_DESC_TXT      AS MTR_LB_DESC_TXT
            ,B.BLLG_COPY_QTY        AS BLLG_COPY_QTY
            ,B.TEST_COPY_QTY        AS TEST_COPY_QTY
            ,B.TOT_COPY_QTY         AS TOT_COPY_QTY
        FROM
             SVC_INV_LINE       A
            ,SVC_INV_LINE_MTR   B
            ,MTR_LB             C
        WHERE
                A.EZCANCELFLAG        = '0'
            AND A.GLBL_CMPY_CD        = #cMsg.glblCmpyCd#
            AND A.DS_CONTR_DTL_PK     = #cMsg.dsContrDtlPk#
            AND A.SVC_INV_CHRG_TP_CD  = #svcInvChrgTpCdIsMeter#
            AND B.EZCANCELFLAG        = '0'
            AND A.GLBL_CMPY_CD        = B.GLBL_CMPY_CD
            AND A.SVC_INV_LINE_PK     = B.SVC_INV_LINE_PK
            AND C.EZCANCELFLAG        = '0'
            AND B.GLBL_CMPY_CD        = C.GLBL_CMPY_CD
            AND B.MTR_LB_CD           = C.MTR_LB_CD
        ORDER BY B.MTR_READ_DT, C.MTR_LB_SORT_NUM
    </statement>
-->
<!-- QC#26845 Del End -->
    <resultMap id="result.getMtrHistInfo" class="NSAL0500_BSMsg">
        <result property="mtrReadDt_B0"      column="MTR_READ_DT"              javaType="EZDSDateItem"/>
        <!-- START 2018/05/25 K.Kitachi [QC#25950, MOD] -->
        <result property="mtrLbDescTxt_B0"   column="MTR_LB_DESC_TXT"          javaType="EZDSStringItem"/>
        <!-- END 2018/05/25 K.Kitachi [QC#25950, MOD] -->
        <result property="bllgCopyQty_B0"    column="BLLG_COPY_QTY"            javaType="EZDSBigDecimalItem"/>
        <result property="testCopyQty_B0"    column="TEST_COPY_QTY"            javaType="EZDSBigDecimalItem"/>
        <result property="totCopyQty_B0"     column="TOT_COPY_QTY"             javaType="EZDSBigDecimalItem"/>
    </resultMap>

    <statement id="getDealHistInfo" parameterClass="NSAL0500CMsg" resultMap="result.getDealHistInfo">
        SELECT
             M.AP_INV_NUM               AS AP_INV_NUM
            ,M.XX_DSPL_TP_TXT           AS XX_DSPL_TP_TXT
            ,M.START_DT                 AS START_DT
            ,M.END_DT                   AS END_DT
            ,M.BASE_AMT                 AS BASE_AMT
        FROM (
            SELECT
                 C.AP_INV_NUM               AS AP_INV_NUM
                ,'BASE'                     AS XX_DSPL_TP_TXT
                ,C.START_DT                 AS START_DT
                ,C.END_DT                   AS END_DT
                ,C.BASE_AMT                 AS BASE_AMT
                ,''                         AS CNT_TP_CD
            FROM
                 DS_CONTR_DTL       A
                ,SVC_MACH_MSTR      B
                ,CM_MAINT_INV_SER   C
            WHERE
                    A.EZCANCELFLAG        = '0'
                AND A.GLBL_CMPY_CD        = #glblCmpyCd#
                AND A.DS_CONTR_DTL_PK     = #dsContrDtlPk#
                AND B.EZCANCELFLAG        = '0'
                AND A.GLBL_CMPY_CD        = B.GLBL_CMPY_CD
                AND A.SVC_MACH_MSTR_PK    = B.SVC_MACH_MSTR_PK
                AND C.EZCANCELFLAG        = '0'
                AND B.GLBL_CMPY_CD        = C.GLBL_CMPY_CD
                AND B.SER_NUM             = C.SER_NUM
                AND C.AP_VND_CD           = #vndCd#
            UNION ALL
            SELECT
                 C.AP_INV_NUM               AS AP_INV_NUM
                ,'USAGE - ' || C.CNT_TP_CD  AS XX_DSPL_TP_TXT
                ,C.START_DT                 AS START_DT
                ,C.END_DT                   AS END_DT
                <!-- START 2017/10/23 [QC#21839, ADD] -->
                ,C.AP_TOL_AMT               AS BASE_AMT
                <!-- END 2017/10/23 [QC#21839, ADD] -->
                ,C.CNT_TP_CD                AS CNT_TP_CD
            FROM
                 DS_CONTR_DTL       A
                ,SVC_MACH_MSTR      B
                ,CM_MAINT_INV_MTR   C
            WHERE
                    A.EZCANCELFLAG        = '0'
                AND A.GLBL_CMPY_CD        = #glblCmpyCd#
                AND A.DS_CONTR_DTL_PK     = #dsContrDtlPk#
                AND B.EZCANCELFLAG        = '0'
                AND A.GLBL_CMPY_CD        = B.GLBL_CMPY_CD
                AND A.SVC_MACH_MSTR_PK    = B.SVC_MACH_MSTR_PK
                AND C.EZCANCELFLAG        = '0'
                AND B.GLBL_CMPY_CD        = C.GLBL_CMPY_CD
                AND B.SER_NUM             = C.SER_NUM
                AND C.AP_VND_CD           = #vndCd#
            ) M
        ORDER BY M.START_DT DESC, M.CNT_TP_CD NULLS FIRST
    </statement>
    <resultMap id="result.getDealHistInfo" class="NSAL0500_CSMsg">
        <result property="apInvNum_C0" column="AP_INV_NUM"        javaType="EZDSStringItem"/>
        <result property="xxDsplTpTxt_C0" column="XX_DSPL_TP_TXT"    javaType="EZDSStringItem"/>
        <result property="startDt_C0"     column="START_DT"          javaType="EZDSDateItem"/>
        <result property="endDt_C0"       column="END_DT"            javaType="EZDSDateItem"/>
        <result property="baseAmt_C0"     column="BASE_AMT"          javaType="EZDSBigDecimalItem"/>
    </resultMap>

    <statement id="getVndNm" parameterClass="Map" resultClass="String">
        SELECT
             PV.PRNT_VND_NM AS PRNT_VND_NM
        FROM
             VND            V
            ,VND_TP_RELN    VTR
            ,PRNT_VND       PV
        WHERE
            V.GLBL_CMPY_CD      = #cMsg.glblCmpyCd#
        AND V.VND_CD            = #cMsg.vndCd#
        AND V.RGTN_STS_CD       = #rgtnStsCdIsReadyForOrder#
<!-- START 2016/10/31 N.Arai [QC#14840, MOD] -->
        AND NVL(V.EFF_THRU_DT,#slsDt#)  &gt;= #slsDt#
<!-- END 2016/10/31 N.Arai [QC#14840, MOD] -->
        AND V.EZCANCELFLAG      = '0'
        AND V.GLBL_CMPY_CD      = VTR.GLBL_CMPY_CD
        AND V.VND_CD            = VTR.VND_CD
        AND VTR.EZCANCELFLAG    = '0'
        AND PV.GLBL_CMPY_CD     = V.GLBL_CMPY_CD
        AND PV.PRNT_VND_PK      = V.PRNT_VND_PK
        AND (PV.INAC_DT IS NULL
            OR PV.INAC_DT &gt; #slsDt#)
        AND PV.EZCANCELFLAG     = '0'
        AND ROWNUM              = 1
   </statement>

    <statement id="getDefTech" parameterClass="Map" resultClass="String">
        SELECT
            TECH_TOC_CD
        FROM (
            SELECT
                E.TECH_TOC_CD
            FROM
                 VND            A
                ,CTAC_PSN       B
                ,S21_PSN        D
                ,TECH_MSTR      E
                ,DS_CTAC_PSN_RELN F
            WHERE
                    A.GLBL_CMPY_CD        =     #cMsg.glblCmpyCd#
                AND A.VND_CD              =     #cMsg.vndCd#
                AND A.LOC_NUM             =     F.LOC_NUM
                AND A.GLBL_CMPY_CD        =     F.GLBL_CMPY_CD
                AND F.CTAC_PSN_PK         =     B.CTAC_PSN_PK
                AND F.GLBL_CMPY_CD        =     B.GLBL_CMPY_CD
                AND B.CTAC_PSN_ACTV_FLG   =     #ctacPsnActvFlg#
                AND B.CTAC_PSN_PK         =     D.CTAC_PSN_PK
                AND B.GLBL_CMPY_CD        =     D.GLBL_CMPY_CD
                AND D.EFF_FROM_DT     &lt;= #slsDt#
                AND NVL(D.EFF_THRU_DT, #maxThruDt#)     &gt;= #slsDt#
                AND D.DEL_FLG             =     #delFlg#
                AND D.PSN_CD              =     E.TECH_TOC_CD
                AND D.GLBL_CMPY_CD        =     E.GLBL_CMPY_CD
                AND A.EZCANCELFLAG    =     '0'
                AND B.EZCANCELFLAG    =     '0'
                AND D.EZCANCELFLAG    =     '0'
                AND E.EZCANCELFLAG    =     '0'
                AND F.EZCANCELFLAG    =     '0'
            ORDER BY
                E.TECH_TOC_CD)
        WHERE
            ROWNUM = #rowNum#
   </statement>

    <!-- START 2016/12/14 K.Kojima [QC#15653,ADD] -->
    <statement id="getTechMstr" parameterClass="Map" resultClass="String">
        SELECT
            TM.TECH_TOC_CD
        FROM
             TECH_MSTR TM
        WHERE
                TM.GLBL_CMPY_CD                   = #glblCmpyCd#
            AND TM.TECH_TOC_CD                    = #techTocCd#
            AND TM.EZCANCELFLAG                   = '0'
            AND EXISTS(
                SELECT
                    1
                FROM
                     ORG_FUNC_ASG     OFA
                    ,TOC              T
                    ,ORG_FUNC_ROLE_TP OFRT
                WHERE
                        OFA.GLBL_CMPY_CD                  = TM.GLBL_CMPY_CD
                    AND OFA.PSN_CD                        = TM.TECH_TOC_CD
                    AND OFA.EFF_FROM_DT               &lt;= #slsDt#
                    AND NVL(OFA.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
                    AND OFA.GLBL_CMPY_CD                  = T.GLBL_CMPY_CD
                    AND OFA.TOC_CD                        = T.TOC_CD
                    AND T.GLBL_CMPY_CD                    = OFRT.GLBL_CMPY_CD
                    AND T.ORG_FUNC_ROLE_TP_CD             = OFRT.ORG_FUNC_ROLE_TP_CD
                    AND OFRT.TECH_MSTR_REQ_FLG            = #flgY#
                    AND OFRT.ACTV_FLG                     = #flgY#
                    AND OFA.EZCANCELFLAG                  = '0'
                    AND T.EZCANCELFLAG                    = '0'
                    AND OFRT.EZCANCELFLAG                 = '0'
            )
    </statement>
    <!-- END 2016/12/14 K.Kojima [QC#15653,ADD] -->

    <!-- add start 2017/03/01 CSA QC#17575 -->
    <statement id="get3rdPartyTech" parameterClass="Map" resultClass="String">
        SELECT
            SP.PSN_CD
        FROM
             VND              V
            ,DS_CTAC_PSN_RELN DCPR
            ,S21_PSN          SP
        WHERE
                V.GLBL_CMPY_CD               = #glblCmpyCd#
            AND V.VND_CD                     = #vndCd#
            AND V.EZCANCELFLAG               = '0'
            AND V.GLBL_CMPY_CD               = DCPR.GLBL_CMPY_CD
            AND V.LOC_NUM                    = DCPR.LOC_NUM
            AND DCPR.EZCANCELFLAG            = '0'
            AND DCPR.GLBL_CMPY_CD            = SP.GLBL_CMPY_CD
            AND DCPR.CTAC_PSN_PK             = SP.CTAC_PSN_PK
            AND SP.EZCANCELFLAG              = '0'
            AND SP.PSN_TP_CD                 &lt;&gt; #psnTpCd#
            AND SP.PSN_CD                    = #techTocCd#
            AND SP.EFF_FROM_DT               &lt;= #slsDt#
            AND NVL(SP.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
    </statement>
    <!-- add end 2017/03/01 CSA QC#17575 -->
    <!-- START 2018/12/10  K.Fujimoto [QC#29079, ADD] -->
    <statement id="getSubContrMtrInfo" parameterClass="Map" resultMap="result.getSubContrMtrInfo">
        <isNotNull property="cMsg.dsSubContrPk">
        SELECT
             DSCM.DS_SUB_CONTR_MTR_PK     AS DS_SUB_CONTR_MTR_PK
            ,ML.MTR_LB_CD                 AS BLLG_MTR_LB_CD
            ,ML.MTR_LB_DESC_TXT           AS MTR_LB_DESC_TXT
            ,DSCM.MTR_ALWNC_CNT           AS MTR_ALWNC_CNT
            ,DSCM.PRC_MTR_RATE            AS PRC_MTR_RATE
        FROM
             DS_SUB_CONTR_MTR          DSCM
            ,DS_CONTR_BLLG_MTR         DCBM
            ,DS_CONTR_BLLG_MTR_STS_V   DCBMS
            ,MTR_LB                    ML
        WHERE
                DSCM.GLBL_CMPY_CD          = #cMsg.glblCmpyCd#
            AND DSCM.DS_SUB_CONTR_PK       = #cMsg.dsSubContrPk#
            AND DSCM.GLBL_CMPY_CD          = DCBM.GLBL_CMPY_CD
            AND DSCM.BLLG_MTR_LB_CD        = DCBM.BLLG_MTR_LB_CD
            AND DCBM.DS_CONTR_DTL_PK       = #dsContrDtlPk#
            AND DCBM.GLBL_CMPY_CD          = DCBMS.GLBL_CMPY_CD
            AND DCBM.DS_CONTR_BLLG_MTR_PK  = DCBMS.DS_CONTR_BLLG_MTR_PK
            AND DCBMS.DS_CONTR_CTRL_STS_CD &lt;&gt; #cancelledSts#
            AND DSCM.GLBL_CMPY_CD          = ML.GLBL_CMPY_CD
            AND DSCM.BLLG_MTR_LB_CD        = ML.MTR_LB_CD
            AND DSCM.EZCANCELFLAG          = '0'
            AND DCBM.EZCANCELFLAG          = '0'
            AND DCBMS.EZCANCELFLAG         = '0'
            AND ML.EZCANCELFLAG            = '0'
        
        UNION ALL
        </isNotNull>
        SELECT
             NULL                         AS DS_SUB_CONTR_MTR_PK
            ,ML.MTR_LB_CD                 AS BLLG_MTR_LB_CD
            ,ML.MTR_LB_DESC_TXT           AS MTR_LB_DESC_TXT
            ,NULL                         AS MTR_ALWNC_CNT
            ,NULL                         AS PRC_MTR_RATE
        FROM
             DS_CONTR_BLLG_MTR         DCBM
            ,DS_CONTR_BLLG_MTR_STS_V   DCBMS
            ,MTR_LB                    ML
        WHERE
                DCBM.GLBL_CMPY_CD          = #cMsg.glblCmpyCd#
            AND DCBM.DS_CONTR_DTL_PK       = #dsContrDtlPk#
            AND DCBM.GLBL_CMPY_CD          = DCBMS.GLBL_CMPY_CD
            AND DCBM.DS_CONTR_BLLG_MTR_PK  = DCBMS.DS_CONTR_BLLG_MTR_PK
            AND DCBMS.DS_CONTR_CTRL_STS_CD &lt;&gt; #cancelledSts#
            AND DCBM.GLBL_CMPY_CD          = ML.GLBL_CMPY_CD
            AND DCBM.BLLG_MTR_LB_CD        = ML.MTR_LB_CD
            AND DCBM.EZCANCELFLAG          = '0'
            AND DCBMS.EZCANCELFLAG         = '0'
            AND ML.EZCANCELFLAG            = '0'
            <isNotNull property="cMsg.dsSubContrPk">
            AND NOT EXISTS
                (
                  SELECT
                       1
                  FROM
                       DS_SUB_CONTR_MTR DSCM
                  WHERE
                          DSCM.GLBL_CMPY_CD    = DCBM.GLBL_CMPY_CD
                      AND DSCM.DS_SUB_CONTR_PK = #cMsg.dsSubContrPk#
                      AND DSCM.BLLG_MTR_LB_CD  = DCBM.BLLG_MTR_LB_CD
                      AND DSCM.EZCANCELFLAG    = '0'
                )
            </isNotNull>
        ORDER BY BLLG_MTR_LB_CD ASC
    </statement>
    <resultMap id="result.getSubContrMtrInfo" class="NSAL0500_ECMsg">
        <result property="dsSubContrMtrPk_E0" column="DS_SUB_CONTR_MTR_PK"      javaType="EZDSBigDecimalItem"/>
        <result property="bllgMtrLbCd_E0"     column="BLLG_MTR_LB_CD"           javaType="EZDSStringItem"/>
        <result property="mtrLbDescTxt_E0"    column="MTR_LB_DESC_TXT"          javaType="EZDSStringItem"/>
        <result property="mtrAlwncCnt_E0"     column="MTR_ALWNC_CNT"            javaType="EZDSBigDecimalItem"/>
        <result property="prcMtrRate_E0"      column="PRC_MTR_RATE"             javaType="EZDSBigDecimalItem"/>
    </resultMap>
    
    <statement id="getDsSubContrMtrForDelete" parameterClass="Map" resultClass="Map">
        SELECT
            GLBL_CMPY_CD
           ,DS_SUB_CONTR_MTR_PK
        FROM
             DS_SUB_CONTR_MTR DSCM
        WHERE 
                DSCM.GLBL_CMPY_CD     = #cMsg.glblCmpyCd#
            AND DSCM.DS_SUB_CONTR_PK  = #cMsg.dsSubContrPk#
            AND DSCM.EZCANCELFLAG     = '0'
            AND NOT EXISTS
                (
                  SELECT
                       1
                  FROM
                       DS_CONTR_BLLG_MTR         DCBM
                      ,DS_CONTR_BLLG_MTR_STS_V   DCBMS
                  WHERE 
                          DSCM.GLBL_CMPY_CD          = DCBM.GLBL_CMPY_CD
                      AND DSCM.BLLG_MTR_LB_CD        = DCBM.BLLG_MTR_LB_CD
                      AND DCBM.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                      AND DCBM.GLBL_CMPY_CD          = DCBMS.GLBL_CMPY_CD
                      AND DCBM.DS_CONTR_BLLG_MTR_PK  = DCBMS.DS_CONTR_BLLG_MTR_PK
                      AND DCBMS.DS_CONTR_CTRL_STS_CD &lt;&gt; #cancelledSts#
                      AND DCBM.EZCANCELFLAG          = '0'
                      AND DCBMS.EZCANCELFLAG         = '0'
                )
    </statement>

    <statement id="getDsContrDtlLine" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             DCD.DS_CONTR_DTL_PK
        FROM
             DS_CONTR_DTL DCD
        WHERE
                DCD.GLBL_CMPY_CD       = #cMsg.glblCmpyCd#
            AND DCD.DS_CONTR_DTL_TP_CD = #dsContrDtlTpCd#
            AND DCD.EZCANCELFLAG       = '0'
            AND EXISTS
                (
                  SELECT
                       1
                  FROM
                       DS_CONTR_DTL    DCD2
                      ,DS_CONTR        DC
                  WHERE
                          DC.GLBL_CMPY_CD            = DCD2.GLBL_CMPY_CD
                      AND DC.DS_CONTR_PK             = DCD2.DS_CONTR_PK
                      AND DCD2.DS_CONTR_PK           = DCD.DS_CONTR_PK
                      AND DCD2.DS_CONTR_DTL_PK       = #cMsg.dsContrDtlPk#
                      AND DC.EZCANCELFLAG            = '0'
                      AND DCD2.EZCANCELFLAG          = '0'
                )
    </statement>
    <!-- END   2018/12/10  K.Fujimoto [QC#29079, ADD] -->
</sqlMap>
