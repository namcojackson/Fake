<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSXC003001CallTaxCalcAPICommon">
    <statement id="getBillToInfo" parameterClass="Map" resultClass="Map">
        SELECT
             A.SELL_TO_CUST_CD          AS SELL_TO_CUST_CD
            ,A.DS_TAX_GRP_EXEM_CD       AS DS_TAX_GRP_EXEM_CD
            ,C.DS_TAX_GRP_EXEM_RESL_FLG AS DS_TAX_GRP_EXEM_RESL_FLG
        FROM
             BILL_TO_CUST           A
            ,DS_TAX_GRP_EXEM        C
        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            AND A.BILL_TO_CUST_CD       = #billToCustCd#
            AND A.EZCANCELFLAG          = '0'
            AND A.GLBL_CMPY_CD          = C.GLBL_CMPY_CD(+)
            AND A.DS_TAX_GRP_EXEM_CD    = C.DS_TAX_GRP_EXEM_CD(+)
            AND C.EZCANCELFLAG(+)       = '0'

    </statement>
    <statement id="getShipToInfo" parameterClass="Map" resultClass="Map">
        SELECT
             A.DS_TAX_GRP_EXEM_CD     AS DS_TAX_GRP_EXEM_CD
            ,A.GEO_CD                 AS GEO_CD
            ,A.DS_INSD_CTY_LIMIT_FLG  AS DS_INSD_CTY_LIMIT_FLG
            ,NVL(C.TAX_AREA_ID, NVL(C1.TAX_AREA_ID, C2.TAX_AREA_ID)) AS TAX_AREA_ID
            ,A.FIRST_LINE_ADDR        AS FIRST_LINE_ADDR
            ,A.SCD_LINE_ADDR          AS SCD_LINE_ADDR
            ,A.CTY_ADDR               AS CTY_ADDR
            ,A.ST_CD                  AS ST_CD
            ,D.CNTY_NM                AS CNTY_NM
            ,A.POST_CD                AS POST_CD
            ,A.CTRY_CD                AS CTRY_CD
        FROM
             SHIP_TO_CUST           A
            ,TAX_AREA               C
            ,TAX_AREA               C1
            ,TAX_AREA               C2
            ,CNTY                   D
        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            AND A.SHIP_TO_CUST_CD       = #shipToCustCd#
            AND A.EZCANCELFLAG          = '0'
            AND A.GLBL_CMPY_CD          = C.GLBL_CMPY_CD    (+)
            AND A.CTY_ADDR              = C.CTY_ADDR        (+)
            AND A.CNTY_PK               = C.CNTY_PK         (+)
            AND A.ST_CD                 = C.ST_CD           (+)
            AND C.EZCANCELFLAG      (+) = '0'
            AND A.GLBL_CMPY_CD          = C1.GLBL_CMPY_CD    (+)
            AND A.CNTY_PK               = C1.CNTY_PK         (+)
            AND A.ST_CD                 = C1.ST_CD           (+)
            AND C1.CTY_ADDR         (+) IS NULL
            AND C1.EZCANCELFLAG     (+) = '0'
            AND A.GLBL_CMPY_CD          = C2.GLBL_CMPY_CD    (+)
            AND A.ST_CD                 = C2.ST_CD           (+)
            AND C2.CTY_ADDR         (+) IS NULL
            AND C2.CNTY_PK          (+) IS NULL
            AND C2.EZCANCELFLAG     (+) = '0'
            AND A.GLBL_CMPY_CD          = D.GLBL_CMPY_CD    (+)
            AND A.CNTY_PK               = D.CNTY_PK         (+)
            AND D.EZCANCELFLAG      (+) = '0'
    </statement>
    <statement id="getDsInvInfo" parameterClass="Map" resultClass="Map">
        SELECT
             C.TAX_CALC_FLG      AS TAX_CALC_FLG
            ,C.TAX_EXEM_FLG      AS TAX_EXEM_FLG
            ,C.TAX_EXEM_RSN_CD   AS TAX_EXEM_RSN_CD
        FROM
             DS_CONTR               A
            ,DS_CONTR_CLS           B
            ,DS_INV_TP              C
        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            AND A.EZCANCELFLAG          = '0'
            AND A.DS_CONTR_PK           = #dsContrPk#
            AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
            AND A.DS_CONTR_CLS_CD       = B.DS_CONTR_CLS_CD
            AND B.EZCANCELFLAG          = '0'
            AND B.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
            AND B.DS_INV_TP_CD          = C.DS_INV_TP_CD
            AND C.EZCANCELFLAG          = '0'

    </statement>
    <statement id="getDsMdseInfo" parameterClass="Map" resultClass="Map">
        SELECT
             A.SVC_ALLOC_TP_CD     AS SVC_ALLOC_TP_CD
            ,B.SVC_ALLOC_TRX_TP_NM AS SVC_ALLOC_TRX_TP_NM
            ,A.TAX_EXEM_TP_CD      AS TAX_EXEM_TP_CD
        FROM
             MDSE         A
            ,SVC_ALLOC_TP B
        WHERE
                A.GLBL_CMPY_CD    = #glblCmpyCd#
            AND A.MDSE_CD         = #mdseCd#
            AND A.EZCANCELFLAG    = '0'
<!-- START 2023/11/10 [QC#61468, MOD] -->
<!--            AND A.GLBL_CMPY_CD    = B.GLBL_CMPY_CD        -->
<!--            AND A.SVC_ALLOC_TP_CD = B.SVC_ALLOC_TP_CD     -->
<!--            AND B.EZCANCELFLAG    = '0'                   -->
            AND A.GLBL_CMPY_CD    = B.GLBL_CMPY_CD(+)
            AND A.SVC_ALLOC_TP_CD = B.SVC_ALLOC_TP_CD(+)
            AND B.EZCANCELFLAG(+) = '0'
<!-- END   2023/11/10 [QC#61468, MOD] -->

    </statement>

<!-- START 2017/02/28 N.Arai [QC#17748, ADD] -->
    <statement id="getSalesRepInfo" parameterClass="Map" resultClass="Map">
        SELECT
             SP.FIRST_LINE_ADDR         AS FIRST_LINE_ADDR
            ,SP.SCD_LINE_ADDR           AS SCD_LINE_ADDR
            ,SP.THIRD_LINE_ADDR         AS THIRD_LINE_ADDR
            ,SP.FRTH_LINE_ADDR          AS FRTH_LINE_ADDR
            ,SP.CTY_ADDR                AS CTY_ADDR
            ,SP.PROV_NM                 AS PROV_NM
            ,SP.ST_CD                   AS ST_CD
            ,SP.POST_CD                 AS POST_CD
            ,SP.CTRY_CD                 AS CTRY_CD
            ,SP.GEO_CD                  AS GEO_CD
            ,SP.DS_INSD_CTY_LIMIT_FLG   AS DS_INSD_CTY_LIMIT_FLG
            ,CT.CNTY_NM                 AS CNTY_NM
        FROM
             ORG_FUNC_ASG OFA
            ,S21_PSN SP
            ,CNTY CT
        WHERE
                OFA.GLBL_CMPY_CD                    = #glblCmpyCd#
            AND OFA.TOC_CD                          = #tocCd#
            AND OFA.EFF_FROM_DT                     &lt;= #nextBllgDt#
            AND NVL(OFA.EFF_THRU_DT,'99991231')     &gt;= #nextBllgDt#
            AND OFA.EZCANCELFLAG                    = '0'
            AND OFA.GLBL_CMPY_CD                    = SP.GLBL_CMPY_CD
            AND OFA.PSN_CD                          = SP.PSN_CD
            AND SP.EZCANCELFLAG                     = '0'
            AND SP.GLBL_CMPY_CD                     = CT.GLBL_CMPY_CD(+)
            AND SP.CNTY_PK                          = CT.CNTY_PK(+)
            AND CT.EZCANCELFLAG(+)                  = '0'
    </statement>
<!-- END 2017/02/28 N.Arai [QC#17748, ADD] -->
<!-- add start 2018/07/25 QC#27329 -->
    <statement id="getOrigSvcInvInfo" parameterClass="Map" resultClass="Map">
        SELECT
             A.SVC_INV_NUM              AS SVC_INV_NUM
            ,A.SVC_INV_LINE_NUM         AS SVC_INV_LINE_NUM
            ,B.INV_DT                   AS INV_DT
            ,C.BILL_TO_CUST_CD          AS BILL_TO_CUST_CD
            ,C.SELL_TO_CUST_CD          AS BILL_TO_ACCT_NUM
            ,C.DS_TAX_GRP_EXEM_CD       AS BILL_TO_TAX_GRP_EXEM_CD
            ,D.DS_TAX_GRP_EXEM_RESL_FLG AS BILL_TO_TAX_GRP_EXEM_RESL_FLG

            ,E.SHIP_TO_CUST_CD          AS SHIP_TO_CUST_CD
            ,E.SELL_TO_CUST_CD          AS SHIP_TO_ACCT_NUM
            ,E.DS_TAX_GRP_EXEM_CD       AS SHIP_TO_TAX_GRP_EXEM_CD
            ,E.GEO_CD                   AS SHIP_TO_GEO_CD
            ,E.DS_INSD_CTY_LIMIT_FLG    AS SHIP_TO_DS_INSD_CTY_LIMIT_FLG
            ,NVL(F.TAX_AREA_ID, NVL(F1.TAX_AREA_ID, F2.TAX_AREA_ID)) 
                                        AS SHIP_TO_TAX_AREA_ID

            ,H.SHIP_TO_FIRST_LINE_ADDR  AS SHIP_TO_FIRST_LINE_ADDR
            ,H.SHIP_TO_SCD_LINE_ADDR    AS SHIP_TO_SCD_LINE_ADDR
            ,H.SHIP_TO_CTY_ADDR         AS SHIP_TO_CTY_ADDR
            ,H.SHIP_TO_ST_CD            AS SHIP_TO_ST_CD
            ,H.SHIP_TO_CNTY_NM          AS SHIP_TO_CNTY_NM
            ,H.SHIP_TO_POST_CD          AS SHIP_TO_POST_CD
            ,H.SHIP_TO_CTRY_CD          AS SHIP_TO_CTRY_CD

            ,J.GEO_CD                   AS SLS_REP_GEO_CD
            ,J.DS_INSD_CTY_LIMIT_FLG    AS SLS_REP_DS_INSD_CTY_LIMIT_FLG
            ,J.FIRST_LINE_ADDR          AS SLS_REP_FIRST_LINE_ADDR
            ,J.SCD_LINE_ADDR            AS SLS_REP_SCD_LINE_ADDR
            ,J.CTY_ADDR                 AS SLS_REP_CTY_ADDR
            ,J.ST_CD                    AS SLS_REP_ST_CD
            ,J.POST_CD                  AS SLS_REP_POST_CD
            ,J.CTRY_CD                  AS SLS_REP_CTRY_CD
            ,K.CNTY_NM                  AS SLS_REP_CNTY_NM
        FROM
             SVC_INV_LINE    A
            ,SVC_INV         B
            ,BILL_TO_CUST    C
            ,DS_TAX_GRP_EXEM D
            ,SHIP_TO_CUST    E
            ,TAX_AREA        F
            ,TAX_AREA        F1
            ,TAX_AREA        F2
            ,INV_LINE        G
            ,INV_BOL         H
            ,ORG_FUNC_ASG    I
            ,S21_PSN         J
            ,CNTY            K
        WHERE
                A.GLBL_CMPY_CD          = #glblCmpyCd#
            AND A.DS_CONTR_BLLG_SCHD_PK = #dsContrBllgSchdPk#
            AND A.EZCANCELFLAG          = '0'
            AND A.GLBL_CMPY_CD          = B.GLBL_CMPY_CD
            AND A.SVC_INV_NUM           = B.SVC_INV_NUM
            AND B.EZCANCELFLAG          = '0'
            AND B.GLBL_CMPY_CD          = C.GLBL_CMPY_CD
            AND B.BILL_TO_CUST_CD       = C.BILL_TO_CUST_CD
            AND C.EZCANCELFLAG          = '0'
            AND C.GLBL_CMPY_CD          = D.GLBL_CMPY_CD      (+)
            AND C.DS_TAX_GRP_EXEM_CD    = D.DS_TAX_GRP_EXEM_CD(+)
            AND D.EZCANCELFLAG      (+) = '0'

            AND A.GLBL_CMPY_CD          = E.GLBL_CMPY_CD
            AND A.SHIP_TO_CUST_CD       = E.SHIP_TO_CUST_CD
            AND E.EZCANCELFLAG          = '0'
            AND E.GLBL_CMPY_CD          = F.GLBL_CMPY_CD     (+)
            AND E.CTY_ADDR              = F.CTY_ADDR         (+)
            AND E.CNTY_PK               = F.CNTY_PK          (+)
            AND E.ST_CD                 = F.ST_CD            (+)
            AND F.EZCANCELFLAG      (+) = '0'
            AND E.GLBL_CMPY_CD          = F1.GLBL_CMPY_CD    (+)
            AND E.CNTY_PK               = F1.CNTY_PK         (+)
            AND E.ST_CD                 = F1.ST_CD           (+)
            AND F1.CTY_ADDR         (+) IS NULL
            AND F1.EZCANCELFLAG     (+) = '0'
            AND E.GLBL_CMPY_CD          = F2.GLBL_CMPY_CD    (+)
            AND E.ST_CD                 = F2.ST_CD           (+)
            AND F2.CTY_ADDR         (+) IS NULL
            AND F2.CNTY_PK          (+) IS NULL
            AND F2.EZCANCELFLAG     (+) = '0'

            AND A.GLBL_CMPY_CD          = G.GLBL_CMPY_CD
            AND A.SVC_INV_LINE_PK       = G.SVC_INV_LINE_PK
            AND G.EZCANCELFLAG          = '0'
            AND G.GLBL_CMPY_CD          = H.GLBL_CMPY_CD
            AND G.INV_NUM               = H.INV_NUM
            AND G.INV_BOL_LINE_NUM      = H.INV_BOL_LINE_NUM
            AND H.EZCANCELFLAG          = '0'

            AND B.GLBL_CMPY_CD          = I.GLBL_CMPY_CD     (+)
            AND B.SLS_REP_TOC_CD        = I.TOC_CD           (+)
            AND B.INV_DT                &gt;= I.EFF_FROM_DT  (+)
            AND B.INV_DT                &lt;= NVL(I.EFF_THRU_DT, B.INV_DT)
            AND I.EZCANCELFLAG      (+) = '0'
            AND I.GLBL_CMPY_CD          = J.GLBL_CMPY_CD     (+)
            AND I.PSN_CD                = J.PSN_CD           (+)
            AND J.EZCANCELFLAG      (+) = '0'
            AND J.GLBL_CMPY_CD          = K.GLBL_CMPY_CD     (+)
            AND J.CNTY_PK               = K.CNTY_PK          (+)
            AND K.EZCANCELFLAG      (+) = '0'
    </statement>
<!-- add end 2018/07/25 QC#27329 -->
<!-- START 2020/05/11 K.Sakurai [QC#56726, ADD] -->
    <statement id="getSvcMachMstrHist" parameterClass="Map" resultClass="Map">
        SELECT
            *
        FROM
            (
                SELECT
                     A.*
                    ,B.MDSE_NM
                FROM
                     SVC_MACH_MSTR_HIST A
                    ,MDSE               B
                WHERE
                        A.GLBL_CMPY_CD     = #glblCmpyCd#
                    AND A.SVC_MACH_MSTR_PK = #svcMachMstrPk#
                    <iterate property="svcMachMstrStsCdList" var="svcMachMstrStsCd[]" open="AND A.SVC_MACH_MSTR_STS_CD IN (" close=")" conjunction=",">
                        #svcMachMstrStsCd[]#
                    </iterate>
                    AND A.EZCANCELFLAG     = '0'
                    AND A.GLBL_CMPY_CD     = B.GLBL_CMPY_CD
                    AND A.MDSE_CD          = B.MDSE_CD
                    AND B.EZCANCELFLAG     = '0'
                ORDER BY
                    A.HIST_CRAT_TS DESC
            )
        WHERE
            ROWNUM = 1
    </statement>
<!-- END 2020/05/11 K.Sakurai [QC#56726, ADD] -->
</sqlMap>
