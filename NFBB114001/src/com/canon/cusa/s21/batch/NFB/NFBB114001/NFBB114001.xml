<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NFBB114001">

    <statement id="SELECT_RECORD" parameterClass="Map">
        SELECT
        <!-- CM_INV_ACCT_HDR -->
            CMI.AP_VND_CD       AP_VND_CD
        ,   CMI.AP_INV_NUM      AP_VND_INV_NUM
        ,   '00'                AP_VND_INV_SQ_NUM
        ,   NULL                LOC_NUM
        ,   'NONE'              PO_NUM
        ,   NULL                PMT_DUE_DT
        ,   NULL                VND_PMT_TERM_CD
        ,   NULL                ACCT_BANK_CD
        ,   NULL                ACCT_BANK_ACCT_PAY_TP_CD
        ,   'N'                 INV_TP_CD
        ,   'N'                 PMT_HLD_FLG
        ,   NULL                PMT_HLD_CD
        ,   NULL                PMT_HLD_DT
        ,   NULL                PMT_HLD_RSN_CD
        ,   NULL                PMT_HLD_PSN_CD
        ,   NULL                PMT_HLD_REL_PSN_CD
        ,   NULL                PMT_HLD_REL_DT
        ,   NULL                PMT_HLD_REL_RSN_CD
        ,   NULL                PMT_HLD_REL_CMNT_TXT
        ,   CMI.AP_INV_AMT      AP_INV_AMT
        ,   CMI.AP_ADJ_AMT      AP_ADJ_AMT
        ,   NULL                AP_INV_SRC_NM
        ,   NULL                AP_INV_DESC_TXT
        ,   'N'                 PAY_ALONE_FLG
        ,   NULL                INV_MATCH_TP_CD
        ,   NULL                INV_PMT_NUM
        ,   AP_BAT_NUM          INV_HDR_DESC_TXT
        ,   #acctInvStsCd#      ACCT_INV_STS_CD
        ,   V.SPLY_COA_CMPY_CD SPLY_COA_CMPY_CD
        ,   V.SPLY_COA_BR_CD   SPLY_COA_BR_CD
        ,   V.SPLY_COA_CC_CD   SPLY_COA_CC_CD
        ,   V.SPLY_COA_ACCT_CD SPLY_COA_ACCT_CD
        ,   V.SPLY_COA_PROD_CD SPLY_COA_PROD_CD
        ,   V.SPLY_COA_CH_CD   SPLY_COA_CH_CD
        ,   V.SPLY_COA_AFFL_CD SPLY_COA_AFFL_CD
        ,   V.SPLY_COA_PROJ_CD SPLY_COA_PROJ_CD
        ,   V.SPLY_COA_EXTN_CD SPLY_COA_EXTN_CD
        ,   NULL                AP_PMT_CHK_NUM
        ,   'N'                 IF_PROC_STS_CD
        ,   #apInvCatgCd#       AP_INV_CATG_CD
        ,   #invAuthDt#         INV_AUTH_DT
        ,   PV.PRNT_VND_CD      PRNT_VND_CD
        <!-- CM_INV_ACCT_DIST -->
        ,   CMIS.SER_NUM        MDSE_CD
        ,   CMIS.SER_NUM        MDSE_NM
        ,   'NO'                AP_INV_TP_CD
        ,   'NONE'              DELY_ORD_NUM
        ,   0                   INV_QTY
        ,   0                   PO_QTY
        ,   0                   INV_RCV_QTY
        ,   0                   AP_BILL_QTY
        ,   0                   AP_REJ_QTY
        ,   NULL                UOM_CD
        ,   0                   THIS_MTH_FOB_COST_AMT
        ,   0                   AC_INV_TAX_AMT
        ,   DECODE(CMI.AP_ADJ_AMT,0,NVL(CMIS.AP_TOL_AMT, 0) + CMIS.BASE_AMT,CMI.AP_ADJ_AMT)
                                AC_INV_JRNL_COST_AMT
        ,   NULL                INV_ASG_DT
        ,   NULL                STK_IN_DT
        ,   NULL                AP_INV_DESC_TXT
        ,   NULL                CSMP_INV_NUM
        ,   CMIS.SER_NUM        AS SER_NUM
        ,   NULL                CR_TERM_CD
        ,   STC.FIRST_LINE_ADDR AS ISTL_LOC_FIRST_LINE_ADDR
        ,   SMM.SVC_MACH_FL_NM  AS ISTL_LOC_FL_NM
        ,   STC.CTY_ADDR        AS ISTL_LOC_CTY_ADDR
        ,   STC.ST_CD           AS ISTL_LOC_ST_CD
        ,   STC.POST_CD         AS ISTL_LOC_POST_CD
        ,   NULL                INV_LINE_DESC_TXT
        ,   CDA.CM_COA_CMPY_CD  CM_COA_CMPY_CD
        ,   CDA.CM_COA_BR_CD    CM_COA_BR_CD
        ,   CDA.CM_COA_CC_CD    CM_COA_CC_CD
        ,   CDA.CM_COA_ACCT_CD  CM_COA_ACCT_CD
        ,   CDA.CM_COA_PROD_CD  CM_COA_PROD_CD
        ,   CDA.CM_COA_CH_CD    CM_COA_CH_CD
        ,   CDA.CM_COA_AFFL_CD  CM_COA_AFFL_CD
        ,   CDA.CM_COA_PROJ_CD  CM_COA_PROJ_CD
        ,   CDA.CM_COA_EXTN_CD  CM_COA_EXTN_CD
        ,   NULL                AP_ACCT_DESC_TXT
        ,   'N'                 AP_INV_AUTH_FLG
        ,   'N'                 AP_JRNL_CPLT_FLG
        ,   0                   ENT_DEAL_NET_UNIT_PRC_AMT
        ,   0                   ENT_PO_DTL_DEAL_NET_AMT
        ,   0                   ENT_FUNC_NET_UNIT_PRC_AMT
        ,   0                   ENT_PO_DTL_FUNC_NET_AMT
        ,   0                   EXCH_RATE
        ,   NULL                PO_ORD_DTL_LINE_NUM
        <!-- start 2018/03/28 QC#20316 ADD -->
        ,LPAD(TO_CHAR(ROW_NUMBER() OVER (PARTITION BY CMI.AP_VND_CD, CMI.AP_INV_NUM ORDER BY CMI.AP_VND_CD, CMI.AP_INV_NUM, CMIS.SER_NUM)), 4, '0')
                                AP_VND_INV_LINE_NUM
        <!-- end 2018/03/28 QC#20316 ADD -->
        ,LPAD(TO_CHAR(ROW_NUMBER() OVER (PARTITION BY CMI.AP_VND_CD, CMI.AP_INV_NUM ORDER BY CMI.AP_VND_CD, CMI.AP_INV_NUM, CMIS.SER_NUM)), 3, '0')
                                CM_INV_ACCT_DIST_LINE_NUM
        ,   CMI.DEAL_CCY_CD     CCY_CD
        ,   CMIS.START_DT
        ,   CMIS.END_DT
        FROM
            CM_MAINT_INV      CMI
        ,   CM_MAINT_INV_SER  CMIS
        ,   (
                SELECT
                    INV_VND_CD             VND_CD
                ,   MAX(SPLY_COA_CMPY_CD)  SPLY_COA_CMPY_CD
                ,   MAX(SPLY_COA_BR_CD)    SPLY_COA_BR_CD
                ,   MAX(SPLY_COA_CC_CD)    SPLY_COA_CC_CD
                ,   MAX(SPLY_COA_ACCT_CD)  SPLY_COA_ACCT_CD
                ,   MAX(SPLY_COA_PROD_CD)  SPLY_COA_PROD_CD
                ,   MAX(SPLY_COA_CH_CD)    SPLY_COA_CH_CD
                ,   MAX(SPLY_COA_AFFL_CD)  SPLY_COA_AFFL_CD
                ,   MAX(SPLY_COA_PROJ_CD)  SPLY_COA_PROJ_CD
                ,   MAX(SPLY_COA_EXTN_CD)  SPLY_COA_EXTN_CD
                FROM
                    VND
                WHERE 
                    GLBL_CMPY_CD = #glblCmpyCd#
                AND EZCANCELFLAG = '0'
                GROUP BY
                    INV_VND_CD
            )                 V
        ,   CM_DEF_ACCT       CDA
        ,   (
                SELECT
                    V.GLBL_CMPY_CD
                ,   V.INV_VND_CD
                ,   MAX(PV.PRNT_VND_CD)           PRNT_VND_CD
                ,   MAX(PV.PRNT_VND_NM)           PRNT_VND_NM
                FROM
                    PRNT_VND PV
                ,   VND      V
                WHERE
                    PV.GLBL_CMPY_CD   = #glblCmpyCd#
                AND PV.GLBL_CMPY_CD   = V.GLBL_CMPY_CD
                AND PV.PRNT_VND_PK    = V.PRNT_VND_PK
                AND PV.EZCANCELFLAG   = '0'
                AND V.EZCANCELFLAG   = '0'
                GROUP BY
                    V.GLBL_CMPY_CD
                ,   V.INV_VND_CD
            )                PV
          , SVC_MACH_MSTR             SMM
          , SHIP_TO_CUST              STC
        WHERE
            CMI.GLBL_CMPY_CD        = #glblCmpyCd#
        AND CMI.GLBL_CMPY_CD        = CMIS.GLBL_CMPY_CD
        AND CMI.AP_MAINT_INV_STS_CD = #apMaintInvStsCd#
        AND CMI.AP_VND_CD           = CMIS.AP_VND_CD
        AND CMI.AP_INV_NUM          = CMIS.AP_INV_NUM
        AND CMI.EZCANCELFLAG        = '0'
        AND CMIS.EZCANCELFLAG       = '0'
        <!-- start 2018/03/27 QC#20316 MOD -->
        AND NOT EXISTS
            (
                SELECT
                    1
                FROM
                    CM_INV_ACCT_DIST CIAD
                WHERE
                    CIAD.GLBL_CMPY_CD      = CMI.GLBL_CMPY_CD
                AND CIAD.AP_VND_CD         = CMI.AP_VND_CD
                AND CIAD.AP_VND_INV_NUM    = CMI.AP_INV_NUM
                AND CIAD.AP_VND_INV_SQ_NUM = '00'
                AND CIAD.EZCANCELFLAG      = '0'
            )
        <!-- end 2018/03/27 QC#20316 MOD -->
        AND CMIS.GLBL_CMPY_CD              = SMM.GLBL_CMPY_CD(+)
        AND CMIS.SER_NUM                   = SMM.SER_NUM(+)
        AND SMM.EZCANCELFLAG(+)            = '0'
        AND SMM.GLBL_CMPY_CD               = STC.GLBL_CMPY_CD(+)
        AND SMM.CUR_LOC_NUM                = STC.SHIP_TO_CUST_CD(+)
        AND STC.EZCANCELFLAG(+)            = '0'
        AND CMI.AP_VND_CD           = V.VND_CD(+)
        AND CMI.GLBL_CMPY_CD        = CDA.GLBL_CMPY_CD(+)
        AND #cmDefAcctCd#           = CDA.CM_DEF_ACCT_CD(+)
        AND '0'                     = CDA.EZCANCELFLAG(+)
        AND CMI.AP_VND_CD           = PV.INV_VND_CD(+)
        ORDER BY
            CMI.AP_VND_CD
        ,   CMI.AP_INV_NUM
    </statement>

    <statement id="SELECT_FIN_BR_CD" parameterClass="Map" resultClass="Map">
        SELECT
            FIN_BR_CD
        ,   EFF_FROM_DT
        FROM
            SVC_MACH_MSTR
        WHERE
            GLBL_CMPY_CD        = #glblCmpyCd#
        AND SER_NUM             = #serNum#
        AND EZCANCELFLAG        = '0'
        ORDER BY
            EFF_FROM_DT DESC
    </statement>

    <statement id="SELECT_CONTR_INFO" parameterClass="Map" resultClass="Map">
        SELECT
             DC.DS_CONTR_NUM
            ,DSC.VND_CD
        FROM
             DS_CONTR_DTL              DCD
            ,DS_CONTR                  DC
            ,DS_SUB_CONTR              DSC
        WHERE
            DCD.GLBL_CMPY_CD    = #glblCmpyCd#
        AND DCD.DS_CONTR_DTL_PK = #dsContrDtlPk#
        AND DCD.GLBL_CMPY_CD    = DC.GLBL_CMPY_CD(+)
        AND DCD.DS_CONTR_PK     = DC.DS_CONTR_PK(+)
        AND DCD.GLBL_CMPY_CD    = DSC.GLBL_CMPY_CD(+)
        AND DCD.DS_CONTR_DTL_PK = DSC.DS_CONTR_DTL_PK(+)
        AND #stDt#          &gt;= DSC.EFF_FROM_DT(+)
        AND #stDt#          &lt;= DSC.EFF_THRU_DT(+)
        AND #endDt#         &lt;= DSC.EFF_THRU_DT(+)
        AND DCD.EZCANCELFLAG    = '0'
        AND DC.EZCANCELFLAG(+)  = '0'
        AND DSC.EZCANCELFLAG(+) = '0'
    </statement>

</sqlMap>
