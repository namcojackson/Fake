<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NFBB116001">
    <statement id="getEnteredWriteOff" parameterClass="Map" resultClass="Map">
    SELECT
           INLINE1.VND_CD
          ,INLINE1.PO_NUM
          ,INLINE1.MDSE_CD
          ,INLINE1.DELY_ORD_NUM
          ,NVL(INLINE1.PO_QTY,0)                PO_QTY
          ,NVL(INLINE1.RCV_QTY,0)               RCV_QTY
          ,NVL(INLINE1.THIS_MTH_FOB_COST_AMT,0) THIS_MTH_FOB_COST_AMT
          ,INLINE1.INV_RCV_DT
          <!-- start 2016/09/28 QC#14130 ADD -->
          ,INLINE1.ENT_DEAL_NET_UNIT_PRC_AMT
          <!-- start 2016/09/28 QC#14130 ADD -->
          ,INLINE1.PO_ORD_DTL_LINE_NUM
      FROM
           CM_STK_IN INLINE1
     WHERE
           INLINE1.GLBL_CMPY_CD = #glblCmpyCd#
       AND INLINE1.EZCANCELFLAG = 0
       AND NOT EXISTS (
                       SELECT
                              INLINE2.DELY_ORD_NUM
                         FROM
                              CM_ACRL_WRITE_OFF INLINE2
                        WHERE INLINE2.EZCANCELFLAG = 0
                          AND INLINE1.GLBL_CMPY_CD = INLINE2.GLBL_CMPY_CD
                          <!-- START 2020/04/08 QC#56469 MOD -->
                          <!-- AND INLINE1.VND_CD       = INLINE2.AP_VND_CD -->
                          AND INLINE1.PO_ORD_NUM   = INLINE2.PO_NUM
                          <!-- END   2020/04/08 QC#56469 MOD -->
                          AND INLINE1.DELY_ORD_NUM = INLINE2.DELY_ORD_NUM
                          AND INLINE1.MDSE_CD      = INLINE2.MDSE_CD
                          AND INLINE1.INV_RCV_DT   = INLINE2.STK_IN_DT
                       )
    </statement>
    <statement id="getApprovedWriteOff" parameterClass="Map" resultClass="Map">
    <!-- start 2018/03/29 QC#20316 MOD -->
    SELECT
           INLINE1.GLBL_CMPY_CD
          ,INLINE1.AP_VND_CD
          ,INLINE1.AP_VND_INV_NUM
          ,INLINE1.AP_VND_INV_LINE_NUM
          ,INLINE1.AP_VND_INV_SQ_NUM
          ,INLINE1.LOC_NUM
          ,INLINE1.INV_DT
          ,INLINE1.PO_NUM
          ,INLINE1.MDSE_CD
          ,INLINE1.DELY_ORD_NUM
          ,INLINE1.INV_QTY
          ,INLINE1.PO_QTY
          ,INLINE1.INV_RCV_QTY
          ,INLINE1.THIS_MTH_FOB_COST_AMT
          ,INLINE1.AC_INV_JRNL_COST_AMT
          ,INLINE1.STK_IN_DT
          ,INLINE1.COA_CMPY_CD
          ,INLINE1.COA_BR_CD
          ,INLINE1.COA_CC_CD
          ,INLINE1.COA_ACCT_CD
          ,INLINE1.COA_PROD_CD
          ,INLINE1.COA_CH_CD
          ,INLINE1.COA_AFFL_CD
          ,INLINE1.COA_PROJ_CD
          ,INLINE1.COA_EXTN_CD
          <!-- start 2016/09/28 QC#14130 ADD -->
          ,INLINE1.ENT_DEAL_NET_UNIT_PRC_AMT
          <!-- end 2016/09/28 QC#14130 ADD -->
          ,INLINE1.PO_ORD_DTL_LINE_NUM

     FROM
          (
           SELECT
                  INLINE1_1.GLBL_CMPY_CD
                 ,INLINE1_1.AP_VND_CD
                 ,INLINE1_1.AP_VND_INV_NUM
                 ,INLINE1_2.AP_VND_INV_LINE_NUM
                 ,INLINE1_1.AP_VND_INV_SQ_NUM
                 ,INLINE1_1.LOC_NUM
                 ,INLINE1_1.INV_DT
                 <!-- START 2020/01/31 QC#53413 MOD -->
                 <!-- ,INLINE1_1.PO_NUM -->
                 ,INLINE1_2.PO_NUM
                 <!-- END   2020/01/31 QC#53413 MOD -->
                 ,INLINE1_2.MDSE_CD
                 ,INLINE1_2.DELY_ORD_NUM
                 <!-- start 2016/09/28 QC#14130 MOD -->
                 ,NVL(INLINE1_2.AP_BILL_QTY,0)           INV_QTY
                 <!-- end 2016/09/28 QC#14130 ADD -->
                 ,NVL(INLINE1_2.PO_QTY,0)                PO_QTY
                 ,NVL(INLINE1_2.INV_RCV_QTY,0)           INV_RCV_QTY
                 ,NVL(INLINE1_2.THIS_MTH_FOB_COST_AMT,0) THIS_MTH_FOB_COST_AMT
                 ,NVL(INLINE1_2.AC_INV_JRNL_COST_AMT,0)  AC_INV_JRNL_COST_AMT
                 ,INLINE1_2.STK_IN_DT
                 ,INLINE1_2.DR_COA_CMPY_CD               COA_CMPY_CD
                 ,INLINE1_2.DR_COA_BR_CD                 COA_BR_CD
                 ,INLINE1_2.DR_COA_CC_CD                 COA_CC_CD
                 ,INLINE1_2.DR_COA_ACCT_CD               COA_ACCT_CD
                 ,INLINE1_2.DR_COA_PROD_CD               COA_PROD_CD
                 ,INLINE1_2.DR_COA_CH_CD                 COA_CH_CD
                 ,INLINE1_2.DR_COA_AFFL_CD               COA_AFFL_CD
                 ,INLINE1_2.DR_COA_PROJ_CD               COA_PROJ_CD
                 ,INLINE1_2.DR_COA_EXTN_CD               COA_EXTN_CD
                 <!-- start 2016/09/28 QC#14130 ADD -->
                 ,NVL(INLINE1_2.ENT_DEAL_NET_UNIT_PRC_AMT,0)
                                                         ENT_DEAL_NET_UNIT_PRC_AMT
                 <!-- end 2016/09/28 QC#14130 ADD -->
                 ,INLINE1_2.PO_ORD_DTL_LINE_NUM
             FROM
                  CM_AP_INV_HDR    INLINE1_1
                 ,CM_INV_ACCT_DIST INLINE1_2
            WHERE
                  INLINE1_1.EZCANCELFLAG      = 0
              AND INLINE1_2.EZCANCELFLAG      = 0
              AND INLINE1_1.GLBL_CMPY_CD      = INLINE1_2.GLBL_CMPY_CD
              AND INLINE1_1.AP_VND_CD         = INLINE1_2.AP_VND_CD
              AND INLINE1_1.AP_VND_INV_NUM    = INLINE1_2.AP_VND_INV_NUM
              AND INLINE1_1.AP_VND_INV_SQ_NUM = INLINE1_2.AP_VND_INV_SQ_NUM
              AND INLINE1_1.GLBL_CMPY_CD      = #glblCmpyCd#
              <!-- mod start 2022/04/06 QC#57935 -->
              <!-- AND INLINE1_1.ACCT_INV_STS_CD   = #acctInvStsCd# -->
              <iterate property="acctInvStsCdList" var="acctInvStsCd[]" open="AND INLINE1_1.ACCT_INV_STS_CD IN (" close=")" conjunction=",">
                  #acctInvStsCd[]#
              </iterate>
              <!-- mod end 2022/04/06 QC#57935 -->
              AND INLINE1_1.AP_INV_CATG_CD    IN
                                                  <iterate property="listApInvCatgCd" var="listApInvCatgCd[]" open="(" close=")" conjunction=",">
                                                      #listApInvCatgCd[]#
                                                  </iterate>
              AND INLINE1_2.MDSE_CD           NOT IN
                                                  <iterate property="listExcludeMdseCd" var="listExcludeMdseCd[]" open="(" close=")" conjunction=",">
                                                      #listExcludeMdseCd[]#
                                                  </iterate>
          ) INLINE1
     WHERE NOT EXISTS (
                        SELECT
                              INLINE2.GLBL_CMPY_CD
                         FROM
                              CM_ACRL_WRITE_OFF INLINE2
                        WHERE INLINE2.EZCANCELFLAG        = 0
                          AND INLINE2.GLBL_CMPY_CD        = INLINE1.GLBL_CMPY_CD
                          AND INLINE2.AP_VND_CD           = INLINE1.AP_VND_CD
                          AND INLINE2.AP_VND_INV_NUM      = INLINE1.AP_VND_INV_NUM
                          AND INLINE2.AP_VND_INV_SQ_NUM   = INLINE1.AP_VND_INV_SQ_NUM
                          AND INLINE2.AP_VND_INV_LINE_NUM = INLINE1.AP_VND_INV_LINE_NUM
                       )
    <!-- end 2018/03/29 QC#20316 MOD -->
    </statement>
    <statement id="getAcrlCoaAccountCode" parameterClass="Map" resultClass="String">
        SELECT
            CPA.COA_ACCT_CD
        FROM
            MDSE                MDS
           ,COA_PROJ_ACCT       CPA
        WHERE
            MDS.MDSE_CD         = #mdseCd#
        AND MDS.GLBL_CMPY_CD    = #glblCmpyCd#
        AND MDS.EZCANCELFLAG    = '0'

        AND MDS.GLBL_CMPY_CD        = CPA.GLBL_CMPY_CD
        AND MDS.COA_MDSE_TP_CD      = CPA.COA_PROJ_CD
        AND CPA.COA_PROJ_ACCT_TP_CD = #acctTpCdAccrual#
        AND CPA.EZCANCELFLAG        = '0'

    </statement>
    <!-- END   2017/01/12 [QC#16928,MOD] -->
     
    <statement id="getCoaSegmentCode" parameterClass="Map" resultClass="Map">
    SELECT
          INLINE1.CM_COA_CMPY_CD
         ,INLINE1.CM_COA_BR_CD
         ,INLINE1.CM_COA_CC_CD
         ,INLINE1.CM_COA_PROD_CD
         ,INLINE1.CM_COA_CH_CD
         ,INLINE1.CM_COA_AFFL_CD
         ,INLINE1.CM_COA_PROJ_CD
         ,INLINE1.CM_COA_EXTN_CD
     FROM
          CM_DEF_ACCT INLINE1
    WHERE
          INLINE1.EZCANCELFLAG   = 0
      AND INLINE1.GLBL_CMPY_CD   = #glblCmpyCd#
      AND INLINE1.CM_DEF_ACCT_CD = #mdseCd#
    </statement>
</sqlMap>