<?xml version="1.0" encoding="UTF-8"?>

<sqlMap namespace="NMAB011001">

    <statement id ="getCostShiftTargetSCMdse" parameterClass="Map" resultClass="Map">
        SELECT
            M.MDSE_CD
           ,CST_HIST.MDSE_CST_UPD_HIST_HDR_PK
           ,CST_HIST.MDSE_CST_UPD_TP_CD
           ,CST_HIST.MDSE_CST_UPD_STS_CD
        FROM
            MDSE M
           ,(
             SELECT
                 D.MDSE_CD
                ,D.MDSE_CST_UPD_HIST_HDR_PK
                ,H.MDSE_CST_UPD_TP_CD
                ,D.MDSE_CST_UPD_STS_CD
                ,D.MDSE_CST_UPD_EFF_FROM_DT <!-- Add QC#16026 12/15/2016 -->
             FROM
                 MDSE_CST_UPD_HIST_HDR H
                ,MDSE_CST_UPD_HIST_DTL D
                ,MDSE_CST_UPD_TP UT
             WHERE
                 D.EZCANCELFLAG                 = '0' 
             AND D.GLBL_CMPY_CD                 = #glblCmpyCd#
             AND D.MDSE_CST_UPD_STS_CD          = #mdseCstUpdStsCd#
             AND D.MDSE_CST_UPD_EFF_FROM_DT &lt;= #nextSalesDate#
             AND D.EZCANCELFLAG                 = H.EZCANCELFLAG
             AND D.GLBL_CMPY_CD                 = H.GLBL_CMPY_CD
             AND D.MDSE_CST_UPD_HIST_HDR_PK     = H.MDSE_CST_UPD_HIST_HDR_PK
             AND H.EZCANCELFLAG                 = UT.EZCANCELFLAG
             AND H.GLBL_CMPY_CD                 = UT.GLBL_CMPY_CD
             AND H.MDSE_CST_UPD_TP_CD           = UT.MDSE_CST_UPD_TP_CD
             AND UT.STD_COST_RELN_FLG           = #stdCostRelnFlg#
             AND NOT EXISTS (SELECT '1' FROM MDSE_CST_UPD_HIST_DTL WHERE MDSE_CST_UPD_HIST_HDR_PK = D.MDSE_CST_UPD_HIST_HDR_PK AND MDSE_CST_UPD_STS_CD = 'PE')
           ) CST_HIST
        WHERE
            M.EZCANCELFLAG                      = '0' 
        AND M.GLBL_CMPY_CD                      = #glblCmpyCd#
        AND M.MDSE_CST_UPD_EFF_FROM_DT          IS NOT NULL
        AND M.NEXT_MTH_TOT_STD_COST_AMT         IS NOT NULL
        AND M.MDSE_CD                           = CST_HIST.MDSE_CD
        AND M.RGTN_STS_CD                       IN (#rgtnStsCdP10#, #rgtnStsCdP20#)
        ORDER BY M.MDSE_CD, CST_HIST.MDSE_CST_UPD_EFF_FROM_DT DESC  <!-- Add QC#16026 12/15/2016 -->
    </statement>
    
    <statement id ="getCostUpdateHistData" parameterClass="Map" resultClass="Map">
        SELECT
            D.MDSE_CST_UPD_HIST_HDR_PK
        FROM
            MDSE_CST_UPD_HIST_HDR H
           ,MDSE_CST_UPD_HIST_DTL D
        WHERE
            D.EZCANCELFLAG                      = '0' 
        AND D.GLBL_CMPY_CD                      = #glblCmpyCd#
        AND D.MDSE_CST_UPD_STS_CD               = #mdseCstUpdStsCd#
        AND H.MDSE_CST_UPD_TP_CD                = #mdseCstUpdTpCd#
        AND D.MDSE_CD                           = #mdseCd#
        AND D.MDSE_CST_UPD_EFF_FROM_DT      &lt;= #nextSalesDate#
        AND D.EZCANCELFLAG                      = H.EZCANCELFLAG
        AND D.GLBL_CMPY_CD                      = H.GLBL_CMPY_CD
        AND D.MDSE_CST_UPD_HIST_HDR_PK          = H.MDSE_CST_UPD_HIST_HDR_PK
    </statement>
    
    <statement id ="getCostShiftTargetARMdse" parameterClass="Map" resultClass="Map">
        SELECT
            M.MDSE_CD
           ,CST_HIST.MDSE_CST_UPD_HIST_HDR_PK
           ,CST_HIST.MDSE_CST_UPD_TP_CD
           ,CST_HIST.MDSE_CST_UPD_STS_CD
        FROM
            MDSE M
           ,(
             SELECT
                 D.MDSE_CD
                ,D.MDSE_CST_UPD_HIST_HDR_PK
                ,H.MDSE_CST_UPD_TP_CD
                ,D.MDSE_CST_UPD_STS_CD
             FROM
                 MDSE_CST_UPD_HIST_HDR H
                ,MDSE_CST_UPD_HIST_DTL D
                ,MDSE_CST_UPD_TP UT
             WHERE
                 D.EZCANCELFLAG                 = '0' 
             AND D.GLBL_CMPY_CD                 = #glblCmpyCd#
             AND D.MDSE_CST_UPD_STS_CD          = #mdseCstUpdStsCd#
             AND D.MDSE_CST_UPD_EFF_FROM_DT &lt;= #nextSalesDate#
             AND D.EZCANCELFLAG                 = H.EZCANCELFLAG
             AND D.GLBL_CMPY_CD                 = H.GLBL_CMPY_CD
             AND D.MDSE_CST_UPD_HIST_HDR_PK     = H.MDSE_CST_UPD_HIST_HDR_PK
             AND H.EZCANCELFLAG                 = UT.EZCANCELFLAG
             AND H.GLBL_CMPY_CD                 = UT.GLBL_CMPY_CD
             AND H.MDSE_CST_UPD_TP_CD           = UT.MDSE_CST_UPD_TP_CD
             AND UT.STD_COST_RELN_FLG           = #stdCostRelnFlg#
             AND NOT EXISTS (SELECT '1' FROM MDSE_CST_UPD_HIST_DTL WHERE MDSE_CST_UPD_HIST_HDR_PK = D.MDSE_CST_UPD_HIST_HDR_PK AND MDSE_CST_UPD_STS_CD = 'PE')
           ) CST_HIST
        WHERE
            M.EZCANCELFLAG                      = '0' 
        AND M.GLBL_CMPY_CD                      = #glblCmpyCd#
        AND M.NEXT_ASSET_RECOV_COST_AMT         IS NOT NULL
        AND M.MDSE_CD                           = CST_HIST.MDSE_CD
        AND M.RGTN_STS_CD                       IN (#rgtnStsCdP10#, #rgtnStsCdP20#)
    </statement>

</sqlMap>
