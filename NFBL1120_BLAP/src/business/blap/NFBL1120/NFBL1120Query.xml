<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NFBL1120Query">

    <typeAlias alias="NFBL1120CMsg" type="business.blap.NFBL1120.NFBL1120CMsg"/>

    <statement id="checkLocNm" parameterClass="Map" resultClass="Map">
        SELECT
            1
        FROM
            VND
        WHERE
            GLBL_CMPY_CD = #glblCmpyCd#
        AND LOC_NM       = #locNm#
        AND EZCANCELFLAG = '0'    
    </statement>

    <statement id="checkPrntVnd" parameterClass="Map" resultClass="Map">
        SELECT
            1
        FROM
            PRNT_VND
        WHERE
            GLBL_CMPY_CD = #glblCmpyCd#
        AND PRNT_VND_CD  = #prntVndCd#
        AND EZCANCELFLAG = '0'
    </statement>

    <statement id="searchRecord" parameterClass="Map" resultClass="Map">
        SELECT
            CMI.AP_BAT_NUM
        ,   CMIB.AP_BAT_DT
        ,   DV.PRNT_VND_CD
        ,   DV.PRNT_VND_NM
        ,   CMI.AP_VND_CD
        ,   CMI.VND_SITE_NM
        ,   CMI.AP_MAINT_INV_STS_CD
        ,   AMIS.AP_MAINT_INV_STS_DESC_TXT
        ,   VCC.VAR_CHAR_CONST_VAL         AS APVR_USR_NM
        ,   CMI.AP_INV_NUM
        ,   CMI.INV_DT
        ,   CMI.AP_INV_AMT
         <!-- START 2017/03/16 E.Kameishi [QC#14205,ADD] -->
        ,   CMI.EZINTIME                   AS  XX_REC_HIST_CRAT_TS
        ,   CMI.EZINUSERID                 AS  XX_REC_HIST_CRAT_BY_NM
        ,   CMI.EZUPTIME                   AS  XX_REC_HIST_UPD_TS
        ,   CMI.EZUPUSERID                 AS  XX_REC_HIST_UPD_BY_NM
        ,   CMI.EZTABLEID                  AS  XX_REC_HIST_TBL_NM
         <!-- END 2017/03/16 E.Kameishi [QC#14205,ADD] -->
        FROM
            CM_MAINT_INV     CMI
        ,   CM_MAINT_INV_BAT CMIB
        ,   AP_MAINT_INV_STS AMIS
        ,   VAR_CHAR_CONST   VCC
        ,   (
                SELECT
                    V.GLBL_CMPY_CD
                ,   V.INV_VND_CD
                ,   V.LOC_NM
                ,   MAX(PV.PRNT_VND_CD)           PRNT_VND_CD
                ,   MAX(PV.PRNT_VND_NM)           PRNT_VND_NM
                FROM
                    PRNT_VND PV
                ,   VND      V
                WHERE
                    PV.GLBL_CMPY_CD   = #glblCmpyCd#
                AND PV.GLBL_CMPY_CD   = V.GLBL_CMPY_CD
                AND PV.PRNT_VND_PK    = V.PRNT_VND_PK
                AND PV.EZCANCELFLAG   = '0'
                AND V.EZCANCELFLAG    = '0'
                GROUP BY
                    V.GLBL_CMPY_CD
                ,   V.INV_VND_CD
                ,   V.LOC_NM
            )                DV
        WHERE
            CMI.GLBL_CMPY_CD         =     #glblCmpyCd#
        AND CMI.GLBL_CMPY_CD         =     CMIB.GLBL_CMPY_CD
        AND CMI.AP_BAT_NUM           =     CMIB.AP_BAT_NUM
        <isNotNull property="apBatNum">
        AND CMI.AP_BAT_NUM           LIKE  #apBatNum#
        </isNotNull>
        <isNotNull property="prntVndCd">
        AND DV.PRNT_VND_CD           LIKE  #prntVndCd#
        </isNotNull>
        <isNotNull property="apBatDt">
        AND CMIB.AP_BAT_DT           =     #apBatDt#
        </isNotNull>
        <isNotNull property="locNm">
        AND CMI.VND_SITE_NM          LIKE  #locNm#
        </isNotNull>
        <isNotNull property="apMaintInvStsCd">
        AND CMI.AP_MAINT_INV_STS_CD  =     #apMaintInvStsCd#
        </isNotNull>
        <isNotNull property="apvrUsrId">
        AND CMI.APVR_USR_ID          =     #apvrUsrId#
        </isNotNull>
        <isNotNull property="apInvNum">
        AND CMI.AP_INV_NUM           LIKE  #apInvNum#
        </isNotNull>
        <isNotNull property="invDt">
        AND CMI.INV_DT               =     #invDt#
        </isNotNull>
        AND CMI.EZCANCELFLAG        =     '0'
        AND CMIB.EZCANCELFLAG       =     '0'
        AND CMI.GLBL_CMPY_CD        =     AMIS.GLBL_CMPY_CD(+)
        AND CMI.AP_MAINT_INV_STS_CD =     AMIS.AP_MAINT_INV_STS_CD(+)
        AND '0'                     =     AMIS.EZCANCELFLAG(+)
        AND CMI.AP_VND_CD           =     DV.INV_VND_CD(+)
        AND CMI.VND_SITE_NM         =     DV.LOC_NM(+)
        AND CMI.GLBL_CMPY_CD        =     VCC.GLBL_CMPY_CD(+)
        AND CMI.APVR_USR_ID         =     VCC.VAR_CHAR_CONST_NM(+)
        AND VCC.EZCANCELFLAG(+)     =     '0'
        ORDER BY
            CMI.AP_BAT_NUM
    </statement>

    <statement id="getPrntVndNm" parameterClass="Map" resultClass="Map">
        SELECT
            MAX(PRNT_VND_NM) PRNT_VND_NM
        FROM
            PRNT_VND
        WHERE
            GLBL_CMPY_CD = #glblCmpyCd#
        AND PRNT_VND_CD  = #prntVndCd#
        AND EZCANCELFLAG = '0'
        GROUP BY
            PRNT_VND_CD
    </statement>

    <statement id="getApvrUsrNm" parameterClass="Map" resultClass="Map">
        SELECT
            SUBSTR(MAX(LAST_NM) || ', ' || MAX(FIRST_NM),0,30) APVR_USR_NM
        FROM
            AP_MAINT_INV_APVL_LIMIT
        WHERE
            GLBL_CMPY_CD = #glblCmpyCd#
        AND USR_NM       = #apvrUsrId#
        AND EZCANCELFLAG = '0'
        GROUP BY
            USR_NM
    </statement>

    <statement id="getInvoiceStatusPulldownValue"  parameterClass="Map" resultClass="Map">
        SELECT
            AMIS.AP_MAINT_INV_STS_CD
        ,   AMIS.AP_MAINT_INV_STS_DESC_TXT
        FROM
            AP_MAINT_INV_STS AMIS
        WHERE
            AMIS.GLBL_CMPY_CD      = #glblCmpyCd#
        AND AMIS.EZCANCELFLAG      = '0' 
        ORDER BY
            AMIS.AP_MAINT_INV_STS_SORT_NUM ASC
    </statement>

</sqlMap>