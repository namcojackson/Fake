<?xml version="1.0" encoding="UTF-8"?>

<sqlMap namespace="NMAB265004">

    <statement id="insertTrtyRoleAsgList" parameterClass="Map">
    INSERT INTO
    <isNotNull property="customerFlag">
    ACCT_TRTY_ROLE_ASG
    </isNotNull>
    <isNotNull property="prospectFlag">
    PROS_TRTY_ROLE_ASG
    </isNotNull>

    --3.AcctGrp
    WITH AGA_SC AS (
        SELECT
              ROW_NUMBER() OVER (PARTITION BY DS_ACCT_NUM ORDER BY DS_ACCT_GRP_ASG_PK) AS ROW_NUM
          ,DS_ACCT_NUM
          ,DS_ACCT_GRP_CD
        FROM
            DS_ACCT_GRP_ASG AGA
        WHERE
             GLBL_CMPY_CD  = #glblCmpyCd#
        AND  EZCANCELFLAG  = '0'
        AND  EFF_FROM_DT   &lt;= #slsDt#
        AND  ( EFF_THRU_DT IS NULL
           OR  EFF_THRU_DT &gt;= #slsDt#)
        ORDER BY
           DS_ACCT_NUM
          ,DS_ACCT_GRP_ASG_PK
    )

    SELECT
        #tableId#             EZTABLEID
      , '0'                   EZCANCELFLAG
      , #ezintime#            EZINTIME
      , #ezintimezone#        EZINTIMEZONE
      , #ezincompanycode#     EZINCOMPANYCODE
      , #ezinuserid#          EZINUSERID
      , #ezinaplid#           EZINAPLID
      , #ezuptime#            EZUPTIME
      , #ezuptimezone#        EZUPTIMEZONE
      , #ezupcompanycode#     EZUPCOMPANYCODE
      , #ezupuserid#          EZUPUSERID
      , #ezupaplid#           EZUPAPLID
      , #glblCmpyCd#          GLBL_CMPY_CD

      <isNotNull property="customerFlag">
      , ACCT_TRTY_ROLE_ASG_SQ.NEXTVAL       ACCT_TRTY_ROLE_ASG_PK
      </isNotNull>
      <isNotNull property="prospectFlag">
      , ACCT_TRTY_ROLE_ASG_SQ.NEXTVAL       PROS_TRTY_ROLE_ASG_PK
      </isNotNull>

      , MN.DS_ACCT_NUM             DS_ACCT_NUM
      , MN.LOC_NUM                 LOC_NUM
      , MN.ORG_CD                  ORG_CD
      , MN.LINE_BIZ_ROLE_TP_CD     LINE_BIZ_ROLE_TP_CD
      , MN.DS_ACCT_NM              DS_ACCT_NM
      , MN.BILL_TO_CUST_CD         BILL_TO_CUST_CD
      , MN.SHIP_TO_CUST_CD         SHIP_TO_CUST_CD
      , MN.DS_ACCT_TP_CD           DS_ACCT_TP_CD
      , MN.DS_ACCT_CLS_CD          DS_ACCT_CLS_CD
      , MN.FIRST_DS_ACCT_GRP_TP_CD FIRST_DS_ACCT_GRP_TP_CD
      , MN.SCD_DS_ACCT_GRP_TP_CD   SCD_DS_ACCT_GRP_TP_CD
      , MN.THIRD_DS_ACCT_GRP_TP_CD THIRD_DS_ACCT_GRP_TP_CD
      , MN.FRTH_DS_ACCT_GRP_TP_CD  FRTH_DS_ACCT_GRP_TP_CD
      , MN.FIFTH_DS_ACCT_GRP_TP_CD FIFTH_DS_ACCT_GRP_TP_CD
      , MN.INDY_TP_CD              INDY_TP_CD
      , MN.FIRST_LINE_ADDR         FIRST_LINE_ADDR
      , MN.SCD_LINE_ADDR           SCD_LINE_ADDR
      , MN.THIRD_LINE_ADDR         THIRD_LINE_ADDR
      , MN.FRTH_LINE_ADDR          FRTH_LINE_ADDR
      , MN.CTY_ADDR                CTY_ADDR
      , MN.ST_CD                   ST_CD
      , MN.PROV_NM                 PROV_NM
      , MN.CNTY_NM                 CNTY_NM
      , MN.POST_CD                 POST_CD
      , MN.ORG_NM                  ORG_NM
      , MN.TRTY_GRP_TP_CD          TRTY_GRP_TP_CD
      , MN.ORG_RANK_NUM            ORG_RANK_NUM

      , NVL(AR_SC.TOC_CD,MN.TOC_CD) TOC_CD
      , NVL(AR_SC.PSN_CD,MN.PSN_CD) PSN_CD
      , NVL2(AR_SC.ORG_CD,'Y','N')  MAN_ENTRY_FLG
      , NVL(AR_SC.TRTY_TP_CD,MN.TRTY_TP_CD) TRTY_TP_CD

      , MN.ASG_TRTY_ATTRB_CD       ASG_TRTY_ATTRB_CD
      , MN.NON_SLS_REP_FLG         NON_SLS_REP_FLG
      , MN.LINE_BIZ_TP_CD          LINE_BIZ_TP_CD
      , MN.DS_CUST_SIC_CD          DS_CUST_SIC_CD

    FROM
    (
     SELECT
        MN_SC.DS_ACCT_NUM                   DS_ACCT_NUM
      , MN_SC.LOC_NUM                       LOC_NUM
      , DECODE(MN_SC.ORG_RANK_NUM,'X','',MN_SC.ORG_CD) ORG_CD
      , MN_SC.LINE_BIZ_ROLE_TP_CD           LINE_BIZ_ROLE_TP_CD
      , MN_SC.DS_ACCT_NM                    DS_ACCT_NM

      , MN_SC.BILL_TO_CUST_CD               BILL_TO_CUST_CD
      , MN_SC.SHIP_TO_CUST_CD               SHIP_TO_CUST_CD
      , MN_SC.DS_ACCT_TP_CD                 DS_ACCT_TP_CD
      , MN_SC.DS_ACCT_CLS_CD                DS_ACCT_CLS_CD

      , MN_SC.FIRST_DS_ACCT_GRP_TP_CD       FIRST_DS_ACCT_GRP_TP_CD
      , MN_SC.SCD_DS_ACCT_GRP_TP_CD         SCD_DS_ACCT_GRP_TP_CD
      , MN_SC.THIRD_DS_ACCT_GRP_TP_CD       THIRD_DS_ACCT_GRP_TP_CD
      , MN_SC.FRTH_DS_ACCT_GRP_TP_CD        FRTH_DS_ACCT_GRP_TP_CD
      , MN_SC.FIFTH_DS_ACCT_GRP_TP_CD       FIFTH_DS_ACCT_GRP_TP_CD

      , MN_SC.INDY_TP_CD                    INDY_TP_CD

      , RTRIM(MN_SC.FIRST_LINE_ADDR)        FIRST_LINE_ADDR
      , RTRIM(MN_SC.SCD_LINE_ADDR)          SCD_LINE_ADDR
      , RTRIM(MN_SC.THIRD_LINE_ADDR)        THIRD_LINE_ADDR
      , RTRIM(MN_SC.FRTH_LINE_ADDR)         FRTH_LINE_ADDR

      , RTRIM(MN_SC.CTY_ADDR)               CTY_ADDR
      , MN_SC.ST_CD                         ST_CD
      , MN_SC.PROV_NM                       PROV_NM
      , MN_SC.CNTY_NM                       CNTY_NM
      , MN_SC.POST_CD                       POST_CD

      , DECODE(MN_SC.ORG_RANK_NUM,'X','',MN_SC.ORG_NM) ORG_NM
      , DECODE(MN_SC.ORG_RANK_NUM,'X','',MN_SC.TRTY_GRP_TP_CD) TRTY_GRP_TP_CD
      , MN_SC.ORG_RANK_NUM                  ORG_RANK_NUM

      , DECODE(MN_SC.ORG_RANK_NUM,'X','',RSC_SC.TOC_CD)  TOC_CD
      , DECODE(MN_SC.ORG_RANK_NUM,'X','',RSC_SC.PSN_CD)  PSN_CD

      , 'N'                                 MAN_ENTRY_FLG
      , DECODE(MN_SC.ORG_RANK_NUM,'X','',MN_SC.TRTY_TP_CD) TRTY_TP_CD
      , MN_SC.ASG_TRTY_ATTRB_CD             ASG_TRTY_ATTRB_CD
      <isNotNull property="salseRepFlag">
      , 'N'  NON_SLS_REP_FLG
      </isNotNull>
      <isNotNull property="specialistFlag">
      , 'Y'  NON_SLS_REP_FLG
      </isNotNull>
      , MN_SC.LINE_BIZ_TP_CD                LINE_BIZ_TP_CD
      , MN_SC.DS_CUST_SIC_CD                DS_CUST_SIC_CD

      --6.Manual
      , MN_SC.ROW_NUM_MU                    ROW_NUM_MU
      , MN_SC.ORG_CD_MU                     ORG_CD_MU
     FROM
      (
        SELECT
            --1.Rank
              RNK_SC.ORG_NM              ORG_NM
            , RNK_SC.DS_ACCT_NUM         DS_ACCT_NUM
            , RNK_SC.LOC_NUM             LOC_NUM
            , RNK_SC.TRTY_GRP_TP_CD      TRTY_GRP_TP_CD
            , RNK_SC.ORG_RANK_NUM        ORG_RANK_NUM

            , RNK_SC.ORG_CD                ORG_CD
            , RNK_SC.DS_ACCT_TP_CD         DS_ACCT_TP_CD
            , RNK_SC.DS_ACCT_NM            DS_ACCT_NM
            , RNK_SC.SRC_LINE_BIZ_TP_CD    SRC_LINE_BIZ_TP_CD
            , RNK_SC.TRTY_TP_CD            TRTY_TP_CD

            , ROW_NUMBER() OVER (PARTITION BY RNK_SC.LOC_NUM ORDER BY LBL_SC.ASG_TRTY_ATTRB_CD) LA_ROW_NUM
            , RANK()       OVER (PARTITION BY RNK_SC.LOC_NUM ORDER BY LBL_SC.ASG_TRTY_ATTRB_CD) LA_RANK_NUM

            --2.LineBizTpCd
            , LBL_SC.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD
            , LBL_SC.ASG_TRTY_ATTRB_CD   ASG_TRTY_ATTRB_CD
            , LBL_SC.LINE_BIZ_TP_CD      LINE_BIZ_TP_CD

            --3.AcctGrp
            , AGA_SC_FIRST.DS_ACCT_GRP_CD  FIRST_DS_ACCT_GRP_TP_CD
            , AGA_SC_SCD.DS_ACCT_GRP_CD    SCD_DS_ACCT_GRP_TP_CD
            , AGA_SC_THIRD.DS_ACCT_GRP_CD  THIRD_DS_ACCT_GRP_TP_CD
            , AGA_SC_FRTH.DS_ACCT_GRP_CD   FRTH_DS_ACCT_GRP_TP_CD
            , AGA_SC_FIFTH.DS_ACCT_GRP_CD  FIFTH_DS_ACCT_GRP_TP_CD

            --4.Location
            , RNK_SC.SHIP_TO_CUST_CD     SHIP_TO_CUST_CD
            , RNK_SC.BILL_TO_CUST_CD     BILL_TO_CUST_CD
            , RNK_SC.DS_ACCT_CLS_CD      DS_ACCT_CLS_CD
            , RNK_SC.DS_CUST_SIC_CD      DS_CUST_SIC_CD
            , ''                         INDY_TP_CD
            , RNK_SC.FIRST_LINE_ADDR     FIRST_LINE_ADDR
            , RNK_SC.SCD_LINE_ADDR       SCD_LINE_ADDR
            , RNK_SC.THIRD_LINE_ADDR     THIRD_LINE_ADDR
            , RNK_SC.FRTH_LINE_ADDR      FRTH_LINE_ADDR
            , RNK_SC.CTY_ADDR            CTY_ADDR
            , RNK_SC.ST_CD               ST_CD
            , RNK_SC.PROV_NM             PROV_NM
            , RNK_SC.CNTY_NM             CNTY_NM
            , RNK_SC.POST_CD             POST_CD

            --6.Manual
            , CASE
                WHEN MU_SC.ORG_CD IS NULL THEN 1
                ELSE ROW_NUMBER() OVER (PARTITION BY MU_SC.DS_ACCT_TP_CD,MU_SC.LOC_NUM,MU_SC.ORG_CD,MU_SC.ASG_TRTY_ATTRB_CD
                                ORDER BY RNK_SC.DS_ACCT_NUM, RNK_SC.LOC_NUM, RNK_SC.TRTY_GRP_TP_CD, RNK_SC.ORG_RANK_NUM)
              END ROW_NUM_MU
            , MU_SC.ORG_CD               ORG_CD_MU
        FROM
          --1.Rank
          (
            SELECT
              TRLR_C.ORG_NM                 ORG_NM
            , TRLR_C.DS_ACCT_NUM           DS_ACCT_NUM
            , TRLR_C.LOC_NUM               LOC_NUM
            , TRLR_C.TRTY_GRP_TP_CD        TRTY_GRP_TP_CD
            <isNotNull property="salseRepFlag">
            , CASE
                  WHEN TRLR_C.ORG_RANK_NUM = #orgRankNumMax# THEN 'X'
                  ELSE TO_CHAR(ROW_NUMBER() OVER (PARTITION BY TRLR_C.LOC_NUM,TRLR_C.TRTY_GRP_TP_CD ORDER BY TRLR_C.LOC_NUM,TRLR_C.TRTY_GRP_TP_CD,TRLR_C.ORG_RANK_NUM))
              END ORG_RANK_NUM
            </isNotNull>
            <isNotNull property="specialistFlag">
            , NULL          ORG_RANK_NUM
            </isNotNull>
            , TRLR_C.ORG_CD                ORG_CD
            , TRLR_C.DS_ACCT_TP_CD         DS_ACCT_TP_CD
            , TRLR_C.DS_ACCT_NM            DS_ACCT_NM
            , TRLR_C.SRC_LINE_BIZ_TP_CD    SRC_LINE_BIZ_TP_CD
            , TRLR_C.TRTY_TP_CD            TRTY_TP_CD
            , TRLR_C.SHIP_TO_CUST_CD
            , TRLR_C.BILL_TO_CUST_CD
            , TRLR_C.DS_ACCT_CLS_CD
            , TRLR_C.FIRST_LINE_ADDR
            , TRLR_C.SCD_LINE_ADDR
            , TRLR_C.THIRD_LINE_ADDR
            , TRLR_C.FRTH_LINE_ADDR
            , TRLR_C.CTY_ADDR
            , TRLR_C.ST_CD
            , TRLR_C.PROV_NM
            , TRLR_C.DS_CUST_SIC_CD
            , TRLR_C.CNTY_NM
            , TRLR_C.POST_CD
            FROM 
            (
                SELECT
                  DOU.ORG_NM                 ORG_NM
                , TRLR.DS_ACCT_NUM           DS_ACCT_NUM
                , TRLR.LOC_NUM               LOC_NUM
                , TRLR.TRTY_GRP_TP_CD        TRTY_GRP_TP_CD
                <isNotNull property="salseRepFlag">
                , CASE
                      WHEN COUNT(1) OVER (PARTITION BY TRLR.LOC_NUM,TRLR.TRTY_GRP_TP_CD,TRLR.ORG_RANK_NUM) > 1 THEN #orgRankNumMax#
                      ELSE TRLR.ORG_RANK_NUM
                  END ORG_RANK_NUM
                </isNotNull>
                <isNotNull property="specialistFlag">
                , TRLR.ORG_RANK_NUM          ORG_RANK_NUM
                </isNotNull>
                , TRLR.ORG_CD                ORG_CD
                , TRLR.DS_ACCT_TP_CD         DS_ACCT_TP_CD
                , TRLR.DS_ACCT_NM            DS_ACCT_NM
                , TRLR.SRC_LINE_BIZ_TP_CD    SRC_LINE_BIZ_TP_CD
                , TRLR.TRTY_TP_CD            TRTY_TP_CD
                , STC.SHIP_TO_CUST_CD        SHIP_TO_CUST_CD
                , BTC.BILL_TO_CUST_CD        BILL_TO_CUST_CD
                , DAC.DS_ACCT_CLS_CD         DS_ACCT_CLS_CD
                , PLW.FIRST_LINE_ADDR        FIRST_LINE_ADDR
                , PLW.SCD_LINE_ADDR          SCD_LINE_ADDR
                , PLW.THIRD_LINE_ADDR        THIRD_LINE_ADDR
                , PLW.FRTH_LINE_ADDR         FRTH_LINE_ADDR
                , PLW.CTY_ADDR               CTY_ADDR
                , PLW.ST_CD                  ST_CD
                , PLW.PROV_NM                PROV_NM
                , PLW.DS_CUST_SIC_CD         DS_CUST_SIC_CD
                , CN.CNTY_NM                 CNTY_NM
                , PLW.POST_CD                POST_CD

                FROM
                <isNotNull property="customerFlag">
                    TRTY_RULE_LOC_RELN   TRLR
                </isNotNull>
                <isNotNull property="prospectFlag">
                    TRTY_RULE_PROS_RELN  TRLR
                </isNotNull>
                  , DS_ORG_UNIT          DOU
                  , TRTY_GRP_TP          TGT
                <isNotNull property="customerFlag">
                  , SELL_TO_CUST       DAC
                  , PTY_LOC_WRK        PLW
                  , ACCT_LOC           AL
                </isNotNull>
                <isNotNull property="prospectFlag">
                  , DS_ACCT_PROS       DAC
                  , PROS_PTY_LOC_WRK   PLW
                </isNotNull>
                  , CNTY               CN
                  , SHIP_TO_CUST       STC
                  , BILL_TO_CUST       BTC
    
                WHERE
                    TRLR.GLBL_CMPY_CD   = #glblCmpyCd#
                AND TRLR.EZCANCELFLAG   = '0'
    
                AND DOU.GLBL_CMPY_CD    = TRLR.GLBL_CMPY_CD
                AND DOU.EZCANCELFLAG    = '0'
                AND TRLR.ORG_CD         = DOU.ORG_CD
    
                AND DOU.GLBL_CMPY_CD    = TGT.GLBL_CMPY_CD
                AND TGT.EZCANCELFLAG    = '0'
                AND DOU.TRTY_GRP_TP_CD  = TGT.TRTY_GRP_TP_CD
                AND TGT.NON_SLS_REP_FLG = #nonSlsRepFlgs#
    
                AND EXISTS
                    (SELECT
                        1
                     FROM
                        DS_ORG_RESRC_RELN DORR
                     WHERE
                         DORR.GLBL_CMPY_CD   = #glblCmpyCd#
                     AND DORR.ORG_CD         = DOU.ORG_CD
                     AND DORR.EZCANCELFLAG   = '0'
                <isNotNull property="salseRepFlag">
                     AND DORR.ACCT_TEAM_ROLE_TP_CD IS NULL
                </isNotNull>
                     AND DORR.GNRN_TP_CD     = #gnrnTpCd#
                    )
                AND DAC.GLBL_CMPY_CD  = #glblCmpyCd#
                AND DAC.EZCANCELFLAG  = '0'
                AND DAC.RGTN_STS_CD   &lt;&gt; #rgtnStsTerminated#
                AND DAC.DS_ACCT_ACTV_CUST_FLG = #activeFlag#

                <isNotNull property="customerFlag">
                AND DAC.GLBL_CMPY_CD  = AL.GLBL_CMPY_CD
                AND AL.EZCANCELFLAG   = '0'
                AND AL.RGTN_STS_CD    &lt;&gt; #rgtnStsTerminated#   
                AND DAC.SELL_TO_CUST_CD   = AL.DS_ACCT_NUM
                
                AND TRLR.GLBL_CMPY_CD = AL.GLBL_CMPY_CD
                AND TRLR.DS_ACCT_NUM  = AL.DS_ACCT_NUM
                AND TRLR.LOC_NUM      = AL.LOC_NUM
                </isNotNull>
                
                <isNotNull property="prospectFlag">
                AND DAC.LOC_NUM       = PLW.LOC_NUM
                AND TRLR.GLBL_CMPY_CD = DAC.GLBL_CMPY_CD
                AND TRLR.DS_ACCT_NUM  = DAC.DS_ACCT_NUM
                AND TRLR.LOC_NUM      = DAC.LOC_NUM
                </isNotNull>

                AND DAC.GLBL_CMPY_CD  = PLW.GLBL_CMPY_CD
                <isNotNull property="prospectFlag">
                AND DAC.LOC_NUM    = PLW.LOC_NUM
                </isNotNull>
                AND PLW.EZCANCELFLAG  = '0'
                AND PLW.RGTN_STS_CD   &lt;&gt; #rgtnStsTerminated#
                <isNotNull property="customerFlag">
                AND AL.PTY_LOC_PK     = PLW.PTY_LOC_PK
                </isNotNull>

                AND DAC.GLBL_CMPY_CD  = CN.GLBL_CMPY_CD(+)
                AND CN.EZCANCELFLAG(+)= '0'
                AND PLW.CNTY_PK       = CN.CNTY_PK(+)

                AND DAC.GLBL_CMPY_CD  = STC.GLBL_CMPY_CD(+)
                AND STC.EZCANCELFLAG(+)  = '0'
                AND PLW.LOC_NUM       = STC.LOC_NUM(+)
                AND STC.RGTN_STS_CD(+)   &lt;&gt; #rgtnStsTerminated#

                AND DAC.GLBL_CMPY_CD  = BTC.GLBL_CMPY_CD(+)
                AND BTC.EZCANCELFLAG(+)  = '0'
                AND PLW.LOC_NUM       = BTC.LOC_NUM(+)
                AND BTC.RGTN_STS_CD(+)   &lt;&gt; #rgtnStsTerminated#
                ORDER BY
                  TRLR.DS_ACCT_NUM
                , TRLR.LOC_NUM
                , TRLR.TRTY_GRP_TP_CD
                , TRLR.ORG_RANK_NUM
             ) TRLR_C
          ) RNK_SC

          --2.LineBizTpCd
          ,(
            SELECT
            <isNotNull property="salseRepFlag">
               ROW_NUMBER() OVER (PARTITION BY
                  LBL.SRC_LINE_BIZ_TP_CD
                 ,LBL.TRTY_GRP_TP_CD
                 ,LBL.DS_ACCT_TP_CD
                 ,LBL.LINE_BIZ_RANK_NUM
               ORDER BY LBL.LINE_BIZ_ROLE_TP_CD) AS ROW_NUM
            </isNotNull>
            <isNotNull property="specialistFlag">
               ROW_NUMBER() OVER (PARTITION BY
                  LBL.SRC_LINE_BIZ_TP_CD
                 ,LBL.DS_ACCT_TP_CD
                 ,LBL.TRTY_GRP_TP_CD
                 ,LBL.TRTY_TP_CD
               ORDER BY LBL.LINE_BIZ_ROLE_TP_CD) AS ROW_NUM
            </isNotNull>
              ,LBL.SRC_LINE_BIZ_TP_CD
              ,LBL.TRTY_GRP_TP_CD
              ,LBL.DS_ACCT_TP_CD
              ,LBL.LINE_BIZ_RANK_NUM
              ,LBL.TRTY_TP_CD

              ,LBL.LINE_BIZ_ROLE_TP_CD
              ,LBL.ASG_TRTY_ATTRB_CD
              ,LBT.LINE_BIZ_TP_CD
            FROM
              LINE_BIZ_ROLE_RANK_DECN LBL
             ,LINE_BIZ_ROLE_TP        LBT
            WHERE
                  LBL.GLBL_CMPY_CD  = #glblCmpyCd#
              AND LBL.EZCANCELFLAG  = '0'
              AND LBL.RNK_ELIG_FLG  = #rnkEligFlg#
              AND LBL.GLBL_CMPY_CD  = LBT.GLBL_CMPY_CD
              AND LBL.LINE_BIZ_ROLE_TP_CD = LBT.LINE_BIZ_ROLE_TP_CD
              AND LBT.EZCANCELFLAG  = '0'
            ORDER BY
               LBL.SRC_LINE_BIZ_TP_CD
              ,LBL.DS_ACCT_TP_CD
              ,LBL.TRTY_GRP_TP_CD
              ,LBL.TRTY_TP_CD
              ,LINE_BIZ_ROLE_TP_CD ASC
          ) LBL_SC

          --3.AcctGrp
          , AGA_SC AGA_SC_FIRST
          , AGA_SC AGA_SC_SCD
          , AGA_SC AGA_SC_THIRD
          , AGA_SC AGA_SC_FRTH
          , AGA_SC AGA_SC_FIFTH

          --4.Location
          --6.isManual
	      ,(
	           SELECT DISTINCT
	             ASG.DS_ACCT_TP_CD      DS_ACCT_TP_CD
	            ,ASG.LOC_NUM            LOC_NUM
	            ,ASG.ASG_TRTY_ATTRB_CD  ASG_TRTY_ATTRB_CD
	            ,ASG.ORG_CD             ORG_CD
	           FROM
	            <isNotNull property="customerFlag">
	              ACCT_TRTY_ROLE_ASG ASG
	            </isNotNull>
	            <isNotNull property="prospectFlag">
	              PROS_TRTY_ROLE_ASG ASG
	            </isNotNull>
	            <!-- START 2017/07/10 H.Sugawara [QC#19778,DEL] -->
	            <!-- , ACCT_LOC  LOC -->
	            <!-- END 2017/07/10 H.Sugawara [QC#19778,DEL] -->
	           WHERE
	               ASG.GLBL_CMPY_CD  = #glblCmpyCd#
	           AND ASG.MAN_ENTRY_FLG = 'Y'

	           AND ASG.DS_ACCT_TP_CD = #dsAcctTp#
               <!-- START 2017/07/10 H.Sugawara [QC#19778,DEL] -->
	           <!-- AND ASG.GLBL_CMPY_CD  = LOC.GLBL_CMPY_CD -->
	           <!-- AND ASG.LOC_NUM       = LOC.LOC_NUM -->
	           <!-- AND LOC.EZCANCELFLAG  = '0' -->
               <!-- END 2017/07/10 H.Sugawara [QC#19778,DEL] -->
	           AND ASG.LINE_BIZ_ROLE_TP_CD IN
	               (
	                    SELECT
	                        DECN.LINE_BIZ_ROLE_TP_CD
	                    FROM
	                        LINE_BIZ_ROLE_RANK_DECN DECN
	                    WHERE
	                        DECN.GLBL_CMPY_CD  = #glblCmpyCd#
	                <isEqual property="salesRepFlg" compareValue="Y">
	                    AND DECN.LINE_BIZ_RANK_NUM IS NOT NULL
	                </isEqual>
	                <isNotEqual property="salesRepFlg" compareValue="Y">
	                    AND DECN.LINE_BIZ_RANK_NUM IS NULL
	                </isNotEqual>
	               )
	        ) MU_SC
        WHERE

        --2.LineBizTpCd
            RNK_SC.SRC_LINE_BIZ_TP_CD = LBL_SC.SRC_LINE_BIZ_TP_CD (+)
        AND RNK_SC.TRTY_GRP_TP_CD     = LBL_SC.TRTY_GRP_TP_CD (+)
        AND RNK_SC.DS_ACCT_TP_CD      = LBL_SC.DS_ACCT_TP_CD (+)
        <isNotNull property="salseRepFlag">
        AND RNK_SC.ORG_RANK_NUM       = LBL_SC.LINE_BIZ_RANK_NUM (+)
        </isNotNull>
        <isNotNull property="specialistFlag">
        AND RNK_SC.TRTY_TP_CD         = LBL_SC.TRTY_TP_CD (+)
        </isNotNull>
        AND LBL_SC.ROW_NUM (+)    = 1

        --3.AcctGrp
        AND RNK_SC.DS_ACCT_NUM    = AGA_SC_FIRST.DS_ACCT_NUM (+)
        AND AGA_SC_FIRST.ROW_NUM (+) = 1

        AND RNK_SC.DS_ACCT_NUM    = AGA_SC_SCD.DS_ACCT_NUM (+)
        AND AGA_SC_SCD.ROW_NUM   (+) = 2

        AND RNK_SC.DS_ACCT_NUM    = AGA_SC_THIRD.DS_ACCT_NUM (+)
        AND AGA_SC_THIRD.ROW_NUM (+) = 3

        AND RNK_SC.DS_ACCT_NUM    = AGA_SC_FRTH.DS_ACCT_NUM (+)
        AND AGA_SC_FRTH.ROW_NUM  (+) = 4

        AND RNK_SC.DS_ACCT_NUM    = AGA_SC_FIFTH.DS_ACCT_NUM (+)
        AND AGA_SC_FIFTH.ROW_NUM (+) = 5

        --6.Manual
        AND RNK_SC.DS_ACCT_TP_CD      = MU_SC.DS_ACCT_TP_CD (+)
        AND RNK_SC.LOC_NUM            = MU_SC.LOC_NUM (+)
        AND RNK_SC.ORG_CD             = MU_SC.ORG_CD (+)
        AND LBL_SC.ASG_TRTY_ATTRB_CD  = MU_SC.ASG_TRTY_ATTRB_CD (+)

        ORDER BY
          RNK_SC.DS_ACCT_NUM
        , RNK_SC.LOC_NUM
        , RNK_SC.TRTY_GRP_TP_CD
        , RNK_SC.ORG_RANK_NUM
      ) MN_SC

      --5.Resource
      ,(
        SELECT
            DORR.ORG_CD

          , OFA.TOC_CD
          , OFA.PSN_CD
        FROM
            DS_ORG_RESRC_RELN DORR
          , ORG_STRU_TP       OST
          , S21_PSN           SP
          , ORG_FUNC_ASG      OFA
          , TOC_ORG_STRU_RELN RELN
          , DS_ORG_UNIT       UNIT

        WHERE
            DORR.GLBL_CMPY_CD    = #glblCmpyCd#
        AND DORR.GNRN_TP_CD      = #gnrnTpCd#
       <isEqual property="salesRepFlg" compareValue="Y">
        AND DORR.ACCT_TEAM_ROLE_TP_CD IS NULL
       </isEqual>

        AND DORR.GLBL_CMPY_CD    = OST.GLBL_CMPY_CD
        AND DORR.ORG_STRU_TP_CD  = OST.ORG_STRU_TP_CD
        AND OST.TRTY_STRU_FLG    = #trtyStruFlg#

        AND DORR.GLBL_CMPY_CD    = SP.GLBL_CMPY_CD
        AND DORR.PSN_CD          = SP.PSN_CD
        AND SP.EFF_FROM_DT   &lt;= #slsDt#
        AND NVL(SP.EFF_THRU_DT, #maxDt#)     &gt;= #slsDt#

        AND SP.GLBL_CMPY_CD      = OFA.GLBL_CMPY_CD
        AND SP.PSN_CD            = OFA.PSN_CD
        AND OFA.GNRN_TP_CD       = #gnrnTpCd#

        AND OFA.GLBL_CMPY_CD     = RELN.GLBL_CMPY_CD
        AND OFA.TOC_CD           = RELN.TOC_CD
        AND RELN.EFF_FROM_DT &lt;= #slsDt#
        AND NVL(RELN.EFF_THRU_DT, #maxDt#)   &gt;= #slsDt#

        AND RELN.GLBL_CMPY_CD    = UNIT.GLBL_CMPY_CD
        AND RELN.ORG_CD          = UNIT.ORG_CD
        AND UNIT.FIRST_ORG_CD    = #bizArea_Sales#
        AND UNIT.GNRN_TP_CD      = #gnrnTpCd#

        AND DORR.EZCANCELFLAG    = '0'
        AND OST.EZCANCELFLAG     = '0'
        AND SP.EZCANCELFLAG      = '0'
        AND OFA.EZCANCELFLAG     = '0'
        AND RELN.EZCANCELFLAG    = '0'
        AND UNIT.EZCANCELFLAG    = '0'
      ) RSC_SC

      WHERE
        --5.Resource duplicate ASG_TRTY_ATTRB_CD and ORG_RANK_NUM 'X' after first Line is Non-target
        (MN_SC.LA_ROW_NUM = MN_SC.LA_RANK_NUM OR MN_SC.ORG_RANK_NUM != 'X')
        AND MN_SC.ORG_CD = RSC_SC.ORG_CD (+)
    ) MN

    --6. Manual Active Resource
    ,(
	    SELECT
	        UNIT.ORG_CD         ORG_CD

	      , PSN.PSN_CD          PSN_CD
	      , RQST.TOC_CD         TOC_CD
	      , UNIT.TRTY_GRP_TP_CD TRTY_GRP_TP_CD
	      , UNIT.TRTY_TP_CD     TRTY_TP_CD
	    FROM
	        DS_ORG_UNIT       UNIT
	      , DS_ORG_RESRC_RELN RELN
	      , S21_PSN           PSN
	      , ORG_FUNC_ASG      ASG
	      , ORG_TOC_CHNG_RQST RQST
	    WHERE
	        UNIT.GLBL_CMPY_CD = #glblCmpyCd#

	    AND UNIT.GNRN_TP_CD   = #gnrnTp_Current#
	    AND UNIT.GLBL_CMPY_CD = RELN.GLBL_CMPY_CD
	    AND UNIT.ORG_CD       = RELN.ORG_CD
	    AND RELN.EFF_FROM_DT &lt;= #slsDt#
	    AND NVL(RELN.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
	   <isEqual property="salesRepFlg" compareValue="Y">
	    AND RELN.ACCT_TEAM_ROLE_TP_CD IS NULL
	   </isEqual>
	    AND RELN.GLBL_CMPY_CD = PSN.GLBL_CMPY_CD
	    AND RELN.PSN_CD       = PSN.PSN_CD
	    AND PSN.EFF_FROM_DT  &lt;= #slsDt#
	    AND NVL(PSN.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
	    AND PSN.GLBL_CMPY_CD  = ASG.GLBL_CMPY_CD
	    AND PSN.PSN_CD        = ASG.PSN_CD
	    AND ASG.EFF_FROM_DT  &lt;= #slsDt#
	    AND NVL(ASG.EFF_THRU_DT, #maxDt#) &gt;= #slsDt#
	    AND ASG.GLBL_CMPY_CD  = RQST.GLBL_CMPY_CD
	    AND ASG.TOC_CD        = RQST.TOC_CD
	    AND RQST.RGTN_STS_CD  = #rgtnSts_P20#
	    AND UNIT.EZCANCELFLAG = '0'
	    AND RELN.EZCANCELFLAG = '0'
	    AND PSN.EZCANCELFLAG  = '0'
	    AND ASG.EZCANCELFLAG  = '0'
	    AND RQST.EZCANCELFLAG = '0'
     ) AR_SC
    WHERE
        --6.Manual first Line
        MN.ROW_NUM_MU = 1
    AND MN.ORG_CD_MU = AR_SC.ORG_CD (+)
    </statement>

    <statement id="insertAcctTrtyResrcAsg" parameterClass="Map">
         INSERT INTO
           <isNotNull property="customerFlag">
               ACCT_TRTY_RESRC_ASG
           </isNotNull>
           <isNotNull property="prospectFlag">
               PROS_TRTY_RESRC_ASG
           </isNotNull>

        WITH LOC_SC AS (
         SELECT
            ROW_NUMBER() OVER (PARTITION BY LOC_NUM ORDER BY DS_ACCT_NUM, LOC_NUM, ASG_TRTY_ATTRB_CD) ROW_NUM
          , ROW_NUMBER() OVER (PARTITION BY DS_ACCT_NUM, LOC_NUM, ASG_TRTY_ATTRB_CD ORDER BY ORG_CD)  ROW_NUM_ATTRB
          , LOC_NUM
          , DS_ACCT_NUM
          , DS_ACCT_NM
          , ORG_CD
          , MAN_ENTRY_FLG
          , ASG_TRTY_ATTRB_CD
          , LINE_BIZ_ROLE_TP_CD
          , TOC_CD
          , PSN_CD
         FROM
           (
              SELECT
                *
              FROM
              (
                  SELECT
                  <!-- START 2017/07/10 H.Sugawara [QC#19778,MOD] -->
                  <!--     LOC.DS_ACCT_NUM -->
                      TRTY.DS_ACCT_NUM
                  <!-- END 2017/07/10 H.Sugawara [QC#19778,MOD] -->
                    , ACCT.DS_ACCT_NM
                  <!-- START 2017/07/10 H.Sugawara [QC#19778,MOD] -->
                  <!--   , LOC.LOC_NUM -->
                    , TRTY.LOC_NUM
                  <!-- END 2017/07/10 H.Sugawara [QC#19778,MOD] -->
                    , TRTY.ORG_CD            AS ORG_CD
                    , TRTY.MAN_ENTRY_FLG     AS MAN_ENTRY_FLG
                    , TRTY.ASG_TRTY_ATTRB_CD AS ASG_TRTY_ATTRB_CD
                    , TRTY.LINE_BIZ_ROLE_TP_CD AS LINE_BIZ_ROLE_TP_CD
                    , CASE
                        WHEN TRTY.ORG_RANK_NUM IS NOT NULL THEN TRTY.TOC_CD ELSE '' END AS TOC_CD
                    , CASE WHEN TRTY.ORG_RANK_NUM IS NOT NULL THEN TRTY.PSN_CD ELSE '' END AS PSN_CD
                  FROM
                    <isNotNull property="customerFlag">
                      SELL_TO_CUST       ACCT
                    </isNotNull>
                    <isNotNull property="prospectFlag">
                      DS_ACCT_PROS       ACCT
                    </isNotNull>
                  <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                  <isNotNull property="customerFlag">
                  <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                    , ACCT_LOC LOC
                    , PTY_LOC_WRK PTY
                  <!-- START 2017/07/10 H.Sugawara [QC#19778,DEL] -->
                  <!-- <isNotNull property="customerFlag"> -->
                  <!-- END 2017/07/10 H.Sugawara [QC#19778,DEL] -->
                    , ACCT_TRTY_ROLE_ASG TRTY
                  </isNotNull>
                  <isNotNull property="prospectFlag">
                  <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                    , PROS_PTY_LOC_WRK PTY
                  <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                    , PROS_TRTY_ROLE_ASG TRTY
                  </isNotNull>
                  WHERE
                      ACCT.GLBL_CMPY_CD          = #glblCmpyCd#
                  AND ACCT.DS_ACCT_ACTV_CUST_FLG = #flgOnY#

                <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                <isNotNull property="customerFlag">
                <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                  AND ACCT.GLBL_CMPY_CD          = LOC.GLBL_CMPY_CD
                <!-- START 2017/07/10 H.Sugawara [QC#19778,DEL] -->
                <!-- <isNotNull property="customerFlag"> -->
                <!-- END 2017/07/10 H.Sugawara [QC#19778,DEL] -->
                  AND ACCT.SELL_TO_CUST_CD       = LOC.DS_ACCT_NUM
                </isNotNull>
                <isNotNull property="prospectFlag">
                <!-- START 2017/07/10 H.Sugawara [QC#19778,MOD] -->
                <!--   AND ACCT.DS_ACCT_NUM           = LOC.DS_ACCT_NUM -->
                  AND ACCT.GLBL_CMPY_CD          = PTY.GLBL_CMPY_CD
                  AND ACCT.LOC_NUM               = PTY.LOC_NUM
                <!-- END 2017/07/10 H.Sugawara [QC#19778,MOD] -->
                </isNotNull>

                <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                <isNotNull property="customerFlag">
                <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                  AND LOC.RGTN_STS_CD           != #rgtnSts_P99#

                  AND LOC.GLBL_CMPY_CD           = PTY.GLBL_CMPY_CD
                  AND LOC.PTY_LOC_PK             = PTY.PTY_LOC_PK
                <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                </isNotNull>
                <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                  AND PTY.RGTN_STS_CD           != #rgtnSts_P99#

                <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                <isNotNull property="customerFlag">
                <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                  AND LOC.GLBL_CMPY_CD           = TRTY.GLBL_CMPY_CD
                  AND LOC.DS_ACCT_NUM            = TRTY.DS_ACCT_NUM
                  AND LOC.LOC_NUM                = TRTY.LOC_NUM
                <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                </isNotNull>
                <isNotNull property="prospectFlag">
                  AND ACCT.GLBL_CMPY_CD          = TRTY.GLBL_CMPY_CD
                  AND ACCT.DS_ACCT_NUM           = TRTY.DS_ACCT_NUM
                  AND ACCT.LOC_NUM               = TRTY.LOC_NUM
                </isNotNull>
                <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                  AND TRTY.MAN_ENTRY_FLG         = #flgOffN#

                  AND ACCT.EZCANCELFLAG          = '0'
                <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                <isNotNull property="customerFlag">
                <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                  AND LOC.EZCANCELFLAG           = '0'
                <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                </isNotNull>
                <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                  AND PTY.EZCANCELFLAG           = '0'
                  AND TRTY.EZCANCELFLAG          = '0'

                  UNION ALL

                  SELECT
                  <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                    <isNotNull property="customerFlag">
                  <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                      LOC.DS_ACCT_NUM
                  <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                    </isNotNull>
                    <isNotNull property="prospectFlag">
                      ACCT.DS_ACCT_NUM
                    </isNotNull>
                  <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                    , ACCT.DS_ACCT_NM
                  <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                    <isNotNull property="customerFlag">
                  <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                    , LOC.LOC_NUM
                  <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                    </isNotNull>
                    <isNotNull property="prospectFlag">
                    , ACCT.LOC_NUM
                    </isNotNull>
                  <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                    , NULL AS ORG_CD
                    , 'N'  AS MAN_ENTRY_FLG
                    , NULL AS ASG_TRTY_ATTRB_CD
                    , NULL AS LINE_BIZ_ROLE_TP_CD
                    , NULL AS TOC_CD
                    , NULL AS PSN_CD
                  FROM
                    <isNotNull property="customerFlag">
                      SELL_TO_CUST       ACCT
                    </isNotNull>
                    <isNotNull property="prospectFlag">
                      DS_ACCT_PROS       ACCT
                    </isNotNull>
                    <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                    <isNotNull property="customerFlag">
                    <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                    , ACCT_LOC LOC
                    , PTY_LOC_WRK PTY
                    <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                    </isNotNull>
                    <isNotNull property="prospectFlag">
                    , PROS_PTY_LOC_WRK PTY
                    </isNotNull>
                    <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                  WHERE
                      ACCT.GLBL_CMPY_CD          = #glblCmpyCd#
                  AND ACCT.DS_ACCT_ACTV_CUST_FLG = #flgOnY#

                <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                <isNotNull property="customerFlag">
                <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                  AND ACCT.GLBL_CMPY_CD          = LOC.GLBL_CMPY_CD
                <!-- START 2017/07/10 H.Sugawara [QC#19778,DEL] -->
                <!-- <isNotNull property="customerFlag"> -->
                <!-- END 2017/07/10 H.Sugawara [QC#19778,DEL] -->
                  AND ACCT.SELL_TO_CUST_CD       = LOC.DS_ACCT_NUM
                </isNotNull>
                <isNotNull property="prospectFlag">
                <!-- START 2017/07/10 H.Sugawara [QC#19778,MOD] -->
                <!--   AND ACCT.DS_ACCT_NUM           = LOC.DS_ACCT_NUM -->
                  AND ACCT.GLBL_CMPY_CD          = PTY.GLBL_CMPY_CD
                  AND ACCT.LOC_NUM               = PTY.LOC_NUM
                <!-- END 2017/07/10 H.Sugawara [QC#19778,MOD] -->
                </isNotNull>

                <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                <isNotNull property="customerFlag">
                <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                  AND LOC.RGTN_STS_CD           != #rgtnSts_P99#

                  AND LOC.GLBL_CMPY_CD           = PTY.GLBL_CMPY_CD
                  AND LOC.PTY_LOC_PK             = PTY.PTY_LOC_PK
                <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                </isNotNull>
                <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                  AND PTY.RGTN_STS_CD           != #rgtnSts_P99#
                  AND NOT EXISTS
                         ( SELECT
                              1
                           FROM
                              <isNotNull property="customerFlag">
                                ACCT_TRTY_ROLE_ASG ASG
                              </isNotNull>
                              <isNotNull property="prospectFlag">
                                PROS_TRTY_ROLE_ASG ASG
                              </isNotNull>
                           WHERE
                               ACCT.GLBL_CMPY_CD = ASG.GLBL_CMPY_CD
                         <isNotNull property="customerFlag">
                           AND ACCT.SELL_TO_CUST_CD  = ASG.DS_ACCT_NUM
                         </isNotNull>
                         <isNotNull property="prospectFlag">
                           AND ACCT.DS_ACCT_NUM      = ASG.DS_ACCT_NUM
                         </isNotNull>
                         <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                         <isNotNull property="customerFlag">
                         <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                           AND LOC.LOC_NUM       = ASG.LOC_NUM
                         <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                         </isNotNull>
                         <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                           AND ASG.EZCANCELFLAG  = '0'
                         )
                  AND ACCT.EZCANCELFLAG          = '0'
                  <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                  <isNotNull property="customerFlag">
                  <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                  AND LOC.EZCANCELFLAG           = '0'
                  <!-- START 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                  </isNotNull>
                  <!-- END 2017/07/10 H.Sugawara [QC#19778,ADD] -->
                  AND PTY.EZCANCELFLAG           = '0'
              )
              ORDER BY
                  DS_ACCT_NUM
                , LOC_NUM
                , ASG_TRTY_ATTRB_CD
              )
          )

          (
          SELECT DISTINCT
            #tableId#                 EZTABLEID
          , '0'                       EZCANCELFLAG
          , #ezintime#                EZINTIME
          , #ezintimezone#            EZINTIMEZONE
          , #ezincompanycode#         EZINCOMPANYCODE
          , #ezinuserid#              EZINUSERID
          , #ezinaplid#               EZINAPLID
          , #ezuptime#                EZUPTIME
          , #ezuptimezone#            EZUPTIMEZONE
          , #ezupcompanycode#         EZUPCOMPANYCODE
          , #ezupuserid#              EZUPUSERID
          , #ezupaplid#               EZUPAPLID
          , #glblCmpyCd#              GLBL_CMPY_CD

          , LOC_M.DS_ACCT_NUM         DS_ACCT_NUM
          , LOC_M.DS_ACCT_NM          DS_ACCT_NM
          , LOC_M.LOC_NUM             LOC_NUM
          , #dsAcctTp#                DS_ACCT_TP_CD

          , LOC_1.ORG_CD              ACCT_TRTY_ORG_CD_01
          , LOC_1.PSN_CD              ACCT_TRTY_PSN_CD_01
          , LOC_1.TOC_CD              ACCT_TRTY_TOC_CD_01
          , LOC_2.ORG_CD              ACCT_TRTY_ORG_CD_02
          , LOC_2.PSN_CD              ACCT_TRTY_PSN_CD_02
          , LOC_2.TOC_CD              ACCT_TRTY_TOC_CD_02
          , LOC_3.ORG_CD              ACCT_TRTY_ORG_CD_03
          , LOC_3.PSN_CD              ACCT_TRTY_PSN_CD_03
          , LOC_3.TOC_CD              ACCT_TRTY_TOC_CD_03
          , LOC_4.ORG_CD              ACCT_TRTY_ORG_CD_04
          , LOC_4.PSN_CD              ACCT_TRTY_PSN_CD_04
          , LOC_4.TOC_CD              ACCT_TRTY_TOC_CD_04
          , LOC_5.ORG_CD              ACCT_TRTY_ORG_CD_05
          , LOC_5.PSN_CD              ACCT_TRTY_PSN_CD_05
          , LOC_5.TOC_CD              ACCT_TRTY_TOC_CD_05
          , LOC_6.ORG_CD              ACCT_TRTY_ORG_CD_06
          , LOC_6.PSN_CD              ACCT_TRTY_PSN_CD_06
          , LOC_6.TOC_CD              ACCT_TRTY_TOC_CD_06
          , LOC_7.ORG_CD              ACCT_TRTY_ORG_CD_07
          , LOC_7.PSN_CD              ACCT_TRTY_PSN_CD_07
          , LOC_7.TOC_CD              ACCT_TRTY_TOC_CD_07
          , LOC_8.ORG_CD              ACCT_TRTY_ORG_CD_08
          , LOC_8.PSN_CD              ACCT_TRTY_PSN_CD_08
          , LOC_8.TOC_CD              ACCT_TRTY_TOC_CD_08
          , LOC_9.ORG_CD              ACCT_TRTY_ORG_CD_09
          , LOC_9.PSN_CD              ACCT_TRTY_PSN_CD_09
          , LOC_9.TOC_CD              ACCT_TRTY_TOC_CD_09
          , LOC_10.ORG_CD             ACCT_TRTY_ORG_CD_10
          , LOC_10.PSN_CD             ACCT_TRTY_PSN_CD_10
          , LOC_10.TOC_CD             ACCT_TRTY_TOC_CD_10

          , LOC_11.ORG_CD             ACCT_TRTY_ORG_CD_11
          , LOC_11.PSN_CD             ACCT_TRTY_PSN_CD_11
          , LOC_11.TOC_CD             ACCT_TRTY_TOC_CD_11
          , LOC_12.ORG_CD             ACCT_TRTY_ORG_CD_12
          , LOC_12.PSN_CD             ACCT_TRTY_PSN_CD_12
          , LOC_12.TOC_CD             ACCT_TRTY_TOC_CD_12
          , LOC_13.ORG_CD             ACCT_TRTY_ORG_CD_13
          , LOC_13.PSN_CD             ACCT_TRTY_PSN_CD_13
          , LOC_13.TOC_CD             ACCT_TRTY_TOC_CD_13
          , LOC_14.ORG_CD             ACCT_TRTY_ORG_CD_14
          , LOC_14.PSN_CD             ACCT_TRTY_PSN_CD_14
          , LOC_14.TOC_CD             ACCT_TRTY_TOC_CD_14
          , LOC_15.ORG_CD             ACCT_TRTY_ORG_CD_15
          , LOC_15.PSN_CD             ACCT_TRTY_PSN_CD_15
          , LOC_15.TOC_CD             ACCT_TRTY_TOC_CD_15
          , LOC_16.ORG_CD             ACCT_TRTY_ORG_CD_16
          , LOC_16.PSN_CD             ACCT_TRTY_PSN_CD_16
          , LOC_16.TOC_CD             ACCT_TRTY_TOC_CD_16
          , LOC_17.ORG_CD             ACCT_TRTY_ORG_CD_17
          , LOC_17.PSN_CD             ACCT_TRTY_PSN_CD_17
          , LOC_17.TOC_CD             ACCT_TRTY_TOC_CD_17
          , LOC_18.ORG_CD             ACCT_TRTY_ORG_CD_18
          , LOC_18.PSN_CD             ACCT_TRTY_PSN_CD_18
          , LOC_18.TOC_CD             ACCT_TRTY_TOC_CD_18
          , LOC_19.ORG_CD             ACCT_TRTY_ORG_CD_19
          , LOC_19.PSN_CD             ACCT_TRTY_PSN_CD_19
          , LOC_19.TOC_CD             ACCT_TRTY_TOC_CD_19
          , LOC_20.ORG_CD             ACCT_TRTY_ORG_CD_20
          , LOC_20.PSN_CD             ACCT_TRTY_PSN_CD_20
          , LOC_20.TOC_CD             ACCT_TRTY_TOC_CD_20

          , LOC_1.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_01
          , LOC_2.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_02
          , LOC_3.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_03
          , LOC_4.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_04
          , LOC_5.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_05
          , LOC_6.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_06
          , LOC_7.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_07
          , LOC_8.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_08
          , LOC_9.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_09
          , LOC_10.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_10

          , LOC_11.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_11
          , LOC_12.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_12
          , LOC_13.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_13
          , LOC_14.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_14
          , LOC_15.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_15
          , LOC_16.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_16
          , LOC_17.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_17
          , LOC_18.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_18
          , LOC_19.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_19
          , LOC_20.LINE_BIZ_ROLE_TP_CD LINE_BIZ_ROLE_TP_CD_20

          , LOC_M.MAN_ENTRY_FLG   MAN_ENTRY_FLG

          FROM
             LOC_SC LOC_M
            ,LOC_SC LOC_1
            ,LOC_SC LOC_2
            ,LOC_SC LOC_3
            ,LOC_SC LOC_4
            ,LOC_SC LOC_5
            ,LOC_SC LOC_6
            ,LOC_SC LOC_7
            ,LOC_SC LOC_8
            ,LOC_SC LOC_9
            ,LOC_SC LOC_10
            ,LOC_SC LOC_11
            ,LOC_SC LOC_12
            ,LOC_SC LOC_13
            ,LOC_SC LOC_14
            ,LOC_SC LOC_15
            ,LOC_SC LOC_16
            ,LOC_SC LOC_17
            ,LOC_SC LOC_18
            ,LOC_SC LOC_19
            ,LOC_SC LOC_20
          WHERE
              LOC_M.ROW_NUM = 1
          AND LOC_M.LOC_NUM = LOC_1.LOC_NUM (+)
          AND LOC_1.ASG_TRTY_ATTRB_CD (+) = 1
          AND LOC_M.LOC_NUM = LOC_2.LOC_NUM (+)
          AND LOC_2.ASG_TRTY_ATTRB_CD (+) = 2
          AND LOC_M.LOC_NUM = LOC_3.LOC_NUM (+)
          AND LOC_3.ASG_TRTY_ATTRB_CD (+) = 3
          AND LOC_M.LOC_NUM = LOC_4.LOC_NUM (+)
          AND LOC_4.ASG_TRTY_ATTRB_CD (+) = 4
          AND LOC_M.LOC_NUM = LOC_5.LOC_NUM (+)
          AND LOC_5.ASG_TRTY_ATTRB_CD (+) = 5
          AND LOC_M.LOC_NUM = LOC_6.LOC_NUM (+)
          AND LOC_6.ASG_TRTY_ATTRB_CD (+) = 6
          AND LOC_M.LOC_NUM = LOC_7.LOC_NUM (+)
          AND LOC_7.ASG_TRTY_ATTRB_CD (+) = 7
          AND LOC_M.LOC_NUM = LOC_8.LOC_NUM (+)
          AND LOC_8.ASG_TRTY_ATTRB_CD (+) = 8
          AND LOC_M.LOC_NUM = LOC_9.LOC_NUM (+)
          AND LOC_9.ASG_TRTY_ATTRB_CD (+) = 9
          AND LOC_M.LOC_NUM = LOC_10.LOC_NUM (+)
          AND LOC_10.ASG_TRTY_ATTRB_CD (+) = 10

          AND LOC_M.LOC_NUM = LOC_11.LOC_NUM (+)
          AND LOC_11.ASG_TRTY_ATTRB_CD (+) = 11
          AND LOC_M.LOC_NUM = LOC_12.LOC_NUM (+)
          AND LOC_12.ASG_TRTY_ATTRB_CD (+) = 12
          AND LOC_M.LOC_NUM = LOC_13.LOC_NUM (+)
          AND LOC_13.ASG_TRTY_ATTRB_CD (+) = 13
          AND LOC_M.LOC_NUM = LOC_14.LOC_NUM (+)
          AND LOC_14.ASG_TRTY_ATTRB_CD (+) = 14
          AND LOC_M.LOC_NUM = LOC_15.LOC_NUM (+)
          AND LOC_15.ASG_TRTY_ATTRB_CD (+) = 15
          AND LOC_M.LOC_NUM = LOC_16.LOC_NUM (+)
          AND LOC_16.ASG_TRTY_ATTRB_CD (+) = 16
          AND LOC_M.LOC_NUM = LOC_17.LOC_NUM (+)
          AND LOC_17.ASG_TRTY_ATTRB_CD (+) = 17
          AND LOC_M.LOC_NUM = LOC_18.LOC_NUM (+)
          AND LOC_18.ASG_TRTY_ATTRB_CD (+) = 18
          AND LOC_M.LOC_NUM = LOC_19.LOC_NUM (+)
          AND LOC_19.ASG_TRTY_ATTRB_CD (+) = 19
          AND LOC_M.LOC_NUM = LOC_20.LOC_NUM (+)
          AND LOC_20.ASG_TRTY_ATTRB_CD (+) = 20

          AND LOC_1.ROW_NUM_ATTRB (+) = 1
          AND LOC_2.ROW_NUM_ATTRB (+) = 1
          AND LOC_3.ROW_NUM_ATTRB (+) = 1
          AND LOC_4.ROW_NUM_ATTRB (+) = 1
          AND LOC_5.ROW_NUM_ATTRB (+) = 1
          AND LOC_6.ROW_NUM_ATTRB (+) = 1
          AND LOC_7.ROW_NUM_ATTRB (+) = 1
          AND LOC_8.ROW_NUM_ATTRB (+) = 1
          AND LOC_9.ROW_NUM_ATTRB (+) = 1
          AND LOC_10.ROW_NUM_ATTRB (+) = 1
          AND LOC_11.ROW_NUM_ATTRB (+) = 1
          AND LOC_12.ROW_NUM_ATTRB (+) = 1
          AND LOC_13.ROW_NUM_ATTRB (+) = 1
          AND LOC_14.ROW_NUM_ATTRB (+) = 1
          AND LOC_15.ROW_NUM_ATTRB (+) = 1
          AND LOC_16.ROW_NUM_ATTRB (+) = 1
          AND LOC_17.ROW_NUM_ATTRB (+) = 1
          AND LOC_18.ROW_NUM_ATTRB (+) = 1
          AND LOC_19.ROW_NUM_ATTRB (+) = 1
          AND LOC_20.ROW_NUM_ATTRB (+) = 1
        )
    </statement>

    <statement id="setCancelFlagManualRoleAsg" parameterClass="Map">
        UPDATE
         <isNotNull property="customerFlag">
          ACCT_TRTY_ROLE_ASG ASL
         </isNotNull>
         <isNotNull property="prospectFlag">
          PROS_TRTY_ROLE_ASG ASL
         </isNotNull>
        SET
          EZCANCELFLAG = '1'
        WHERE
          EXISTS (
                SELECT
                  1
                FROM
                 <isNotNull property="customerFlag">
                   ACCT_TRTY_ROLE_ASG ASG
                 </isNotNull>
                 <isNotNull property="prospectFlag">
                   PROS_TRTY_ROLE_ASG ASG
                 </isNotNull>
                 <!-- START 2017/07/10 H.Sugawara [QC#19778,DEL] -->
                 <!--  , ACCT_LOC  LOC -->
                 <!-- END 2017/07/10 H.Sugawara [QC#19778,DEL] -->
                WHERE
                    ASG.GLBL_CMPY_CD  = #glblCmpyCd#
                AND ASG.MAN_ENTRY_FLG = 'Y'
                AND ASG.EZCANCELFLAG  = '0'
                AND ASG.DS_ACCT_TP_CD = #dsAcctTp#
                <!-- START 2017/07/10 H.Sugawara [QC#19778,DEL] -->
                <!-- AND ASG.GLBL_CMPY_CD  = LOC.GLBL_CMPY_CD -->
                <!-- AND ASG.LOC_NUM       = LOC.LOC_NUM -->
                <!-- AND LOC.EZCANCELFLAG  = '0' -->
                <!-- END 2017/07/10 H.Sugawara [QC#19778,DEL] -->
                AND ASG.LINE_BIZ_ROLE_TP_CD IN
                    (
                         SELECT
                             DECN.LINE_BIZ_ROLE_TP_CD
                         FROM
                             LINE_BIZ_ROLE_RANK_DECN DECN
                         WHERE
                             DECN.GLBL_CMPY_CD  = #glblCmpyCd#
                     <isEqual property="salesRepFlg" compareValue="Y">
                         AND DECN.LINE_BIZ_RANK_NUM IS NOT NULL
                     </isEqual>
                     <isNotEqual property="salesRepFlg" compareValue="Y">
                         AND DECN.LINE_BIZ_RANK_NUM IS NULL
                     </isNotEqual>
                    )

                AND ASG.GLBL_CMPY_CD          = ASL.GLBL_CMPY_CD
                AND ASG.ACCT_TRTY_ROLE_ASG_PK = ASL.ACCT_TRTY_ROLE_ASG_PK
            )
         AND ASL.EZCANCELFLAG      = '0'
    </statement>

    <statement id="deleteCancelFlagManualRoleAsg" parameterClass="Map">
        DELETE FROM
         <isNotNull property="customerFlag">
          ACCT_TRTY_ROLE_ASG
         </isNotNull>
         <isNotNull property="prospectFlag">
          PROS_TRTY_ROLE_ASG
         </isNotNull>
        WHERE
            GLBL_CMPY_CD = #glblCmpyCd#
        AND EZCANCELFLAG = '1'
    </statement>
</sqlMap>
