<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSBL0480Query">

    <typeAlias alias="NSBL0480_ASMsg"    type="business.blap.NSBL0480.NSBL0480_ASMsg"/>
    <typeAlias alias="NSBL0480_BSMsg"    type="business.blap.NSBL0480.NSBL0480_BSMsg"/>
    <statement id="getSearchResourceData"  parameterClass="Map"  resultMap="result.getSearchResourceData">
    SELECT
         ACCS.EZUPTIME
       , ACCS.EZUPTIMEZONE
       , ACCS.SVC_ACCS_PMIT_TECH_RELN_PK
       , ACCS.EFF_FROM_DT
       , ACCS.EFF_THRU_DT
       , ACCS.SVC_ACCS_PMIT_NUM
       , ACCS.SVC_ACCS_PMIT_DESC_TXT
       , ACCS.SVC_PMIT_LVL_TP_CD
       , ACCS.SVC_PMIT_LVL_VAL_TXT
       , ACCS.SVC_ACCS_PMIT_PK
<!-- START 2016/12/06 N.Arai [QC#14204, ADD] -->
       , ACCS.XX_REC_HIST_CRAT_TS
       , ACCS.XX_REC_HIST_CRAT_BY_NM
       , ACCS.XX_REC_HIST_UPD_TS
       , ACCS.XX_REC_HIST_UPD_BY_NM
       , ACCS.XX_REC_HIST_TBL_NM
<!-- END 2016/12/06 N.Arai [QC#14204, ADD] -->

    FROM
    (
       SELECT
             SAPTR.EZUPTIME
           , SAPTR.EZUPTIMEZONE
           , SAPTR.SVC_ACCS_PMIT_TECH_RELN_PK
           , SAPTR.EFF_FROM_DT
           , SAPTR.EFF_THRU_DT
           , SAP.SVC_ACCS_PMIT_NUM
           , PVAL.SVC_ACCS_PMIT_DESC_TXT
           , SAP.SVC_PMIT_LVL_TP_CD
           , SAP.SVC_PMIT_LVL_VAL_TXT
           , SAP.SVC_ACCS_PMIT_PK
<!-- START 2016/12/06 N.Arai [QC#14204, ADD] -->
           , SAPTR.EZINTIME         AS XX_REC_HIST_CRAT_TS
           , SAPTR.EZINUSERID       AS XX_REC_HIST_CRAT_BY_NM
           , SAPTR.EZUPTIME         AS XX_REC_HIST_UPD_TS
           , SAPTR.EZUPUSERID       AS XX_REC_HIST_UPD_BY_NM
           , SAPTR.EZTABLEID        AS XX_REC_HIST_TBL_NM
<!-- END 2016/12/06 N.Arai [QC#14204, ADD] -->

       FROM
              SVC_ACCS_PMIT_TECH_RELN SAPTR
             ,SVC_ACCS_PMIT           SAP
             ,SVC_PMIT_LVL_TP         SPLT
             ,SVC_ACCS_PMIT_VAL       PVAL

       WHERE
           SAPTR.GLBL_CMPY_CD                                 =   #glblCmpyCd#
           AND SAPTR.TECH_CD                                  =   #techCd#
           AND SAPTR.EFF_FROM_DT                          &lt;=   #effDt#
           AND NVL(SAPTR.EFF_THRU_DT, #effDt#)            &gt;=   #effDt#
           AND SAPTR.EZCANCELFLAG                             =   '0'
           AND SAPTR.GLBL_CMPY_CD                             = SAP.GLBL_CMPY_CD
           AND SAPTR.SVC_ACCS_PMIT_PK                         = SAP.SVC_ACCS_PMIT_PK
           AND SAP.EFF_FROM_DT                            &lt;=   #effDt#
           AND NVL(SAP.EFF_TO_DT, #effDt#)                &gt;=   #effDt#
           AND SAP.EZCANCELFLAG                               =   '0'
           AND SAP.GLBL_CMPY_CD                               = SPLT.GLBL_CMPY_CD
           AND SAP.SVC_PMIT_LVL_TP_CD                         = SPLT.SVC_PMIT_LVL_TP_CD
           AND SPLT.EZCANCELFLAG                              =   '0'
           AND SAP.GLBL_CMPY_CD                               = PVAL.GLBL_CMPY_CD       (+)
           AND SAP.SVC_ACCS_PMIT_NUM                          = PVAL.SVC_ACCS_PMIT_NUM  (+)
           AND PVAL.EZCANCELFLAG                      (+)     =   '0'

           ORDER BY
               SAP.SVC_ACCS_PMIT_NUM   ASC
       ) ACCS
    WHERE
      ROWNUM                            &lt;=   #limitCount#
    </statement>

    <resultMap id="result.getSearchResourceData"     class="NSBL0480_ASMsg">
        <result property="svcAccsPmitTechRelnPk_A"   column="SVC_ACCS_PMIT_TECH_RELN_PK" javaType="EZDSBigDecimalItem"/>
        <result property="svcAccsPmitNum_A"          column="SVC_ACCS_PMIT_NUM"         javaType="EZDSStringItem"/>
        <result property="svcAccsPmitDescTxt_A"      column="SVC_ACCS_PMIT_DESC_TXT"    javaType="EZDSStringItem"/>
        <result property="svcPmitLvlTpCd_A"          column="SVC_PMIT_LVL_TP_CD"        javaType="EZDSStringItem"/>
        <result property="xxScrItem30Txt_A"          column="SVC_PMIT_LVL_VAL_TXT"      javaType="EZDSStringItem"/>
        <result property="svcAccsPmitPk_A"           column="SVC_ACCS_PMIT_PK"          javaType="EZDSBigDecimalItem"/>
        <result property="effFromDt_A"               column="EFF_FROM_DT"               javaType="EZDSDateItem"/>
        <result property="effThruDt_A"               column="EFF_THRU_DT"               javaType="EZDSDateItem"/>
        <result property="ezUpTime_A"                column="EZUPTIME"                  javaType="EZDSStringItem"/>
        <result property="ezUpTimeZone_A"            column="EZUPTIMEZONE"              javaType="EZDSStringItem"/>
<!-- START 2016/12/06 N.Arai [QC#14204, ADD] -->
        <result property="xxRecHistCratTs_A"         column="XX_REC_HIST_CRAT_TS"       javaType="EZDSStringItem"/>
        <result property="xxRecHistCratByNm_A"       column="XX_REC_HIST_CRAT_BY_NM"    javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdTs_A"          column="XX_REC_HIST_UPD_TS"        javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdByNm_A"        column="XX_REC_HIST_UPD_BY_NM"     javaType="EZDSStringItem"/>
        <result property="xxRecHistTblNm_A"          column="XX_REC_HIST_TBL_NM"        javaType="EZDSStringItem"/>
<!-- END 2016/12/06 N.Arai [QC#14204, ADD] -->
    </resultMap>

    <statement id="getSvcAccsPmitPk" parameterClass="Map" resultClass="BigDecimal">
     SELECT
           SAP.SVC_ACCS_PMIT_PK
     FROM
            SVC_ACCS_PMIT      SAP

     WHERE
         SAP.GLBL_CMPY_CD                                    =  #glblCmpyCd#
         AND SAP.SVC_ACCS_PMIT_NUM                           =  #svcAccsPmitNum#
         AND SAP.SVC_PMIT_LVL_TP_CD                          =  #svcPmitLvlTpCd#
         AND SAP.SVC_PMIT_LVL_VAL_TXT                        =  #svcPmitLvlValTxt#
         AND SAP.EFF_FROM_DT                             &lt;=  #effDt#
         AND NVL(SAP.EFF_TO_DT, #effDt#)                 &gt;=  #effDt#
         AND SAP.EZCANCELFLAG                                =  '0'
    </statement>

    <statement id="getSearchAccessPermitsData"  parameterClass="Map"  resultMap="result.getSearchAccessPermitsData">
    SELECT
         ACCS.EZUPTIME
       , ACCS.EZUPTIMEZONE
       , ACCS.SVC_ACCS_PMIT_TECH_RELN_PK
       , ACCS.TECH_CD
       , ACCS.EFF_FROM_DT
       , ACCS.EFF_THRU_DT
       , ACCS.PSN_NM
<!-- START 2016/12/06 N.Arai [QC#14204, ADD] -->
       , ACCS.XX_REC_HIST_CRAT_TS
       , ACCS.XX_REC_HIST_CRAT_BY_NM
       , ACCS.XX_REC_HIST_UPD_TS
       , ACCS.XX_REC_HIST_UPD_BY_NM
       , ACCS.XX_REC_HIST_TBL_NM
<!-- END 2016/12/06 N.Arai [QC#14204, ADD] -->

    FROM
    (
       SELECT
             SAPTR.EZUPTIME
           , SAPTR.EZUPTIMEZONE
           , SAPTR.SVC_ACCS_PMIT_TECH_RELN_PK
           , SAPTR.TECH_CD
           , SAPTR.EFF_FROM_DT
           , SAPTR.EFF_THRU_DT
           , SP.PSN_LAST_NM||','||SP.PSN_FIRST_NM AS PSN_NM
<!-- START 2016/12/06 N.Arai [QC#14204, ADD] -->
           , SAPTR.EZINTIME         AS XX_REC_HIST_CRAT_TS
           , SAPTR.EZINUSERID       AS XX_REC_HIST_CRAT_BY_NM
           , SAPTR.EZUPTIME         AS XX_REC_HIST_UPD_TS
           , SAPTR.EZUPUSERID       AS XX_REC_HIST_UPD_BY_NM
           , SAPTR.EZTABLEID        AS XX_REC_HIST_TBL_NM
<!-- END 2016/12/06 N.Arai [QC#14204, ADD] -->

       FROM
              SVC_ACCS_PMIT_TECH_RELN SAPTR
             ,SVC_ACCS_PMIT           SAP
             ,S21_PSN                 SP

       WHERE
           SAPTR.GLBL_CMPY_CD                                 = #glblCmpyCd#
           AND SAPTR.EFF_FROM_DT                          &lt;= #effDt#
           AND NVL(SAPTR.EFF_THRU_DT, #effDt#)            &gt;= #effDt#
           AND SAPTR.EZCANCELFLAG                             = '0'
           AND SAPTR.GLBL_CMPY_CD                             = SP.GLBL_CMPY_CD 
           AND SAPTR.TECH_CD                                  = SP.PSN_CD
           AND SP.EFF_FROM_DT                             &lt;= #effDt#
           AND NVL(SP.EFF_THRU_DT, #effDt#)               &gt;= #effDt#
           AND SP.DEL_FLG                                     = #delFlg#
           AND SP.EZCANCELFLAG                                = '0'
           AND SAPTR.GLBL_CMPY_CD                             = SAP.GLBL_CMPY_CD
           AND SAPTR.SVC_ACCS_PMIT_PK                         = SAP.SVC_ACCS_PMIT_PK
           AND SAP.SVC_ACCS_PMIT_NUM                          = #svcAccsPmitNum#
           AND SAP.SVC_PMIT_LVL_TP_CD                         = #svcPmitLvlTpCd#
           AND SAP.SVC_PMIT_LVL_VAL_TXT                       = #svcPmitLvlValTxt#
           AND SAP.EFF_FROM_DT                            &lt;= #effDt#
           AND NVL(SAP.EFF_TO_DT, #effDt#)                &gt;= #effDt#
           AND SAP.EZCANCELFLAG                               = '0'

           ORDER BY
               SAPTR.TECH_CD   ASC
       ) ACCS
    WHERE
      ROWNUM                            &lt;=   #limitCount#
    </statement>

    <resultMap id="result.getSearchAccessPermitsData"     class="NSBL0480_BSMsg">
        <result property="svcAccsPmitTechRelnPk_B"   column="SVC_ACCS_PMIT_TECH_RELN_PK" javaType="EZDSBigDecimalItem"/>
        <result property="fullPsnNm_B"               column="PSN_NM"                     javaType="EZDSStringItem"/>
        <result property="techCd_B"                  column="TECH_CD"                    javaType="EZDSStringItem"/>
        <result property="effFromDt_B"               column="EFF_FROM_DT"                javaType="EZDSDateItem"/>
        <result property="effThruDt_B"               column="EFF_THRU_DT"                javaType="EZDSDateItem"/>
        <result property="ezUpTime_B"                column="EZUPTIME"                   javaType="EZDSStringItem"/>
        <result property="ezUpTimeZone_B"            column="EZUPTIMEZONE"               javaType="EZDSStringItem"/>
<!-- START 2016/12/06 N.Arai [QC#14204, ADD] -->
        <result property="xxRecHistCratTs_B"         column="XX_REC_HIST_CRAT_TS"       javaType="EZDSStringItem"/>
        <result property="xxRecHistCratByNm_B"       column="XX_REC_HIST_CRAT_BY_NM"    javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdTs_B"          column="XX_REC_HIST_UPD_TS"        javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdByNm_B"        column="XX_REC_HIST_UPD_BY_NM"     javaType="EZDSStringItem"/>
        <result property="xxRecHistTblNm_B"          column="XX_REC_HIST_TBL_NM"        javaType="EZDSStringItem"/>
<!-- END 2016/12/06 N.Arai [QC#14204, ADD] -->
    </resultMap>

    <statement id="getSearchPsn"  parameterClass="Map"  resultClass="Map">
    SELECT
         SP.GLBL_CMPY_CD
        , SP.EZCANCELFLAG
        , SP.PSN_CD
        , SP.PSN_LAST_NM||','||PSN_FIRST_NM AS PSN_NM
        , PT.PSN_TP_DESC_TXT

    FROM
          S21_PSN    SP
        , PSN_TP     PT
        , TECH_MSTR  TM

    WHERE
           SP.GLBL_CMPY_CD                                  = #glblCmpyCd#
           AND SP.PSN_CD                                    = #psnCd#
           AND SP.EFF_FROM_DT                           &lt;= #effDt#
           AND NVL(SP.EFF_THRU_DT, #effDt#)             &gt;= #effDt#
           AND SP.DEL_FLG                                   = #delFlg#
           AND SP.EZCANCELFLAG                              = '0'
           AND SP.GLBL_CMPY_CD                              = PT.GLBL_CMPY_CD
           AND SP.PSN_TP_CD                                 = PT.PSN_TP_CD
           AND PT.EZCANCELFLAG                              = '0'
           AND SP.GLBL_CMPY_CD                              = TM.GLBL_CMPY_CD
           AND SP.PSN_CD                                    = TM.TECH_TOC_CD
           AND TM.EZCANCELFLAG                              = '0'
           <!--START 2016/12/15 K.Kojima [QC#15653,ADD] -->
           AND EXISTS(
               SELECT
                   1
               FROM
                    ORG_FUNC_ASG     OFA
                   ,TOC              T
                   ,ORG_FUNC_ROLE_TP OFRT
               WHERE
                       OFA.GLBL_CMPY_CD                  = TM.GLBL_CMPY_CD
                   AND OFA.PSN_CD                        = TM.TECH_TOC_CD
                   AND OFA.EFF_FROM_DT               &lt;= #effDt#
                   AND NVL(OFA.EFF_THRU_DT, #effDt#) &gt;= #effDt#
                   AND OFA.GLBL_CMPY_CD                  = T.GLBL_CMPY_CD
                   AND OFA.TOC_CD                        = T.TOC_CD
                   AND T.GLBL_CMPY_CD                    = OFRT.GLBL_CMPY_CD
                   AND T.ORG_FUNC_ROLE_TP_CD             = OFRT.ORG_FUNC_ROLE_TP_CD
                   AND OFRT.TECH_MSTR_REQ_FLG            = #flgY#
                   AND OFRT.ACTV_FLG                     = #flgY#
                   AND OFA.EZCANCELFLAG                  = '0'
                   AND T.EZCANCELFLAG                    = '0'
                   AND OFRT.EZCANCELFLAG                 = '0'
           )
           <!--END 2016/12/15 K.Kojima [QC#15653,ADD] -->
    </statement>

    <statement id="getSearchSvcAccsPmit"  parameterClass="Map"  resultClass="Map">
    SELECT
         SAP.GLBL_CMPY_CD
        , SAP.EZCANCELFLAG
        , SAP.SVC_ACCS_PMIT_NUM
        , SAP.SVC_ACCS_PMIT_DESC_TXT
        , SAP.SVC_ACCS_PMIT_PK
        , SPLT.SVC_PMIT_LVL_TP_DESC_TXT

    FROM
          SVC_ACCS_PMIT      SAP 
        , SVC_PMIT_LVL_TP    SPLT 

    WHERE
           SAP.GLBL_CMPY_CD                                 =   #glblCmpyCd#
           AND SAP.SVC_ACCS_PMIT_NUM                        =   #svcAccsPmitNum#
           AND SAP.SVC_PMIT_LVL_TP_CD                       =   #svcPmitLvlTpCd#
           AND SAP.SVC_PMIT_LVL_VAL_TXT                     =   #svcPmitLvlValTxt#
           AND SAP.EFF_FROM_DT                          &lt;=   #effDt#
           AND NVL(SAP.EFF_TO_DT, #effDt#)              &gt;=   #effDt#
           AND SAP.EZCANCELFLAG                             =   '0'
           AND SAP.GLBL_CMPY_CD                             = SPLT.GLBL_CMPY_CD
           AND SAP.SVC_PMIT_LVL_TP_CD                       = SPLT.SVC_PMIT_LVL_TP_CD
           AND SPLT.EZCANCELFLAG                            =   '0'
    </statement>

    <statement id="getDtPerOvlpCount"  parameterClass="Map"  resultClass="BigDecimal">
        SELECT
            COUNT(*)
        FROM
            SVC_ACCS_PMIT SAP
        WHERE
                SAP.GLBL_CMPY_CD                = #glblCmpyCd#
            AND SAP.SVC_ACCS_PMIT_NUM           = #svcAccsPmitNum#
            AND SAP.SVC_PMIT_LVL_TP_CD          = #svcPmitLvlTpCd#
            AND SAP.SVC_PMIT_LVL_VAL_TXT        = #svcPmitLvlValTxt#
            AND SAP.EFF_FROM_DT             &lt;= #effDt#
            AND NVL(SAP.EFF_TO_DT, #effDt#) &gt;= #effDt#
            AND SAP.EZCANCELFLAG                = '0'
            AND EXISTS (
                SELECT
                    1
                FROM
                    SVC_ACCS_PMIT_TECH_RELN SAPTR
                WHERE
                        SAPTR.GLBL_CMPY_CD                      = SAP.GLBL_CMPY_CD
                    AND SAPTR.SVC_ACCS_PMIT_PK                  = SAP.SVC_ACCS_PMIT_PK
                    <isNotNull property="svcAccsPmitTechRelnPk">
                    AND SAPTR.SVC_ACCS_PMIT_TECH_RELN_PK &lt;&gt; #svcAccsPmitTechRelnPk#
                    </isNotNull>
                    AND SAPTR.EFF_FROM_DT                   &lt;= #thruDt#
                    AND NVL(SAPTR.EFF_THRU_DT, #fromDt#)    &gt;= #fromDt#
                    AND SAPTR.EZCANCELFLAG                      = '0'
            )
    </statement>
</sqlMap>
