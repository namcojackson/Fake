<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NPAB172001">
    <statement id="getMinMaxPlanningInfo" parameterClass="Map"
        resultClass="Map">
        SELECT
            MRP.MRP_INFO_PK
            ,MRP.INVTY_LOC_CD
            ,MRP.RTL_WH_CD
            ,MRP.RTL_SWH_CD
            ,MRP.MDSE_CD
            ,MRP.ROP_QTY
            ,MRP.MAX_INVTY_QTY
            ,TM.TECH_TOC_CD
            ,TM.TECH_NM
            ,PSN.LINE_BIZ_TP_CD
            ,SOF.SHUT_OFF_DAYS_AOT
            ,AM.MDSE_DESC_SHORT_TXT
            ,AM.THIS_MTH_TOT_STD_COST_AMT
            ,(
                SELECT
                    SUBSTR(MAX(RCV.RWS_STK_DT_TM_TS), #dtSubstrStart#, #dtSubstEnd#)
                FROM
                    PRCH_REQ     PR
                   ,PRCH_REQ_DTL PRD
                   ,RWS_DTL      RWS
                   ,RWS_PUT_AWAY RCV
                WHERE
                    PR.PRCH_REQ_REC_TP_CD     = #prchReqRecTpCd#
                AND PR.RQST_TECH_TOC_CD       = TM.TECH_TOC_CD
                AND PR.PRCH_REQ_NUM           = PRD.PRCH_REQ_NUM
                AND RWS.RWS_DTL_LINE_NUM      = RCV.RWS_DTL_LINE_NUM
                AND PR.GLBL_CMPY_CD           = #glblCmpyCd#
                AND PR.GLBL_CMPY_CD           = PRD.GLBL_CMPY_CD
                AND PR.GLBL_CMPY_CD           = RWS.GLBL_CMPY_CD
                AND PR.GLBL_CMPY_CD           = RCV.GLBL_CMPY_CD
                AND PR.EZCANCELFLAG           = '0'
                AND (PRD.MDSE_CD              = MRP.MDSE_CD
                            OR    (PRD.MDSE_CD LIKE OM.ORD_TAKE_MDSE_CD || #likePrefix# AND OM.ORD_TAKE_MDSE_CD IS NOT NULL))
                AND PRD.PRCH_REQ_NUM          = RWS.PRCH_REQ_NUM
                AND PRD.PRCH_REQ_LINE_NUM     = RWS.PRCH_REQ_LINE_NUM
                AND PRD.PRCH_REQ_LINE_SUB_NUM = RWS.PRCH_REQ_LINE_SUB_NUM
                AND PRD.EZCANCELFLAG          = '0'
                AND RWS.RWS_NUM               = RCV.RWS_NUM
                AND RWS.EZCANCELFLAG          = '0'
                AND RCV.EZCANCELFLAG          = '0'
                ) LAST_INVTY_RCV_DT
            ,OM.ORD_TAKE_MDSE_CD
        FROM
             MRP_INFO              MRP
            ,TECH_LOC              TL
            ,TECH_MSTR             TM
            ,S21_PSN               PSN
            ,TECH_MIN_MAX_SHUT_OFF SOF
            ,ALL_MDSE_V            AM
            ,ORD_TAKE_MDSE         OM
        WHERE
            MRP.MRP_ENBL_FLG   ='Y'
        AND MRP.GLBL_CMPY_CD   = #glblCmpyCd#
        AND MRP.INVTY_LOC_CD   = TL.TECH_LOC_CD
        AND MRP.GLBL_CMPY_CD   = TL.GLBL_CMPY_CD
        AND TL.TECH_TOC_CD     = TM.TECH_TOC_CD
        AND TL.GLBL_CMPY_CD    = TM.GLBL_CMPY_CD
        AND TM.TECH_TOC_CD     = PSN.PSN_CD
        AND TM.GLBL_CMPY_CD    = PSN.GLBL_CMPY_CD
        AND PSN.LINE_BIZ_TP_CD = SOF.LINE_BIZ_TP_CD
        AND PSN.GLBL_CMPY_CD   = SOF.GLBL_CMPY_CD
        AND MRP.MDSE_CD        = AM.MDSE_CD
        AND MRP.GLBL_CMPY_CD   = AM.GLBL_CMPY_CD
        AND MRP.MDSE_CD        = OM.ORD_TAKE_MDSE_CD(+)
        AND MRP.GLBL_CMPY_CD   = OM.GLBL_CMPY_CD(+)
        AND MRP.EZCANCELFLAG   = '0'
        AND TL.EZCANCELFLAG    = '0'
        AND TM.EZCANCELFLAG    = '0'
        AND PSN.EZCANCELFLAG   = '0'
        AND SOF.EZCANCELFLAG   = '0'
        AND AM.EZCANCELFLAG    = '0'
        AND OM.EZCANCELFLAG(+) = '0'
        AND EXISTS
            (
                SELECT
                    1
                FROM
                     PRCH_REQ     PR
                    ,PRCH_REQ_DTL PRD
                    ,RWS_DTL      RWS
                    ,RWS_PUT_AWAY RCV
                WHERE
                    PR.PRCH_REQ_REC_TP_CD     = #prchReqRecTpCd#
                AND PR.RQST_TECH_TOC_CD       = TM.TECH_TOC_CD
                AND PR.PRCH_REQ_NUM           = PRD.PRCH_REQ_NUM
                AND PR.GLBL_CMPY_CD           = #glblCmpyCd#
                AND PR.GLBL_CMPY_CD           = PRD.GLBL_CMPY_CD
                AND PR.GLBL_CMPY_CD           = RWS.GLBL_CMPY_CD
                AND PR.GLBL_CMPY_CD           = RCV.GLBL_CMPY_CD
                AND PR.EZCANCELFLAG           = '0'
                AND (PRD.MDSE_CD              = MRP.MDSE_CD
                     OR    (PRD.MDSE_CD LIKE OM.ORD_TAKE_MDSE_CD || #likePrefix# AND OM.ORD_TAKE_MDSE_CD IS NOT NULL))
                AND PRD.PRCH_REQ_NUM          = RWS.PRCH_REQ_NUM
                AND PRD.PRCH_REQ_LINE_NUM     = RWS.PRCH_REQ_LINE_NUM
                AND PRD.PRCH_REQ_LINE_SUB_NUM = RWS.PRCH_REQ_LINE_SUB_NUM
                AND PRD.EZCANCELFLAG          = '0'
                AND RWS.RWS_NUM               = RCV.RWS_NUM
                AND RWS.RWS_DTL_LINE_NUM      = RCV.RWS_DTL_LINE_NUM
                AND RWS.EZCANCELFLAG          = '0'
                AND RCV.EZCANCELFLAG          = '0'
                HAVING MAX(RCV.RWS_STK_DT_TM_TS) IS NOT NULL
                AND TO_DATE(#currentDt#, #dtFormat#) - TO_DATE(SUBSTR(MAX(RCV.RWS_STK_DT_TM_TS), #dtSubstrStart#, #dtSubstEnd#), #dtFormat#)
                                                  &gt; SOF.SHUT_OFF_DAYS_AOT
            )
       ORDER BY
           TM.TECH_TOC_CD
           ,MRP.RTL_WH_CD
           ,MRP.RTL_SWH_CD
           ,MRP.MDSE_CD
    </statement>

    <statement id="getMailInfo" parameterClass="Map"
        resultClass="Map">
        SELECT 
            PSN1.EML_ADDR MAIL
           ,PSN2.EML_ADDR SUPV_MAIL
        FROM 
            S21_PSN PSN1
           ,S21_PSN PSN2
        WHERE 
            PSN1.PSN_CD       = #psnCd#
        AND PSN1.DEL_FLG      = 'N'
        AND PSN1.GLBL_CMPY_CD = #glblCmpyCd#
        AND PSN1.HR_SUPV_ID   = PSN2.PSN_CD
        AND PSN2.DEL_FLG      = 'N'
        AND PSN1.GLBL_CMPY_CD = PSN2.GLBL_CMPY_CD
        AND PSN1.EZCANCELFLAG = '0'
        AND PSN2.EZCANCELFLAG = '0'
    </statement>

    <statement id="getInventory" parameterClass="Map"
        resultClass="BigDecimal">
        SELECT 
            SUM(INV.INVTY_QTY)
        FROM 
            INVTY INV
        WHERE 
            INV.INVTY_LOC_CD = #invtyLocCd#
        <isNotNull property="ordTakeMdseCd">
        AND INV.MDSE_CD LIKE #mdseCd# || #likePrefix#
        </isNotNull>
        <isNull property="ordTakeMdseCd">
        AND INV.MDSE_CD      = #mdseCd#
        </isNull>
        AND INV.LOC_STS_CD   = #locStsCd#
        AND INV.STK_STS_CD   = #stkStsCd#
        AND INV.GLBL_CMPY_CD = #glblCmpyCd#
        AND INV.EZCANCELFLAG = '0'
    </statement>
</sqlMap>