<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NSAL0850Query">
    <typeAlias alias="NSAL0850_ASMsg"                   type="business.blap.NSAL0850.NSAL0850_ASMsg"/>

    <statement id="getMainData" parameterClass="Map" resultMap="result.getMainData">
        SELECT
             NULL AS XX_CHK_BOX
            ,DS_CONTR_INTFC_BAT_NUM
            ,DS_CONTR_SRC_REF_NUM
            ,CONTR_INTFC_SRC_TP_CD
            ,DS_CONTR_NUM
            ,DS_CONTR_INTFC_ACT_DESC_TXT
            ,PRC_ALLOC_INTFC_TP_CD
            ,SER_NUM
            ,SVC_MACH_MSTR_PK
            ,MDSE_CD
            ,TOC_CD
            ,TOC_NM
            ,PRC_ALLOC_RATE
            ,DS_CONTR_INTFC_STS_CD
            ,INTFC_ERR_MSG_TXT
            ,DS_CONTR_PROC_STS_DESC_TXT
            ,DS_CONTR_PROC_STS_CD
            ,DS_CONTR_INTFC_PK
            ,PRC_ALLOC_INTFC_PK
            ,EZUPTIME
            ,EZUPTIMEZONE
            ,ROWNUM AS XX_ROW_NUM
            <!-- START 2016/11/28 K.Kojima [QC#14204, ADD] -->
            ,XX_REC_HIST_CRAT_TS_A
            ,XX_REC_HIST_CRAT_BY_NM_A
            ,XX_REC_HIST_UPD_TS_A
            ,XX_REC_HIST_UPD_BY_NM_A
            ,XX_REC_HIST_TBL_NM_A
            <!-- END 2016/11/28 K.Kojima [QC#14204, ADD] -->
        FROM
        (
            SELECT
                 PRC.DS_CONTR_INTFC_BAT_NUM
                ,PRC.DS_CONTR_SRC_REF_NUM
                ,PRC.CONTR_INTFC_SRC_TP_CD
                ,CON.DS_CONTR_NUM
                ,ACT.DS_CONTR_INTFC_ACT_DESC_TXT
                ,PRC.PRC_ALLOC_INTFC_TP_CD
                ,PRC.SER_NUM
                ,PRC.SVC_MACH_MSTR_PK
                ,PRC.MDSE_CD
                ,PRC.TOC_CD
                ,PRC.TOC_NM
                ,PRC.PRC_ALLOC_RATE
                ,PRC.ALLOC_INTFC_STS_CD AS DS_CONTR_INTFC_STS_CD
                ,PRC.INTFC_ERR_MSG_TXT
                ,PSTS.DS_CONTR_PROC_STS_DESC_TXT
                ,PSTS.DS_CONTR_PROC_STS_CD
                ,CON.DS_CONTR_INTFC_PK
                ,PRC.PRC_ALLOC_INTFC_PK
                ,PRC.EZUPTIME
                ,PRC.EZUPTIMEZONE
                <!-- START 2016/11/28 K.Kojima [QC#14204, ADD] -->
                ,PRC.EZINTIME    AS XX_REC_HIST_CRAT_TS_A
                ,PRC.EZINUSERID  AS XX_REC_HIST_CRAT_BY_NM_A
                ,PRC.EZUPTIME    AS XX_REC_HIST_UPD_TS_A
                ,PRC.EZUPUSERID  AS XX_REC_HIST_UPD_BY_NM_A
                ,PRC.EZTABLEID   AS XX_REC_HIST_TBL_NM_A
                <!-- END 2016/11/28 K.Kojima [QC#14204, ADD] -->
            FROM
                 PRC_ALLOC_INTFC     PRC
                ,DS_CONTR_INTFC      CON
                ,DS_CONTR_INTFC_ACT  ACT
                ,DS_CONTR_PROC_STS   PSTS
                ,PRC_ALLOC_INTFC_TP  AIT
                ,SVC_MACH_MSTR      MAC
            WHERE
                PRC.GLBL_CMPY_CD                = #glblCmpyCd#
                AND PRC.EZCANCELFLAG            = '0'
                AND PRC.GLBL_CMPY_CD            = CON.GLBL_CMPY_CD
                AND PRC.DS_CONTR_INTFC_BAT_NUM  = CON.DS_CONTR_INTFC_BAT_NUM
                AND PRC.DS_CONTR_SRC_REF_NUM    = CON.DS_CONTR_SRC_REF_NUM
                AND PRC.CONTR_INTFC_SRC_TP_CD   = CON.CONTR_INTFC_SRC_TP_CD
                AND PRC.EZCANCELFLAG            = CON.EZCANCELFLAG
                AND CON.CONTR_INTFC_DTL_TP_CD   = #contrIntfcDtlTpCd#
                AND NVL(PRC.SVC_MACH_MSTR_PK,0) = NVL(CON.SVC_MACH_MSTR_PK,0)
                AND CON.GLBL_CMPY_CD            = ACT.GLBL_CMPY_CD(+)
                AND CON.DS_CONTR_INTFC_ACT_CD   = ACT.DS_CONTR_INTFC_ACT_CD(+)
                AND CON.EZCANCELFLAG            = ACT.EZCANCELFLAG(+)
                AND CON.GLBL_CMPY_CD            = PSTS.GLBL_CMPY_CD(+)
                AND CON.DS_CONTR_PROC_STS_CD    = PSTS.DS_CONTR_PROC_STS_CD(+)
                AND CON.EZCANCELFLAG            = PSTS.EZCANCELFLAG(+)
                AND PRC.GLBL_CMPY_CD            = AIT.GLBL_CMPY_CD(+)
                AND PRC.CONTR_INTFC_SRC_TP_CD   = AIT.PRC_ALLOC_INTFC_TP_CD(+)
                AND PRC.EZCANCELFLAG            = AIT.EZCANCELFLAG(+)
                AND PRC.GLBL_CMPY_CD            = MAC.GLBL_CMPY_CD(+)
                AND PRC.SVC_MACH_MSTR_PK        = MAC.SVC_MACH_MSTR_PK(+)
                AND PRC.EZCANCELFLAG            = MAC.EZCANCELFLAG(+)
                <isNotNull property="dsContrIntfcPkList">
                    <iterate property="dsContrIntfcPkList" var="dsContrIntfcPkList[]" open="                AND CON.DS_CONTR_INTFC_PK IN (" close=")" conjunction=",">
                        #dsContrIntfcPkList[]#
                    </iterate>
                </isNotNull>
                <isNotNull property="dsContrNum">
                AND CON.DS_CONTR_NUM            = #dsContrNum#
                </isNotNull>
                <isNotNull property="dsContrIntfcBatNum">
                AND PRC.DS_CONTR_INTFC_BAT_NUM = #dsContrIntfcBatNum#
                </isNotNull>
                <isNotNull property="dsContrSrcRefNum">
                AND PRC.DS_CONTR_SRC_REF_NUM   = #dsContrSrcRefNum#
                </isNotNull>
                <isNotNull property="contrIntfcSrcTpCd">
                AND PRC.CONTR_INTFC_SRC_TP_CD  = #contrIntfcSrcTpCd#
                </isNotNull>
                <isNotNull property="xxErrFlgList">
                    <iterate property="xxErrFlgList" var="xxErrFlgList[]" open="                AND PSTS.DS_CONTR_PROC_STS_CD IN (" close=")" conjunction=",">
                        #xxErrFlgList[]#
                    </iterate>
                </isNotNull>
            ORDER BY
                 PRC.DS_CONTR_SRC_REF_NUM
                ,PRC.CONTR_INTFC_SRC_TP_CD
                ,PRC.DS_CONTR_INTFC_BAT_NUM
           <!-- ,PRC.CPO_SVC_DTL_PK -->
                ,MAC.SVC_CONFIG_MSTR_PK NULLS FIRST
                ,PRC.SVC_MACH_MSTR_PK
                ,MAC.SVC_MACH_TP_CD
                ,PRC.PRC_ALLOC_INTFC_TP_CD
        )
        WHERE
            ROWNUM &lt;= #limitNum#

    </statement>
    <resultMap id="result.getMainData"        class="NSAL0850_ASMsg">
        <result property="dsContrIntfcBatNum_A"             column="DS_CONTR_INTFC_BAT_NUM"         javaType="EZDSStringItem"/>
        <result property="dsContrSrcRefNum_A"               column="DS_CONTR_SRC_REF_NUM"           javaType="EZDSStringItem"/>
        <result property="contrIntfcSrcTpCd_A"              column="CONTR_INTFC_SRC_TP_CD"          javaType="EZDSStringItem"/>
        <result property="dsContrNum_A"                     column="DS_CONTR_NUM"                   javaType="EZDSStringItem"/>
        <result property="dsContrIntfcActDescTxt_A"         column="DS_CONTR_INTFC_ACT_DESC_TXT"    javaType="EZDSStringItem"/>
        <result property="prcAllocIntfcTpCd_A"              column="PRC_ALLOC_INTFC_TP_CD"          javaType="EZDSStringItem"/>
        <result property="serNum_A"                         column="SER_NUM"                        javaType="EZDSStringItem"/>
        <result property="svcMachMstrPk_A"                  column="SVC_MACH_MSTR_PK"               javaType="EZDSBigDecimalItem"/>
        <result property="mdseCd_A"                         column="MDSE_CD"                        javaType="EZDSStringItem"/>
        <result property="tocCd_A"                          column="TOC_CD"                         javaType="EZDSStringItem"/>
        <result property="tocNm_A"                          column="TOC_NM"                         javaType="EZDSStringItem"/>
        <result property="prcAllocRate_A"                   column="PRC_ALLOC_RATE"                 javaType="EZDSBigDecimalItem"/>
        <result property="dsContrIntfcStsCd_A"              column="DS_CONTR_INTFC_STS_CD"          javaType="EZDSStringItem"/>
        <result property="intfcErrMsgTxt_A"                 column="INTFC_ERR_MSG_TXT"              javaType="EZDSStringItem"/>
        <result property="dsContrProcStsDescTxt_A"          column="DS_CONTR_PROC_STS_DESC_TXT"     javaType="EZDSStringItem"/>
        <result property="dsContrProcStsCd_A"               column="DS_CONTR_PROC_STS_CD"           javaType="EZDSStringItem"/>
        <result property="dsContrIntfcPk_A"                 column="DS_CONTR_INTFC_PK"              javaType="EZDSBigDecimalItem"/>
        <result property="prcAllocIntfcPk_A"                column="PRC_ALLOC_INTFC_PK"             javaType="EZDSBigDecimalItem"/>
        <result property="ezUpTime"                         column="EZUPTIME"                       javaType="EZDSStringItem"/>
        <result property="ezUpTimeZone"                     column="EZUPTIMEZONE"                   javaType="EZDSStringItem"/>
        <result property="xxRowNum_A"                       column="XX_ROW_NUM"                     javaType="EZDSBigDecimalItem"/>
        <!-- START 2016/11/28 K.Kojima [QC#14204, ADD] -->
        <result property="xxRecHistCratTs_A"                column="XX_REC_HIST_CRAT_TS_A"          javaType="EZDSStringItem"/>
        <result property="xxRecHistCratByNm_A"              column="XX_REC_HIST_CRAT_BY_NM_A"       javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdTs_A"                 column="XX_REC_HIST_UPD_TS_A"           javaType="EZDSStringItem"/>
        <result property="xxRecHistUpdByNm_A"               column="XX_REC_HIST_UPD_BY_NM_A"        javaType="EZDSStringItem"/>
        <result property="xxRecHistTblNm_A"                 column="XX_REC_HIST_TBL_NM_A"           javaType="EZDSStringItem"/>
        <!-- END 2016/11/28 K.Kojima [QC#14204, ADD] -->
   </resultMap>

    <statement id="getPrcAllocIntfcPk" parameterClass="Map" resultClass="Map">
           SELECT
                 CON.DS_CONTR_NUM
                ,ACT.DS_CONTR_INTFC_ACT_DESC_TXT
                ,PRC.ALLOC_INTFC_STS_CD AS DS_CONTR_INTFC_STS_CD
                ,PRC.INTFC_ERR_MSG_TXT
                ,PSTS.DS_CONTR_PROC_STS_DESC_TXT
                ,PSTS.DS_CONTR_PROC_STS_CD
                ,CON.DS_CONTR_INTFC_PK
                ,PRC.PRC_ALLOC_INTFC_PK
                ,PRC.EZUPTIME
                ,PRC.EZUPTIMEZONE
            FROM
                 DS_CONTR_INTFC      CON
                ,PRC_ALLOC_INTFC     PRC
                ,DS_CONTR_INTFC_ACT  ACT
                ,DS_CONTR_PROC_STS   PSTS
            WHERE
                CON.GLBL_CMPY_CD                = #glblCmpyCd#
                AND CON.EZCANCELFLAG            = '0'
                AND CON.GLBL_CMPY_CD            = PRC.GLBL_CMPY_CD
                AND CON.DS_CONTR_INTFC_BAT_NUM  = PRC.DS_CONTR_INTFC_BAT_NUM
                AND CON.DS_CONTR_SRC_REF_NUM    = PRC.DS_CONTR_SRC_REF_NUM
                AND CON.CONTR_INTFC_SRC_TP_CD   = PRC.CONTR_INTFC_SRC_TP_CD
                AND NVL(CON.SVC_MACH_MSTR_PK,0) = NVL(PRC.SVC_MACH_MSTR_PK,0)
                AND CON.EZCANCELFLAG            = PRC.EZCANCELFLAG
                AND CON.GLBL_CMPY_CD            = ACT.GLBL_CMPY_CD(+)
                AND CON.DS_CONTR_INTFC_ACT_CD   = ACT.DS_CONTR_INTFC_ACT_CD(+)
                AND CON.EZCANCELFLAG            = ACT.EZCANCELFLAG(+)
                AND CON.GLBL_CMPY_CD            = PSTS.GLBL_CMPY_CD(+)
                AND CON.DS_CONTR_PROC_STS_CD    = PSTS.DS_CONTR_PROC_STS_CD(+)
                AND CON.EZCANCELFLAG            = PSTS.EZCANCELFLAG(+)
                AND PRC.DS_CONTR_INTFC_BAT_NUM  = #dsContrIntfcBatNum#
                AND PRC.DS_CONTR_SRC_REF_NUM    = #dsContrSrcRefNum#
                AND PRC.CONTR_INTFC_SRC_TP_CD   = #contrIntfcSrcTpCd#
                <isNotNull property="serNum">
                AND PRC.SER_NUM                 = #serNum# 
                </isNotNull>
                <isNull property="serNum">
                AND PRC.SER_NUM IS NULL 
                </isNull>
                <isNotNull property="mdseCd">
                AND PRC.MDSE_CD                 = #mdseCd#
                </isNotNull>
                <isNull property="mdseCd">
                AND PRC.MDSE_CD IS NULL
                </isNull>
                AND PRC.PRC_ALLOC_INTFC_TP_CD   = #prcAllocIntfcTpCd#
                AND PRC.TOC_CD                  = #tocCd#
                AND ROWNUM                      = 1
    </statement>
    <statement id="getDsContrIntfcPk" parameterClass="Map" resultClass="Map">
           SELECT
                 CON.DS_CONTR_NUM
                ,ACT.DS_CONTR_INTFC_ACT_DESC_TXT
                ,CON.DS_CONTR_INTFC_STS_CD
                ,CON.INTFC_ERR_MSG_TXT
                ,PSTS.DS_CONTR_PROC_STS_DESC_TXT
                ,PSTS.DS_CONTR_PROC_STS_CD
                ,CON.DS_CONTR_INTFC_PK
                ,CON.EZUPTIME
                ,CON.EZUPTIMEZONE
            FROM
                 DS_CONTR_INTFC      CON
                ,DS_CONTR_INTFC_ACT  ACT
                ,DS_CONTR_PROC_STS   PSTS
            WHERE
                CON.GLBL_CMPY_CD                = #glblCmpyCd#
                AND CON.EZCANCELFLAG            = '0'
                AND CON.DS_CONTR_INTFC_BAT_NUM  = #dsContrIntfcBatNum#
                AND CON.DS_CONTR_SRC_REF_NUM    = #dsContrSrcRefNum#
                AND CON.CONTR_INTFC_SRC_TP_CD   = #contrIntfcSrcTpCd#
                <isNotNull property="svcMachMstrPk">
                AND CON.SVC_MACH_MSTR_PK        = #svcMachMstrPk#
                </isNotNull>
                <isNull property="svcMachMstrPk">
                AND CON.SVC_MACH_MSTR_PK IS NULL
                </isNull>
                AND CON.GLBL_CMPY_CD            = ACT.GLBL_CMPY_CD(+)
                AND CON.DS_CONTR_INTFC_ACT_CD   = ACT.DS_CONTR_INTFC_ACT_CD(+)
                AND CON.EZCANCELFLAG            = ACT.EZCANCELFLAG(+)
                AND CON.GLBL_CMPY_CD            = PSTS.GLBL_CMPY_CD(+)
                AND CON.DS_CONTR_PROC_STS_CD    = PSTS.DS_CONTR_PROC_STS_CD(+)
                AND CON.EZCANCELFLAG            = PSTS.EZCANCELFLAG(+)
                AND ROWNUM                      = 1
    </statement>
    <statement id="getStatusUpdateTarget" parameterClass="Map" resultClass="Map">
         SELECT
            DCI.GLBL_CMPY_CD
           ,DCI.DS_CONTR_INTFC_PK
        FROM
            DS_CONTR_INTFC        DCI
        WHERE
            DCI.GLBL_CMPY_CD                = #glblCmpyCd#
            AND DCI.EZCANCELFLAG            = '0'
            AND DCI.DS_CONTR_PROC_STS_CD IN(#inProcess#, #reProcess#)
            AND EXISTS(SELECT 1 FROM PRC_ALLOC_INTFC PAI
                        WHERE
                        DCI.GLBL_CMPY_CD                = PAI.GLBL_CMPY_CD
                        AND DCI.DS_CONTR_INTFC_BAT_NUM  = PAI.DS_CONTR_INTFC_BAT_NUM
                        AND DCI.CONTR_INTFC_SRC_TP_CD   = PAI.CONTR_INTFC_SRC_TP_CD
                        AND DCI.DS_CONTR_SRC_REF_NUM    = PAI.DS_CONTR_SRC_REF_NUM
                   <!-- AND NVL(DCI.CPO_SVC_DTL_PK, 0)  = NVL(PAI.CPO_SVC_DTL_PK, 0) -->
                        AND PAI.ALLOC_INTFC_STS_CD      = #intfcStsError#
                        <iterate property="prcAllocIntfcPkList" var="prcAllocIntfcPkList[]" open="                AND PAI.PRC_ALLOC_INTFC_PK IN (" close=")" conjunction=",">
                            #prcAllocIntfcPkList[]#
                        </iterate>
                        AND PAI.EZCANCELFLAG            = '0')
        ORDER BY DCI.DS_CONTR_INTFC_PK
    </statement>

<!-- START 2016/07/28 M.Gotou [QC#12141, ADD] -->
    <statement id="countCpltData" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            COUNT(*)
        FROM
            DS_CONTR_INTFC     CON
        WHERE
                CON.GLBL_CMPY_CD          = #glblCmpyCd#
            AND CON.DS_CONTR_PROC_STS_CD  = #dsContrProcStsCd#
            AND CON.EZCANCELFLAG          = '0'
            <iterate property="dsContrIntfcPkList" var="dsContrIntfcPkList[]" open="AND CON.DS_CONTR_INTFC_PK IN (" close=")" conjunction=",">
                #dsContrIntfcPkList[]#
            </iterate>
    </statement>
    <statement id="getDsContrIntfcActDescTxt" parameterClass="Map" resultClass="String">
        SELECT
            DS_CONTR_INTFC_ACT_DESC_TXT
        FROM
        (
            SELECT
                ACT.DS_CONTR_INTFC_ACT_DESC_TXT
            FROM
                 DS_CONTR_INTFC     CON
                ,DS_CONTR_INTFC_ACT ACT
            WHERE
                    CON.GLBL_CMPY_CD          = #glblCmpyCd#
                AND CON.EZCANCELFLAG          = '0'
                AND CON.GLBL_CMPY_CD          = ACT.GLBL_CMPY_CD
                AND CON.DS_CONTR_INTFC_ACT_CD = ACT.DS_CONTR_INTFC_ACT_CD
                AND CON.EZCANCELFLAG          = ACT.EZCANCELFLAG
                <iterate property="dsContrIntfcPkList" var="dsContrIntfcPkList[]" open="AND CON.DS_CONTR_INTFC_PK IN (" close=")" conjunction=",">
                    #dsContrIntfcPkList[]#
                </iterate>
            ORDER BY
                CON.DS_CONTR_INTFC_PK
        )
        WHERE
            ROWNUM = 1
    </statement>
<!-- END 2016/07/28 M.Gotou [QC#12141, ADD] -->
</sqlMap>
