<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NMAL7160Query">

    <typeAlias alias="NMAL7160_ASMsg"   type="business.blap.NMAL7160.NMAL7160_ASMsg"/>

    <statement id="getSearchResult" parameterClass="Map" resultMap="result.getSearchResult">
        SELECT
            * 
        FROM
            (    SELECT
                     I.CPO_ORD_NUM                          CPO_ORD_NUM
                    ,CONCAT (IL.DS_ORD_POSN_NUM, DECODE(IL.DS_ORD_POSN_NUM, NULL, '', '.'))
                        || CONCAT (IL.DS_CPO_LINE_NUM, DECODE(IL.DS_CPO_LINE_SUB_NUM, NULL, '', '.'))
                        || IL.DS_CPO_LINE_SUB_NUM          DPLY_LINE_NUM
                    ,I.INV_NUM                              INV_NUM
                    ,IL.MDSE_CD                             MDSE_CD
                    ,DMI.MDSE_DESC_SHORT_TXT                MDSE_DESC_SHORT_TXT
                    ,IL.CSMP_CONTR_NUM                      CSMP_CONTR_NUM
                    ,IL.DLR_REF_NUM                         DLR_REF_NUM
                    ,(SELECT MAX(C2.CSMP_INV_ERR_DT)
                        FROM CSMP_INV_ERR C2
                        WHERE
                            IL.GLBL_CMPY_CD     = C2.GLBL_CMPY_CD
                        AND IL.INV_NUM          = C2.ORIG_INV_NUM
                        AND IL.INV_BOL_LINE_NUM = C2.ORIG_INV_BOL_LINE_NUM
                        AND IL.INV_LINE_NUM     = C2.ORIG_INV_LINE_NUM
                        AND IL.INV_LINE_SUB_NUM = C2.ORIG_INV_LINE_SUB_NUM
                        AND IL.INV_LINE_SUB_TRX_NUM = C2.ORIG_INV_LINE_SUB_TRX_NUM
                        AND C2.EZCANCELFLAG     = '0' )     CSMP_INV_ERR_DT
                    ,IL.INV_BOL_LINE_NUM                    INV_BOL_LINE_NUM
                    ,IL.INV_LINE_NUM                        INV_LINE_NUM
                    ,IL.INV_LINE_SUB_NUM                    INV_LINE_SUB_NUM
                    ,IL.INV_LINE_SUB_TRX_NUM                INV_LINE_SUB_TRX_NUM
                    ,IL.EZUPTIME                            EZUPTIME
                    ,IL.EZUPTIMEZONE                        EZUPTIMEZONE
                FROM 
                    INV I
                    ,INV_LINE IL
                    ,MDSE         DMI
                WHERE
                        I.GLBL_CMPY_CD      = #glblCmpyCd#
                <isNotNull property="invNum">
                    AND I.INV_NUM           LIKE #invNum#
                </isNotNull>
                
                <isNotNull property="ordNum">
                    AND I.CPO_ORD_NUM       LIKE #ordNum#
                </isNotNull>
                    AND I.EZCANCELFLAG      = '0'
                    
                    AND I.GLBL_CMPY_CD      = IL.GLBL_CMPY_CD
                    AND I.INV_NUM           = IL.INV_NUM
                    AND IL.CSMP_INV_PROC_STS_CD  = #procStsErr#
                <isNotNull property="csmpNum">
                    AND IL.CSMP_CONTR_NUM   LIKE #csmpNum#
                </isNotNull>
                <isNotNull property="csaNum">
                    AND IL.DLR_REF_NUM      LIKE #csaNum#
                </isNotNull>
                    
                <isNotNull property="itemCd">
                    AND IL.MDSE_CD          LIKE #itemCd#
                </isNotNull>
                    AND IL.EZCANCELFLAG         = '0'
                    
                    AND IL.GLBL_CMPY_CD     = DMI.GLBL_CMPY_CD
                    AND IL.MDSE_CD          = DMI.MDSE_CD
                    AND DMI.EZCANCELFLAG    = '0'
            
                ORDER BY
                     CPO_ORD_NUM
                    ,DPLY_LINE_NUM
                    ,INV_NUM
            ) TBL
        WHERE 
                ROWNUM &lt;= #rowNum#
        <isNotNull property="errDtFrom">
            AND TBL.CSMP_INV_ERR_DT  &gt;= #errDtFrom#
        </isNotNull>
        <isNotNull property="errDtTo">
            AND TBL.CSMP_INV_ERR_DT  &lt;= #errDtTo#
        </isNotNull>
        
    </statement>
    
    <resultMap id="result.getSearchResult" class="NMAL7160_ASMsg">
        <result property="cpoOrdNum_A"            column="CPO_ORD_NUM"                javaType="EZDCStringItem"/>
        <result property="dplyLineNum_A"          column="DPLY_LINE_NUM"              javaType="EZDCStringItem"/>
        <result property="invNum_A"               column="INV_NUM"                    javaType="EZDCStringItem"/>
        <result property="mdseCd_A"               column="MDSE_CD"                    javaType="EZDCStringItem"/>
        <result property="mdseDescShortTxt_A"     column="MDSE_DESC_SHORT_TXT"        javaType="EZDCStringItem"/>
        <result property="csmpContrNum_A"         column="CSMP_CONTR_NUM"             javaType="EZDCStringItem"/>
        <result property="dlrRefNum_A"            column="DLR_REF_NUM"                javaType="EZDCStringItem"/>
        <result property="csmpInvErrDt_A"         column="CSMP_INV_ERR_DT"            javaType="EZDCStringItem"/>
        <result property="invBolLineNum_A"        column="INV_BOL_LINE_NUM"           javaType="EZDCStringItem"/>
        <result property="invLineNum_A"           column="INV_LINE_NUM"               javaType="EZDCStringItem"/>
        <result property="invLineSubNum_A"        column="INV_LINE_SUB_NUM"           javaType="EZDCStringItem"/>
        <result property="invLineSubTrxNum_A"     column="INV_LINE_SUB_TRX_NUM"       javaType="EZDCStringItem"/>
        <result property="ezUpTime_A"             column="EZUPTIME"                   javaType="EZDCStringItem"/>
        <result property="ezUpTimeZone_A"         column="EZUPTIMEZONE"               javaType="EZDCStringItem"/>
    </resultMap>
    
    
</sqlMap>
