<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NLCB116001">

    <statement id="getTrgtYrMth" parameterClass="Map" resultClass="String">
        SELECT
            CAL.DWH_TRGT_YR_MTH
        FROM
            DMN_RPT_CAL            CAL
        WHERE 
            CAL.GLBL_CMPY_CD       = #glblCmpyCd#
        AND CAL.DWH_TRGT_DT        = #trgtDt#
        AND CAL.EZCANCELFLAG       = '0'
    </statement>

    <statement id="getTrgtYrMthRec" parameterClass="Map" resultClass="BigDecimal">
        SELECT COUNT(1)
        FROM
            FCT_INVTY_OH_AGING       MAIN
        WHERE 
            MAIN.GLBL_CMPY_CD         = #glblCmpyCd#
        AND MAIN.DWH_TRGT_YR_MTH      = #trgtYrMth#
        AND MAIN.EZCANCELFLAG         = '0'
    </statement>

    <statement id="getMainData" parameterClass="Map" resultClass="Map">
        SELECT
            INVTY_LOC_CD
           ,RTL_WH_CD
           ,RTL_SWH_CD
           ,RTL_WH_CATG_CD
           ,MDSE_CD
           ,STK_IN_DT
           ,INVTY_AGING_DAYS_AOT
           ,INVTY_AGING_BCKT_DESC_TXT
           ,SUM(CASE INVTY_AGING_BCKT_DESC_TXT WHEN '1' THEN INVTY_QTY ELSE 0 END) AGE_INVTY_QTY_01
           ,SUM(CASE INVTY_AGING_BCKT_DESC_TXT WHEN '2' THEN INVTY_QTY ELSE 0 END) AGE_INVTY_QTY_02
           ,SUM(CASE INVTY_AGING_BCKT_DESC_TXT WHEN '3' THEN INVTY_QTY ELSE 0 END) AGE_INVTY_QTY_03
           ,SUM(CASE INVTY_AGING_BCKT_DESC_TXT WHEN '4' THEN INVTY_QTY ELSE 0 END) AGE_INVTY_OVER_QTY
        FROM
            (
            SELECT
                INV.INVTY_LOC_CD
               ,SWH.RTL_WH_CD
               ,SWH.RTL_SWH_CD
               ,SWH.RTL_WH_CATG_CD
               ,INV.MDSE_CD
               ,INV.STK_IN_DT
               ,INV.INVTY_QTY
               ,TRUNC(TO_DATE(#trgtDt#, 'YYYYMMDD')) - TO_DATE(INV.STK_IN_DT, 'YYYYMMDD') AS INVTY_AGING_DAYS_AOT
               ,CASE WHEN TO_DATE(#trgtDt#, 'YYYYMMDD') - TO_DATE(INV.STK_IN_DT, 'YYYYMMDD') &lt; 31 THEN '1'
                     WHEN TO_DATE(#trgtDt#, 'YYYYMMDD') - TO_DATE(INV.STK_IN_DT, 'YYYYMMDD') &lt; 61 THEN '2'
                     WHEN TO_DATE(#trgtDt#, 'YYYYMMDD') - TO_DATE(INV.STK_IN_DT, 'YYYYMMDD') &lt; 91 THEN '3'
                     WHEN TO_DATE(#trgtDt#, 'YYYYMMDD') - TO_DATE(INV.STK_IN_DT, 'YYYYMMDD') &gt; 90 THEN '4'
                     ELSE NULL END AS INVTY_AGING_BCKT_DESC_TXT
            FROM
                INVTY_DTL_SNAP_SHOT   INV
               ,RTL_SWH               SWH
            WHERE
                INV.GLBL_CMPY_CD           = #glblCmpyCd#
            AND INV.INVTY_DTL_SNAP_SHOT_DT = #trgtDt#
            AND INV.GLBL_CMPY_CD           = SWH.GLBL_CMPY_CD
            AND INV.INVTY_LOC_CD           = SWH.INVTY_LOC_CD
            AND INV.EZCANCELFLAG           = '0'
            AND SWH.EZCANCELFLAG           = '0'
              ) MAIN
        GROUP BY
            INVTY_LOC_CD
           ,MDSE_CD
           ,STK_IN_DT
           ,RTL_WH_CD
           ,RTL_SWH_CD
           ,RTL_WH_CATG_CD
           ,INVTY_AGING_DAYS_AOT
           ,INVTY_AGING_BCKT_DESC_TXT
    </statement>

</sqlMap>
