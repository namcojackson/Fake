<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NSAB036001">

<!-- START 2018/08/28 M.Naito [QC#27102, MOD] -->
    <statement id="getAnnualEscalationList" parameterClass="Map" resultClass="Map">
        WITH
            IV_ANE_ESCL_B AS (
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             RNW.DS_CONTR_MACH_LVL_NUM
                            ,RNW.DS_CONTR_PK
                            ,RNW.DS_CONTR_DTL_PK
                            ,COALESCE(RNW.UPLFT_BEF_END_RNW_DAYS_AOT, IDR.BEF_END_UPLFT_DAYS_AOT, 1) AS UPLFT_BEF_END_RNW_DAYS_AOT
                            ,RNW.DS_CONTR_BASE_USG_NM
                            ,CTP.UPLFT_BASE_FLG
                            ,CTP.UPLFT_USG_FLG
                            ,RNW.CONTR_UPLFT_TP_CD
                            ,RNW.UPLFT_PCY_DT
                            ,RNW.MAX_PRC_UP_RATIO
                        FROM
                             DS_CONTR_RNW_ESCL       RNW
                            ,CONTR_UPLFT_TP          CTP
                            ,DS_CONTR                CON
                            ,DS_CONTR_STS_V          CSV
                            ,DS_CONTR_INTFC_DEF_RULE IDR
                        WHERE
                            RNW.GLBL_CMPY_CD             =  #glblCmpyCd#
                            AND RNW.EZCANCELFLAG         =  '0'
                            AND RNW.UPLFT_PRC_METH_CD    IS NOT NULL
                            AND RNW.UPLFT_PCY_DT         &lt;= TO_CHAR(TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(RNW.UPLFT_BEF_END_RNW_DAYS_AOT, IDR.BEF_END_UPLFT_DAYS_AOT, 1), 'YYYYMMDD')
                            AND CTP.GLBL_CMPY_CD         =  RNW.GLBL_CMPY_CD
                            AND CTP.CONTR_UPLFT_TP_CD    =  RNW.CONTR_UPLFT_TP_CD
                            AND CTP.EZCANCELFLAG         =  '0'
                            AND CTP.UPLFT_BASE_FLG       =  'Y'
                            AND RNW.GLBL_CMPY_CD         =  CON.GLBL_CMPY_CD
                            AND RNW.DS_CONTR_PK          =  CON.DS_CONTR_PK
                            AND CON.EZCANCELFLAG         =  '0'
                            AND CON.GLBL_CMPY_CD         =  CSV.GLBL_CMPY_CD
                            AND CON.DS_CONTR_PK          =  CSV.DS_CONTR_PK
                            AND CSV.EZCANCELFLAG         =  '0'
                            AND CSV.CONTR_ESCL_AVAL_FLG  =  'Y'
                            AND CON.GLBL_CMPY_CD         =  IDR.GLBL_CMPY_CD(+)
                            AND CON.DS_CONTR_SRC_TP_CD   =  IDR.CONTR_INTFC_SRC_TP_CD(+)
                            AND CON.DS_CONTR_CLS_CD      =  IDR.DS_CONTR_CLS_CD(+)
                            AND CON.SVC_LINE_BIZ_CD      =  IDR.SVC_LINE_BIZ_CD(+)
                            AND IDR.EZCANCELFLAG(+)      =  '0'
                            AND IDR.EFF_FROM_DT(+)       &lt;= #slsDt#
                            AND IDR.ENBL_FLG(+)          =  'Y'
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
           ,IV_ANE_ESCL_U AS (
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             RNW.DS_CONTR_MACH_LVL_NUM
                            ,RNW.DS_CONTR_PK
                            ,RNW.DS_CONTR_DTL_PK
                            ,COALESCE(RNW.UPLFT_BEF_END_RNW_DAYS_AOT, IDR.BEF_END_UPLFT_DAYS_AOT, 1) AS UPLFT_BEF_END_RNW_DAYS_AOT
                            ,RNW.DS_CONTR_BASE_USG_NM
                            ,CTP.UPLFT_BASE_FLG
                            ,CTP.UPLFT_USG_FLG
                            ,RNW.CONTR_UPLFT_TP_CD
                            ,RNW.UPLFT_PCY_DT
                        FROM
                             DS_CONTR_RNW_ESCL       RNW
                            ,CONTR_UPLFT_TP          CTP
                            ,DS_CONTR                CON
                            ,DS_CONTR_STS_V          CSV
                            ,DS_CONTR_INTFC_DEF_RULE IDR
                        WHERE
                            RNW.GLBL_CMPY_CD             =  #glblCmpyCd#
                            AND RNW.EZCANCELFLAG         =  '0'
                            AND RNW.UPLFT_PRC_METH_CD    IS NOT NULL
                            AND RNW.UPLFT_PCY_DT         &lt;= TO_CHAR(TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(RNW.UPLFT_BEF_END_RNW_DAYS_AOT, IDR.BEF_END_UPLFT_DAYS_AOT, 1), 'YYYYMMDD')
                            AND CTP.GLBL_CMPY_CD         =  RNW.GLBL_CMPY_CD
                            AND CTP.CONTR_UPLFT_TP_CD    =  RNW.CONTR_UPLFT_TP_CD
                            AND CTP.EZCANCELFLAG         =  '0'
                            AND CTP.UPLFT_USG_FLG        =  'Y'
                            AND RNW.GLBL_CMPY_CD         =  CON.GLBL_CMPY_CD
                            AND RNW.DS_CONTR_PK          =  CON.DS_CONTR_PK
                            AND CON.EZCANCELFLAG         =  '0'
                            AND CON.GLBL_CMPY_CD         =  CSV.GLBL_CMPY_CD
                            AND CON.DS_CONTR_PK          =  CSV.DS_CONTR_PK
                            AND CSV.EZCANCELFLAG         =  '0'
                            AND CSV.CONTR_ESCL_AVAL_FLG  =  'Y'
                            AND CON.GLBL_CMPY_CD         =  IDR.GLBL_CMPY_CD(+)
                            AND CON.DS_CONTR_SRC_TP_CD   =  IDR.CONTR_INTFC_SRC_TP_CD(+)
                            AND CON.DS_CONTR_CLS_CD      =  IDR.DS_CONTR_CLS_CD(+)
                            AND CON.SVC_LINE_BIZ_CD      =  IDR.SVC_LINE_BIZ_CD(+)
                            AND IDR.EZCANCELFLAG(+)      =  '0'
                            AND IDR.EFF_FROM_DT(+)       &lt;= #slsDt#
                            AND IDR.ENBL_FLG(+)          =  'Y'
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
            <!-- START 2017/11/27 K.Kojima [QC#22660,ADD] -->
            ,IV_DO_NOT_UPLIFT AS (
                        SELECT
                             DCRE.DS_CONTR_PK
                            ,DCRE.DS_CONTR_DTL_PK
                            ,DCRE.DS_CONTR_MACH_LVL_NUM
                            ,DCRE.DS_CONTR_BASE_USG_NM
                        FROM
                            DS_CONTR_RNW_ESCL DCRE
                        WHERE
                                DCRE.GLBL_CMPY_CD      = #glblCmpyCd#
                            AND DCRE.CONTR_UPLFT_TP_CD = #doNotUplift#
                            AND DCRE.EZCANCELFLAG      = '0'
            )
            <!-- END 2017/11/27 K.Kojima [QC#22660,ADD] -->
            ,IV_DTL_STS_V_B AS(
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             DSV.DS_CONTR_PK
                            ,DSV.DS_CONTR_DTL_PK
                        FROM
                             DS_CONTR_DTL_STS_V DSV
                            ,DS_CONTR_DTL       DTL
                            ,DS_CONTR_DTL_TP    TP
                        WHERE
                            DSV.GLBL_CMPY_CD            = #glblCmpyCd#
                            AND DSV.EZCANCELFLAG        = '0'
                            AND DSV.CONTR_ESCL_AVAL_FLG = 'Y'
                            AND EXISTS(
                                SELECT
                                    *
                                FROM
                                    IV_ANE_ESCL_B RNV
                                WHERE
                                    RNV.DS_CONTR_PK = DSV.DS_CONTR_PK
                                )
                            AND DSV.GLBL_CMPY_CD    = DTL.GLBL_CMPY_CD
                            AND DSV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK
                            AND DTL.EZCANCELFLAG    = '0'
                            AND (
                                    DTL.CONTR_RNW_TOT_CNT = 0
                                OR  DTL.CONTR_RNW_TOT_CNT IS NULL
                                )
                            AND DTL.GLBL_CMPY_CD       = TP.GLBL_CMPY_CD
                            AND DTL.DS_CONTR_DTL_TP_CD = TP.DS_CONTR_DTL_TP_CD
                            AND TP.EZCANCELFLAG        = '0'
                            AND TP.BASE_CHRG_FLG       = 'Y'
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
            ,IV_DTL_STS_V_U AS(
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             DSV.DS_CONTR_PK
                            ,DSV.DS_CONTR_DTL_PK
                        FROM
                             DS_CONTR_DTL_STS_V DSV
                            ,DS_CONTR_DTL       DTL
                            ,DS_CONTR_DTL_TP    TP
                        WHERE
                            DSV.GLBL_CMPY_CD            = #glblCmpyCd#
                            AND DSV.EZCANCELFLAG        = '0'
                            AND DSV.CONTR_ESCL_AVAL_FLG = 'Y'
                            AND EXISTS(
                                SELECT
                                    *
                                FROM
                                    IV_ANE_ESCL_U RNV
                                WHERE
                                    RNV.DS_CONTR_PK = DSV.DS_CONTR_PK
                                )
                            AND DSV.GLBL_CMPY_CD    = DTL.GLBL_CMPY_CD
                            AND DSV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK
                            AND DTL.EZCANCELFLAG    = '0'
                            AND (
                                    DTL.CONTR_RNW_TOT_CNT = 0
                                OR  DTL.CONTR_RNW_TOT_CNT IS NULL
                                )
                            AND DTL.GLBL_CMPY_CD       = TP.GLBL_CMPY_CD
                            AND DTL.DS_CONTR_DTL_TP_CD = TP.DS_CONTR_DTL_TP_CD
                            AND TP.EZCANCELFLAG        = '0'
                            AND TP.USG_CHRG_FLG        = 'Y'
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
        --Regular Lv3/Base
            ,IV_REG_LV3_BASE AS (
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             DS_CONTR_PK
                            ,DS_CONTR_DTL_PK
                            ,SVC_MACH_MSTR_PK
                            ,LVL_NUM
                            <!-- mod start 2019/08/15 QC#52413 -->
                            <!-- ,CASE
                                WHEN UPLFT_EFF_FROM_DT IS NULL
                                    THEN UPLFT_PCY_DT
                                    ELSE TO_CHAR(ADD_MONTHS(TO_DATE(NVL(UPLFT_EFF_FROM_DT, UPLFT_PCY_DT), 'YYYYMMDD'), 12),  'YYYYMMDD')
                             END AS EFF_FROM_DT -->
                            ,UPLFT_PCY_DT AS EFF_FROM_DT
                            <!-- mod end 2019/08/15 QC#52413 -->
                            ,CONTR_UPLFT_TP_CD
                            <!-- add start 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_FROM_DT
                            <!-- add end 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_THRU_DT
                            ,DS_CONTR_NUM
                            ,DS_CONTR_CATG_CD
                            ,DS_CONTR_DTL_TP_CD
                            ,CONTR_CLO_DAY
                            <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            ,DS_CONTR_BASE_USG_NM
                            <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                        FROM (
                            SELECT
                                 DTL.DS_CONTR_PK                DS_CONTR_PK
                                ,DTL.DS_CONTR_DTL_PK            DS_CONTR_DTL_PK
                                ,DTL.SVC_MACH_MSTR_PK           SVC_MACH_MSTR_PK
                                ,#dsContrMachLvl3#                            LVL_NUM
                                ,IAB.CONTR_UPLFT_TP_CD          CONTR_UPLFT_TP_CD
                                <!-- add start 2019/08/15 QC#52413 -->
                                ,DTL.CONTR_EFF_FROM_DT          CONTR_EFF_FROM_DT
                                <!-- add end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                                <!-- mod end 2019/09/20 QC#53646 -->
                                ,HDR.DS_CONTR_NUM
                                ,HDR.DS_CONTR_CATG_CD
                                ,DTL.DS_CONTR_DTL_TP_CD
                                ,DTL.CONTR_CLO_DAY
                                ,DTL.UPLFT_EFF_FROM_DT
                                ,IAB.UPLFT_PCY_DT
                                <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                                ,IAB.DS_CONTR_BASE_USG_NM
                                <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            FROM
                                 DS_CONTR               HDR
                                ,DS_CONTR_DTL           DTL
                                ,IV_ANE_ESCL_B          IAB
                                ,IV_DTL_STS_V_B         DTV
                            WHERE
                                    HDR.GLBL_CMPY_CD                =  #glblCmpyCd#
                                AND HDR.DS_CONTR_CATG_CD            =  #dsContrCatgReg#
                                AND HDR.EZCANCELFLAG                =  '0'
                                AND HDR.GLBL_CMPY_CD                =  DTL.GLBL_CMPY_CD
                                AND HDR.DS_CONTR_PK                 =  DTL.DS_CONTR_PK
                                AND DTL.EZCANCELFLAG                =  '0'
                                AND DTL.DS_CONTR_PK                 =  IAB.DS_CONTR_PK
                                AND DTL.DS_CONTR_DTL_PK             =  IAB.DS_CONTR_DTL_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                       DTL.UPLFT_EFF_FROM_DT        &lt;= #slsDt#
                                    OR DTL.UPLFT_EFF_FROM_DT        IS NULL
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                AND NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)
                                                                    &gt;= #slsDt#
                                <!-- mod end 2019/09/20 QC#53646 -->
                                AND IAB.DS_CONTR_MACH_LVL_NUM       =  #dsContrMachLvl3#
                                AND IAB.DS_CONTR_BASE_USG_NM        =  #dsContrBaseUsgNmBase#
                                AND DTL.DS_CONTR_DTL_PK             = DTV.DS_CONTR_DTL_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT IS NULL
                                    OR  MONTHS_BETWEEN(
                                         TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(IAB.UPLFT_BEF_END_RNW_DAYS_AOT, 1)
                                        ,TO_DATE(NVL(DTL.UPLFT_EFF_FROM_DT, IAB.UPLFT_PCY_DT), 'YYYYMMDD')
                                        ) / 12 >= 1
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                            )
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
        --Regular Lv3/Usage
            ,IV_REG_LV3_USAGE AS (
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             DS_CONTR_PK
                            ,DS_CONTR_DTL_PK
                            ,SVC_MACH_MSTR_PK
                            ,LVL_NUM
                            <!-- mod start 2019/08/15 QC#52413 -->
                            <!-- ,CASE
                                WHEN UPLFT_EFF_FROM_DT IS NULL
                                    THEN UPLFT_PCY_DT
                                    ELSE TO_CHAR(ADD_MONTHS(TO_DATE(NVL(UPLFT_EFF_FROM_DT, UPLFT_PCY_DT), 'YYYYMMDD'), 12),  'YYYYMMDD')
                             END AS EFF_FROM_DT -->
                            ,UPLFT_PCY_DT AS EFF_FROM_DT
                            <!-- mod end 2019/08/15 QC#52413 -->
                            ,CONTR_UPLFT_TP_CD
                            <!-- add start 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_FROM_DT
                            <!-- add end 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_THRU_DT
                            ,DS_CONTR_NUM
                            ,DS_CONTR_CATG_CD
                            ,DS_CONTR_DTL_TP_CD
                            ,CONTR_CLO_DAY
                            <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            ,DS_CONTR_BASE_USG_NM
                            <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                        FROM (
                            SELECT
                                 DTL.DS_CONTR_PK                DS_CONTR_PK
                                ,DTL.DS_CONTR_DTL_PK            DS_CONTR_DTL_PK
                                ,DTL.SVC_MACH_MSTR_PK           SVC_MACH_MSTR_PK
                                ,#dsContrMachLvl3#              LVL_NUM
                                ,IAU.CONTR_UPLFT_TP_CD         CONTR_UPLFT_TP_CD
                                <!-- add start 2019/08/15 QC#52413 -->
                                ,DTL.CONTR_EFF_FROM_DT          CONTR_EFF_FROM_DT
                                <!-- add end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                                <!-- mod end 2019/09/20 QC#53646 -->
                                ,HDR.DS_CONTR_NUM
                                ,HDR.DS_CONTR_CATG_CD
                                ,DTL.DS_CONTR_DTL_TP_CD
                                ,DTL.CONTR_CLO_DAY
                                ,DTL.UPLFT_EFF_FROM_DT
                                ,IAU.UPLFT_PCY_DT
                                <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                                ,IAU.DS_CONTR_BASE_USG_NM
                                <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            FROM
                                 DS_CONTR               HDR
                                ,DS_CONTR_DTL           DTL
                                ,IV_ANE_ESCL_U          IAU
                                ,IV_DTL_STS_V_U         DTV
                            WHERE
                                    HDR.GLBL_CMPY_CD                =  #glblCmpyCd#
                                AND HDR.DS_CONTR_CATG_CD            =  #dsContrCatgReg#
                                AND HDR.EZCANCELFLAG                =  '0'
                                AND HDR.GLBL_CMPY_CD                =  DTL.GLBL_CMPY_CD
                                AND HDR.DS_CONTR_PK                 =  DTL.DS_CONTR_PK
                                AND DTL.EZCANCELFLAG                =  '0'
                                AND DTL.DS_CONTR_PK                 =  IAU.DS_CONTR_PK
                                AND DTL.DS_CONTR_DTL_PK             =  IAU.DS_CONTR_DTL_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                       DTL.UPLFT_EFF_FROM_DT        &lt;= #slsDt#
                                    OR DTL.UPLFT_EFF_FROM_DT        IS NULL
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                AND NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)
                                                                    &gt;= #slsDt#
                                <!-- mod end 2019/09/20 QC#53646 -->
                                AND IAU.DS_CONTR_MACH_LVL_NUM       =  #dsContrMachLvl3#
                                AND IAU.DS_CONTR_BASE_USG_NM        =  #dsContrBaseUsgNmUsage#
                                AND DTL.DS_CONTR_DTL_PK             = DTV.DS_CONTR_DTL_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT IS NULL
                                    OR  MONTHS_BETWEEN(
                                         TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(IAU.UPLFT_BEF_END_RNW_DAYS_AOT, 1)
                                        ,TO_DATE(NVL(DTL.UPLFT_EFF_FROM_DT, IAU.UPLFT_PCY_DT), 'YYYYMMDD')
                                        ) / 12 >= 1
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                            )
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
        --Regular Lv2/Base
            ,IV_REG_LV2_BASE AS (
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             DS_CONTR_PK
                            ,DS_CONTR_DTL_PK
                            ,SVC_MACH_MSTR_PK
                            ,LVL_NUM
                            <!-- mod start 2019/08/15 QC#52413 -->
                            <!-- ,CASE
                                WHEN UPLFT_EFF_FROM_DT IS NULL
                                    THEN UPLFT_PCY_DT
                                    ELSE TO_CHAR(ADD_MONTHS(TO_DATE(NVL(UPLFT_EFF_FROM_DT, UPLFT_PCY_DT), 'YYYYMMDD'), 12),  'YYYYMMDD')
                             END AS EFF_FROM_DT -->
                            ,UPLFT_PCY_DT AS EFF_FROM_DT
                            <!-- mod end 2019/08/15 QC#52413 -->
                            ,CONTR_UPLFT_TP_CD
                             <!-- add start 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_FROM_DT
                            <!-- add end 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_THRU_DT
                            ,DS_CONTR_NUM
                            ,DS_CONTR_CATG_CD
                            ,DS_CONTR_DTL_TP_CD
                            ,CONTR_CLO_DAY
                            <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            ,DS_CONTR_BASE_USG_NM
                            <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                        FROM (
                            SELECT
                                 DTL.DS_CONTR_PK                DS_CONTR_PK
                                ,DTL.DS_CONTR_DTL_PK            DS_CONTR_DTL_PK
                                ,DTL.SVC_MACH_MSTR_PK           SVC_MACH_MSTR_PK
                                ,#dsContrMachLvl2#                            LVL_NUM
                                ,IAB.CONTR_UPLFT_TP_CD          CONTR_UPLFT_TP_CD
                                <!-- add start 2019/08/15 QC#52413 -->
                                ,DTL.CONTR_EFF_FROM_DT          CONTR_EFF_FROM_DT
                                <!-- add end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                                <!-- mod end 2019/09/20 QC#53646 -->
                                ,HDR.DS_CONTR_NUM
                                ,HDR.DS_CONTR_CATG_CD
                                ,DTL.DS_CONTR_DTL_TP_CD
                                ,DTL.CONTR_CLO_DAY
                                ,DTL.UPLFT_EFF_FROM_DT
                                ,IAB.UPLFT_PCY_DT
                                <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                                ,IAB.DS_CONTR_BASE_USG_NM
                                <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            FROM
                                 DS_CONTR               HDR
                                ,DS_CONTR_DTL           DTL
                                ,IV_ANE_ESCL_B          IAB
                                ,IV_DTL_STS_V_B         DTV
                            WHERE
                                    HDR.GLBL_CMPY_CD                = #glblCmpyCd#
                                AND HDR.DS_CONTR_CATG_CD            = #dsContrCatgReg#
                                AND HDR.EZCANCELFLAG                = '0'
                                AND HDR.GLBL_CMPY_CD                = DTL.GLBL_CMPY_CD
                                AND HDR.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                                AND DTL.EZCANCELFLAG                = '0'
                                AND DTL.DS_CONTR_PK                 = IAB.DS_CONTR_PK
                                AND DTL.DS_CONTR_DTL_PK             = IAB.DS_CONTR_DTL_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT       &lt;= #slsDt#
                                    OR  DTL.UPLFT_EFF_FROM_DT       IS NULL
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                AND NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)
                                                                    &gt;= #slsDt#
                                <!-- mod end 2019/09/20 QC#53646 -->
                                AND IAB.DS_CONTR_MACH_LVL_NUM       = #dsContrMachLvl2#
                                AND DTL.DS_CONTR_DTL_PK             = DTV.DS_CONTR_DTL_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT IS NULL
                                    OR  MONTHS_BETWEEN(
                                         TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(IAB.UPLFT_BEF_END_RNW_DAYS_AOT, 1)
                                        ,TO_DATE(NVL(DTL.UPLFT_EFF_FROM_DT, IAB.UPLFT_PCY_DT), 'YYYYMMDD')
                                        ) / 12 >= 1
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        DS_CONTR_RNW_ESCL AEV3
                                    WHERE
                                        AEV3.DS_CONTR_PK             = DTL.DS_CONTR_PK
                                    AND AEV3.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                    AND AEV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                    AND AEV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmBase#
                                    AND AEV3.EZCANCELFLAG            = '0'
                                    AND AEV3.UPLFT_PCY_DT            IS NOT NULL
                                    )
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        IV_DO_NOT_UPLIFT IDNP
                                    WHERE
                                        IDNP.DS_CONTR_PK             = DTL.DS_CONTR_PK
                                    AND IDNP.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                    AND IDNP.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                    AND IDNP.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmBase#
                                    )
                              )
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
        --Regular Lv2/Usage
            ,IV_REG_LV2_USAGE AS (
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             DS_CONTR_PK
                            ,DS_CONTR_DTL_PK
                            ,SVC_MACH_MSTR_PK
                            ,LVL_NUM
                            <!-- mod start 2019/08/15 QC#52413 -->
                            <!-- ,CASE
                                WHEN UPLFT_EFF_FROM_DT IS NULL
                                    THEN UPLFT_PCY_DT
                                    ELSE TO_CHAR(ADD_MONTHS(TO_DATE(NVL(UPLFT_EFF_FROM_DT, UPLFT_PCY_DT), 'YYYYMMDD'), 12),  'YYYYMMDD')
                             END AS EFF_FROM_DT -->
                            ,UPLFT_PCY_DT AS EFF_FROM_DT
                            <!-- mod end 2019/08/15 QC#52413 -->
                            ,CONTR_UPLFT_TP_CD
                            <!-- add start 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_FROM_DT
                            <!-- add end 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_THRU_DT
                            ,DS_CONTR_NUM
                            ,DS_CONTR_CATG_CD
                            ,DS_CONTR_DTL_TP_CD
                            ,CONTR_CLO_DAY
                            <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            ,DS_CONTR_BASE_USG_NM
                            <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                        FROM (
                            SELECT
                                 DTL.DS_CONTR_PK                DS_CONTR_PK
                                ,DTL.DS_CONTR_DTL_PK            DS_CONTR_DTL_PK
                                ,DTL.SVC_MACH_MSTR_PK           SVC_MACH_MSTR_PK
                                ,#dsContrMachLvl2#                            LVL_NUM
                                ,IAU.CONTR_UPLFT_TP_CD          CONTR_UPLFT_TP_CD
                                <!-- add start 2019/08/15 QC#52413 -->
                                ,DTL.CONTR_EFF_FROM_DT          CONTR_EFF_FROM_DT
                                <!-- add end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                                <!-- mod end 2019/09/20 QC#53646 -->
                                ,HDR.DS_CONTR_NUM
                                ,HDR.DS_CONTR_CATG_CD
                                ,DTL.DS_CONTR_DTL_TP_CD
                                ,DTL.CONTR_CLO_DAY
                                ,DTL.UPLFT_EFF_FROM_DT
                                ,IAU.UPLFT_PCY_DT
                                <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                                ,IAU.DS_CONTR_BASE_USG_NM
                                <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            FROM
                                 DS_CONTR               HDR
                                ,DS_CONTR_DTL           DTL
                                ,IV_ANE_ESCL_U          IAU
                                ,IV_DTL_STS_V_U         DTV
                            WHERE
                                    HDR.GLBL_CMPY_CD                =  #glblCmpyCd#
                                AND HDR.DS_CONTR_CATG_CD            =  #dsContrCatgReg#
                                AND HDR.EZCANCELFLAG                =  '0'
                                AND HDR.GLBL_CMPY_CD                =  DTL.GLBL_CMPY_CD
                                AND HDR.DS_CONTR_PK                 =  DTL.DS_CONTR_PK
                                AND DTL.EZCANCELFLAG                =  '0'
                                AND DTL.DS_CONTR_PK                 =  IAU.DS_CONTR_PK
                                AND DTL.DS_CONTR_DTL_PK             =  IAU.DS_CONTR_DTL_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT       &lt;= #slsDt#
                                    OR  DTL.UPLFT_EFF_FROM_DT       IS NULL
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                AND NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)
                                                                    &gt;= #slsDt#
                                <!-- mod end 2019/09/20 QC#53646 -->
                                AND IAU.DS_CONTR_MACH_LVL_NUM       =  #dsContrMachLvl2#
                                AND DTL.DS_CONTR_DTL_PK             =  DTV.DS_CONTR_DTL_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT IS NULL
                                    OR  MONTHS_BETWEEN(
                                         TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(IAU.UPLFT_BEF_END_RNW_DAYS_AOT, 1)
                                        ,TO_DATE(NVL(DTL.UPLFT_EFF_FROM_DT, IAU.UPLFT_PCY_DT), 'YYYYMMDD')
                                        ) / 12 >= 1
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        DS_CONTR_RNW_ESCL AEV3
                                    WHERE
                                        AEV3.DS_CONTR_PK             = DTL.DS_CONTR_PK
                                    AND AEV3.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                    AND AEV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                    AND AEV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmUsage#
                                    AND AEV3.EZCANCELFLAG            = '0'
                                    AND AEV3.UPLFT_PCY_DT            IS NOT NULL
                                    )
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        IV_DO_NOT_UPLIFT IDNP
                                    WHERE
                                        IDNP.DS_CONTR_PK           = DTL.DS_CONTR_PK
                                    AND IDNP.DS_CONTR_DTL_PK       = DTL.DS_CONTR_DTL_PK
                                    AND IDNP.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl3#
                                    AND IDNP.DS_CONTR_BASE_USG_NM  = #dsContrBaseUsgNmUsage#)
                            )
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
        --Regular Lv1/Base
            ,IV_REG_LV1_BASE AS (
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             DS_CONTR_PK
                            ,DS_CONTR_DTL_PK
                            ,SVC_MACH_MSTR_PK
                            ,LVL_NUM
                            <!-- mod start 2019/08/15 QC#52413 -->
                            <!-- ,CASE
                                WHEN UPLFT_EFF_FROM_DT IS NULL
                                    THEN UPLFT_PCY_DT
                                    ELSE TO_CHAR(ADD_MONTHS(TO_DATE(NVL(UPLFT_EFF_FROM_DT, UPLFT_PCY_DT), 'YYYYMMDD'), 12),  'YYYYMMDD')
                             END AS EFF_FROM_DT -->
                            ,UPLFT_PCY_DT AS EFF_FROM_DT
                            <!-- mod end 2019/08/15 QC#52413 -->
                            ,CONTR_UPLFT_TP_CD
                            <!-- add start 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_FROM_DT
                            <!-- add end 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_THRU_DT
                            ,DS_CONTR_NUM
                            ,DS_CONTR_CATG_CD
                            ,DS_CONTR_DTL_TP_CD
                            ,CONTR_CLO_DAY
                            <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            ,DS_CONTR_BASE_USG_NM
                            <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                        FROM
                            (
                        SELECT
                             DTL.DS_CONTR_PK                DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK            DS_CONTR_DTL_PK
                            ,DTL.SVC_MACH_MSTR_PK           SVC_MACH_MSTR_PK
                            ,#dsContrMachLvl1#                            LVL_NUM
                            ,IAB.CONTR_UPLFT_TP_CD          CONTR_UPLFT_TP_CD
                            <!-- add start 2019/08/15 QC#52413 -->
                            ,DTL.CONTR_EFF_FROM_DT          CONTR_EFF_FROM_DT
                            <!-- add end 2019/08/15 QC#52413 -->
                            <!-- mod start 2019/09/20 QC#53646 -->
                            ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                            <!-- mod end 2019/09/20 QC#53646 -->
                            ,HDR.DS_CONTR_NUM
                            ,HDR.DS_CONTR_CATG_CD
                            ,DTL.DS_CONTR_DTL_TP_CD
                            ,DTL.CONTR_CLO_DAY
                            ,DTL.UPLFT_EFF_FROM_DT
                            ,IAB.UPLFT_PCY_DT
                            <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            ,IAB.DS_CONTR_BASE_USG_NM
                            <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                        FROM
                             DS_CONTR               HDR
                            ,DS_CONTR_DTL           DTL
                            ,IV_ANE_ESCL_B          IAB
                            ,IV_DTL_STS_V_B         DTV
                        WHERE
                                HDR.GLBL_CMPY_CD                =  #glblCmpyCd#
                            AND HDR.DS_CONTR_CATG_CD            =  #dsContrCatgReg#
                            AND HDR.EZCANCELFLAG                =  '0'
                            AND HDR.GLBL_CMPY_CD                =  DTL.GLBL_CMPY_CD
                            AND HDR.DS_CONTR_PK                 =  DTL.DS_CONTR_PK
                            AND DTL.EZCANCELFLAG                =  '0'
                            AND DTL.DS_CONTR_PK                 =  IAB.DS_CONTR_PK
                            <!-- del start 2019/08/15 QC#52413 -->
                            <!-- AND (
                                    DTL.UPLFT_EFF_FROM_DT       &lt;= #slsDt#
                                OR  DTL.UPLFT_EFF_FROM_DT       IS NULL
                                ) -->
                            <!-- del end 2019/08/15 QC#52413 -->
                            <!-- mod start 2019/09/20 QC#53646 -->
                            AND NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)
                                                                &gt;= #slsDt#
                            <!-- mod end 2019/09/20 QC#53646 -->
                            AND IAB.DS_CONTR_MACH_LVL_NUM       =  #dsContrMachLvl1#
                            AND DTL.DS_CONTR_DTL_PK             = DTV.DS_CONTR_DTL_PK
                            <!-- del start 2019/08/15 QC#52413 -->
                            <!--    AND (
                                        DTL.UPLFT_EFF_FROM_DT IS NULL
                                    OR  MONTHS_BETWEEN(
                                         TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(IAB.UPLFT_BEF_END_RNW_DAYS_AOT, 1)
                                        ,TO_DATE(NVL(DTL.UPLFT_EFF_FROM_DT, IAB.UPLFT_PCY_DT), 'YYYYMMDD')
                                        ) / 12 >= 1
                                    ) -->
                            <!-- del end 2019/08/15 QC#52413 -->
                            AND NOT EXISTS(
                                SELECT
                                    *
                                FROM
                                    DS_CONTR_RNW_ESCL AEV3
                                WHERE
                                    AEV3.DS_CONTR_PK             = DTL.DS_CONTR_PK
                                AND AEV3.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                AND AEV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                AND AEV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmBase#
                                AND AEV3.EZCANCELFLAG            = '0'
                                AND AEV3.UPLFT_PCY_DT            IS NOT NULL
                                )
                            AND NOT EXISTS(
                                SELECT
                                    *
                                FROM
                                    DS_CONTR_RNW_ESCL AEV2
                                WHERE
                                    AEV2.DS_CONTR_PK             = DTL.DS_CONTR_PK
                                AND AEV2.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                AND AEV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                                AND AEV2.EZCANCELFLAG            = '0'
                                AND AEV2.UPLFT_PCY_DT            IS NOT NULL
                                )
                            AND NOT EXISTS(
                                SELECT
                                    *
                                FROM
                                    IV_DO_NOT_UPLIFT IDNP
                                WHERE
                                    IDNP.DS_CONTR_PK               = DTL.DS_CONTR_PK
                                AND IDNP.DS_CONTR_DTL_PK       = DTL.DS_CONTR_DTL_PK
                                AND IDNP.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl3#
                                AND IDNP.DS_CONTR_BASE_USG_NM  = #dsContrBaseUsgNmBase#
                                )
                            AND NOT EXISTS(
                                SELECT
                                    *
                                FROM
                                    IV_DO_NOT_UPLIFT IDNP
                                WHERE
                                    IDNP.DS_CONTR_PK           = DTL.DS_CONTR_PK
                                AND IDNP.DS_CONTR_DTL_PK       = DTL.DS_CONTR_DTL_PK
                                AND IDNP.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl2#
                                )
                        )
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
        --Regular Lv1/Usage
            ,IV_REG_LV1_USAGE AS (
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             DS_CONTR_PK
                            ,DS_CONTR_DTL_PK
                            ,SVC_MACH_MSTR_PK
                            ,LVL_NUM
                            <!-- mod start 2019/08/15 QC#52413 -->
                            <!-- ,CASE
                                WHEN UPLFT_EFF_FROM_DT IS NULL
                                    THEN UPLFT_PCY_DT
                                    ELSE TO_CHAR(ADD_MONTHS(TO_DATE(NVL(UPLFT_EFF_FROM_DT, UPLFT_PCY_DT), 'YYYYMMDD'), 12),  'YYYYMMDD')
                             END AS EFF_FROM_DT -->
                            ,UPLFT_PCY_DT AS EFF_FROM_DT
                            <!-- mod end 2019/08/15 QC#52413 -->
                            ,CONTR_UPLFT_TP_CD
                            <!-- add start 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_FROM_DT
                            <!-- add end 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_THRU_DT
                            ,DS_CONTR_NUM
                            ,DS_CONTR_CATG_CD
                            ,DS_CONTR_DTL_TP_CD
                            ,CONTR_CLO_DAY
                            <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            ,DS_CONTR_BASE_USG_NM
                            <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                        FROM (
                            SELECT
                                 DTL.DS_CONTR_PK                DS_CONTR_PK
                                ,DTL.DS_CONTR_DTL_PK            DS_CONTR_DTL_PK
                                ,DTL.SVC_MACH_MSTR_PK           SVC_MACH_MSTR_PK
                                ,#dsContrMachLvl1#                            LVL_NUM
                                ,IAU.CONTR_UPLFT_TP_CD          CONTR_UPLFT_TP_CD
                                <!-- add start 2019/08/15 QC#52413 -->
                                ,DTL.CONTR_EFF_FROM_DT          CONTR_EFF_FROM_DT
                                <!-- add end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                                <!-- mod end 2019/09/20 QC#53646 -->
                                ,HDR.DS_CONTR_NUM
                                ,HDR.DS_CONTR_CATG_CD
                                ,DTL.DS_CONTR_DTL_TP_CD
                                ,DTL.CONTR_CLO_DAY
                                ,DTL.UPLFT_EFF_FROM_DT
                                ,IAU.UPLFT_PCY_DT
                                <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                                ,IAU.DS_CONTR_BASE_USG_NM
                                <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            FROM
                                 DS_CONTR               HDR
                                ,DS_CONTR_DTL           DTL
                                ,IV_ANE_ESCL_U          IAU
                                ,IV_DTL_STS_V_U         DTV
                            WHERE
                                    HDR.GLBL_CMPY_CD                =  #glblCmpyCd#
                                AND HDR.DS_CONTR_CATG_CD            =  #dsContrCatgReg#
                                AND HDR.EZCANCELFLAG                =  '0'
                                AND HDR.GLBL_CMPY_CD                =  DTL.GLBL_CMPY_CD
                                AND HDR.DS_CONTR_PK                 =  DTL.DS_CONTR_PK
                                AND DTL.EZCANCELFLAG                =  '0'
                                AND DTL.DS_CONTR_PK                 =  IAU.DS_CONTR_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT       &lt;= #slsDt#
                                    OR  DTL.UPLFT_EFF_FROM_DT       IS NULL
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                AND NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)
                                                                    &gt;= #slsDt#
                                <!-- mod end 2019/09/20 QC#53646 -->
                                AND IAU.DS_CONTR_MACH_LVL_NUM       = #dsContrMachLvl1#
                                AND DTL.DS_CONTR_DTL_PK             = DTV.DS_CONTR_DTL_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT IS NULL
                                    OR  MONTHS_BETWEEN(
                                         TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(IAU.UPLFT_BEF_END_RNW_DAYS_AOT, 1)
                                        ,TO_DATE(NVL(DTL.UPLFT_EFF_FROM_DT, IAU.UPLFT_PCY_DT), 'YYYYMMDD')
                                        ) / 12 >= 1
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        DS_CONTR_RNW_ESCL AEV3
                                    WHERE
                                        AEV3.DS_CONTR_PK             =  DTL.DS_CONTR_PK
                                    AND AEV3.DS_CONTR_DTL_PK         =  DTL.DS_CONTR_DTL_PK
                                    AND AEV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                    AND AEV3.DS_CONTR_BASE_USG_NM    =  #dsContrBaseUsgNmUsage#
                                    AND AEV3.EZCANCELFLAG            = '0'
                                    AND AEV3.UPLFT_PCY_DT            IS NOT NULL
                                    )
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        DS_CONTR_RNW_ESCL AEV2
                                    WHERE
                                        AEV2.DS_CONTR_PK             =  DTL.DS_CONTR_PK
                                    AND AEV2.DS_CONTR_DTL_PK         =  DTL.DS_CONTR_DTL_PK
                                    AND AEV2.DS_CONTR_MACH_LVL_NUM   =  #dsContrMachLvl2#
                                    AND AEV2.EZCANCELFLAG            = '0'
                                    AND AEV2.UPLFT_PCY_DT            IS NOT NULL
                                    )
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        IV_DO_NOT_UPLIFT IDNP
                                    WHERE
                                        IDNP.DS_CONTR_PK           = DTL.DS_CONTR_PK
                                    AND IDNP.DS_CONTR_DTL_PK       = DTL.DS_CONTR_DTL_PK
                                    AND IDNP.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl3#
                                    AND IDNP.DS_CONTR_BASE_USG_NM  = #dsContrBaseUsgNmUsage#
                                    )
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        IV_DO_NOT_UPLIFT IDNP
                                    WHERE
                                        IDNP.DS_CONTR_PK           = DTL.DS_CONTR_PK
                                    AND IDNP.DS_CONTR_DTL_PK       = DTL.DS_CONTR_DTL_PK
                                    AND IDNP.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl2#
                                    )
                            )
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
        --Fleet Lv3/Base
            ,IV_FLT_LV3_BASE AS (
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             DS_CONTR_PK
                            ,DS_CONTR_DTL_PK
                            ,SVC_MACH_MSTR_PK
                            ,LVL_NUM
                            <!-- mod start 2019/08/15 QC#52413 -->
                            <!-- ,CASE
                                WHEN UPLFT_EFF_FROM_DT IS NULL
                                    THEN UPLFT_PCY_DT
                                    ELSE TO_CHAR(ADD_MONTHS(TO_DATE(NVL(UPLFT_EFF_FROM_DT, UPLFT_PCY_DT), 'YYYYMMDD'), 12),  'YYYYMMDD')
                             END AS EFF_FROM_DT -->
                            ,UPLFT_PCY_DT AS EFF_FROM_DT
                            <!-- mod end 2019/08/15 QC#52413 -->
                            ,CONTR_UPLFT_TP_CD
                            <!-- add start 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_FROM_DT
                            <!-- add end 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_THRU_DT
                            ,DS_CONTR_NUM
                            ,DS_CONTR_CATG_CD
                            ,DS_CONTR_DTL_TP_CD
                            ,CONTR_CLO_DAY
                            <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            ,DS_CONTR_BASE_USG_NM
                            <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                        FROM
                            (
                            SELECT
                                 DTL.DS_CONTR_PK                DS_CONTR_PK
                                ,DTL.DS_CONTR_DTL_PK            DS_CONTR_DTL_PK
                                ,DTL.SVC_MACH_MSTR_PK           SVC_MACH_MSTR_PK
                                ,#dsContrMachLvl3#                            LVL_NUM
                                ,IAB.CONTR_UPLFT_TP_CD          CONTR_UPLFT_TP_CD
                                <!-- add start 2019/08/15 QC#52413 -->
                                ,DTL.CONTR_EFF_FROM_DT          CONTR_EFF_FROM_DT
                                <!-- add end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                                <!-- mod end 2019/09/20 QC#53646 -->
                                ,HDR.DS_CONTR_NUM
                                ,HDR.DS_CONTR_CATG_CD
                                ,DTL.DS_CONTR_DTL_TP_CD
                                ,DTL.CONTR_CLO_DAY
                                ,DTL.UPLFT_EFF_FROM_DT
                                ,IAB.UPLFT_PCY_DT
                                <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                                ,IAB.DS_CONTR_BASE_USG_NM
                                <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            FROM
                                 DS_CONTR               HDR
                                ,DS_CONTR_DTL           DTL
                                ,IV_ANE_ESCL_B          IAB
                                ,IV_DTL_STS_V_B         DTV
                            WHERE
                                    HDR.GLBL_CMPY_CD                =  #glblCmpyCd#
                                AND HDR.DS_CONTR_CATG_CD            =  #dsContrCatgFlt#
                                AND HDR.EZCANCELFLAG                =  '0'
                                AND HDR.GLBL_CMPY_CD                =  DTL.GLBL_CMPY_CD
                                AND HDR.DS_CONTR_PK                 =  DTL.DS_CONTR_PK
                                AND DTL.EZCANCELFLAG                =  '0'
                                AND DTL.DS_CONTR_PK                 =  IAB.DS_CONTR_PK
                                AND DTL.DS_CONTR_DTL_PK             =  IAB.DS_CONTR_DTL_PK
                                AND DTL.DS_CONTR_DTL_TP_CD          =  #dsContrDtlTpCdFlt#
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT       &lt;= #slsDt#
                                    OR  DTL.UPLFT_EFF_FROM_DT       IS NULL
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                AND NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)
                                                                    &gt;= #slsDt#
                                <!-- mod end 2019/09/20 QC#53646 -->
                                AND IAB.DS_CONTR_MACH_LVL_NUM       =  #dsContrMachLvl3#
                                AND IAB.DS_CONTR_BASE_USG_NM        =  #dsContrBaseUsgNmBase#
                                AND DTL.DS_CONTR_DTL_PK             =  DTV.DS_CONTR_DTL_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT IS NULL
                                    OR  MONTHS_BETWEEN(
                                         TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(IAB.UPLFT_BEF_END_RNW_DAYS_AOT, 1)
                                        ,TO_DATE(NVL(DTL.UPLFT_EFF_FROM_DT, IAB.UPLFT_PCY_DT), 'YYYYMMDD')
                                        ) / 12 >= 1
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                            )
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
        --Fleet Lv3/Usage
            ,IV_FLT_LV3_USAGE AS (
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             DS_CONTR_PK
                            ,DS_CONTR_DTL_PK
                            ,SVC_MACH_MSTR_PK
                            ,LVL_NUM
                            <!-- mod start 2019/08/15 QC#52413 -->
                            <!-- ,CASE
                                WHEN UPLFT_EFF_FROM_DT IS NULL
                                    THEN UPLFT_PCY_DT
                                    ELSE TO_CHAR(ADD_MONTHS(TO_DATE(NVL(UPLFT_EFF_FROM_DT, UPLFT_PCY_DT), 'YYYYMMDD'), 12),  'YYYYMMDD')
                             END AS EFF_FROM_DT -->
                            ,UPLFT_PCY_DT AS EFF_FROM_DT
                            <!-- mod end 2019/08/15 QC#52413 -->
                            ,CONTR_UPLFT_TP_CD
                            <!-- add start 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_FROM_DT
                            <!-- add end 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_THRU_DT
                            ,DS_CONTR_NUM
                            ,DS_CONTR_CATG_CD
                            ,DS_CONTR_DTL_TP_CD
                            ,CONTR_CLO_DAY
                            <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            ,DS_CONTR_BASE_USG_NM
                            <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                        FROM
                            (
                            SELECT
                                 DTL.DS_CONTR_PK                DS_CONTR_PK
                                ,DTL.DS_CONTR_DTL_PK            DS_CONTR_DTL_PK
                                ,DTL.SVC_MACH_MSTR_PK           SVC_MACH_MSTR_PK
                                ,#dsContrMachLvl3#                            LVL_NUM
                                ,IAU.CONTR_UPLFT_TP_CD          CONTR_UPLFT_TP_CD
                                <!-- add start 2019/08/15 QC#52413 -->
                                ,DTL.CONTR_EFF_FROM_DT          CONTR_EFF_FROM_DT
                                <!-- add end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                                <!-- mod end 2019/09/20 QC#53646 -->
                                ,HDR.DS_CONTR_NUM
                                ,HDR.DS_CONTR_CATG_CD
                                ,DTL.DS_CONTR_DTL_TP_CD
                                ,DTL.CONTR_CLO_DAY
                                ,DTL.UPLFT_EFF_FROM_DT
                                ,IAU.UPLFT_PCY_DT
                                <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                                ,IAU.DS_CONTR_BASE_USG_NM
                                <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            FROM
                                 DS_CONTR               HDR
                                ,DS_CONTR_DTL           DTL
                                ,IV_ANE_ESCL_U          IAU
                                ,IV_DTL_STS_V_U         DTV
                            WHERE
                                    HDR.GLBL_CMPY_CD                =  #glblCmpyCd#
                                AND HDR.DS_CONTR_CATG_CD            =  #dsContrCatgFlt#
                                AND HDR.EZCANCELFLAG                =  '0'
                                AND HDR.GLBL_CMPY_CD                =  DTL.GLBL_CMPY_CD
                                AND HDR.DS_CONTR_PK                 =  DTL.DS_CONTR_PK
                                AND DTL.EZCANCELFLAG                =  '0'
                                AND DTL.DS_CONTR_PK                 =  IAU.DS_CONTR_PK
                                AND DTL.DS_CONTR_DTL_PK             =  IAU.DS_CONTR_DTL_PK
                                AND DTL.DS_CONTR_DTL_TP_CD          =  #dsContrDtlTpCdFlt#
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT       &lt;= #slsDt#
                                    OR  DTL.UPLFT_EFF_FROM_DT       IS NULL
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                AND NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)
                                                                    &gt;= #slsDt#
                                <!-- mod end 2019/09/20 QC#53646 -->
                                AND IAU.DS_CONTR_MACH_LVL_NUM       =  #dsContrMachLvl3#
                                AND IAU.DS_CONTR_BASE_USG_NM        =  #dsContrBaseUsgNmUsage#
                                AND DTL.DS_CONTR_DTL_PK             =  DTV.DS_CONTR_DTL_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT IS NULL
                                    OR  MONTHS_BETWEEN(
                                         TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(IAU.UPLFT_BEF_END_RNW_DAYS_AOT, 1)
                                        ,TO_DATE(NVL(DTL.UPLFT_EFF_FROM_DT, IAU.UPLFT_PCY_DT), 'YYYYMMDD')
                                        ) / 12 >= 1
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                            )
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
        --Fleet Lv2/Base
            ,IV_FLT_LV2_BASE AS (
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             DS_CONTR_PK
                            ,DS_CONTR_DTL_PK
                            ,SVC_MACH_MSTR_PK
                            ,LVL_NUM
                            <!-- mod start 2019/08/15 QC#52413 -->
                            <!-- ,CASE
                                WHEN UPLFT_EFF_FROM_DT IS NULL
                                    THEN UPLFT_PCY_DT
                                    ELSE TO_CHAR(ADD_MONTHS(TO_DATE(NVL(UPLFT_EFF_FROM_DT, UPLFT_PCY_DT), 'YYYYMMDD'), 12),  'YYYYMMDD')
                             END AS EFF_FROM_DT -->
                            ,UPLFT_PCY_DT AS EFF_FROM_DT
                            <!-- mod end 2019/08/15 QC#52413 -->
                            ,CONTR_UPLFT_TP_CD
                            <!-- add start 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_FROM_DT
                            <!-- add end 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_THRU_DT
                            ,DS_CONTR_NUM
                            ,DS_CONTR_CATG_CD
                            ,DS_CONTR_DTL_TP_CD
                            ,CONTR_CLO_DAY
                            <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            ,DS_CONTR_BASE_USG_NM
                            <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                        FROM
                            (
                            SELECT
                                 DTL.DS_CONTR_PK                DS_CONTR_PK
                                ,DTL.DS_CONTR_DTL_PK            DS_CONTR_DTL_PK
                                ,DTL.SVC_MACH_MSTR_PK           SVC_MACH_MSTR_PK
                                ,#dsContrMachLvl2#              LVL_NUM
                                ,IAB.CONTR_UPLFT_TP_CD          CONTR_UPLFT_TP_CD
                                <!-- add start 2019/08/15 QC#52413 -->
                                ,DTL.CONTR_EFF_FROM_DT          CONTR_EFF_FROM_DT
                                <!-- add end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                                <!-- mod end 2019/09/20 QC#53646 -->
                                ,HDR.DS_CONTR_NUM
                                ,HDR.DS_CONTR_CATG_CD
                                ,DTL.DS_CONTR_DTL_TP_CD
                                ,DTL.CONTR_CLO_DAY
                                ,DTL.UPLFT_EFF_FROM_DT
                                ,IAB.UPLFT_PCY_DT
                                <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                                ,IAB.DS_CONTR_BASE_USG_NM
                                <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            FROM
                                 DS_CONTR               HDR
                                ,DS_CONTR_DTL           DTL
                                ,IV_ANE_ESCL_B          IAB
                                ,IV_DTL_STS_V_B         DTV
                            WHERE
                                    HDR.GLBL_CMPY_CD                =  #glblCmpyCd#
                                AND HDR.DS_CONTR_CATG_CD            =  #dsContrCatgFlt#
                                AND HDR.EZCANCELFLAG                =  '0'
                                AND HDR.GLBL_CMPY_CD                =  DTL.GLBL_CMPY_CD
                                AND HDR.DS_CONTR_PK                 =  DTL.DS_CONTR_PK
                                AND DTL.EZCANCELFLAG                =  '0'
                                AND DTL.DS_CONTR_PK                 =  IAB.DS_CONTR_PK
                                AND DTL.DS_CONTR_DTL_PK             =  IAB.DS_CONTR_DTL_PK
                                AND DTL.DS_CONTR_DTL_TP_CD          =  #dsContrDtlTpCdFlt#
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT       &lt;= #slsDt#
                                    OR  DTL.UPLFT_EFF_FROM_DT       IS NULL
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                AND NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)
                                                                    &gt;= #slsDt#
                                <!-- mod end 2019/09/20 QC#53646 -->
                                AND IAB.DS_CONTR_MACH_LVL_NUM       =  #dsContrMachLvl2#
                                AND DTL.DS_CONTR_DTL_PK             =  DTV.DS_CONTR_DTL_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT IS NULL
                                    OR  MONTHS_BETWEEN(
                                         TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(IAB.UPLFT_BEF_END_RNW_DAYS_AOT, 1)
                                        ,TO_DATE(NVL(DTL.UPLFT_EFF_FROM_DT, IAB.UPLFT_PCY_DT), 'YYYYMMDD')
                                        ) / 12 >= 1
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        DS_CONTR_RNW_ESCL AEV3
                                    WHERE
                                        AEV3.DS_CONTR_PK             = DTL.DS_CONTR_PK
                                    AND AEV3.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                    AND AEV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                    AND AEV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmBase#
                                    AND AEV3.EZCANCELFLAG            = '0'
                                    AND AEV3.UPLFT_PCY_DT            IS NOT NULL
                                    )
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        IV_DO_NOT_UPLIFT IDNP
                                    WHERE
                                        IDNP.DS_CONTR_PK               = DTL.DS_CONTR_PK
                                    AND IDNP.DS_CONTR_DTL_PK       = DTL.DS_CONTR_DTL_PK
                                    AND IDNP.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl3#
                                    AND IDNP.DS_CONTR_BASE_USG_NM  = #dsContrBaseUsgNmBase#
                                    )
                            )
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
        --Fleet Lv2/Usage
            ,IV_FLT_LV2_USAGE AS (
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             DS_CONTR_PK
                            ,DS_CONTR_DTL_PK
                            ,SVC_MACH_MSTR_PK
                            ,LVL_NUM
                            <!-- mod start 2019/08/15 QC#52413 -->
                            <!-- ,CASE
                                WHEN UPLFT_EFF_FROM_DT IS NULL
                                    THEN UPLFT_PCY_DT
                                    ELSE TO_CHAR(ADD_MONTHS(TO_DATE(NVL(UPLFT_EFF_FROM_DT, UPLFT_PCY_DT), 'YYYYMMDD'), 12),  'YYYYMMDD')
                             END AS EFF_FROM_DT -->
                            ,UPLFT_PCY_DT AS EFF_FROM_DT
                            <!-- mod end 2019/08/15 QC#52413 -->
                            ,CONTR_UPLFT_TP_CD
                            <!-- add start 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_FROM_DT
                            <!-- add end 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_THRU_DT
                            ,DS_CONTR_NUM
                            ,DS_CONTR_CATG_CD
                            ,DS_CONTR_DTL_TP_CD
                            ,CONTR_CLO_DAY
                            <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            ,DS_CONTR_BASE_USG_NM
                            <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                        FROM
                            (
                            SELECT
                                 DTL.DS_CONTR_PK                DS_CONTR_PK
                                ,DTL.DS_CONTR_DTL_PK            DS_CONTR_DTL_PK
                                ,DTL.SVC_MACH_MSTR_PK           SVC_MACH_MSTR_PK
                                ,#dsContrMachLvl2#                            LVL_NUM
                                ,IAU.CONTR_UPLFT_TP_CD          CONTR_UPLFT_TP_CD
                                <!-- add start 2019/08/15 QC#52413 -->
                                ,DTL.CONTR_EFF_FROM_DT          CONTR_EFF_FROM_DT
                                <!-- add end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                                <!-- mod end 2019/09/20 QC#53646 -->
                                ,HDR.DS_CONTR_NUM
                                ,HDR.DS_CONTR_CATG_CD
                                ,DTL.DS_CONTR_DTL_TP_CD
                                ,DTL.CONTR_CLO_DAY
                                ,DTL.UPLFT_EFF_FROM_DT
                                ,IAU.UPLFT_PCY_DT
                                <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                                ,IAU.DS_CONTR_BASE_USG_NM
                                <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            FROM
                                 DS_CONTR               HDR
                                ,DS_CONTR_DTL           DTL
                                ,IV_ANE_ESCL_U          IAU
                                ,IV_DTL_STS_V_U         DTV
                            WHERE
                                    HDR.GLBL_CMPY_CD                =  #glblCmpyCd#
                                AND HDR.DS_CONTR_CATG_CD            =  #dsContrCatgFlt#
                                AND HDR.EZCANCELFLAG                =  '0'
                                AND HDR.GLBL_CMPY_CD                =  DTL.GLBL_CMPY_CD
                                AND HDR.DS_CONTR_PK                 =  DTL.DS_CONTR_PK
                                AND DTL.EZCANCELFLAG                =  '0'
                                AND DTL.DS_CONTR_PK                 =  IAU.DS_CONTR_PK
                                AND DTL.DS_CONTR_DTL_PK             =  IAU.DS_CONTR_DTL_PK
                                AND DTL.DS_CONTR_DTL_TP_CD          =  #dsContrDtlTpCdFlt#
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT       &lt;= #slsDt#
                                    OR  DTL.UPLFT_EFF_FROM_DT       IS NULL
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                AND NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)
                                                                    &gt;= #slsDt#
                                <!-- mod end 2019/09/20 QC#53646 -->
                                AND IAU.DS_CONTR_MACH_LVL_NUM       =  #dsContrMachLvl2#
                                AND DTL.DS_CONTR_DTL_PK             =  DTV.DS_CONTR_DTL_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT IS NULL
                                    OR  MONTHS_BETWEEN(
                                         TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(IAU.UPLFT_BEF_END_RNW_DAYS_AOT, 1)
                                        ,TO_DATE(NVL(DTL.UPLFT_EFF_FROM_DT, IAU.UPLFT_PCY_DT), 'YYYYMMDD')
                                        ) / 12 >= 1
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        DS_CONTR_RNW_ESCL AEV3
                                    WHERE
                                        AEV3.DS_CONTR_PK             = DTL.DS_CONTR_PK
                                    AND AEV3.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                    AND AEV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                    AND AEV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmUsage#
                                    AND AEV3.EZCANCELFLAG            = '0'
                                    AND AEV3.UPLFT_PCY_DT            IS NOT NULL
                                    )
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        IV_DO_NOT_UPLIFT IDNP
                                    WHERE
                                        IDNP.DS_CONTR_PK           = DTL.DS_CONTR_PK
                                    AND IDNP.DS_CONTR_DTL_PK       = DTL.DS_CONTR_DTL_PK
                                    AND IDNP.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl3#
                                    AND IDNP.DS_CONTR_BASE_USG_NM  = #dsContrBaseUsgNmUsage#
                                    )
                            )
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
        --Fleet Lv1/Base
            ,IV_FLT_LV1_BASE AS (
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             DS_CONTR_PK
                            ,DS_CONTR_DTL_PK
                            ,SVC_MACH_MSTR_PK
                            ,LVL_NUM
                            <!-- mod start 2019/08/15 QC#52413 -->
                            <!-- ,CASE
                                WHEN UPLFT_EFF_FROM_DT IS NULL
                                    THEN UPLFT_PCY_DT
                                    ELSE TO_CHAR(ADD_MONTHS(TO_DATE(NVL(UPLFT_EFF_FROM_DT, UPLFT_PCY_DT), 'YYYYMMDD'), 12),  'YYYYMMDD')
                             END AS EFF_FROM_DT -->
                            ,UPLFT_PCY_DT AS EFF_FROM_DT
                            <!-- mod end 2019/08/15 QC#52413 -->
                            ,CONTR_UPLFT_TP_CD
                            <!-- add start 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_FROM_DT
                            <!-- add end 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_THRU_DT
                            ,DS_CONTR_NUM
                            ,DS_CONTR_CATG_CD
                            ,DS_CONTR_DTL_TP_CD
                            ,CONTR_CLO_DAY
                            <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            ,DS_CONTR_BASE_USG_NM
                            <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                        FROM
                            (
                            SELECT
                                 DTL.DS_CONTR_PK                DS_CONTR_PK
                                ,DTL.DS_CONTR_DTL_PK            DS_CONTR_DTL_PK
                                ,DTL.SVC_MACH_MSTR_PK           SVC_MACH_MSTR_PK
                                ,#dsContrMachLvl1#                            LVL_NUM
                                ,IAB.CONTR_UPLFT_TP_CD          CONTR_UPLFT_TP_CD
                                <!-- add start 2019/08/15 QC#52413 -->
                                ,DTL.CONTR_EFF_FROM_DT          CONTR_EFF_FROM_DT
                                <!-- add end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                                <!-- mod end 2019/09/20 QC#53646 -->
                                ,HDR.DS_CONTR_NUM
                                ,HDR.DS_CONTR_CATG_CD
                                ,DTL.DS_CONTR_DTL_TP_CD
                                ,DTL.CONTR_CLO_DAY
                                ,DTL.UPLFT_EFF_FROM_DT
                                ,IAB.UPLFT_PCY_DT
                                <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                                ,IAB.DS_CONTR_BASE_USG_NM
                                <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            FROM
                                 DS_CONTR               HDR
                                ,DS_CONTR_DTL           DTL
                                ,IV_ANE_ESCL_B          IAB
                                ,IV_DTL_STS_V_B         DTV
                            WHERE
                                    HDR.GLBL_CMPY_CD                =  #glblCmpyCd#
                                AND HDR.DS_CONTR_CATG_CD            =  #dsContrCatgFlt#
                                AND HDR.EZCANCELFLAG                =  '0'
                                AND HDR.GLBL_CMPY_CD                =  DTL.GLBL_CMPY_CD
                                AND HDR.DS_CONTR_PK                 =  DTL.DS_CONTR_PK
                                AND DTL.EZCANCELFLAG                =  '0'
                                AND DTL.DS_CONTR_PK                 =  IAB.DS_CONTR_PK
                                AND DTL.DS_CONTR_DTL_TP_CD          =  #dsContrDtlTpCdFlt#
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT       &lt;= #slsDt#
                                    OR  DTL.UPLFT_EFF_FROM_DT       IS NULL
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                AND NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)
                                                                    &gt;= #slsDt#
                                <!-- mod end 2019/09/20 QC#53646 -->
                                AND IAB.DS_CONTR_MACH_LVL_NUM       =  #dsContrMachLvl1#
                                AND DTL.DS_CONTR_DTL_PK             =  DTV.DS_CONTR_DTL_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT IS NULL
                                    OR  MONTHS_BETWEEN(
                                         TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(IAB.UPLFT_BEF_END_RNW_DAYS_AOT, 1)
                                        ,TO_DATE(NVL(DTL.UPLFT_EFF_FROM_DT, IAB.UPLFT_PCY_DT), 'YYYYMMDD')
                                        ) / 12 >= 1
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        DS_CONTR_RNW_ESCL AEV3
                                    WHERE
                                            AEV3.DS_CONTR_PK             = DTL.DS_CONTR_PK
                                        AND AEV3.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                        AND AEV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                        AND AEV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmBase#
                                        AND AEV3.EZCANCELFLAG            = '0'
                                        AND AEV3.UPLFT_PCY_DT            IS NOT NULL
                                    )
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        DS_CONTR_RNW_ESCL AEV2
                                    WHERE
                                            AEV2.DS_CONTR_PK             = DTL.DS_CONTR_PK
                                        AND AEV2.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                        AND AEV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                                        AND AEV2.EZCANCELFLAG            = '0'
                                        AND AEV2.UPLFT_PCY_DT            IS NOT NULL
                                    )
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        IV_DO_NOT_UPLIFT IDNP
                                    WHERE
                                        IDNP.DS_CONTR_PK           = DTL.DS_CONTR_PK
                                    AND IDNP.DS_CONTR_DTL_PK       = DTL.DS_CONTR_DTL_PK
                                    AND IDNP.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl3#
                                    AND IDNP.DS_CONTR_BASE_USG_NM  = #dsContrBaseUsgNmBase#
                                    )
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        IV_DO_NOT_UPLIFT IDNP
                                    WHERE
                                        IDNP.DS_CONTR_PK           = DTL.DS_CONTR_PK
                                    AND IDNP.DS_CONTR_DTL_PK       = DTL.DS_CONTR_DTL_PK
                                    AND IDNP.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl2#
                                )
                            )
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
        --Fleet Lv1/Usage
            ,IV_FLT_LV1_USAGE AS (
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             DS_CONTR_PK
                            ,DS_CONTR_DTL_PK
                            ,SVC_MACH_MSTR_PK
                            ,LVL_NUM
                            <!-- mod start 2019/08/15 QC#52413 -->
                            <!-- ,CASE
                                WHEN UPLFT_EFF_FROM_DT IS NULL
                                    THEN UPLFT_PCY_DT
                                    ELSE TO_CHAR(ADD_MONTHS(TO_DATE(NVL(UPLFT_EFF_FROM_DT, UPLFT_PCY_DT), 'YYYYMMDD'), 12),  'YYYYMMDD')
                             END AS EFF_FROM_DT -->
                            ,UPLFT_PCY_DT AS EFF_FROM_DT
                            <!-- mod end 2019/08/15 QC#52413 -->
                            ,CONTR_UPLFT_TP_CD
                            <!-- add start 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_FROM_DT
                            <!-- add end 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_THRU_DT
                            ,DS_CONTR_NUM
                            ,DS_CONTR_CATG_CD
                            ,DS_CONTR_DTL_TP_CD
                            ,CONTR_CLO_DAY
                            <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            ,DS_CONTR_BASE_USG_NM
                            <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                        FROM
                            (
                            SELECT
                                 DTL.DS_CONTR_PK                DS_CONTR_PK
                                ,DTL.DS_CONTR_DTL_PK            DS_CONTR_DTL_PK
                                ,DTL.SVC_MACH_MSTR_PK           SVC_MACH_MSTR_PK
                                ,#dsContrMachLvl1#                            LVL_NUM
                                ,IAU.CONTR_UPLFT_TP_CD          CONTR_UPLFT_TP_CD
                                <!-- add start 2019/08/15 QC#52413 -->
                                ,DTL.CONTR_EFF_FROM_DT          CONTR_EFF_FROM_DT
                                <!-- add end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                                <!-- mod end 2019/09/20 QC#53646 -->
                                ,HDR.DS_CONTR_NUM
                                ,HDR.DS_CONTR_CATG_CD
                                ,DTL.DS_CONTR_DTL_TP_CD
                                ,DTL.CONTR_CLO_DAY
                                ,DTL.UPLFT_EFF_FROM_DT
                                ,IAU.UPLFT_PCY_DT
                                <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                                ,IAU.DS_CONTR_BASE_USG_NM
                                <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            FROM
                                 DS_CONTR               HDR
                                ,DS_CONTR_DTL           DTL
                                ,IV_ANE_ESCL_U          IAU
                                ,IV_DTL_STS_V_U         DTV
                            WHERE
                                    HDR.GLBL_CMPY_CD                =  #glblCmpyCd#
                                AND HDR.DS_CONTR_CATG_CD            =  #dsContrCatgFlt#
                                AND HDR.EZCANCELFLAG                =  '0'
                                AND HDR.GLBL_CMPY_CD                =  DTL.GLBL_CMPY_CD
                                AND HDR.DS_CONTR_PK                 =  DTL.DS_CONTR_PK
                                AND DTL.EZCANCELFLAG                =  '0'
                                AND DTL.DS_CONTR_PK                 =  IAU.DS_CONTR_PK
                                AND DTL.DS_CONTR_DTL_TP_CD          =  #dsContrDtlTpCdFlt#
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT       &lt;= #slsDt#
                                    OR  DTL.UPLFT_EFF_FROM_DT       IS NULL) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                AND NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)
                                                                    &gt;= #slsDt#
                                <!-- mod end 2019/09/20 QC#53646 -->
                                AND IAU.DS_CONTR_MACH_LVL_NUM       =  #dsContrMachLvl1#
                                AND DTL.DS_CONTR_DTL_PK             =  DTV.DS_CONTR_DTL_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT IS NULL
                                    OR  MONTHS_BETWEEN(
                                         TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(IAU.UPLFT_BEF_END_RNW_DAYS_AOT, 1)
                                        ,TO_DATE(NVL(DTL.UPLFT_EFF_FROM_DT, IAU.UPLFT_PCY_DT), 'YYYYMMDD')
                                        ) / 12 >= 1
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        DS_CONTR_RNW_ESCL AEV3
                                    WHERE
                                        AEV3.DS_CONTR_PK             = DTL.DS_CONTR_PK
                                    AND AEV3.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                    AND AEV3.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl3#
                                    AND AEV3.DS_CONTR_BASE_USG_NM    = #dsContrBaseUsgNmUsage#
                                    AND AEV3.EZCANCELFLAG            = '0'
                                    AND AEV3.UPLFT_PCY_DT            IS NOT NULL
                                    )
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        DS_CONTR_RNW_ESCL AEV2
                                    WHERE
                                        AEV2.DS_CONTR_PK             = DTL.DS_CONTR_PK
                                    AND AEV2.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                    AND AEV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                                    AND AEV2.EZCANCELFLAG            = '0'
                                    AND AEV2.UPLFT_PCY_DT            IS NOT NULL
                                    )
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        IV_DO_NOT_UPLIFT IDNP
                                    WHERE
                                        IDNP.DS_CONTR_PK               = DTL.DS_CONTR_PK
                                    AND IDNP.DS_CONTR_DTL_PK       = DTL.DS_CONTR_DTL_PK
                                    AND IDNP.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl3#
                                    AND IDNP.DS_CONTR_BASE_USG_NM  = #dsContrBaseUsgNmUsage#
                                    )
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        IV_DO_NOT_UPLIFT IDNP
                                    WHERE
                                        IDNP.DS_CONTR_PK               = DTL.DS_CONTR_PK
                                    AND IDNP.DS_CONTR_DTL_PK       = DTL.DS_CONTR_DTL_PK
                                    AND IDNP.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl2#
                                    )
                            )
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
      --Aggregate Lv2/Base
            ,IV_AGG_LV2_BASE AS (
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             DS_CONTR_PK
                            ,DS_CONTR_DTL_PK
                            ,SVC_MACH_MSTR_PK
                            ,LVL_NUM
                            <!-- mod start 2019/08/15 QC#52413 -->
                            <!-- ,CASE
                                WHEN UPLFT_EFF_FROM_DT IS NULL
                                    THEN UPLFT_PCY_DT
                                    ELSE TO_CHAR(ADD_MONTHS(TO_DATE(NVL(UPLFT_EFF_FROM_DT, UPLFT_PCY_DT), 'YYYYMMDD'), 12),  'YYYYMMDD')
                             END AS EFF_FROM_DT -->
                            ,UPLFT_PCY_DT AS EFF_FROM_DT
                            <!-- mod end 2019/08/15 QC#52413 -->
                            ,CONTR_UPLFT_TP_CD
                            <!-- add start 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_FROM_DT
                            <!-- add end 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_THRU_DT
                            ,DS_CONTR_NUM
                            ,DS_CONTR_CATG_CD
                            ,DS_CONTR_DTL_TP_CD
                            ,CONTR_CLO_DAY
                            <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            ,DS_CONTR_BASE_USG_NM
                            <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                        FROM
                            (
                            SELECT
                                 DTL.DS_CONTR_PK                DS_CONTR_PK
                                ,DTL.DS_CONTR_DTL_PK            DS_CONTR_DTL_PK
                                ,DTL.SVC_MACH_MSTR_PK           SVC_MACH_MSTR_PK
                                ,#dsContrMachLvl2#                            LVL_NUM
                                ,IAB.CONTR_UPLFT_TP_CD          CONTR_UPLFT_TP_CD
                                <!-- add start 2019/08/15 QC#52413 -->
                                ,DTL.CONTR_EFF_FROM_DT          CONTR_EFF_FROM_DT
                                <!-- add end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                                <!-- mod end 2019/09/20 QC#53646 -->
                                ,HDR.DS_CONTR_NUM
                                ,HDR.DS_CONTR_CATG_CD
                                ,DTL.DS_CONTR_DTL_TP_CD
                                ,DTL.CONTR_CLO_DAY
                                ,DTL.UPLFT_EFF_FROM_DT
                                ,IAB.UPLFT_PCY_DT
                                <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                                ,IAB.DS_CONTR_BASE_USG_NM
                                <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            FROM
                                 DS_CONTR               HDR
                                ,DS_CONTR_DTL           DTL
                                ,IV_ANE_ESCL_B          IAB
                                ,IV_DTL_STS_V_B         DTV
                            WHERE
                                    HDR.GLBL_CMPY_CD                =   #glblCmpyCd#
                                AND HDR.DS_CONTR_CATG_CD            =   #dsContrCatgAgg#
                                AND HDR.EZCANCELFLAG                =   '0'
                                AND HDR.GLBL_CMPY_CD                =   DTL.GLBL_CMPY_CD
                                AND HDR.DS_CONTR_PK                 =   DTL.DS_CONTR_PK
                                AND DTL.EZCANCELFLAG                =   '0'
                                AND DTL.DS_CONTR_PK                 =   IAB.DS_CONTR_PK
                                AND DTL.DS_CONTR_DTL_PK             =   IAB.DS_CONTR_DTL_PK
                                AND DTL.DS_CONTR_DTL_TP_CD          NOT IN (#dsContrDtlTpAgg#)
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT       &lt;=  #slsDt#
                                    OR  DTL.UPLFT_EFF_FROM_DT       IS  NULL
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                AND NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)
                                                                    &gt;= #slsDt#
                                <!-- mod end 2019/09/20 QC#53646 -->
                                AND IAB.DS_CONTR_MACH_LVL_NUM       =   #dsContrMachLvl2#
                                AND DTL.DS_CONTR_DTL_PK             =   DTV.DS_CONTR_DTL_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT IS NULL
                                    OR  MONTHS_BETWEEN(
                                         TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(IAB.UPLFT_BEF_END_RNW_DAYS_AOT, 1)
                                        ,TO_DATE(NVL(DTL.UPLFT_EFF_FROM_DT, IAB.UPLFT_PCY_DT), 'YYYYMMDD')
                                        ) / 12 >= 1
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                        )
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
        --Aggregate Lv2/Usage
            ,IV_AGG_LV2_USAGE AS (
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             DS_CONTR_PK
                            ,DS_CONTR_DTL_PK
                            ,SVC_MACH_MSTR_PK
                            ,LVL_NUM
                            <!-- mod start 2019/08/15 QC#52413 -->
                            <!-- ,CASE
                                WHEN UPLFT_EFF_FROM_DT IS NULL
                                    THEN UPLFT_PCY_DT
                                    ELSE TO_CHAR(ADD_MONTHS(TO_DATE(NVL(UPLFT_EFF_FROM_DT, UPLFT_PCY_DT), 'YYYYMMDD'), 12),  'YYYYMMDD')
                             END AS EFF_FROM_DT -->
                            ,UPLFT_PCY_DT AS EFF_FROM_DT
                            <!-- mod end 2019/08/15 QC#52413 -->
                            ,CONTR_UPLFT_TP_CD
                            <!-- add start 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_FROM_DT
                            <!-- add end 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_THRU_DT
                            ,DS_CONTR_NUM
                            ,DS_CONTR_CATG_CD
                            ,DS_CONTR_DTL_TP_CD
                            ,CONTR_CLO_DAY
                            <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            ,DS_CONTR_BASE_USG_NM
                            <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                        FROM
                            (
                            SELECT
                                 DTL.DS_CONTR_PK                DS_CONTR_PK
                                ,DTL.DS_CONTR_DTL_PK            DS_CONTR_DTL_PK
                                ,DTL.SVC_MACH_MSTR_PK           SVC_MACH_MSTR_PK
                                ,#dsContrMachLvl2#                            LVL_NUM
                                ,IAU.CONTR_UPLFT_TP_CD          CONTR_UPLFT_TP_CD
                                <!-- add start 2019/08/15 QC#52413 -->
                                ,DTL.CONTR_EFF_FROM_DT          CONTR_EFF_FROM_DT
                                <!-- add end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                                <!-- mod end 2019/09/20 QC#53646 -->
                                ,HDR.DS_CONTR_NUM
                                ,HDR.DS_CONTR_CATG_CD
                                ,DTL.DS_CONTR_DTL_TP_CD
                                ,DTL.CONTR_CLO_DAY
                                ,DTL.UPLFT_EFF_FROM_DT
                                ,IAU.UPLFT_PCY_DT
                                <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                                ,IAU.DS_CONTR_BASE_USG_NM
                                <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            FROM
                                 DS_CONTR               HDR
                                ,DS_CONTR_DTL           DTL
                                ,IV_ANE_ESCL_U          IAU
                                ,IV_DTL_STS_V_U         DTV
                            WHERE
                                    HDR.GLBL_CMPY_CD                =  #glblCmpyCd#
                                AND HDR.DS_CONTR_CATG_CD            =  #dsContrCatgAgg#
                                AND HDR.EZCANCELFLAG                =  '0'
                                AND HDR.GLBL_CMPY_CD                =  DTL.GLBL_CMPY_CD
                                AND HDR.DS_CONTR_PK                 =  DTL.DS_CONTR_PK
                                AND DTL.EZCANCELFLAG                =  '0'
                                AND DTL.DS_CONTR_PK                 =  IAU.DS_CONTR_PK
                                AND DTL.DS_CONTR_DTL_PK             =  IAU.DS_CONTR_DTL_PK
                                AND DTL.DS_CONTR_DTL_TP_CD          =  #dsContrDtlTpAgg#
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                         DTL.UPLFT_EFF_FROM_DT      &lt;=  #slsDt#
                                    OR  DTL.UPLFT_EFF_FROM_DT       IS  NULL
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                AND NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)
                                                                    &gt;= #slsDt#
                                <!-- mod end 2019/09/20 QC#53646 -->
                                AND IAU.DS_CONTR_MACH_LVL_NUM       =  #dsContrMachLvl2#
                                AND DTL.DS_CONTR_DTL_PK             =  DTV.DS_CONTR_DTL_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT IS NULL
                                    OR  MONTHS_BETWEEN(
                                         TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(IAU.UPLFT_BEF_END_RNW_DAYS_AOT, 1)
                                        ,TO_DATE(NVL(DTL.UPLFT_EFF_FROM_DT, IAU.UPLFT_PCY_DT), 'YYYYMMDD')
                                        ) / 12 >= 1
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                            )
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
        --Aggregate Lv1/Base
            ,IV_AGG_LV1_BASE AS (
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             DS_CONTR_PK
                            ,DS_CONTR_DTL_PK
                            ,SVC_MACH_MSTR_PK
                            ,LVL_NUM
                            <!-- mod start 2019/08/15 QC#52413 -->
                            <!-- ,CASE
                                WHEN UPLFT_EFF_FROM_DT IS NULL
                                    THEN UPLFT_PCY_DT
                                    ELSE TO_CHAR(ADD_MONTHS(TO_DATE(NVL(UPLFT_EFF_FROM_DT, UPLFT_PCY_DT), 'YYYYMMDD'), 12),  'YYYYMMDD')
                             END AS EFF_FROM_DT -->
                            ,UPLFT_PCY_DT AS EFF_FROM_DT
                            <!-- mod end 2019/08/15 QC#52413 -->
                            ,CONTR_UPLFT_TP_CD
                            <!-- add start 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_FROM_DT
                            <!-- add end 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_THRU_DT
                            ,DS_CONTR_NUM
                            ,DS_CONTR_CATG_CD
                            ,DS_CONTR_DTL_TP_CD
                            ,CONTR_CLO_DAY
                            <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            ,DS_CONTR_BASE_USG_NM
                            <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                        FROM
                            (
                            SELECT
                                 DTL.DS_CONTR_PK                DS_CONTR_PK
                                ,DTL.DS_CONTR_DTL_PK            DS_CONTR_DTL_PK
                                ,DTL.SVC_MACH_MSTR_PK           SVC_MACH_MSTR_PK
                                ,#dsContrMachLvl1#                            LVL_NUM
                                ,IAB.CONTR_UPLFT_TP_CD          CONTR_UPLFT_TP_CD
                                <!-- add start 2019/08/15 QC#52413 -->
                                ,DTL.CONTR_EFF_FROM_DT          CONTR_EFF_FROM_DT
                                <!-- add end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                                <!-- mod end 2019/09/20 QC#53646 -->
                                ,HDR.DS_CONTR_NUM
                                ,HDR.DS_CONTR_CATG_CD
                                ,DTL.DS_CONTR_DTL_TP_CD
                                ,DTL.CONTR_CLO_DAY
                                ,DTL.UPLFT_EFF_FROM_DT
                                ,IAB.UPLFT_PCY_DT
                                <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                                ,IAB.DS_CONTR_BASE_USG_NM
                                <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            FROM
                                 DS_CONTR               HDR
                                ,DS_CONTR_DTL           DTL
                                ,IV_ANE_ESCL_B          IAB
                                ,IV_DTL_STS_V_B         DTV
                            WHERE
                                    HDR.GLBL_CMPY_CD                =   #glblCmpyCd#
                                AND HDR.DS_CONTR_CATG_CD            =   #dsContrCatgAgg#
                                AND HDR.EZCANCELFLAG                =   '0'
                                AND HDR.GLBL_CMPY_CD                =   DTL.GLBL_CMPY_CD
                                AND HDR.DS_CONTR_PK                 =   DTL.DS_CONTR_PK
                                AND DTL.EZCANCELFLAG                =   '0'
                                AND DTL.DS_CONTR_PK                 =   IAB.DS_CONTR_PK
                                AND DTL.DS_CONTR_DTL_TP_CD          NOT IN #dsContrDtlTpAgg#
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT       &lt;=  #slsDt#
                                    OR  DTL.UPLFT_EFF_FROM_DT           IS  NULL
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                AND NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)
                                                                    &gt;= #slsDt#
                                <!-- mod end 2019/09/20 QC#53646 -->
                                AND IAB.DS_CONTR_MACH_LVL_NUM       =   #dsContrMachLvl1#
                                AND DTL.DS_CONTR_DTL_PK             =   DTV.DS_CONTR_DTL_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT IS NULL
                                    OR  MONTHS_BETWEEN(
                                         TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(IAB.UPLFT_BEF_END_RNW_DAYS_AOT, 1)
                                        ,TO_DATE(NVL(DTL.UPLFT_EFF_FROM_DT, IAB.UPLFT_PCY_DT), 'YYYYMMDD')
                                        ) / 12 >= 1
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        DS_CONTR_RNW_ESCL AEV2
                                    WHERE
                                        AEV2.DS_CONTR_PK             = DTL.DS_CONTR_PK
                                    AND AEV2.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                    AND AEV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                                    AND AEV2.EZCANCELFLAG            = '0'
                                    AND AEV2.UPLFT_PCY_DT            IS NOT NULL
                                    )
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        IV_DO_NOT_UPLIFT IDNP
                                    WHERE
                                        IDNP.DS_CONTR_PK           = DTL.DS_CONTR_PK
                                    AND IDNP.DS_CONTR_DTL_PK       = DTL.DS_CONTR_DTL_PK
                                    AND IDNP.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl2#
                                    )
                        )
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
        --Aggregate Lv1/Usage
            ,IV_AGG_LV1_USAGE AS (
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                        SELECT
                             DS_CONTR_PK
                            ,DS_CONTR_DTL_PK
                            ,SVC_MACH_MSTR_PK
                            ,LVL_NUM
                            <!-- mod start 2019/08/15 QC#52413 -->
                            <!-- ,CASE
                                WHEN UPLFT_EFF_FROM_DT IS NULL
                                    THEN UPLFT_PCY_DT
                                    ELSE TO_CHAR(ADD_MONTHS(TO_DATE(NVL(UPLFT_EFF_FROM_DT, UPLFT_PCY_DT), 'YYYYMMDD'), 12),  'YYYYMMDD')
                             END AS EFF_FROM_DT -->
                            ,UPLFT_PCY_DT AS EFF_FROM_DT
                            <!-- mod end 2019/08/15 QC#52413 -->
                            ,CONTR_UPLFT_TP_CD
                            <!-- add start 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_FROM_DT
                            <!-- add end 2019/08/15 QC#52413 -->
                            ,CONTR_EFF_THRU_DT
                            ,DS_CONTR_NUM
                            ,DS_CONTR_CATG_CD
                            ,DS_CONTR_DTL_TP_CD
                            ,CONTR_CLO_DAY
                            <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            ,DS_CONTR_BASE_USG_NM
                            <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                        FROM
                            (
                            SELECT
                                 DTL.DS_CONTR_PK                DS_CONTR_PK
                                ,DTL.DS_CONTR_DTL_PK            DS_CONTR_DTL_PK
                                ,DTL.SVC_MACH_MSTR_PK           SVC_MACH_MSTR_PK
                                ,#dsContrMachLvl1#                            LVL_NUM
                                ,IAU.CONTR_UPLFT_TP_CD          CONTR_UPLFT_TP_CD
                                <!-- add start 2019/08/15 QC#52413 -->
                                ,DTL.CONTR_EFF_FROM_DT          CONTR_EFF_FROM_DT
                                <!-- add end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                                <!-- mod end 2019/09/20 QC#53646 -->
                                ,HDR.DS_CONTR_NUM
                                ,HDR.DS_CONTR_CATG_CD
                                ,DTL.DS_CONTR_DTL_TP_CD
                                ,DTL.CONTR_CLO_DAY
                                ,DTL.UPLFT_EFF_FROM_DT
                                ,IAU.UPLFT_PCY_DT
                                <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                                ,IAU.DS_CONTR_BASE_USG_NM
                                <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            FROM
                                 DS_CONTR               HDR
                                ,DS_CONTR_DTL           DTL
                                ,IV_ANE_ESCL_U          IAU
                                ,IV_DTL_STS_V_U         DTV
                            WHERE
                                    HDR.GLBL_CMPY_CD                =  #glblCmpyCd#
                                AND HDR.DS_CONTR_CATG_CD            =  #dsContrCatgAgg#
                                AND HDR.EZCANCELFLAG                =  '0'
                                AND HDR.GLBL_CMPY_CD                =  DTL.GLBL_CMPY_CD
                                AND HDR.DS_CONTR_PK                 =  DTL.DS_CONTR_PK
                                AND DTL.EZCANCELFLAG                =  '0'
                                AND DTL.DS_CONTR_PK                 =  IAU.DS_CONTR_PK
                                AND DTL.DS_CONTR_DTL_TP_CD          =  #dsContrDtlTpAgg#
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT       &lt;=  #slsDt#
                                    OR  DTL.UPLFT_EFF_FROM_DT       IS  NULL
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                <!-- mod start 2019/09/20 QC#53646 -->
                                AND NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)
                                                                    &gt;= #slsDt#
                                <!-- mod end 2019/09/20 QC#53646 -->
                                AND IAU.DS_CONTR_MACH_LVL_NUM       =  #dsContrMachLvl1#
                                AND DTL.DS_CONTR_DTL_PK             =  DTV.DS_CONTR_DTL_PK
                                <!-- del start 2019/08/15 QC#52413 -->
                                <!-- AND (
                                        DTL.UPLFT_EFF_FROM_DT IS NULL
                                    OR  MONTHS_BETWEEN(
                                         TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(IAU.UPLFT_BEF_END_RNW_DAYS_AOT, 1)
                                        ,TO_DATE(NVL(DTL.UPLFT_EFF_FROM_DT, IAU.UPLFT_PCY_DT), 'YYYYMMDD')
                                        ) / 12 >= 1
                                    ) -->
                                <!-- del end 2019/08/15 QC#52413 -->
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        DS_CONTR_RNW_ESCL AEV2
                                    WHERE
                                        AEV2.DS_CONTR_PK             = DTL.DS_CONTR_PK
                                    AND AEV2.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                                    AND AEV2.DS_CONTR_MACH_LVL_NUM   = #dsContrMachLvl2#
                                    AND AEV2.EZCANCELFLAG            = '0'
                                    AND AEV2.UPLFT_PCY_DT            IS NOT NULL
                                    )
                                <!-- mod start 2019/09/20 QC#53646 -->
                                AND NOT EXISTS(
                                    SELECT
                                        *
                                    FROM
                                        IV_DO_NOT_UPLIFT IDNP
                                    WHERE
                                        IDNP.DS_CONTR_PK           = DTL.DS_CONTR_PK
                                    AND IDNP.DS_CONTR_DTL_PK       = DTL.DS_CONTR_DTL_PK
                                    AND IDNP.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl2#
                                    )
                                <!-- mod end 2019/09/20 QC#53646 -->
                        )
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
        ,IV_REG_BASE AS(
                SELECT
                    *
                FROM
                    IV_REG_LV3_BASE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_REG_LV2_BASE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_REG_LV1_BASE
            )
        ,IV_REG_USAGE AS(
                SELECT
                    *
                FROM
                    IV_REG_LV3_USAGE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_REG_LV2_USAGE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_REG_LV1_USAGE
            )
        ,IV_REG AS(
                SELECT
                    BS.DS_CONTR_PK
                    ,BS.DS_CONTR_DTL_PK
                    ,BS.SVC_MACH_MSTR_PK
                    ,BS.DS_CONTR_NUM
                    ,BS.DS_CONTR_CATG_CD
                    ,BS.DS_CONTR_DTL_TP_CD
                    ,BS.EFF_FROM_DT
                    ,BS.CONTR_UPLFT_TP_CD
                    ,BS.CONTR_CLO_DAY
                    <!-- add start 2019/08/15 QC#52413 -->
                    ,BS.CONTR_EFF_FROM_DT
                    <!-- add end 2019/08/15 QC#52413 -->
                    ,BS.CONTR_EFF_THRU_DT
                    ,'Y' AS BASE_FLG
                    ,'Y' AS USAGE_FLG
                    <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                    ,BS.DS_CONTR_BASE_USG_NM
                    <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                FROM
                    IV_REG_BASE BS
                WHERE
                    EXISTS(SELECT * FROM IV_REG_USAGE USG
                            WHERE
                                USG.DS_CONTR_PK         = BS.DS_CONTR_PK
                                AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK
                                AND USG.EFF_FROM_DT     = BS.EFF_FROM_DT)
                UNION ALL
                SELECT
                    BS.DS_CONTR_PK
                    ,BS.DS_CONTR_DTL_PK
                    ,BS.SVC_MACH_MSTR_PK
                    ,BS.DS_CONTR_NUM
                    ,BS.DS_CONTR_CATG_CD
                    ,BS.DS_CONTR_DTL_TP_CD
                    ,BS.EFF_FROM_DT
                    ,BS.CONTR_UPLFT_TP_CD
                    ,BS.CONTR_CLO_DAY
                    <!-- add start 2019/08/15 QC#52413 -->
                    ,BS.CONTR_EFF_FROM_DT
                    <!-- add end 2019/08/15 QC#52413 -->
                    ,BS.CONTR_EFF_THRU_DT
                    ,'Y' AS BASE_FLG
                    ,'N' AS USAGE_FLG
                    <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                    ,BS.DS_CONTR_BASE_USG_NM
                    <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                FROM
                    IV_REG_BASE BS
                WHERE
                    NOT EXISTS(SELECT * FROM IV_REG_USAGE USG
                            WHERE
                                USG.DS_CONTR_PK         = BS.DS_CONTR_PK
                                AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK
                                AND USG.EFF_FROM_DT     = BS.EFF_FROM_DT)
                UNION ALL
                SELECT
                    USG.DS_CONTR_PK
                    ,USG.DS_CONTR_DTL_PK
                    ,USG.SVC_MACH_MSTR_PK
                    ,USG.DS_CONTR_NUM
                    ,USG.DS_CONTR_CATG_CD
                    ,USG.DS_CONTR_DTL_TP_CD
                    ,USG.EFF_FROM_DT
                    ,USG.CONTR_UPLFT_TP_CD
                    ,USG.CONTR_CLO_DAY
                    <!-- add start 2019/08/15 QC#52413 -->
                    ,USG.CONTR_EFF_FROM_DT
                    <!-- add end 2019/08/15 QC#52413 -->
                    ,USG.CONTR_EFF_THRU_DT
                    ,'N' AS BASE_FLG
                    ,'Y' AS USAGE_FLG
                    <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                    ,USG.DS_CONTR_BASE_USG_NM
                    <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                FROM
                    IV_REG_USAGE USG
                WHERE
                    NOT EXISTS(SELECT * FROM IV_REG_BASE BS
                            WHERE
                                USG.DS_CONTR_PK         = BS.DS_CONTR_PK
                                AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK
                                AND USG.EFF_FROM_DT     = BS.EFF_FROM_DT)
                )
        ,IV_FLT_BASE AS(
                SELECT
                    *
                FROM
                    IV_FLT_LV3_BASE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_FLT_LV2_BASE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_FLT_LV1_BASE
            )
        ,IV_FLT_USAGE AS(
                SELECT
                    *
                FROM
                    IV_FLT_LV3_USAGE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_FLT_LV2_USAGE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_FLT_LV1_USAGE
            )
        ,IV_FLT AS(
                SELECT
                    BS.DS_CONTR_PK
                    ,BS.DS_CONTR_DTL_PK
                    ,BS.SVC_MACH_MSTR_PK
                    ,BS.DS_CONTR_NUM
                    ,BS.DS_CONTR_CATG_CD
                    ,BS.DS_CONTR_DTL_TP_CD
                    ,BS.EFF_FROM_DT
                    ,BS.CONTR_UPLFT_TP_CD
                    ,BS.CONTR_CLO_DAY
                    <!-- add start 2019/08/15 QC#52413 -->
                    ,BS.CONTR_EFF_FROM_DT
                    <!-- add end 2019/08/15 QC#52413 -->
                    ,BS.CONTR_EFF_THRU_DT
                    ,'Y' AS BASE_FLG
                    ,'Y' AS USAGE_FLG
                    <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                    ,BS.DS_CONTR_BASE_USG_NM
                    <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                FROM
                    IV_FLT_BASE BS
                WHERE
                    EXISTS(SELECT * FROM IV_FLT_USAGE USG
                            WHERE
                                USG.DS_CONTR_PK         = BS.DS_CONTR_PK
                                AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK
                                AND USG.EFF_FROM_DT     = BS.EFF_FROM_DT)
                UNION ALL
                SELECT
                    BS.DS_CONTR_PK
                    ,BS.DS_CONTR_DTL_PK
                    ,BS.SVC_MACH_MSTR_PK
                    ,BS.DS_CONTR_NUM
                    ,BS.DS_CONTR_CATG_CD
                    ,BS.DS_CONTR_DTL_TP_CD
                    ,BS.EFF_FROM_DT
                    ,BS.CONTR_UPLFT_TP_CD
                    ,BS.CONTR_CLO_DAY
                    <!-- add start 2019/08/15 QC#52413 -->
                    ,BS.CONTR_EFF_FROM_DT
                    <!-- add end 2019/08/15 QC#52413 -->
                    ,BS.CONTR_EFF_THRU_DT
                    ,'Y' AS BASE_FLG
                    ,'N' AS USAGE_FLG
                    <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                    ,BS.DS_CONTR_BASE_USG_NM
                    <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                FROM
                    IV_FLT_BASE BS
                WHERE
                    NOT EXISTS(SELECT * FROM IV_FLT_USAGE USG
                            WHERE
                                USG.DS_CONTR_PK         = BS.DS_CONTR_PK
                                AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK
                                AND USG.EFF_FROM_DT     = BS.EFF_FROM_DT)
                UNION ALL
                SELECT
                    USG.DS_CONTR_PK
                    ,USG.DS_CONTR_DTL_PK
                    ,USG.SVC_MACH_MSTR_PK
                    ,USG.DS_CONTR_NUM
                    ,USG.DS_CONTR_CATG_CD
                    ,USG.DS_CONTR_DTL_TP_CD
                    ,USG.EFF_FROM_DT
                    ,USG.CONTR_UPLFT_TP_CD
                    ,USG.CONTR_CLO_DAY
                    <!-- add start 2019/08/15 QC#52413 -->
                    ,USG.CONTR_EFF_FROM_DT
                    <!-- add end 2019/08/15 QC#52413 -->
                    ,USG.CONTR_EFF_THRU_DT
                    ,'N' AS BASE_FLG
                    ,'Y' AS USAGE_FLG
                    <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                    ,USG.DS_CONTR_BASE_USG_NM
                    <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                FROM
                    IV_FLT_USAGE USG
                WHERE
                    NOT EXISTS(SELECT * FROM IV_FLT_BASE BS
                            WHERE
                                USG.DS_CONTR_PK         = BS.DS_CONTR_PK
                                AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK
                                AND USG.EFF_FROM_DT     = BS.EFF_FROM_DT)
                )
<!-- START 2017/12/08 K.Kojima [QC#22985, ADD] -->
        ,IV_AGG_BASE_TMP AS(
                SELECT
                    *
                FROM
                    (
                    SELECT
                        A.*
                        ,ROW_NUMBER() OVER (PARTITION BY A.DS_CONTR_PK ORDER BY A.DS_CONTR_DTL_PK) AS ROW_NUMBER
                    FROM
                        (
                            SELECT
                                *
                            FROM
                                IV_AGG_LV2_BASE
                            UNION ALL
                            SELECT
                                *
                            FROM
                                IV_AGG_LV1_BASE
                        ) A
                    )
                WHERE
                    ROW_NUMBER = 1
            )
        ,IV_AGG_USAGE_TMP AS(
                SELECT
                    *
                FROM
                    IV_AGG_LV2_USAGE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_AGG_LV1_USAGE
            )
        ,IV_AGG_BASE_AGG AS(
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                SELECT
                     DTL.DS_CONTR_PK
                    ,DTL.DS_CONTR_DTL_PK
                    ,DTL.SVC_MACH_MSTR_PK
                    ,NULL AS LVL_NUM
                    ,IABT.EFF_FROM_DT
                    ,IABT.CONTR_UPLFT_TP_CD
                    <!-- add start 2019/08/15 QC#52413 -->
                    ,DTL.CONTR_EFF_FROM_DT
                    <!-- add end 2019/08/15 QC#52413 -->
                    <!-- mod start 2019/09/20 QC#53646 -->
                    ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                    <!-- mod end 2019/09/20 QC#53646 -->
                    ,HDR.DS_CONTR_NUM
                    ,HDR.DS_CONTR_CATG_CD
                    ,DTL.DS_CONTR_DTL_TP_CD
                    ,DTL.CONTR_CLO_DAY
                    <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                    ,IABT.DS_CONTR_BASE_USG_NM
                    <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                FROM
                     IV_AGG_BASE_TMP  IABT
                    ,DS_CONTR         HDR
                    ,DS_CONTR_DTL     DTL
                    ,DS_CONTR_DTL_TP  DCDT
                WHERE
                        IABT.DS_CONTR_PK                   =  HDR.DS_CONTR_PK
                    AND HDR.GLBL_CMPY_CD                   =  #glblCmpyCd#
                    AND HDR.EZCANCELFLAG                   =  '0'
                    AND HDR.GLBL_CMPY_CD                   =  DTL.GLBL_CMPY_CD
                    AND HDR.DS_CONTR_PK                    =  DTL.DS_CONTR_PK
                    AND DTL.DS_CONTR_DTL_TP_CD             =  #dsContrDtlTpAgg#
                    AND DTL.DS_CONTR_DTL_STS_CD            &lt;&gt; #dsContrDtlStsOrdr#
                    <!-- del start 2019/08/15 QC#52413 -->
                    <!-- AND (
                            DTL.UPLFT_EFF_FROM_DT          &lt;= #slsDt#
                        OR  DTL.UPLFT_EFF_FROM_DT          IS NULL
                        ) -->
                    <!-- del end 2019/08/15 QC#52413 -->
                    <!-- mod start 2019/09/20 QC#53646 -->
                    AND NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)
                                                           &gt;= #slsDt#
                    <!-- mod end 2019/09/20 QC#53646 -->
                    AND DTL.EZCANCELFLAG                   = '0'
                    AND DTL.GLBL_CMPY_CD                   = DCDT.GLBL_CMPY_CD
                    AND DTL.DS_CONTR_DTL_TP_CD             = DCDT.DS_CONTR_DTL_TP_CD
                    AND DCDT.SVC_PRC_FLG                   = 'N'
                    AND DCDT.EZCANCELFLAG                  = '0'
                    <!-- del start 2019/09/20 QC#53646 -->
                    <!-- AND ABS(
                        MONTHS_BETWEEN(
                             TO_DATE(IABT.EFF_FROM_DT, 'YYYYMMDD')
                            ,TO_DATE(DTL.CONTR_EFF_THRU_DT, 'YYYYMMDD') + 1
                            )
                        ) &gt;= 1 -->
                    <!-- del end 2019/09/20 QC#53646 -->
                    AND EXISTS(
                        SELECT
                            *
                        FROM
                            IV_DTL_STS_V_B DTV
                        WHERE
                            DTV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK
                        )
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
        ,IV_AGG_USAGE_MACH AS(
            <!-- START 2018/11/19 T.Tomita [QC#28638,MOD] -->
                SELECT
                     DTL.DS_CONTR_PK
                    ,DTL.DS_CONTR_DTL_PK
                    ,DTL.SVC_MACH_MSTR_PK
                    ,NULL AS LVL_NUM
                    ,IAUT.EFF_FROM_DT
                    ,IAUT.CONTR_UPLFT_TP_CD
                    <!-- add start 2019/08/15 QC#52413 -->
                    ,DTL.CONTR_EFF_FROM_DT
                    <!-- add end 2019/08/15 QC#52413 -->
                    <!-- mod start 2019/09/20 QC#53646 -->
                    ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                    <!-- mod end 2019/09/20 QC#53646 -->
                    ,HDR.DS_CONTR_NUM
                    ,HDR.DS_CONTR_CATG_CD
                    ,DTL.DS_CONTR_DTL_TP_CD
                    ,DTL.CONTR_CLO_DAY
                    <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                    ,IAUT.DS_CONTR_BASE_USG_NM
                    <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                FROM
                     IV_AGG_USAGE_TMP IAUT
                    ,DS_CONTR         HDR
                    ,DS_CONTR_DTL     DTL
                    ,DS_CONTR_DTL_TP  DCDT
                WHERE
                        IAUT.DS_CONTR_PK                   =  HDR.DS_CONTR_PK
                    AND HDR.GLBL_CMPY_CD                   =  #glblCmpyCd#
                    AND HDR.EZCANCELFLAG                   =  '0'
                    AND HDR.GLBL_CMPY_CD                   =  DTL.GLBL_CMPY_CD
                    AND HDR.DS_CONTR_PK                    =  DTL.DS_CONTR_PK
                    AND DTL.DS_CONTR_DTL_TP_CD             &lt;&gt; #dsContrDtlTpAgg#
                    AND DTL.DS_CONTR_DTL_STS_CD            &lt;&gt; #dsContrDtlStsOrdr#
                    <!-- del start 2019/08/15 QC#52413 -->
                    <!-- AND (
                        DTL.UPLFT_EFF_FROM_DT              &lt;= #slsDt#
                        OR DTL.UPLFT_EFF_FROM_DT           IS NULL) -->
                    <!-- del end 2019/08/15 QC#52413 -->
                    <!-- mod start 2019/09/20 QC#53646 -->
                    AND NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)
                                                           &gt;= #slsDt#
                    <!-- mod end 2019/09/20 QC#53646 -->
                    AND DTL.EZCANCELFLAG                   =  '0'
                    AND DTL.GLBL_CMPY_CD                   =  DCDT.GLBL_CMPY_CD
                    AND DTL.DS_CONTR_DTL_TP_CD             =  DCDT.DS_CONTR_DTL_TP_CD
                    AND DCDT.SVC_PRC_FLG                   =  'N'
                    AND DCDT.EZCANCELFLAG                  =  '0'
                    <!-- del start 2019/09/20 QC#53646 -->
                    <!-- AND ABS(
                        MONTHS_BETWEEN(
                             TO_DATE(IAUT.EFF_FROM_DT, 'YYYYMMDD')
                            ,TO_DATE(DTL.CONTR_EFF_THRU_DT, 'YYYYMMDD') + 1
                            )
                        ) &gt;= 1 -->
                    <!-- del end 2019/09/20 QC#53646 -->
                    AND EXISTS(
                        SELECT
                            *
                        FROM
                            IV_DTL_STS_V_U DTV
                        WHERE
                            DTV.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK
                        )
            <!-- END 2018/11/19 T.Tomita [QC#28638,MOD] -->
            )
<!-- END 2017/12/08 K.Kojima [QC#22985, ADD] -->
        ,IV_AGG_BASE AS(
                SELECT
                    *
                FROM
                    IV_AGG_LV2_BASE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_AGG_LV1_BASE
<!-- START 2017/12/08 K.Kojima [QC#22985, ADD] -->
                UNION ALL
                SELECT
                    *
                FROM
                    IV_AGG_BASE_AGG
<!-- END 2017/12/08 K.Kojima [QC#22985, ADD] -->
            )
        ,IV_AGG_USAGE AS(
                SELECT
                    *
                FROM
                    IV_AGG_LV2_USAGE
                UNION ALL
                SELECT
                    *
                FROM
                    IV_AGG_LV1_USAGE
<!-- START 2017/12/08 K.Kojima [QC#22985, ADD] -->
                UNION ALL
                SELECT
                    *
                FROM
                    IV_AGG_USAGE_MACH
<!-- END 2017/12/08 K.Kojima [QC#22985, ADD] -->
            )
        ,IV_AGG AS(
<!-- START 2017/12/08 K.Kojima [QC#22985, ADD] -->
                SELECT
                    USG.DS_CONTR_PK
                    ,USG.DS_CONTR_DTL_PK
                    ,USG.SVC_MACH_MSTR_PK
                    ,USG.DS_CONTR_NUM
                    ,USG.DS_CONTR_CATG_CD
                    ,USG.DS_CONTR_DTL_TP_CD
                    ,USG.EFF_FROM_DT
                    ,USG.CONTR_UPLFT_TP_CD
                    ,USG.CONTR_CLO_DAY
                    <!-- add start 2019/08/15 QC#52413 -->
                    ,USG.CONTR_EFF_FROM_DT
                    <!-- add end 2019/08/15 QC#52413 -->
                    ,USG.CONTR_EFF_THRU_DT
                    ,'Y' AS BASE_FLG
                    ,'Y' AS USAGE_FLG
                    <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                    ,USG.DS_CONTR_BASE_USG_NM
                    <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                FROM
                    IV_AGG_USAGE USG
                WHERE
                    EXISTS(SELECT * FROM IV_AGG_BASE BS
                            WHERE
                                USG.DS_CONTR_PK         = BS.DS_CONTR_PK
                                AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK
                                AND USG.EFF_FROM_DT     = BS.EFF_FROM_DT)
                    AND USG.DS_CONTR_DTL_TP_CD = #dsContrDtlTpAgg#
                UNION ALL
<!-- END 2017/12/08 K.Kojima [QC#22985, ADD] -->
                SELECT
                    BS.DS_CONTR_PK
                    ,BS.DS_CONTR_DTL_PK
                    ,BS.SVC_MACH_MSTR_PK
                    ,BS.DS_CONTR_NUM
                    ,BS.DS_CONTR_CATG_CD
                    ,BS.DS_CONTR_DTL_TP_CD
                    ,BS.EFF_FROM_DT
                    ,BS.CONTR_UPLFT_TP_CD
                    ,BS.CONTR_CLO_DAY
                    <!-- add start 2019/08/15 QC#52413 -->
                    ,BS.CONTR_EFF_FROM_DT
                    <!-- add end 2019/08/15 QC#52413 -->
                    ,BS.CONTR_EFF_THRU_DT
                    ,'Y' AS BASE_FLG
                    ,'Y' AS USAGE_FLG
                    <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                    ,BS.DS_CONTR_BASE_USG_NM
                    <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                FROM
                    IV_AGG_BASE BS
                WHERE
                    EXISTS(SELECT * FROM IV_AGG_USAGE USG
                            WHERE
                                USG.DS_CONTR_PK         = BS.DS_CONTR_PK
                                AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK
                                AND USG.EFF_FROM_DT     = BS.EFF_FROM_DT)
<!-- START 2017/12/08 K.Kojima [QC#22985, ADD] -->
                    AND BS.DS_CONTR_DTL_TP_CD &lt;&gt; #dsContrDtlTpAgg#
<!-- END 2017/12/08 K.Kojima [QC#22985, ADD] -->
                UNION ALL
                SELECT
                    BS.DS_CONTR_PK
                    ,BS.DS_CONTR_DTL_PK
                    ,BS.SVC_MACH_MSTR_PK
                    ,BS.DS_CONTR_NUM
                    ,BS.DS_CONTR_CATG_CD
                    ,BS.DS_CONTR_DTL_TP_CD
                    ,BS.EFF_FROM_DT
                    ,BS.CONTR_UPLFT_TP_CD
                    ,BS.CONTR_CLO_DAY
                    <!-- add start 2019/08/15 QC#52413 -->
                    ,BS.CONTR_EFF_FROM_DT
                    <!-- add end 2019/08/15 QC#52413 -->
                    ,BS.CONTR_EFF_THRU_DT
                    ,'Y' AS BASE_FLG
                    ,'N' AS USAGE_FLG
                    <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                    ,BS.DS_CONTR_BASE_USG_NM
                    <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                FROM
                    IV_AGG_BASE BS
                WHERE
                    NOT EXISTS(SELECT * FROM IV_AGG_USAGE USG
                            WHERE
                                USG.DS_CONTR_PK         = BS.DS_CONTR_PK
                                AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK
                                AND USG.EFF_FROM_DT     = BS.EFF_FROM_DT)
                UNION ALL
                SELECT
                    USG.DS_CONTR_PK
                    ,USG.DS_CONTR_DTL_PK
                    ,USG.SVC_MACH_MSTR_PK
                    ,USG.DS_CONTR_NUM
                    ,USG.DS_CONTR_CATG_CD
                    ,USG.DS_CONTR_DTL_TP_CD
                    ,USG.EFF_FROM_DT
                    ,USG.CONTR_UPLFT_TP_CD
                    ,USG.CONTR_CLO_DAY
                    <!-- add start 2019/08/15 QC#52413 -->
                    ,USG.CONTR_EFF_FROM_DT
                    <!-- add end 2019/08/15 QC#52413 -->
                    ,USG.CONTR_EFF_THRU_DT
                    ,'N' AS BASE_FLG
                    ,'Y' AS USAGE_FLG
                    <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                    ,USG.DS_CONTR_BASE_USG_NM
                    <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                FROM
                    IV_AGG_USAGE USG
                WHERE
                    NOT EXISTS(SELECT * FROM IV_AGG_BASE BS
                            WHERE
                                USG.DS_CONTR_PK         = BS.DS_CONTR_PK
                                AND USG.DS_CONTR_DTL_PK = BS.DS_CONTR_DTL_PK
                                AND USG.EFF_FROM_DT     = BS.EFF_FROM_DT)
            )
            ,IV_LINE AS(
                        SELECT
                            DTL.DS_CONTR_PK
                            ,DTL.DS_CONTR_DTL_PK
                            ,DTL.SVC_MACH_MSTR_PK
                            ,HDR.DS_CONTR_NUM
                            ,HDR.DS_CONTR_CATG_CD
                            ,DTL.DS_CONTR_DTL_TP_CD
                            ,'' AS EFF_FROM_DT
                            ,'' AS CONTR_UPLFT_TP_CD
                            ,DTL.CONTR_CLO_DAY
                            <!-- add start 2019/08/15 QC#52413 -->
                            ,'' AS CONTR_EFF_FROM_DT
                            <!-- add end 2019/08/15 QC#52413 -->
                            ,'' AS CONTR_EFF_THRU_DT
                            ,'N' AS BASE_FLG
                            ,'N' AS USAGE_FLG
                            <!-- START 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                            ,'' AS DS_CONTR_BASE_USG_NM
                            <!-- END 2022/12/05 E.Sanchez [QC#60807, ADD] -->
                        FROM
                            DS_CONTR         HDR
                            ,DS_CONTR_DTL    DTL
                            ,DS_CONTR_DTL_TP DCDT
                        WHERE
                            HDR.GLBL_CMPY_CD                = #glblCmpyCd#
                            AND HDR.EZCANCELFLAG            = '0'
                            AND HDR.DS_CONTR_CATG_CD        IN 
                            <iterate property="dsContrCatgList" var="dsContrCatgList[]" open="(" close=")" conjunction=",">
                                               #dsContrCatgList[]#
                            </iterate>
                            AND HDR.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                            AND DTL.EZCANCELFLAG            = '0'
<!-- START 2017/06/19 Y.Osawa [QC#19256,ADD] -->
                            AND DTL.DS_CONTR_DTL_STS_CD &lt;&gt; #dsContrDtlStsOrdr#
<!-- END   2017/06/19 Y.Osawa [QC#19256,ADD] -->
                            AND HDR.DS_CONTR_PK             = DTL.DS_CONTR_PK
                            AND DTL.GLBL_CMPY_CD            = DCDT.GLBL_CMPY_CD
                            AND DTL.DS_CONTR_DTL_TP_CD      = DCDT.DS_CONTR_DTL_TP_CD
                            AND DCDT.SVC_PRC_FLG            = #flgOffN#
                            AND DCDT.EZCANCELFLAG           = '0'
                            AND (EXISTS(SELECT * FROM IV_FLT FLT
                                        WHERE FLT.DS_CONTR_PK = DTL.DS_CONTR_PK)
                                OR EXISTS(SELECT * FROM IV_AGG AGG
                                        WHERE AGG.DS_CONTR_PK = DTL.DS_CONTR_PK))
                            AND (NOT EXISTS(SELECT * FROM IV_FLT FLT
                                        WHERE FLT.DS_CONTR_PK = DTL.DS_CONTR_PK
                                          AND FLT.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK)
                                AND NOT EXISTS(SELECT * FROM IV_AGG AGG
                                        WHERE AGG.DS_CONTR_PK = DTL.DS_CONTR_PK
                                          AND AGG.DS_CONTR_DTL_PK = DTL.DS_CONTR_DTL_PK))
            )
<!-- START 2017/08/28 K.Kitachi [QC#20529, MOD] -->
        SELECT
 <!-- START 2023/04/21 R.Jin [QC#59586,MOD] -->
            X.*
            ,COUNT(1) OVER(PARTITION BY X.DS_CONTR_PK) ROWCNT
 <!-- END 2023/04/21 R.Jin [QC#59586,MOD] -->
        FROM
             (
                SELECT
                    *
                FROM
                    IV_REG
                UNION ALL
                SELECT
                    *
                FROM
                    IV_FLT
                UNION ALL
                SELECT
                    *
                FROM
                    IV_AGG
                UNION ALL
                SELECT
                    *
                FROM
                    IV_LINE
             ) X
            ,DS_CONTR_DTL_TP DCDT
        WHERE
                X.DS_CONTR_DTL_TP_CD = DCDT.DS_CONTR_DTL_TP_CD
            AND DCDT.GLBL_CMPY_CD    = #glblCmpyCd#
            AND DCDT.EZCANCELFLAG    = '0'
            <!-- START 2018/10/04 K.Kojima [QC#28620,ADD] -->
            AND X.EFF_FROM_DT    &lt;= X.CONTR_EFF_THRU_DT
            <!-- END 2018/10/04 K.Kojima [QC#28620,ADD] -->
            <!-- add start 2019/08/15 QC#52413 -->
            AND X.EFF_FROM_DT    &gt;= X.CONTR_EFF_FROM_DT
            <!-- add end 2019/08/15 QC#52413 -->
        ORDER BY
             X.DS_CONTR_PK
            <!-- START 2018/05/14 K.Kojima [QC#25640,ADD] -->
            <!-- ,DCDT.DS_CONTR_DTL_TP_SORT_NUM -->
            <!-- START 2023/04/21 R.Jin [QC#59586,MOD] -->
            <!-- ,CASE WHEN DCDT.DS_CONTR_DTL_TP_CD = #dsContrDtlTpAgg# THEN 0 ELSE DCDT.DS_CONTR_DTL_TP_SORT_NUM END -->
            ,CASE WHEN DCDT.DS_CONTR_DTL_TP_CD = #dsContrDtlTpAgg# THEN (SELECT MAX(DCDT2.DS_CONTR_DTL_TP_SORT_NUM)+1 FROM DS_CONTR_DTL_TP DCDT2) ELSE DCDT.DS_CONTR_DTL_TP_SORT_NUM END
            <!-- END 2023/04/21 R.Jin [QC#59586,MOD] -->
            <!-- END 2018/05/14 K.Kojima [QC#25640,ADD] -->
            ,X.EFF_FROM_DT NULLS LAST
            ,X.DS_CONTR_DTL_PK
<!-- END 2017/08/28 K.Kitachi [QC#20529, MOD] -->
    </statement>
<!-- END 2018/08/28 M.Naito [QC#27102, MOD] -->
    <statement id="getDsContrDtlBase" parameterClass="Map" resultClass="Map">
                SELECT
                     HDR.DS_CONTR_PK                    DS_CONTR_PK
                    ,HDR.CCY_CD                         CCY_CD
                    ,REH.DS_CONTR_RNW_ESCL_PK           HDR_DS_CONTR_RNW_ESCL_PK
                    ,REH.CONTR_UPLFT_TP_CD              HDR_CONTR_UPLFT_TP_CD
                    ,REH.UPLFT_BASE_PRC_UP_RATIO        HDR_BASE_PRC_UP_RATIO
                    ,REH.UPLFT_PRC_METH_CD              HDR_UPLFT_PRC_METH_CD
                    ,DTL.DS_CONTR_DTL_PK                DS_CONTR_DTL_PK
                    <!-- mod start 2019/09/20 QC#53646 -->
                    ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                    <!-- mod end 2019/09/20 QC#53646 -->
                    ,DTL.CONTR_CLO_DAY                  CONTR_CLO_DAY
                    ,DTL.BASE_BLLG_CYCLE_CD             BLLG_CYCLE_CD
                    ,DTL.RNW_EFF_FROM_DT                RNW_EFF_FROM_DT
                    ,DTP.BASE_CHRG_FLG                  BASE_CHRG_FLG
                    ,DTP.USG_CHRG_FLG                   USG_CHRG_FLG
                    ,RED.DS_CONTR_RNW_ESCL_PK           DTL_DS_CONTR_RNW_ESCL_PK
                    ,RED.CONTR_UPLFT_TP_CD              DTL_CONTR_UPLFT_TP_CD
                    ,RED.UPLFT_BASE_PRC_UP_RATIO        DTL_BASE_PRC_UP_RATIO
                    ,RED.UPLFT_PRC_METH_CD              DTL_UPLFT_PRC_METH_CD
                    ,REB.DS_CONTR_RNW_ESCL_PK           REB_DS_CONTR_RNW_ESCL_PK
                    ,REB.CONTR_UPLFT_TP_CD              REB_CONTR_UPLFT_TP_CD
                    ,REB.UPLFT_BASE_PRC_UP_RATIO        REB_BASE_PRC_UP_RATIO
                    ,REB.UPLFT_PRC_METH_CD              REB_UPLFT_PRC_METH_CD
                    ,CCY.AFT_DECL_PNT_DIGIT_NUM         AFT_DECL_PNT_DIGIT_NUM
                FROM
                     DS_CONTR               HDR
                    ,DS_CONTR_RNW_ESCL      REH
                    ,CONTR_UPLFT_TP         UPH
                    ,DS_CONTR_DTL           DTL
                    ,DS_CONTR_DTL_TP        DTP
                    ,DS_CONTR_RNW_ESCL      RED
                    ,CONTR_UPLFT_TP         UPD
                    ,DS_CONTR_RNW_ESCL      REB
                    ,CONTR_UPLFT_TP         UPB
                    ,CCY                    CCY
                WHERE
                        HDR.GLBL_CMPY_CD                = #glblCmpyCd#
                    AND HDR.DS_CONTR_PK                 = #dsContrPk#
                    AND HDR.EZCANCELFLAG                = '0'
                    AND HDR.DS_CONTR_PK                 = REH.DS_CONTR_PK(+)
                    AND HDR.GLBL_CMPY_CD                = REH.GLBL_CMPY_CD(+)
                    AND REH.DS_CONTR_MACH_LVL_NUM(+)    = #dsContrMachLvl1#
                    AND REH.EZCANCELFLAG(+)             = '0'
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND REH.UPLFT_PCY_DT(+)             IS NOT NULL
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND REH.CONTR_UPLFT_TP_CD           = UPH.CONTR_UPLFT_TP_CD(+)
                    AND REH.GLBL_CMPY_CD                = UPH.GLBL_CMPY_CD(+)
                    AND UPH.UPLFT_BASE_FLG(+)           = #uplftBaseFlg#
                    AND UPH.EZCANCELFLAG(+)             = '0'
                    AND HDR.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                    AND HDR.GLBL_CMPY_CD                = DTL.GLBL_CMPY_CD
                    AND DTL.DS_CONTR_DTL_PK             = #dsContrDtlPk#
                    AND DTL.EZCANCELFLAG                = '0'
                    AND DTL.DS_CONTR_DTL_TP_CD          = DTP.DS_CONTR_DTL_TP_CD
                    AND DTL.GLBL_CMPY_CD                = DTP.GLBL_CMPY_CD
                    AND DTP.EZCANCELFLAG                = '0'
                    AND DTL.DS_CONTR_DTL_PK             = RED.DS_CONTR_DTL_PK(+)
                    AND DTL.GLBL_CMPY_CD                = RED.GLBL_CMPY_CD(+)
                    AND RED.DS_CONTR_MACH_LVL_NUM(+)    = #dsContrMachLvl2#
                    AND RED.EZCANCELFLAG(+)             = '0'
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND RED.UPLFT_PCY_DT(+)             IS NOT NULL
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND RED.CONTR_UPLFT_TP_CD           = UPD.CONTR_UPLFT_TP_CD(+)
                    AND RED.GLBL_CMPY_CD                = UPD.GLBL_CMPY_CD(+)
                    AND UPD.UPLFT_BASE_FLG(+)           = #uplftBaseFlg#
                    AND UPD.EZCANCELFLAG(+)             = '0'
                    AND DTL.DS_CONTR_DTL_PK             = REB.DS_CONTR_DTL_PK(+)
                    AND DTL.GLBL_CMPY_CD                = REB.GLBL_CMPY_CD(+)
                    AND REB.DS_CONTR_MACH_LVL_NUM(+)    = #dsContrMachLvl3#
                    AND REB.DS_CONTR_BASE_USG_NM(+)     = #dsContrBaseUsgNmB#
                    AND REB.EZCANCELFLAG(+)             = '0'
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND REB.UPLFT_PCY_DT(+)             IS NOT NULL
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND REB.CONTR_UPLFT_TP_CD           = UPB.CONTR_UPLFT_TP_CD(+)
                    AND REB.GLBL_CMPY_CD                = UPB.GLBL_CMPY_CD(+)
                    AND UPB.UPLFT_BASE_FLG(+)           = #uplftBaseFlg#
                    AND UPB.EZCANCELFLAG(+)             = '0'
                    AND HDR.CCY_CD                      = CCY.CCY_CD
                    AND HDR.GLBL_CMPY_CD                = CCY.GLBL_CMPY_CD
                    AND CCY.EZCANCELFLAG                = '0'
                    AND NOT EXISTS(
                        SELECT
                            1
                        FROM
                             DS_CONTR_DTL        DCD
                            ,DS_CONTR            DCH
                        WHERE
                            DCD.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                        AND DCD.DS_CONTR_DTL_TP_CD   &lt;&gt; #dsContrDtlTpF#
                        AND DCD.EZCANCELFLAG            = '0'
                        AND DCD.DS_CONTR_PK             = DCH.DS_CONTR_PK
                        AND DCD.GLBL_CMPY_CD            = DCH.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_CATG_CD        = #dsContrCatgF#
                        AND DCH.EZCANCELFLAG            = '0'
                    )
                    AND NOT EXISTS(
                        SELECT
                            1
                        FROM
                             DS_CONTR_DTL        DCD
                            ,DS_CONTR            DCH
                        WHERE
                            DCD.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                        AND DCD.DS_CONTR_DTL_TP_CD      = #dsContrDtlTpA#
                        AND DCD.EZCANCELFLAG            = '0'
                        AND DCD.DS_CONTR_PK             = DCH.DS_CONTR_PK
                        AND DCD.GLBL_CMPY_CD            = DCH.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_CATG_CD        = #dsContrCatgA#
                        AND DCH.EZCANCELFLAG            = '0'
                    )
    </statement>
    <statement id="getDsContrDtlNotRegularMachine" parameterClass="Map" resultClass="Map">
                SELECT
                     HDR.DS_CONTR_PK                    DS_CONTR_PK
                    ,HDR.CCY_CD                         CCY_CD
                    ,REH.DS_CONTR_RNW_ESCL_PK           HDR_DS_CONTR_RNW_ESCL_PK
                    ,REH.CONTR_UPLFT_TP_CD              HDR_CONTR_UPLFT_TP_CD
                    ,REH.UPLFT_BASE_PRC_UP_RATIO        HDR_BASE_PRC_UP_RATIO
                    ,REH.UPLFT_PRC_METH_CD              HDR_UPLFT_PRC_METH_CD
                    ,DTL.DS_CONTR_DTL_PK                DS_CONTR_DTL_PK
                    ,DTL.CONTR_EFF_THRU_DT              CONTR_EFF_THRU_DT
                    ,DTL.CONTR_CLO_DAY                  CONTR_CLO_DAY
                    ,DTL.BASE_BLLG_CYCLE_CD             BLLG_CYCLE_CD
                    ,DTL.RNW_EFF_FROM_DT                RNW_EFF_FROM_DT
                    ,DTL.CONTR_EFF_THRU_DT              CONTR_EFF_THRU_DT
                    ,DTP.BASE_CHRG_FLG                  BASE_CHRG_FLG
                    ,DTP.USG_CHRG_FLG                   USG_CHRG_FLG
                    ,RED.DS_CONTR_RNW_ESCL_PK           DTL_DS_CONTR_RNW_ESCL_PK
                    ,RED.CONTR_UPLFT_TP_CD              DTL_CONTR_UPLFT_TP_CD
                    ,RED.UPLFT_BASE_PRC_UP_RATIO        DTL_BASE_PRC_UP_RATIO
                    ,RED.UPLFT_PRC_METH_CD              DTL_UPLFT_PRC_METH_CD
                    ,REB.DS_CONTR_RNW_ESCL_PK           REB_DS_CONTR_RNW_ESCL_PK
                    ,REB.CONTR_UPLFT_TP_CD              REB_CONTR_UPLFT_TP_CD
                    ,REB.UPLFT_BASE_PRC_UP_RATIO        REB_BASE_PRC_UP_RATIO
                    ,REB.UPLFT_PRC_METH_CD              REB_UPLFT_PRC_METH_CD
                    ,CCY.AFT_DECL_PNT_DIGIT_NUM         AFT_DECL_PNT_DIGIT_NUM
                FROM
                     DS_CONTR               HDR
                    ,DS_CONTR_RNW_ESCL      REH
                    ,CONTR_UPLFT_TP         UPH
                    ,DS_CONTR_DTL           DTL
                    ,DS_CONTR_DTL_TP        DTP
                    ,DS_CONTR_RNW_ESCL      RED
                    ,CONTR_UPLFT_TP         UPD
                    ,DS_CONTR_RNW_ESCL      REB
                    ,CONTR_UPLFT_TP         UPB
                    ,CCY                    CCY
                WHERE
                        HDR.GLBL_CMPY_CD                = #glblCmpyCd#
                    AND HDR.DS_CONTR_PK                 = #dsContrPk#
                    AND HDR.EZCANCELFLAG                = '0'
                    AND HDR.DS_CONTR_PK                 = REH.DS_CONTR_PK(+)
                    AND HDR.GLBL_CMPY_CD                = REH.GLBL_CMPY_CD(+)
                    AND REH.DS_CONTR_MACH_LVL_NUM(+)    = #dsContrMachLvl1#
                    AND REH.EZCANCELFLAG(+)             = '0'
                    AND REH.CONTR_UPLFT_TP_CD           = UPH.CONTR_UPLFT_TP_CD(+)
                    AND REH.GLBL_CMPY_CD                = UPH.GLBL_CMPY_CD(+)
                    AND UPH.UPLFT_BASE_FLG(+)           = #uplftBaseFlg#
                    AND UPH.EZCANCELFLAG(+)             = '0'
                    AND HDR.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                    AND HDR.GLBL_CMPY_CD                = DTL.GLBL_CMPY_CD
                    AND DTL.DS_CONTR_DTL_PK             = #dsContrDtlPk#
                    AND DTL.EZCANCELFLAG                = '0'
                    AND DTL.DS_CONTR_DTL_TP_CD          = DTP.DS_CONTR_DTL_TP_CD
                    AND DTL.GLBL_CMPY_CD                = DTP.GLBL_CMPY_CD
                    AND DTP.EZCANCELFLAG                = '0'
                    AND DTL.DS_CONTR_DTL_PK             = RED.DS_CONTR_DTL_PK(+)
                    AND DTL.GLBL_CMPY_CD                = RED.GLBL_CMPY_CD(+)
                    AND RED.DS_CONTR_MACH_LVL_NUM(+)    = #dsContrMachLvl2#
                    AND RED.EZCANCELFLAG(+)             = '0'
                    AND RED.CONTR_UPLFT_TP_CD           = UPD.CONTR_UPLFT_TP_CD(+)
                    AND RED.GLBL_CMPY_CD                = UPD.GLBL_CMPY_CD(+)
                    AND UPD.UPLFT_BASE_FLG(+)           = #uplftBaseFlg#
                    AND UPD.EZCANCELFLAG(+)             = '0'
                    AND DTL.DS_CONTR_DTL_PK             = REB.DS_CONTR_DTL_PK(+)
                    AND DTL.GLBL_CMPY_CD                = REB.GLBL_CMPY_CD(+)
                    AND REB.DS_CONTR_MACH_LVL_NUM(+)    = #dsContrMachLvl3#
                    AND REB.DS_CONTR_BASE_USG_NM(+)     = #dsContrBaseUsgNmB#
                    AND REB.EZCANCELFLAG(+)             = '0'
                    AND REB.CONTR_UPLFT_TP_CD           = UPB.CONTR_UPLFT_TP_CD(+)
                    AND REB.GLBL_CMPY_CD                = UPB.GLBL_CMPY_CD(+)
                    AND UPB.UPLFT_BASE_FLG(+)           = #uplftBaseFlg#
                    AND UPB.EZCANCELFLAG(+)             = '0'
                    AND HDR.CCY_CD                      = CCY.CCY_CD
                    AND HDR.GLBL_CMPY_CD                = CCY.GLBL_CMPY_CD
                    AND CCY.EZCANCELFLAG                = '0'
                    AND NOT EXISTS(
                        SELECT
                            1
                        FROM
                             DS_CONTR_DTL        DCD
                            ,DS_CONTR            DCH
                        WHERE
                            DCD.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                        AND DCD.DS_CONTR_DTL_TP_CD   &lt;&gt; #dsContrDtlTpF#
                        AND DCD.EZCANCELFLAG            = '0'
                        AND DCD.DS_CONTR_PK             = DCH.DS_CONTR_PK
                        AND DCD.GLBL_CMPY_CD            = DCH.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_CATG_CD        = #dsContrCatgF#
                        AND DCH.EZCANCELFLAG            = '0'
                    )
                    AND NOT EXISTS(
                        SELECT
                            1
                        FROM
                             DS_CONTR_DTL        DCD
                            ,DS_CONTR            DCH
                        WHERE
                            DCD.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                        AND DCD.DS_CONTR_DTL_TP_CD      = #dsContrDtlTpA#
                        AND DCD.EZCANCELFLAG            = '0'
                        AND DCD.DS_CONTR_PK             = DCH.DS_CONTR_PK
                        AND DCD.GLBL_CMPY_CD            = DCH.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_CATG_CD        = #dsContrCatgA#
                        AND DCH.EZCANCELFLAG            = '0'
                    )
    </statement>
    <statement id="getDsContrDtlUsage" parameterClass="Map" resultClass="Map">
                SELECT
                     HDR.DS_CONTR_PK                    DS_CONTR_PK
                    ,HDR.CCY_CD                         CCY_CD
                    ,REH.DS_CONTR_RNW_ESCL_PK           HDR_DS_CONTR_RNW_ESCL_PK
                    ,REH.CONTR_UPLFT_TP_CD              HDR_CONTR_UPLFT_TP_CD
                    ,REH.UPLFT_MTR_PRC_UP_RATIO         HDR_MTR_PRC_UP_RATIO
                    ,REH.UPLFT_PRC_METH_CD              HDR_UPLFT_PRC_METH_CD
                    ,DTL.DS_CONTR_DTL_PK                DS_CONTR_DTL_PK
                    <!-- mod start 2019/09/20 QC#53646 -->
                    ,NVL(DTL.CONTR_CLO_DT, DTL.CONTR_EFF_THRU_DT)  CONTR_EFF_THRU_DT
                    <!-- mod end 2019/09/20 QC#53646 -->
                    ,DTL.CONTR_CLO_DAY                  CONTR_CLO_DAY
                    ,DTL.BASE_BLLG_CYCLE_CD             BLLG_CYCLE_CD
                    ,DTL.RNW_EFF_FROM_DT                RNW_EFF_FROM_DT
                    ,DTP.BASE_CHRG_FLG                  BASE_CHRG_FLG
                    ,DTP.USG_CHRG_FLG                   USG_CHRG_FLG
                    ,RED.DS_CONTR_RNW_ESCL_PK           DTL_DS_CONTR_RNW_ESCL_PK
                    ,RED.CONTR_UPLFT_TP_CD              DTL_CONTR_UPLFT_TP_CD
                    ,RED.UPLFT_MTR_PRC_UP_RATIO         DTL_MTR_PRC_UP_RATIO
                    ,RED.UPLFT_PRC_METH_CD              DTL_UPLFT_PRC_METH_CD
                    ,REB.DS_CONTR_RNW_ESCL_PK           REB_DS_CONTR_RNW_ESCL_PK
                    ,REB.CONTR_UPLFT_TP_CD              REB_CONTR_UPLFT_TP_CD
                    ,REB.UPLFT_MTR_PRC_UP_RATIO         REB_MTR_PRC_UP_RATIO
                    ,REB.UPLFT_PRC_METH_CD              REB_UPLFT_PRC_METH_CD
                    ,CCY.AFT_DECL_PNT_DIGIT_NUM         AFT_DECL_PNT_DIGIT_NUM
                FROM
                     DS_CONTR               HDR
                    ,DS_CONTR_RNW_ESCL      REH
                    ,CONTR_UPLFT_TP         UPH
                    ,DS_CONTR_DTL           DTL
                    ,DS_CONTR_DTL_TP        DTP
                    ,DS_CONTR_RNW_ESCL      RED
                    ,CONTR_UPLFT_TP         UPD
                    ,DS_CONTR_RNW_ESCL      REB
                    ,CONTR_UPLFT_TP         UPB
                    ,CCY                    CCY
                WHERE
                        HDR.GLBL_CMPY_CD                = #glblCmpyCd#
                    AND HDR.DS_CONTR_PK                 = #dsContrPk#
                    AND HDR.EZCANCELFLAG                = '0'
                    AND HDR.DS_CONTR_PK                 = REH.DS_CONTR_PK(+)
                    AND HDR.GLBL_CMPY_CD                = REH.GLBL_CMPY_CD(+)
                    AND REH.DS_CONTR_MACH_LVL_NUM(+)    = #dsContrMachLvl1#
                    AND REH.EZCANCELFLAG(+)             = '0'
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND REH.UPLFT_PCY_DT(+)             IS NOT NULL
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND REH.CONTR_UPLFT_TP_CD           = UPH.CONTR_UPLFT_TP_CD(+)
                    AND REH.GLBL_CMPY_CD                = UPH.GLBL_CMPY_CD(+)
                    AND UPH.UPLFT_USG_FLG(+)            = #uplftUsgFlg#
                    AND UPH.EZCANCELFLAG(+)             = '0'
                    AND HDR.DS_CONTR_PK                 = DTL.DS_CONTR_PK
                    AND HDR.GLBL_CMPY_CD                = DTL.GLBL_CMPY_CD
                    AND DTL.DS_CONTR_DTL_PK             = #dsContrDtlPk#
                    AND DTL.EZCANCELFLAG                = '0'
                    AND DTL.DS_CONTR_DTL_TP_CD          = DTP.DS_CONTR_DTL_TP_CD
                    AND DTL.GLBL_CMPY_CD                = DTP.GLBL_CMPY_CD
                    AND DTP.EZCANCELFLAG                = '0'
                    AND DTL.DS_CONTR_DTL_PK             = RED.DS_CONTR_DTL_PK(+)
                    AND DTL.GLBL_CMPY_CD                = RED.GLBL_CMPY_CD(+)
                    AND RED.DS_CONTR_MACH_LVL_NUM(+)    = #dsContrMachLvl2#
                    AND RED.EZCANCELFLAG(+)             = '0'
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND RED.UPLFT_PCY_DT(+)             IS NOT NULL
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND RED.CONTR_UPLFT_TP_CD           = UPD.CONTR_UPLFT_TP_CD(+)
                    AND RED.GLBL_CMPY_CD                = UPD.GLBL_CMPY_CD(+)
                    AND UPD.UPLFT_USG_FLG(+)            = #uplftUsgFlg#
                    AND UPD.EZCANCELFLAG(+)             = '0'
                    AND DTL.DS_CONTR_DTL_PK             = REB.DS_CONTR_DTL_PK(+)
                    AND DTL.GLBL_CMPY_CD                = REB.GLBL_CMPY_CD(+)
                    AND REB.DS_CONTR_MACH_LVL_NUM(+)    = #dsContrMachLvl3#
                    AND REB.DS_CONTR_BASE_USG_NM(+)     = #dsContrBaseUsgNmU#
                    AND REB.EZCANCELFLAG(+)             = '0'
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND REB.UPLFT_PCY_DT(+)             IS NOT NULL
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND REB.CONTR_UPLFT_TP_CD           = UPB.CONTR_UPLFT_TP_CD(+)
                    AND REB.GLBL_CMPY_CD                = UPB.GLBL_CMPY_CD(+)
                    AND UPB.UPLFT_USG_FLG(+)            = #uplftUsgFlg#
                    AND UPB.EZCANCELFLAG(+)             = '0'
                    AND HDR.CCY_CD                      = CCY.CCY_CD
                    AND HDR.GLBL_CMPY_CD                = CCY.GLBL_CMPY_CD
                    AND CCY.EZCANCELFLAG                = '0'
                    AND NOT EXISTS(
                        SELECT
                            1
                        FROM
                             DS_CONTR_DTL        DCD
                            ,DS_CONTR            DCH
                        WHERE
                            DCD.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD
                        AND DCD.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK
                        AND DCD.DS_CONTR_DTL_TP_CD   &lt;&gt; #dsContrDtlTpF#
                        AND DCD.EZCANCELFLAG            = '0'
                        AND DCD.DS_CONTR_PK             = DCH.DS_CONTR_PK
                        AND DCD.GLBL_CMPY_CD            = DCH.GLBL_CMPY_CD
                        AND DCH.DS_CONTR_CATG_CD        = #dsContrCatgF#
                        AND DCH.EZCANCELFLAG            = '0'
                    )
<!-- START 2017/08/28 K.Kitachi [QC#20529, DEL] -->
<!--                AND NOT EXISTS( -->
<!--                    SELECT -->
<!--                        1 -->
<!--                    FROM -->
<!--                         DS_CONTR_DTL        DCD -->
<!--                        ,DS_CONTR            DCH -->
<!--                    WHERE -->
<!--                        DCD.GLBL_CMPY_CD            = DTL.GLBL_CMPY_CD -->
<!--                    AND DCD.DS_CONTR_DTL_PK         = DTL.DS_CONTR_DTL_PK -->
<!--                    AND DCD.DS_CONTR_DTL_TP_CD   &lt;&gt; #dsContrDtlTpA# -->
<!--                    AND DCD.EZCANCELFLAG            = '0' -->
<!--                    AND DCD.DS_CONTR_PK             = DCH.DS_CONTR_PK -->
<!--                    AND DCD.GLBL_CMPY_CD            = DCH.GLBL_CMPY_CD -->
<!--                    AND DCH.DS_CONTR_CATG_CD        = #dsContrCatgA# -->
<!--                    AND DCH.EZCANCELFLAG            = '0' -->
<!--                ) -->
<!-- END 2017/08/28 K.Kitachi [QC#20529, DEL] -->
    </statement>
    <statement id="getModelUpdateRuleBase" parameterClass="Map" resultClass="BigDecimal">
        SELECT
                MUR.UPLFT_BASE_PRC_UP_RATIO       BASE_PRC_UP_RATIO
        FROM
                 DS_CONTR_DTL           DTL
                ,SVC_CONFIG_MSTR        SCM
                ,DS_MDL_ESCL_RULE       MUR
        WHERE
                DTL.GLBL_CMPY_CD                 = #glblCmpyCd#
            AND DTL.DS_CONTR_DTL_PK              = #dsContrDtlPk#
            AND DTL.EZCANCELFLAG                 = '0'
            AND DTL.SVC_CONFIG_MSTR_PK           = SCM.SVC_CONFIG_MSTR_PK
            AND DTL.GLBL_CMPY_CD                 = SCM.GLBL_CMPY_CD
            AND SCM.EZCANCELFLAG                 = '0'
            AND SCM.MDL_ID                       = MUR.MDL_ID
            AND SCM.GLBL_CMPY_CD                 = MUR.GLBL_CMPY_CD
            AND MUR.EFF_FROM_DT              &lt;= #effFromDt#
            AND NVL(MUR.EFF_THRU_DT,#maxDt#) &gt;= #effFromDt#
            AND MUR.EZCANCELFLAG                 = '0'
    </statement>
    <statement id="getModelUpdateRuleBaseForLine" parameterClass="Map" resultClass="BigDecimal">
        WITH IV_DTL AS(
            SELECT
                GLBL_CMPY_CD
                ,DS_CONTR_DTL_PK
                ,SVC_CONFIG_MSTR_PK
            FROM
                (SELECT
                    DTL.GLBL_CMPY_CD
                    ,DTL.DS_CONTR_DTL_PK
                    ,DTL.SVC_CONFIG_MSTR_PK
                    ,ROW_NUMBER() OVER (PARTITION BY DTL.DS_CONTR_PK ORDER BY DTL.DS_CONTR_DTL_PK ASC) AS ROW_NUM 
                FROM
                    DS_CONTR_DTL           DTL
                WHERE
                    DTL.GLBL_CMPY_CD            = #glblCmpyCd#
                    AND DTL.EZCANCELFLAG        = '0'
                    AND DTL.SVC_MACH_MSTR_PK    IS NOT NULL
                    AND EXISTS
                        (SELECT * FROM DS_CONTR_DTL  LINE
                        WHERE
                            LINE.GLBL_CMPY_CD           = #glblCmpyCd#
                            AND LINE.DS_CONTR_DTL_PK    = #dsContrDtlPk#
                            AND LINE.DS_CONTR_PK        = DTL.DS_CONTR_PK
                            AND LINE.EZCANCELFLAG       = '0')
                )
            WHERE
                ROW_NUM = 1
            )
        SELECT
                MUR.UPLFT_BASE_PRC_UP_RATIO       BASE_PRC_UP_RATIO
        FROM
                 IV_DTL                 DTL
                ,SVC_CONFIG_MSTR        SCM
                ,DS_MDL_ESCL_RULE       MUR
        WHERE
                DTL.SVC_CONFIG_MSTR_PK          = SCM.SVC_CONFIG_MSTR_PK
            AND DTL.GLBL_CMPY_CD                = SCM.GLBL_CMPY_CD
            AND SCM.EZCANCELFLAG                = '0'
            AND SCM.MDL_ID                      = MUR.MDL_ID
            AND SCM.GLBL_CMPY_CD                = MUR.GLBL_CMPY_CD
            AND MUR.EFF_FROM_DT               &lt;= #effFromDt#
            AND NVL(MUR.EFF_THRU_DT,#maxDt#)  &gt;= #effFromDt#
            AND MUR.EZCANCELFLAG                = '0'
    </statement>
    <statement id="getModelUpdateRuleMtrForLine" parameterClass="Map" resultClass="BigDecimal">
        WITH IV_DTL AS(
            SELECT
                GLBL_CMPY_CD
                ,DS_CONTR_DTL_PK
                ,SVC_CONFIG_MSTR_PK
            FROM
                (SELECT
                    DTL.GLBL_CMPY_CD
                    ,DTL.DS_CONTR_DTL_PK
                    ,DTL.SVC_CONFIG_MSTR_PK
                    ,ROW_NUMBER() OVER (PARTITION BY DTL.DS_CONTR_PK ORDER BY DTL.DS_CONTR_DTL_PK ASC) AS ROW_NUM 
                FROM
                    DS_CONTR_DTL           DTL
                WHERE
                    DTL.GLBL_CMPY_CD            = #glblCmpyCd#
                    AND DTL.EZCANCELFLAG        = '0'
                    AND DTL.SVC_MACH_MSTR_PK    IS NOT NULL
                    AND EXISTS
                        (SELECT * FROM DS_CONTR_DTL  LINE
                        WHERE
                            LINE.GLBL_CMPY_CD           = #glblCmpyCd#
                            AND LINE.DS_CONTR_DTL_PK    = #dsContrDtlPk#
                            AND LINE.DS_CONTR_PK        = DTL.DS_CONTR_PK
                            AND LINE.EZCANCELFLAG       = '0')
                )
            WHERE
                ROW_NUM = 1
            )
                SELECT
                        MBM.UPLFT_MTR_PRC_UP_RATIO       MTR_PRC_UP_RATIO
                FROM
                         IV_DTL                 DTL
                        ,SVC_CONFIG_MSTR        SCM
                        ,DS_CONTR_BLLG_MTR      BLM
                        ,DS_MDL_ESCL_RULE       MUR
                        ,DS_MDL_ESCL_BLLG_MTR   MBM
                WHERE
                        DTL.SVC_CONFIG_MSTR_PK          = SCM.SVC_CONFIG_MSTR_PK
                    AND DTL.GLBL_CMPY_CD                = SCM.GLBL_CMPY_CD
                    AND SCM.EZCANCELFLAG                = '0'
                    AND DTL.GLBL_CMPY_CD                = BLM.GLBL_CMPY_CD
                    AND BLM.EZCANCELFLAG                = '0'
                    AND BLM.DS_CONTR_BLLG_MTR_PK        = #dsContrBllgMtrPk#
                    AND SCM.MDL_ID                      = MUR.MDL_ID
                    AND SCM.GLBL_CMPY_CD                = MUR.GLBL_CMPY_CD
                    AND MUR.EFF_FROM_DT               &lt;= #effFromDt#
                    AND NVL(MUR.EFF_THRU_DT,#maxDt#)  &gt;= #effFromDt#
                    AND MUR.EZCANCELFLAG                = '0'
                    AND MUR.DS_MDL_ESCL_RULE_PK         = MBM.DS_MDL_ESCL_RULE_PK
                    AND MUR.GLBL_CMPY_CD                = MBM.GLBL_CMPY_CD
                    AND MBM.EZCANCELFLAG                = '0'
                    AND BLM.GLBL_CMPY_CD                = MBM.GLBL_CMPY_CD
                    AND BLM.BLLG_MTR_LB_CD              = MBM.BLLG_MTR_LB_CD
    </statement>
    <statement id="getUsagePrcEff" parameterClass="Map" resultClass="Map">
        SELECT
            BLLG_MTR_LB_CD
            ,DS_CONTR_BLLG_MTR_PK
            ,CONTR_XS_COPY_PK
            ,XS_MTR_COPY_QTY
            ,XS_MTR_AMT_RATE
            ,XS_MTR_FIRST_FLG
        FROM
            (
            SELECT
                 CBM.BLLG_MTR_LB_CD
                ,CPE.DS_CONTR_BLLG_MTR_PK
                ,PEM.CONTR_XS_COPY_PK
                ,PEM.XS_MTR_COPY_QTY
                ,PEM.XS_MTR_AMT_RATE
                ,PEM.XS_MTR_FIRST_FLG
                ,ROW_NUMBER() OVER (PARTITION BY CPE.DS_CONTR_BLLG_MTR_PK,PEM.CONTR_XS_COPY_PK ORDER BY CPE.CONTR_PRC_EFF_THRU_DT DESC) AS ROW_NUM 
            FROM
                 DS_CONTR_PRC_EFF       CPE
                ,DS_CONTR_PRC_EFF_MTR   PEM
                ,DS_CONTR_BLLG_MTR      CBM
<!-- START 2021/11/11 L.Mandanas [QC#59305, ADD] -->
                ,CONTR_XS_COPY          CXC
<!-- NED 2021/11/11 L.Mandanas [QC#59305, ADD] -->
            WHERE
                    CPE.GLBL_CMPY_CD                = #glblCmpyCd#
                AND CPE.DS_CONTR_DTL_PK             = #dsContrDtlPk#
                AND CPE.USG_CHRG_FLG                = 'Y'
                AND CPE.EZCANCELFLAG                = '0'
                AND CPE.DS_CONTR_PRC_EFF_PK         = PEM.DS_CONTR_PRC_EFF_PK
                AND CPE.GLBL_CMPY_CD                = PEM.GLBL_CMPY_CD
                AND PEM.EZCANCELFLAG                = '0'
                AND PEM.DS_CONTR_BLLG_MTR_PK        = CBM.DS_CONTR_BLLG_MTR_PK
                AND PEM.GLBL_CMPY_CD                = CBM.GLBL_CMPY_CD
                AND CBM.EZCANCELFLAG                = '0'
<!-- START 2021/11/11 L.Mandanas [QC#59305, ADD] -->
                AND PEM.GLBL_CMPY_CD                = CXC.GLBL_CMPY_CD
                AND PEM.CONTR_XS_COPY_PK            = CXC.CONTR_XS_COPY_PK
                AND CXC.EZCANCELFLAG                = '0'
<!-- NED 2021/11/11 L.Mandanas [QC#59305, ADD] -->
            )
        WHERE
            ROW_NUM = 1
        ORDER BY
            DS_CONTR_BLLG_MTR_PK       ASC
            ,XS_MTR_COPY_QTY           ASC
    </statement>
    <statement id="getModelUpdateRuleMtr" parameterClass="Map" resultClass="BigDecimal">
        SELECT
                MBM.UPLFT_MTR_PRC_UP_RATIO       MTR_PRC_UP_RATIO
        FROM
                 DS_CONTR_DTL           DTL
                ,SVC_CONFIG_MSTR        SCM
                ,DS_MDL_ESCL_RULE       MUR
                ,DS_MDL_ESCL_BLLG_MTR   MBM
        WHERE
                DTL.GLBL_CMPY_CD                 = #glblCmpyCd#
            AND DTL.DS_CONTR_DTL_PK              = #dsContrDtlPk#
            AND DTL.EZCANCELFLAG                 = '0'
            AND DTL.SVC_CONFIG_MSTR_PK           = SCM.SVC_CONFIG_MSTR_PK
            AND DTL.GLBL_CMPY_CD                 = SCM.GLBL_CMPY_CD
            AND SCM.EZCANCELFLAG                 = '0'
            AND SCM.MDL_ID                       = MUR.MDL_ID
            AND SCM.GLBL_CMPY_CD                 = MUR.GLBL_CMPY_CD
            AND MUR.EFF_FROM_DT              &lt;= #effFromDt#
            AND NVL(MUR.EFF_THRU_DT,#maxDt#) &gt;= #effFromDt#
            AND MUR.EZCANCELFLAG                 = '0'
            AND MUR.DS_MDL_ESCL_RULE_PK          = MBM.DS_MDL_ESCL_RULE_PK
            AND MUR.GLBL_CMPY_CD                 = MBM.GLBL_CMPY_CD
            AND MBM.EZCANCELFLAG                 = '0'
    </statement>
<!-- START 2017/08/28 K.Kitachi [QC#20529, MOD] -->
    <statement id="getBaseTermAmtForAggLine" parameterClass="Map" resultClass="Map">
<!-- END 2017/08/28 K.Kitachi [QC#20529, MOD] -->
        SELECT
             SUM(B.BASE_PRC_TERM_DEAL_AMT_RATE) AS BASE_PRC_TERM_DEAL_AMT_RATE
<!-- START 2017/08/28 K.Kitachi [QC#20529, ADD] -->
            ,SUM(B.BASE_PRC_DEAL_AMT)           AS BASE_PRC_DEAL_AMT
<!-- END 2017/08/28 K.Kitachi [QC#20529, ADD] -->
        FROM
             DS_CONTR     A
            ,DS_CONTR_DTL B
        WHERE
                A.GLBL_CMPY_CD       =  #glblCmpyCd#
            AND A.DS_CONTR_PK        =  #dsContrPk#
            AND A.DS_CONTR_CATG_CD   =  #dsContrCatgCd#
            AND A.EZCANCELFLAG       =  '0'
            AND A.GLBL_CMPY_CD       =  B.GLBL_CMPY_CD
            AND A.DS_CONTR_PK        =  B.DS_CONTR_PK
            AND B.DS_CONTR_DTL_TP_CD &lt;&gt; #dsContrDtlTpCd#
<!-- START 2017/06/19 Y.Osawa [QC#19256,ADD] -->
            AND B.DS_CONTR_DTL_STS_CD &lt;&gt; #dsContrDtlStsOrdr#
<!-- END   2017/06/19 Y.Osawa [QC#19256,ADD] -->
            AND B.EZCANCELFLAG       =  '0'
    </statement>
<!-- START 2017/02/10 K.Kitachi [QC#17410, ADD] -->
    <statement id="countCfsDlr" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            COUNT(*)
        FROM
             BILL_TO_CUST    BTC
            ,SELL_TO_CUST    STC
        WHERE
                BTC.GLBL_CMPY_CD    = #glblCmpyCd#
            AND BTC.BILL_TO_CUST_CD = #billToCustCd#
            AND BTC.EZCANCELFLAG    = '0'
            AND BTC.GLBL_CMPY_CD    = STC.GLBL_CMPY_CD
            AND BTC.SELL_TO_CUST_CD = STC.SELL_TO_CUST_CD
            AND STC.DS_ACCT_DLR_CD  = #cfsDlrCd#
            AND STC.EZCANCELFLAG    = '0'
    </statement>
    <statement id="getRegAndAggBase" parameterClass="Map" resultClass="Map">
        SELECT
             X.SER_NUM
            ,X.MDL_ID
            ,X.MDL_NM
            ,X.PRC_UP_RATIO
        FROM
            (
                SELECT
                     SMM.SER_NUM                 AS SER_NUM
                    ,MNM.T_MDL_ID                AS MDL_ID
                    ,MNM.T_MDL_NM                AS MDL_NM
                    ,CRE.UPLFT_BASE_PRC_UP_RATIO AS PRC_UP_RATIO
                    ,CRE.DS_CONTR_MACH_LVL_NUM   AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_UPLFT_TP    UTP
                    ,SVC_MACH_MSTR     SMM
                    ,SVC_CONFIG_MSTR   SCM
                    ,MDL_NM            MNM
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_PK           = CRE.DS_CONTR_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl1#
                    AND CRE.EZCANCELFLAG          = '0'
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.UPLFT_PCY_DT          IS NOT NULL
                    <!-- END 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.GLBL_CMPY_CD          = UTP.GLBL_CMPY_CD
                    AND CRE.CONTR_UPLFT_TP_CD     = UTP.CONTR_UPLFT_TP_CD
                    AND UTP.UPLFT_BASE_FLG        = 'Y'
                    AND UTP.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = SMM.GLBL_CMPY_CD
                    AND DCD.SVC_MACH_MSTR_PK      = SMM.SVC_MACH_MSTR_PK
                    AND SMM.EZCANCELFLAG          = '0'
                    AND SMM.GLBL_CMPY_CD          = SCM.GLBL_CMPY_CD
                    AND SMM.SVC_CONFIG_MSTR_PK    = SCM.SVC_CONFIG_MSTR_PK
                    AND SCM.EZCANCELFLAG          = '0'
                    AND SCM.GLBL_CMPY_CD          = MNM.T_GLBL_CMPY_CD
                    AND SCM.MDL_ID                = MNM.T_MDL_ID
                    AND MNM.EZCANCELFLAG          = '0'
                UNION
                SELECT
                     SMM.SER_NUM                 AS SER_NUM
                    ,MNM.T_MDL_ID                AS MDL_ID
                    ,MNM.T_MDL_NM                AS MDL_NM
                    ,CRE.UPLFT_BASE_PRC_UP_RATIO AS PRC_UP_RATIO
                    ,CRE.DS_CONTR_MACH_LVL_NUM   AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_UPLFT_TP    UTP
                    ,SVC_MACH_MSTR     SMM
                    ,SVC_CONFIG_MSTR   SCM
                    ,MDL_NM            MNM
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CRE.DS_CONTR_DTL_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl2#
                    AND CRE.EZCANCELFLAG          = '0'
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.UPLFT_PCY_DT          IS NOT NULL
                    <!-- END 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.GLBL_CMPY_CD          = UTP.GLBL_CMPY_CD
                    AND CRE.CONTR_UPLFT_TP_CD     = UTP.CONTR_UPLFT_TP_CD
                    AND UTP.UPLFT_BASE_FLG        = 'Y'
                    AND UTP.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = SMM.GLBL_CMPY_CD
                    AND DCD.SVC_MACH_MSTR_PK      = SMM.SVC_MACH_MSTR_PK
                    AND SMM.EZCANCELFLAG          = '0'
                    AND SMM.GLBL_CMPY_CD          = SCM.GLBL_CMPY_CD
                    AND SMM.SVC_CONFIG_MSTR_PK    = SCM.SVC_CONFIG_MSTR_PK
                    AND SCM.EZCANCELFLAG          = '0'
                    AND SCM.GLBL_CMPY_CD          = MNM.T_GLBL_CMPY_CD
                    AND SCM.MDL_ID                = MNM.T_MDL_ID
                    AND MNM.EZCANCELFLAG          = '0'
                UNION
                SELECT
                     SMM.SER_NUM                 AS SER_NUM
                    ,MNM.T_MDL_ID                AS MDL_ID
                    ,MNM.T_MDL_NM                AS MDL_NM
                    ,CRE.UPLFT_BASE_PRC_UP_RATIO AS PRC_UP_RATIO
                    ,CRE.DS_CONTR_MACH_LVL_NUM   AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_UPLFT_TP    UTP
                    ,SVC_MACH_MSTR     SMM
                    ,SVC_CONFIG_MSTR   SCM
                    ,MDL_NM            MNM
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CRE.DS_CONTR_DTL_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl3#
                    AND CRE.DS_CONTR_BASE_USG_NM  = #dsContrBaseUsgNm#
                    AND CRE.EZCANCELFLAG          = '0'
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.UPLFT_PCY_DT          IS NOT NULL
                    <!-- END 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.GLBL_CMPY_CD          = UTP.GLBL_CMPY_CD
                    AND CRE.CONTR_UPLFT_TP_CD     = UTP.CONTR_UPLFT_TP_CD
                    AND UTP.UPLFT_BASE_FLG        = 'Y'
                    AND UTP.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = SMM.GLBL_CMPY_CD
                    AND DCD.SVC_MACH_MSTR_PK      = SMM.SVC_MACH_MSTR_PK
                    AND SMM.EZCANCELFLAG          = '0'
                    AND SMM.GLBL_CMPY_CD          = SCM.GLBL_CMPY_CD
                    AND SMM.SVC_CONFIG_MSTR_PK    = SCM.SVC_CONFIG_MSTR_PK
                    AND SCM.EZCANCELFLAG          = '0'
                    AND SCM.GLBL_CMPY_CD          = MNM.T_GLBL_CMPY_CD
                    AND SCM.MDL_ID                = MNM.T_MDL_ID
                    AND MNM.EZCANCELFLAG          = '0'
                ORDER BY
                    DS_CONTR_MACH_LVL_NUM DESC
            ) X
        WHERE
            ROWNUM = 1
    </statement>
    <statement id="getRegAndAggUsg" parameterClass="Map" resultClass="Map">
        SELECT
             X.SER_NUM
            ,X.MDL_ID
            ,X.MDL_NM
            ,X.PRC_UP_RATIO
        FROM
            (
                SELECT
                     SMM.SER_NUM                 AS SER_NUM
                    ,MNM.T_MDL_ID                AS MDL_ID
                    ,MNM.T_MDL_NM                AS MDL_NM
                    ,CRE.UPLFT_MTR_PRC_UP_RATIO  AS PRC_UP_RATIO
                    ,CRE.DS_CONTR_MACH_LVL_NUM   AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_BLLG_MTR CBM
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_UPLFT_TP    UTP
                    ,SVC_MACH_MSTR     SMM
                    ,SVC_CONFIG_MSTR   SCM
                    ,MDL_NM            MNM
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CBM.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CBM.DS_CONTR_DTL_PK
                    AND CBM.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
                    AND CBM.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_PK           = CRE.DS_CONTR_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl1#
                    AND CRE.EZCANCELFLAG          = '0'
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.UPLFT_PCY_DT          IS NOT NULL
                    <!-- END 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.GLBL_CMPY_CD          = UTP.GLBL_CMPY_CD
                    AND CRE.CONTR_UPLFT_TP_CD     = UTP.CONTR_UPLFT_TP_CD
                    AND UTP.UPLFT_USG_FLG         = 'Y'
                    AND UTP.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = SMM.GLBL_CMPY_CD
                    AND DCD.SVC_MACH_MSTR_PK      = SMM.SVC_MACH_MSTR_PK
                    AND SMM.EZCANCELFLAG          = '0'
                    AND SMM.GLBL_CMPY_CD          = SCM.GLBL_CMPY_CD
                    AND SMM.SVC_CONFIG_MSTR_PK    = SCM.SVC_CONFIG_MSTR_PK
                    AND SCM.EZCANCELFLAG          = '0'
                    AND SCM.GLBL_CMPY_CD          = MNM.T_GLBL_CMPY_CD
                    AND SCM.MDL_ID                = MNM.T_MDL_ID
                    AND MNM.EZCANCELFLAG          = '0'
                UNION
                SELECT
                     SMM.SER_NUM                 AS SER_NUM
                    ,MNM.T_MDL_ID                AS MDL_ID
                    ,MNM.T_MDL_NM                AS MDL_NM
                    ,CRE.UPLFT_MTR_PRC_UP_RATIO  AS PRC_UP_RATIO
                    ,CRE.DS_CONTR_MACH_LVL_NUM   AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_BLLG_MTR CBM
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_UPLFT_TP    UTP
                    ,SVC_MACH_MSTR     SMM
                    ,SVC_CONFIG_MSTR   SCM
                    ,MDL_NM            MNM
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CBM.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CBM.DS_CONTR_DTL_PK
                    AND CBM.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
                    AND CBM.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CRE.DS_CONTR_DTL_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl2#
                    AND CRE.EZCANCELFLAG          = '0'
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.UPLFT_PCY_DT          IS NOT NULL
                    <!-- END 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.GLBL_CMPY_CD          = UTP.GLBL_CMPY_CD
                    AND CRE.CONTR_UPLFT_TP_CD     = UTP.CONTR_UPLFT_TP_CD
                    AND UTP.UPLFT_USG_FLG         = 'Y'
                    AND UTP.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = SMM.GLBL_CMPY_CD
                    AND DCD.SVC_MACH_MSTR_PK      = SMM.SVC_MACH_MSTR_PK
                    AND SMM.EZCANCELFLAG          = '0'
                    AND SMM.GLBL_CMPY_CD          = SCM.GLBL_CMPY_CD
                    AND SMM.SVC_CONFIG_MSTR_PK    = SCM.SVC_CONFIG_MSTR_PK
                    AND SCM.EZCANCELFLAG          = '0'
                    AND SCM.GLBL_CMPY_CD          = MNM.T_GLBL_CMPY_CD
                    AND SCM.MDL_ID                = MNM.T_MDL_ID
                    AND MNM.EZCANCELFLAG          = '0'
                UNION
                SELECT
                     SMM.SER_NUM                 AS SER_NUM
                    ,MNM.T_MDL_ID                AS MDL_ID
                    ,MNM.T_MDL_NM                AS MDL_NM
                    ,CRE.UPLFT_MTR_PRC_UP_RATIO  AS PRC_UP_RATIO
                    ,CRE.DS_CONTR_MACH_LVL_NUM   AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_BLLG_MTR CBM
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_UPLFT_TP    UTP
                    ,SVC_MACH_MSTR     SMM
                    ,SVC_CONFIG_MSTR   SCM
                    ,MDL_NM            MNM
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CBM.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CBM.DS_CONTR_DTL_PK
                    AND CBM.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
                    AND CBM.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CRE.DS_CONTR_DTL_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl3#
                    AND CRE.DS_CONTR_BASE_USG_NM  = #dsContrBaseUsgNm#
                    AND CRE.EZCANCELFLAG          = '0'
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.UPLFT_PCY_DT          IS NOT NULL
                    <!-- END 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.GLBL_CMPY_CD          = UTP.GLBL_CMPY_CD
                    AND CRE.CONTR_UPLFT_TP_CD     = UTP.CONTR_UPLFT_TP_CD
                    AND UTP.UPLFT_USG_FLG         = 'Y'
                    AND UTP.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = SMM.GLBL_CMPY_CD
                    AND DCD.SVC_MACH_MSTR_PK      = SMM.SVC_MACH_MSTR_PK
                    AND SMM.EZCANCELFLAG          = '0'
                    AND SMM.GLBL_CMPY_CD          = SCM.GLBL_CMPY_CD
                    AND SMM.SVC_CONFIG_MSTR_PK    = SCM.SVC_CONFIG_MSTR_PK
                    AND SCM.EZCANCELFLAG          = '0'
                    AND SCM.GLBL_CMPY_CD          = MNM.T_GLBL_CMPY_CD
                    AND SCM.MDL_ID                = MNM.T_MDL_ID
                    AND MNM.EZCANCELFLAG          = '0'
                ORDER BY
                    DS_CONTR_MACH_LVL_NUM DESC
            ) X
        WHERE
            ROWNUM = 1
    </statement>
    <statement id="getFltBase" parameterClass="Map" resultClass="Map">
        SELECT
            X.PRC_UP_RATIO
        FROM
            (
                SELECT
                     CRE.UPLFT_BASE_PRC_UP_RATIO AS PRC_UP_RATIO
                    ,CRE.DS_CONTR_MACH_LVL_NUM   AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_UPLFT_TP    UTP
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_PK           = CRE.DS_CONTR_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl1#
                    AND CRE.EZCANCELFLAG          = '0'
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.UPLFT_PCY_DT          IS NOT NULL
                    <!-- END 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.GLBL_CMPY_CD          = UTP.GLBL_CMPY_CD
                    AND CRE.CONTR_UPLFT_TP_CD     = UTP.CONTR_UPLFT_TP_CD
                    AND UTP.UPLFT_BASE_FLG        = 'Y'
                    AND UTP.EZCANCELFLAG          = '0'
                UNION
                SELECT
                     CRE.UPLFT_BASE_PRC_UP_RATIO AS PRC_UP_RATIO
                    ,CRE.DS_CONTR_MACH_LVL_NUM   AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_UPLFT_TP    UTP
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CRE.DS_CONTR_DTL_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl2#
                    AND CRE.EZCANCELFLAG          = '0'
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.UPLFT_PCY_DT          IS NOT NULL
                    <!-- END 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.GLBL_CMPY_CD          = UTP.GLBL_CMPY_CD
                    AND CRE.CONTR_UPLFT_TP_CD     = UTP.CONTR_UPLFT_TP_CD
                    AND UTP.UPLFT_BASE_FLG        = 'Y'
                    AND UTP.EZCANCELFLAG          = '0'
                UNION
                SELECT
                     CRE.UPLFT_BASE_PRC_UP_RATIO AS PRC_UP_RATIO
                    ,CRE.DS_CONTR_MACH_LVL_NUM   AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_UPLFT_TP    UTP
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CRE.DS_CONTR_DTL_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl3#
                    AND CRE.DS_CONTR_BASE_USG_NM  = #dsContrBaseUsgNm#
                    AND CRE.EZCANCELFLAG          = '0'
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.UPLFT_PCY_DT          IS NOT NULL
                    <!-- END 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.GLBL_CMPY_CD          = UTP.GLBL_CMPY_CD
                    AND CRE.CONTR_UPLFT_TP_CD     = UTP.CONTR_UPLFT_TP_CD
                    AND UTP.UPLFT_BASE_FLG        = 'Y'
                    AND UTP.EZCANCELFLAG          = '0'
                ORDER BY
                    DS_CONTR_MACH_LVL_NUM DESC
            ) X
        WHERE
            ROWNUM = 1
    </statement>
    <statement id="getFltUsg" parameterClass="Map" resultClass="Map">
        SELECT
            X.PRC_UP_RATIO
        FROM
            (
                SELECT
                     CRE.UPLFT_MTR_PRC_UP_RATIO  AS PRC_UP_RATIO
                    ,CRE.DS_CONTR_MACH_LVL_NUM   AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_BLLG_MTR CBM
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_UPLFT_TP    UTP
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CBM.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CBM.DS_CONTR_DTL_PK
                    AND CBM.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
                    AND CBM.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_PK           = CRE.DS_CONTR_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl1#
                    AND CRE.EZCANCELFLAG          = '0'
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.UPLFT_PCY_DT          IS NOT NULL
                    <!-- END 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.GLBL_CMPY_CD          = UTP.GLBL_CMPY_CD
                    AND CRE.CONTR_UPLFT_TP_CD     = UTP.CONTR_UPLFT_TP_CD
                    AND UTP.UPLFT_USG_FLG         = 'Y'
                    AND UTP.EZCANCELFLAG          = '0'
                UNION
                SELECT
                     CRE.UPLFT_MTR_PRC_UP_RATIO  AS PRC_UP_RATIO
                    ,CRE.DS_CONTR_MACH_LVL_NUM   AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_BLLG_MTR CBM
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_UPLFT_TP    UTP
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CBM.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CBM.DS_CONTR_DTL_PK
                    AND CBM.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
                    AND CBM.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CRE.DS_CONTR_DTL_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl2#
                    AND CRE.EZCANCELFLAG          = '0'
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.UPLFT_PCY_DT          IS NOT NULL
                    <!-- END 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.GLBL_CMPY_CD          = UTP.GLBL_CMPY_CD
                    AND CRE.CONTR_UPLFT_TP_CD     = UTP.CONTR_UPLFT_TP_CD
                    AND UTP.UPLFT_USG_FLG         = 'Y'
                    AND UTP.EZCANCELFLAG          = '0'
                UNION
                SELECT
                     CRE.UPLFT_MTR_PRC_UP_RATIO  AS PRC_UP_RATIO
                    ,CRE.DS_CONTR_MACH_LVL_NUM   AS DS_CONTR_MACH_LVL_NUM
                FROM
                     DS_CONTR_DTL      DCD
                    ,DS_CONTR_BLLG_MTR CBM
                    ,DS_CONTR_RNW_ESCL CRE
                    ,CONTR_UPLFT_TP    UTP
                WHERE
                        DCD.GLBL_CMPY_CD          = #glblCmpyCd#
                    AND DCD.DS_CONTR_DTL_PK       = #dsContrDtlPk#
                    AND DCD.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CBM.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CBM.DS_CONTR_DTL_PK
                    AND CBM.DS_CONTR_BLLG_MTR_PK  = #dsContrBllgMtrPk#
                    AND CBM.EZCANCELFLAG          = '0'
                    AND DCD.GLBL_CMPY_CD          = CRE.GLBL_CMPY_CD
                    AND DCD.DS_CONTR_DTL_PK       = CRE.DS_CONTR_DTL_PK
                    AND CRE.DS_CONTR_MACH_LVL_NUM = #dsContrMachLvl3#
                    AND CRE.DS_CONTR_BASE_USG_NM  = #dsContrBaseUsgNm#
                    AND CRE.EZCANCELFLAG          = '0'
                    <!-- START 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.UPLFT_PCY_DT          IS NOT NULL
                    <!-- END 2018/11/29 T.Tomita [QC#28638, ADD] -->
                    AND CRE.GLBL_CMPY_CD          = UTP.GLBL_CMPY_CD
                    AND CRE.CONTR_UPLFT_TP_CD     = UTP.CONTR_UPLFT_TP_CD
                    AND UTP.UPLFT_USG_FLG         = 'Y'
                    AND UTP.EZCANCELFLAG          = '0'
                ORDER BY
                    DS_CONTR_MACH_LVL_NUM DESC
            ) X
        WHERE
            ROWNUM = 1
    </statement>
<!-- END 2017/02/10 K.Kitachi [QC#17410, ADD] -->

<!-- START 2017/08/24 E.Kameishi [QC#8661,ADD] -->
    <statement id="getAnnLtrCtrlInfo" parameterClass="Map" resultClass="BigDecimal">
        SELECT
             COUNT(*)
        FROM
             DS_CONTR_DTL          DCD
            ,DS_CONTR              DC
            ,SVC_RG_BR_RELN        SRBR
            ,RNW_ESCL_LTR_CTRL     RELC
        WHERE
                DCD.GLBL_CMPY_CD      = #glblCmpyCd#
            AND DCD.DS_CONTR_DTL_PK   = #dsContrDtlPk#
            AND DCD.DS_CONTR_PK       = DC.DS_CONTR_PK
            AND DCD.GLBL_CMPY_CD      = DC.GLBL_CMPY_CD
            AND DC.GLBL_CMPY_CD       = SRBR.GLBL_CMPY_CD
            AND DC.SVC_CONTR_BR_CD    = SRBR.SVC_CONTR_BR_CD
            AND DC.GLBL_CMPY_CD       = RELC.GLBL_CMPY_CD
            AND DC.SVC_LINE_BIZ_CD    = RELC.SVC_LINE_BIZ_CD
            AND DC.SVC_CONTR_BR_CD    = RELC.SVC_CONTR_BR_CD
            AND SRBR.SVC_RG_PK        = RELC.SVC_RG_PK
            <!-- START 2023/04/13 E.Sanchez [QC#61394, MOD] -->
            <!-- AND RELC.RNW_LTR_FLG      = 'Y' -->
            AND RELC.ANN_ESCL_LTR_FLG = 'Y'
            <!-- END 2023/04/13 E.Sanchez [QC#61394, MOD] -->
            AND DCD.EZCANCELFLAG      = '0'
            AND DC.EZCANCELFLAG       = '0'
            AND SRBR.EZCANCELFLAG     = '0'
            AND RELC.EZCANCELFLAG     = '0'
    </statement>
    <statement id="getAnnEscLtrWrkList" parameterClass="Map" resultClass="Map">
        SELECT DISTINCT
             DCD.DS_CONTR_PK
            ,DCD.DS_CONTR_DTL_PK
            ,DC.DS_CONTR_NUM
            ,RELC.PRINT_OLD_PRC_FLG 
        FROM
             DS_CONTR_PRC_CHNG_REC DCPCR
            ,DS_CONTR_DTL          DCD
            ,DS_CONTR              DC
            ,SVC_RG_BR_RELN        SRBR
            ,RNW_ESCL_LTR_CTRL     RELC
        WHERE
                DCPCR.GLBL_CMPY_CD    = #glblCmpyCd#
            AND DCPCR.UPLFT_EFF_FROM_DT &gt;= #slsDt#
            AND DCPCR.EIP_RPT_RQST_DT IS NULL
            AND DCPCR.GLBL_CMPY_CD    = DCD.GLBL_CMPY_CD
            AND DCPCR.DS_CONTR_DTL_PK = DCD.DS_CONTR_DTL_PK
            AND DCD.GLBL_CMPY_CD      = DC.GLBL_CMPY_CD
            AND DCD.DS_CONTR_PK       = DC.DS_CONTR_PK
            AND DC.GLBL_CMPY_CD       = SRBR.GLBL_CMPY_CD
            AND DC.SVC_CONTR_BR_CD    = SRBR.SVC_CONTR_BR_CD
            AND DC.GLBL_CMPY_CD       = RELC.GLBL_CMPY_CD
            AND DC.SVC_LINE_BIZ_CD    = RELC.SVC_LINE_BIZ_CD
            AND DC.SVC_CONTR_BR_CD    = RELC.SVC_CONTR_BR_CD
            AND SRBR.SVC_RG_PK        = RELC.SVC_RG_PK
            AND RELC.ANN_ESCL_LTR_FLG = 'Y'
            AND DCPCR.EZCANCELFLAG    = '0'
            AND DCD.EZCANCELFLAG      = '0'
            AND DC.EZCANCELFLAG       = '0'
            AND SRBR.EZCANCELFLAG     = '0'
            AND RELC.EZCANCELFLAG     = '0'
        ORDER BY
             DCD.DS_CONTR_PK
            ,DCD.DS_CONTR_DTL_PK
     </statement>
<!-- START 2017/08/24 E.Kameishi [QC#8661,ADD] -->

<!-- START 2017/08/28 K.Kitachi [QC#20529, ADD] -->
    <statement id="getTotBasePrcForAggLine" parameterClass="Map" resultClass="Map">
        SELECT
             SUM(C.BASE_PRC_DEAL_AMT)           AS BASE_PRC_DEAL_AMT
            ,SUM(C.BASE_PRC_TERM_DEAL_AMT_RATE) AS BASE_PRC_TERM_DEAL_AMT_RATE
        FROM
             DS_CONTR_DTL           A
            ,DS_CONTR_DTL_TP        B
            ,DS_CONTR_PRC_EFF       C
            ,DS_CONTR_PRC_EFF_STS_V D
        WHERE
                A.GLBL_CMPY_CD                 = #glblCmpyCd#
            AND A.DS_CONTR_PK                  = #dsContrPk#
            AND A.DS_CONTR_DTL_TP_CD    &lt;&gt; #dsContrDtlTpCd#
            AND A.EZCANCELFLAG                 = '0'
            AND A.GLBL_CMPY_CD                 = B.GLBL_CMPY_CD
            AND A.DS_CONTR_DTL_TP_CD           = B.DS_CONTR_DTL_TP_CD
            AND B.BASE_CHRG_FLG                = 'Y'
            AND B.EZCANCELFLAG                 = '0'
            AND A.GLBL_CMPY_CD                 = C.GLBL_CMPY_CD
            AND A.DS_CONTR_DTL_PK              = C.DS_CONTR_DTL_PK
            AND C.CONTR_PRC_EFF_FROM_DT    &lt;= #effFromDt#
            AND C.CONTR_PRC_EFF_THRU_DT    &gt;= #effFromDt#
            AND C.EZCANCELFLAG                 = '0'
            AND C.GLBL_CMPY_CD                 = D.GLBL_CMPY_CD
            AND C.DS_CONTR_PRC_EFF_PK          = D.DS_CONTR_PRC_EFF_PK
            AND D.DS_CONTR_CTRL_STS_CD  &lt;&gt; #dsContrCtrlStsCd#
            AND D.EZCANCELFLAG                 = '0'
    </statement>
<!-- END 2017/08/28 K.Kitachi [QC#20529, ADD] -->
<!-- START 2018/11/21 T.Tomita [QC#28638, ADD] -->
    <statement id="getMaxPrcUpRato" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            Z.MAX_PRC_UP_RATIO
        FROM (
            SELECT
                 A.MAX_PRC_UP_RATIO       AS MAX_PRC_UP_RATIO
                ,A.DS_CONTR_MACH_LVL_NUM  AS DS_CONTR_MACH_LVL_NUM
            FROM
                 DS_CONTR_RNW_ESCL       A
                ,DS_CONTR                B
                ,DS_CONTR_INTFC_DEF_RULE C
                ,CONTR_UPLFT_TP          D
            WHERE
                A.GLBL_CMPY_CD          =  #glblCmpyCd#
            AND A.EZCANCELFLAG          =  '0'
            AND A.DS_CONTR_PK           =  #dsContrPk#
            AND A.DS_CONTR_MACH_LVL_NUM =  #dsContrMachLvlNum1#
            AND A.GLBL_CMPY_CD          =  B.GLBL_CMPY_CD
            AND A.DS_CONTR_PK           =  B.DS_CONTR_PK
            AND B.EZCANCELFLAG          =  '0'
            AND B.GLBL_CMPY_CD          =  C.GLBL_CMPY_CD          (+)
            AND B.DS_CONTR_SRC_TP_CD    =  C.CONTR_INTFC_SRC_TP_CD (+)
            AND B.DS_CONTR_CLS_CD       =  C.DS_CONTR_CLS_CD       (+)
            AND B.SVC_LINE_BIZ_CD       =  C.SVC_LINE_BIZ_CD       (+)
            AND C.EZCANCELFLAG      (+) =  '0'
            AND C.EFF_FROM_DT       (+) &lt;= #slsDt#
            AND C.ENBL_FLG          (+) =  'Y'
            AND A.UPLFT_PCY_DT          &lt;= TO_CHAR(TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(A.UPLFT_BEF_END_RNW_DAYS_AOT, C.BEF_END_UPLFT_DAYS_AOT, 1), 'YYYYMMDD')
            AND A.GLBL_CMPY_CD          = D.GLBL_CMPY_CD
            AND A.CONTR_UPLFT_TP_CD     = D.CONTR_UPLFT_TP_CD
            AND D.EZCANCELFLAG          = '0'
            <isEqual property="dsContrBaseUsgNm" compareValue="BASE">
            AND D.UPLFT_BASE_FLG        = 'Y'
            </isEqual>
            <isEqual property="dsContrBaseUsgNm" compareValue="OVERAGE">
            AND D.UPLFT_USG_FLG         = 'Y'
            </isEqual>
            <!-- START 2023/04/21 R.Jin [QC#59586,ADD] -->
            AND A.MAX_PRC_UP_RATIO IS NOT NULL
            <!-- END 2023/04/21 R.Jin [QC#59586,ADD] -->
            UNION
            SELECT
                 A.MAX_PRC_UP_RATIO       AS MAX_PRC_UP_RATIO
                ,A.DS_CONTR_MACH_LVL_NUM  AS DS_CONTR_MACH_LVL_NUM
            FROM
                 DS_CONTR_RNW_ESCL       A
                ,DS_CONTR                B
                ,DS_CONTR_INTFC_DEF_RULE C
                ,CONTR_UPLFT_TP          D
            WHERE
                A.GLBL_CMPY_CD          =  #glblCmpyCd#
            AND A.EZCANCELFLAG          =  '0'
            AND A.DS_CONTR_PK           =  #dsContrPk#
            AND A.DS_CONTR_DTL_PK       =  #dsContrDtlPk#
            AND A.DS_CONTR_MACH_LVL_NUM =  #dsContrMachLvlNum2#
            AND A.GLBL_CMPY_CD          =  B.GLBL_CMPY_CD
            AND A.DS_CONTR_PK           =  B.DS_CONTR_PK
            AND B.EZCANCELFLAG          =  '0'
            AND B.GLBL_CMPY_CD          =  C.GLBL_CMPY_CD          (+)
            AND B.DS_CONTR_SRC_TP_CD    =  C.CONTR_INTFC_SRC_TP_CD (+)
            AND B.DS_CONTR_CLS_CD       =  C.DS_CONTR_CLS_CD       (+)
            AND B.SVC_LINE_BIZ_CD       =  C.SVC_LINE_BIZ_CD       (+)
            AND C.EZCANCELFLAG      (+) =  '0'
            AND C.EFF_FROM_DT       (+) &lt;= #slsDt#
            AND C.ENBL_FLG          (+) =  'Y'
            AND A.UPLFT_PCY_DT          &lt;= TO_CHAR(TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(A.UPLFT_BEF_END_RNW_DAYS_AOT, C.BEF_END_UPLFT_DAYS_AOT, 1), 'YYYYMMDD')
            AND A.GLBL_CMPY_CD          = D.GLBL_CMPY_CD
            AND A.CONTR_UPLFT_TP_CD     = D.CONTR_UPLFT_TP_CD
            AND D.EZCANCELFLAG          = '0'
            <isEqual property="dsContrBaseUsgNm" compareValue="BASE">
            AND D.UPLFT_BASE_FLG        = 'Y'
            </isEqual>
            <isEqual property="dsContrBaseUsgNm" compareValue="OVERAGE">
            AND D.UPLFT_USG_FLG         = 'Y'
            </isEqual>
            <!-- START 2023/04/21 R.Jin [QC#59586,ADD] -->
            AND A.MAX_PRC_UP_RATIO IS NOT NULL
            <!-- END 2023/04/21 R.Jin [QC#59586,ADD] -->
            UNION
            SELECT
                 A.MAX_PRC_UP_RATIO       AS MAX_PRC_UP_RATIO
                ,A.DS_CONTR_MACH_LVL_NUM  AS DS_CONTR_MACH_LVL_NUM
            FROM
                 DS_CONTR_RNW_ESCL       A
                ,DS_CONTR                B
                ,DS_CONTR_INTFC_DEF_RULE C
                ,CONTR_UPLFT_TP          D
            WHERE
                A.GLBL_CMPY_CD          =  #glblCmpyCd#
            AND A.EZCANCELFLAG          =  '0'
            AND A.DS_CONTR_PK           =  #dsContrPk#
            AND A.DS_CONTR_DTL_PK       =  #dsContrDtlPk#
            AND A.DS_CONTR_MACH_LVL_NUM =  #dsContrMachLvlNum3#
            AND A.DS_CONTR_BASE_USG_NM  =  #dsContrBaseUsgNm#
            AND A.GLBL_CMPY_CD          =  B.GLBL_CMPY_CD
            AND A.DS_CONTR_PK           =  B.DS_CONTR_PK
            AND B.EZCANCELFLAG          =  '0'
            AND B.GLBL_CMPY_CD          =  C.GLBL_CMPY_CD          (+)
            AND B.DS_CONTR_SRC_TP_CD    =  C.CONTR_INTFC_SRC_TP_CD (+)
            AND B.DS_CONTR_CLS_CD       =  C.DS_CONTR_CLS_CD       (+)
            AND B.SVC_LINE_BIZ_CD       =  C.SVC_LINE_BIZ_CD       (+)
            AND C.EZCANCELFLAG      (+) =  '0'
            AND C.EFF_FROM_DT       (+) &lt;= #slsDt#
            AND C.ENBL_FLG          (+) =  'Y'
            AND A.UPLFT_PCY_DT          &lt;= TO_CHAR(TO_DATE(#slsDt#, 'YYYYMMDD') + COALESCE(A.UPLFT_BEF_END_RNW_DAYS_AOT, C.BEF_END_UPLFT_DAYS_AOT, 1), 'YYYYMMDD')
            AND A.GLBL_CMPY_CD          = D.GLBL_CMPY_CD
            AND A.CONTR_UPLFT_TP_CD     = D.CONTR_UPLFT_TP_CD
            AND D.EZCANCELFLAG          = '0'
            <isEqual property="dsContrBaseUsgNm" compareValue="BASE">
            AND D.UPLFT_BASE_FLG        = 'Y'
            </isEqual>
            <isEqual property="dsContrBaseUsgNm" compareValue="OVERAGE">
            AND D.UPLFT_USG_FLG         = 'Y'
            </isEqual>
            <!-- START 2023/04/21 R.Jin [QC#59586,ADD] -->
            AND A.MAX_PRC_UP_RATIO IS NOT NULL
            <!-- END 2023/04/21 R.Jin [QC#59586,ADD] -->
            ORDER BY
                DS_CONTR_MACH_LVL_NUM DESC
        ) Z
        WHERE
            ROWNUM = 1
    </statement>
<!-- END 2018/11/21 T.Tomita [QC#28638, ADD] -->
<!-- add start 2019/07/25 QC#52070 -->
    <statement id="getInvoicedSchdCount" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            COUNT(*)
        FROM
            DS_CONTR_BLLG_SCHD   A
        WHERE
                A.GLBL_CMPY_CD       = #glblCmpyCd#
            AND A.DS_CONTR_DTL_PK    = #dsContrDtlPk#
            <!-- START 2022/12/05 E.Sanchez [QC#60807, MOD] -->
            <!-- AND A.BLLG_SCHD_FROM_DT  &gt;= #effFromDt# -->
            AND (A.BLLG_SCHD_FROM_DT         &gt;= #effFromDt#
                 OR (A.BLLG_SCHD_FROM_DT     &lt;= #effFromDt# 
                     AND A.BLLG_SCHD_THRU_DT &gt;= #effFromDt#)
            )
            <!-- END 2022/12/05 E.Sanchez [QC#60807, MOD] -->
            <isNotNull property="baseChrgFlg">
            AND A.BASE_CHRG_FLG      = #baseChrgFlg#
            </isNotNull>
            <isNotNull property="usgChrgFlg">
            AND A.USG_CHRG_FLG       = #usgChrgFlg#
            </isNotNull>
            AND A.INV_FLG            = 'Y'
            AND A.EZCANCELFLAG       = '0'
    </statement>
<!-- add end 2019/07/25 QC#52070 -->
<!-- add start 2019/08/15 QC#52413 -->
    <statement id="getDsContrRnwEsclList" parameterClass="Map" resultClass="Map">
<!-- START 2023/04/21 R.Jin [QC#59586,MOD] -->
        <isEqual property="lastRowFlg" compareValue="1">
        SELECT
             A.DS_CONTR_RNW_ESCL_PK
            ,A.DS_CONTR_MACH_LVL_NUM
            ,A.UPLFT_PCY_DT
            ,TO_CHAR(ADD_MONTHS(TO_DATE(A.UPLFT_PCY_DT, 'YYYYMMDD'), 12),  'YYYYMMDD') NEXT_UPLFT_PCY_DT
        FROM
             DS_CONTR_RNW_ESCL       A
            ,CONTR_UPLFT_TP          B
        WHERE
                A.GLBL_CMPY_CD          =  #glblCmpyCd#
            AND A.DS_CONTR_PK           =  #dsContrPk#
            AND A.DS_CONTR_MACH_LVL_NUM =  #dsContrMachLvlNum1#
            AND A.CONTR_UPLFT_TP_CD     =  #contrUplftTpCd#
            AND A.UPLFT_PCY_DT          =  #uplftPcyDt#
            AND A.EZCANCELFLAG          =  '0'
            AND A.GLBL_CMPY_CD          =  B.GLBL_CMPY_CD
            AND A.CONTR_UPLFT_TP_CD     =  B.CONTR_UPLFT_TP_CD
            AND B.EZCANCELFLAG          =  '0'
            <isEqual property="dsContrBaseUsgNm" compareValue="BASE">
            AND B.UPLFT_BASE_FLG        =  'Y'
            </isEqual>
            <isEqual property="dsContrBaseUsgNm" compareValue="OVERAGE">
            AND B.UPLFT_USG_FLG         =  'Y'
            </isEqual>
        UNION
        </isEqual>
<!-- END 2023/04/21 R.Jin [QC#59586,MOD] -->
        SELECT
             A.DS_CONTR_RNW_ESCL_PK
            ,A.DS_CONTR_MACH_LVL_NUM
            ,A.UPLFT_PCY_DT
            ,TO_CHAR(ADD_MONTHS(TO_DATE(A.UPLFT_PCY_DT, 'YYYYMMDD'), 12),  'YYYYMMDD') NEXT_UPLFT_PCY_DT
        FROM
             DS_CONTR_RNW_ESCL       A
            ,CONTR_UPLFT_TP          B
        WHERE
                A.GLBL_CMPY_CD          =  #glblCmpyCd#
            AND A.DS_CONTR_PK           =  #dsContrPk#
            AND A.DS_CONTR_DTL_PK       =  #dsContrDtlPk#
            AND A.DS_CONTR_MACH_LVL_NUM =  #dsContrMachLvlNum2#
            AND A.CONTR_UPLFT_TP_CD     =  #contrUplftTpCd#
            AND A.UPLFT_PCY_DT          =  #uplftPcyDt#
            AND A.EZCANCELFLAG          =  '0'
            AND A.GLBL_CMPY_CD          =  B.GLBL_CMPY_CD
            AND A.CONTR_UPLFT_TP_CD     =  B.CONTR_UPLFT_TP_CD
            AND B.EZCANCELFLAG          =  '0'
            <isEqual property="dsContrBaseUsgNm" compareValue="BASE">
            AND B.UPLFT_BASE_FLG        =  'Y'
            </isEqual>
            <isEqual property="dsContrBaseUsgNm" compareValue="OVERAGE">
            AND B.UPLFT_USG_FLG         =  'Y'
            </isEqual>
        UNION
        SELECT
             A.DS_CONTR_RNW_ESCL_PK
            ,A.DS_CONTR_MACH_LVL_NUM
            ,A.UPLFT_PCY_DT
            ,TO_CHAR(ADD_MONTHS(TO_DATE(A.UPLFT_PCY_DT, 'YYYYMMDD'), 12),  'YYYYMMDD') NEXT_UPLFT_PCY_DT
        FROM
             DS_CONTR_RNW_ESCL       A
            ,CONTR_UPLFT_TP          B
        WHERE
                A.GLBL_CMPY_CD          =  #glblCmpyCd#
            AND A.DS_CONTR_PK           =  #dsContrPk#
            AND A.DS_CONTR_DTL_PK       =  #dsContrDtlPk#
            AND A.DS_CONTR_MACH_LVL_NUM =  #dsContrMachLvlNum3#
            AND A.DS_CONTR_BASE_USG_NM  =  #dsContrBaseUsgNm#
            AND A.CONTR_UPLFT_TP_CD     =  #contrUplftTpCd#
            AND A.UPLFT_PCY_DT          =  #uplftPcyDt#
            AND A.EZCANCELFLAG          =  '0'
            AND A.GLBL_CMPY_CD          =  B.GLBL_CMPY_CD
            AND A.CONTR_UPLFT_TP_CD     =  B.CONTR_UPLFT_TP_CD
            AND B.EZCANCELFLAG          =  '0'
            <isEqual property="dsContrBaseUsgNm" compareValue="BASE">
            AND B.UPLFT_BASE_FLG        =  'Y'
            </isEqual>
            <isEqual property="dsContrBaseUsgNm" compareValue="OVERAGE">
            AND B.UPLFT_USG_FLG         =  'Y'
            </isEqual>
     </statement>
<!-- add end 2019/08/15 QC#52413 -->
<!-- START 2022/12/05 E.Sanchez [QC#60807, MOD] -->
    <statement id="getMachSerNum" parameterClass="Map" resultClass="String">
        SELECT
            A.SER_NUM
        FROM
            SVC_MACH_MSTR A
        WHERE
                A.EZCANCELFLAG         = '0'
            AND A.GLBL_CMPY_CD         = #glblCmpyCd#
            AND A.SVC_MACH_MSTR_PK     = #svcMachMstrPk#
    </statement>
<!-- END 2022/12/05 E.Sanchez [QC#60807, MOD] -->
</sqlMap>
