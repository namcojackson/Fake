<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="NFBB134001">

    <statement id="getTargetPoDtl" parameterClass="Map" resultClass="Map">
        SELECT
             A.PO_ORD_NUM
            ,A.PO_ORD_DTL_LINE_NUM
        FROM
            PO_DTL    A
        WHERE
                A.GLBL_CMPY_CD        = #glblCmpyCd#
            <iterate property="poLineStsCdList" var="poLineStsCd[]" open="AND A.PO_LINE_STS_CD IN (" close=")" conjunction= "," >
                #poLineStsCd[]#
            </iterate>
            AND A.PO_MDSE_CMPSN_TP_CD = #poMdseCmpsnTpRegular#
            AND A.EZCANCELFLAG        = '0'
            AND NOT EXISTS (
                    SELECT
                        1
                    FROM
                         RWS_HDR  X
                        ,RWS_DTL  Y
                        ,RWS_STS  Z
                    WHERE
                            X.GLBL_CMPY_CD        = A.GLBL_CMPY_CD
                        AND X.PO_RCV_TRX_HDR_NUM  = A.PO_ORD_NUM
                        AND X.EZCANCELFLAG        = '0'
                        AND X.GLBL_CMPY_CD        = Y.GLBL_CMPY_CD
                        AND X.RWS_NUM             = Y.RWS_NUM
                        AND Y.PO_RCV_TRX_LINE_NUM = A.PO_ORD_DTL_LINE_NUM
                        AND Y.EZCANCELFLAG        = '0'
                        AND Y.GLBL_CMPY_CD        = Z.GLBL_CMPY_CD
                        AND Y.RWS_STS_CD          = Z.RWS_STS_CD
                        AND Z.RWS_OPEN_FLG        = #flgOnY#
                        AND Z.EZCANCELFLAG        = '0'
                )
            AND EXISTS (
                    SELECT
                        1
                    FROM
                        CM_ACRL_WRITE_OFF X
                    WHERE
                            X.GLBL_CMPY_CD        = A.GLBL_CMPY_CD
                        AND X.PO_NUM              = A.PO_ORD_NUM
                        AND X.PO_ORD_DTL_LINE_NUM = A.PO_ORD_DTL_LINE_NUM
                        AND X.WRT_OFF_FLG         = #flgOnY#
                        <iterate property="coaAcctCdList" var="coaAcctCd[]" open="AND X.COA_ACCT_CD IN (" close=")" conjunction= "," >
                            #coaAcctCd[]#
                        </iterate>
                        AND X.AJE_CM_INTFC_TP_CD  IS NULL
                        AND TO_CHAR(TO_DATE(X.WRT_OFF_DT, #dateFormat#) + #pastDays#, #dateFormat#) &lt;= #slsDt#
                        AND X.EZCANCELFLAG        = '0'
                )
        ORDER BY
             PO_ORD_NUM
            ,PO_ORD_DTL_LINE_NUM
    </statement>
</sqlMap>
