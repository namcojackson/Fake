<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NLCB102001">
    <statement id="getInvtyTrx" parameterClass="Map" resultClass="Map">
            WITH SCUBE_MDSE_V AS (
                    SELECT
                        A1.MDSE_CD
                        ,A1.SPLY_ITEM_NUM
                        ,A1.GLBL_CMPY_CD
                        ,CPV.P_CODE_VENDR   AS CUSA_VND_CD
                    FROM
                        ASL_DTL A1
                        ,(SELECT
                            AD.GLBL_CMPY_CD
                            ,AD.ASL_DTL_PK
                            ,ROW_NUMBER() OVER (PARTITION BY AD.MDSE_CD ORDER BY NVL(AD.EFF_FROM_DT, #effFromDtDefalut#) DESC) IDX
                        FROM
                            ASL_DTL AD
                            ,PRNT_CMPY_VND PV
                        WHERE  AD.GLBL_CMPY_CD      =    PV.GLBL_CMPY_CD
                        AND    PV.PRNT_CMPY_VND_CD  =    AD.VND_CD
                        <iterate property="vndSysTpCdList" var="vndSysTpCdList[]" open="AND PV.VND_SYS_TP_CD IN (" close=")" conjunction=",">
                          #vndSysTpCdList[]#
                        </iterate>
                        AND    AD.EZCANCELFLAG      =    '0'
                        AND    PV.EZCANCELFLAG      =    '0'
                        ) A2
                        ,CSA_PRT_V     CPV
                        ,DS_COND_CONST DCC
                    WHERE  A1.GLBL_CMPY_CD          = A2.GLBL_CMPY_CD
                    AND    A1.ASL_DTL_PK            = A2.ASL_DTL_PK
                    <isNotNull property="exclMdseCdList">
                        <iterate property="exclMdseCdList" var="exclMdseCdList[]" open="AND A1.MDSE_CD NOT IN (" close=")" conjunction=",">
                        #exclMdseCdList[]#
                        </iterate> 
                    </isNotNull>
                    AND    A2.IDX                   = #numOne#
                    AND    CPV.P_PARTS_NUM          = NVL(A1.SPLY_ITEM_NUM, A1.MDSE_CD)
                    AND    CPV.P_CODE_VENDR         = DCC.DS_COND_CONST_VAL_TXT_01
                    AND    DCC.GLBL_CMPY_CD         = A1.GLBL_CMPY_CD
                    AND    DCC.DS_COND_CONST_GRP_ID = #dsCondConstGrpId#
                    AND    A1.EZCANCELFLAG          = '0'
                    AND    CPV.EZCANCELFLAG         = '0'
                    AND    DCC.EZCANCELFLAG         = '0'
            )
            SELECT
                IT.TRX_CD
               ,IT.TRX_RSN_CD
               ,IT.INVTY_LOC_CD
               ,IT.LOC_TP_CD
               ,IT.SHIP_FROM_LOC_CUST_CD
               ,IT.WHT_TO_INVTY_LOC_CD
               ,IT.SHIP_FROM_LOC_TP_CD
               ,IT.INVTY_TRX_PK
               ,IT.INVTY_TRX_DT
               ,IT.INVTY_GLBL_CMPY_CD
               ,IT.FSR_GLBL_CMPY_CD
               ,IT.MDSE_CD
               ,IT.CPO_SHPG_SVC_LVL_CD
               ,IT.CPO_CARR_CD
               ,IT.INVTY_SHPG_SVC_LVL_CD
               ,IT.SHPG_SHPG_SVC_LVL_CD
               ,IT.SHPG_TRD_PTNR_SHPG_METH_CD
               ,IT.WO_SHPG_SVC_LVL_CD
               ,IT.WO_TRD_PTNR_SHPG_METH_CD
               ,IT.INVTY_TRX_QTY
               ,IT.STK_OUT_RTL_WH_CD
               ,IT.STK_OUT_WH_OWNR_CD
               ,IT.WHT_TO_LOC_TP_CD
               ,IT.WHT_TO_CUST_CD
               ,IT.WHT_TO_RTL_WH_CD
               ,IT.WHT_TO_WH_OWNR_CD
               ,IT.DS_COND_CONST_VAL_TXT_01
               ,IT.DS_COND_CONST_VAL_TXT_02
               ,IT.DS_COND_CONST_VAL_TXT_03
               ,IT.DS_COND_CONST_VAL_TXT_04
               ,IT.DS_COND_CONST_VAL_TXT_05
               ,IT.CUSA_VND_CD
               ,IT.SHIP_FLG1
               ,IT.SHIP_FLG2
               ,IT.SHIP_FLG3
            FROM
                (SELECT
                    IT.TRX_CD
                   ,IT.TRX_RSN_CD
                   ,IT.INVTY_LOC_CD
                   ,IT.LOC_TP_CD
                   ,IT.SHIP_FROM_LOC_CUST_CD
                   ,IT.SHIP_TO_LOC_CUST_CD       AS WHT_TO_INVTY_LOC_CD
                   ,DIL1.INVTY_LOC_TP_CD         AS SHIP_FROM_LOC_TP_CD
                   ,IT.INVTY_TRX_PK
                   ,IT.INVTY_TRX_DT
                   ,GC1.GLBL_CMPY_CD              AS INVTY_GLBL_CMPY_CD
                   ,GC2.GLBL_CMPY_CD             AS FSR_GLBL_CMPY_CD
                   ,IT.MDSE_CD
                   ,SP1.REQ_SHPG_SVC_LVL_CD      AS CPO_SHPG_SVC_LVL_CD
                   ,SP1.CARR_CD                  AS CPO_CARR_CD
                   ,IOD.SHPG_SVC_LVL_CD          AS INVTY_SHPG_SVC_LVL_CD
                   ,SP2.REQ_SHPG_SVC_LVL_CD      AS SHPG_SHPG_SVC_LVL_CD
                   ,TPSXR1.TRD_PTNR_SHPG_METH_CD AS SHPG_TRD_PTNR_SHPG_METH_CD
                   ,SP3.REQ_SHPG_SVC_LVL_CD      AS WO_SHPG_SVC_LVL_CD
                   ,TPSXR2.TRD_PTNR_SHPG_METH_CD AS WO_TRD_PTNR_SHPG_METH_CD
                   ,IT.INVTY_TRX_QTY
                   ,RW1.RTL_WH_CD                AS STK_OUT_RTL_WH_CD
                   ,RW1.WH_OWNR_CD               AS STK_OUT_WH_OWNR_CD
                   ,DIL2.INVTY_LOC_TP_CD         AS WHT_TO_LOC_TP_CD
                   ,DIL2.INVTY_LOC_CD            AS WHT_TO_CUST_CD
                   ,RW2.RTL_WH_CD                AS WHT_TO_RTL_WH_CD
                   ,RW2.WH_OWNR_CD               AS WHT_TO_WH_OWNR_CD
                   ,DCC.DS_COND_CONST_VAL_TXT_01
                   ,DCC.DS_COND_CONST_VAL_TXT_02
                   ,DCC.DS_COND_CONST_VAL_TXT_03
                   ,DCC.DS_COND_CONST_VAL_TXT_04
                   ,DCC.DS_COND_CONST_VAL_TXT_05
                   ,SMV.CUSA_VND_CD
                   ,SS1.SHIP_FLG                 AS SHIP_FLG1
                   ,SS2.SHIP_FLG                 AS SHIP_FLG2
                   ,SS3.SHIP_FLG                 AS SHIP_FLG3
                FROM
                    INVTY_TRX           IT
                   ,DS_COND_CONST       DCC
                   ,DS_INVTY_LOC_V      DIL1
                   ,RTL_WH              RW1
                   ,INVTY_OWNR          IO1
                   ,SCUBE_MDSE_V        SMV
                   --OUTER JOIN 2
                   ,BILL_TO_CUST        BTC1
                   ,GLBL_CMPY           GC1
                   ,DS_INVTY_LOC_V      DIL2
                   ,RTL_WH              RW2
                   --OUTER JOIN 3
                   ,FSR                 F
                   ,BILL_TO_CUST        BTC2
                   ,GLBL_CMPY           GC2
                   --OUTER JOIN 4
                   ,SHPG_PLN            SP1
                   ,SHPG_STS            SS1
                   --OUTER JOIN 5
                   ,INVTY_ORD           IOD
                   --OUTER JOIN 6
                   ,SHPG_PLN            SP2
                   ,SHPG_STS            SS2
                   ,TRD_PTNR_SHPG_X_REF TPSXR1
                   --OUTER JOIN 7
                   ,SHPG_PLN            SP3
                   ,SHPG_STS            SS3
                   ,TRD_PTNR_SHPG_X_REF TPSXR2
                WHERE
                    IT.GLBL_CMPY_CD               =  #glblCmpyCd#
                 <isNotNull property="fromInvtyTrxDt">
                    AND IT.INVTY_TRX_DT       &gt;   #fromInvtyTrxDt#
                    AND IT.INVTY_TRX_DT       &lt;=  #toInvtyTrxDt#
                 </isNotNull>
                 <isNull property="fromInvtyTrxDt">
                    AND IT.INVTY_TRX_DT           =  #toInvtyTrxDt#
                 </isNull>
                    -- DS_COND_CONST JOIN
                    AND IT.GLBL_CMPY_CD           =  DCC.GLBL_CMPY_CD
                    AND IT.TRX_CD                 =  DCC.DS_COND_CONST_VAL_TXT_01
                    AND IT.TRX_RSN_CD             =  DCC.DS_COND_CONST_VAL_TXT_02
                    AND DCC.DS_COND_CONST_GRP_ID  =  #dsCondConstGrpIdStkOut#
                    -- DS_INVTY_LOC_V1 JOIN
                    AND IT.GLBL_CMPY_CD           =  DIL1.GLBL_CMPY_CD
                    AND IT.INVTY_LOC_CD           =  DIL1.INVTY_LOC_CD
                    <!-- Add Start 2020/02/04 QC#55572 -->
                    <isNotNull property="exclSwhCdList">
                    AND <iterate property="exclSwhCdList" var="exclSwhCdList[]" open="DIL1.RTL_SWH_CD NOT IN (" close=")" conjunction=",">
                        #exclSwhCdList[]#
                        </iterate>
                    </isNotNull>
                    <!-- Add End 2020/02/04 QC#55572 -->
                    -- RTL_WH1 JOIN
                    AND DIL1.GLBL_CMPY_CD         =  RW1.GLBL_CMPY_CD
                    AND DIL1.RTL_WH_CD            =  RW1.RTL_WH_CD
                    -- INVTY_OWNR1 JOIN
                    AND RW1.GLBL_CMPY_CD          =  IO1.GLBL_CMPY_CD
                    AND RW1.INVTY_OWNR_CD         =  IO1.INVTY_OWNR_CD
                    AND IO1.CMPY_INVTY_FLG        =  #cmpyInvtyFlg#
                    -- SCUBE_MDSE_V JOIN
                    AND IT.GLBL_CMPY_CD           =  SMV.GLBL_CMPY_CD
                    AND IT.MDSE_CD                =  SMV.MDSE_CD
                    AND NOT EXISTS (
                                SELECT
                                    1
                                FROM
                                    PRT_STK_OUT_RSLT_WRK AA1
                                WHERE
                                    AA1.GLBL_CMPY_CD    = IT.GLBL_CMPY_CD
                                AND AA1.INVTY_TRX_PK    = IT.INVTY_TRX_PK
                                AND ROWNUM              = #numOne#
                                AND AA1.EZCANCELFLAG    = '0'
                                )
                    --OUTER JOIN 2
                    AND IT.GLBL_CMPY_CD             = BTC1.GLBL_CMPY_CD         (+)
                    AND IT.BILL_TO_CUST_CD          = BTC1.BILL_TO_CUST_CD      (+)
                    AND BTC1.GLBL_CMPY_CD           = GC1.GLBL_CMPY_CD          (+)
                    AND BTC1.COA_AFFL_CD            = GC1.COA_AFFL_CD           (+)
                    AND IT.GLBL_CMPY_CD             = DIL2.GLBL_CMPY_CD         (+)
                    AND IT.SHIP_TO_LOC_CUST_CD      = DIL2.INVTY_LOC_CD         (+)
                    AND DIL2.GLBL_CMPY_CD           = RW2.GLBL_CMPY_CD          (+)
                    AND DIL2.RTL_WH_CD              = RW2.RTL_WH_CD             (+)
                    --OUTER JOIN 3
                    AND IT.GLBL_CMPY_CD             = F.GLBL_CMPY_CD            (+)
                    AND IT.INVTY_TRX_SLP_NUM        = F.FSR_NUM                 (+)
                    AND F.GLBL_CMPY_CD              = BTC2.GLBL_CMPY_CD         (+)
                    AND F.BILL_TO_CUST_CD           = BTC2.BILL_TO_CUST_CD      (+)
                    AND BTC2.GLBL_CMPY_CD           = GC2.GLBL_CMPY_CD          (+)
                    AND BTC2.COA_AFFL_CD            = GC2.COA_AFFL_CD           (+)
                    --OUTER JOIN 4
                    AND IT.GLBL_CMPY_CD             = SP1.GLBL_CMPY_CD          (+)
                    AND IT.CPO_ORD_NUM              = SP1.TRX_HDR_NUM           (+)
                    AND IT.CPO_DTL_LINE_NUM         = SP1.TRX_LINE_NUM          (+)
                    AND IT.CPO_DTL_LINE_SUB_NUM     = SP1.TRX_LINE_SUB_NUM      (+)
                    <!-- START 2018/07/27 S.Katsuma [QC#26281,ADD]] -->
                    AND NVL(IT.SO_NUM, 'X')         = NVL(SP1.SO_NUM(+), 'X')
                    AND NVL(IT.SO_SLP_NUM, 'X')     = NVL(SP1.SO_SLP_NUM(+), 'X')
                    <!-- END 2018/07/27 S.Katsuma [QC#26281,ADD]] -->
                    AND SP1.GLBL_CMPY_CD            = SS1.GLBL_CMPY_CD          (+)
                    AND SP1.SHPG_STS_CD             = SS1.SHPG_STS_CD           (+)
                    --OUTER JOIN 5
                    AND IT.GLBL_CMPY_CD             = IOD.GLBL_CMPY_CD          (+)
                    AND IT.INVTY_ORD_NUM            = IOD.INVTY_ORD_NUM         (+)
                    --OUTER JOIN 6
                    AND IT.GLBL_CMPY_CD             = SP2.GLBL_CMPY_CD          (+)
                    AND IT.INVTY_ORD_NUM            = SP2.TRX_HDR_NUM           (+)
                    AND IT.INVTY_ORD_LINE_NUM       = SP2.TRX_LINE_NUM          (+)
                    AND SP2.GLBL_CMPY_CD            = SS2.GLBL_CMPY_CD          (+)
                    AND SP2.SHPG_STS_CD             = SS2.SHPG_STS_CD           (+)
                    AND SP2.GLBL_CMPY_CD            = TPSXR1.GLBL_CMPY_CD       (+)
                    AND SP2.REQ_SHPG_SVC_LVL_CD     = TPSXR1.SHPG_SVC_LCL_CD    (+)
                    AND TPSXR1.VND_CD           (+) = #vndCd#
                    AND TPSXR1.CARR_CD          (+) = #carrCd#
                    AND TPSXR1.FRT_COND_CD      (+) = #frtCondCd#
                    --OUTER JOIN 7
                    AND IT.GLBL_CMPY_CD             = SP3.GLBL_CMPY_CD          (+)
                    AND IT.WRK_ORD_NUM              = SP3.TRX_HDR_NUM           (+)
                    AND IT.WRK_ORD_LINE_NUM         = SP3.TRX_LINE_NUM          (+)
                    AND SP3.GLBL_CMPY_CD            = SS3.GLBL_CMPY_CD          (+)
                    AND SP3.SHPG_STS_CD             = SS3.SHPG_STS_CD           (+)
                    AND SP3.GLBL_CMPY_CD            = TPSXR2.GLBL_CMPY_CD       (+)
                    AND SP3.REQ_SHPG_SVC_LVL_CD     = TPSXR2.SHPG_SVC_LCL_CD    (+)
                    AND TPSXR2.VND_CD           (+) = #vndCd#
                    AND TPSXR2.CARR_CD          (+) = #carrCd#
                    AND TPSXR2.FRT_COND_CD      (+) = #frtCondCd#
                    --EZCANCELFLAG
                    AND IT.EZCANCELFLAG             = '0'
                    AND DCC.EZCANCELFLAG            = '0'
                    AND DIL1.EZCANCELFLAG           = '0'
                    AND RW1.EZCANCELFLAG            = '0'
                    AND IO1.EZCANCELFLAG            = '0'
                    AND BTC1.EZCANCELFLAG       (+) = '0'
                    AND GC1.EZCANCELFLAG        (+) = '0'
                    AND F.EZCANCELFLAG          (+) = '0'
                    AND BTC2.EZCANCELFLAG       (+) = '0'
                    AND GC2.EZCANCELFLAG        (+) = '0'
                    AND SP1.EZCANCELFLAG        (+) = '0'
                    AND IOD.EZCANCELFLAG        (+) = '0'
                    AND DIL2.EZCANCELFLAG       (+) = '0'
                    AND RW2.EZCANCELFLAG        (+) = '0'
                    AND TPSXR1.EZCANCELFLAG     (+) = '0'
                    AND TPSXR2.EZCANCELFLAG     (+) = '0'
                    AND SS1.EZCANCELFLAG        (+) = '0'
                    AND SS2.EZCANCELFLAG        (+) = '0'
                    AND SS3.EZCANCELFLAG        (+) = '0'
                ) IT
            WHERE
                  ( IT.SHIP_FLG1 = #shipFlg#
               OR   IT.SHIP_FLG1 IS NULL )
              AND ( IT.SHIP_FLG2 = #shipFlg#
               OR   IT.SHIP_FLG2 IS NULL )
              AND ( IT.SHIP_FLG3 = #shipFlg#
               OR   IT.SHIP_FLG3 IS NULL )
            ORDER BY
                IT.INVTY_TRX_DT
               ,IT.INVTY_TRX_PK
    </statement>
    <statement id="getPrtStkOutRsltWrkFindByBatDt" parameterClass="Map" resultClass="Map">
        SELECT
             PSORW.GLBL_CMPY_CD
            ,PSORW.INVTY_TRX_PK
        FROM 
             PRT_STK_OUT_RSLT_WRK PSORW
        WHERE
                PSORW.GLBL_CMPY_CD  = #glblCmpyCd#
            AND PSORW.INTFC_CRAT_DT = #intfcCratDt#
            AND PSORW.EZCANCELFLAG  = '0'
    </statement>
    <statement id="getPrtStkOutRsltWrkCratDt" parameterClass="Map" resultClass="String">
        SELECT
             MAX(PSORW.INTFC_CRAT_DT)
        FROM 
             PRT_STK_OUT_RSLT_WRK PSORW
        WHERE
                PSORW.GLBL_CMPY_CD     = #glblCmpyCd#
            AND PSORW.INTFC_CRAT_DT &lt; #intfcCratDt#
            AND PSORW.EZCANCELFLAG     = '0'
    </statement>
    <statement id="getPrtStkOutRsltWrkOfPastDt" parameterClass="Map">
        SELECT
             PSORW.GLBL_CMPY_CD
            ,PSORW.INVTY_TRX_PK
        FROM 
             PRT_STK_OUT_RSLT_WRK PSORW
        WHERE
                PSORW.GLBL_CMPY_CD     = #glblCmpyCd#
            AND PSORW.INTFC_CRAT_DT &lt; #preIntfcCratDt#
            AND PSORW.EZCANCELFLAG     = '0'
        ORDER BY
             PSORW.INTFC_CRAT_DT
            ,PSORW.INVTY_TRX_PK
    </statement>

    <!-- START 05/23/2016 R.Shimamoto [V2.0 ADD] -->
    <statement id="getTrdPtnrShpgMethCd" parameterClass="Map" resultClass="String">
        SELECT
            TPSXR.TRD_PTNR_SHPG_METH_CD
        FROM
            TRD_PTNR_SHPG_X_REF TPSXR
        WHERE
            TPSXR.GLBL_CMPY_CD        = #glblCmpyCd#
        AND TPSXR.VND_CD              = #vndCd#
        AND TPSXR.SHPG_SVC_LCL_CD     = #shpgSvcLclCd#
        AND TPSXR.CARR_CD             = #carrCd#
        AND TPSXR.FRT_COND_CD         = #frtCondCd#
        AND TPSXR.EZCANCELFLAG        = '0'
    </statement>
    <statement id="getCincGlblWhCd" parameterClass="Map" resultClass="String">
        SELECT
            CGWC.CINC_GLBL_WH_CD
        FROM
            CINC_GLBL_WH_CONV CGWC
        WHERE CGWC.GLBL_CMPY_CD    = #glblCmpyCd#
          AND CGWC.RTL_WH_CD       = #rtlWhCd#
          AND CGWC.WH_OWNR_CD      = #whOwnrCd#
          AND CGWC.LOC_TP_CD       = #locTpCd#
          AND CGWC.EZCANCELFLAG    = '0'
    </statement>
    <statement id="getCincGlblCatgCd" parameterClass="Map" resultClass="Map">
        SELECT
            WTCCC.CINC_GLBL_CMPY_CATG_CD
            ,WTCCC.CINC_GLBL_SHPG_CATG_CD
            ,WTCCC.CINC_GLBL_ORD_CATG_CD
        FROM
            WH_TRNSF_CINC_CATG_CONV WTCCC
        WHERE
            WTCCC.GLBL_CMPY_CD             = #glblCmpyCd#
        AND WTCCC.FROM_RTL_WH_CD           = #fromRtlWhCd#
        AND WTCCC.FROM_WH_OWNR_CD          = #fromWhOwnrCd#
        AND WTCCC.FROM_LOC_TP_CD           = #fromLocTpCd#
        AND WTCCC.TO_RTL_WH_CD             = #toRtlWhCd#
        AND WTCCC.TO_WH_OWNR_CD            = #toWhOwnrCd#
        AND WTCCC.TO_LOC_TP_CD             = #toLocTpCd#
        AND WTCCC.EZCANCELFLAG             = '0'
    </statement>
    <!-- END 05/23/2016 R.Shimamoto [V2.0 ADD] -->
</sqlMap>
