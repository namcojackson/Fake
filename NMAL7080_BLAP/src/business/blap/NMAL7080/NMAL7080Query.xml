<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<sqlMap namespace="NMAL7080Query">
    <statement id="getSupplyAgreement" parameterClass="Map" resultClass="Map">
    SELECT
             SPLY_AGMT_PLN_PK
             , SPLY_AGMT_PLN_NM
             , SPLY_AGMT_PLN_SHORT_NM
             , SPLY_AGMT_PLN_DESC_TXT
             , SPLY_AGMT_PLN_TP_CD
             , SPLY_AGMT_DOC_TP_CD
             , EFF_FROM_DT
             , EFF_THRU_DT
             , ACTV_FLG
             , DEL_FLG
             , ANN_TERM_CAP_NUM
             , EZUPTIME
             , EZUPTIMEZONE
             , SPLY_AGMT_PLN_DTL_PK
             , MDSE_CD
             , MDSE_DESC_SHORT_TXT
             , SPLY_AGMT_FREQ_TP_CD
             , SPLY_AGMT_PLN_FIRST_QTY
             , SPLY_AGMT_PLN_QTY
             , SPLY_AGMT_PLN_SQ_NUM
             , DTL_EFF_FROM_DT
             , DTL_EFF_THRU_DT
             , DTL_DEL_FLG
             , DTL_EZUPTIMEZONE 
             , EZINTIME
             , CREATED_BY
             , DTL_EZUPTIME
             , UPDATE_BY
             , SPLY_AGMT_PLN_TP_NM
             , HDR_LVL_QTY_ENTRY_FLG
             , DTL_LVL_QTY_ENTRY_FLG
             , SPLY_AGMT_DOC_TP_NM
     FROM
        (SELECT SAP.SPLY_AGMT_PLN_PK
             , SAP.SPLY_AGMT_PLN_NM
             , SAP.SPLY_AGMT_PLN_SHORT_NM
             , SAP.SPLY_AGMT_PLN_DESC_TXT
             , SAP.SPLY_AGMT_PLN_TP_CD
             , SAP.SPLY_AGMT_DOC_TP_CD
             , SAP.EFF_FROM_DT
             , SAP.EFF_THRU_DT
             , SAP.ACTV_FLG
             , SAP.DEL_FLG
             , SAP.ANN_TERM_CAP_NUM
             , SAP.EZUPTIME                   AS EZUPTIME
             , SAP.EZUPTIMEZONE               AS EZUPTIMEZONE
             , SAPD.SPLY_AGMT_PLN_DTL_PK
             , SAPD.MDSE_CD
             , AMV.MDSE_DESC_SHORT_TXT
             , SAPD.SPLY_AGMT_FREQ_TP_CD
             , SAPD.SPLY_AGMT_PLN_FIRST_QTY
             , SAPD.SPLY_AGMT_PLN_QTY
             , SAPD.SPLY_AGMT_PLN_SQ_NUM
             , SAPD.EFF_FROM_DT               AS DTL_EFF_FROM_DT
             , SAPD.EFF_THRU_DT               AS DTL_EFF_THRU_DT
             , SAPD.DEL_FLG                   AS DTL_DEL_FLG
             , SAPD.EZUPTIMEZONE              AS DTL_EZUPTIMEZONE 
             , SAPD.EZINTIME
             , CASE
                 WHEN AP1.FIRST_NM IS NOT NULL THEN SAPD.EZINUSERID || '(' || AP1.FIRST_NM || ' ' || AP1.LAST_NM || ')'
                 ELSE SAPD.EZINUSERID
               END CREATED_BY
             , SAPD.EZUPTIME                  AS DTL_EZUPTIME
             , CASE
                 WHEN AP2.FIRST_NM IS NOT NULL THEN SAPD.EZUPUSERID || '(' || AP2.FIRST_NM || ' ' || AP2.LAST_NM || ')'
                 ELSE SAPD.EZUPUSERID
               END UPDATE_BY
             , SAPT.SPLY_AGMT_PLN_TP_NM
             , SADT.HDR_LVL_QTY_ENTRY_FLG
             , SADT.DTL_LVL_QTY_ENTRY_FLG
             , SADT.SPLY_AGMT_DOC_TP_NM
          FROM SPLY_AGMT_PLN     SAP
             , SPLY_AGMT_PLN_DTL SAPD
             , SPLY_AGMT_PLN_TP  SAPT
             , SPLY_AGMT_DOC_TP  SADT
             , SPLY_AGMT_FREQ_TP SAFT
             , ALL_MDSE_V        AMV
             , AUTH_PSN AP1
             , AUTH_PSN AP2
          WHERE SAP.GLBL_CMPY_CD = #glblCmpyCd#
             AND SAP.EZCANCELFLAG = '0'
             AND SAP.SPLY_AGMT_PLN_PK = #splyAgmtPlnPk#
          
             AND SAP.GLBL_CMPY_CD     = SAPD.GLBL_CMPY_CD
             AND SAP.EZCANCELFLAG     = SAPD.EZCANCELFLAG
             AND SAP.SPLY_AGMT_PLN_PK = SAPD.SPLY_AGMT_PLN_PK
             <isNotNull property="mdseCd">
             AND SAPD.MDSE_CD         = #mdseCd#
             </isNotNull>
          
             AND SAP.GLBL_CMPY_CD     = SAPT.GLBL_CMPY_CD
             AND SAP.EZCANCELFLAG     = SAPT.EZCANCELFLAG
             AND SAP.SPLY_AGMT_PLN_TP_CD = SAPT.SPLY_AGMT_PLN_TP_CD
          
             AND SAP.GLBL_CMPY_CD        = SADT.GLBL_CMPY_CD
             AND SAP.EZCANCELFLAG        = SADT.EZCANCELFLAG
             AND SAP.SPLY_AGMT_DOC_TP_CD = SADT.SPLY_AGMT_DOC_TP_CD
          
             AND SAPD.GLBL_CMPY_CD         = SAFT.GLBL_CMPY_CD
             AND SAPD.EZCANCELFLAG         = SAFT.EZCANCELFLAG
             AND SAPD.SPLY_AGMT_FREQ_TP_CD = SAFT.SPLY_AGMT_FREQ_TP_CD
          
             AND SAPD.GLBL_CMPY_CD         = AMV.GLBL_CMPY_CD
             AND SAPD.EZCANCELFLAG         = AMV.EZCANCELFLAG
             AND SAPD.MDSE_CD              = AMV.MDSE_CD
          
             AND SAPD.GLBL_CMPY_CD = AP1.GLBL_CMPY_CD(+)
             AND SAPD.EZCANCELFLAG = AP1.EZCANCELFLAG(+)
             AND SAPD.EZINUSERID   = AP1.USR_NM(+)
          
             AND SAPD.GLBL_CMPY_CD = AP2.GLBL_CMPY_CD(+)
             AND SAPD.EZCANCELFLAG = AP2.EZCANCELFLAG(+)
             AND SAPD.EZUPUSERID   = AP2.USR_NM(+)
             <isEqual property="splyAgmtPlnStsCd" compareValue="01">
             AND SAPD.EFF_FROM_DT                 &lt;= #slsDt#
             AND NVL(SAPD.EFF_THRU_DT,'99991231') &gt;= #slsDt#
             AND SAPD.DEL_FLG                     = 'N'
             </isEqual>
             <isEqual property="splyAgmtPlnStsCd" compareValue="02">
             AND (SAPD.EFF_FROM_DT                 &gt; #slsDt#
              OR NVL(SAPD.EFF_THRU_DT,'99991231') &lt; #slsDt#)
             AND SAPD.DEL_FLG                     = 'N'
             </isEqual>
             <isEqual property="splyAgmtPlnStsCd" compareValue="03">
             AND SAPD.DEL_FLG                     = 'Y'
             </isEqual>
             <isEqual property="splyAgmtPlnStsCd" compareValue="04">
             AND SAPD.DEL_FLG                     = 'N'
             </isEqual>
             ORDER BY 
                 SAPD.SPLY_AGMT_PLN_SQ_NUM
                 ,SAPD.MDSE_CD)
         WHERE
             ROWNUM &lt;= #rowNum#
    </statement>
    <statement id="getSupplyAgreementName" parameterClass="Map" resultClass="BigDecimal">
        SELECT
            SAP.SPLY_AGMT_PLN_PK
        FROM
            SPLY_AGMT_PLN SAP
        WHERE
                SAP.GLBL_CMPY_CD = #glblCmpyCd#
            AND SAP.EZCANCELFLAG = '0'
            AND SAP.SPLY_AGMT_PLN_NM =#splyAgmtPlnNm#
    </statement>
        <statement id="getSupplyAgreementDetailFreq" parameterClass="Map" resultClass="Map">
        SELECT
            SAPD.SPLY_AGMT_FREQ_TP_CD
            ,SAPD.SPLY_AGMT_PLN_QTY
        FROM
            SPLY_AGMT_PLN_DTL SAPD
        WHERE
                SAPD.GLBL_CMPY_CD = #glblCmpyCd#
            AND SAPD.EZCANCELFLAG = '0'
            AND SAPD.SPLY_AGMT_PLN_PK = #splyAgmtPlnPk#
            AND SAPD.DEL_FLG = 'N'
    </statement>
    <statement id="getNotDeleteSupplyAgreementDetail" parameterClass="Map" resultClass="Integer">
        SELECT
            COUNT(*)
        FROM
            SPLY_AGMT_PLN_DTL SAPD
        WHERE
                SAPD.GLBL_CMPY_CD = #glblCmpyCd#
            AND SAPD.EZCANCELFLAG = '0'
            AND SAPD.SPLY_AGMT_PLN_PK = #splyAgmtPlnPk#
            <isNotNull property="dtlPk">
            <iterate property="dtlPk" var="elem[]" open="AND (" close=")" conjunction="AND">
                SAPD.SPLY_AGMT_PLN_DTL_PK &lt;&gt; #elem[]#
            </iterate>
            </isNotNull>
            AND SAPD.DEL_FLG = 'N'
            
            <isNotNull property="mdseCd">
            AND SAPD.MDSE_CD = #mdseCd#
            </isNotNull>
            <isNull property="mdseCd">
            AND SAPD.MDSE_CD IS NULL
            </isNull>
            

            AND SAPD.SPLY_AGMT_FREQ_TP_CD    = #splyAgmtFreqTpCd#

            <isNotNull property="splyAgmtPlnFirstQty">
            AND SAPD.SPLY_AGMT_PLN_FIRST_QTY = #splyAgmtPlnFirstQty#
            </isNotNull>
            <isNull property="splyAgmtPlnFirstQty">
            AND SAPD.SPLY_AGMT_PLN_FIRST_QTY IS NULL
            </isNull>
            
            <isNotNull property="splyAgmtPlnQty">
            AND SAPD.SPLY_AGMT_PLN_QTY       = #splyAgmtPlnQty#
            </isNotNull>
            <isNull property="splyAgmtPlnQty">
            AND SAPD.SPLY_AGMT_PLN_QTY       IS NULL
            </isNull>

            <isNotNull property="splyAgmtPlnSqNum">
            AND SAPD.SPLY_AGMT_PLN_SQ_NUM    = #splyAgmtPlnSqNum#
            </isNotNull>
            <isNull property="splyAgmtPlnSqNum">
            AND SAPD.SPLY_AGMT_PLN_SQ_NUM    IS NULL
            </isNull>

            AND SAPD.EFF_FROM_DT             = #effFromDt#
            
            <isNotNull property="effThruDt">
            AND SAPD.EFF_THRU_DT             = #effThruDt#
            </isNotNull>
            <isNull property="effThruDt">
            AND SAPD.EFF_THRU_DT             IS NULL
            </isNull>
            
    </statement>
    
    <statement id="countDtlDupByEffDt" parameterClass="Map" resultClass="Integer">
        SELECT
            COUNT(*)
        FROM
            SPLY_AGMT_PLN_DTL SAPD
        WHERE
                SAPD.GLBL_CMPY_CD = #glblCmpyCd#
            AND SAPD.EZCANCELFLAG = '0'
            AND SAPD.SPLY_AGMT_PLN_PK = #splyAgmtPlnPk#
            <isNotNull property="dtlPk">
            <iterate property="dtlPk" var="elem[]" open="AND (" close=")" conjunction="AND">
                SAPD.SPLY_AGMT_PLN_DTL_PK &lt;&gt; #elem[]#
            </iterate>
            </isNotNull>
            AND SAPD.DEL_FLG = 'N'
            <isNotNull property="mdseCd">
            AND SAPD.MDSE_CD = #mdseCd#
            </isNotNull>
            <isNull property="mdseCd">
            AND SAPD.MDSE_CD IS NULL
            </isNull>
            AND ((SAPD.EFF_FROM_DT &gt; #effFromDt#
            AND SAPD.EFF_FROM_DT &lt;= #effThruDt#)
             OR (SAPD.EFF_FROM_DT &lt; #effFromDt#
            AND NVL(SAPD.EFF_THRU_DT , '99991231') &gt;= #effFromDt#)
             OR SAPD.EFF_FROM_DT = #effFromDt#)
            <!-- QC#8012 Start -->
            <isNotNull property="splyAgmtFreqTpCd">
            AND SAPD.SPLY_AGMT_FREQ_TP_CD = #splyAgmtFreqTpCd#
            </isNotNull>
            <isNull property="splyAgmtFreqTpCd">
            AND SAPD.SPLY_AGMT_FREQ_TP_CD IS NULL
            </isNull>
            
            <isNotNull property="splyAgmtPlnFirstQty">
            AND SAPD.SPLY_AGMT_PLN_FIRST_QTY = #splyAgmtPlnFirstQty#
            </isNotNull>
            <isNull property="splyAgmtPlnFirstQty">
            AND SAPD.SPLY_AGMT_PLN_FIRST_QTY IS NULL
            </isNull>
            
            <isNotNull property="splyAgmtPlnQty">
            AND SAPD.SPLY_AGMT_PLN_QTY = #splyAgmtPlnQty#
            </isNotNull>
            <isNull property="splyAgmtPlnQty">
            AND SAPD.SPLY_AGMT_PLN_QTY IS NULL
            </isNull>
            
            <isNotNull property="splyAgmtPlnSqNum">
            AND SAPD.SPLY_AGMT_PLN_SQ_NUM = #splyAgmtPlnSqNum#
            </isNotNull>
            <isNull property="splyAgmtPlnSqNum">
            AND SAPD.SPLY_AGMT_PLN_SQ_NUM IS NULL
            </isNull>
            <!-- QC#8012 End -->
            
    </statement>
    <!-- QC#13253 Start -->
    <statement id="countActiveSupplyPriceList" parameterClass="Map" resultClass="Integer">
        SELECT 
            COUNT(*)
        FROM
            PRC_LIST_SPLY_PGM PLSP
            ,PRC_CATG PC
        WHERE
                PLSP.GLBL_CMPY_CD     = #glblCmpyCd#
            AND PLSP.EZCANCELFLAG     = '0'
            AND PLSP.SPLY_AGMT_PLN_PK = #splyAgmtPlnPk#
            AND PLSP.DEL_FLG          = 'N'
            AND PLSP.EFF_FROM_DT                  &lt;= #slsDt#
            AND NVL(PLSP.EFF_THRU_DT,'99991231')  &gt;= #slsDt#
        
            AND PLSP.GLBL_CMPY_CD = PC.GLBL_CMPY_CD
            AND PLSP.EZCANCELFLAG = PC.EZCANCELFLAG
            AND PLSP.PRC_CATG_CD  = PC.PRC_CATG_CD
            AND PC.ACTV_FLG       = 'Y'
            AND PC.DEL_FLG        = 'N'
            AND PC.EFF_FROM_DT                   &lt;= #slsDt#
            AND NVL(PC.EFF_THRU_DT,'99991231')   &gt;= #slsDt#
    </statement>
    <!-- QC#13253 End -->
</sqlMap>
