<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<sqlMap namespace="NFDL0040Query">

    <!-- *********************************************************** -->
    <!-- ********** Bean Definition ******************************** -->
    <!-- *********************************************************** -->
    <typeAlias alias="NFDL0040CMsg"     type="business.blap.NFDL0040.NFDL0040CMsg"/>
    <typeAlias alias="NFDL0040_ASMsg"   type="business.blap.NFDL0040.NFDL0040_ASMsg"/>
    <typeAlias alias="NFDL0040_BSMsg"   type="business.blap.NFDL0040.NFDL0040_BSMsg"/>

    <statement id="getPromise" parameterClass="Map" resultMap="result.getPromise">
        SELECT    
              PRMS.EZUPTIME                      EZUPTIME_A
            , PRMS.EZUPTIMEZONE                  EZUPTIMEZONE_A
            , PRMS.CLT_PRMS_CRAT_DT              CLT_PRMS_CRAT_DT_A
            , NVL(PRMS.AR_TRX_NUM, #onAccount#)  AR_TRX_NUM_A
            , PRMS.CLT_PRMS_DTL_PK               CLT_PRMS_DTL_PK_A
            , PRMS.DEAL_RMNG_BAL_GRS_AMT         DEAL_RMNG_BAL_GRS_AMT_A1
            , TRX.DEAL_RMNG_BAL_GRS_AMT          DEAL_RMNG_BAL_GRS_AMT_A2
           <!-- QC6269-2 INSERT start--> 
            , PRMS.FUNC_RMNG_BAL_GRS_AMT         FUNC_RMNG_BAL_GRS_AMT_A1
            , TRX.FUNC_RMNG_BAL_GRS_AMT          FUNC_RMNG_BAL_GRS_AMT_A2
           <!-- QC6269-2 INSERT end-->
            , PRMS.DEAL_CLT_PRMS_AMT             DEAL_CLT_PRMS_AMT_A
            , PRMS.CLT_PRMS_STS_CD               CLT_PRMS_STS_CD_A
            , STS.CLT_PRMS_STS_DESC_TXT          CLT_PRMS_STS_DESC_TXT_A
            , PRMS.CLT_PRMS_DT                   CLT_PRMS_DT_A
            , PRMS.CLT_PRMS_BRKN_FLG             CLT_PRMS_BRKN_FLG_A
            , PSN.LAST_NM || ',' || PSN.FIRST_NM FULL_PSN_NM_A
            , PRMS.CLT_PRMS_NOTE_TXT             CLT_PRMS_NOTE_TXT_A
        FROM  CLT_PRMS_DTL PRMS
             ,AR_TRX_BAL   TRX
             ,AUTH_PSN     PSN
             ,CLT_PRMS_STS STS
        WHERE     PRMS.GLBL_CMPY_CD    = #glblCmpyCd#
        AND       PRMS.EZCANCELFLAG    = '0'
        AND       PRMS.CLT_ACCT_CD     = #cMsg.dsAcctNum_H#
        <isNotNull property="cMsg.arTrxNum_H">
            AND   PRMS.AR_TRX_NUM      = #cMsg.arTrxNum_H#
        </isNotNull>
        <isNotEqual property="cMsg.xxChkBox_AH" compareValue="Y">
            AND   PRMS.CLT_PRMS_STS_CD = #cltPrmsStsCd#
        </isNotEqual>
        AND       PRMS.GLBL_CMPY_CD    = TRX.GLBL_CMPY_CD(+)
        AND       PRMS.AR_TRX_NUM      = TRX.AR_TRX_NUM(+)
        AND       TRX.EZCANCELFLAG(+)  = '0'
        AND       PRMS.GLBL_CMPY_CD    = PSN.GLBL_CMPY_CD (+)
        AND       PRMS.CRAT_USR_ID     = PSN.USR_NM (+)
        AND       PRMS.GLBL_CMPY_CD    = STS.GLBL_CMPY_CD (+)
        AND       PRMS.CLT_PRMS_STS_CD = STS.CLT_PRMS_STS_CD (+)
        AND       STS.EZCANCELFLAG(+)  = '0'
        ORDER BY
                   CLT_PRMS_DT_A DESC
                 , CLT_PRMS_STS_CD_A ASC
    </statement>

    <resultMap id="result.getPromise"  class="NFDL0040_ASMsg">
        <result property="ezUpTime_A"             column="EZUPTIME_A"               javaType="EZDSStringItem" />
        <result property="ezUpTimeZone_A"         column="EZUPTIMEZONE_A"           javaType="EZDSStringItem" />
        <result property="cltPrmsCratDt_A"        column="CLT_PRMS_CRAT_DT_A"       javaType="EZDSStringItem" />
        <result property="arTrxNum_A"             column="AR_TRX_NUM_A"             javaType="EZDSStringItem" />
        <result property="cltPrmsDtlPk_A"         column="CLT_PRMS_DTL_PK_A"        javaType="EZDSBigDecimalItem" />
        <result property="dealRmngBalGrsAmt_A1"   column="DEAL_RMNG_BAL_GRS_AMT_A1" javaType="EZDSBigDecimalItem" />
        <result property="dealRmngBalGrsAmt_A2"   column="DEAL_RMNG_BAL_GRS_AMT_A2" javaType="EZDSBigDecimalItem" />
        <!-- QC6269-2 INSERT start-->
        <result property="funcRmngBalGrsAmt_A1"   column="FUNC_RMNG_BAL_GRS_AMT_A1" javaType="EZDSBigDecimalItem" />
        <result property="funcRmngBalGrsAmt_A2"   column="FUNC_RMNG_BAL_GRS_AMT_A2" javaType="EZDSBigDecimalItem" />
        <!-- QC6269-2 INSERT end-->
        <result property="dealCltPrmsAmt_A"       column="DEAL_CLT_PRMS_AMT_A"     javaType="EZDSBigDecimalItem" />
        <result property="cltPrmsStsCd_A"         column="CLT_PRMS_STS_CD_A"        javaType="EZDSStringItem" />
        <result property="cltPrmsStsDescTxt_A"    column="CLT_PRMS_STS_DESC_TXT_A"  javaType="EZDSStringItem" />
        <result property="cltPrmsDt_A"            column="CLT_PRMS_DT_A"            javaType="EZDSStringItem" />
        <result property="cltPrmsBrknFlg_A"       column="CLT_PRMS_BRKN_FLG_A"      javaType="EZDSStringItem" />
        <result property="fullPsnNm_A"            column="FULL_PSN_NM_A"            javaType="EZDSStringItem" />
        <result property="cltPrmsNoteTxt_A"       column="CLT_PRMS_NOTE_TXT_A"      javaType="EZDSStringItem" />
    </resultMap>

    <statement id="getDispute" parameterClass="Map" resultMap="result.getDispute">
        SELECT
              DSPT.EZUPTIME                      AS EZUPTIME_B
             ,DSPT.EZUPTIMEZONE                  AS EZUPTIMEZONE_B
             ,DSPT.CLT_DSPT_DT                   AS CLT_DSPT_DT_B
             ,DSPT.AR_TRX_NUM                    AS AR_TRX_NUM_B
             ,DSPT.CLT_DSPT_TRX_PK               AS CLT_DSPT_TRX_PK_B
             ,DSPT.DEAL_RMNG_BAL_GRS_AMT         AS DEAL_RMNG_BAL_GRS_AMT_B
             ,DSPT.FUNC_RMNG_BAL_GRS_AMT         AS FUNC_RMNG_BAL_GRS_AMT_B
             ,DSPT.DEAL_CLT_DSPT_AMT             AS DEAL_CLT_DSPT_AMT_B
             ,DSPT.CLT_DSPT_RSN_CD               AS CLT_DSPT_RSN_CD_B
             ,PSN.LAST_NM || ',' || PSN.FIRST_NM AS FULL_PSN_NM_B
             ,DSPT.CLT_DSPT_STS_CD               AS CLT_DSPT_STS_CD
             ,DSPT.CLT_DSPT_NOTE_TXT             AS CLT_DSPT_NOTE_TXT
        FROM  CLT_DSPT_TRX DSPT
             ,AUTH_PSN     PSN
        WHERE DSPT.GLBL_CMPY_CD          = #glblCmpyCd#
        AND   DSPT.EZCANCELFLAG          = '0'
        AND   DSPT.CLT_ACCT_CD           = #cMsg.dsAcctNum_H#
        <isNotNull property="cMsg.arTrxNum_H">
            AND DSPT.AR_TRX_NUM          = #cMsg.arTrxNum_H#
        </isNotNull>
        AND   DSPT.GLBL_CMPY_CD          = PSN.GLBL_CMPY_CD (+)
        AND   DSPT.CLT_DSPT_CRAT_USR_ID  = PSN.USR_NM (+)
    </statement>

    <resultMap id="result.getDispute"  class="NFDL0040_BSMsg">
        <result property="ezUpTime_B"           column="EZUPTIME_B"               javaType="EZDSStringItem" />
        <result property="ezUpTimeZone_B"       column="EZUPTIMEZONE_B"           javaType="EZDSStringItem" />
        <result property="cltDsptDt_B"          column="CLT_DSPT_DT_B"            javaType="EZDSStringItem" />
        <result property="arTrxNum_B"           column="AR_TRX_NUM_B"             javaType="EZDSStringItem" />
        <result property="cltDsptTrxPk_B"       column="CLT_DSPT_TRX_PK_B"        javaType="EZDSBigDecimalItem" />
        <result property="dealRmngBalGrsAmt_B"  column="DEAL_RMNG_BAL_GRS_AMT_B"  javaType="EZDSBigDecimalItem" />
        <result property="funcRmngBalGrsAmt_B"  column="FUNC_RMNG_BAL_GRS_AMT_B"  javaType="EZDSBigDecimalItem" />
        <result property="dealCltDsptAmt_B"     column="DEAL_CLT_DSPT_AMT_B"      javaType="EZDSBigDecimalItem" />
        <result property="cltDsptRsnCd_B"       column="CLT_DSPT_RSN_CD_B"        javaType="EZDSStringItem" />
        <result property="fullPsnNm_B"          column="FULL_PSN_NM_B"            javaType="EZDSStringItem" />
        <result property="cltDsptStsCd_B"       column="CLT_DSPT_STS_CD"          javaType="EZDSStringItem" />
        <result property="cltDsptStsCd_BB"      column="CLT_DSPT_STS_CD"          javaType="EZDSStringItem" />
        <result property="cltDsptNoteTxt_B"     column="CLT_DSPT_NOTE_TXT"        javaType="EZDSStringItem" />
    </resultMap>

    <statement id="countCollectablePromise" parameterClass="Map" resultClass="BigDecimal">
        SELECT
                  COUNT(*)
        FROM      CLT_PRMS_DTL PRMS
        WHERE     PRMS.GLBL_CMPY_CD    = #glblCmpyCd#
        AND       PRMS.EZCANCELFLAG    = '0'
        AND       PRMS.CLT_ACCT_CD     = #cMsg.dsAcctNum_H#
        <!-- Start 2023/5/26 S.Nakatani [QC#61271, MOD]-->
        <!-- <isNotNull property="cMsg.arTrxNum_H"> -->
        <!--     AND   PRMS.AR_TRX_NUM      = #cMsg.arTrxNum_H# -->
        <!-- </isNotNull> -->
        <iterate property="arTrxNumList" var="arTrxNumList[]" open="AND PRMS.AR_TRX_NUM IN (" close=")" conjunction=",">
            #arTrxNumList[]#
        </iterate>
        <!-- End 2023/5/26 S.Nakatani [QC#61271, MOD]-->
        AND   PRMS.CLT_PRMS_STS_CD = #cltPrmsStsCd#
    </statement>

    <statement id="getActualInvoiceBalance" parameterClass="Map" resultClass="BigDecimal">
        SELECT
                  SUM(DEAL_RMNG_BAL_GRS_AMT)
        FROM      AR_TRX_BAL TRX
        WHERE     TRX.GLBL_CMPY_CD    = #glblCmpyCd#
        <!-- Start 2023/5/26 S.Nakatani [QC#61271, MOD]-->
        <!-- AND       TRX.AR_TRX_NUM      = #cMsg.arTrxNum_H# -->
        <iterate property="arTrxNumList" var="arTrxNumList[]" open="AND TRX.AR_TRX_NUM IN (" close=")" conjunction=",">
            #arTrxNumList[]#
        </iterate>
        <!-- End 2023/5/26 S.Nakatani [QC#61271, MOD]-->
        AND       TRX.EZCANCELFLAG    = '0'
    </statement>

    <!-- QC6269-2 INSERT start-->
    <statement id="getArTrxBalData" parameterClass="Map" resultClass="Map">
        SELECT
            <!-- Start 2023/5/26 S.Nakatani [QC#61271, MOD]-->
                  <!-- TRX.DEAL_RMNG_BAL_GRS_AMT -->
                  <!-- ,TRX.FUNC_RMNG_BAL_GRS_AMT -->
                  SUM(TRX.DEAL_RMNG_BAL_GRS_AMT) DEAL_RMNG_BAL_GRS_AMT
                 ,SUM(TRX.FUNC_RMNG_BAL_GRS_AMT) FUNC_RMNG_BAL_GRS_AMT
            <!-- End 2023/5/26 S.Nakatani [QC#61271, MOD]-->
        FROM      AR_TRX_BAL TRX
        WHERE     TRX.GLBL_CMPY_CD    = #glblCmpyCd#
        <!-- Start 2023/5/26 S.Nakatani [QC#61271, MOD]-->
        <!-- AND       TRX.AR_TRX_NUM      = #cMsg.arTrxNum_H# -->
        <iterate property="arTrxNumList" var="arTrxNumList[]" open="AND TRX.AR_TRX_NUM IN (" close=")" conjunction=",">
            #arTrxNumList[]#
        </iterate>
        <!-- End 2023/5/26 S.Nakatani [QC#61271, MOD]-->
        AND       TRX.EZCANCELFLAG    = '0'
        <!-- Start 2023/5/26 S.Nakatani [QC#61271, DEL]-->
        <!-- AND       ROWNUM              = '1' -->
        <!-- End 2023/5/26 S.Nakatani [QC#61271, DEL]-->
    </statement>
    <!-- QC6269-2 INSERT end-->
    
    <!-- End 2023/5/26 S.Nakatani [QC#61271, ADD]-->
    <statement id="getPromiseForMultiInv" parameterClass="Map" resultMap="result.getPromise">
        SELECT    
              MIN(PRMS.EZUPTIME)                 EZUPTIME_A
            , MIN(PRMS.EZUPTIMEZONE)             EZUPTIMEZONE_A
            , MIN(PRMS.CLT_PRMS_CRAT_DT)         CLT_PRMS_CRAT_DT_A
            , ''                                 AR_TRX_NUM_A
            , MIN(PRMS.CLT_PRMS_DTL_PK)          CLT_PRMS_DTL_PK_A
            , SUM(PRMS.DEAL_RMNG_BAL_GRS_AMT)    DEAL_RMNG_BAL_GRS_AMT_A1
            , SUM(TRX.DEAL_RMNG_BAL_GRS_AMT)     DEAL_RMNG_BAL_GRS_AMT_A2
            , SUM(PRMS.FUNC_RMNG_BAL_GRS_AMT)    FUNC_RMNG_BAL_GRS_AMT_A1
            , SUM(TRX.FUNC_RMNG_BAL_GRS_AMT)     FUNC_RMNG_BAL_GRS_AMT_A2
            , SUM(PRMS.DEAL_CLT_PRMS_AMT)        DEAL_CLT_PRMS_AMT_A
            , MIN(PRMS.CLT_PRMS_STS_CD)          CLT_PRMS_STS_CD_A
            , MIN(STS.CLT_PRMS_STS_DESC_TXT)     CLT_PRMS_STS_DESC_TXT_A
            , MIN(PRMS.CLT_PRMS_DT)              CLT_PRMS_DT_A
            , MIN(PRMS.CLT_PRMS_BRKN_FLG)        CLT_PRMS_BRKN_FLG_A
            , MIN(PSN.LAST_NM || ',' || PSN.FIRST_NM) FULL_PSN_NM_A
            , MIN(PRMS.CLT_PRMS_NOTE_TXT)        CLT_PRMS_NOTE_TXT_A
        FROM  CLT_PRMS_DTL PRMS
             ,AR_TRX_BAL   TRX
             ,AUTH_PSN     PSN
             ,CLT_PRMS_STS STS
        WHERE     PRMS.GLBL_CMPY_CD    = #glblCmpyCd#
        AND       PRMS.EZCANCELFLAG    = '0'
        AND       PRMS.CLT_ACCT_CD     = #cMsg.dsAcctNum_H#
        <iterate property="arTrxNumList" var="arTrxNumList[]" open="AND PRMS.AR_TRX_NUM IN (" close=")" conjunction=",">
            #arTrxNumList[]#
        </iterate>
        <isNotEqual property="cMsg.xxChkBox_AH" compareValue="Y">
            AND   PRMS.CLT_PRMS_STS_CD = #cltPrmsStsCd#
        </isNotEqual>
        AND       PRMS.GLBL_CMPY_CD    = TRX.GLBL_CMPY_CD(+)
        AND       PRMS.AR_TRX_NUM      = TRX.AR_TRX_NUM(+)
        AND       TRX.EZCANCELFLAG(+)  = '0'
        AND       PRMS.GLBL_CMPY_CD    = PSN.GLBL_CMPY_CD (+)
        AND       PRMS.CRAT_USR_ID     = PSN.USR_NM (+)
        AND       PRMS.GLBL_CMPY_CD    = STS.GLBL_CMPY_CD (+)
        AND       PRMS.CLT_PRMS_STS_CD = STS.CLT_PRMS_STS_CD (+)
        AND       STS.EZCANCELFLAG(+)  = '0'
        ORDER BY
                   CLT_PRMS_DT_A DESC
                 , CLT_PRMS_STS_CD_A ASC
    </statement>

    <statement id="getDisputeForMultiInv" parameterClass="Map" resultMap="result.getDispute">
        SELECT
              MIN(DSPT.EZUPTIME)                      AS EZUPTIME_B
             ,MIN(DSPT.EZUPTIMEZONE)                  AS EZUPTIMEZONE_B
             ,MIN(DSPT.CLT_DSPT_DT)                   AS CLT_DSPT_DT_B
             ,''                    AS AR_TRX_NUM_B
             ,MIN(DSPT.CLT_DSPT_TRX_PK)               AS CLT_DSPT_TRX_PK_B
             ,SUM(DSPT.DEAL_RMNG_BAL_GRS_AMT)         AS DEAL_RMNG_BAL_GRS_AMT_B
             ,SUM(DSPT.FUNC_RMNG_BAL_GRS_AMT)         AS FUNC_RMNG_BAL_GRS_AMT_B
             ,SUM(DSPT.DEAL_CLT_DSPT_AMT)             AS DEAL_CLT_DSPT_AMT_B
             ,MIN(DSPT.CLT_DSPT_RSN_CD)               AS CLT_DSPT_RSN_CD_B
             ,MIN(PSN.LAST_NM || ',' || PSN.FIRST_NM) AS FULL_PSN_NM_B
             ,MIN(DSPT.CLT_DSPT_STS_CD)               AS CLT_DSPT_STS_CD
             ,MIN(DSPT.CLT_DSPT_NOTE_TXT)             AS CLT_DSPT_NOTE_TXT
        FROM  CLT_DSPT_TRX DSPT
             ,AUTH_PSN     PSN
        WHERE DSPT.GLBL_CMPY_CD          = #glblCmpyCd#
        AND   DSPT.EZCANCELFLAG          = '0'
        AND   DSPT.CLT_ACCT_CD           = #cMsg.dsAcctNum_H#
        <iterate property="arTrxNumList" var="arTrxNumList[]" open="AND DSPT.AR_TRX_NUM IN (" close=")" conjunction=",">
            #arTrxNumList[]#
        </iterate>
        AND   DSPT.GLBL_CMPY_CD          = PSN.GLBL_CMPY_CD (+)
        AND   DSPT.CLT_DSPT_CRAT_USR_ID  = PSN.USR_NM (+)
    </statement>

    <statement id="countOpenDispute" parameterClass="Map" resultClass="BigDecimal">
        SELECT
                  COUNT(*)
        FROM      CLT_DSPT_TRX DSPT
        WHERE     DSPT.GLBL_CMPY_CD    = #glblCmpyCd#
        AND       DSPT.EZCANCELFLAG    = '0'
        AND       DSPT.CLT_ACCT_CD     = #cMsg.dsAcctNum_H#
        <iterate property="arTrxNumList" var="arTrxNumList[]" open="AND DSPT.AR_TRX_NUM IN (" close=")" conjunction=",">
            #arTrxNumList[]#
        </iterate>
        AND   DSPT.CLT_DSPT_STS_CD = #cltDsptStsCd#
    </statement>
    
</sqlMap>